{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Runtime Architecture Internals &amp; Developer Guide","text":"<p>\u8fd9\u662f\u4e00\u5957\u9762\u5411 <code>arkcompiler/runtime_core/static_core</code> \u7684\u5185\u90e8 Wiki\uff1a</p> <ul> <li>\u6982\u89c8\uff08\u539f Stage1\uff09\uff1a\u6bcf\u7ae0\u4e00\u7bc7\u201c\u67b6\u6784\u4e3b\u7ebf + \u5173\u952e\u6982\u5ff5\u201d\u603b\u89c8\uff0c\u65b9\u4fbf\u5feb\u901f\u5efa\u7acb\u5fc3\u667a\u6a21\u578b</li> <li>\u6df1\u5165\uff08\u539f Stage2\uff09\uff1a\u56f4\u7ed5\u6bcf\u7ae0 README/Flows/DataStructures/FileNotes \u505a\u9010\u884c\u8bc1\u636e\u94fe\u6c89\u6dc0\uff0c\u65b9\u4fbf\u65b0\u4eba\u843d\u5730\u6392\u969c\u4e0e\u6539\u4ee3\u7801</li> </ul>"},{"location":"#00","title":"00 \u603b\u89c8\u4e0e\u65b9\u6cd5\u8bba\uff08\u9996\u9875\uff09","text":"<ul> <li>\u603b\u7d22\u5f15\uff08\u6982\u89c8\uff09</li> <li>\u65b9\u6cd5\u8bba Checklist</li> <li>\u5168\u91cf\u9875\u9762\u7d22\u5f15\uff08\u5fc5\u5907\uff09</li> </ul>"},{"location":"#stage1","title":"\u5404\u7ae0\u6982\u89c8\uff08Stage1\uff09","text":"<ul> <li>01 Startup</li> <li>02 Memory</li> <li>03 ClassLoading</li> <li>04 ExecutionEngine</li> <li>05 NativeBridge</li> <li>06 Tooling</li> <li>07 Build&amp;Config</li> </ul>"},{"location":"#mkdocs","title":"\u672c\u5730\u9884\u89c8\uff08MkDocs\uff09","text":"<p>\u5728\u672c\u76ee\u5f55\uff08<code>/home/fanzewei/docs/Runtime_Architecture_Internals_and_Developer_Guide</code>\uff09\u8fd0\u884c\uff1a</p> <pre><code># \u5982\u679c\u4f60\u672c\u673a\u5df2\u7ecf\u6709 mkdocs\uff08\u4f8b\u5982 ~/.local/bin/mkdocs\uff09\uff0c\u53ef\u4ee5\u76f4\u63a5\uff1a\nmkdocs serve\n\n# \u82e5\u9700\u8981\u9694\u79bb\u73af\u5883\uff08\u53ef\u80fd\u4f1a\u6162/\u9700\u8981\u7f51\u7edc\uff09\uff1a\npython3 -m venv .venv\nsource .venv/bin/activate\npip install -r mkdocs-requirements.txt\nmkdocs serve\n</code></pre>"},{"location":"#github-pages","title":"GitHub Pages \u53d1\u5e03","text":"<p>\u672c\u76ee\u5f55\u63d0\u4f9b\u4e86 GitHub Actions workflow\uff08\u89c1 <code>.github/workflows/mkdocs-gh-pages.yml</code>\uff09\uff0c\u4f1a\u5c06 <code>mkdocs.yml</code> \u6784\u5efa\u4ea7\u7269\u53d1\u5e03\u5230 <code>gh-pages</code> \u5206\u652f\u3002</p> <p>\u53d1\u5e03\u524d\u4f60\u9700\u8981\u5728 GitHub \u4ed3\u5e93\u91cc\u505a\u4e00\u6b21\u8bbe\u7f6e\uff1a</p> <ul> <li>Settings \u2192 Pages \u2192 Build and deployment</li> <li>Source: <code>Deploy from a branch</code></li> <li>Branch: <code>gh-pages</code> / <code>(root)</code></li> </ul>"},{"location":"00_Master_Index/","title":"Runtime \u67b6\u6784\u5185\u5e55\u4e0e\u5f00\u53d1\u8005\u6307\u5357\uff08\u9636\u6bb5 1\uff1aArchitecture &amp; Index\uff09","text":"<p>\u672c\u76ee\u5f55\u9762\u5411 arkcompiler/runtime_core/static_core \u8fd9\u5957 C++ Runtime\uff08\u7c7b ART \u98ce\u683c VM\uff09\u5de5\u7a0b\uff0c\u76ee\u6807\u662f\uff1a\u7528\u865a\u62df\u673a\u751f\u547d\u5468\u671f\u628a\u4ee3\u7801\u7ed3\u6784\u201c\u7ffb\u8bd1\u201d\u4e3a\u67b6\u6784\u5730\u56fe\u4e0e\u53ef\u6301\u7eed\u6269\u5c55\u7684\u5f00\u53d1\u8005\u6307\u5357\u7d22\u5f15\u3002</p>"},{"location":"00_Master_Index/#0","title":"0. \u8bfb\u8005\u4e0e\u8303\u56f4","text":"<ul> <li>\u8bfb\u8005\uff1a\u9700\u8981\u7406\u89e3/\u6539\u9020 VM \u542f\u52a8\u3001\u5185\u5b58\u7ba1\u7406\u3001\u7c7b\u52a0\u8f7d\u3001\u89e3\u91ca\u5668/JIT/AOT\u3001Native \u63a5\u53e3\uff08ANI/Interop\uff09\u7684\u5f00\u53d1\u8005\u3002</li> <li>\u8303\u56f4\uff1a\u4ee5 <code>static_core/</code> \u4e3a\u6839\uff1b\u91cd\u70b9\u8986\u76d6 <code>runtime/</code> \u4e0e <code>plugins/ets/runtime/</code> \u7684\u8fd0\u884c\u671f\u5173\u952e\u8def\u5f84\uff0c\u5e76\u5173\u8054 <code>compiler/</code>\u3001<code>irtoc/</code>\u3001<code>verification/</code> \u7b49\u652f\u6491\u6a21\u5757\u3002</li> </ul>"},{"location":"00_Master_Index/#1-component-mapping","title":"1. \u7ed3\u8bba\u5148\u884c\uff1a\u7ec4\u4ef6\u6620\u5c04\uff08Component Mapping\uff09","text":"\u7ec4\u4ef6 \u4e3b\u8981\u76ee\u5f55 \u5173\u952e\u6587\u4ef6\uff08\u5165\u53e3/\u951a\u70b9\uff09 \u8bf4\u660e \u542f\u52a8\u5165\u53e3\uff08CLI\uff09 <code>panda/</code> <code>panda/panda.cpp</code> <code>main()</code> \u89e3\u6790\u53c2\u6570\u540e\u8c03\u7528 <code>Runtime::Create()</code>\uff0c\u6267\u884c <code>ExecutePandaFile()</code>\uff0c\u6700\u7ec8 <code>Runtime::Destroy()</code> \u542f\u52a8\u5165\u53e3\uff08zygote/ANI\uff09 <code>plugins/ets/runtime/ani/</code> <code>plugins/ets/runtime/ani/ani_vm_api.cpp</code> <code>ANI_CreateVM()</code> \u89e3\u6790 ANI options\uff0c\u521d\u59cb\u5316 logger\uff0c\u8c03\u7528 <code>ark::Runtime::Create()</code>\uff0c\u62ff\u5230 <code>EtsCoroutine-&gt;GetPandaVM()</code> Runtime \u751f\u547d\u5468\u671f <code>runtime/</code> <code>runtime/runtime.cpp</code>\u3001<code>runtime/include/runtime.h</code> <code>Runtime::Create/Initialize/Destroy</code> \u4e32\u8d77\u5185\u5b58\u7a7a\u95f4\u3001PandaVM\u3001ClassLinker\u3001GC\u3001\u5de5\u5177\u94fe\u7b49 \u5185\u5b58\u7ba1\u7406\uff08Heap/GC/Allocator\uff09 <code>runtime/mem/</code> <code>runtime/mem/heap_manager.*</code>\u3001<code>runtime/mem/gc/*</code> HeapManager + \u591a\u79cd GC\uff08STW\u3001G1/Gen\u3001Epsilon\u2026\uff09\uff0c\u5e76\u63d0\u4f9b barrier/safepoint \u652f\u6491 \u5bf9\u8c61\u6a21\u578b\uff08Object Model\uff09 <code>runtime/</code>\u3001<code>runtime/coretypes/</code> <code>runtime/object_header.cpp</code>\u3001<code>runtime/include/object_header.h</code>\u3001<code>runtime/mark_word.*</code> <code>ObjectHeader</code> \u7531 MarkWord + ClassWord \u7ec4\u6210\uff1b<code>coretypes/*</code> \u63d0\u4f9b Array/String \u7b49\u6838\u5fc3\u5bf9\u8c61 \u7c7b\u52a0\u8f7d\u4e0e\u94fe\u63a5\uff08ClassLinker\uff09 <code>runtime/</code> <code>runtime/include/class_linker.h</code>\u3001<code>runtime/class_linker.cpp</code>\u3001<code>runtime/class_linker_context.h</code> \u7edf\u4e00\u7684 language-agnostic <code>ClassLinker</code>\uff0c\u901a\u8fc7 <code>ClassLinkerExtension</code> \u505a\u8bed\u8a00\u6269\u5c55 \u6267\u884c\u5f15\u64ce\uff08\u89e3\u91ca\u5668\uff09 <code>runtime/interpreter/</code> <code>runtime/interpreter/frame.h</code>\u3001<code>runtime/interpreter/vregister.h</code> \u57fa\u4e8e vregister\uff08\u865a\u62df\u5bc4\u5b58\u5668\uff09 \u7684\u89e3\u91ca\u5668\uff1b\u9759\u6001\u8bed\u8a00\u7528\u201cmirror vregs\u201d\u5b58 tag\uff0c\u52a8\u6001\u8bed\u8a00\u7528 TaggedValue JIT/AOT/\u6865\u63a5 <code>runtime/bridge/</code>\u3001<code>runtime/jit/</code>\u3001<code>compiler/</code>\u3001<code>irtoc/</code> <code>runtime/bridge/bridge.h</code>\u3001<code>runtime/runtime.cpp</code>\uff08JIT/AOT \u9009\u9879\u5904\u7406\uff09 \u89e3\u91ca\u5668 &lt;-&gt; \u7f16\u8bd1\u4ee3\u7801\u6865\u63a5\uff08c2i/i2c\uff09\uff0cJIT \u7f16\u8bd1\u4e0e profile \u4fdd\u5b58\uff1bAOT \u7531 <code>compiler/aot/</code> \u4e0e AotManager \u53c2\u4e0e Native/\u6865\uff08ANI/ETS Native/Interop\uff09 <code>plugins/ets/runtime/</code> <code>plugins/ets/runtime/ani/*</code>\u3001<code>plugins/ets/runtime/ets_native_library*.{h,cpp}</code>\u3001<code>plugins/ets/runtime/interop_js/*</code> ANI \u7ebf\u7a0b attach/detach\uff1bETS Native \u5e93\u52a0\u8f7d\uff1b\u53ef\u9009 JS \u4e92\u64cd\u4f5c \u5de5\u5177\u94fe\u4e0e\u53ef\u89c2\u6d4b\u6027 <code>runtime/tooling/</code> <code>runtime/tooling/inspector/*</code>\u3001<code>runtime/tooling/debugger.*</code>\u3001<code>runtime/tooling/tools.*</code> \u8c03\u8bd5\u5668/Inspector\uff08PtHooks\uff09\u3001\u91c7\u6837 profiler\u3001perf counter \u7b49 \u5b57\u8282\u7801/\u5feb\u5316/\u4f18\u5316\u5de5\u5177 <code>bytecode_optimizer/</code>\u3001<code>quickener/</code> <code>bytecode_optimizer/optimize_bytecode.cpp</code>\u3001<code>quickener/quick.cpp</code> \u5b57\u8282\u7801\u4f18\u5316\u4e0e quickening\uff08\u8fd0\u884c\u524d/\u6784\u5efa\u671f\u4f18\u5316\uff09 \u9a8c\u8bc1\u5668\uff08Verifier\uff09 <code>verification/</code> <code>verification/verifier/verifier.cpp</code>\u3001<code>verification/public.h</code> \u591a\u7ebf\u7a0b\u9a8c\u8bc1\u65b9\u6cd5\uff1b\u901a\u8fc7 language plugin \u521b\u5efa ManagedThread \u5e76\u8c03\u7528 Verify \u6784\u5efa\u4e0e\u914d\u7f6e \u9876\u5c42 + \u5404\u6a21\u5757 <code>BUILD.gn</code>\u3001<code>CMakeLists.txt</code>\u3001<code>runtime/options.yaml</code> GN/CMake \u53cc\u6784\u5efa\u4f53\u7cfb\uff1bruntime/compiler/options \u7b49\u901a\u8fc7 yaml \u5408\u5e76\u751f\u6210 options"},{"location":"00_Master_Index/#2","title":"2. \u903b\u8f91\u67b6\u6784\u63a8\u65ad\uff08\u4ece\u76ee\u5f55/\u4ee3\u7801\u8bc1\u636e\u51fa\u53d1\uff09","text":""},{"location":"00_Master_Index/#21-vm","title":"2.1 \u8fd9\u662f\u57fa\u4e8e\u6808\u8fd8\u662f\u5bc4\u5b58\u5668\u7684 VM\uff1f","text":"<p>\u7ed3\u8bba\uff1a\u4ee5\u5bc4\u5b58\u5668\uff08register-based / vreg-based\uff09\u4e3a\u4e2d\u5fc3\u7684\u89e3\u91ca\u5668\u8bbe\u8ba1\u3002</p> <p>\u5173\u952e\u8bc1\u636e\uff1a - <code>runtime/interpreter/vregister.h</code>\uff1a\u5b9a\u4e49 <code>VRegister</code>\uff0864-bit payload\uff09\u4e0e <code>StaticVRegisterRef/DynamicVRegisterRef</code>\uff0c\u5e76\u663e\u5f0f\u63d0\u5230\u201ctagless vregister / mirror vregister\u201d\u3002 - <code>runtime/interpreter/frame.h</code>\uff1aFrame layout \u76f4\u63a5\u5305\u542b <code>vregs_[0]</code> \u7684 VLA\uff0c\u5e76\u8bf4\u660e\u9759\u6001\u8bed\u8a00\u9700\u8981 mirror \u533a\u5b58 tag\uff1b\u8fd8\u5b9a\u4e49 <code>AccVRegister</code>\uff08\u7d2f\u52a0\u5668\uff09\u4e0e <code>GetAccAsVReg()</code>\u3002</p> <p>\u8fd9\u4e0e ART \u7684 dex bytecode \u201cvreg + accumulator/\u4e34\u65f6\u5bc4\u5b58\u5668\u201d\u98ce\u683c\u975e\u5e38\u63a5\u8fd1\uff1a\u6267\u884c\u72b6\u6001\u4ee5\u4e00\u7ec4\u865a\u62df\u5bc4\u5b58\u5668\u4e3a\u4e3b\uff0c\u800c\u975e operand stack \u4e3a\u4e3b\u3002</p>"},{"location":"00_Master_Index/#22-object-model","title":"2.2 \u5bf9\u8c61\u6a21\u578b\uff08Object Model\uff09\u957f\u4ec0\u4e48\u6837\uff1f","text":"<p>\u7ed3\u8bba\uff1a\u4ee5 <code>ObjectHeader</code> \u4e3a\u7edf\u4e00\u5bf9\u8c61\u5934\uff0cMarkWord \u7ba1\u540c\u6b65/GC/\u54c8\u5e0c\uff0cClassWord \u6307\u5411\u5143\u6570\u636e\uff08Class/HClass\uff09\uff0c\u5e76\u901a\u8fc7 <code>coretypes/*</code> \u63d0\u4f9b\u6838\u5fc3\u5bf9\u8c61\u3002</p> <p>\u5173\u952e\u8bc1\u636e\uff1a - <code>runtime/object_header.cpp</code>\uff1a<code>ObjectHeader::CreateObject()</code> \u901a\u8fc7 <code>HeapManager</code> \u5206\u914d\u5bf9\u8c61\uff1b<code>ObjectSize()</code> \u4f9d\u636e <code>ClassAddr&lt;BaseClass&gt;()</code> \u5224\u65ad\u9759\u6001/\u52a8\u6001 class\uff0c\u5e76\u5bf9 <code>Array/String/Class</code> \u505a\u7279\u6b8a\u5206\u6d3e\u3002 - <code>runtime/include/object_header.h</code> / <code>runtime/mark_word.*</code>\uff1a\u5bf9\u8c61\u5934\u62c6\u5206\u4e3a mark/class \u4e24\u90e8\u5206\uff08\u4e0d\u540c\u5e73\u53f0\u914d\u7f6e\u5728 <code>runtime/object_header_config.h</code>\uff09\u3002 - <code>runtime/coretypes/</code>\uff1a<code>String</code>\u3001<code>Array</code> \u7b49\u6838\u5fc3\u7c7b\u578b\u5b9e\u73b0\u3002</p> <p>\u8fd9\u91cc\u4e0d\u50cf ART \u6587\u6863\u91cc\u5e38\u8bf4\u7684 \u201cmirror::Object\u201d \u547d\u540d\u4f53\u7cfb\uff1b\u4f46\u529f\u80fd\u4e0a\u7b49\u4ef7\uff1a\u5bf9\u8c61\u5934 + \u5143\u6570\u636e\u7c7b\uff08Class/HClass\uff09+ coretypes \u57fa\u7c7b \u5171\u540c\u6784\u6210 \u201cmirror \u7cfb\u7edf\u201d\u3002</p>"},{"location":"00_Master_Index/#3-vm-master-index","title":"3. VM \u751f\u547d\u5468\u671f\u603b\u89c8\uff08Master Index\uff09","text":"<p>\u4e0b\u9762\u7684\u7ae0\u8282\u987a\u5e8f\u6309\u201c\u542f\u52a8 -&gt; \u8fd0\u884c -&gt; \u9000\u51fa\u201d\u7684\u771f\u5b9e\u8def\u5f84\u7ec4\u7ec7\uff1b\u6bcf\u7ae0\u5148\u7ed9\u9636\u6bb5 1 \u7684\u67b6\u6784\u5730\u56fe\u4e0e\u7d22\u5f15\uff0c\u9636\u6bb5 2 \u518d\u586b\u6df1\u5165\u7ec6\u8282\u3002</p>"},{"location":"00_Master_Index/#31-chapter-index","title":"3.1 Chapter Index","text":"<ul> <li>Chapter 1\uff1a\u542f\u52a8\u4e0e\u5165\u53e3\u70b9\uff08CLI/ANI/zygote\u3001options\u3001logger\u3001Runtime Create/Destroy\uff09  </li> <li>\u89c1\uff1a<code>01_Startup_and_Entrypoints.md</code></li> <li>Chapter 2\uff1a\u5185\u5b58\u7ba1\u7406\u4e0e\u5bf9\u8c61\u5e03\u5c40\uff08Heap/Allocator\u3001GC\u3001barrier/safepoint\u3001ObjectHeader/coretypes\uff09  </li> <li>\u89c1\uff1a<code>02_Memory_Management_and_Object_Model.md</code></li> <li>Chapter 3\uff1a\u7c7b\u52a0\u8f7d\u4e0e\u94fe\u63a5\uff08PandaFile/Abc \u88c5\u8f7d\u3001ClassLinker\u3001Context\u3001ClassLinkerExtension\u3001AOT class context\uff09  </li> <li>\u89c1\uff1a<code>03_Class_Loading_and_Linking.md</code></li> <li>Chapter 4\uff1a\u6267\u884c\u5f15\u64ce\uff08Interpreter vreg/frame\u3001\u6865\u63a5\u3001JIT/AOT/IRTOC\u3001deopt/OSR\uff09  </li> <li>\u89c1\uff1a<code>04_Execution_Engine_Interpreter_JIT_AOT.md</code></li> <li>Chapter 5\uff1aNative \u6865\uff08ANI\u3001ETS Native library\u3001Interop JS\u3001\u7ebf\u7a0b attach/detach\uff09  </li> <li>\u89c1\uff1a<code>05_Native_Bridge_ANI_and_Interop.md</code></li> <li>Chapter 6\uff1a\u5de5\u5177\u94fe\u4e0e\u53ef\u89c2\u6d4b\u6027\uff08Inspector/Debugger\u3001Profiling\u3001Verification\uff09  </li> <li>\u89c1\uff1a<code>06_Tooling_Profiling_Verification.md</code></li> <li>Chapter 7\uff1a\u6784\u5efa\u4e0e\u914d\u7f6e\uff08GN/CMake\u3001options.yaml \u5408\u5e76\u3001\u751f\u6210\u7269\u5173\u7cfb\uff09  </li> <li>\u89c1\uff1a<code>07_Build_and_Configuration.md</code></li> </ul>"},{"location":"00_Master_Index/#4","title":"4. \u4e24\u6761\u5173\u952e\u542f\u52a8\u94fe\u8def\uff08\u7528\u4e8e\u8bfb\u4ee3\u7801\u7684\u201c\u4e3b\u5e72\u8def\u5f84\u201d\uff09","text":""},{"location":"00_Master_Index/#41-cli-pandapandacpp","title":"4.1 CLI \u542f\u52a8\u94fe\u8def\uff08<code>panda/panda.cpp</code>\uff09","text":"<pre><code>flowchart TD\n  cliMain[pandaMain] --&gt; parseArgs[PandArgParserParse]\n  parseArgs --&gt; validate[RuntimeOptionsValidate]\n  validate --&gt; initLogger[LoggerInitialize]\n  initLogger --&gt; runtimeCreate[RuntimeCreate]\n  runtimeCreate --&gt; initSpaces[CreateMemorySpaces]\n  initSpaces --&gt; createVm[CreatePandaVM]\n  createVm --&gt; initVm[InitializePandaVM]\n  initVm --&gt; startGc[StartGC]\n  startGc --&gt; executeFile[ExecutePandaFile]\n  executeFile --&gt; invoke[InvokeEntrypoint]\n  invoke --&gt; runtimeDestroy[RuntimeDestroy]</code></pre> <p>\u5173\u952e\u951a\u70b9\uff1a - <code>panda/panda.cpp</code>\uff1a<code>ark::Main()</code> \u8c03\u7528 <code>Runtime::Create(runtimeOptions)</code>\uff0c\u7136\u540e <code>ExecutePandaFile()</code>\uff0c\u6700\u540e <code>Runtime::Destroy()</code> - <code>runtime/runtime.cpp</code>\uff1a<code>Runtime::Create()</code> -&gt; <code>Runtime::Initialize()</code> -&gt; <code>CreatePandaVM/InitializePandaVM</code> \u7b49</p>"},{"location":"00_Master_Index/#42-anizygote-ani_createvm","title":"4.2 ANI/zygote \u542f\u52a8\u94fe\u8def\uff08<code>ANI_CreateVM</code>\uff09","text":"<pre><code>flowchart TD\n  aniCreate[ANICreateVM] --&gt; parseAni[ANIOptionsParserParse]\n  parseAni --&gt; initLogger[LoggerInitialize]\n  initLogger --&gt; runtimeCreate[RuntimeCreate]\n  runtimeCreate --&gt; coro[EtsCoroutineGetCurrent]\n  coro --&gt; vmGet[GetPandaVM]\n  vmGet --&gt; ok[ANI_OK]</code></pre> <p>\u5173\u952e\u951a\u70b9\uff1a - <code>plugins/ets/runtime/ani/ani_vm_api.cpp</code>\uff1a<code>ANI_CreateVM()</code>\u3001<code>ANI_GetCreatedVMs()</code>\u3001<code>AttachCurrentThread()</code>\u3001<code>DetachCurrentThread()</code></p>"},{"location":"00_Master_Index/#5","title":"5. \u5982\u4f55\u7528\u672c\u6307\u5357\u8bfb\u4ee3\u7801\uff08\u63a8\u8350\u8def\u5f84\uff09","text":"<ul> <li>\u4ece\u5165\u53e3\u5f00\u59cb\uff1a\u5148\u8bfb <code>01_Startup_and_Entrypoints.md</code>\uff0c\u628a <code>Runtime::Create/Initialize/Destroy</code> \u8fd9\u6761\u4e3b\u5e72\u8dd1\u901a\u3002</li> <li>\u518d\u770b\u4e24\u5927\u5e95\u5ea7\uff1a\u5185\u5b58\uff08Chapter 2\uff09\u4e0e\u7c7b\u52a0\u8f7d\uff08Chapter 3\uff09\u51b3\u5b9a\u4e86\u8fd0\u884c\u65f6\u6240\u6709\u5bf9\u8c61/\u65b9\u6cd5\u5982\u4f55\u51fa\u73b0\u4e0e\u5b58\u6d3b\u3002</li> <li>\u6700\u540e\u8fdb\u5165\u6267\u884c\u4e0e\u6865\uff1a\u89e3\u91ca\u5668 vreg/frame\u3001\u6865\u63a5\u3001JIT/AOT\uff08Chapter 4\uff09\u662f\u6027\u80fd\u4e0e\u6b63\u786e\u6027\u7684\u4ea4\u6c47\u5904\u3002</li> <li>\u505a\u8bed\u8a00/\u5e73\u53f0\u96c6\u6210\u65f6\uff1a\u4f18\u5148\u8bfb Chapter 5\uff08ANI/Interop\uff09\u4e0e Chapter 7\uff08\u6784\u5efa/\u914d\u7f6e\uff09\u3002</li> </ul> <p>\u8865\u5145\uff1a\u5982\u679c\u4f60\u5728\u5199/\u5ba1\u89c6\u6587\u6863\uff08\u800c\u4e0d\u4ec5\u662f\u8bfb\u4ee3\u7801\uff09\uff0c\u5efa\u8bae\u76f4\u63a5\u6309\u201c04 \u7ae0\u6c89\u6dc0\u7684\u65b9\u6cd5\u8bba\u6e05\u5355\u201d\u505a\u9a8c\u6536\u4e0e\u8865\u9f50\u95ed\u73af\uff1a - <code>00_Methodology_Wiki_Review_Checklist.md</code></p>"},{"location":"00_Methodology_Wiki_Review_Checklist/","title":"VM \u7ae0\u8282\u5ba1\u89c6\u4e0e\u4ea4\u4ed8\u65b9\u6cd5\u8bba\uff08\u590d\u7528 04 \u7ae0\u7ecf\u9a8c\u7684\u901a\u7528\u6e05\u5355\uff09","text":"<p>\u76ee\u6807\uff1a\u628a\u6bcf\u4e00\u7ae0\u4ea4\u4ed8\u4e3a\u201c\u65b0\u4eba\u53ef\u76f4\u63a5\u4e0a\u624b\u7406\u89e3\u4e0e\u6392\u969c + \u67b6\u6784\u65ad\u8a00\u53ef\u8ffd\u6eaf\u5230\u6e90\u7801\u201d\u7684\u7a33\u5b9a\u6587\u6863\u96c6\u3002 \u4f7f\u7528\u65b9\u5f0f\uff1a\u4ee5\u672c\u6e05\u5355\u505a\u7ae0\u8282\u9a8c\u6536\uff1b\u82e5\u53d1\u73b0\u7f3a\u53e3\uff0c\u6309\u201c\u5165\u53e3\u2192Flow\u2192DataStructures\u2192FileNotes\u2192Playbook\u2192\u5b8c\u5de5\u5ba1\u67e5\u201d\u8865\u9f50\u95ed\u73af\u3002</p>"},{"location":"00_Methodology_Wiki_Review_Checklist/#1","title":"1) \u7ae0\u8282\u4ea4\u4ed8\u7684\u6700\u5c0f\u7ec4\u6210\uff08\u5fc5\u987b\u9f50\uff09","text":"<ul> <li>\u5355\u4e00\u5165\u53e3\uff08Stage2 README\uff09\uff1a\u544a\u8bc9\u65b0\u4eba\u201c\u5148\u770b\u4ec0\u4e48\u3001\u4e3a\u4f55\u770b\u3001\u770b\u5b8c\u80fd\u505a\u4ec0\u4e48\u201d\uff0c\u5e76\u63d0\u4f9b 30min/2h/1d \u8def\u7ebf\u3002</li> <li>\u7aef\u5230\u7aef\u810a\u67f1\u56fe\uff08EndToEnd Flow\uff09\uff1a\u7528\u4e00\u5f20\u56fe\u628a\u4e3b\u94fe\u8def\u4e32\u8d77\u6765\uff1b\u6bcf\u4e2a\u6846\u90fd\u80fd\u4e0b\u6f5c\u5230\u5bf9\u5e94 Flow/DataStructures/FileNotes\u3002</li> <li>Flows\uff08\u8c03\u7528\u94fe\uff09\uff1a\u6bcf\u6761 Flow \u81f3\u5c11\u5305\u542b\uff1a</li> <li>\u201c0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e\u201d</li> <li>\u201c\u8bc1\u636e\u94fe\uff08\u53ef\u5ba1\u8ba1\u5230\u6e90\u7801\u6587\u4ef6/\u51fd\u6570/\u5173\u952e\u6761\u4ef6\uff09\u201d</li> <li>\u201c\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09\u201d</li> <li>DataStructures\uff08\u7ed3\u6784\u5361\u7247\uff09\uff1a\u6bcf\u5f20\u5361\u7247\u53ea\u5199\u4e09\u4ef6\u4e8b\uff1a\u662f\u4ec0\u4e48/\u4e0d\u53d8\u91cf/\u8c01\u5199\u8c01\u8bfb\uff0c\u5e76\u56de\u94fe\u5230 FileNotes\u3002</li> <li>FileNotes\uff08\u8bc1\u636e\u94fe\u5361\u7247\uff09\uff1a\u9ad8\u98ce\u9669\u65ad\u8a00\u5fc5\u987b\u80fd\u5b9a\u4f4d\u5230\u6e90\u7801\u51fd\u6570\u4e0e\u5173\u952e\u5206\u652f\uff08\u6700\u597d\u542b\u884c\u533a\u95f4/\u6761\u4ef6\uff09\u3002</li> <li>\u65b0\u4eba\u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff08MinDebug Playbook\uff09\uff1a\u80fd\u628a\u201c\u75c7\u72b6\u2192\u7b2c\u4e00\u843d\u70b9\u2192\u7b2c\u4e8c\u843d\u70b9\u201d\u8dd1\u901a\uff0c\u5e76\u7ed9 2\u20133 \u4e2a\u6700\u5c0f\u53ef\u590d\u73b0\u5b9e\u9a8c\u3002</li> <li>\u5b8c\u5de5\u5ba1\u67e5\uff08Completion Review\uff09\uff1a\u5217\u51fa P0 \u65ad\u8a00\u6e05\u5355 + \u5bf9\u5e94\u6e90\u7801\u8bc1\u636e\u70b9 + \u4ecd\u53ef\u4f18\u5316\u9879\u3002</li> </ul>"},{"location":"00_Methodology_Wiki_Review_Checklist/#2-p0","title":"2) \u67b6\u6784\u5e08\u89c6\u89d2\uff1aP0 \u65ad\u8a00\u5fc5\u987b\u5177\u5907\u201c\u8bc1\u636e\u94fe\u201d","text":"<p>\u628a\u7ae0\u8282\u91cc\u6700\u5bb9\u6613\u8bef\u5bfc/\u6700\u5bb9\u6613\u51fa\u4e8b\u6545\u7684\u7ed3\u8bba\uff0c\u5168\u90e8\u6539\u6210\u53ef\u6838\u9a8c\u7684\u65ad\u8a00\uff0c\u5e76\u7ed1\u5b9a\u8bc1\u636e\u70b9\uff1a</p> <ul> <li>\u9ed8\u8ba4\u503c/\u6700\u7ec8\u884c\u4e3a\u5dee\u5f02\uff1a\u4f8b\u5982\u201coptions \u9ed8\u8ba4\u503c vs \u6700\u7ec8\u9009\u578b/\u964d\u7ea7/\u5f3a\u5236\u7ea6\u675f\u201d\u8fd9\u79cd\uff0c\u5fc5\u987b\u5199\u6e05\u695a\u89e6\u53d1\u6761\u4ef6\u77e9\u9635\u3002</li> <li>\u5e76\u53d1/\u7ade\u6001\u8bed\u4e49\uff1a\u7f13\u5b58\u53bb\u91cd\u3001\u9501\u7c92\u5ea6\u3001\u540c\u4e00\u8d44\u6e90\u7684\u591a\u5904\u5199\u5165\u70b9\uff0c\u5fc5\u987b\u5199\u6e05\u695a\u201c\u8c01\u8d62/\u8c01\u56de\u6536/\u8c01\u7b49\u5f85\u201d\u3002</li> <li>\u5e73\u53f0/\u6784\u5efa\u5dee\u5f02\uff1a\u5b8f\u5f00\u5173\u3001\u67b6\u6784\u5206\u76ee\u5f55\u3001\u4e0d\u540c GC/\u4e0d\u540c\u8fd0\u884c\u6a21\u5f0f\uff08debug/release\uff09\u4e0b\u7684\u884c\u4e3a\u5dee\u5f02\uff0c\u5fc5\u987b\u663e\u5f0f\u5217\u51fa\u3002</li> <li>\u9519\u8bef\u4e0e\u5f02\u5e38\u8bed\u4e49\uff1a\u9519\u8bef\u7801/\u5f02\u5e38\u7c7b\u578b/\u5305\u88c5\u7b56\u7565\uff08\u4f8b\u5982 CNFE\u2192NCDFE\uff09\uff0c\u5fc5\u987b\u5199\u660e\u201c\u53d1\u751f\u70b9/\u5305\u88c5\u70b9/\u5bf9\u4e0a\u5c42\u542b\u4e49\u201d\u3002</li> <li>\u8de8\u7ae0\u4ea4\u754c\uff1a\u4f8b\u5982\u201c\u7c7b\u52a0\u8f7d\u2194\u521d\u59cb\u5316\u201d\u201c\u89e3\u91ca\u5668\u2194\u6865\u63a5\u2194\u7f16\u8bd1\u5668\u201d\uff0c\u5fc5\u987b\u4e92\u94fe\u5230\u4e0b\u4e00\u7ae0\u7684\u5165\u53e3\u6bb5\u843d\uff0c\u907f\u514d\u65ad\u94fe\u3002</li> </ul>"},{"location":"00_Methodology_Wiki_Review_Checklist/#3","title":"3) \u65b0\u4eba\u89c6\u89d2\uff1a\u5b66\u4e60\u8def\u5f84\u5fc5\u987b\u201c\u53ef\u6e10\u8fdb\u3001\u53ef\u843d\u5730\u201d","text":"<ul> <li>\u5148\u7ed9\u5fc3\u667a\u6a21\u578b\uff1a\u4e00\u53e5\u8bdd\u89e3\u91ca\u201c\u672c\u7ae0\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\u201d\uff0c\u518d\u7ed9\u810a\u67f1\u56fe\u3002</li> <li>\u518d\u7ed9\u6700\u77ed\u6392\u969c\u95ed\u73af\uff1a\u65b0\u4eba 10\u201315 \u5206\u949f\u80fd\u7528 Playbook \u627e\u5230\u7b2c\u4e00\u843d\u70b9\uff0c\u5e76\u77e5\u9053\u4e0b\u4e00\u6b65\u770b\u54ea\u91cc\u3002</li> <li>\u6700\u540e\u7ed9\u6df1\u5165\u8def\u7ebf\uff1a\u6bcf\u6761\u6df1\u5165\u70b9\u5fc5\u987b\u80fd\u6cbf\u7740 wiki \u4e00\u6b65\u6b65\u4e0b\u6f5c\uff0c\u4e0d\u7559\u201c\u6309\u9700/\u53ef\u9009\u6df1\u5316\u70b9\u201d\u60ac\u7a7a\u3002</li> </ul>"},{"location":"00_Methodology_Wiki_Review_Checklist/#4-playbook","title":"4) Playbook \u7684\u6700\u4f4e\u53ef\u7528\u6807\u51c6\uff08\u53ef\u590d\u73b0\uff09","text":"<ul> <li>\u5feb\u901f\u76ee\u5f55\uff1a\u5e38\u89c1\u75c7\u72b6\u5165\u53e3\uff08\u542f\u52a8\u5931\u8d25/\u627e\u4e0d\u5230\u7c7b/\u6027\u80fd\u56de\u9000/\u5d29\u6e83/\u5f02\u5e38\u7c7b\u578b\u4e0d\u5bf9\u2026\uff09\u3002</li> <li>\u51b3\u7b56\u77e9\u9635\uff1a\u628a\u201c\u914d\u7f6e/\u5e73\u53f0/\u8fd0\u884c\u6a21\u5f0f\u201d\u5bf9\u884c\u4e3a\u7684\u5f71\u54cd\u5217\u6210\u8868\uff08\u907f\u514d\u53e3\u53e3\u76f8\u4f20\uff09\u3002</li> <li>\u53ef\u590d\u73b0\u65e5\u5fd7\u53c2\u6570\uff1a\u7ed9\u4e00\u7ec4\u80fd\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u7684 logger/options\uff08\u7ec4\u4ef6/\u7ea7\u522b/\u5173\u952e\u5f00\u5173\uff09\u3002</li> <li>\u75c7\u72b6\u2192\u7b2c\u4e00\u843d\u70b9\u2192\u7b2c\u4e8c\u843d\u70b9\u8868\uff1a\u6bcf\u6761\u81f3\u5c11\u7ed9 1 \u4e2a\u6e90\u7801\u951a\u70b9 + 1 \u4e2a\u6587\u6863\u951a\u70b9\uff08Flow/FileNote\uff09\u3002</li> <li>\u6700\u5c0f\u5b9e\u9a8c\uff082\u20133 \u4e2a\uff09\uff1a\u6bcf\u4e2a\u5b9e\u9a8c\u5199\u6e05\u695a\uff1a</li> <li>\u76ee\u7684\uff08\u9a8c\u8bc1\u54ea\u4e2a\u65ad\u8a00\uff09</li> <li>\u64cd\u4f5c\uff08\u547d\u4ee4/\u53c2\u6570/\u8f93\u5165\uff09</li> <li>\u89c2\u6d4b\u70b9\uff08\u671f\u671b\u65e5\u5fd7/\u5173\u952e\u51fd\u6570/\u5173\u952e\u6761\u4ef6\uff09</li> </ul>"},{"location":"00_Methodology_Wiki_Review_Checklist/#5-definition-of-done","title":"5) \u5b8c\u5de5\u9a8c\u6536\uff08Definition of Done\uff09","text":"<ul> <li>README/Index/EndToEnd \u5f62\u6210\u201c\u5355\u4e00\u8def\u5f84\u201d\uff0c\u4e0d\u4f1a\u8ba9\u65b0\u4eba\u5728\u591a\u4e2a\u5165\u53e3\u95f4\u8ff7\u8def\u3002</li> <li>\u6240\u6709 P0 \u65ad\u8a00\u90fd\u6709\u6e90\u7801\u8bc1\u636e\u70b9\uff08\u81f3\u5c11\u5230\u6587\u4ef6+\u51fd\u6570+\u5173\u952e\u5206\u652f\u6761\u4ef6\uff09\u3002</li> <li>Flows \u4e0e DataStructures \u90fd\u6709\u201c0) \u4f4d\u7f6e/\u4e0b\u4e00\u6b65\u201d\uff0c\u5e76\u80fd\u81ea\u6d3d\u4e92\u94fe\u3002</li> <li>Playbook \u80fd\u95ed\u73af 80% \u5e38\u89c1\u95ee\u9898\uff08\u81f3\u5c11\u8986\u76d6\u672c\u7ae0 Top3 \u75c7\u72b6\uff09\u3002</li> <li>Completion Review \u660e\u786e\uff1a\u672c\u7ae0\u8303\u56f4\u3001P0 \u65ad\u8a00\u3001\u8bc1\u636e\u70b9\u3001\u5df2\u77e5\u9650\u5236/\u5f85\u4f18\u5316\u9879\u3002</li> </ul>"},{"location":"01_Startup_and_Entrypoints/","title":"Chapter 1\uff1a\u542f\u52a8\u4e0e\u5165\u53e3\u70b9\uff08Startup &amp; Entrypoints\uff09","text":"<p>\u672c\u7ae0\u628a\u201c\u600e\u4e48\u628a VM \u8dd1\u8d77\u6765\u201d\u62c6\u6210\u4e24\u6761\u4e3b\u8def\u5f84\uff1a\u547d\u4ee4\u884c\uff08CLI\uff09\u4e0e ANI/zygote\uff08\u901a\u8fc7 ETS \u63d2\u4ef6\uff09\u3002\u4f60\u8bfb\u4ee3\u7801\u65f6\u5efa\u8bae\u4ece\u672c\u7ae0\u5f00\u59cb\uff0c\u5148\u628a <code>Runtime::Create/Initialize/Destroy</code> \u8d70\u901a\u3002</p>"},{"location":"01_Startup_and_Entrypoints/#1","title":"1. \u542f\u52a8\u5165\u53e3\u603b\u8868","text":"\u573a\u666f \u5165\u53e3\u6587\u4ef6/\u51fd\u6570 \u5173\u952e\u52a8\u4f5c \u4ea7\u7269 CLI \u53ef\u6267\u884c\u6587\u4ef6 <code>panda/panda.cpp</code>\uff1a<code>main()</code> / <code>ark::Main()</code> \u89e3\u6790 runtime/compiler/logger options \u2192 <code>Runtime::Create()</code> \u2192 <code>ExecutePandaFile()</code> \u2192 <code>Runtime::Destroy()</code> \u8fd0\u884c\u6307\u5b9a <code>pandafile(.abc)</code> \u7684 entrypoint zygote/ANI \u521b\u5efa VM <code>plugins/ets/runtime/ani/ani_vm_api.cpp</code>\uff1a<code>ANI_CreateVM()</code> \u89e3\u6790 ANI options \u2192 \u521d\u59cb\u5316 logger \u2192 <code>Runtime::Create()</code> \u2192 \u83b7\u53d6 <code>EtsCoroutine</code> \u4e0e <code>PandaVM</code> \u8fd4\u56de <code>ani_vm*</code>\uff08\u5e95\u5c42\u6307\u5411 PandaVM\uff09"},{"location":"01_Startup_and_Entrypoints/#2-cli-main-executepandafile","title":"2. CLI \u8def\u5f84\uff1a\u4ece <code>main()</code> \u5230 <code>ExecutePandaFile()</code>","text":""},{"location":"01_Startup_and_Entrypoints/#21","title":"2.1 \u5173\u952e\u63a7\u5236\u6d41\uff08\u9ad8\u5c42\uff09","text":"<pre><code>flowchart TD\n  main[main] --&gt; arkMain[arkMain]\n  arkMain --&gt; parse[PandArgParserParse]\n  parse --&gt; validate[RuntimeOptionsValidate]\n  validate --&gt; initLogger[LoggerInitialize]\n  initLogger --&gt; runtimeCreate[RuntimeCreate]\n  runtimeCreate --&gt; runFile[ExecutePandaFile]\n  runFile --&gt; runtimeDestroy[RuntimeDestroy]</code></pre>"},{"location":"01_Startup_and_Entrypoints/#22","title":"2.2 \u5173\u952e\u951a\u70b9\uff08\u63a8\u8350\u9605\u8bfb\u987a\u5e8f\uff09","text":"<ul> <li>\u53c2\u6570\u4e0e options \u4f53\u7cfb</li> <li><code>panda/panda.cpp</code>\uff1a\u628a <code>RuntimeOptions</code>\u3001<code>logger::Options</code>\u3001<code>compiler::g_options</code> \u5168\u90e8\u6ce8\u518c\u5230\u540c\u4e00\u4e2a <code>PandArgParser</code></li> <li><code>runtime/options.yaml</code>\uff1aruntime options \u7684\u6e90\uff08\u4f1a\u7ecf\u751f\u6210\u5668\u751f\u6210 <code>runtime/include/runtime_options.h</code> \u7b49\uff09</li> <li>\u521b\u5efa/\u9500\u6bc1 Runtime</li> <li><code>runtime/runtime.cpp</code>\uff1a<code>Runtime::Create()</code> / <code>Runtime::Initialize()</code> / <code>Runtime::Destroy()</code></li> <li>\u6267\u884c\u5165\u53e3</li> <li><code>runtime/runtime.cpp</code>\uff1a<code>Runtime::ExecutePandaFile()</code> \u2192 <code>Runtime::Execute()</code> \u2192 <code>pandaVm_-&gt;InvokeEntrypoint()</code></li> </ul>"},{"location":"01_Startup_and_Entrypoints/#3-ani-ani_createvm-pandavm","title":"3. ANI \u8def\u5f84\uff1a\u4ece <code>ANI_CreateVM()</code> \u5230 <code>PandaVM</code>","text":""},{"location":"01_Startup_and_Entrypoints/#31","title":"3.1 \u5173\u952e\u63a7\u5236\u6d41\uff08\u9ad8\u5c42\uff09","text":"<pre><code>flowchart TD\n  aniCreate[ANICreateVM] --&gt; parseAni[ANIOptionsParserParse]\n  parseAni --&gt; initLogger[LoggerInitializeWithCallback]\n  initLogger --&gt; runtimeCreate[RuntimeCreate]\n  runtimeCreate --&gt; getCoro[EtsCoroutineGetCurrent]\n  getCoro --&gt; getVm[GetPandaVM]\n  getVm --&gt; returnVm[Return ani_vm]</code></pre>"},{"location":"01_Startup_and_Entrypoints/#32-attachdetachani","title":"3.2 \u7ebf\u7a0b attach/detach\uff08ANI \u8fd0\u884c\u671f\u5fc5\u5907\uff09","text":"<p>ANI \u4e0d\u4ec5\u63d0\u4f9b\u201c\u521b\u5efa VM\u201d\uff0c\u8fd8\u8d1f\u8d23\u628a native \u7ebf\u7a0b\u9644\u7740\u5230 VM\uff1a</p> <ul> <li>Attach</li> <li><code>plugins/ets/runtime/ani/ani_vm_api.cpp</code>\uff1a<code>AttachCurrentThread()</code></li> <li>\u5173\u952e\u884c\u4e3a\uff1a\u68c0\u67e5\u5f53\u524d\u7ebf\u7a0b\u672a attach \u2192 \u901a\u8fc7 <code>CoroutineManager</code> \u4e3a\u7ebf\u7a0b\u521b\u5efa\u201cexclusive worker coroutine\u201d \u2192 \u8fd4\u56de <code>ani_env*</code></li> <li>Detach</li> <li><code>plugins/ets/runtime/ani/ani_vm_api.cpp</code>\uff1a<code>DetachCurrentThread()</code></li> <li>\u5173\u952e\u884c\u4e3a\uff1a\u9500\u6bc1\u8be5 worker coroutine\uff1b\u82e5\u542f\u7528 interop\uff08JS\uff09\uff0c\u8fd8\u4f1a\u6e05\u7406 JS env</li> </ul> <p>\u8bfb\u4ee3\u7801\u63d0\u793a\uff1a\u8fd9\u6761\u94fe\u8def\u628a \u201c\u7ebf\u7a0b-\u534f\u7a0b-VM\u201d \u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u540e\u7eed\u4f60\u770b GC root / safepoint / handle scope \u65f6\uff0c\u4f1a\u9891\u7e41\u78b0\u5230 <code>ManagedThread</code> \u4e0e ETS \u7684 <code>EtsCoroutine</code>\u3002</p>"},{"location":"01_Startup_and_Entrypoints/#4-runtimecreateinitializedestroy","title":"4. Runtime::Create/Initialize/Destroy\uff1a\u542f\u52a8\u4e3b\u5e72\u9aa8\u67b6","text":""},{"location":"01_Startup_and_Entrypoints/#41-create-runtime","title":"4.1 Create\uff1a\u6700\u5c0f\u53ef\u8fd0\u884c Runtime \u7684\u5efa\u7acb","text":"<p>\u5728 <code>runtime/runtime.cpp</code> \u4e2d\uff0c<code>Runtime::Create()</code> \u7684\u5173\u952e\u9636\u6bb5\u53ef\u4ee5\u62bd\u8c61\u4e3a\uff1a</p> <ol> <li>\u521d\u59cb\u5316\u8fd0\u884c\u65f6\u7a7a\u95f4\u4e0e\u5185\u5b58\u6c60</li> <li><code>CreateMemorySpaces()</code>\uff1a\u6839\u636e <code>RuntimeOptions</code> \u521d\u59cb\u5316 <code>MemConfig</code>\uff0c\u5e76 <code>PoolManager::Initialize()</code></li> <li>\u521b\u5efa\u5185\u90e8\u5206\u914d\u5668</li> <li><code>RuntimeInternalAllocator::Create()</code>\uff1a\u4e3a runtime \u5185\u90e8\u5bf9\u8c61\uff08\u5305\u62ec GC \u5185\u90e8\u7ed3\u6784\u7b49\uff09\u63d0\u4f9b allocator</li> <li>\u521b\u5efa Runtime \u5355\u4f8b\u5b9e\u4f8b</li> <li><code>Runtime::CreateInstance()</code>\uff1a\u521d\u59cb\u5316 <code>Locks</code> / <code>Events</code> \u7b49\uff0c\u5e76\u6784\u9020 <code>Runtime(options, allocator)</code></li> <li>Initialize()\uff1a\u8fdb\u5165\u201c\u6709 PandaVM \u7684\u8fd0\u884c\u6001\u201d</li> <li>\u89c1 4.2</li> <li>StartGC()</li> <li><code>instance_-&gt;GetPandaVM()-&gt;StartGC()</code>\uff08\u521b\u5efa\u5b8c\u6210\u540e\u542f\u52a8 GC \u7ebf\u7a0b/\u673a\u5236\uff09</li> </ol>"},{"location":"01_Startup_and_Entrypoints/#42-initialize-pandavmclasslinkeraotjit","title":"4.2 Initialize\uff1a\u7ec4\u88c5 PandaVM\u3001ClassLinker\u3001AOT/JIT \u7b49","text":"<p><code>Runtime::Initialize()</code> \u7684\u6838\u5fc3\u6b65\u9aa4\uff08\u6309\u4ee3\u7801\u987a\u5e8f\uff09\uff1a</p> <ul> <li>Verifier \u914d\u7f6e</li> <li><code>LoadVerificationConfig()</code> + <code>InitializeVerifierRuntime()</code>\uff08\u82e5\u5f00\u542f verification\uff09</li> <li>CreatePandaVM(runtimeType)</li> <li><code>PandaVM::Create(this, options_, runtimeType)</code></li> <li><code>LoadBootPandaFiles()</code>\uff08\u6309\u8bed\u8a00\u4e0a\u4e0b\u6587\u51b3\u5b9a openMode\uff09</li> <li>\u8bbe\u7f6e AOT class context\uff1a<code>AotManager::SetBootClassContext/SetAppClassContext</code></li> <li>HandleAotOptions()</li> <li>\u901a\u8fc7 <code>FileManager::LoadAnFile()</code> \u52a0\u8f7d AOT \u6587\u4ef6\uff08\u5982\u6709\uff09</li> <li>InitializePandaVM()</li> <li><code>classLinker_-&gt;Initialize(...)</code></li> <li><code>pandaVm_-&gt;Initialize()</code></li> <li>SetThreadClassPointers()</li> <li>\u5728\u5f53\u524d <code>ManagedThread</code> \u4e0a\u7f13\u5b58\u5e38\u7528 Class \u6307\u9488\uff08String/Array roots \u7b49\uff09</li> <li>HandleJitOptions()</li> <li>\u8bbe\u7f6e\u4fe1\u53f7\u5904\u7406\uff08\u91c7\u6837\u3001NPE\u3001\u6808\u6ea2\u51fa\u7b49\uff09\uff0c\u5e76\u6839\u636e AOT/\u9009\u9879\u8c03\u6574</li> <li>pandaVm_-&gt;InitializeFinish()</li> </ul>"},{"location":"01_Startup_and_Entrypoints/#43-destroy-gc","title":"4.3 Destroy\uff1a\u9000\u51fa\u987a\u5e8f\uff08\u201c\u4e3a\u4ec0\u4e48\u8981\u5148\u505c\u7f16\u8bd1\u5668\uff0c\u518d\u505c GC\uff1f\u201d\uff09","text":"<p><code>Runtime::Destroy()</code> \u7684\u9000\u51fa\u987a\u5e8f\u9ad8\u5ea6\u5de5\u7a0b\u5316\uff0c\u6838\u5fc3\u70b9\u662f\u907f\u514d\u7ebf\u7a0b/\u7f16\u8bd1\u5668/GC \u7684\u4ea4\u53c9\u8d44\u6e90\u8bbf\u95ee\uff1a</p> <ul> <li>\u5148\u89e6\u53d1 <code>VmDeathEvent</code>\uff0c\u518d \u5148\u505c compiler/JIT\uff08\u907f\u514d compile memleak \u4e0e\u5e76\u53d1\u8bbf\u95ee\uff09</li> <li>\u518d\u5378\u8f7d debugger\uff08\u4ece listener \u94fe\u8def\u4e2d\u6458\u9664\uff09</li> <li><code>UninitializeThreads()</code> \u540e\u518d <code>StopGC()</code>\uff08\u6ce8\u91ca\u8bf4\u660e\uff1auninit \u53ef\u80fd\u6267\u884c managed code\uff0c\u9700\u8981 barrier\uff09</li> <li>\u6700\u540e\u91ca\u653e Runtime \u5355\u4f8b\u3001Finalize MemConfig/PoolManager \u7b49</li> </ul>"},{"location":"01_Startup_and_Entrypoints/#5-zygotefork","title":"5. \u4e0e zygote/fork \u76f8\u5173\u7684\u751f\u547d\u5468\u671f\u94a9\u5b50","text":"<p>\u5728 <code>runtime/runtime.cpp</code> \u4e2d\u53ef\u770b\u5230\uff1a</p> <ul> <li><code>Runtime::PreZygoteFork()</code> / <code>Runtime::PostZygoteFork()</code>\uff1a\u8f6c\u53d1\u7ed9 <code>pandaVm_</code></li> <li><code>Runtime::InitNonZygoteOrPostFork(...)</code>\uff1a\u7528\u4e8e fork \u540e\u7684\u975e zygote \u521d\u59cb\u5316\uff1b\u5185\u90e8\u4f1a <code>pandaVm_-&gt;PreStartup()</code> \u5e76\u6267\u884c <code>initHook()</code></li> </ul> <p>\u8fd9\u8bf4\u660e\u5de5\u7a0b\u9884\u7559\u4e86 Android/\u7c7b Android \u7684\u201czygote \u9884\u70ed + fork \u5b50\u8fdb\u7a0b\u201d\u8fd0\u884c\u6a21\u5f0f\uff0c\u4f46\u90e8\u5206\u6ce8\u91ca\u663e\u793a\u4ecd\u6709\u5f85\u96c6\u6210\u7684\u7cfb\u7edf\u670d\u52a1\uff08NativeBridge/ThreadPool/profile \u7b49\uff09\u3002</p>"},{"location":"01_Startup_and_Entrypoints/#6-2","title":"6. \u9636\u6bb5 2\uff08\u540e\u7eed\u6269\u5c55\u5efa\u8bae\uff09","text":"<ul> <li>\u628a <code>RuntimeOptions</code> \u7684\u5173\u952e\u5f00\u5173\u505a\u6210\u201c\u6309\u573a\u666f\u914d\u7f6e\u77e9\u9635\u201d\uff1adebug / AOT / JIT / verifier / profiling / interop</li> <li>\u8865\u9f50\u542f\u52a8\u65f6\u5e8f\u7684\u7ebf\u7a0b\u89c6\u89d2\uff1a\u8c01\u521b\u5efa\u4e86 GC \u7ebf\u7a0b\uff1f\u8c01\u521b\u5efa\u4e86 JIT worker\uff1f\u54ea\u4e2a\u65f6\u523b\u5141\u8bb8\u6267\u884c managed code\uff1f</li> <li>\u628a <code>FileManager</code>\u3001<code>panda_file</code>\uff08abc/zip\uff09\u4e0e AOT <code>*.an</code> \u7684\u88c5\u8f7d\u8def\u5f84\u753b\u6210\u4e00\u5f20\u56fe</li> </ul>"},{"location":"02_Memory_Management_and_Object_Model/","title":"Chapter 2\uff1a\u5185\u5b58\u7ba1\u7406\u4e0e\u5bf9\u8c61\u6a21\u578b\uff08Memory Management &amp; Object Model\uff09","text":"<p>\u672c\u7ae0\u56de\u7b54\u4e09\u4ef6\u4e8b\uff1a\u5bf9\u8c61\u5982\u4f55\u5206\u914d\u3001GC \u5982\u4f55\u8ffd\u8e2a/\u89e6\u53d1/\u56de\u6536\u3001\u4ee5\u53ca \u5bf9\u8c61\u5934/\u6838\u5fc3\u5bf9\u8c61\uff08coretypes\uff09\u957f\u4ec0\u4e48\u6837\u3002\u9636\u6bb5 1 \u4ee5\u201c\u67b6\u6784\u5730\u56fe + \u7d22\u5f15\u201d\u4e3a\u4e3b\uff0c\u4fbf\u4e8e\u4f60\u5feb\u901f\u5b9a\u4f4d\u5230\u53ef\u8bfb\u7684\u5173\u952e\u6587\u4ef6\u3002</p>"},{"location":"02_Memory_Management_and_Object_Model/#1","title":"1. \u7ec4\u4ef6\u5730\u56fe\uff08\u76ee\u5f55 \u2192 \u804c\u8d23\uff09","text":"\u5b50\u7cfb\u7edf \u76ee\u5f55 \u5173\u952e\u6587\u4ef6\uff08\u5efa\u8bae\u5165\u53e3\uff09 \u4f60\u80fd\u5728\u8fd9\u91cc\u627e\u5230\u4ec0\u4e48 HeapManager / \u5206\u914d\u5165\u53e3 <code>runtime/mem/</code> <code>runtime/mem/heap_manager.h</code>\u3001<code>runtime/mem/heap_manager.cpp</code> <code>AllocateObject/AllocateNonMovableObject</code>\u3001TLAB\u3001\u5bf9\u8c61\u7a7a\u95f4\u5224\u5b9a\uff08young/non-movable\uff09 \u5206\u914d\u5668\u5bb6\u65cf <code>runtime/mem/</code> <code>allocator.*</code>\u3001<code>runslots*</code>\u3001<code>region_allocator*</code>\u3001<code>bump-allocator*</code> \u4e0d\u540c size class/region/runslots \u5206\u914d\u7b56\u7565 GC \u603b\u63a5\u53e3 <code>runtime/mem/gc/</code> <code>runtime/mem/gc/gc.h</code>\u3001<code>runtime/mem/gc/gc.cpp</code> <code>GC::StartGC/StopGC/WaitForGC</code>\u3001root/phase/stats/worker \u6846\u67b6 GC \u5177\u4f53\u5b9e\u73b0 <code>runtime/mem/gc/*/</code> <code>stw-gc/</code>\u3001<code>gen-gc/</code>\u3001<code>g1/</code>\u3001<code>epsilon/</code>\u2026 STW/\u5206\u4ee3/G1/\u7a7a GC \u7b49\u5b9e\u73b0\u7ec6\u8282 \u89e6\u53d1\u5668\uff08Trigger\uff09 <code>runtime/mem/gc/</code> <code>runtime/mem/gc/gc_trigger.h</code> heap \u9608\u503c\u3001adaptive\u3001debug\u3001\u6309 Nth alloc \u7b49\u89e6\u53d1\u7b56\u7565 BarrierSet\uff08\u5199\u5c4f\u969c/\u8bfb\u5c4f\u969c\uff09 <code>runtime/mem/gc/</code> + <code>libarkbase/mem/</code> <code>runtime/mem/gc/gc_barrier_set.h</code> Interpreter \u8c03\u7528\u7684 <code>PreBarrier/PostBarrier</code> + \u7ed9 Compiler \u7684 operand \u63a5\u53e3 \u5bf9\u8c61\u5934 <code>runtime/</code> <code>runtime/include/object_header.h</code>\u3001<code>runtime/object_header.cpp</code>\u3001<code>runtime/mark_word.h</code>\u3001<code>runtime/object_header_config.h</code> MarkWord/ClassWord\u3001\u540c\u6b65/\u54c8\u5e0c/\u8f6c\u53d1\u5730\u5740\u3001\u5bf9\u8c61\u5927\u5c0f\u4e0e\u7c7b\u578b\u5224\u5b9a \u6838\u5fc3\u5bf9\u8c61\uff08Array/String\uff09 <code>runtime/include/coretypes/</code> + <code>runtime/coretypes/</code> <code>runtime/include/coretypes/array.h</code>\u3001<code>runtime/include/coretypes/string.h</code> <code>Array</code>/<code>String</code> \u7ee7\u627f <code>ObjectHeader</code>\uff0c\u5b9a\u4e49\u5e03\u5c40\u3001\u8bfb\u5199\u4e0e barrier \u4ea4\u4e92 \u8bbe\u8ba1\u6587\u6863\uff08\u5bf9\u9f50\u5b9e\u73b0\uff09 <code>docs/</code> <code>docs/memory-management.md</code> \u8bbe\u8ba1/\u672f\u8bed/\u5bf9\u8c61\u5934\u5e03\u5c40\u3001barrier/safepoint \u7406\u5ff5"},{"location":"02_Memory_Management_and_Object_Model/#2-new-object-heap","title":"2. \u5206\u914d\u4e3b\u8def\u5f84\uff1a\u4ece <code>new object</code> \u5230 Heap","text":""},{"location":"02_Memory_Management_and_Object_Model/#21","title":"2.1 \u5206\u914d\u5165\u53e3\u5728\u54ea\u91cc\uff1f","text":"<p>\u7edf\u4e00\u5165\u53e3\u662f <code>mem::HeapManager</code>\uff1a - <code>runtime/mem/heap_manager.h</code>\uff1a<code>AllocateObject()</code> / <code>AllocateNonMovableObject()</code> - <code>runtime/object_header.cpp</code>\uff1a<code>ObjectHeader::CreateObject()</code> \u5185\u90e8\u901a\u8fc7 <code>thread-&gt;GetVM()-&gt;GetHeapManager()</code> \u5206\u914d\u5bf9\u8c61 - <code>runtime/coretypes/string.cpp</code> / <code>runtime/coretypes/line_string.cpp</code>\uff1a\u5b57\u7b26\u4e32\u4e5f\u901a\u8fc7 <code>vm-&gt;GetHeapManager()-&gt;AllocateObject(...)</code> \u5206\u914d\uff08\u53ef movable \u6216 non-movable\uff09</p>"},{"location":"02_Memory_Management_and_Object_Model/#22-allocation","title":"2.2 Allocation \u6d41\u7a0b\u56fe\uff08\u6982\u5ff5\u7ea7\uff09","text":"<pre><code>flowchart TD\n  allocSite[AllocationSite] --&gt; createObj[ObjectHeaderCreateObject]\n  createObj --&gt; heapMgr[HeapManagerAllocate]\n  heapMgr --&gt; tlab{UseTLAB?}\n  tlab --&gt;|yes| fastPath[TLABFastAlloc]\n  tlab --&gt;|no| slowPath[ObjectAllocatorAlloc]\n  fastPath --&gt; initBits[GCInitGCBits]\n  slowPath --&gt; maybeTrigger{NeedGCTrigger?}\n  maybeTrigger --&gt;|yes| enqueueGc[GCTaskEnqueue]\n  maybeTrigger --&gt;|no| done[ReturnObjectHeader]\n  initBits --&gt; done</code></pre> <p>\u6ce8\uff1a\u5177\u4f53\u201c\u662f\u5426\u89e6\u53d1 GC\u201d\u7531 <code>GCTrigger</code> \u4e0e <code>GC::WaitForGC/Trigger</code> \u7ec4\u5408\u51b3\u5b9a\uff1bTLAB \u4e8b\u4ef6/\u7edf\u8ba1\u5728 <code>runtime/entrypoints/entrypoints.cpp</code> \u6709\u8bb0\u5f55\u70b9\uff08\u4f8b\u5982 slowpath alloc \u4e8b\u4ef6\u3001MemStats \u8bb0\u5f55\uff09\u3002</p>"},{"location":"02_Memory_Management_and_Object_Model/#3-gc-gc","title":"3. GC \u6846\u67b6\uff1aGC \u7684\u804c\u8d23\u8fb9\u754c\u4e0e\u4e3b\u7ebf\u7a0b\u6a21\u578b","text":""},{"location":"02_Memory_Management_and_Object_Model/#31-gc","title":"3.1 GC \u62bd\u8c61\u63a5\u53e3\u7684\u201c\u6700\u5c0f\u96c6\u5408\u201d","text":"<p>\u5728 <code>runtime/mem/gc/gc.h</code> \u4e2d\uff0cGC \u57fa\u7c7b\u63d0\u4f9b\u4e86\uff1a - \u751f\u547d\u5468\u671f\uff1a<code>Initialize(PandaVM*)</code>\u3001<code>StartGC()</code>\u3001<code>StopGC()</code> - \u4efb\u52a1\u6267\u884c\uff1a<code>WaitForGC(GCTask)</code>\u3001<code>WaitForGCInManaged(...)</code>\uff08\u5728 managed scope \u4e0b\u7b49\u5f85\uff09 - \u5bf9\u8c61\u5143\u6570\u636e\uff1a<code>InitGCBits(...)</code>\u3001<code>InitGCBitsForAllocationInTLAB(...)</code> - \u53ef\u89c2\u6d4b\u6027\uff1a<code>GCListener</code>\u3001<code>GCPhase</code>\u3001<code>GCStats</code>\u3001<code>GCWorkersTaskPool</code></p> <p>\u8bfb\u4ee3\u7801\u5efa\u8bae\uff1a\u5148\u770b <code>GC::StartGC/StopGC/WaitForGC</code> \u7684\u7ea6\u675f\uff0c\u518d\u8fdb\u5165\u5177\u4f53\u5b9e\u73b0\uff08G1/Gen/STW\uff09\u3002</p>"},{"location":"02_Memory_Management_and_Object_Model/#32-gc-trigger","title":"3.2 GC \u89e6\u53d1\u5668\uff08Trigger\uff09","text":"<p><code>runtime/mem/gc/gc_trigger.h</code> \u7ed9\u51fa\u53ef\u63d2\u62d4\u7684\u89e6\u53d1\u7b56\u7565\uff08\u793a\u4f8b\uff09\uff1a - <code>HEAP_TRIGGER</code>\uff1aheap size \u76f8\u5bf9\u4e0a\u6b21 GC \u589e\u957f\u4e00\u5b9a\u767e\u5206\u6bd4\u89e6\u53d1 - <code>ADAPTIVE_HEAP_TRIGGER</code>\uff1a\u81ea\u9002\u5e94\u9608\u503c\uff08\u4fdd\u5b58\u8fd1\u671f\u9608\u503c\u907f\u514d\u8fc7\u9891\uff09 - <code>DEBUG</code> / <code>DEBUG_NEVER</code> / <code>ON_NTH_ALLOC</code>\uff1a\u8c03\u8bd5/\u6d4b\u8bd5\u7b56\u7565</p> <p>\u5728\u5de5\u7a0b\u5c42\u9762\uff0c\u201c\u4f55\u65f6\u8dd1 GC\u201d\u901a\u5e38\u662f\uff1a</p> <pre><code>flowchart TD\n  alloc[Allocation] --&gt; memStats[MemStatsUpdate]\n  memStats --&gt; trigger[GCTriggerTriggerGcIfNeeded]\n  trigger --&gt;|enqueue| gcQueue[GCQueue]\n  gcQueue --&gt; gcThread[GCWorkerThread]</code></pre>"},{"location":"02_Memory_Management_and_Object_Model/#4-barrierset-gc","title":"4. BarrierSet\uff1a\u89e3\u91ca\u5668\u4e0e\u7f16\u8bd1\u5668\u5982\u4f55\u4e0e GC \u534f\u4f5c","text":""},{"location":"02_Memory_Management_and_Object_Model/#41-barrier","title":"4.1 \u4e3a\u4ec0\u4e48\u9700\u8981 Barrier\uff1f","text":"<p>GC \u9700\u8981\u5728\u5e76\u53d1\u6807\u8bb0/\u5206\u4ee3\u6536\u96c6\u4e2d\u4fdd\u6301\u5806\u4e00\u81f4\u6027\u4e0e remembered set/card table \u7684\u6b63\u786e\u6027\u3002\u5de5\u7a0b\u4e2d\u628a barrier \u62bd\u8c61\u4e3a <code>GCBarrierSet</code>\uff1a</p> <ul> <li>Interpreter \u4f7f\u7528\uff08\u76f4\u63a5\u8c03\u7528\uff09</li> <li><code>PreBarrier(void *preValAddr)</code></li> <li><code>PostBarrier(const void *objAddr, size_t offset, void *valAddr)</code></li> <li><code>PostBarrier(const void *objAddr, size_t offset, size_t count)</code></li> <li>Compiler \u4f7f\u7528\uff08\u751f\u6210 barrier \u7684 operand\uff09</li> <li><code>GetBarrierOperand(BarrierPosition, name)</code></li> </ul> <p>\u5bf9\u5e94\u6587\u4ef6\uff1a<code>runtime/mem/gc/gc_barrier_set.h</code></p>"},{"location":"02_Memory_Management_and_Object_Model/#42-g1","title":"4.2 \u5178\u578b\u5b9e\u73b0\uff1a\u5206\u4ee3\u5199\u5c4f\u969c / G1 \u5c4f\u969c","text":"<p><code>gc_barrier_set.h</code> \u91cc\u53ef\u4ee5\u76f4\u63a5\u770b\u5230\uff1a - <code>GCGenBarrierSet</code>\uff1a\u4f7f\u7528 <code>CardTable</code> + dirty card \u66f4\u65b0\uff08\u5178\u578b inter-generational barrier\uff09 - <code>GCG1BarrierSet</code>\uff1a\u66f4\u590d\u6742\uff0c\u6d89\u53ca thread-local card queue / ring buffer\uff08\u7528\u4e8e G1 remembered set \u66f4\u65b0\uff09</p>"},{"location":"02_Memory_Management_and_Object_Model/#5-objectheader-markwordclassword","title":"5. \u5bf9\u8c61\u6a21\u578b\uff1aObjectHeader + MarkWord/ClassWord","text":""},{"location":"02_Memory_Management_and_Object_Model/#51-objectheader","title":"5.1 ObjectHeader \u7684\u4e24\u5927\u804c\u8d23","text":"<p><code>runtime/include/object_header.h</code> \u660e\u786e\u628a\u804c\u8d23\u62c6\u4e3a\uff1a - Class word\uff1a\u7c7b\u578b/\u5143\u6570\u636e\uff08<code>ClassAddr&lt;T&gt;()</code>\uff09\u3001\u5b57\u6bb5\u8bbf\u95ee/\u7c7b\u578b\u5224\u65ad - Mark word\uff1a\u9501\uff08\u8f7b\u91cf/\u91cd\u91cf\uff09\u3001hash\u3001GC mark\u3001\u8f6c\u53d1\u5730\u5740\uff08forwarding\uff09</p> <p><code>runtime/mark_word.h</code> \u5219\u7ed9\u51fa\u4e0d\u540c\u5e73\u53f0\u914d\u7f6e\u4e0b MarkWord \u7684 bit layout\uff08\u9ad8\u7aef/\u4f4e\u7aef\u300132/64 \u4f4d\u6307\u9488\uff09\u3002</p>"},{"location":"02_Memory_Management_and_Object_Model/#52","title":"5.2 \u201c\u8f6c\u53d1\u5730\u5740\u201d\u610f\u5473\u7740\u4ec0\u4e48\uff1f","text":"<p>\u5f53\u5bf9\u8c61\u88ab\u79fb\u52a8 GC \u79fb\u52a8\u540e\uff0cMarkWord \u8fdb\u5165 <code>STATE_GC</code>\uff08forwarding\uff09\uff0c\u8fd9\u89e3\u91ca\u4e86\uff1a - \u4e3a\u4ec0\u4e48\u5bf9\u8c61\u5934\u9700\u8981\u4fdd\u5b58 forwarding address - \u4e3a\u4ec0\u4e48 <code>ObjectHeader::IsForwarded()</code> \u662f\u4e00\u4e2a\u9ad8\u9891\u5224\u65ad\u70b9\uff08\u5bf9\u8bfb barrier/\u66f4\u65b0\u6307\u9488\u975e\u5e38\u5173\u952e\uff09</p>"},{"location":"02_Memory_Management_and_Object_Model/#53-object-header","title":"5.3 object header \u914d\u7f6e\u70b9","text":"<p><code>runtime/object_header_config.h</code>\uff1a\u5f53\u524d\u901a\u8fc7 <code>#define HIGHENDSYSTEM</code> \u9009\u62e9 high-end \u914d\u7f6e\uff08hash in header \u7b49\uff09\uff0c\u5e76\u6309 <code>OBJECT_POINTER_SIZE</code> \u5206\u5316 32/64 \u4f4d\u3002</p>"},{"location":"02_Memory_Management_and_Object_Model/#6-coretypesarray-string","title":"6. \u6838\u5fc3\u5bf9\u8c61\uff08coretypes\uff09\uff1aArray \u4e0e String","text":""},{"location":"02_Memory_Management_and_Object_Model/#61-array","title":"6.1 Array","text":"<p><code>runtime/include/coretypes/array.h</code>\uff1a - <code>class Array : public ObjectHeader</code> - \u5e03\u5c40\u8981\u70b9\uff1a\u5bf9\u8c61\u5934 + <code>length_</code> + <code>data_[]</code> - \u5173\u952e\u70b9\uff1a<code>GetObject/SetObject</code> \u7b49 API \u4f1a\u7ed3\u5408 \u8bfb\u5199 barrier\uff08\u901a\u8fc7\u6a21\u677f\u53c2\u6570\u63a7\u5236 <code>NEED_READ_BARRIER/NEED_WRITE_BARRIER</code>\uff09</p>"},{"location":"02_Memory_Management_and_Object_Model/#62-string","title":"6.2 String","text":"<p><code>runtime/include/coretypes/string.h</code>\uff1a - <code>class String : public ObjectHeader</code> - \u652f\u6301\u538b\u7f29\u5b57\u7b26\u4e32\uff08<code>LineString::SetCompressedStringsEnabled</code>\uff09\uff0c\u591a\u79cd\u6765\u6e90\u6784\u5efa\uff08Utf8/Utf16/MUtf8\uff09 - \u5b57\u7b26\u4e32\u5b9e\u73b0\u4e0e <code>LanguageContext</code>/<code>PandaVM</code> \u5f3a\u7ed1\u5b9a\uff08\u521b\u5efa\u65f6\u9700\u8981 ctx \u4e0e vm\uff09</p>"},{"location":"02_Memory_Management_and_Object_Model/#7-2","title":"7. \u9636\u6bb5 2\uff08\u540e\u7eed\u6269\u5c55\u5efa\u8bae\uff09","text":"<ul> <li>\u628a heap space/region/young/tenured \u7684\u201c\u771f\u5b9e\u5b9e\u73b0\u7c7b\u201d\u8865\u9f50\uff1a\u5728 <code>runtime/mem/heap_space.*</code>\u3001<code>runtime/mem/gc/g1/*</code>\u3001<code>runtime/mem/gc/gen-gc/*</code> \u4e4b\u95f4\u5efa\u7acb\u4e00\u5f20\u7c7b\u56fe</li> <li>\u8865\u9f50 root \u679a\u4e3e\u4e0e\u626b\u63cf\u8def\u5f84\uff1a\u4ece <code>runtime/mem/gc/gc_root.*</code>\u3001<code>runtime/include/thread.h</code>\u3001<code>runtime/stack_walker.*</code> \u51fa\u53d1</li> <li>\u8865\u9f50 safepoint \u4e0e\u4fe1\u53f7\u534f\u4f5c\uff1a\u5bf9\u7167 <code>docs/memory-management.md</code> \u7684 safepoint \u8bbe\u8ba1\u6bb5\u843d\uff0c\u5173\u8054 runtime \u5b9e\u9645\u5b9e\u73b0\u70b9</li> </ul>"},{"location":"03_Class_Loading_and_Linking/","title":"Chapter 3\uff1a\u7c7b\u52a0\u8f7d\u4e0e\u94fe\u63a5\uff08Class Loading &amp; Linking\uff09","text":"<p>\u672c\u7ae0\u628a\u201c\u7c7b\u4ece\u54ea\u91cc\u6765\u3001\u600e\u4e48\u88ab\u94fe\u63a5\u6210\u53ef\u6267\u884c\u7684 Method/Class \u5bf9\u8c61\u201d\u62c6\u6210\u4e09\u4e2a\u5c42\u6b21\uff1a<code>FileManager</code>\uff08\u6587\u4ef6\u88c5\u8f7d\uff09\u2192 <code>ClassLinker</code>\uff08\u8bed\u8a00\u65e0\u5173\u5bb9\u5668\uff09\u2192 <code>ClassLinkerExtension/Context</code>\uff08\u8bed\u8a00\u6269\u5c55 + \u52a0\u8f7d\u4e0a\u4e0b\u6587\uff09\u3002</p>"},{"location":"03_Class_Loading_and_Linking/#1-abcpandafile-classmethod","title":"1. \u603b\u89c8\uff1a\u4ece abc/pandafile \u5230 Class/Method","text":"<pre><code>flowchart TD\n  inputFile[abc_or_zip] --&gt; openFile[OpenPandaFile]\n  openFile --&gt; addFile[ClassLinkerAddPandaFile]\n  addFile --&gt; resolveClass[ClassLinkerGetClass]\n  resolveClass --&gt; link[LinkMethodsFieldsVTable]\n  link --&gt; init[InitializeClassIfNeeded]\n  init --&gt; invoke[MethodInvoke]</code></pre>"},{"location":"03_Class_Loading_and_Linking/#11-classloading","title":"1.1 \u65b0\u624b\u5fc3\u667a\u6a21\u578b\uff1aClassLoading \u5230\u5e95\u201c\u52a0\u8f7d\u4e86\u4ec0\u4e48\u201d","text":"<ul> <li>\u52a0\u8f7d\uff08LoadClass\uff09\uff1a\u521b\u5efa\u5e76\u586b\u5145 <code>Class/Method/Field</code> \u5143\u6570\u636e\u5bf9\u8c61\uff0c\u6784\u5efa\u6d3e\u53d1\u8868\uff08vtable/itable/IMT\uff09\uff0c\u8ba1\u7b97\u5b57\u6bb5 offset \u4e0e\u5bf9\u8c61\u5927\u5c0f\uff0c\u5e76\u628a\u7ed3\u679c\u63d2\u5165 <code>ClassLinkerContext</code> \u7f13\u5b58\u3002</li> <li>\u521d\u59cb\u5316\uff08InitializeClass\uff09\uff1a\u8bed\u8a00\u76f8\u5173\uff08\u4f8b\u5982\u6267\u884c <code>&lt;clinit&gt;</code>\uff0c\u5f02\u5e38\u5305\u88c5\uff0c\u6821\u9a8c\u7b49\uff09\u3002\u672c\u7ae0\u53ea\u8986\u76d6\u201c\u63a5\u53e3\u70b9\u5728\u54ea\u91cc\u88ab\u8c03\u7528/\u7531\u8c01\u8c03\u7528\u201d\uff0c\u6267\u884c\u7ec6\u8282\u66f4\u504f\u6267\u884c\u5f15\u64ce\u4e0e\u9a8c\u8bc1\u7ae0\u8282\u3002</li> </ul> <p>\u5bf9\u5e94\u4ee3\u7801\u5165\u53e3\uff1a - \u6587\u4ef6\u88c5\u8f7d\uff1a<code>runtime/file_manager.cpp</code>\uff08<code>FileManager::LoadAbcFile</code> / <code>TryLoadAnFileForLocation</code> / <code>LoadAnFile</code>\uff09 - \u7c7b\u94fe\u63a5\u5668\uff1a<code>runtime/include/class_linker.h</code>\u3001<code>runtime/class_linker.cpp</code> - \u8bed\u8a00\u6269\u5c55\uff08\u62bd\u8c61 + \u9ed8\u8ba4\u5b9e\u73b0 + core/ETS \u843d\u5730\uff09\uff1a   - \u62bd\u8c61\u4e0e\u5bb9\u5668\uff1a<code>runtime/include/class_linker_extension.h</code>   - \u9ed8\u8ba4\u5b9e\u73b0\uff08Boot/AppContext LoadClass\u3001new/created/obsolete classes\u3001CNFE\u2192NCDFE \u5305\u88c5\uff09\uff1a<code>runtime/class_linker_extension.cpp</code>   - core\uff08PANDA_ASSEMBLY\uff09\u5b9e\u73b0\uff08roots \u81ea\u4e3e\u3001String \u5b50\u7c7b GC \u5143\u6570\u636e\u3001CreateClass NonMovable \u5206\u914d\uff09\uff1a<code>runtime/core/core_class_linker_extension.cpp</code>   - ETS fa\u00e7ade\uff08\u5bf9\u5916 API + async \u6ce8\u89e3\u89e3\u6790\uff09\uff1a<code>plugins/ets/runtime/ets_class_linker.h</code>\u3001<code>plugins/ets/runtime/ets_class_linker.cpp</code></p>"},{"location":"03_Class_Loading_and_Linking/#2-filemanagerpandafileabc-aotan","title":"2. FileManager\uff1aPandaFile/Abc \u4e0e AOT\uff08.an\uff09\u7684\u88c5\u8f7d","text":""},{"location":"03_Class_Loading_and_Linking/#21-boot-panda-files-panda-files","title":"2.1 Boot panda files \u4e0e\u5e94\u7528 panda files","text":"<p>\u5728 CLI \u8def\u5f84\u91cc\uff0c\u9ed8\u8ba4 boot panda file \u6765\u81ea <code>runtime/options.yaml</code> \u7684 <code>boot-panda-files</code>\uff08\u4f8b\u5982 <code>arkstdlib.abc</code>\uff09\uff0c\u5e94\u7528\u6587\u4ef6\u901a\u8fc7 <code>panda/panda.cpp</code> \u7684 tail args \u586b\u5165\uff08\u5e76\u53ef\u80fd\u88ab\u585e\u5230 boot list \u672b\u5c3e\uff0c\u89c1 <code>runtime/runtime.cpp</code> \u7684\u6ce8\u91ca\uff09\u3002</p>"},{"location":"03_Class_Loading_and_Linking/#22-loadabcfile-abc-classlinker","title":"2.2 LoadAbcFile\uff1a\u88c5\u8f7d abc \u5e76\u6ce8\u518c\u5230 ClassLinker","text":"<p><code>runtime/file_manager.cpp</code>\uff1a - \u901a\u8fc7 <code>panda_file::OpenPandaFile(location, \"\", openMode)</code> \u6253\u5f00\u6587\u4ef6 - \u82e5\u542f\u7528 <code>--enable-an</code> \u4e14\u975e ArkAOT\uff0c\u5c1d\u8bd5\u4e3a\u8be5 abc \u81ea\u52a8\u52a0\u8f7d\u540c\u540d <code>.an</code>\uff08AOT \u6587\u4ef6\uff09   - <code>TryLoadAnFileForLocation()</code>\uff1a\u5148\u770b <code>boot-an-location</code>\uff0c\u518d\u56de\u9000\u5230 abc \u6240\u5728\u76ee\u5f55   - \u6210\u529f\u540e\u53ef\u628a AOT \u7684 class hash table \u7ed1\u5b9a\u5230 pf\uff1a<code>pf-&gt;SetClassHashTable(...)</code> - \u6700\u7ec8\uff1a<code>runtime-&gt;GetClassLinker()-&gt;AddPandaFile(std::move(pf))</code></p>"},{"location":"03_Class_Loading_and_Linking/#221-mermaidloadabcfile-aot-an","title":"2.2.1 Mermaid\uff1aLoadAbcFile\uff08\u542b\u53ef\u9009 AOT <code>.an</code>\uff09\u65f6\u5e8f","text":"<pre><code>sequenceDiagram\n  participant FM as FileManager\n  participant PF as panda_file::File\n  participant CL as ClassLinker\n  participant AM as AotManager\n\n  FM-&gt;&gt;PF: OpenPandaFile(location)\n  alt enable-an &amp;&amp; !ArkAot\n    FM-&gt;&gt;FM: TryLoadAnFileForLocation(abcPath)\n    FM-&gt;&gt;AM: AddFile(anPath, gcType)\n    AM--&gt;&gt;FM: AotFile/PF hash table\n    FM-&gt;&gt;PF: pf-&gt;SetClassHashTable(...)\n  end\n  FM-&gt;&gt;CL: AddPandaFile(pf, context?)\n  note over CL: \u66f4\u65b0 pandaFiles/bootPandaFiles&lt;br/&gt;\u66f4\u65b0 boot bloom filter&lt;br/&gt;\u66f4\u65b0 AOT snapshot/\u901a\u77e5/\u8c03\u8bd5\u5143\u4fe1\u606f</code></pre>"},{"location":"03_Class_Loading_and_Linking/#23-loadanfileaot-aotmanager","title":"2.3 LoadAnFile\uff1aAOT \u6587\u4ef6\u8fdb\u5165 AotManager","text":"<p><code>FileManager::LoadAnFile()</code> \u4f1a\uff1a - \u8ba1\u7b97 <code>gcType = Runtime::GetGCType(...)</code>\uff08AOT \u9700\u8981\u4e0e GC \u914d\u7f6e\u4e00\u81f4\uff09 - <code>AotManager::AddFile(realAnFilePath, runtimeIface, gcType, force)</code> \u628a <code>.an</code> \u6ce8\u518c\u5230\u8fd0\u884c\u65f6</p>"},{"location":"03_Class_Loading_and_Linking/#3-classlinker","title":"3. ClassLinker\uff1a\u8bed\u8a00\u65e0\u5173\u7684\u201c\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5\u5bb9\u5668\u201d","text":"<p><code>runtime/include/class_linker.h</code> \u7684\u5b9a\u4f4d\u975e\u5e38\u660e\u786e\uff1aThread-safe + language-agnostic\u3002\u5b83\u63d0\u4f9b\uff1a</p> <ul> <li>GetClass / GetMethod / GetField\uff1a\u901a\u8fc7 descriptor \u6216 panda_file entityId \u89e3\u6790</li> <li>AddPandaFile\uff1a\u6ce8\u518c\u65b0\u7684 panda file\uff08boot \u6216 app context\uff09</li> <li>EnumeratePandaFiles / EnumerateBootPandaFiles\uff1a\u904d\u5386\u5df2\u88c5\u8f7d\u6587\u4ef6\u96c6\u5408</li> <li>AotManager\uff1a\u901a\u8fc7 <code>GetAotManager()</code> \u4e0e AOT \u5b50\u7cfb\u7edf\u8054\u52a8\uff08class context\u3001profile\u3001\u91cd\u94fe\u63a5\u7b49\uff09</li> </ul> <p>\u8bfb\u4ee3\u7801\u63d0\u793a\uff1a<code>ClassLinker</code> \u5185\u90e8\u628a \u201cboot files\u201d \u4e0e \u201cpandaFiles_\uff08\u542b context\uff09\u201d\u5206\u5f00\u7ba1\u7406\uff0c\u5e76\u7528 mutex \u4fdd\u62a4\uff1b\u4f60\u770b class \u67e5\u627e/\u7f13\u5b58/\u8fc7\u6ee4\uff08BloomFilter\uff09\u65f6\u975e\u5e38\u5173\u952e\u3002</p>"},{"location":"03_Class_Loading_and_Linking/#31-mermaidgetclass-loadclass","title":"3.1 Mermaid\uff1aGetClass \u2192 LoadClass \u7684\u4e3b\u7ba1\u7ebf\uff08\u6982\u5ff5\u56fe\uff09","text":"<pre><code>flowchart TD\n  A[\"GetClass(descriptor/pf,id)\"] --&gt; B{\"FindLoadedClass\\n(context \u7f13\u5b58)\"}\n  B --&gt;|\u547d\u4e2d| R1[\"\u8fd4\u56de Class*\"]\n  B --&gt;|\u672a\u547d\u4e2d| C{\"boot context?\"}\n  C --&gt;|\u662f| D[\"boot bloom filter + bootPandaFiles \u67e5 classId\"] --&gt; L[\"LoadClass(\u4e3b\u7ba1\u7ebf)\"]\n  C --&gt;|\u5426| E[\"context-&gt;LoadClass()\\n(ETS \u7279\u5316\u53ef\u5728\u6b64\u53d1\u751f)\"] --&gt; L\n  L --&gt; F[\"SetupClassInfo\\nCreate builders + compute size\"]\n  F --&gt; G[\"CreateClass(ext)\\nLoadMethods/LoadFields\"]\n  G --&gt; H[\"LinkMethods\\n(vtable/itable/IMT)\"]\n  H --&gt; I[\"LinkFields\\n(LayoutFields \u5199 offset/objectSize/refFields)\"]\n  I --&gt; J[\"InsertClass \u5e76\u53d1\u53bb\u91cd\\n(\u5931\u8d25\u5219\u56de\u6536\u65b0\u5bf9\u8c61)\"]\n  J --&gt; R2[\"\u8fd4\u56de Class* / nullptr\"]</code></pre>"},{"location":"03_Class_Loading_and_Linking/#4-contextclasslinkercontext-classlinkerextension","title":"4. Context\uff1aClassLinkerContext \u4e0e ClassLinkerExtension \u7684\u5206\u5de5","text":""},{"location":"03_Class_Loading_and_Linking/#41-classlinkercontext","title":"4.1 ClassLinkerContext\uff1a\u52a0\u8f7d\u4e0a\u4e0b\u6587\u4e0e\u5df2\u52a0\u8f7d\u7c7b\u8868","text":"<p><code>runtime/class_linker_context.h</code>\uff1a - <code>loadedClasses_</code>\uff1a\u4ee5 descriptor \u4e3a key \u7684\u5df2\u52a0\u8f7d\u7c7b\u8868\uff08\u7531 <code>InsertClass()</code>/<code>FindClass()</code> \u7ba1\u7406\uff09 - <code>EnumeratePandaFiles()</code>\uff1a\u9ed8\u8ba4\u7a7a\u5b9e\u73b0\uff0c\u4ea4\u7ed9\u5177\u4f53 context\uff08boot/app/\u94fe\u5f0f\u4e0a\u4e0b\u6587\uff09\u8986\u5199 - GC roots \u652f\u6491\uff1acontext \u5185\u7ef4\u62a4 <code>roots_</code>\uff0c\u63d0\u4f9b <code>VisitGCRoots</code>/<code>UpdateGCRoots</code> - \u5e76\u53d1\u534f\u8c03\uff1a\u4e3a\u6bcf\u4e2a Class \u7ef4\u62a4 <code>ClassMutexHandler</code>\uff08\u9012\u5f52 mutex + condvar\uff09\uff0c\u7528\u4e8e\u89e3\u51b3\u5e76\u53d1\u52a0\u8f7d/\u521d\u59cb\u5316\u7684\u534f\u8c03\u95ee\u9898</p>"},{"location":"03_Class_Loading_and_Linking/#42-classlinkerextension","title":"4.2 ClassLinkerExtension\uff1a\u8bed\u8a00\u6269\u5c55\u70b9","text":"<p><code>runtime/include/class_linker_extension.h</code>\uff1a - \u6bcf\u79cd\u8bed\u8a00\u4e00\u4e2a <code>ClassLinkerExtension(lang)</code> - \u5185\u7f6e <code>bootContext_</code>\uff0c\u5e76\u6301\u6709\u591a\u4e2a <code>contexts_</code>\uff08app contexts\uff09 - \u8d1f\u8d23\uff1a   - \u521d\u59cb\u5316 class roots\uff08<code>SetClassRoot</code> \u4f1a\u628a root \u63d2\u5165 boot context\uff09   - \u5b9e\u73b0 <code>InitializePrimitiveClass/ArrayClass/SyntheticClass</code> \u7b49\u8bed\u8a00\u5dee\u5f02   - \u63d0\u4f9b <code>GetNativeEntryPointFor(Method*)</code> \u7b49 native \u7ed1\u5b9a\u80fd\u529b   - \u521b\u5efa\u5e94\u7528 context\uff1a<code>CreateApplicationClassLinkerContext(path)</code>   - \u679a\u4e3e classes/contexts\uff08\u542b\u201c\u53ea\u679a\u4e3e\u65b0\u589e root\u201d\u4ee5\u652f\u6301\u5e76\u53d1 GC root recording\uff09</p>"},{"location":"03_Class_Loading_and_Linking/#43-mermaidbootcontext-appcontext-chained-contexts-dump","title":"4.3 Mermaid\uff1aBootContext / AppContext / Chained contexts\uff08\u4ee5\u53ca dump\uff09","text":"<pre><code>flowchart TD\n  subgraph OneLang[\"\u67d0\u4e00\u79cd\u8bed\u8a00\u7684 Extension\uff08\u793a\u610f\uff09\"]\n    Boot[\"BootContext\"]\n    App1[\"AppContext #1\"]\n    App2[\"AppContext #2\"]\n    Boot --&gt; App1\n    Boot --&gt; App2\n  end\n\n  subgraph Dump[\"Runtime::DumpForSigQuit\"]\n    D1[\"\u8f93\u51fa: -&gt; Dump class loaders\"] --&gt; D2[\"ClassLinker::EnumerateContextsForDump\"]\n  end\n\n  D2 --&gt; Boot\n  D2 --&gt; App1\n  D2 --&gt; App2</code></pre>"},{"location":"03_Class_Loading_and_Linking/#5-runtime-app-context-entrypoint","title":"5. Runtime \u5982\u4f55\u521b\u5efa App Context\uff1a\u4e0e entrypoint \u7ed1\u5b9a","text":"<p><code>runtime/runtime.cpp</code> \u4e2d\u7684 <code>Runtime::CreateApplicationClassLinkerContext(filename, entryPoint)</code> \u662f\u7406\u89e3\u201c\u5e94\u7528\u6587\u4ef6\u5982\u4f55\u8fdb\u5165 classloader\u201d\u6700\u76f4\u89c2\u7684\u5165\u53e3\uff1a</p> <ul> <li>\u5982\u679c\u6587\u4ef6\u672a\u5728 boot panda files \u4e2d\uff1a</li> <li><code>panda_file::OpenPandaFileOrZip(filename)</code> \u6253\u5f00\u6587\u4ef6</li> <li><code>ExtractLanguageContext(pf, entryPoint)</code>\uff1a\u4ece entrypoint \u65b9\u6cd5/\u7c7b\u63a8\u65ad SourceLang\uff08\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a Extension\uff09</li> <li><code>ext-&gt;CreateApplicationClassLinkerContext(appFiles)</code>\uff1a\u4e3a appFiles \u5efa\u7acb context</li> <li>\u679a\u4e3e context \u7684 panda files\uff0c\u751f\u6210 AOT app class context\uff1a<code>AotClassContextCollector</code> \u2192 <code>AotManager::SetAppClassContext(...)</code></li> </ul> <p>\u8fd9\u6bb5\u903b\u8f91\u628a \u201centrypoint\u201d \u4e0e \u201c\u8bed\u8a00\u9009\u62e9/\u52a0\u8f7d\u7b56\u7565\u201d\u7ed1\u5b9a\u5728\u4e00\u8d77\uff1a\u8fd0\u884c\u65f6\u5e76\u4e0d\u53ea\u9760\u6587\u4ef6\u6269\u5c55\u540d\u51b3\u5b9a\u8bed\u8a00\uff0c\u800c\u662f\u57fa\u4e8e panda file \u5143\u4fe1\u606f + entrypoint \u89e3\u6790\u51b3\u5b9a\u8bed\u8a00\u4e0a\u4e0b\u6587\u3002</p>"},{"location":"03_Class_Loading_and_Linking/#51-mermaidcreateapplicationclasslinkercontext-aot-app-class-context","title":"5.1 Mermaid\uff1aCreateApplicationClassLinkerContext\uff08\u542b AOT app class context\uff09","text":"<pre><code>sequenceDiagram\n  participant RT as Runtime\n  participant PF as panda_file::File\n  participant CL as ClassLinker\n  participant EXT as ClassLinkerExtension(lang)\n  participant AM as AotManager\n\n  RT-&gt;&gt;PF: OpenPandaFileOrZip(appFile)\n  RT-&gt;&gt;RT: ExtractLanguageContext(pf, entryPoint)\n  RT-&gt;&gt;EXT: CreateApplicationClassLinkerContext(appFiles)\n  EXT-&gt;&gt;CL: AddPandaFile(pf, appCtx)\n  RT-&gt;&gt;CL: EnumeratePandaFiles(appCtx)\n  RT-&gt;&gt;AM: SetAppClassContext(collectedCtx)</code></pre>"},{"location":"03_Class_Loading_and_Linking/#6-ets-etsclasslinkerextension-classlinker","title":"6. ETS \u6848\u4f8b\uff1aEtsClassLinkerExtension \u5982\u4f55\u6269\u5c55 ClassLinker","text":"<p>ETS \u63d2\u4ef6\u7ed9\u4e86\u4e00\u4e2a\u975e\u5e38\u597d\u7684\u201c\u8bed\u8a00\u6269\u5c55\u6a21\u677f\u201d\uff1a</p> <ul> <li><code>plugins/ets/runtime/ets_class_linker_extension.cpp</code></li> <li>\u5b9a\u4e49 ETS \u7684 error mapping\uff08\u628a <code>ClassLinker::Error</code> \u6620\u5c04\u6210 ETS \u4fa7\u5f02\u5e38 descriptor\uff09</li> <li>\u521d\u59cb\u5316 class roots\uff1aprimitive\u3001array\u3001string \u5b50\u7c7b\uff08Line/Sliced/TreeString\uff09\u7b49</li> <li>\u540c\u65f6\u4e5f\u53c2\u4e0e native/ANI \u4fa7\u7684\u7ea6\u675f\uff08\u4f8b\u5982\u5bf9 \u201cunsafe quick/direct\u201d \u6ce8\u89e3\u51b3\u5b9a native \u8c03\u7528\u6a21\u5f0f\uff09</li> <li><code>plugins/ets/runtime/ets_class_linker.h</code> / <code>plugins/ets/runtime/ets_class_linker.cpp</code></li> <li>\u4f5c\u4e3a\u5bf9\u5916 fa\u00e7ade\uff1a\u7f13\u5b58 <code>EtsClassLinkerExtension</code>\uff0c\u628a <code>Class*</code> \u8bed\u4e49\u5305\u88c5\u6210 <code>EtsClass*</code>\uff0c\u5e76\u63d0\u4f9b async \u6ce8\u89e3 \u2192 impl method \u7684\u89e3\u6790\u5165\u53e3\uff08\u5931\u8d25\u629b ETS \u94fe\u63a5\u5f02\u5e38\uff09</li> </ul> <p>\u8bfb\u4ee3\u7801\u63d0\u793a\uff1aString \u5b50\u7c7b\u7684 GC ref-fields \u5143\u6570\u636e\u5728 roots \u521d\u59cb\u5316\u9636\u6bb5\u5c31\u4f1a\u88ab\u56fa\u5316\uff08\u4e0d\u4ec5 ETS\uff0ccore \u8bed\u8a00\u4e5f\u540c\u6837\u5982\u6b64\uff09\u3002\u4f8b\u5982\uff1a - <code>runtime/core/core_class_linker_extension.cpp</code>\uff1a<code>FillStringClass</code> \u5bf9 <code>SLICED_STRING/TREE_STRING</code> \u5199 <code>refFieldsNum/refFieldsOffset/objectSize</code> - <code>plugins/ets/runtime/ets_class_linker_extension.cpp</code>\uff1aETS \u7684 String \u5b50\u7c7b\u6784\u5efa\u4e5f\u4f1a\u8bbe\u7f6e\u76f8\u540c\u4e00\u7c7b GC \u5143\u6570\u636e</p>"},{"location":"03_Class_Loading_and_Linking/#7-2","title":"7. \u9636\u6bb5 2\uff08\u6267\u884c\u72b6\u6001\u590d\u67e5\uff1a\u5df2\u5b8c\u6210 / \u4ecd\u5f85\u8865\u9f50\uff09","text":"<ul> <li>\u5df2\u5b8c\u6210\uff1a\u628a <code>runtime/class_linker.cpp</code> \u7684\u5173\u952e\u8def\u5f84\u62c6\u89e3\u5e76\u843d\u76d8\uff1a</li> <li>\u5bf9\u5e94 Stage2/03\uff1a<code>Runtime_Architecture_Internals_and_Developer_Guide/03_ClassLoading/Flows/*</code></li> <li>\u63a8\u8350\u4ece <code>03_ClassLoading/README.md</code> \u7684\u4e09\u5f20\u4e3b\u6d41\u7a0b\u56fe\u5f00\u59cb\uff0c\u518d\u987a\u7740 <code>03_ClassLoading/Index.md</code> \u6df1\u8bfb <code>FileNotes/runtime_class_linker.cpp.md</code></li> <li>\u4ecd\u5f85\u8865\u9f50\uff1aCHA \u4e0e AotManager \u7684\u4ea4\u4e92\u8865\u56fe\uff08VerifyClassHierarchy \u8c03\u7528\u70b9\u5728 Runtime\uff09\uff1a</li> <li>\u771f\u5b9e\u8c03\u7528\u70b9\uff1a<code>runtime/runtime.cpp</code>\uff08<code>CreatePandaVM</code> \u7b49\u8def\u5f84\u4f1a\u5728\u542f\u7528 CHA \u65f6\u8c03\u7528 <code>classLinker_-&gt;GetAotManager()-&gt;VerifyClassHierarchy()</code>\uff09</li> <li>\u5efa\u8bae\u5f52\u5c5e\uff1a\u66f4\u8d34\u8fd1\u201c\u542f\u52a8/\u8fd0\u884c\u65f6\u521d\u59cb\u5316\u201d\uff0c\u53ef\u653e\u5728 Stage2/01\uff08Startup\uff09\u6216\u5728 03 \u7ae0\u8865\u4e00\u4e2a\u201cRuntime \u4e0e ClassLinker/AotManager \u4ea4\u754c\u9762\u201d\u5c0f\u8282</li> <li>\u4ecd\u5f85\u8865\u9f50\uff1aclassloader/context \u5173\u7cfb\u56fe + <code>EnumerateContextsForDump</code> \u8f93\u51fa\u683c\u5f0f\uff1a</li> <li>\u771f\u5b9e\u8c03\u7528\u70b9\uff1a<code>runtime/runtime.cpp::DumpForSigQuit</code> \u4f1a\u8c03\u7528 <code>ClassLinker::EnumerateContextsForDump</code> \u5e76\u8f93\u51fa \u201cDump class loaders\u201d</li> <li>03 \u7ae0\u5f53\u524d\u5df2\u8986\u76d6\uff1a<code>ClassLinkerExtension</code>/<code>ClassLinkerContext</code> \u7684\u5bb9\u5668\u8bed\u4e49\u4e0e parent \u67e5\u627e\u63a5\u53e3\uff08\u89c1 Stage2/03 \u7684 <code>FileNotes/runtime_include_class_linker_extension.h.md</code> \u7b49\uff09</li> <li>\u4ecd\u7f3a\u5c11\uff1a\u628a \u201cboot context + app contexts + chained contexts\uff08parent loader\uff09\u201d \u753b\u6210\u4e00\u5f20\u53ef\u590d\u7528 Mermaid \u56fe\uff0c\u5e76\u914d\u4e00\u6bb5\u5bf9 dump \u8f93\u51fa\u7684\u89e3\u8bfb</li> </ul>"},{"location":"03_Class_Loading_and_Linking/#71-mermaidchaverifyclasshierarchy-runtime","title":"7.1 Mermaid\uff1aCHA/VerifyClassHierarchy \u5728 Runtime \u521d\u59cb\u5316\u8fb9\u754c\u7684\u4f4d\u7f6e\uff08\u8865\u56fe\uff09","text":"<pre><code>flowchart TD\n  A[\"Runtime::CreatePandaVM\"] --&gt; B[\"LoadBootPandaFiles\"]\n  B --&gt; C[\"AotManager::SetBootClassContext / SetAppClassContext\"]\n  C --&gt; D{\"LanguageContext.IsEnabledCHA() ?\"}\n  D --&gt;|\u662f| E[\"AotManager::VerifyClassHierarchy()\"]\n  D --&gt;|\u5426| F[\"\u8df3\u8fc7\"]\n  E --&gt; G[\"\u7ee7\u7eed VM \u521d\u59cb\u5316\"]\n  F --&gt; G</code></pre> <p>\u8bf4\u660e\uff1aCHA \u66f4\u504f\u201c\u7f16\u8bd1/\u4f18\u5316\u4e00\u81f4\u6027\u68c0\u67e5\u201d\uff0c\u4f46\u5b83\u5728 runtime \u521d\u59cb\u5316\u9636\u6bb5\u89e6\u53d1\uff0c\u6240\u4ee5\u5728\u9605\u8bfb ClassLoading \u65f6\u9700\u8981\u77e5\u9053\u5b83\u5c5e\u4e8e\u54ea\u4e00\u5c42\u3001\u5728\u54ea\u91cc\u53d1\u751f\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/","title":"Chapter 4\uff1a\u6267\u884c\u5f15\u64ce\uff08Interpreter / JIT / AOT / Bridge\uff09","text":"<p>\u672c\u7ae0\u5173\u6ce8\u201c\u4ee3\u7801\u600e\u4e48\u8dd1\u8d77\u6765\u201d\uff1a\u89e3\u91ca\u5668\u5982\u4f55\u6267\u884c bytecode\u3001\u89e3\u91ca\u5668\u4e0e\u7f16\u8bd1\u4ee3\u7801\u5982\u4f55\u4e92\u76f8\u8c03\u7528\uff08i2c/c2i bridge\uff09\u3001\u4ee5\u53ca JIT/AOT/IRTOC/quickener \u7b49\u201c\u6027\u80fd\u8def\u5f84\u201d\u5728\u5de5\u7a0b\u4e2d\u7684\u843d\u70b9\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#1","title":"1. \u6267\u884c\u5f15\u64ce\u5730\u56fe\uff08\u76ee\u5f55 \u2192 \u804c\u8d23\uff09","text":"\u7ec4\u4ef6 \u76ee\u5f55 \u5173\u952e\u951a\u70b9 \u8bf4\u660e \u89e3\u91ca\u5668 API <code>runtime/interpreter/</code> <code>runtime/interpreter/interpreter.h</code> <code>interpreter::Execute(thread, pc, frame)</code> \u662f\u89e3\u91ca\u5668\u5165\u53e3 \u89e3\u91ca\u5668\u5b9e\u73b0 <code>runtime/interpreter/</code> <code>runtime/interpreter/interpreter.cpp</code>\u3001<code>runtime/interpreter/interpreter_impl.cpp</code>\u3001<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\u3001<code>runtime/interpreter/interpreter-inl.h</code> <code>Execute()</code> \u8c03 <code>ExecuteImpl()</code>\uff1b\u4e3b\u5faa\u73af/dispatch table \u5728\u6784\u5efa\u671f\u7531 <code>interpreter-inl_gen.h.erb</code> \u751f\u6210\u5230 <code>interpreter-inl_gen.h</code>\uff0c\u800c <code>interpreter-inl.h</code> \u4e3b\u8981\u662f\u5927\u91cf <code>HandleXxx</code>\uff08opcode \u8bed\u4e49\u5b9e\u73b0\uff09 \u6267\u884c\u72b6\u6001\uff08\u5bc4\u5b58\u5668/\u5e27\uff09 <code>runtime/interpreter/</code> <code>runtime/interpreter/frame.h</code>\u3001<code>runtime/interpreter/vregister.h</code>\u3001<code>runtime/interpreter/acc_vregister.h</code> vreg-based frame layout\uff1b\u9759\u6001\u8bed\u8a00 mirror vregs \u5b58 tag\uff0c\u52a8\u6001\u8bed\u8a00\u4f7f\u7528 TaggedValue \u6865\u63a5\uff08i2c/c2i\uff09 <code>runtime/bridge/</code> <code>runtime/bridge/bridge.h</code>\u3001<code>runtime/bridge/bridge.cpp</code>\u3001<code>runtime/bridge/arch/*</code> \u89e3\u91ca\u5668\u2194\u7f16\u8bd1\u4ee3\u7801\u4e92\u8c03\uff1b\u6c47\u7f16\u5b9e\u73b0\u6309\u67b6\u6784\u5206\u76ee\u5f55 entrypoints\uff08\u8fd0\u884c\u65f6\u6162\u8def\u5f84\uff09 <code>runtime/entrypoints/</code> <code>runtime/entrypoints/entrypoints.cpp</code> \u5206\u914d\u3001\u5b57\u7b26\u4e32\u3001\u5f02\u5e38\u7b49\u6162\u8def\u5f84/\u8fd0\u884c\u65f6\u5165\u53e3\uff08\u4f9b\u7f16\u8bd1\u4ee3\u7801\u8c03\u7528\uff09 JIT \u7f16\u8bd1\u4e0e RuntimeInterface <code>runtime/</code> + <code>compiler/</code> <code>runtime/compiler.h</code>\u3001<code>runtime/compiler.cpp</code>\u3001<code>compiler/*</code> runtime \u4fa7\u63d0\u4f9b <code>PandaRuntimeInterface</code> \u7ed9 compiler \u89e3\u6790\u7c7b/\u65b9\u6cd5/\u5e38\u91cf/\u5c4f\u969c\u7b49 AOT \u7ba1\u7406 <code>compiler/aot/</code> <code>compiler/aot/aot_manager.h</code>\u3001<code>compiler/aot/aot_file.*</code> <code>.an</code> \u6587\u4ef6\u88c5\u8f7d\u3001class context\u3001snapshot index \u7b49 IRTOC\uff08IR\u2192Code \u5de5\u5177\uff09 <code>irtoc/</code> <code>irtoc/</code>\uff08\u5de5\u5177\u4e0e\u811a\u672c\uff09 \u5de5\u7a0b\u5185\u7f6e IRTOC \u5b50\u9879\u76ee\uff08README \u7b80\u7565\uff09 Quickening / Bytecode \u4f18\u5316 <code>quickener/</code>\u3001<code>bytecode_optimizer/</code> <code>quickener/quick.cpp</code>\u3001<code>bytecode_optimizer/optimize_bytecode.cpp</code> \u8fd0\u884c\u524d/\u6784\u5efa\u671f\u5b57\u8282\u7801\u6539\u5199\u4e0e\u4f18\u5316"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#2-vregister-based","title":"2. \u89e3\u91ca\u5668\uff1avregister-based \u7684\u6267\u884c\u6a21\u578b","text":""},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#20-irtocllvm-fast-interpreter-c","title":"2.0 \u771f\u5b9e\u9ed8\u8ba4\u8def\u5f84\uff1aIRTOC/LLVM fast interpreter\uff08\u5148\u7ea0\u6b63\u201c\u53ea\u770b C++\u201d\u7684\u8bef\u533a\uff09","text":"<p>\u672c\u4ed3\u5e93\u652f\u6301\u591a\u79cd\u89e3\u91ca\u5668\u5b9e\u73b0\uff08<code>runtime/options.yaml</code>\uff09\uff1a</p> <ul> <li><code>--interpreter-type=cpp</code>\uff1aC++ interpreter\uff08\u66f4\u9002\u5408 debug/\u65ad\u70b9\uff1b\u4e14 <code>--debug-mode=true</code> \u53ea\u80fd\u914d cpp\uff09</li> <li><code>--interpreter-type=irtoc</code>\uff1aIRTOC backend \u7684 fast interpreter</li> <li><code>--interpreter-type=llvm</code>\uff1aLLVM backend \u7684 fast interpreter\uff08\u9ed8\u8ba4\u503c\uff09</li> </ul> <p>\u8fd0\u884c\u65f6\u9009\u62e9\u53d1\u751f\u5728\uff1a<code>runtime/interpreter/interpreter_impl.cpp::GetInterpreterTypeFromRuntimeOptions/ExecuteImplType</code>\uff1a \u5b83\u4f1a\u5728\u7f16\u8bd1\u914d\u7f6e\u4e0d\u652f\u6301\u65f6\u505a\u964d\u7ea7\uff08\u4f8b\u5982\u672a\u7f16\u8bd1 LLVM interpreter \u65f6\uff0c\u9ed8\u8ba4 <code>llvm</code> \u4f1a\u964d\u7ea7\u5230 <code>irtoc</code>\uff1b\u672a\u7f16\u8bd1 IRTOC \u65f6\u518d\u964d\u7ea7\u5230 cpp\uff09\u3002</p> <p>\u8865\u5145\u51e0\u6761\u975e\u5e38\u5bb9\u6613\u8e29\u5751\u4f46\u5fc5\u987b\u5199\u8fdb\u8111\u5b50\u7684\u89c4\u5219\uff08\u90fd\u5728 <code>runtime/interpreter/interpreter_impl.cpp</code> \u91cc\u786c\u7f16\u7801\uff09\uff1a</p> <ul> <li>\u9ed8\u8ba4\u503c vs \u6700\u7ec8\u9009\u578b\uff1a<code>runtime/options.yaml</code> \u7684\u9ed8\u8ba4\u503c\u662f <code>llvm</code>\uff0c\u4f46\u6700\u7ec8\u9009\u578b\u53d6\u51b3\u4e8e frame \u662f\u5426 dynamic / \u662f\u5426\u663e\u5f0f\u8bbe\u7f6e / \u6784\u5efa\u662f\u5426\u542f\u7528 LLVM/IRTOC / \u8fd0\u884c\u65f6\u786c\u9650\u5236\uff08debug-mode/GC \u7b49\uff09\u3002</li> <li>\u9759\u6001\u8bed\u8a00\uff08\u975e dynamic frame\uff09\uff1a\u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u65f6\u4f1a\u8bfb\u53d6\u9ed8\u8ba4\u503c <code>llvm</code>\uff1b\u82e5\u8be5\u6784\u5efa\u672a\u542f\u7528 LLVM\uff0c\u5219\u4f1a\u81ea\u52a8\u964d\u7ea7\u5230 IRTOC\uff1b\u82e5\u4e5f\u672a\u542f\u7528 IRTOC\uff0c\u5219\u7ee7\u7eed\u964d\u7ea7\u5230 cpp\u3002</li> <li>\u52a8\u6001\u8bed\u8a00\uff08dynamic frame\uff09\u9ed8\u8ba4\u603b\u662f cpp\uff1a\u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u65f6\uff0c\u5373\u4fbf options \u9ed8\u8ba4\u662f <code>llvm</code>\uff0cdynamic frame \u4ecd\u4f1a\u5f3a\u5236\u8d70 cpp\uff08\u6e90\u7801\u6ce8\u91ca\u539f\u6587\uff1a<code>Dynamic languages default is always cpp interpreter (unless option was set)</code>\uff09\u3002   \u53ea\u6709\u5f53\u4f60\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type=irtoc/llvm</code> \u65f6\uff0cdynamic \u624d\u4f1a\u5c1d\u8bd5\u8d70 fast interpreter\uff0c\u5e76\u89e6\u53d1 GC/Profiler \u7b49\u7ea6\u675f\u68c0\u67e5\u3002</li> <li>\u201c\u81ea\u52a8\u964d\u7ea7\u201d\u53ea\u5bf9\u672a\u663e\u5f0f\u8bbe\u7f6e\u751f\u6548\uff1a\u4e00\u65e6\u4f60\u663e\u5f0f\u6307\u5b9a <code>--interpreter-type=llvm/irtoc</code>\uff0c\u800c\u5f53\u524d\u6784\u5efa\u4e0d\u652f\u6301\u8be5\u540e\u7aef\uff08\u4f8b\u5982\u672a\u7f16\u8fdb LLVM/IRTOC\uff09\uff0c\u8fd0\u884c\u65f6\u4f1a <code>LOG(FATAL)</code> \u76f4\u63a5\u9000\u51fa\uff0c\u4e0d\u4f1a\u81ea\u52a8\u964d\u7ea7\u3002</li> <li>ARK_HYBRID \u7ea6\u675f\u662f\u6761\u4ef6\u6210\u7acb\u7684\uff1a\u53ea\u6709\u5f53\u7f16\u8bd1\u5b8f <code>ARK_HYBRID</code> \u6253\u5f00\u65f6\uff0c\u624d\u4f1a\u51fa\u73b0 \u201cinterpreter-type&gt;cpp \u9700\u8981 <code>cmc-gc</code>\u3001\u4ee5\u53ca <code>--interpreter-type=llvm</code> \u76f4\u63a5 FATAL\u201d \u8fd9\u7ec4\u7ea6\u675f\uff1b\u975e ARK_HYBRID \u6784\u5efa\u4e0b\uff08\u4f8b\u5982\u5e38\u89c1 G1GC\uff09\u4e0d\u9002\u7528\u3002</li> <li>\u5173\u4e8e build/ \u76ee\u5f55\u7684\u63d0\u9192\uff1a\u4ed3\u5e93\u5185 <code>build/</code> \u4ea7\u7269\u662f\u201c\u5f53\u524d\u8fd9\u6b21\u7f16\u8bd1\u201d\u7684\u8f93\u51fa\uff1b\u672c\u673a linux/amd64 \u7684 <code>build/</code> \u4e0d\u80fd\u76f4\u63a5\u63a8\u65ad\u624b\u673a android/arm64 \u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u9a8c\u8bc1 fast interpreter/dispatch table \u65f6\u8bf7\u4ee5 \u5bf9\u5e94\u76ee\u6807\u5e73\u53f0\u7684\u6784\u5efa\u4ea7\u7269\u4e3a\u51c6\u3002</li> </ul> <p>\u91cd\u8981\u63d0\u9192\uff1a\u4f60\u5728 <code>runtime/interpreter/interpreter-inl.h</code> \u91cc\u8bfb\u5230\u7684\u5927\u91cf C++ handler\uff0c\u66f4\u591a\u662f\u201c\u8bed\u4e49\u5bf9\u7167/\u8c03\u8bd5\u8def\u5f84\u201d\uff1b\u751f\u4ea7\u9ed8\u8ba4\u66f4\u5e38\u8d70 fast interpreter \u7684 <code>HANDLE_FAST_*</code>\uff08\u7531 <code>irtoc/scripts/interpreter.irt</code> \u751f\u6210\uff09\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#21","title":"2.1 \u6700\u5c0f\u8c03\u7528\u94fe","text":"<p><code>runtime/interpreter/interpreter.cpp</code>\uff1a - <code>interpreter::Execute(...)</code> \u2192 <code>ExecuteImpl(...)</code> \u2192 <code>RESTORE_GLOBAL_REGS()</code></p> <p>\u5173\u952e\u70b9\uff1a - <code>ExecuteImpl</code> \u7684\u5165\u53e3\u9009\u62e9\u4e0e\u53c2\u6570\u68c0\u67e5\u5728 <code>runtime/interpreter/interpreter_impl.cpp</code>\uff0c\u5e76\u4f1a <code>#include \"interpreter-inl_gen.h\"</code>\uff08\u6784\u5efa\u65f6\u751f\u6210\uff09\u3002 - \u89e3\u91ca\u5668\u4e3b\u5faa\u73af\uff08dispatch table + <code>DISPATCH(...)</code> computed-goto + <code>EXCEPTION_HANDLER</code>\uff09\u6765\u81ea\u751f\u6210\u5934 <code>interpreter-inl_gen.h</code>\uff1a   - \u6a21\u677f\u6e90\u6587\u4ef6\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>   - <code>DISPATCH</code> \u5b8f\uff1a<code>runtime/interpreter/arch/macros.h</code>   - \u63d2\u4ef6\u6269\u5c55\u70b9\u805a\u5408\uff1a<code>runtime/templates/plugins_interpreters-inl.h.erb</code> \u2192 <code>plugins_interpreters-inl.h</code> - <code>runtime/interpreter/interpreter-inl.h</code> \u7684\u5b9a\u4f4d\u66f4\u51c6\u786e\u5730\u8bf4\u662f\uff1a\u5927\u91cf opcode \u7684 <code>InstructionHandler::HandleXxx</code> \u8bed\u4e49\u5b9e\u73b0 + stackless \u8c03\u7528/\u8fd4\u56de/\u627e catch \u7684 helper\uff08\u4f53\u91cf\u5927\uff0c\u5efa\u8bae\u5e26\u7740 opcode/handler \u540d\u79f0\u53bb grep\uff09\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#22-framevregisteracc","title":"2.2 Frame/VRegister/Acc\uff1a\u5bc4\u5b58\u5668\u4e0e\u5e27\u7684\u8bc1\u636e","text":"<p>\u5728 <code>runtime/interpreter/frame.h</code> \u7684\u6ce8\u91ca\u91cc\uff0cframe layout \u88ab\u660e\u786e\u753b\u51fa\u6765\uff1a - \u9759\u6001\u8bed\u8a00\uff1apayload vregs + mirror vregs\uff08mirror \u7528\u4e8e tag\uff0c\u533a\u5206\u5bf9\u8c61/\u539f\u59cb\u503c\uff09 - \u52a8\u6001\u8bed\u8a00\uff1a\u4ec5 payload vregs\uff08\u503c\u672c\u8eab\u643a\u5e26 tag\uff0c\u4f8b\u5982 TaggedValue\uff09</p> <p><code>runtime/interpreter/vregister.h</code> \u8fdb\u4e00\u6b65\u63d0\u4f9b\uff1a - <code>VRegister</code>\uff1a\u7eaf 64-bit payload - <code>StaticVRegisterRef</code>\uff1apayload + mirror\uff08tag \u5b58\u5728 mirror\uff09 - <code>DynamicVRegisterRef</code>\uff1apayload \u91cc\u5b58 TaggedValue raw data\uff0c\u7528 <code>IsHeapObject()</code> \u5224\u5b9a\u5bf9\u8c61</p> <p>\u8fd9\u5957\u8bbe\u8ba1\u76f4\u63a5\u7ed9\u51fa\u7ed3\u8bba\uff1a\u89e3\u91ca\u5668\u4ee5 \u865a\u62df\u5bc4\u5b58\u5668\uff08vreg\uff09 \u4e3a\u6838\u5fc3\uff0c\u5c5e\u4e8e register-based VM\uff08\u975e\u5e38\u63a5\u8fd1 ART/dex \u7684\u6267\u884c\u98ce\u683c\uff09\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#23-catch","title":"2.3 \u5f02\u5e38\u5904\u7406\uff1a\u89e3\u91ca\u5668\u4fa7\u662f\u201c\u4e24\u6bb5\u5f0f\u201d\u627e catch","text":"<p>\u5f53 bytecode handler \u89e6\u53d1\u5f02\u5e38\u65f6\uff08\u4f8b\u5982 NPE/\u8d8a\u754c/\u663e\u5f0f throw\uff09\uff0c\u89e3\u91ca\u5668\u4f1a\u8d70\u7edf\u4e00\u5f02\u5e38\u5165\u53e3\uff1a</p> <ul> <li>\u7b2c\u4e00\u6bb5\uff1astackless IFrames \u5185 unwind</li> <li><code>interpreter-inl.h</code> \u4e2d\u7684 <code>FindCatchBlockStackless()</code> \u8d1f\u8d23\u5728 stackless \u89e3\u91ca\u5668\u5e27\u94fe\u4e0a\u5411\u4e0a\u627e catch\uff0c\u5fc5\u8981\u65f6 <code>FreeFrame</code> \u5e76\u56de\u5230 caller frame\u3002</li> <li>\u7b2c\u4e8c\u6bb5\uff1a\u9700\u8981\u65f6\u8fdb\u5165 CFrames \u641c\u7d22\u5e76 deopt \u56de\u89e3\u91ca\u5668</li> <li>\u751f\u6210\u7684 <code>interpreter-inl_gen.h</code>\uff08\u6765\u81ea <code>interpreter-inl_gen.h.erb</code>\uff09\u5728 <code>EXCEPTION_HANDLER</code> \u4e2d\uff0c\u82e5\u7b2c\u4e00\u6bb5\u8fd4\u56de <code>INVALID_OFFSET</code>\uff0c\u4f1a\uff08\u5728\u90e8\u5206\u67b6\u6784\u4e0a\uff09<code>return FindCatchBlockInCallStack(thread)</code>\u3002</li> <li><code>runtime/exceptions.cpp</code> \u5b9e\u73b0 <code>FindCatchBlockInCallStack/FindCatchBlockInCFrames</code>\uff1a\u7528 <code>StackWalker</code> \u904d\u5386\u7f16\u8bd1\u5e27\uff0c\u627e\u5230 catch \u540e\u8c03\u7528 <code>Deoptimize(stack, method-&gt;GetInstructions()+pcOffset)</code> \u56de\u5230\u89e3\u91ca\u5668\u7684 catch pc \u7ee7\u7eed\u6267\u884c\u3002</li> </ul>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#3-bridge","title":"3. Bridge\uff1a\u89e3\u91ca\u5668 \u2194 \u7f16\u8bd1\u4ee3\u7801\u7684\u53cc\u5411\u8df3\u8f6c","text":""},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#31","title":"3.1 \u5bf9\u5916\u53ef\u89c1\u7684\u6865\u63a5\u7b26\u53f7","text":"<p><code>runtime/bridge/bridge.h</code> \u58f0\u660e\u4e86\u5173\u952e ABI\uff1a - <code>InterpreterToCompiledCodeBridge(...)</code> / <code>InterpreterToCompiledCodeBridgeDyn(...)</code> - <code>CompiledCodeToInterpreterBridge()</code> / <code>CompiledCodeToInterpreterBridgeDyn()</code> - <code>InvokeInterpreter(...)</code>\uff1a\u4ece\u7279\u5b9a pc+frame \u8c03\u56de\u89e3\u91ca\u5668\u6267\u884c</p> <p>\u5e76\u5728 <code>runtime/bridge/arch/*</code> \u4e0b\u6309 CPU \u67b6\u6784\u63d0\u4f9b\u6c47\u7f16\u5b9e\u73b0\uff08aarch64/amd64/arm/x86\uff09\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#32-c2ideopt","title":"3.2 c2i\uff1a\u7f16\u8bd1\u4ee3\u7801\u56de\u9000\u89e3\u91ca\u5668\uff08deopt/\u5f02\u5e38\u8def\u5f84\u5e38\u7528\uff09","text":"<p><code>runtime/bridge/bridge.cpp</code> \u7684 <code>InvokeInterpreter(...)</code> \u5c55\u793a\u4e86\u5178\u578b\u201c\u4ece\u7f16\u8bd1\u6001\u56de\u89e3\u91ca\u5668\u201d\u7684\u9aa8\u67b6\uff1a - \u8bbe\u5b9a <code>thread-&gt;SetCurrentFrame(frame)</code> \u5e76\u6807\u8bb0 <code>IsCompiled=false</code> - <code>interpreter::Execute(thread, pc, frame, ...)</code> - \u4ece <code>frame-&gt;GetAcc()</code> \u53d6\u56de\u8fd4\u56de\u503c\uff08\u9759\u6001/\u52a8\u6001\u5206\u652f\u4e0d\u540c\uff09 - <code>FreeFrame(frame)</code> \u5e76\u6062\u590d previous frame kind</p> <p>\u540c\u65f6\u53ef\u770b\u5230\u5bf9 <code>INITOBJ_*</code> \u6307\u4ee4\u7684\u7279\u6b8a\u5904\u7406\u6ce8\u91ca\uff1a\u8bf4\u660e\u7f16\u8bd1\u5668\u53ef\u80fd\u628a\u67d0\u4e9b\u5b57\u8282\u7801\u62c6\u5206\u4e3a\u591a\u6761\u6307\u4ee4\uff0cdeopt \u65f6\u9700\u8981\u4fdd\u6301 acc \u8bed\u4e49\u4e00\u81f4\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#33-i2c","title":"3.3 i2c\uff1a\u89e3\u91ca\u5668\u8c03\u7528\u5df2\u7f16\u8bd1\u5165\u53e3","text":"<p>\u5728 <code>runtime/interpreter/interpreter-inl.h</code> \u4e2d\u53ef\u4ee5\u76f4\u63a5\u770b\u5230\u8c03\u7528\u6865\u7684\u7b26\u53f7\uff08\u901a\u8fc7 grep \u53ef\u5b9a\u4f4d\uff09\uff1a - <code>InterpreterToCompiledCodeBridge(...)</code> - <code>InterpreterToCompiledCodeBridgeDyn(...)</code></p> <p>\u8fd9\u610f\u5473\u7740\uff1a\u89e3\u91ca\u5668\u6267\u884c\u5230\u67d0\u4e2a call/dispatch \u70b9\u65f6\uff0c\u4f1a\u6839\u636e <code>Method</code> \u7684 compiled entrypoint \u51b3\u5b9a\u8d70\u89e3\u91ca\u5668\u5185\u5b9e\u73b0\u8fd8\u662f\u8df3\u5230\u7f16\u8bd1\u4ee3\u7801\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#4-jitruntimecompiler-compiler","title":"4. JIT\uff1aruntime/compiler \u4e0e compiler \u5b50\u9879\u76ee\u5982\u4f55\u5bf9\u63a5","text":""},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#41-runtimeinterface-runtime","title":"4.1 RuntimeInterface\uff1a\u7f16\u8bd1\u5668\u9700\u8981 runtime \u63d0\u4f9b\u54ea\u4e9b\u80fd\u529b\uff1f","text":"<p><code>runtime/compiler.h</code> \u5b9a\u4e49 <code>PandaRuntimeInterface : compiler::RuntimeInterface</code>\uff0c\u63d0\u4f9b\u5927\u91cf\u201c\u7f16\u8bd1\u65f6\u9700\u8981\u67e5\u8be2\u201d\u7684\u94a9\u5b50\uff0c\u4f8b\u5982\uff1a - \u65b9\u6cd5/\u7c7b\u578b\u4fe1\u606f\uff1a<code>GetMethodCode()</code>\u3001<code>GetMethodRegistersCount()</code>\u3001<code>ResolveMethodIndex/FieldIndex/TypeIndex</code> - \u7c7b\u89e3\u6790\uff1a<code>GetClass(...)</code> \u4f1a\u8d70 <code>ClassLinker</code> \u7684 loaded class fast path\uff0c\u5fc5\u8981\u65f6\u52a0\u9501\u52a0\u8f7d - \u8bbe\u7f6e\u7f16\u8bd1\u7ed3\u679c\uff1a<code>SetCompiledEntryPoint(method, ep)</code>\u3001<code>TrySetOsrCode(method, ep)</code> - GC/Barrier \u4fe1\u606f\uff1a\u53ef\u89c1 <code>gc_barrier_set.h</code> \u88ab\u7eb3\u5165 compiler \u4fa7\u63a5\u53e3\uff08\u7528\u4e8e\u751f\u6210 barrier fast path\uff09</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#42-osr-deopt","title":"4.2 OSR / Deopt\uff1a\u4e0e\u6865\u63a5\u8054\u52a8","text":"<p><code>PandaRuntimeInterface::TrySetOsrCode</code> \u663e\u793a\u4e86\u5178\u578b OSR \u5199\u5165\u6d41\u7a0b\uff1a - \u83b7\u53d6 <code>MutatorLock</code>\uff08\u8bfb\u9501\uff09\u4fdd\u62a4 - \u82e5\u65b9\u6cd5\u5df2 deopt/\u65e0 compiled code\uff0c\u5219\u62d2\u7edd OSR code - \u901a\u8fc7 <code>CompilerInterface</code> \u8bbe\u7f6e OSR code \u6307\u9488</p> <p>\u8fd9\u4e0e <code>bridge.cpp</code> \u7684 deoptimization \u56de\u9000\u89e3\u91ca\u5668\u8def\u5f84\u5f62\u6210\u95ed\u73af\uff1a\u7f16\u8bd1\u2192\u6267\u884c\u2192deopt\u2192\u56de\u89e3\u91ca\u5668\u2192\u518d\u70ed\u2192\u518d\u7f16\u8bd1/OSR\u3002</p> <p>\u26a0\ufe0f \u67b6\u6784\u73b0\u5b9e\u63d0\u9192\uff08\u907f\u514d\u8bef\u6392\u969c\uff09\uff1aOSR \u7684\u201c\u6700\u7ec8\u8fdb\u5165\u70b9\u201d\u662f\u67b6\u6784\u76f8\u5173\u6c47\u7f16\u5165\u53e3\uff08<code>OsrEntryAfter*</code>\uff09\u3002\u5f53\u524d\u6e90\u7801\u4e2d\u8be5\u5165\u53e3\u5728 arm64 \u6709\u771f\u5b9e\u5b9e\u73b0\uff08<code>runtime/arch/aarch64/osr_aarch64.S</code>\uff09\uff0c\u800c\u5728\u975e arm64 \u5e73\u53f0\u4e0a\u53ef\u80fd\u662f <code>UNREACHABLE()</code> stub\uff08\u89c1 <code>runtime/arch/asm_support.cpp</code>\uff09\u3002\u56e0\u6b64\u5728\u975e arm64 \u4e0a\u201cOSR \u8dd1\u4e0d\u51fa\u6765\u201d\u4e0d\u4e00\u5b9a\u662f\u9009\u9879/\u70ed\u5ea6\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u5e73\u53f0\u5b9e\u73b0\u7f3a\u5931/\u5360\u4f4d\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#5-aotan-snapshot-index-class-context","title":"5. AOT\uff1a.an \u6587\u4ef6\u3001snapshot index \u4e0e class context","text":"<p>\u843d\u70b9\u4e3b\u8981\u6709\u4e24\u5904\uff1a</p> <ul> <li><code>.an</code> \u88c5\u8f7d\u4e0e\u7ba1\u7406\uff1a<code>compiler/aot/aot_manager.*</code>\uff08\u4e24\u6761\u771f\u5b9e\u5165\u53e3\uff1a\u542f\u52a8\u671f <code>Runtime::HandleAotOptions()</code>\uff1b\u4ee5\u53ca <code>enable-an</code> \u4e0b <code>FileManager::LoadAbcFile()</code> \u4f1a\u6309 <code>.abc</code> \u8def\u5f84\u5c1d\u8bd5 <code>TryLoadAnFileForLocation()</code>\uff09</li> <li>\u7f16\u8bd1\u5668\u4fa7\u5f15\u7528 <code>.an</code> \u7684\u7d22\u5f15\uff1a<code>runtime/compiler.cpp</code> \u4e2d <code>GetAOTBinaryFileSnapshotIndexForMethod(...)</code> \u7b49\u63a5\u53e3\uff0c\u628a panda_file \u6620\u5c04\u5230 AOT snapshot index</li> </ul> <p>\u5e76\u4e14 runtime \u5728\u542f\u52a8\u65f6\u4f1a\u8bbe\u7f6e\uff1a - <code>AotManager::SetBootClassContext(...)</code> - <code>AotManager::SetAppClassContext(...)</code></p> <p>\uff08\u89c1 <code>runtime/runtime.cpp</code> \u7684 <code>CreatePandaVM</code> \u4e0e <code>CreateApplicationClassLinkerContext</code> \u6bb5\u843d\uff09</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#6-irtoc-quickener-bytecode-optimizer","title":"6. IRTOC / Quickener / Bytecode Optimizer\uff1a\u6267\u884c\u524d\u7684\u201c\u53d8\u6362\u5c42\u201d","text":""},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#61-irtoc","title":"6.1 IRTOC","text":"<p><code>irtoc/</code> \u5b50\u9879\u76ee\u5728\u5de5\u7a0b\u4e2d\u4f5c\u4e3a\u72ec\u7acb\u6a21\u5757\u5b58\u5728\uff08README \u7b80\u7565\uff09\uff0c\u7528\u4e8e IR \u5230\u673a\u5668\u7801/\u5185\u5efa\u4ee3\u7801\u7684\u751f\u6210\u7ba1\u7ebf\uff08\u5e38\u4e0e intrinsics/\u6a21\u677f\u751f\u6210\u7ed3\u5408\uff09\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#62-quickener","title":"6.2 Quickener","text":"<p><code>quickener/</code> \u76ee\u5f55\u63d0\u4f9b quickening \u5de5\u5177\uff08\u5b57\u8282\u7801/\u5e38\u91cf\u6c60\u7b49\u9884\u5904\u7406\uff09\uff0c\u5e38\u7528\u4e8e\u964d\u4f4e\u8fd0\u884c\u671f\u89e3\u6790\u5f00\u9500\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#63-bytecode-optimizer","title":"6.3 Bytecode Optimizer","text":"<p><code>bytecode_optimizer/</code> \u63d0\u4f9b\u66f4\u5168\u9762\u7684\u5b57\u8282\u7801\u4f18\u5316\uff08peephole\u3001canonicalization\u3001reg/acc \u5206\u914d\u3001codegen \u7b49\uff09\uff0c\u662f\u201c\u8fd0\u884c\u524d/\u6784\u5efa\u671f\u6027\u80fd\u5de5\u7a0b\u201d\u7684\u6838\u5fc3\u5de5\u5177\u7bb1\u4e4b\u4e00\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#7-2","title":"7. \u9636\u6bb5 2\uff08\u5df2\u843d\u5730\u5185\u5bb9 &amp; \u4ecd\u5efa\u8bae\u8865\u9f50\uff09","text":""},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#71-stage2-04_executionengine","title":"7.1 \u5df2\u843d\u5730\uff08Stage2 / 04_ExecutionEngine\uff09","text":"<ul> <li>\u5e38\u7528 opcode \u7684\u201c\u65b0\u4eba\u53ef\u8bfb\u7d22\u5f15\u201d\uff1a\u5df2\u8865\u9f50\uff08\u5e76\u4e14\u4ee5 IRTOC fast interpreter \u4e3a\u4e3b\u7ebf\uff0c\u800c\u975e\u53ea\u770b C++ handler\uff09</li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC.md</code></li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel.md</code></li> <li>IRTOC/LLVM fast interpreter \u7684\u771f\u5b9e\u6267\u884c\u94fe + \u751f\u6210\u94fe\uff1a\u5df2\u8865\u9f50</li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/Flows/IRTOC_FastInterpreter.md</code></li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter.md</code></li> <li>entrypoints \u7684\u201c\u6309\u7c7b\u522b\u7406\u89e3\u201d\uff1a\u5df2\u6709 Stage2 \u6c89\u6dc0\u5165\u53e3\uff08\u53ef\u4f5c\u4e3a\u65b0\u4eba\u5165\u53e3\uff09</li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/DataStructures/Entrypoints.md</code></li> <li>\u9010\u884c\u8bc1\u636e\uff1a<code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp.md</code></li> </ul>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#72-i2cc2i-framekind-stackwalker-deopt","title":"7.2 i2c/c2i \u7684\u6808\u5e27\u5f62\u6001\uff08\u5df2\u8865\u9f50\uff1a\u542b FrameKind \u8fb9\u754c\u3001StackWalker \u4e0e deopt \u4ea4\u754c\uff09","text":"<ul> <li>\u5b8c\u6574\u7684\u201c\u903b\u8f91\u6808\u5f62\u6001\u56fe + \u5207\u6362\u70b9\u6e05\u5355\u201d\uff1a\u89c1</li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/Flows/Bridge_I2C_C2I.md</code>\uff08\u542b I2C/C2I \u7684 Top\u2192Bottom \u6808\u5f62\u6001 + Thread/FrameKind \u5207\u6362\u70b9\uff09</li> <li><code>Runtime_Architecture_Internals_and_Developer_Guide/04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind.md</code>\uff08\u542b boundary frame\u3001thread \u53cc\u72b6\u6001\u5f00\u5173\u3001deopt/\u5f02\u5e38\u4e0e StackWalker \u7684\u4ea4\u754c\uff09</li> </ul>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#73-abi","title":"7.3 \u7269\u7406\u6808\u5e27/ABI\uff08\u4e0d\u518d\u201c\u7559\u4f5c\u53ef\u9009\u201d\uff1a\u7ed9\u4f60\u4e00\u5957\u80fd\u5bf9\u7167\u6c47\u7f16\u7684\u7a33\u5b9a\u7ed3\u8bba\uff09","text":"<p>\u672c\u8282\u628a \u201c\u903b\u8f91\u8fb9\u754c\u201d\u5982\u4f55\u843d\u5230\u201c\u673a\u5668\u6808\u4e0a\u7684\u771f\u5b9e\u8fb9\u754c\u5e27\u201d \u8bf4\u6e05\u695a\uff1a\u4f60\u53ea\u8981\u638c\u63e1\u8fd9\u4e9b\u4e0d\u53d8\u91cf\uff0c\u5c31\u80fd\u628a\u5d29\u6e83/\u7f3a\u5e27\u5b9a\u4f4d\u5230\u5177\u4f53\u6865\u63a5\u70b9\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#731-boundary-frame","title":"7.3.1 Boundary frame \u7684\u201c\u843d\u5730\u65b9\u5f0f\u201d\uff08\u6c47\u7f16\u76f4\u63a5\u6784\u9020\uff0c\u4e0d\u662f\u6982\u5ff5\uff09","text":"<ul> <li>I2C\uff08Interpreter \u2192 Compiled\uff09\uff1a\u8fdb\u5165 compiled \u524d\uff0c\u4f1a\u5728\u673a\u5668\u6808\u4e0a\u6784\u9020\u4e00\u4e2a\u6807\u8bb0\u4e3a <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code>\uff08\u6216 <code>BYPASS_BRIDGE</code>\uff09\u7684\u8fb9\u754c\u5e27\uff0c\u5e76\u628a <code>THREAD_REG</code>/<code>fp</code> \u7b49\u5173\u952e\u5bc4\u5b58\u5668\u72b6\u6001\u7eb3\u5165\u8be5\u5e27\uff0c\u4f9b unwind/StackWalker \u8bc6\u522b\u4e0e\u8fd8\u539f\u3002</li> <li>C2I\uff08Compiled \u2192 Interpreter\uff09\uff1a\u56de\u89e3\u91ca\u5668\u524d\uff0c\u4f1a\u6784\u9020\u4e00\u4e2a\u6807\u8bb0\u4e3a <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> \u7684\u8fb9\u754c\u5e27\uff0c\u5e76 \u4fdd\u5b58\u6240\u6709 callee-saved \u5bc4\u5b58\u5668\uff0c\u4ee5\u4fdd\u8bc1\uff1a</li> <li>\u5f02\u5e38 unwind / \u6808\u56de\u6eaf\u53ef\u4ee5\u8bfb\u53d6\u5230 caller \u7684\u4fdd\u5b58\u5bc4\u5b58\u5668</li> <li>deopt/OSR/\u5f02\u5e38\u8def\u5f84\u8de8\u8fb9\u754c\u65f6\u4e0d\u4e22\u5bc4\u5b58\u5668\u8bed\u4e49</li> </ul>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#732-aarch64","title":"7.3.2 aarch64 \u7684\u201c\u53ef\u89c6\u5316\u7269\u7406\u5e03\u5c40\u201d\uff08\u5173\u952e\u5b57\u6bb5\u6765\u81ea\u6c47\u7f16\u6ce8\u91ca\uff0c\u9002\u5408\u5bf9\u7167\u6808\uff09","text":"<p>aarch64 / I2C \u8fb9\u754c\u5e27\uff08\u6765\u81ea <code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_aarch64.S</code> \u7684\u6ce8\u91ca\u4e0e\u5165\u6808\u987a\u5e8f\uff09\uff1a</p> <pre><code>flowchart TB\n  subgraph A[\"aarch64: I2C bridge frame\uff08\u9ad8\u5730\u5740 \u2192 \u4f4e\u5730\u5740\uff09\"]\n    LR[\"lr\uff08return addr\uff09\"]\n    IF[\"iframe \u6307\u9488\uff08Frame*\uff09  &lt;\u2014 fp \u6240\u5728\u8bed\u4e49\u70b9\u9644\u8fd1\"]\n    TAG[\"INTERPRETER_TO_COMPILED_CODE_BRIDGE / BYPASS_BRIDGE\uff08\u6865\u63a5\u7c7b\u578b\u6807\u8bb0\uff09\"]\n    FP[\"saved fp\"]\n    TH[\"THREAD_REG\uff08ManagedThread*\uff09\"]\n    X19[\"saved x19\uff08callee-saved \u793a\u4f8b\uff09\"]\n  end\n  LR --&gt; IF --&gt; TAG --&gt; FP --&gt; TH --&gt; X19</code></pre> <p>aarch64 / C2I \u8fb9\u754c\u5e27\uff08\u6765\u81ea <code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code>\uff09\uff1a</p> <ul> <li>\u8be5\u6865\u4f1a <code>PUSH_CALLEE_REGS</code> \u628a\u6240\u6709 callee-saved\uff08x19-x28\u3001d8-d15 \u7b49\uff09\u538b\u6808\uff0c\u5e76\u5728\u53ef\u80fd\u8fdb\u5165 safepoint \u524d\u628a C2I \u8fb9\u754c\u5e27\u6307\u9488\u5199\u5165 TLS\uff1a</li> <li><code>THREAD_REG + MANAGED_THREAD_FRAME_OFFSET = fp</code></li> <li>\u76ee\u7684\uff1a\u8ba9 StackWalker \u5728 safepoint/unwind \u671f\u95f4\u201c\u770b\u89c1\u201d caller \u7684\u4fdd\u5b58\u5bc4\u5b58\u5668\u4f4d\u7f6e</li> </ul>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#733-amd64-deopt-cframe-c2i","title":"7.3.3 amd64 \u7684 deopt\u201c\u786c\u843d\u5730\u201d\uff1a\u76f4\u63a5\u628a CFrame \u53d8\u5f62\u4e3a C2I \u8fb9\u754c\u5e27","text":"<p>\u5728 amd64 \u4e0a\uff0cdeopt \u8fd4\u56de\u89e3\u91ca\u5668\u5e76\u4e0d\u662f\u201c\u53e6\u8d77\u7089\u7076\u5efa\u4e2a\u8fb9\u754c\u5e27\u201d\uff0c\u800c\u662f\u53ef\u4ee5\u76f4\u63a5 Morph CFrame \u2192 C2I boundary frame\uff08\u6765\u81ea <code>runtime/bridge/arch/amd64/deoptimization_amd64.S</code>\uff09\uff1a</p> <ul> <li>\u5199\u5165\u8fb9\u754c\u5e27\u6807\u8bb0\uff1a\u628a <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> \u5199\u5230\u8fb9\u754c\u5e27\u7684 method/tag slot</li> <li>\u4e32\u8d77 IFrame \u94fe\uff1a\u628a \u201c\u6700\u540e\u6062\u590d\u7684 IFrame\u201d \u7684 <code>prev_frame</code> \u6307\u5411\u8fd9\u4e2a C2I \u8fb9\u754c\u5e27</li> <li>\u590d\u5236 callee-saved\uff1a\u628a CFrame \u7684 callee-saved \u62f7\u8d1d\u8fdb boundary frame\uff0c\u4f9b\u540e\u7eed unwind/\u6062\u590d\u4f7f\u7528</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e00\u4e2a\u5e38\u89c1\u73b0\u8c61\uff1a\u4f60\u5728 deopt \u4e4b\u540e\u770b\u5230\u7684\u201c\u4e0a\u4e00\u5e27\u201d\u53ef\u80fd\u662f boundary frame\uff08\u4e0d\u662f IFrame/CFrame\uff09\uff0c\u4f46\u5b83\u5fc5\u987b\u5b58\u5728\u4e14\u53ef\u8bc6\u522b\uff0c\u5426\u5219 StackWalker \u4f1a\u5728\u8de8\u8fb9\u754c\u65f6\u8d70\u9519\u89e3\u7801\u8def\u5f84\u3002</p>"},{"location":"04_Execution_Engine_Interpreter_JIT_AOT/#734-crash","title":"7.3.4 \u4f60\u505a crash/\u7f3a\u5e27\u6392\u969c\u65f6\u7684\u6700\u5c0f\u5bf9\u7167\u6e05\u5355","text":"<ul> <li>\u5148\u5bf9\u9f50\u4e09\u4e2a\u7ef4\u5ea6\u662f\u5426\u4e00\u81f4\uff1a</li> <li>thread \u7684 <code>currentFrame*</code></li> <li>thread \u7684 <code>currentFrameIsCompiled</code></li> <li>\u673a\u5668\u6808\u4e0a\u7684 boundary frame \u6807\u8bb0\uff08<code>*_BRIDGE</code> \u5e38\u91cf\uff09</li> <li>\u8bc1\u636e\u5b9a\u4f4d\uff08\u6e90\u7801\u8def\u5f84\uff09\uff1a</li> <li>I2C\uff1a<code>runtime/bridge/arch/*/interpreter_to_compiled_code_bridge_*.S</code></li> <li>C2I\uff1a<code>runtime/bridge/arch/*/compiled_code_to_interpreter_bridge_*.S</code></li> <li> <p>deopt-after\uff1a<code>runtime/bridge/arch/*/deoptimization_*.S</code>\uff08\u4f1a\u663e\u5f0f\u5904\u7406 C2I boundary \u4e0e\u5bc4\u5b58\u5668\u53ef\u89c1\u6027\uff09</p> </li> <li> <p>\u8bc1\u636e\u5b9a\u4f4d\uff08\u672c\u7ae0 FileNotes \u76f4\u8fbe\uff09\uff1a</p> </li> <li><code>Flows/Bridge_I2C_C2I.md</code> \u7684 \u201carch \u6c47\u7f16\u8bc1\u636e\u94fe\u201d \u5c0f\u8282\uff08\u96c6\u4e2d\u5165\u53e3\uff09</li> <li>aarch64\uff1aI2C/C2I/proxy/deopt<ul> <li>I2C\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S.md</li> <li>C2I\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S.md</li> <li>proxy\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S.md</li> <li>deopt\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S.md</li> </ul> </li> <li>amd64\uff1aI2C/C2I/proxy/deopt<ul> <li>I2C\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S.md</li> <li>C2I\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S.md</li> <li>proxy\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S.md</li> <li>deopt\uff1a04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S.md</li> </ul> </li> </ul>"},{"location":"05_Native_Bridge_ANI_and_Interop/","title":"Chapter 5\uff1aNative \u6865\uff08ANI / ETS Native Library / JS Interop\uff09","text":"<p>\u672c\u7ae0\u628a\u201c\u5916\u90e8\u4e16\u754c\u5982\u4f55\u8fdb\u5165 VM\u201d\u62c6\u6210\u4e09\u5757\uff1aANI\uff08\u7c7b JNI \u7684 native API\uff09\u3001ETS Native Library \u52a0\u8f7d\u4e0e\u7b26\u53f7\u89e3\u6790\u3001\u4ee5\u53ca \u53ef\u9009\u7684 JS \u4e92\u64cd\u4f5c\uff08Interop JS\uff09\u3002\u8fd9\u4e9b\u8def\u5f84\u5171\u540c\u51b3\u5b9a\uff1a\u7ebf\u7a0b\u5982\u4f55 attach\u3001GC \u4f55\u65f6\u5141\u8bb8\u53d1\u751f\u3001\u4ee5\u53ca\u8de8\u8bed\u8a00\u5bf9\u8c61\u5982\u4f55\u88ab\u5f15\u7528/\u7ba1\u7406\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#1","title":"1. \u5165\u53e3\u5730\u56fe\uff08\u76ee\u5f55 \u2192 \u804c\u8d23\uff09","text":"\u5b50\u7cfb\u7edf \u76ee\u5f55 \u5173\u952e\u951a\u70b9 \u8bf4\u660e ANI VM API\uff08\u521b\u5efa VM / \u7ebf\u7a0b attach\uff09 <code>plugins/ets/runtime/ani/</code> <code>ani_vm_api.cpp</code> <code>ANI_CreateVM</code>\u3001<code>AttachCurrentThread</code>\u3001<code>DetachCurrentThread</code>\u3001<code>GetEnv</code> ANI Interaction API\uff08\u5927\u91cf C API \u5b9e\u73b0\uff09 <code>plugins/ets/runtime/ani/</code> <code>ani_interaction_api.cpp</code> \u65b9\u6cd5\u8c03\u7528\u3001\u53c2\u6570\u8f6c\u6362\u3001\u7c7b\u521d\u59cb\u5316\u3001\u5f02\u5e38/\u6821\u9a8c\u7b49\uff08\u6587\u4ef6\u5f88\u5927\uff09 ETS N-API env\uff08ani_env \u5b9e\u4f8b\uff09 <code>plugins/ets/runtime/</code> <code>ets_napi_env.h/.cpp</code> <code>PandaEtsNapiEnv</code>\uff0c\u4fdd\u5b58 coroutine\u3001reference storage\u3001\u53ef\u9009 verifier hook ETS Native Library \u52a0\u8f7d <code>plugins/ets/runtime/</code> <code>ets_native_library_provider.h/.cpp</code>\u3001<code>ets_native_library.h/.cpp</code> \u6309\u8def\u5f84/namespace \u52a0\u8f7d so\uff0c\u67e5\u627e <code>ANI_Constructor</code>\uff0c\u505a\u6743\u9650\u6821\u9a8c\uff08OHOS\uff09 Interop JS\uff08\u53ef\u9009\uff09 <code>plugins/ets/runtime/interop_js/</code> <code>interop_context_api.h</code>\u3001<code>interop_context.cpp</code> <code>CreateMainInteropContext</code>\uff0c\u5bf9\u5916\u9690\u85cf napi_env\uff08\u7528 void*\uff09 ExternalIfaceTable\uff08\u8de8\u8fd0\u884c\u65f6\u63a5\u53e3\u8868\uff09 <code>plugins/ets/runtime/</code> <code>external_iface_table.h</code> JS runtime \u521b\u5efa/\u9500\u6bc1\u3001job queue\u3001interop ctx \u521b\u5efa\u7b49\u56de\u8c03\u96c6\u5408"},{"location":"05_Native_Bridge_ANI_and_Interop/#2-ani-vm-attachdetach","title":"2. ANI\uff1a\u521b\u5efa VM \u4e0e\u7ebf\u7a0b\u6a21\u578b\uff08attach/detach\uff09","text":""},{"location":"05_Native_Bridge_ANI_and_Interop/#21-vmani_createvm","title":"2.1 \u521b\u5efa VM\uff1a<code>ANI_CreateVM</code>","text":"<p><code>plugins/ets/runtime/ani/ani_vm_api.cpp</code> \u7684 <code>ANI_CreateVM()</code> \u505a\u4e86\u4e09\u4ef6\u5173\u952e\u4e8b\uff1a</p> <ol> <li>\u89e3\u6790 ANI options\uff08<code>OptionsParser</code>\uff09</li> <li>\u521d\u59cb\u5316 logger\uff08\u652f\u6301 callback\uff09</li> <li>\u521b\u5efa Runtime\uff1a<code>ark::Runtime::Create(runtimeOptions)</code></li> </ol> <p>\u6210\u529f\u540e\u901a\u8fc7\u5f53\u524d <code>EtsCoroutine</code> \u62ff\u5230 <code>PandaVM</code> \u5e76\u8fd4\u56de\u7ed9\u8c03\u7528\u65b9\u3002</p> <pre><code>flowchart TD\n  aniCreate[ANICreateVM] --&gt; parse[ANIOptionsParser]\n  parse --&gt; logger[LoggerInitialize]\n  logger --&gt; runtime[RuntimeCreate]\n  runtime --&gt; coro[EtsCoroutineGetCurrent]\n  coro --&gt; retVm[Return ani_vm]</code></pre>"},{"location":"05_Native_Bridge_ANI_and_Interop/#22-envgetenv","title":"2.2 \u83b7\u53d6 env\uff1a<code>GetEnv</code>","text":"<p><code>ANI_GetEnv</code>\uff08\u5b9e\u73b0\u4e3a <code>GetEnv</code>\uff09\u5173\u952e\u7ea6\u675f\uff1a - \u5f53\u524d\u7ebf\u7a0b\u5fc5\u987b\u5df2\u7ecf attach \u5230 VM\uff08<code>Thread::GetCurrent() != nullptr</code>\uff09 - \u5fc5\u987b\u5b58\u5728\u5f53\u524d coroutine\uff08<code>EtsCoroutine::GetCurrent()</code>\uff09 - \u6bcf\u4e2a coroutine \u90fd\u5e94\u6709\u4e00\u4e2a\u6709\u6548\u7684 <code>ani_env</code>\uff08\u901a\u8fc7 <code>coro-&gt;GetEtsNapiEnv()</code> \u83b7\u5f97\uff09</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#23-attachcurrentthread-detachcurrentthread","title":"2.3 \u7ebf\u7a0b\u9644\u7740\uff1a<code>AttachCurrentThread</code> / <code>DetachCurrentThread</code>","text":"<p><code>AttachCurrentThread()</code> \u7684\u6838\u5fc3\u903b\u8f91\uff1a - \u82e5\u7ebf\u7a0b\u5df2 attach \u5219\u62a5\u9519 - \u901a\u8fc7 <code>PandaEtsVM -&gt; CoroutineManager</code> \u521b\u5efa\u8be5\u7ebf\u7a0b\u4e13\u7528\u7684 \u201cexclusive worker coroutine\u201d - \u8fd4\u56de <code>PandaEtsNapiEnv::GetCurrent()</code> \u4f5c\u4e3a <code>ani_env*</code> - \u82e5\u542f\u7528 interop\uff0c\u53ef\u80fd\u521b\u5efa/\u7ed1\u5b9a JS env\uff0c\u5e76\u5efa\u7acb interop ctx\uff08\u89c1 5\uff09</p> <p><code>DetachCurrentThread()</code> \u7684\u6838\u5fc3\u903b\u8f91\uff1a - \u9500\u6bc1\u8be5 worker coroutine - \u82e5\u5b58\u5728 JS env\uff0c\u5219\u8d70 <code>ExternalIfaceTable-&gt;CleanUpJSEnv(jsEnv)</code> \u6e05\u7406</p> <p>\u8bfb\u4ee3\u7801\u63d0\u793a\uff1aANI \u628a \u201c\u7ebf\u7a0b attach\u201d \u663e\u5f0f\u5efa\u6a21\u4e3a \u201c\u4e3a\u7ebf\u7a0b\u521b\u5efa coroutine worker\u201d\u3002\u8fd9\u610f\u5473\u7740\u5f88\u591a\u751f\u547d\u5468\u671f\uff08\u5f02\u5e38\u3001reference storage\u3001handle scope\u3001interop ctx\uff09\u90fd\u5929\u7136\u6302\u5728 coroutine \u4e0a\uff0c\u800c\u4e0d\u662f\u7eaf thread-local\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#3-ani_envpandaetsnapienv","title":"3. ani_env\uff1aPandaEtsNapiEnv \u4e0e\u5f15\u7528/\u5f02\u5e38/\u6821\u9a8c","text":"<p><code>plugins/ets/runtime/ets_napi_env.h/.cpp</code> \u5b9a\u4e49 <code>PandaEtsNapiEnv : public ani_env</code>\uff1a</p> <ul> <li>\u7ed1\u5b9a coroutine\uff1a<code>GetEtsCoroutine()</code> / <code>GetEtsVM()</code></li> <li>\u5f15\u7528\u7ba1\u7406\uff1a\u6301\u6709 <code>EtsReferenceStorage</code>\uff08<code>mem::InternalAllocator</code> \u5206\u914d\uff09\uff0c\u7528\u4e8e\u7ba1\u7406\u8de8 native \u8fb9\u754c\u7684\u5f15\u7528\u751f\u547d\u5468\u671f</li> <li>\u5f02\u5e38\u6865\u63a5\uff1a<code>SetException/GetThrowable/HasPendingException/ClearException</code> \u8f6c\u53d1\u7ed9 coroutine</li> <li>\u53ef\u9009\u7684 ANI \u6821\u9a8c\u5668\uff1a</li> <li>\u6784\u9020\u65f6\u82e5 <code>coroutine-&gt;GetPandaVM()-&gt;IsVerifyANI()</code>\uff0c\u5c06 <code>c_api</code> \u66ff\u6362\u4e3a verify \u7248\u672c\u7684 interaction API</li> </ul> <p>\u8fd9\u7ed9\u51fa\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u201c\u6269\u5c55\u70b9\u201d\uff1aANI \u7684 C API \u8868\uff08<code>c_api</code>\uff09\u662f\u53ef\u66ff\u6362\u7684\u2014\u2014\u53ef\u4ee5\u6ce8\u5165 verifier/\u7edf\u8ba1\u7b49\u6a2a\u5207\u903b\u8f91\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#4-ani-interaction-apinative-managed","title":"4. ANI Interaction API\uff1anative \u8c03\u7528\u5982\u4f55\u8fdb\u5165 managed \u4e16\u754c","text":"<p><code>plugins/ets/runtime/ani/ani_interaction_api.cpp</code> \u5f88\u5927\uff0c\u4f46\u4ece\u5c40\u90e8\u7ed3\u6784\u53ef\u4ee5\u6293\u4f4f\u4e3b\u7ebf\uff1a</p> <ul> <li>\u7c7b\u521d\u59cb\u5316\uff1a\u5728\u8c03\u7528\u9759\u6001\u65b9\u6cd5/\u51fd\u6570\u65f6\uff0c\u5148 <code>InitializeClass(...)</code>\uff0c\u5e76\u6b63\u786e\u5904\u7406 pending exception</li> <li>\u53c2\u6570\u8f6c\u6362\uff1a\u628a <code>ani_value</code> / varargs \u6309 method shorty \u8f6c\u6210 VM \u5185\u90e8 <code>Value</code> \u5217\u8868</li> <li>\u7ebf\u7a0b/GC \u7ea6\u675f\uff1a\u4f7f\u7528 <code>ScopedCoroutineNativeCall</code>\uff08\u5728 method call \u5468\u671f\u5185\u5207\u6362/\u6807\u8bb0 coroutine \u72b6\u6001\uff09</li> </ul> <p>\u8fd9\u90e8\u5206\u76f8\u5f53\u4e8e\u201cJNI CallStatic / CallMethod\u201d\u65cf\u7684\u5b9e\u73b0\u4e2d\u5fc3\uff1b\u5efa\u8bae\u540e\u7eed\u6309\u529f\u80fd\u628a\u8be5\u6587\u4ef6\u62c6\u6210\uff1a\u53c2\u6570\u8f6c\u6362\u3001method resolve\u3001invoke\u3001\u5f02\u5e38\u3001verify \u8fd9\u51e0\u7c7b\u7d22\u5f15\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#5-ets-native-library-ani_constructor","title":"5. ETS Native Library\uff1a\u52a0\u8f7d\u3001\u6743\u9650\u4e0e ANI_Constructor","text":""},{"location":"05_Native_Bridge_ANI_and_Interop/#51-nativelibraryprovider","title":"5.1 NativeLibraryProvider\uff1a\u7edf\u4e00\u88c5\u8f7d\u5165\u53e3","text":"<p><code>plugins/ets/runtime/ets_native_library_provider.h/.cpp</code> \u63d0\u4f9b\uff1a - <code>LoadLibrary(env, name, shouldVerifyPermission, fileName)</code> - <code>ResolveSymbol(name)</code> - libraryPath \u7684\u8bfb\u5199\uff08\u7ebf\u7a0b\u5b89\u5168 RWLock\uff09</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#52-path-system-namespace","title":"5.2 \u88c5\u8f7d\u7b56\u7565\uff1apath \u2192 system \u2192 namespace\uff08\u5e94\u7528\uff09","text":"<p><code>ets_native_library_provider.cpp</code> \u7684\u7b56\u7565\u53ef\u4ee5\u6982\u62ec\u4e3a\uff1a</p> <ul> <li>\u4f18\u5148\u6309 libraryPath \u641c\u7d22\uff08name \u4e0d\u542b <code>/</code> \u65f6\uff0c\u4f1a\u5728\u6bcf\u4e2a path \u4e0b\u62fc\u63a5 <code>path/name</code> \u9010\u4e2a\u5c1d\u8bd5\uff09</li> <li>\u82e5 <code>shouldVerifyPermission == false</code>\uff08\u4f8b\u5982 system library load \u5931\u8d25\u573a\u666f\uff09\uff0c\u4f1a\u5c1d\u8bd5\u4ece \u5e94\u7528 namespace \u52a0\u8f7d\uff1a</li> <li>\u901a\u8fc7 <code>StackWalker</code> \u627e\u5230\u9996\u4e2a\u975e boot context \u7684\u65b9\u6cd5\u5e27\uff0c\u62ff\u5230\u5e94\u7528 abc \u8def\u5f84\uff08<code>GetFullFileName()</code>\uff09</li> <li>\u4ea4\u7ed9 <code>EtsNamespaceManagerImpl::LoadNativeLibraryFromNs(abcPath, name)</code> \u505a namespace \u7ea7\u52a0\u8f7d</li> </ul> <p>\u8fd9\u610f\u5473\u7740\u540c\u540d so \u53ef\u80fd\u6765\u81ea\u201c\u7cfb\u7edf\u8def\u5f84\u201d\u6216\u201c\u5e94\u7528\u547d\u540d\u7a7a\u95f4\u201d\uff0c\u5e76\u4e14\u52a0\u8f7d\u51b3\u7b56\u4e0e\u5f53\u524d\u6267\u884c\u6808/\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\u6709\u5173\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#53-ani_constructor","title":"5.3 ANI_Constructor \u7ea6\u5b9a","text":"<p><code>NativeLibraryProvider::CallAniCtor()</code> \u4f1a\uff1a - \u67e5\u627e\u5bfc\u51fa\u7b26\u53f7 <code>ANI_Constructor</code> - \u6309\u7ea6\u5b9a\u7b7e\u540d\u8c03\u7528\uff1a<code>ani_status (*)(ani_vm*, uint32_t*)</code> - \u8fd4\u56de\u7684 <code>version</code> \u5fc5\u987b\u901a\u8fc7 <code>ani::IsVersionSupported(version)</code> \u6821\u9a8c</p> <p>\u8fd9\u4e0e JNI_OnLoad \u7c7b\u4f3c\uff1anative \u5e93\u53ef\u5728\u52a0\u8f7d\u65f6\u8fdb\u884c\u7248\u672c\u534f\u5546\u4e0e\u521d\u59cb\u5316\uff0c\u4f46\u8fd9\u91cc\u7edf\u4e00\u7528 <code>ANI_Constructor</code> \u547d\u540d\u3002</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#54-ohos","title":"5.4 \u6743\u9650\u6821\u9a8c\uff08OHOS\uff09","text":"<p>\u5728 <code>PANDA_TARGET_OHOS</code> \u4e0b\uff0c<code>CheckLibraryPermission</code> \u4f1a\uff1a - \u4ece\u8c03\u7528\u6808\u63a8\u5bfc caller class\uff08\u8981\u6c42\u5728 boot context\uff09 - \u901a\u8fc7 <code>EtsNamespaceManagerImpl</code> \u6ce8\u518c\u7684\u56de\u8c03 <code>ExtensionApiCheckCallback</code> \u6821\u9a8c className \u662f\u5426\u88ab\u5141\u8bb8\u52a0\u8f7d\u8be5 native \u5e93\u6587\u4ef6</p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#6-interop-jscreatemaininteropcontext-externalifacetable","title":"6. Interop JS\uff1aCreateMainInteropContext \u4e0e ExternalIfaceTable","text":""},{"location":"05_Native_Bridge_ANI_and_Interop/#61-interop-api-void","title":"6.1 \u4e3a\u4ec0\u4e48 interop API \u8981\u7528 <code>void*</code>\uff1f","text":"<p><code>plugins/ets/runtime/interop_js/interop_context_api.h</code> \u91cc\u7684\u6ce8\u91ca\u7ed9\u4e86\u52a8\u673a\uff1a - \u5bf9\u5916\u6a21\u5757\uff08\u4f8b\u5982 ANI\uff09\u5e94\u4e0e interop \u7ec6\u8282\u9694\u79bb - \u56e0\u6b64\u5bf9\u5916\u63a5\u53e3\u4f7f\u7528 <code>void* napiEnv</code>\uff0c\u907f\u514d\u76f4\u63a5\u4f9d\u8d56 <code>napi_env</code> \u7c7b\u578b\u4e0e interop \u5185\u90e8\u5b9e\u73b0</p> <p>\u5bf9\u5916\u5165\u53e3\uff1a - <code>interop::js::CreateMainInteropContext(EtsCoroutine *mainCoro, void *napiEnv)</code></p>"},{"location":"05_Native_Bridge_ANI_and_Interop/#62-externalifacetable","title":"6.2 ExternalIfaceTable\uff1a\u8de8\u8fd0\u884c\u65f6\u7684\u56de\u8c03\u8868","text":"<p><code>plugins/ets/runtime/external_iface_table.h</code> \u5b9a\u4e49 <code>ExternalIfaceTable</code>\uff0c\u6838\u5fc3\u662f\u201c\u628a interop \u4f9d\u8d56\u6ce8\u5165\u5230 ETS runtime \u4fa7\u201d\uff1a</p> <ul> <li><code>CreateJSRuntime()</code> / <code>CleanUpJSEnv()</code> / <code>GetJSEnv()</code>\uff1aJS env \u751f\u547d\u5468\u671f</li> <li><code>CreateInteropCtx(Coroutine*, JSEnv)</code>\uff1a\u628a\u67d0\u4e2a coroutine \u7ed1\u5b9a\u5230 interop context</li> <li><code>JobQueue</code>\uff1aJS microtask/job queue \u6302\u8f7d\u70b9</li> <li><code>ClearInteropHandleScopesFunction</code>\uff1a\u7528\u4e8e\u6e05\u7406 interop \u53e5\u67c4\u4f5c\u7528\u57df\uff08\u907f\u514d\u8de8\u8bed\u8a00\u5f15\u7528\u6cc4\u6f0f/\u60ac\u6302\uff09</li> </ul>"},{"location":"05_Native_Bridge_ANI_and_Interop/#63-ani-interop","title":"6.3 ANI \u4e0e interop \u7684\u7ed3\u5408\u70b9","text":"<p>\u5728 <code>ani_vm_api.cpp</code> \u4e2d\u80fd\u770b\u5230\u4e24\u4e2a\u5173\u952e\u7ed3\u5408\u70b9\uff1a</p> <ul> <li>\u521b\u5efa VM \u65f6\uff08main coroutine\uff09\uff1a\u82e5 <code>aniOptions.IsInteropMode()</code>\uff0c\u8c03\u7528 <code>CreateMainInteropContext(coroutine, aniOptions.GetInteropEnv())</code></li> <li>\u7ebf\u7a0b attach \u65f6\uff08worker coroutine\uff09\uff1a\u901a\u8fc7 main thread \u7684 <code>ExternalIfaceTable</code>\uff1a</li> <li>\u82e5\u6ca1\u6709 jsEnv\uff0c\u5148 <code>CreateJSRuntime()</code></li> <li>\u518d <code>CreateInteropCtx(exclusiveCoro, jsEnv)</code> \u628a worker coroutine \u7ed1\u5b9a\u5230 interop ctx</li> </ul> <pre><code>sequenceDiagram\n  participant App as NativeApp\n  participant ANI as ANI_VM_API\n  participant RT as Runtime\n  participant Coro as EtsCoroutine\n  participant Iface as ExternalIfaceTable\n  participant JS as InteropJS\n\n  App-&gt;&gt;ANI: ANI_CreateVM(options)\n  ANI-&gt;&gt;RT: Runtime::Create(...)\n  RT-&gt;&gt;Coro: EtsCoroutine::GetCurrent()\n  ANI-&gt;&gt;JS: CreateMainInteropContext(mainCoro, napiEnv)\n  ANI--&gt;&gt;App: ani_vm*\n\n  App-&gt;&gt;ANI: AttachCurrentThread(vm,...)\n  ANI-&gt;&gt;Coro: CreateExclusiveWorkerForThread(...)\n  ANI-&gt;&gt;Iface: GetExternalIfaceTable(mainThread)\n  Iface-&gt;&gt;Iface: CreateJSRuntime() (optional)\n  Iface-&gt;&gt;Iface: CreateInteropCtx(workerCoro, jsEnv)\n  ANI--&gt;&gt;App: ani_env*</code></pre>"},{"location":"05_Native_Bridge_ANI_and_Interop/#7-2","title":"7. \u9636\u6bb5 2\uff08\u540e\u7eed\u6269\u5c55\u5efa\u8bae\uff09","text":"<ul> <li>\u628a <code>ani_interaction_api.cpp</code> \u6309\u201cAPI \u65cf\u201d\u62c6\u7d22\u5f15\uff1a\u5bf9\u8c61/\u7c7b/\u5b57\u6bb5/\u65b9\u6cd5\u8c03\u7528\u3001\u6570\u7ec4\u3001\u5b57\u7b26\u4e32\u3001\u5f02\u5e38\u3001verify\uff0c\u5e76\u4e3a\u6bcf\u65cf\u5efa\u7acb\u201c\u4ece ani_ \u5230 Ets / coretypes\u201d\u7684\u6620\u5c04\u8868</li> <li>\u628a <code>EtsReferenceStorage</code> \u7684\u5f15\u7528\u8bed\u4e49\u5199\u6e05\u695a\uff1alocal/global/weak \u7684\u751f\u547d\u5468\u671f\u4e0e GC \u4ea4\u4e92\uff08\u5bf9\u5e94 <code>plugins/ets/runtime/mem/ets_reference*</code>\uff09</li> <li>\u6df1\u5165 interop_js\uff1a\u628a <code>interop_context.cpp</code> \u7684\u521d\u59cb\u5316\u6a21\u5757\u5217\u8868\u3001job queue \u4e0e XGC\uff08\u8de8 VM \u5f15\u7528 GC\uff09\u4e32\u6210\u4e00\u5f20\u56fe</li> </ul>"},{"location":"06_Tooling_Profiling_Verification/","title":"Chapter 6\uff1a\u5de5\u5177\u94fe\u4e0e\u53ef\u89c2\u6d4b\u6027\uff08Tooling / Profiling / Verification\uff09","text":"<p>\u672c\u7ae0\u56de\u7b54\u201c\u5982\u4f55\u89c2\u6d4b\u4e0e\u63a7\u5236 VM\u201d\uff1a\u8c03\u8bd5\u5668/Inspector \u5982\u4f55\u6302\u63a5\u8fd0\u884c\u65f6\u4e8b\u4ef6\uff0c\u91c7\u6837 profiler \u4e0e PGO profile saver \u5982\u4f55\u5de5\u4f5c\uff0c\u4ee5\u53ca verification\uff08\u5b57\u8282\u7801\u9a8c\u8bc1\uff09\u5982\u4f55\u5728 runtime \u4e2d\u521b\u5efa service \u5e76\u6267\u884c\u3002</p>"},{"location":"06_Tooling_Profiling_Verification/#1","title":"1. \u603b\u89c8\uff1a\u4e09\u7c7b\u80fd\u529b\u4e0e\u5b83\u4eec\u6302\u5728\u54ea","text":"\u80fd\u529b \u76ee\u5f55 \u5173\u952e\u951a\u70b9 \u5728\u751f\u547d\u5468\u671f\u4e2d\u7684\u4f4d\u7f6e Debugger / Inspector <code>runtime/tooling/</code> <code>runtime/tooling/debugger.{h,cpp}</code>\u3001<code>runtime/tooling/inspector/*</code> runtime \u521d\u59cb\u5316\u540e\uff08VmStart/VmInitialization/ThreadStart \u7b49\u4e8b\u4ef6\uff09\u6301\u7eed\u5de5\u4f5c\uff1bDestroy \u65f6\u5148\u5378\u8f7d Sampling Profiler <code>runtime/tooling/</code> <code>runtime/tooling/tools.{h,cpp}</code>\u3001<code>runtime/tooling/sampler/*</code> <code>Runtime::Create()</code> \u65f6\u53ef\u521b\u5efa\u5e76\u5728 startup \u81ea\u52a8\u542f\u52a8\uff1bDestroy \u65f6\u505c\u6b62\u5e76\u9500\u6bc1 PGO/Profile Saver\uff08JIT/AOT profiling\uff09 <code>runtime/jit/</code> <code>runtime/jit/profile_saver_worker.h</code>\u3001<code>runtime/jit/profiling_saver.*</code> runtime Destroy \u65f6\u4f1a\u628a profiled methods \u5199\u5165 profile \u6587\u4ef6\uff08\u4e0e AotManager \u5173\u8054\uff09 Verifier <code>verification/</code> + <code>runtime/</code> <code>verification/public.h</code>\u3001<code>verification/verifier/verifier.cpp</code>\u3001<code>runtime/runtime.cpp</code> runtime \u521d\u59cb\u5316\u65f6\u53ef\u521b\u5efa verifier service\uff1b\u4e5f\u53ef\u7528\u72ec\u7acb verifier \u53ef\u6267\u884c\u8fdb\u884c AOT \u9a8c\u8bc1"},{"location":"06_Tooling_Profiling_Verification/#2-debugger-runtimenotification-pthooks","title":"2. Debugger\uff1a\u57fa\u4e8e RuntimeNotification + PtHooks \u7684\u8c03\u8bd5\u6846\u67b6","text":""},{"location":"06_Tooling_Profiling_Verification/#21-debugger","title":"2.1 Debugger \u7684\u6302\u63a5\u65b9\u5f0f","text":"<p><code>runtime/tooling/debugger.h</code> \u663e\u793a\uff1a - <code>class Debugger : public DebugInterface, RuntimeListener</code> - \u6784\u9020\u65f6\u901a\u8fc7 <code>runtime_-&gt;GetNotificationManager()-&gt;AddListener(this, DEBUG_EVENT_MASK)</code> \u6ce8\u518c\u76d1\u542c - \u6790\u6784\u65f6 RemoveListener\uff0c\u4fdd\u8bc1 runtime \u9000\u51fa\u65f6\u4e0d\u7559\u60ac\u6302 listener</p> <p>\u8fd9\u610f\u5473\u7740 Debugger \u4e0e runtime \u7684\u8026\u5408\u70b9\u4e3b\u8981\u662f\uff1a - RuntimeNotificationManager\uff1a\u63d0\u4f9b VM start/death\u3001thread start/end\u3001bytecode pc change\u3001GC start/finish \u7b49\u4e8b\u4ef6 - PtHooks\uff1a\u628a\u8fd9\u4e9b\u4e8b\u4ef6\u8f6c\u53d1\u7ed9\u66f4\u4e0a\u5c42\u7684 inspector/\u8c03\u8bd5\u534f\u8bae\u5b9e\u73b0\uff08\u89c1 2.2\uff09</p>"},{"location":"06_Tooling_Profiling_Verification/#22-inspector-pthooks","title":"2.2 Inspector\uff1a\u8c03\u8bd5\u534f\u8bae\u670d\u52a1\u7aef + PtHooks \u5b9e\u73b0","text":"<p><code>runtime/tooling/inspector/inspector.h</code> \u663e\u793a\uff1a - <code>Inspector : public PtHooks</code> - \u901a\u8fc7 <code>InspectorServer</code> \u5728\u72ec\u7acb\u7ebf\u7a0b\u63d0\u4f9b\u8c03\u8bd5\u670d\u52a1 - \u7ef4\u62a4 <code>DebuggableThread</code>\u3001<code>BreakpointStorage</code>\u3001<code>DebugInfoCache</code> \u7b49\u8c03\u8bd5\u72b6\u6001</p> <p>Inspector \u7684\u5173\u952e\u884c\u4e3a\uff1a - \u5904\u7406 <code>Exception/MethodEntry/SingleStep/FramePop/...</code> \u7b49 hook - \u7ef4\u62a4\u65ad\u70b9\uff08\u6e90\u6587\u4ef6\u3001\u884c\u53f7\u3001\u6761\u4ef6\u7b49\uff09\uff0c\u5e76\u5728 bytecode \u6267\u884c\u65f6\u89e6\u53d1\u6682\u505c - \u53ef\u96c6\u6210 CPU profiler\uff08\u89c1 3.2 \u7684 sampling profiler \u4e0e inspector \u7684\u4e92\u8c03\uff09</p>"},{"location":"06_Tooling_Profiling_Verification/#3-profiling-vs-pgo-profile","title":"3. Profiling\uff1a\u4e24\u6761\u8def\u5f84\uff08\u91c7\u6837 vs PGO/\u65b9\u6cd5\u7ea7 profile\uff09","text":""},{"location":"06_Tooling_Profiling_Verification/#31-sampling-profilertools-sampler","title":"3.1 Sampling Profiler\uff1aTools + sampler \u6a21\u5757","text":"<p><code>runtime/tooling/tools.h</code> \u5b9a\u4e49 <code>tooling::Tools</code>\uff1a - <code>CreateSamplingProfiler()</code> - <code>StartSamplingProfiler(StreamWriter, interval)</code> - <code>StopSamplingProfiler()</code> - <code>DestroySamplingProfiler()</code></p> <p><code>runtime/tooling/tools.cpp</code> \u8fd8\u5bfc\u51fa C API\uff1a - <code>StartSamplingProfiler(const char* asptFilename, int interval)</code> - <code>StopSamplingProfiler()</code></p> <p>\u5e76\u4e14 runtime \u751f\u547d\u5468\u671f\u4e2d\u6709\u660e\u786e\u6302\u63a5\u70b9\uff08<code>runtime/runtime.cpp</code>\uff09\uff1a - Create \u65f6\uff1a\u82e5 <code>options_.IsSamplingProfilerCreate()</code>\uff0c\u521b\u5efa profiler\uff1b\u82e5 <code>IsSamplingProfilerStartupRun()</code> \u5219\u81ea\u52a8\u542f\u52a8 - Destroy \u65f6\uff1a\u82e5\u5f00\u542f\u8fc7\uff0c\u5219 stop + destroy</p> <pre><code>flowchart TD\n  opt[RuntimeOptionsSamplingProfiler] --&gt; create[ToolsCreateSamplingProfiler]\n  create --&gt; startupRun{StartupRun?}\n  startupRun --&gt;|yes| start[ToolsStartSamplingProfiler]\n  startupRun --&gt;|no| idle[ProfilerIdle]\n  start --&gt; stop[ToolsStopSamplingProfiler]\n  stop --&gt; destroy[ToolsDestroySamplingProfiler]</code></pre> <p>\u8bfb\u4ee3\u7801\u63d0\u793a\uff1a\u91c7\u6837 profiler \u901a\u5e38\u4f1a\u4f9d\u8d56\u4fe1\u53f7/handler\uff08\u89c1 <code>runtime/tooling/sampler/sampling_profiler.cpp</code> \u4ee5\u53ca runtime \u521d\u59cb\u5316\u91cc\u6ce8\u518c <code>SamplingProfilerHandler</code> \u7684\u903b\u8f91\uff09\u3002</p>"},{"location":"06_Tooling_Profiling_Verification/#32-pgo-profileprofilingsaver-profilesaverworker","title":"3.2 PGO / \u65b9\u6cd5\u7ea7 profile\uff1aProfilingSaver + ProfileSaverWorker","text":"<p>\u8fd9\u4e00\u6761\u8def\u5f84\u670d\u52a1\u4e8e AOT/JIT \u7684 profile-guided \u4f18\u5316\uff08\u800c\u975e\u7eaf\u91c7\u6837\uff09\u3002</p> <ul> <li><code>runtime/jit/profiling_saver.h/.cpp</code>\uff1a<code>ProfilingSaver::SaveProfile(...)</code></li> <li>\u8bfb\u53d6\u65e7 profile\uff08\u82e5\u5b58\u5728\uff09\u5e76 merge</li> <li>\u628a runtime \u6536\u96c6\u5230\u7684 inline cache / branch / throw \u6570\u636e\u5199\u5165 PGO \u6587\u4ef6</li> <li><code>runtime/jit/profile_saver_worker.h</code>\uff1a<code>ProfileSaverWorker</code></li> <li>\u57fa\u4e8e <code>taskmanager::TaskManager</code> \u63d0\u4ea4\u540e\u53f0\u4fdd\u5b58\u4efb\u52a1</li> <li>\u652f\u6301 zygote fork\uff1a<code>PreZygoteFork()</code> \u4f1a finalize\uff0c<code>PostZygoteFork()</code> \u4f1a\u91cd\u5efa worker</li> </ul> <p>\u6b64\u5916 <code>runtime/runtime.cpp</code> \u7684 Destroy \u8def\u5f84\u4f1a\u5728\u6761\u4ef6\u6ee1\u8db3\u65f6\u5199 profile\uff1a - <code>SaveProfileInfo()</code> \u4e14 <code>AotManager-&gt;HasProfiledMethods()</code> \u65f6\u89e6\u53d1 <code>ProfilingSaver::SaveProfile(...)</code> - class context \u5b57\u7b26\u4e32\u7531 <code>BootClassContext + \":\" + AppClassContext</code> \u7ec4\u6210\uff08\u7528\u4e8e\u5173\u8054 profile \u4e0e classpath\uff09</p>"},{"location":"06_Tooling_Profiling_Verification/#4-verification-runtime","title":"4. Verification\uff1a\u5b57\u8282\u7801\u9a8c\u8bc1\u5728 runtime \u4e2d\u5982\u4f55\u6302\u63a5","text":""},{"location":"06_Tooling_Profiling_Verification/#41-apiruntime-publich","title":"4.1 \u516c\u5171 API\uff08runtime \u4fa7\u53ea\u4f9d\u8d56 public.h\uff09","text":"<p><code>verification/public.h</code> \u7ed9\u51fa\u6700\u5c0f\u516c\u5f00\u63a5\u53e3\uff1a - <code>VerificationMode</code>\uff08DISABLED/ON_THE_FLY/AHEAD_OF_TIME/DEBUG\uff09 - <code>CreateService(config, allocator, ClassLinker*, cacheFile)</code> - <code>Verify(service, Method*, mode)</code></p>"},{"location":"06_Tooling_Profiling_Verification/#42-runtime-verifier-service","title":"4.2 runtime \u521d\u59cb\u5316 verifier service","text":"<p><code>runtime/runtime.cpp</code> \u4e2d\uff1a - <code>Runtime::InitializeVerifierRuntime()</code> \u4f1a\u5728 verification mode enabled \u65f6\u521b\u5efa <code>verifierService_</code> - Destroy \u65f6\u82e5 verifier enabled\uff0c\u4f1a <code>verifier::DestroyService(verifierService_, updateCache)</code></p> <p>\u8fd9\u8bf4\u660e verifier \u4f5c\u4e3a\u4e00\u4e2a\u201c\u53ef\u9009\u5b50\u7cfb\u7edf\u201d\uff0c\u5176\u751f\u547d\u5468\u671f\u4e0e runtime \u4e25\u683c\u7ed1\u5b9a\uff0c\u5e76\u4e14\u4f9d\u8d56\uff1a - \u5185\u90e8\u5206\u914d\u5668\uff08internal allocator\uff09 - <code>ClassLinker</code>\uff08\u7528\u4e8e\u679a\u4e3e/\u89e3\u6790 Method/Class\uff09 - cache \u6587\u4ef6\uff08\u53ef\u9009\uff0c\u9000\u51fa\u65f6\u53ef\u66f4\u65b0\uff09</p>"},{"location":"06_Tooling_Profiling_Verification/#43-verifier","title":"4.3 \u72ec\u7acb verifier \u53ef\u6267\u884c\u7684\u5b9e\u73b0\u6837\u4f8b","text":"<p><code>verification/verifier/verifier.cpp</code> \u5c55\u793a\u4e86 AOT \u9a8c\u8bc1\u7684\u5178\u578b\u5b9e\u73b0\u65b9\u5f0f\uff1a - \u679a\u4e3e panda files \u4e0e classes\uff0c\u5c06 methods \u5165\u961f - \u591a\u7ebf\u7a0b worker\uff08\u6700\u591a <code>MAX_THREADS</code>\uff09\uff0c\u6309 method SourceLang \u521b\u5efa\u5bf9\u5e94\u8bed\u8a00\u7684 ManagedThread\uff08\u901a\u8fc7 language plugin\uff09 - \u5bf9\u6bcf\u4e2a method \u8c03\u7528 <code>ark::verifier::Verify(service, method, mode)</code></p> <p>\u8fd9\u4e5f\u63d0\u793a\uff1averification \u672c\u8d28\u4e0a\u662f \u201c\u6309\u8bed\u8a00\u63d2\u4ef6\u521b\u5efa\u7ebf\u7a0b \u2192 \u9010 method \u9a8c\u8bc1\u201d\uff0c\u5e76\u4e0d\u5f3a\u5236\u4e0e\u89e3\u91ca\u5668/JIT \u5f3a\u8026\u5408\u3002</p>"},{"location":"06_Tooling_Profiling_Verification/#5-2","title":"5. \u9636\u6bb5 2\uff08\u540e\u7eed\u6269\u5c55\u5efa\u8bae\uff09","text":"<ul> <li>\u753b\u51fa <code>RuntimeNotificationManager</code> \u7684\u4e8b\u4ef6\u6d41\u4e0e\u76d1\u542c\u8005\uff08Debugger/Inspector/\u5176\u4ed6\u5de5\u5177\uff09\u7684\u8ba2\u9605\u5173\u7cfb\u56fe</li> <li>\u7ed9 sampling profiler \u505a\u201c\u4fe1\u53f7\u2192\u91c7\u6837\u2192\u5199 aspt\u201d\u5b8c\u6574\u94fe\u8def\u56fe\uff0c\u5e76\u6307\u51fa\u53ef\u914d\u7f6e\u9879\uff08\u73af\u5883\u53d8\u91cf\u3001options\uff09</li> <li>\u5c06 PGO profile \u6587\u4ef6\u683c\u5f0f\u3001class context \u5b57\u7b26\u4e32\u3001AotManager \u7684 <code>profiledMethods</code> \u751f\u547d\u5468\u671f\u5199\u6210\u4e00\u7bc7\u53ef\u843d\u5730\u7684\u8c03\u4f18\u6307\u5357</li> <li>\u628a verifier \u7684\u9519\u8bef\u6a21\u578b\uff08messages.yaml/Status\uff09\u4e0e\u5b9e\u9645\u62a5\u9519\u793a\u4f8b\u6574\u7406\u6210\u201c\u5e38\u89c1\u9a8c\u8bc1\u5931\u8d25 cookbook\u201d</li> </ul>"},{"location":"07_Build_and_Configuration/","title":"Chapter 7\uff1a\u6784\u5efa\u4e0e\u914d\u7f6e\uff08GN / CMake / Options &amp; Generated Artifacts\uff09","text":"<p>\u672c\u7ae0\u628a\u201c\u600e\u4e48\u628a\u8fd9\u5957 VM \u7f16\u51fa\u6765\uff0c\u4ee5\u53ca\u8fd0\u884c\u65f6/\u7f16\u8bd1\u5668/\u63d2\u4ef6\u7684 options \u4e0e\u751f\u6210\u4ee3\u7801\u600e\u4e48\u4e32\u8d77\u6765\u201d\u6574\u7406\u6210\u4e00\u5f20\u53ef\u64cd\u4f5c\u7684\u5730\u56fe\u3002\u5de5\u7a0b\u540c\u65f6\u652f\u6301 GN \u4e0e CMake \u4e24\u5957\u6784\u5efa\u4f53\u7cfb\uff0c\u5b83\u4eec\u5171\u4eab\u540c\u4e00\u5957\u201cYAML \u2192 \u4ee3\u7801\u751f\u6210/\u5408\u5e76 \u2192 \u7f16\u8bd1\u94fe\u63a5\u201d\u7684\u601d\u8def\u3002</p>"},{"location":"07_Build_and_Configuration/#1","title":"1. \u6784\u5efa\u5165\u53e3\u603b\u89c8","text":"\u4f53\u7cfb \u9876\u5c42\u5165\u53e3 \u7279\u70b9 \u4f60\u6700\u5e38\u6539\u7684\u5730\u65b9 GN\uff08OHOS/\u96c6\u6210\u6784\u5efa\uff09 <code>BUILD.gn</code>\uff08\u9876\u5c42\uff09 + \u5404\u5b50\u6a21\u5757 <code>*/BUILD.gn</code> \u901a\u8fc7 gni \u63a7\u5236\u5b8f\u4e0e\u5e73\u53f0\uff1b\u5927\u91cf\u201c\u751f\u6210\u76ee\u6807\u201d\u96c6\u4e2d\u5728 <code>*_header_deps</code> <code>runtime/BUILD.gn</code>\u3001<code>compiler/BUILD.gn</code>\u3001<code>plugins/*/BUILD.gn</code> CMake\uff08\u72ec\u7acb/host \u5de5\u5177\u94fe\uff09 <code>CMakeLists.txt</code>\uff08\u9876\u5c42\uff09 + \u5404\u5b50\u6a21\u5757 <code>*/CMakeLists.txt</code> <code>panda_gen_files</code> \u6c47\u603b\u6240\u6709\u751f\u6210\u6b65\u9aa4\uff1b<code>RegisterPlugins.cmake</code> \u81ea\u52a8\u6ce8\u518c\u63d2\u4ef6 <code>runtime/CMakeLists.txt</code>\u3001<code>cmake/PostPlugins.cmake</code>\u3001<code>cmake/TemplateBasedGen.cmake</code>"},{"location":"07_Build_and_Configuration/#2-panda_gen_files-postplugins","title":"2. \u751f\u6210\u7cfb\u7edf\u7684\u6838\u5fc3\uff1a<code>panda_gen_files</code> + PostPlugins","text":""},{"location":"07_Build_and_Configuration/#21-cmakepanda_gen_files-umbrella-target","title":"2.1 CMake\uff1a<code>panda_gen_files</code> \u662f\u201c\u6240\u6709\u751f\u6210\u7269\u201d\u7684 umbrella target","text":"<p>\u9876\u5c42 <code>CMakeLists.txt</code> \u660e\u786e\u521b\u5efa\uff1a - <code>add_custom_target(panda_gen_files COMMENT \"Generate all sources\")</code></p> <p>\u7136\u540e\u5728\u591a\u4e2a\u6a21\u5757/\u811a\u672c\u91cc\u4e0d\u65ad <code>add_dependencies(panda_gen_files ...)</code>\uff0c\u4f7f\u5f97\uff1a</p> <p>\u53ea\u8981\u4f9d\u8d56 <code>panda_gen_files</code>\uff0c\u5c31\u80fd\u4fdd\u8bc1\u6240\u6709 YAML \u5408\u5e76\u3001\u6a21\u677f\u751f\u6210\u3001\u63d2\u4ef6 merge \u6587\u4ef6\u90fd\u5df2\u4ea7\u751f\u3002</p>"},{"location":"07_Build_and_Configuration/#22-postplugins","title":"2.2 PostPlugins\uff1a\u628a\u201c\u63d2\u4ef6\u8ffd\u52a0\u5185\u5bb9\u201d\u62fc\u63a5\u5230\u6838\u5fc3\u751f\u6210\u7269","text":"<p><code>cmake/RegisterPlugins.cmake</code> \u63d0\u4f9b merge_plugins machinery\uff1a - core \u4fa7\u5148 <code>declare_plugin_file(\"xxx.h\")</code> \u58f0\u660e\u4e00\u4e2a\u53ef\u88ab\u63d2\u4ef6\u586b\u5145\u7684\u201c\u805a\u5408\u6587\u4ef6\u201d - \u63d2\u4ef6\u4fa7\u7528 <code>add_merge_plugin(PLUGIN_NAME \"xxx.h\" INPUT_FILE \"...\")</code> \u628a\u5185\u5bb9\u8ffd\u52a0\u8fdb\u53bb</p> <p><code>cmake/PostPlugins.cmake</code> \u5728\u6700\u540e\u9636\u6bb5\u505a\u4e24\u4ef6\u4e8b\uff1a - \u628a\u5404\u63d2\u4ef6\u8d21\u732e\u7684\u7247\u6bb5 <code>cat ... &gt; generated/xxx.h</code> \u751f\u6210\u805a\u5408\u6587\u4ef6 - include \u4e00\u7cfb\u5217 <code>*PostPlugins.cmake</code>\uff0c\u5206\u522b\u4e3a runtime/compiler/verification \u7b49\u6a21\u5757\u751f\u6210\u6700\u7ec8\u53ef\u7f16\u8bd1\u7684\u5934/\u6e90</p> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u5de5\u7a0b\u91cc\u4f1a\u51fa\u73b0\u5927\u91cf <code>...PostPlugins.cmake</code>\uff1a\u5b83\u4eec\u5c31\u662f\u201c\u751f\u6210\u94fe\u8def\u7684\u62fc\u88c5\u70b9\u201d\u3002</p>"},{"location":"07_Build_and_Configuration/#3-yaml-optionsheaderruntime-options","title":"3. YAML \u2192 Options/Header\uff1aruntime options \u5982\u4f55\u751f\u6210","text":""},{"location":"07_Build_and_Configuration/#31-runtimeoptionsyaml-merge-runtime_options_genh","title":"3.1 runtime/options.yaml \u662f\u6e90\uff0c\u6700\u7ec8\u4f1a merge \u6210 <code>runtime_options_gen.h</code>","text":"<p>\u5728 CMake \u4fa7\uff1a - <code>runtime/RuntimeOptionsPostPlugins.cmake</code>\uff1a   - \u6536\u96c6 <code>runtime_options_gen</code> \u7684 <code>RUNTIME_OPTIONS_YAML_FILES</code>   - \u8c03\u7528 <code>templates/merge.rb</code> \u5408\u5e76\u6210 <code>runtime_options_gen.yaml</code>   - \u518d\u8c03\u7528 <code>panda_gen_options(...)</code> \u751f\u6210 <code>runtime_options_gen.h</code></p> <p><code>panda_gen_options</code> \u7684\u5b9e\u73b0\u4f4d\u4e8e <code>cmake/TemplateBasedGen.cmake</code>\uff0c\u672c\u8d28\u662f\uff1a - \u4f7f\u7528 <code>templates/options/options.h.erb</code> + <code>templates/common.rb</code> \u628a YAML \u6e32\u67d3\u4e3a C++ header - \u751f\u6210\u76ee\u5f55\u4e00\u822c\u5728 <code>${CMAKE_CURRENT_BINARY_DIR}/panda_gen_options/generated/...</code></p>"},{"location":"07_Build_and_Configuration/#32-gn","title":"3.2 GN \u4fa7\u7684\u540c\u6784\u6982\u5ff5","text":"<p>\u9876\u5c42 <code>BUILD.gn</code> \u4e2d\u53ef\u770b\u5230\u7c7b\u4f3c\u7684\u5408\u5e76\u6b65\u9aa4\uff08\u4f8b\u5982 <code>merge_runtime_options_yamls</code>\uff09\uff1a - \u628a <code>runtime/options.yaml</code> \u4e0e\u5404\u63d2\u4ef6\u7684 <code>plugin_runtime_options_yamls</code> \u5408\u5e76 - \u8f93\u51fa\u5230 <code>$target_gen_dir/runtime_options.yaml</code>\uff08\u518d\u88ab\u540e\u7eed\u751f\u6210\u89c4\u5219\u6d88\u8017\uff09</p> <p>\u7ed3\u8bba\uff1a\u65e0\u8bba GN \u8fd8\u662f CMake\uff0coptions \u90fd\u6765\u81ea YAML\uff0c\u4e14\u652f\u6301\u88ab\u63d2\u4ef6\u201c\u8ffd\u52a0/\u8986\u76d6\u201d\u3002</p>"},{"location":"07_Build_and_Configuration/#4-runtimebuildgn","title":"4. runtime/BUILD.gn\uff1a\u5934\u6587\u4ef6\u751f\u6210\u4f9d\u8d56\u975e\u5e38\u96c6\u4e2d","text":"<p><code>runtime/BUILD.gn</code> \u6709\u4e00\u4e2a\u975e\u5e38\u5173\u952e\u7684 group\uff1a<code>arkruntime_header_deps</code>\uff0c\u5176\u4e2d\u7f57\u5217\u4e86 runtime \u7f16\u8bd1\u524d\u5fc5\u987b\u751f\u6210\u7684\u4e00\u6279\u76ee\u6807\uff0c\u4f8b\u5982\uff1a - entrypoints / intrinsics / interpreter-inl \u7684 ISA \u751f\u6210\u7269 - <code>libarkruntime_options_gen_h</code>\uff08runtime options header\uff09 - verification \u7684\u751f\u6210\u7269\uff08verifier messages\u3001absint \u6a21\u677f\u7b49\uff09 - logger options \u7b49\uff08\u6765\u81ea <code>libarkbase</code> \u7684\u751f\u6210\uff09</p> <p>\u8fd9\u80fd\u5e2e\u52a9\u4f60\u5feb\u901f\u5224\u65ad\uff1a</p> <p>\u201c\u6211\u6539\u4e86\u67d0\u4e2a YAML/\u6a21\u677f/\u63d2\u4ef6\u6ce8\u5165\u7247\u6bb5\u540e\uff0c\u4e3a\u4ec0\u4e48\u7f16\u8bd1\u4f1a\u5931\u8d25\uff1f\u201d\u2014\u2014\u901a\u5e38\u662f\u67d0\u4e2a\u751f\u6210\u76ee\u6807\u6ca1\u88ab\u89e6\u53d1\u6216 include dir \u6ca1\u52a0\u5bf9\u3002</p>"},{"location":"07_Build_and_Configuration/#5-runtimecmakeliststxt","title":"5. runtime/CMakeLists.txt\uff1a\u94fe\u63a5\u5c42\u9762\u7684\u201c\u771f\u5b9e\u6e90\u6587\u4ef6\u6e05\u5355\u201d","text":"<p><code>runtime/CMakeLists.txt</code> \u91cc <code>set(SOURCES ...)</code> \u662f runtime \u9759\u6001/\u5171\u4eab\u5e93\u7684\u6e90\u6587\u4ef6\u771f\u503c\u8868\uff1a - \u89e3\u91ca\u5668\uff1a<code>interpreter/interpreter.cpp</code> - entrypoints\uff1a<code>entrypoints/entrypoints.cpp</code> - \u5185\u5b58\u7ba1\u7406\uff1a<code>mem/*</code> + <code>mem/gc/*</code>\uff08\u542b G1/Gen/STW/Epsilon\uff09 - bridge \u6c47\u7f16\uff1a\u6309\u67b6\u6784\u8ffd\u52a0 <code>bridge/arch/*/*.S</code> - tooling\uff1a<code>tooling/*</code>\uff08debugger/inspector/sampler\uff09 - profilesaver &amp; jit profiling\uff1a<code>jit/*</code>\u3001<code>profilesaver/*</code> - class linker / runtime \u4e3b\u4f53\uff1a<code>class_linker*.cpp</code>\u3001<code>runtime.cpp</code> \u7b49</p> <p>\u5efa\u8bae\u7528\u5b83\u505a\u201c\u88c1\u526a/\u5b9a\u4f4d\u201d\uff1a - \u5982\u679c\u4f60\u60f3\u786e\u8ba4\u67d0\u4e2a\u6587\u4ef6\u662f\u5426\u53c2\u4e0e runtime \u6784\u5efa\uff0c\u5148\u770b\u8fd9\u91cc\uff08\u518d\u5bf9\u7167 GN \u7684 calculated sources\uff09\u3002</p>"},{"location":"07_Build_and_Configuration/#6","title":"6. \u5e38\u89c1\u914d\u7f6e\u843d\u70b9\uff08\u4f60\u6539\u9009\u9879\u65f6\u8be5\u53bb\u54ea\uff09","text":"<ul> <li>\u8fd0\u884c\u65f6 options\uff1a<code>runtime/options.yaml</code>\uff08\u7ecf\u5408\u5e76\u751f\u6210 <code>runtime_options_gen.h</code>\uff09</li> <li>\u7f16\u8bd1\u5668 options\uff1a<code>compiler/compiler.yaml</code>\uff08\u540c\u6837\u6709 CompilerOptionsPostPlugins \u7684\u751f\u6210\u94fe\u8def\uff09</li> <li>\u63d2\u4ef6 options\uff1a\u5404\u63d2\u4ef6\u76ee\u5f55\u4e0b\u7684 <code>runtime_options.yaml</code> \u6216 <code>plugin_options.yaml</code>\uff08\u6700\u7ec8\u8fdb\u5165\u5408\u5e76/\u751f\u6210\uff09</li> <li>logger options\uff1a<code>libarkbase/panda_gen_options/generated/logger_options.h</code>\uff08\u7531 libarkbase \u7684\u751f\u6210\u94fe\u8def\u4ea7\u51fa\uff09</li> </ul>"},{"location":"07_Build_and_Configuration/#7-2","title":"7. \u9636\u6bb5 2\uff08\u540e\u7eed\u6269\u5c55\u5efa\u8bae\uff09","text":"<ul> <li>\u7ed9\u201cYAML \u5408\u5e76 \u2192 header \u751f\u6210 \u2192 include dirs\u201d\u753b\u4e00\u5f20\u8de8 GN/CMake \u7684\u7edf\u4e00\u56fe\uff0c\u5e76\u660e\u786e\u6bcf\u79cd\u751f\u6210\u7269\u7684\u8f93\u51fa\u8def\u5f84</li> <li>\u628a <code>plugins/</code> \u7684 RegisterPlugin/merge_plugins \u673a\u5236\u5199\u6210\u4e00\u7bc7\u201c\u5982\u4f55\u4e3a\u65b0\u8bed\u8a00/\u65b0\u8fd0\u884c\u65f6\u6269\u5c55\u6dfb\u52a0\u751f\u6210\u4ee3\u7801\u201d\u7684 cookbook</li> <li>\u8865\u9f50 <code>compiler/*PostPlugins.cmake</code> \u4e0e <code>runtime/*PostPlugins.cmake</code> \u7684\u751f\u6210\u7269\u6e05\u5355\uff08intrinsics/entrypoints/ISA templates \u7b49\uff09</li> </ul>"},{"location":"All_Pages/","title":"All Pages\uff08\u5168\u91cf\u9875\u9762\u7d22\u5f15\uff09","text":"<p>\u8fd9\u4e2a\u9875\u9762\u7528\u4e8e\u4fdd\u8bc1\uff1a\u4ed3\u5e93\u5185\u6bcf\u4e00\u7bc7 Markdown \u90fd\u80fd\u5728\u7ad9\u70b9\u91cc\u88ab\u70b9\u51fb\u8bbf\u95ee\u3002</p> <p>\u63d0\u793a\uff1a\u5982\u679c\u4f60\u5df2\u7ecf\u77e5\u9053\u5173\u952e\u8bcd\uff0c\u7528\u53f3\u4e0a\u89d2\u641c\u7d22\u4f1a\u66f4\u5feb\u3002</p>"},{"location":"All_Pages/#01_startup","title":"01_Startup","text":"<ul> <li>Errata_to_Stage1</li> <li>Index</li> <li>01_Startup/README</li> </ul>"},{"location":"All_Pages/#02_memory","title":"02_Memory","text":"<ul> <li>Errata_to_Stage1</li> <li>Index</li> <li>02_Memory/README</li> </ul>"},{"location":"All_Pages/#03_classloading","title":"03_ClassLoading","text":"<ul> <li>Completion_Review</li> <li>Class</li> <li>ClassLinkerContext</li> <li>ETS_Plugin_Summary</li> <li>Field</li> <li>Index</li> <li>ITable_and_IMT</li> <li>Method</li> <li>Index</li> <li>Errata_to_Stage1</li> <li>_Glossary</li> <li>Index</li> <li>plugins_ets_runtime_ets_class_linker.cpp</li> <li>plugins_ets_runtime_ets_class_linker.h</li> <li>plugins_ets_runtime_ets_class_linker_context.cpp</li> <li>plugins_ets_runtime_ets_class_linker_context.h</li> <li>plugins_ets_runtime_ets_class_linker_extension.cpp</li> <li>plugins_ets_runtime_ets_class_linker_extension.h</li> <li>plugins_ets_runtime_ets_itable_builder.cpp</li> <li>plugins_ets_runtime_ets_itable_builder.h</li> <li>plugins_ets_runtime_ets_language_context.cpp</li> <li>plugins_ets_runtime_ets_language_context.h</li> <li>runtime_class_linker.cpp</li> <li>runtime_class_linker_context.h</li> <li>runtime_class_linker_extension.cpp</li> <li>runtime_class_lock.cpp</li> <li>runtime_class_lock.h</li> <li>runtime_core_core_class_linker_extension.cpp</li> <li>runtime_file_manager.cpp</li> <li>runtime_imtable_builder.cpp</li> <li>runtime_include_class-inl.h</li> <li>runtime_include_class.h</li> <li>runtime_include_class_helper.h</li> <li>runtime_include_class_linker.h</li> <li>runtime_include_class_linker_extension.h</li> <li>runtime_include_field.h</li> <li>runtime_include_file_manager.h</li> <li>runtime_include_imtable_builder.h</li> <li>runtime_include_itable.h</li> <li>runtime_include_itable_builder.h</li> <li>runtime_include_method.h</li> <li>runtime_include_vtable_builder_base-inl.h</li> <li>runtime_include_vtable_builder_base.h</li> <li>runtime_include_vtable_builder_interface.h</li> <li>runtime_include_vtable_builder_variance-inl.h</li> <li>runtime_include_vtable_builder_variance.h</li> <li>Builders_and_LinkMethods</li> <li>ClassLoading_EndToEnd</li> <li>Concurrency_and_ClassLock</li> <li>ETS_Context_Native_vs_Managed_Load</li> <li>FileManager_ABC_AN</li> <li>GetClass_and_LoadClass</li> <li>Index</li> <li>LayoutFields_and_LinkFields</li> <li>Index</li> <li>Index</li> <li>Newbie_MinDebug_Playbook</li> <li>03_ClassLoading/README</li> </ul>"},{"location":"All_Pages/#04_executionengine","title":"04_ExecutionEngine","text":"<ul> <li>Completion_Review</li> <li>Bridge_ABI_and_FrameKind</li> <li>Deopt_and_OSR</li> <li>Entrypoint_and_MethodDispatch</li> <li>Entrypoints</li> <li>Frame_VReg_Acc</li> <li>Index</li> <li>IRTOC_FastInterpreter</li> <li>ISA_and_OpcodeModel</li> <li>StackWalker</li> <li>Index</li> <li>Errata_to_Stage1</li> <li>_Glossary</li> <li>build_irtoc_irtoc_interpreter_disasm.txt</li> <li>build_irtoc_irtoc_interpreter_interpreter.irt.fixed</li> <li>build_irtoc_irtoc_interpreter_irtoc_code.cpp</li> <li>build_irtoc_irtoc_interpreter_validation.yaml</li> <li>build_runtime_include_irtoc_interpreter_utils.h</li> <li>bytecode_optimizer_optimize_bytecode.cpp</li> <li>bytecode_optimizer_optimize_bytecode.h</li> <li>compiler_aot_aot_file.cpp</li> <li>compiler_aot_aot_file.h</li> <li>compiler_aot_aot_headers.h</li> <li>compiler_aot_aot_manager.cpp</li> <li>compiler_aot_aot_manager.h</li> <li>compiler_aot_compiled_method.h</li> <li>Index</li> <li>irtoc_scripts_common.irt</li> <li>irtoc_scripts_interpreter.irt</li> <li>isa_isa.yaml</li> <li>plugins_ets_isa_isa.yaml</li> <li>quickener_quick.cpp</li> <li>runtime_arch_aarch64_osr_aarch64.S</li> <li>runtime_arch_amd64_osr_amd64.S</li> <li>runtime_arch_arm_osr_arm.S</li> <li>runtime_arch_asm_support.cpp</li> <li>runtime_arch_x86_osr_x86.S</li> <li>runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S</li> <li>runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S</li> <li>runtime_bridge_arch_aarch64_deoptimization_aarch64.S</li> <li>runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S</li> <li>runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S</li> <li>runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S</li> <li>runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S</li> <li>runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S</li> <li>runtime_bridge_arch_amd64_deoptimization_amd64.S</li> <li>runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S</li> <li>runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S</li> <li>runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S</li> <li>runtime_bridge_bridge.cpp</li> <li>runtime_bridge_bridge.h</li> <li>runtime_compiler.cpp</li> <li>runtime_compiler.h</li> <li>runtime_deoptimization.cpp</li> <li>runtime_deoptimization.h</li> <li>runtime_entrypoints_entrypoints.cpp</li> <li>runtime_entrypoints_entrypoints.h</li> <li>runtime_exceptions.cpp</li> <li>runtime_include_compiler_interface.h</li> <li>runtime_include_exceptions.h</li> <li>runtime_include_stack_walker.h</li> <li>runtime_interpreter_acc_vregister-inl.h</li> <li>runtime_interpreter_acc_vregister.h</li> <li>runtime_interpreter_arch_macros.h</li> <li>runtime_interpreter_frame.h</li> <li>runtime_interpreter_instruction_handler_base.h</li> <li>runtime_interpreter_instruction_handler_state.h</li> <li>runtime_interpreter_interpreter-inl.h</li> <li>runtime_interpreter_interpreter.cpp</li> <li>runtime_interpreter_interpreter.h</li> <li>runtime_interpreter_interpreter_impl.cpp</li> <li>runtime_interpreter_interpreter_impl.h</li> <li>runtime_interpreter_runtime_interface.h</li> <li>runtime_interpreter_state.h</li> <li>runtime_interpreter_templates_interpreter-inl_gen.h.erb</li> <li>runtime_interpreter_templates_irtoc_interpreter_utils.h.erb</li> <li>runtime_interpreter_templates_isa_constants_gen.h.erb</li> <li>runtime_interpreter_vregister.h</li> <li>runtime_osr.cpp</li> <li>runtime_osr.h</li> <li>runtime_stack_walker.cpp</li> <li>runtime_templates_bridge_dispatch.S.erb</li> <li>runtime_templates_bridge_dispatch_dyn.S.erb</li> <li>runtime_templates_plugins_interpreters-inl.h.erb</li> <li>Bridge_I2C_C2I</li> <li>Deopt_and_OSR</li> <li>Entrypoints_and_RuntimeInterface</li> <li>ExecutionEngine_EndToEnd</li> <li>Index</li> <li>Interpreter_Execute</li> <li>IRTOC_DSL_Primer</li> <li>IRTOC_DSL_Reference</li> <li>IRTOC_FastInterpreter</li> <li>Opcode_DeepDives_IRTOC</li> <li>StackWalking</li> <li>Index</li> <li>Index</li> <li>Newbie_MinDebug_Playbook</li> <li>04_ExecutionEngine/README</li> </ul>"},{"location":"All_Pages/#05_nativebridge","title":"05_NativeBridge","text":"<ul> <li>Errata_to_Stage1</li> <li>plugins_ets_runtime_ani_ani.h</li> <li>plugins_ets_runtime_ani_ani_helpers.cpp</li> <li>plugins_ets_runtime_ani_ani_helpers.h</li> <li>plugins_ets_runtime_ani_ani_interaction_api.cpp</li> <li>plugins_ets_runtime_ani_ani_interaction_api.h</li> <li>plugins_ets_runtime_ani_ani_options.cpp</li> <li>plugins_ets_runtime_ani_ani_options.h</li> <li>plugins_ets_runtime_ani_ani_options_parser.cpp</li> <li>plugins_ets_runtime_ani_ani_options_parser.h</li> <li>plugins_ets_runtime_ani_ani_vm_api.cpp</li> <li>plugins_ets_runtime_ani_ani_vm_api.h</li> <li>plugins_ets_runtime_ets_napi_env.cpp</li> <li>plugins_ets_runtime_ets_napi_env.h</li> <li>plugins_ets_runtime_ets_native_library.cpp</li> <li>plugins_ets_runtime_ets_native_library.h</li> <li>plugins_ets_runtime_ets_native_library_provider.cpp</li> <li>plugins_ets_runtime_ets_native_library_provider.h</li> <li>plugins_ets_runtime_external_iface_table.h</li> <li>plugins_ets_runtime_interop_js_interop_context.cpp</li> <li>plugins_ets_runtime_interop_js_interop_context.h</li> <li>plugins_ets_runtime_interop_js_interop_context_api.h</li> <li>Index</li> <li>05_NativeBridge/README</li> </ul>"},{"location":"All_Pages/#06_tooling_profiling_verification","title":"06_Tooling_Profiling_Verification","text":"<ul> <li>Errata_to_Stage1</li> <li>Index</li> <li>06_Tooling_Profiling_Verification/README</li> </ul>"},{"location":"All_Pages/#07_build_and_configuration","title":"07_Build_and_Configuration","text":"<ul> <li>Errata_to_Stage1</li> <li>Index</li> <li>07_Build_and_Configuration/README</li> </ul>"},{"location":"All_Pages/#root-files","title":"Root Files","text":"<ul> <li>00_Master_Index</li> <li>00_Methodology_Wiki_Review_Checklist</li> <li>01_Startup_and_Entrypoints</li> <li>02_Memory_Management_and_Object_Model</li> <li>03_Class_Loading_and_Linking</li> <li>04_Execution_Engine_Interpreter_JIT_AOT</li> <li>05_Native_Bridge_ANI_and_Interop</li> <li>06_Tooling_Profiling_Verification</li> <li>07_Build_and_Configuration</li> <li>All_Pages</li> <li>index</li> </ul>"},{"location":"01_Startup/","title":"01_Startup\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\u3002</p>"},{"location":"01_Startup/#_1","title":"\u672c\u7ae0\u8303\u56f4\uff08\u5f85\u51bb\u7ed3\uff09","text":"<ul> <li>seed_dirs: panda, runtime, plugins/ets/runtime/ani</li> <li>seed_files: runtime/options.yaml, BUILD.gn, CMakeLists.txt</li> </ul>"},{"location":"01_Startup/#_2","title":"\u5bfc\u822a","text":"<ul> <li><code>Index.md</code>\uff1a\u6587\u4ef6\u6e05\u5355\u4e0e\u9605\u8bfb\u987a\u5e8f</li> <li><code>Manifests/files.yaml</code>\uff1a\u672c\u7ae0\u9010\u884c\u7cbe\u8bfb\u6587\u4ef6\u6e05\u5355\uff08\u52a8\u6001\u6269\u5c55\uff09</li> <li><code>Manifests/tree_inventory.txt</code>\uff1aseed \u626b\u63cf\u5f97\u5230\u7684\u5b8c\u6574\u6587\u4ef6\u6e05\u5355\uff08tree \u7b49\u4ef7\uff09</li> <li><code>FileNotes/</code>\uff1a\u9010\u6587\u4ef6\u9010\u884c\u7b14\u8bb0</li> <li><code>Errata_to_Stage1.md</code>\uff1a\u9636\u6bb5\u4e00\u6821\u6b63\u70b9</li> </ul>"},{"location":"01_Startup/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"01_Startup/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>\uff08\u6682\u65e0\uff09</li> </ul>"},{"location":"01_Startup/Index/","title":"01_Startup - Index","text":""},{"location":"01_Startup/Index/#_1","title":"\u9605\u8bfb\u987a\u5e8f\uff08\u5f85\u8865\uff09","text":""},{"location":"01_Startup/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"02_Memory/","title":"02_Memory\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\u3002</p>"},{"location":"02_Memory/#_1","title":"\u672c\u7ae0\u8303\u56f4\uff08\u5f85\u51bb\u7ed3\uff09","text":"<ul> <li>seed_dirs: runtime/mem, runtime/coretypes, runtime/include/coretypes, docs</li> <li>seed_files: runtime/object_header.cpp, runtime/include/object_header.h, runtime/mark_word.h, runtime/object_header_config.h</li> </ul>"},{"location":"02_Memory/#_2","title":"\u5bfc\u822a","text":"<ul> <li><code>Index.md</code>\uff1a\u6587\u4ef6\u6e05\u5355\u4e0e\u9605\u8bfb\u987a\u5e8f</li> <li><code>Manifests/files.yaml</code>\uff1a\u672c\u7ae0\u9010\u884c\u7cbe\u8bfb\u6587\u4ef6\u6e05\u5355\uff08\u52a8\u6001\u6269\u5c55\uff09</li> <li><code>Manifests/tree_inventory.txt</code>\uff1aseed \u626b\u63cf\u5f97\u5230\u7684\u5b8c\u6574\u6587\u4ef6\u6e05\u5355\uff08tree \u7b49\u4ef7\uff09</li> <li><code>FileNotes/</code>\uff1a\u9010\u6587\u4ef6\u9010\u884c\u7b14\u8bb0</li> <li><code>Errata_to_Stage1.md</code>\uff1a\u9636\u6bb5\u4e00\u6821\u6b63\u70b9</li> </ul>"},{"location":"02_Memory/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"02_Memory/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>\uff08\u6682\u65e0\uff09</li> </ul>"},{"location":"02_Memory/Index/","title":"02_Memory - Index","text":""},{"location":"02_Memory/Index/#_1","title":"\u9605\u8bfb\u987a\u5e8f\uff08\u5f85\u8865\uff09","text":""},{"location":"02_Memory/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"03_ClassLoading/","title":"03_ClassLoading\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\uff08\u5df2\u95ed\u73af\u5230\u4ee3\u7801\u5b9e\u73b0\u4e0e ETS \u63d2\u4ef6\u843d\u5730\uff09\u3002</p>"},{"location":"03_ClassLoading/#_1","title":"\u4f60\u8bfb\u5b8c\u5e94\u8be5\u80fd\u56de\u7b54\u4ec0\u4e48\uff08\u9762\u5411\u65b0\u540c\u5b66\uff09","text":"<ul> <li>\u7c7b\u662f\u600e\u4e48\u88ab\u201c\u627e\u5230/\u52a0\u8f7d/\u94fe\u63a5/\u521d\u59cb\u5316\u201d\u7684\uff1a\u4ece <code>GetClass(descriptor|pf,id)</code> \u5230 <code>LoadClass</code> \u7ba1\u7ebf\u3001\u5230 <code>InitializeClass</code>\u3002</li> <li>\u6d3e\u53d1\u8868\uff08vtable / itable / IMT\uff09\u662f\u8c01\u5efa\u7684\u3001\u600e\u4e48\u5efa\u7684\u3001\u51b2\u7a81\u600e\u4e48\u5904\u7406\u7684\uff1adefault interface method\u3001multiple implement\u3001IMT \u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\u3002</li> <li>Field offset/\u5bf9\u8c61\u5e03\u5c40\u662f\u8c01\u7b97\u7684\uff1a\u9759\u6001/\u5b9e\u4f8b\u5b57\u6bb5\u5206\u6876\u3001\u5bf9\u9f50\u3001\u57fa\u7c7b padding \u56de\u586b\u3001ref/volatile \u7edf\u8ba1\u5199\u56de\u3002</li> <li>\u4e0a\u4e0b\u6587\uff08Context/Loader\uff09\u5982\u4f55\u9694\u79bb\u4e0e\u5e76\u53d1\u534f\u8c03\uff1adescriptor\u2192Class \u7f13\u5b58\u3001per-Class mutex+condvar\u3001GC roots\u3001ETS \u7684 RuntimeLinker \u94fe\u5f0f\u52a0\u8f7d\u3002</li> <li>ETS \u63d2\u4ef6\u600e\u4e48\u628a\u201c\u7b56\u7565\u201d\u843d\u5230\u201c\u5b9e\u73b0\u201d\uff1aLanguageContext \u5de5\u5382\uff08builder/extension/VM/GC/verification\uff09\u3001Extension \u81ea\u4e3e roots\u3001Context \u7684 native/managed \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u3002</li> </ul>"},{"location":"03_ClassLoading/#filenotes","title":"\u5feb\u901f\u4e0a\u624b\uff08\u4e0d\u8bfb FileNotes \u4e5f\u80fd\u5efa\u7acb\u6574\u4f53\u6a21\u578b\uff09","text":""},{"location":"03_ClassLoading/#0","title":"0) \u5148\u770b\u201c\u7aef\u5230\u7aef\u810a\u67f1\u56fe\u201d\uff08\u65b0\u4eba\u6700\u63a8\u8350\u7684\u7b2c\u4e00\u5165\u53e3\uff09","text":"<ul> <li>Flows/ClassLoading_EndToEnd\uff1a\u4e00\u5f20\u56fe\u628a\u201c\u6587\u4ef6\u88c5\u8f7d\u2192GetClass\u2192LoadClass\u2192builders/layout/link\u2192\u5e76\u53d1\u53bb\u91cd\u2192\u521d\u59cb\u5316\u4ea4\u754c\u201d\u4e32\u8d77\u6765\uff1b\u6bcf\u4e2a\u6846\u90fd\u80fd\u4e00\u952e\u4e0b\u6f5c\u5230\u5bf9\u5e94 Flow/\u5361\u7247/\u9010\u884c\u8bc1\u636e\u3002</li> </ul>"},{"location":"03_ClassLoading/#1","title":"1) \u5148\u8bb0\u4f4f\u4e00\u53e5\u8bdd\uff08\u672c\u7ae0\u4e3b\u7ebf\uff09","text":"<p>\u7c7b\u52a0\u8f7d = \u201c\u6587\u4ef6\u8fdb\u6765\u201d \u2192 \u201c\u6309 descriptor \u627e\u7c7b\u201d \u2192 \u201c\u521b\u5efa Class + \u586b methods/fields\u201d \u2192 \u201c\u5efa\u6d3e\u53d1\u8868/\u7b97 offset\u201d \u2192 \u201c\u63d2\u5165 context \u7f13\u5b58\u5e76\u53d1\u53bb\u91cd\u201d\u3002 \u5176\u4e2d\u201c\u8bed\u8a00\u5dee\u5f02\u201d\u4e3b\u8981\u901a\u8fc7 <code>ClassLinkerExtension/LanguageContext/ClassLinkerContext</code> \u4e09\u4e2a\u70b9\u6ce8\u5165\u3002</p>"},{"location":"03_ClassLoading/#2","title":"2) \u4e09\u4e2a\u4f60\u6700\u5e38\u9047\u5230\u7684\u573a\u666f\uff08\u5bf9\u5e94\u4e09\u6761\u9605\u8bfb\u8def\u7ebf\uff09","text":"<ul> <li>\u573a\u666f A\uff1a\u542f\u52a8\u540e\u7b2c\u4e00\u6b21\u89e3\u6790\u67d0\u4e2a\u7c7b\uff08\u4e3a\u4ec0\u4e48\u627e\u4e0d\u5230\uff1f\u4e3a\u4ec0\u4e48\u662f NCDFE\uff1f\uff09</li> <li>\u770b <code>GetClass</code> \u51b3\u7b56\u6811 + <code>LoadClass</code> \u7ba1\u7ebf + Extension \u7684\u5f02\u5e38\u5305\u88c5\uff08CNFE\u2192NCDFE\uff09\u3002</li> <li>\u573a\u666f B\uff1a\u63a5\u53e3\u65b9\u6cd5\u6d3e\u53d1/\u9ed8\u8ba4\u65b9\u6cd5\u51b2\u7a81\uff08\u4e3a\u4ec0\u4e48 MULTIPLE_IMPLEMENT\uff1f\u4e3a\u4ec0\u4e48 IMT \u4e3a\u7a7a\uff1f\uff09</li> <li>\u770b vtable/itable/IMT \u7684\u6784\u5efa\u987a\u5e8f\u4e0e\u51b2\u7a81\u7b56\u7565\u3002</li> <li>\u573a\u666f C\uff1aETS app context \u52a0\u8f7d\uff08\u4e3a\u4ec0\u4e48 native \u5148\u5c1d\u8bd5\uff1f\u4e3a\u4ec0\u4e48\u4e0d\u8ba9\u975e managed \u7ebf\u7a0b\u56de\u9000\uff1f\uff09</li> <li>\u770b ETS <code>EtsClassLinkerContext::LoadClass</code> \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u3002</li> </ul>"},{"location":"03_ClassLoading/#a","title":"\u573a\u666f A \u6392\u969c\uff1a\u4ece\u201c\u627e\u4e0d\u5230\u7c7b/\u521d\u59cb\u5316\u5931\u8d25\u201d\u5230\u5b9a\u4f4d\u70b9\uff08\u51b3\u7b56\u6811\uff09","text":"<pre><code>flowchart TD\n  S[\"\u75c7\u72b6/\u65e5\u5fd7\uff1a\u7c7b\u76f8\u5173\u5931\u8d25\\n- CLASS_NOT_FOUND\\n- Cannot find class &lt;descriptor&gt;\\n- ClassNotFoundException(CNFE)\\n- NoClassDefFoundError(NCDFE)\\n- \u542f\u52a8\u9636\u6bb5\u9996\u6b21\u89e6\u8fbe\u67d0\u7c7b\u5373\u5931\u8d25\"] --&gt; A{\"\u5931\u8d25\u53d1\u751f\u5728 boot \u8fd8\u662f app\uff1f\"}\n\n  A --&gt;|boot/\u542f\u52a8\u671f| B1[\"\u4f18\u5148\u770b\uff1aboot panda files \u662f\u5426\u5df2\u6ce8\u518c\\n+ boot bloom filter \u662f\u5426\u542f\u7528\"]\n  B1 --&gt; B2{\"descriptor \u771f\u7684\u5728 boot files \u91cc\u5417\uff1f\"}\n  B2 --&gt;|\u4e0d\u5728| C1[\"\u539f\u56e0\uff1a\u6587\u4ef6\u6ca1\u52a0\u8f7d/\u6ca1\u52a0\u5165 boot list\\n\u5b9a\u4f4d\uff1aFileManager::LoadAbcFile + ClassLinker::AddPandaFile\\n\u4f18\u5148\u8bfb\uff1aFlows/FileManager_ABC_AN.md\"]\n  B2 --&gt;|\u5728| C2{\"boot filter \u662f\u5426\u628a\u5b83\u5224\u4e3a IMPOSSIBLY_HAS\uff1f\"}\n  C2 --&gt;|\u662f| C3[\"\u539f\u56e0\uff1afilter \u6570\u636e/\u6ce8\u518c\u65f6\u673a\u95ee\u9898\\n\u5b9a\u4f4d\uff1aClassLinker::AddBootClassFilter/LookupInFilter\\n\u8bc1\u636e\uff1aFileNotes/runtime_class_linker.cpp.md\uff08boot filter \u6bb5\uff09\"]\n  C2 --&gt;|\u5426| C4[\"\u7ee7\u7eed\uff1a\u5728 bootPandaFiles_ \u67e5 classId \u5e76 LoadClass\\n\u4f18\u5148\u8bfb\uff1aFlows/GetClass_and_LoadClass.md\"]\n\n  A --&gt;|app/\u8fd0\u884c\u671f| D1[\"\u4f18\u5148\u770b\uff1aContext \u7684 LoadClass \u7b56\u7565\\n(\u9ed8\u8ba4 AppContext / ETS \u7279\u5316)\"]\n  D1 --&gt; D2{\"\u662f ETS app context \u5417\uff1f\"}\n  D2 --&gt;|\u662f| D3[\"\u8f6c\u5230 \u573a\u666fC\uff08ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\uff09\"]\n  D2 --&gt;|\u5426| D4[\"\u9ed8\u8ba4 AppContext\uff1a\u5148\u63a2\u6d4b GetClass(ctx=null)\\n\u518d\u904d\u5386 pfs_ \u6309 classId LoadClass\"]\n  D4 --&gt; D5[\"\u5b9a\u4f4d\uff1aruntime/class_linker_extension.cpp::AppContext::LoadClass\\n\u8bc1\u636e\uff1aFileNotes/runtime_class_linker_extension.cpp.md\"]\n\n  S --&gt; E{\"\u5f02\u5e38\u7c7b\u578b\u662f NCDFE\uff1f\"}\n  E --&gt;|\u662f| E1[\"\u5e38\u89c1\u542b\u4e49\uff1a\u5e95\u5c42\u66fe\u629b CNFE\uff0c\u4f46\u88ab Extension \u5305\u88c5\u4e3a NCDFE\\n\u5b9a\u4f4d\uff1aWrapClassNotFoundExceptionIfNeeded\\n\u8bc1\u636e\uff1aFileNotes/runtime_class_linker_extension.cpp.md\"]\n  E --&gt;|\u5426| E2[\"\u4ecd\u53ef\u80fd\u662f\u7eaf\u7cb9\u7684 CNFE/handler \u4e0a\u62a5\\n\u7ee7\u7eed\u6cbf GetClass/LoadClass \u8def\u5f84\u8ffd\u67e5\"]\n\n  S --&gt; F{\"\u662f\u5426\u662f link/verify/oom \u7b49\u201c\u975e\u627e\u4e0d\u5230\u201d\u9519\u8bef\uff1f\"}\n  F --&gt;|\u662f| F1[\"\u539f\u56e0\uff1aLoadClass \u5185\u90e8\u5931\u8d25\uff08\u5faa\u73af\u4f9d\u8d56/\u591a\u5b9e\u73b0/\u5206\u914d\u5931\u8d25/\u9a8c\u8bc1\u5931\u8d25\uff09\\n\u4f18\u5148\u8bfb\uff1aFileNotes/runtime_class_linker.cpp.md\uff08LoadClass \u9519\u8bef\u8def\u5f84\uff09\"]\n  F --&gt;|\u5426| F2[\"\u6309\u4e0a\u9762 boot/app \u5206\u652f\u7ee7\u7eed\u6536\u655b\"]</code></pre>"},{"location":"03_ClassLoading/#b","title":"\u573a\u666f B \u6392\u969c\uff1a\u63a5\u53e3\u6d3e\u53d1/\u9ed8\u8ba4\u65b9\u6cd5/\u51b2\u7a81\uff08\u51b3\u7b56\u6811\uff09","text":"<pre><code>flowchart TD\n  S[\"\u75c7\u72b6/\u65e5\u5fd7\uff1a\u63a5\u53e3\u6d3e\u53d1\u5f02\u5e38\\n- MULTIPLE_IMPLEMENT\\n- default interface method \u51b2\u7a81\\n- IMT \u69fd\u547d\u4e2d\u4e3a\u7a7a/FREE SLOT\\n- \u8c03\u7528\u8d70\u6162\u8def\u5f84\uff08itable\uff09\u5bfc\u81f4\u6027\u80fd\u5dee\"] --&gt; A{\"\u4f60\u770b\u5230\u7684\u4e3b\u8981\u4fe1\u53f7\u662f\u4ec0\u4e48\uff1f\"}\n\n  A --&gt;|MULTIPLE_IMPLEMENT| B1[\"\u539f\u56e0\uff1a\u540c\u4e00\u4e2a\u63a5\u53e3\u65b9\u6cd5\u51fa\u73b0\u591a\u4e2a\u5b9e\u73b0\u5019\u9009\\n(ETS resolve \u6216 vtable override \u51b2\u7a81)\"]\n  B1 --&gt; B2[\"\u5b9a\u4f4d\u4f18\u5148\uff1aEtsITableBuilder::Resolve/FindMethodInVTable\\n\u8bc1\u636e\uff1aFileNotes/plugins_ets_runtime_ets_itable_builder.cpp.md\"]\n  B1 --&gt; B3[\"\u8865\u5145\uff1avtable builder \u51b2\u7a81\u7b56\u7565/\u9ed8\u8ba4\u65b9\u6cd5\u51b2\u7a81\\n\u8bc1\u636e\uff1aFileNotes/runtime_include_vtable_builder_variance-inl.h.md\"]\n\n  A --&gt;|IMT \u4e3a\u7a7a / imtSize==0| C1[\"\u539f\u56e0\uff1a\u63a5\u53e3\u65b9\u6cd5\u603b\u6570\u8fc7\u5927 \u2192 IMT \u7981\u7528\\n\u6216 abstract/interface \u7c7b\u4e0d\u586b IMT\"]\n  C1 --&gt; C2[\"\u5b9a\u4f4d\uff1aIMTableBuilder::Build/UpdateClass\\n\u8bc1\u636e\uff1aFileNotes/runtime_imtable_builder.cpp.md\"]\n  C1 --&gt; C3[\"\u7ed3\u8bba\uff1aIMT \u53ea\u662f\u52a0\u901f\u7ed3\u6784\uff0c\u5fc5\u987b\u56de\u9000 itable \u6d3e\u53d1\"]\n\n  A --&gt;|IMT \u69fd\u51b2\u7a81| D1[\"\u539f\u56e0\uff1a\u4e0d\u540c\u63a5\u53e3\u65b9\u6cd5 hash \u5230\u540c\u4e00\u69fd\\n\u7b56\u7565\uff1a\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff0c\u5e76\u6807\u8bb0 conflict\uff08\u540e\u7eed\u4e0d\u518d\u5c1d\u8bd5\u8be5\u69fd\uff09\"]\n  D1 --&gt; D2[\"\u5b9a\u4f4d\uff1aIMTableBuilder::AddMethod/UpdateClass\\n\u8bc1\u636e\uff1aFileNotes/runtime_imtable_builder.cpp.md\"]\n\n  A --&gt;|\u9ed8\u8ba4\u65b9\u6cd5\u884c\u4e3a\u4e0d\u7b26\u5408\u9884\u671f| E1[\"\u539f\u56e0\uff1adefault interface methods \u53ef\u80fd\u88ab\u590d\u5236\u4e3a copied methods\\n\u5e76\u7528 stub/\u51b2\u7a81 stub \u8868\u8fbe\"]\n  E1 --&gt; E2[\"\u5b9a\u4f4d\uff1aVTableBuilder/CopiedMethod + ClassLinker::SetupCopiedMethods\\n\u8bc1\u636e\uff1aFileNotes/runtime_class_linker.cpp.md\uff08LoadMethods/SetupCopiedMethods \u6bb5\uff09\"]\n\n  A --&gt;|\u53ea\u662f\u6027\u80fd\u6162\uff08\u63a5\u53e3\u8c03\u7528\u9891\u7e41\uff09| F1[\"\u5148\u786e\u8ba4\uff1aIMT \u662f\u5426\u542f\u7528\u4e14\u547d\u4e2d\u7387\u5982\u4f55\\n\u5176\u6b21\u770b\uff1a\u63a5\u53e3\u65b9\u6cd5\u6570\u91cf\u4e0e\u51b2\u7a81\u69fd\u6bd4\u4f8b\"]\n  F1 --&gt; F2[\"\u5efa\u8bae\u8bfb\uff1aDataStructures/ITable_and_IMT.md + Flows/Builders_and_LinkMethods.md\"]</code></pre>"},{"location":"03_ClassLoading/#c-ets-app-context-nativemanaged","title":"\u573a\u666f C \u6392\u969c\uff1aETS app context \u52a0\u8f7d\uff08native/managed \u4e24\u6bb5\u5f0f\uff09\uff08\u51b3\u7b56\u6811\uff09","text":"<pre><code>flowchart TD\n  S[\"\u75c7\u72b6/\u65e5\u5fd7\uff1aETS \u7c7b\u52a0\u8f7d\u5f02\u5e38\\n- \u5728 app context \u627e\u4e0d\u5230\u7c7b\\n- native \u94fe\u5f0f\u67e5\u627e\u5931\u8d25\\n- \u4e0d\u5141\u8bb8\u8fdb\u5165 managed \u56de\u9000\\n- managed loadClass \u89e6\u53d1\u5f02\u5e38\"] --&gt; A{\"\u5f53\u524d\u7ebf\u7a0b/\u534f\u7a0b\u72b6\u6001\uff1f\"}\n\n  A --&gt;|\u975e managed \u7ebf\u7a0b / \u65e0 coroutine| B1[\"\u89c4\u5219\uff1a\u7981\u6b62\u8fdb\u5165 managed \u56de\u9000\uff08\u907f\u514d VM \u5185\u90e8\u7ebf\u7a0b re-enter managed\uff09\"]\n  B1 --&gt; B2[\"\u7ed3\u679c\uff1a\u53ea\u80fd\u8d70 native \u94fe\u5f0f\u67e5\u627e\uff0c\u5931\u8d25\u5219 CLASS_NOT_FOUND\\n\u5b9a\u4f4d\uff1aEtsClassLinkerContext::LoadClass\\n\u8bc1\u636e\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_context.cpp.md\"]\n\n  A --&gt;|managed \u7ebf\u7a0b\uff08\u6709 coroutine\uff09| C1[\"\u5141\u8bb8\uff1anative \u4f18\u5148\uff0c\u5fc5\u8981\u65f6\u8c03\u7528 managed RuntimeLinker.loadClass(final)\"]\n  C1 --&gt; C2{\"native \u94fe\u5f0f\u67e5\u627e\u7ed3\u679c\uff1f\"}\n  C2 --&gt;|\u627e\u5230\u7c7b| R1[\"\u8fd4\u56de Class*\uff08\u65e0\u9700\u8fdb\u5165 managed\uff09\"]\n  C2 --&gt;|\u9519\u8bef\u2260CLASS_NOT_FOUND| C3[\"\u4f20\u64ad\u9519\u8bef\uff08\u8bf4\u660e\u52a0\u8f7d\u8fc7\u7a0b\u51fa\u9519\uff09\\n\u5b9a\u4f4d\uff1aDecoratorErrorHandler \u903b\u8f91\"]\n  C2 --&gt;|\u4ec5 CLASS_NOT_FOUND| C4[\"\u8fdb\u5165 managed \u56de\u9000\uff1aRuntimeLinker.loadClass(final)\"]\n  C4 --&gt; C5{\"managed \u56de\u9000\u7ed3\u679c\uff1f\"}\n  C5 --&gt;|\u8fd4\u56de class object| R2[\"\u8f6c\u4e3a runtime Class* \u8fd4\u56de\"]\n  C5 --&gt;|\u629b\u5f02\u5e38/\u8fd4\u56de\u7a7a| R3[\"\u4e0a\u62a5 CLASS_NOT_FOUND\\n\u5efa\u8bae\u68c0\u67e5\uff1a\u8be5 context \u7684 AbcFiles/panda files \u5217\u8868\u662f\u5426\u5305\u542b\u76ee\u6807\u7c7b\"]\n\n  S --&gt; D{\"\u4f60\u6000\u7591\u662f\u201c\u6587\u4ef6/\u4e0a\u4e0b\u6587\u4e0d\u5bf9\u201d\uff1f\"}\n  D --&gt;|\u662f| D1[\"\u68c0\u67e5\uff1aEtsAbcRuntimeLinker \u7684 AbcFiles \u662f\u5426\u679a\u4e3e\u5230\\n\u5b9a\u4f4d\uff1aEnumeratePandaFilesImpl/FindAndLoadClass\\n\u8bc1\u636e\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_context.cpp.md\"]\n  D --&gt;|\u5426| D2[\"\u6309\u7ebf\u7a0b\u72b6\u6001\u4e0e\u94fe\u5f0f\u67e5\u627e/managed \u56de\u9000\u5206\u652f\u6536\u655b\"]</code></pre>"},{"location":"03_ClassLoading/#3","title":"3) \u672f\u8bed\u901f\u67e5\uff08\u5efa\u8bae\u6253\u5f00\u5728\u4fa7\u8fb9\uff09","text":"<ul> <li>FileNotes/_Glossary\uff1a\u672c\u7ae0\u672f\u8bed\u89e3\u91ca\uff08descriptor\u3001PandaFile\u3001EntityId\u3001Context\u3001roots\u3001ITable/IMT\u3001CNFE/NCDFE\u2026\uff09</li> </ul>"},{"location":"03_ClassLoading/#4","title":"4) \u65b0\u4eba\u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff08\u72ec\u7acb\u6587\u6863\uff09","text":"<ul> <li>Newbie_MinDebug_Playbook\uff1a\u65b0\u4eba 10 \u5206\u949f\u5b9a\u4f4d \u627e\u4e0d\u5230\u7c7b / CNFE vs NCDFE / IMT \u51b2\u7a81\u4e0e\u7981\u7528 / ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d gate / .abc/.an \u88c5\u8f7d \u7684\u6700\u77ed\u8def\u5f84\uff08\u542b\u53ef\u590d\u73b0\u5b9e\u9a8c\uff09</li> <li>\u66f4\u5f3a\u4ea4\u4ed8\u6807\u51c6\u5165\u53e3\uff1aPlaybook \u5185\u542b\u201c\u65e5\u5fd7\u5173\u952e\u8bcd \u2192 \u7b2c\u4e00\u843d\u70b9\u51fd\u6570 \u2192 \u5fc5\u67e5\u5206\u652f\u6761\u4ef6 \u2192 \u7b2c\u4e8c\u843d\u70b9\u201d\u7684\u75c7\u72b6\u77e9\u9635\uff08\u89c1 Newbie_MinDebug_Playbook \u7684 2.1 \u8282\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/#_2","title":"\u672c\u7ae0\u4ea7\u7269\u5bfc\u822a\uff08\u5efa\u8bae\u5148\u770b\u8fd9\u4e9b\u201c\u603b\u89c8\u578b\u201d\u6587\u6863\uff09","text":"<ul> <li>\u5b66\u4e60\u8def\u7ebf\u56fe\uff1aIndex\uff0830 \u5206\u949f/2 \u5c0f\u65f6/1 \u5929\u4e09\u6863\uff09</li> <li>\u672c\u7ae0\u6c89\u6dc0\uff1a</li> <li>DataStructures/Index\uff1a\u5173\u952e\u6570\u636e\u7ed3\u6784\u5361\u7247\uff08Class/Method/Field/ITable/IMT/Contexts/ETS\uff09</li> <li>Flows/Index\uff1a\u6309\u8c03\u7528\u94fe\u7ec4\u7ec7\u7684\u6d41\u7a0b\u8bb2\u89e3\uff08\u6bcf\u6761 flow \u90fd\u53ef\u76f4\u63a5\u590d\u7528\u5230\u6392\u969c/\u5206\u4eab\uff09</li> <li>Diagrams/Index\uff1a\u53ef\u590d\u7528 Mermaid \u56fe\uff08README \u91cc\u5d4c\u4e86\u4e3b\u56fe\uff0c\u8fd9\u91cc\u662f\u5355\u6587\u4ef6\u7248\u672c\uff09</li> <li>\u9010\u884c\u8bc1\u636e\u94fe\uff1a<code>FileNotes/</code>\uff08\u5f53\u4f60\u9700\u8981\u201c\u4e3a\u4ec0\u4e48\u4e00\u5b9a\u662f\u8fd9\u6837\u201d\u65f6\u518d\u4e0b\u6f5c\uff09</li> <li>\u9636\u6bb5\u4e00\u6821\u6b63\uff1aErrata_to_Stage1</li> <li>\u7ae0\u8282\u5b8c\u5de5\u5ba1\u67e5\uff08\u4ea4\u4ed8\u9a8c\u6536\uff09\uff1aCompletion_Review\uff08\u9010\u65ad\u8a00\u6838\u9a8c + \u6e90\u7801\u8bc1\u636e\u70b9 + \u53ef\u6267\u884c\u4f18\u5316\u9879\uff09</li> </ul>"},{"location":"03_ClassLoading/#_3","title":"\u7ae0\u8282\u603b\u89c8\uff1a\u7ec4\u4ef6\u8fb9\u754c\u4e0e\u6570\u636e\u6d41","text":"<p>\u4e0b\u9762\u8fd9\u5f20\u56fe\u628a 03 \u7ae0\u6d89\u53ca\u7684\u6838\u5fc3\u7ec4\u4ef6\u4e32\u8d77\u6765\uff08\u201c\u8bed\u8a00\u65e0\u5173\u7ba1\u7ebf\u201d\u4e0e\u201c\u8bed\u8a00\u76f8\u5173\u63d2\u4ef6\u201d\u5206\u5c42\uff09\uff1a</p> <pre><code>flowchart TD\n  subgraph RuntimeCore[\"Runtime\uff08\u8bed\u8a00\u65e0\u5173\uff09\"]\n    CL[\"ClassLinker\\n(GetClass/LoadClass/BuildClass)\"]\n    CLC[\"ClassLinkerContext\\n(descriptor-&gt;Class, per-Class mutex, roots)\"]\n    CDA[\"panda_file::ClassDataAccessor\\n(Method/Field/Proto/Code)\"]\n    VTB[\"VTableBuilder\\n(\u9ed8\u8ba4\u65b9\u6cd5/\u8986\u76d6/\u51b2\u7a81)\"]\n    ITB[\"ITableBuilder\\n(\u63a5\u53e3\u8868\u6784\u5efa/Resolve/\u5199\u56de)\"]\n    IMTB[\"IMTableBuilder\\n(IMT \u89c4\u6a21\u7b56\u7565 + \u586b\u8868/\u51b2\u7a81)\"]\n    Layout[\"LayoutFields\\n(offset/\u5bf9\u9f50/\u57fa\u7c7bpadding)\"]\n  end\n\n  subgraph ETS[\"ETS \u63d2\u4ef6\uff08\u8bed\u8a00\u76f8\u5173\uff09\"]\n    LC[\"EtsLanguageContext\\n(Create*Builder/CreateExtension/CreateVM/CreateGC)\"]\n    EXT[\"EtsClassLinkerExtension\\n(roots\u81ea\u4e3e/managed&lt;-&gt;runtime Class\u7ed1\u5b9a/native entrypoint)\"]\n    ECTX[\"EtsClassLinkerContext\\n(RuntimeLinker\u94fe\u5f0f\u52a0\u8f7d: native-&gt;managed)\"]\n    EITB[\"EtsITableBuilder\\n(\u7ebf\u6027\u5316 + vtable\u9a71\u52a8resolve)\"]\n    EVTB[\"EtsVTableBuilder\\n(ETS override/\u51b2\u7a81\u7b56\u7565)\"]\n  end\n\n  CDA --&gt; CL\n  CL --&gt;|\"\u4f7f\u7528\"| VTB\n  CL --&gt;|\"\u4f7f\u7528\"| ITB\n  CL --&gt;|\"\u4f7f\u7528\"| IMTB\n  CL --&gt;|\"\u4f7f\u7528\"| Layout\n  CL --&gt;|\"\u63d2\u5165/\u67e5\u627e\"| CLC\n\n  LC --&gt;|\"\u521b\u5efa\"| EVTB\n  LC --&gt;|\"\u521b\u5efa\"| EITB\n  LC --&gt;|\"\u521b\u5efa\"| EXT\n  EXT --&gt;|\"\u521b\u5efa/\u7ba1\u7406\"| ECTX\n  EXT --&gt;|\"\u63d0\u4f9b\u9519\u8bef\u5904\u7406/entrypoint\"| CL\n  ECTX --&gt;|\"\u975eboot: LoadClass\"| CL</code></pre>"},{"location":"03_ClassLoading/#mermaid","title":"\u5173\u952e\u6d41\u7a0b\uff08Mermaid\uff0c\u53ef\u590d\u5236\u590d\u7528\uff09\u2014\u2014\u770b\u56fe\u5148\u5efa\u7acb\u76f4\u89c9","text":""},{"location":"03_ClassLoading/#1-getclassdescriptor-boot-vs-app","title":"1) <code>GetClass(descriptor)</code> \u51b3\u7b56\u6811\uff08boot vs app\uff09","text":"<pre><code>flowchart TD\n  A[\"GetClass(descriptor, context)\"] --&gt; B{\"context \u5185\u5df2\u52a0\u8f7d\uff1f\\nFindLoadedClass\"}\n  B --&gt;|\u662f| R1[\"\u8fd4\u56de\u5df2\u52a0\u8f7d Class*\"]\n  B --&gt;|\u5426| C{\"descriptor \u7c7b\u578b\uff1f\"}\n  C --&gt;|union| U[\"LoadUnionClass\\n(\u9700\u8981 commonContext)\"] --&gt; R2[\"\u8fd4\u56de/\u7f13\u5b58/\u63d2\u5165context\"]\n  C --&gt;|array| AR[\"LoadArrayClass\\n(componentContext \u51b3\u5b9a\u63d2\u5165\u57df)\"] --&gt; R2\n  C --&gt;|\u666e\u901a| D{\"IsBootContext?\"}\n  D --&gt;|\u662f| F{\"Boot BloomFilter\\nPossiblyContains?\"}\n  F --&gt;|\"\u5426(IMPOSSIBLY_HAS)\"| R0[\"\u8fd4\u56de nullptr\\n(\u53ef\u4e0a\u62a5 CLASS_NOT_FOUND)\"]\n  F --&gt;|\u662f| G[\"\u5728 bootPandaFiles_ \u67e5 classId\"] --&gt; H{\"\u627e\u5230?\"}\n  H --&gt;|\u5426| R3[\"\u4e0a\u62a5 CLASS_NOT_FOUND\\n\u8fd4\u56de nullptr\"]\n  H --&gt;|\u662f| I[\"LoadClass(pf,classId,context)\"] --&gt; J[\"InsertClass \u5e76\u53d1\u53bb\u91cd\\n(\u51b2\u7a81\u5219\u56de\u6536\u65b0\u5bf9\u8c61)\"] --&gt; R4[\"\u8fd4\u56de Class*\"]\n  D --&gt;|\u5426| K[\"context-&gt;LoadClass()\\n(\u865a\u51fd\u6570/ETS \u7279\u5316)\"] --&gt; R4</code></pre>"},{"location":"03_ClassLoading/#2-loadclass-builder-layout-link","title":"2) <code>LoadClass</code> \u4e3b\u7ba1\u7ebf\uff08builder + layout + link\uff09","text":"<pre><code>flowchart TD\n  S[\"LoadClass(ClassDataAccessor, descriptor, base, interfaces, context, ext)\"] --&gt; I1[\"SetupClassInfo\\nCreate{ITable,VTable,IMTable}Builder\\n\u8ba1\u7b97 class size + numSfields\"]\n  I1 --&gt; I2[\"ext-&gt;CreateClass\\n(ETS: \u5206\u914d NonMovable EtsClass + \u7ed1\u5b9a runtime Class)\"]\n  I2 --&gt; I3[\"\u586b\u5143\u4fe1\u606f\\n(base/interfaces/fileId/pf/accessFlags/indexes)\\n\u5199\u5165 counts(vmethods/copied/sfields)\"]\n  I3 --&gt; I4[\"LoadMethods\\n(+copied methods)\\n\u8bbe\u7f6e entrypoint: C2I/native/AOT/stub\"]\n  I4 --&gt; I5[\"LoadFields\\n\u521b\u5efa Field \u6570\u7ec4\uff08type \u7f16\u7801\u5728 accessFlags\uff09\"]\n  I5 --&gt; I6[\"LinkMethods\\nvtable.UpdateClass\\nitable.Resolve+UpdateClass\\nimtable.UpdateClass\"]\n  I6 --&gt; I7[\"LinkFields\\nLayoutFields(static/instance)\\n\u5199 offset/refFields* / objectSize\"]\n  I7 --&gt; I8[\"(addToRuntime)\\n\u901a\u77e5\u4e8b\u4ef6 ClassLoad/ClassPrepare\\nInsertClass \u5e76\u53d1\u53bb\u91cd\"]\n  I8 --&gt; R[\"\u8fd4\u56de Class* \u6216 nullptr\"]</code></pre>"},{"location":"03_ClassLoading/#21-insertclass","title":"2.1 \u4f60\u5fc5\u987b\u77e5\u9053\u7684\u5e76\u53d1\u73b0\u5b9e\uff1a\u53ef\u80fd\u201c\u91cd\u590d\u6784\u5efa\u201d\uff0c\u6700\u540e InsertClass \u53bb\u91cd","text":"<p>\u8fd9\u662f 03 \u7ae0\u6700\u5bb9\u6613\u88ab\u5ffd\u7565\u4f46\u6700\u5f71\u54cd\u6392\u969c\u7684\u70b9\uff1a\u540c\u4e00\u4e2a descriptor \u5728\u5e76\u53d1\u573a\u666f\u4e0b\u53ef\u80fd\u88ab\u591a\u4e2a\u7ebf\u7a0b\u5b8c\u6574\u6784\u5efa\uff0c\u6700\u540e\u624d\u5728 <code>InsertClass</code> \u5904\u51b3\u51fa\u80dc\u8d1f\uff1b\u540c\u7ebf\u7a0b\u9012\u5f52\u81ea\u6307\u4f9d\u8d56\u7528 <code>ClassLoadingSet</code> \u68c0\u6d4b\u5e76\u62a5 <code>CLASS_CIRCULARITY</code>\u3002</p> <ul> <li>Flow\uff08\u542b\u4e24\u7ebf\u7a0b\u65f6\u5e8f\u56fe + \u9012\u5f52\u52a0\u8f7d\u5224\u5b9a\uff09\uff1aFlows/Concurrency_and_ClassLock</li> </ul>"},{"location":"03_ClassLoading/#3-ets-etsclasslinkercontextloadclassnative-managed","title":"3) ETS <code>EtsClassLinkerContext::LoadClass</code>\uff08native \u4f18\u5148\uff0c\u5fc5\u8981\u65f6 managed\uff09","text":"<pre><code>flowchart TD\n  A[\"EtsClassLinkerContext::LoadClass(descriptor)\"] --&gt; B{\"\u672ccontext\u7f13\u5b58\u547d\u4e2d\uff1f\\nFindClass\"}\n  B --&gt;|\u662f| R1[\"\u8fd4\u56de Class*\"]\n  B --&gt;|\u5426| C[\"TryLoadingClassFromNative\\n(\u6cbf RuntimeLinker parent+shared libs \u94fe)\"]\n  C --&gt; D{\"\u94fe\u904d\u5386\u6210\u529f\uff1f\"}\n  D --&gt;|\u6210\u529f\u4e14\u627e\u5230/\u6709\u9519\u8bef| R2[\"\u8fd4\u56de Class* \u6216\u4f20\u64ad\u9519\u8bef\"]\n  D --&gt;|\"\u5931\u8d25(\u975e\u767d\u540d\u5355linker)\"| E{\"\u5f53\u524d\u7ebf\u7a0b\u53ef\u8c03\u7528 managed\uff1f\\n(coro &amp;&amp; IsManagedCode)\"}\n  E --&gt;|\u5426| R3[\"\u7981\u6b62\u8fdb\u5165 managed\\n\u4e0a\u62a5 CLASS_NOT_FOUND \u8fd4\u56de nullptr\"]\n  E --&gt;|\u662f| F[\"\u6784\u9020 args(runtimeLinker, etsClassName, nullptr)\\n\u8c03\u7528 managed RuntimeLinker.loadClass(final)\"]\n  F --&gt; G{\"\u6709\u5f02\u5e38\uff1f\"}\n  G --&gt;|\u65e0| R4[\"\u628a\u8fd4\u56de\u7684 class object \u8f6c\u4e3a Class* \u8fd4\u56de\"]\n  G --&gt;|\u6709| R5[\"\u4e0a\u62a5 CLASS_NOT_FOUND \u8fd4\u56de nullptr\"]</code></pre>"},{"location":"03_ClassLoading/#_4","title":"\u518d\u8865\u4e24\u5f20\u201c\u65b0\u624b\u6700\u9700\u8981\u201d\u7684\u56fe\uff08\u628a\u8fb9\u754c\u8bb2\u6e05\u695a\uff09","text":""},{"location":"03_ClassLoading/#4-bootappchained-context-dumpforsigquit","title":"4) Boot/App/Chained Context \u7684\u5173\u7cfb\uff08\u4ee5\u53ca DumpForSigQuit \u5982\u4f55\u8f93\u51fa\uff09","text":"<pre><code>flowchart TD\n  subgraph EXT[\"ClassLinkerExtension\uff08\u6bcf\u8bed\u8a00\u4e00\u4e2a\uff09\"]\n    Boot[\"BootContext\\n(boot panda files)\"]\n    App1[\"AppContext #1\\n(app panda files)\"]\n    App2[\"AppContext #2\\n(app panda files)\"]\n    Boot --&gt; App1\n    Boot --&gt; App2\n  end\n\n  subgraph ETSChain[\"ETS\uff1a\u94fe\u5f0f class loader\uff08\u793a\u610f\uff09\"]\n    L0[\"RuntimeLinker L0\\n(ctx0)\"] --&gt; L1[\"parent linker\\n(ctx1)\"]\n    L0 --&gt; LS[\"shared libs linker\\n(ctxS)\"]\n  end\n\n  Dump[\"Runtime::DumpForSigQuit\\nDump class loaders\"] --&gt; Enum[\"ClassLinker::EnumerateContextsForDump\"]\n  Enum --&gt; Boot\n  Enum --&gt; App1\n  Enum --&gt; App2\n  Enum --&gt; L0</code></pre> <p>\u76f4\u89c9\uff1aBootContext \u662f\u57fa\u7840\u53ef\u89c1\u57df\uff1bAppContext \u662f\u201c\u6bcf\u4e2a\u5e94\u7528/\u52a0\u8f7d\u5668\u4e00\u4efd\u201d\uff1bETS \u989d\u5916\u5f15\u5165\u201cparent/\u5171\u4eab\u5e93\u94fe\u201d\uff0c\u6240\u4ee5\u5b83\u7684 context \u5173\u7cfb\u4e0d\u662f\u4e00\u68f5\u7b80\u5355\u6811\u3002</p>"},{"location":"03_ClassLoading/#5-cnfe-vs-ncdfe","title":"5) \u201c\u627e\u4e0d\u5230\u7c7b\u201d\u5230\u5e95\u629b\u4ec0\u4e48\uff08CNFE vs NCDFE\uff09","text":"<pre><code>flowchart TD\n  A[\"GetClass(pf,id) / GetClass(descriptor) \u5931\u8d25\"] --&gt; B{\"\u7ebf\u7a0b\u662f\u5426\u6709 pending exception\uff1f\"}\n  B --&gt;|\u5426| R0[\"\u8fd4\u56de nullptr / \u4ea4\u7ed9 errorHandler\"]\n  B --&gt;|\u662f| C{\"pending exception \u662f CNFE\uff1f\"}\n  C --&gt;|\u5426| R1[\"\u4fdd\u6301\u539f\u5f02\u5e38\"]\n  C --&gt;|\u662f| D[\"WrapClassNotFoundExceptionIfNeeded\"]\n  D --&gt; E[\"\u629b NoClassDefFoundError(NCDFE)\\n(\u66f4\u504f\u201c\u94fe\u63a5\u5931\u8d25/\u5b9a\u4e49\u4e0d\u53ef\u7528\u201d)\"]</code></pre> <p>\u8fd9\u4e2a\u884c\u4e3a\u5728 Stage2 \u5df2\u9010\u884c\u95ed\u73af\uff1a\u89c1 FileNotes/runtime_class_linker_extension.cpp\uff08WrapClassNotFoundExceptionIfNeeded\uff09\u3002</p>"},{"location":"03_ClassLoading/#datastructures-flows-diagrams","title":"DataStructures / Flows / Diagrams\uff08\u672c\u7ae0\u6c89\u6dc0\u4ea7\u7269\uff09","text":"<ul> <li>DataStructures\uff1a\u5173\u952e\u7ed3\u6784\u5361\u7247\uff08\u5b57\u6bb5\u542b\u4e49 + \u5173\u952e\u4e0d\u53d8\u91cf + \u4e0e FileNotes \u7684\u5bf9\u9f50\uff09</li> <li>\u89c1 DataStructures/Index</li> <li>Flows\uff1a\u6309\u201c\u8c03\u7528\u94fe\u201d\u7ec4\u7ec7\u7684\u6d41\u7a0b\u8bb2\u89e3\uff08\u6bcf\u6761\u6d41\u7a0b\u90fd\u56de\u94fe\u5230\u5b9e\u73b0\uff09</li> <li>\u89c1 Flows/Index</li> <li>Diagrams\uff1a\u53ef\u590d\u7528 Mermaid \u56fe\uff08README \u4e2d\u4e5f\u5d4c\u5165\u4e86\u6838\u5fc3\u56fe\uff09</li> <li>\u89c1 Diagrams/Index</li> </ul>"},{"location":"03_ClassLoading/#_5","title":"\u8bc1\u636e\u94fe\uff08\u4ece\u603b\u8ff0\u8df3\u5230\u9010\u884c\uff09","text":"<p>\u672c\u7ae0\u6240\u6709\u7ed3\u8bba\u90fd\u5e94\u80fd\u56de\u6eaf\u5230\u9010\u884c\u7b14\u8bb0\uff1a - ClassLinker \u4e3b\u7ba1\u7ebf\uff1aFileNotes/runtime_class_linker.cpp - ClassLinkerExtension \u9ed8\u8ba4\u884c\u4e3a\uff08Boot/AppContext LoadClass / new|created|obsolete classes\uff09\uff1aFileNotes/runtime_class_linker_extension.cpp - Core roots \u81ea\u4e3e\uff08PANDA_ASSEMBLY\uff09\uff1aFileNotes/runtime_core_core_class_linker_extension.cpp - \u5b57\u6bb5\u5e03\u5c40\u4e0e offset \u5199\u5165\uff1a\u540c\u4e0a\uff08LayoutFields \u6bb5\uff09+ FileNotes/runtime_include_field.h - Method entrypoint/\u7f16\u8bd1\u72b6\u6001\u4f4d\u6bb5\uff1aFileNotes/runtime_include_method.h - IMT \u7b56\u7565\uff1aFileNotes/runtime_imtable_builder.cpp - ETS itable resolve\uff1aFileNotes/plugins_ets_runtime_ets_itable_builder.cpp - ETS Context \u94fe\u5f0f\u52a0\u8f7d\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_context.cpp - ETS Extension roots/entrypoint\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp - ETS fa\u00e7ade\uff08\u5bf9\u5916 API + async \u6ce8\u89e3\u89e3\u6790\uff09\uff1aFileNotes/plugins_ets_runtime_ets_class_linker.cpp</p>"},{"location":"03_ClassLoading/Completion_Review/","title":"03_ClassLoading \u7ae0\u8282\u5b8c\u5de5\u5ba1\u67e5\uff08VM \u67b6\u6784\u5e08\u9a8c\u6536\uff09","text":"<p>\u5ba1\u67e5\u76ee\u6807\uff1a\u628a 03 \u7ae0\u4ea4\u4ed8\u4e3a\u201c\u65b0\u4eba\u53ef\u76f4\u63a5\u6392\u969c + \u67b6\u6784\u65ad\u8a00\u53ef\u8ffd\u6eaf\u5230\u6e90\u7801\u201d\u7684\u7a33\u5b9a\u6587\u6863\u96c6\u3002 \u5ba1\u67e5\u65b9\u6cd5\uff08\u590d\u7528 04 \u7ae0\u7ecf\u9a8c\uff09\uff1a\u89c1 ../00_Methodology_Wiki_Review_Checklist\uff08\u5355\u4e00\u810a\u67f1\u56fe\u5165\u53e3 \u2192 Flow \u62c6\u94fe\u8def \u2192 DataStructures \u62bd\u4e0d\u53d8\u91cf \u2192 FileNotes \u7ed9\u8bc1\u636e\u94fe \u2192 \u6700\u5c0f\u8c03\u8bd5\u624b\u518c\u7ed9\u53ef\u590d\u73b0\u5b9e\u9a8c \u2192 \u9010\u65ad\u8a00\u56de\u6e90\u7801\u6838\u9a8c \u2192 \u51fa\u5177\u5b8c\u5de5\u5ba1\u67e5\u62a5\u544a\uff09\u3002</p>"},{"location":"03_ClassLoading/Completion_Review/#0","title":"0) \u5ba1\u67e5\u8303\u56f4","text":"<ul> <li>Stage2 \u5165\u53e3\uff1aREADME\u3001Index</li> <li>Flows\uff1a<code>Flows/*</code></li> <li>DataStructures\uff1a<code>DataStructures/*</code></li> <li>\u65b0\u4eba\u6700\u5c0f\u6392\u969c\uff1aNewbie_MinDebug_Playbook</li> <li>\u9010\u884c\u8bc1\u636e\u94fe\uff1a<code>FileNotes/*</code>\uff08\u4ee5 <code>Manifests/files.yaml</code> \u4e3a\u51c6\uff09</li> <li>Stage1 \u6821\u6b63\uff1aErrata_to_Stage1</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#1","title":"1) \u7ed3\u8bba\u6982\u89c8","text":"<ul> <li>\u6b63\u786e\u6027\uff08P0 \u65ad\u8a00\uff09\uff1a03 \u7ae0\u7684\u6838\u5fc3\u65ad\u8a00\uff08GetClass \u51b3\u7b56\u6811\u3001LoadClass \u4e3b\u7ba1\u7ebf\u3001builders/layout/link \u987a\u5e8f\u3001Context \u5e76\u53d1\u53bb\u91cd\u3001ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u3001CNFE\u2192NCDFE \u5305\u88c5\uff09\u90fd\u80fd\u56de\u5230\u6e90\u7801\u6838\u9a8c\uff0c\u7ed3\u8bba\u603b\u4f53 \u53ef\u9760\u3002</li> <li>\u53ef\u7528\u6027\uff08\u65b0\u4eba\u8def\u5f84\uff09\uff1aREADME/Index \u5df2\u5177\u5907\u201c\u573a\u666f\u9a71\u52a8\u201d\u7684\u5b66\u4e60\u4e0e\u6392\u969c\u8def\u7ebf\uff1b\u672c\u8f6e\u8865\u9f50\u4e86\uff1a</li> <li>Flows/ClassLoading_EndToEnd\uff1a\u5355\u4e00\u7aef\u5230\u7aef\u810a\u67f1\u56fe\u5165\u53e3</li> <li>Newbie_MinDebug_Playbook\uff1a\u53ef\u590d\u73b0\u7684\u6700\u5c0f\u8c03\u8bd5\u624b\u518c</li> <li>\u4ecd\u53ef\u4f18\u5316\uff1a</li> <li>\u628a\u5c11\u91cf\u201c\u63cf\u8ff0\u6027\u7ed3\u8bba\u201d\u8fdb\u4e00\u6b65\u6539\u6210\u201c\u6761\u4ef6\u77e9\u9635\u201d\uff08\u89e6\u53d1\u6761\u4ef6\u2192\u7b2c\u4e00\u843d\u70b9\u2192\u7b2c\u4e8c\u843d\u70b9\u2192\u5fc5\u770b\u65e5\u5fd7\uff09</li> <li>\u5728\u201c\u52a0\u8f7d\u2194\u521d\u59cb\u5316\u201d\u7684\u8de8\u7ae0\u4ea4\u754c\u5904\u52a0\u66f4\u663e\u5f0f\u4e92\u94fe\uff0803\u219204\uff09</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#2-p0","title":"2) P0 \u65ad\u8a00\u6838\u9a8c\u6e05\u5355\uff08\u5e26\u6e90\u7801\u8bc1\u636e\u70b9\uff09","text":""},{"location":"03_ClassLoading/Completion_Review/#21-getclass-boot-vs-app","title":"2.1 GetClass \u51b3\u7b56\u6811\uff08boot vs app\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/class_linker.cpp</code>\u3001<code>runtime/class_linker_extension.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>FindLoadedClass</code> \u7f13\u5b58\u547d\u4e2d\u4f18\u5148</li> <li>union/array descriptor \u7684\u7279\u5224\u8def\u5f84</li> <li>boot context\uff1abloom filter gate\uff08PossiblyContains\uff09+ boot panda files \u67e5 classId</li> <li>app context\uff1a\u59d4\u6258 <code>context-&gt;LoadClass</code>\uff08ETS \u5728\u6b64\u7279\u5316\uff09</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#22-loadclass","title":"2.2 LoadClass \u4e3b\u7ba1\u7ebf\uff08\u521b\u5efa/\u586b\u5145/\u94fe\u63a5/\u5e03\u5c40/\u53bb\u91cd\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/class_linker.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>SetupClassInfo</code> \u521b\u5efa builders\uff0c\u5e76\u8ba1\u7b97 class size \u8f93\u5165</li> <li><code>ext-&gt;CreateClass</code> \u521b\u5efa <code>Class</code>\uff08ETS\uff1aNonMovable EtsClass + runtime Class \u7ed1\u5b9a\uff09</li> <li><code>LoadMethods/LoadFields</code> \u586b\u5145\u5143\u6570\u636e</li> <li><code>LinkMethods</code>\uff1avtable/itable/imtable \u7684\u6784\u5efa\u4e0e\u5199\u56de\u987a\u5e8f</li> <li><code>LinkFields</code>\uff1a<code>LayoutFields</code> \u5199 offset/objectSize/refFields*</li> <li><code>InsertClass</code>\uff1a\u5e76\u53d1\u53bb\u91cd\uff08\u51b2\u7a81\u56de\u6536\u65b0\u5bf9\u8c61\uff09</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#23-itableimt","title":"2.3 ITable/IMT \u4e0e\u51b2\u7a81\u7b56\u7565","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a</li> <li>core\uff1a<code>runtime/imtable_builder.cpp</code>\u3001<code>runtime/include/vtable_builder_*</code></li> <li>ETS\uff1a<code>plugins/ets/runtime/ets_itable_builder.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li>IMT \u53ef\u88ab\u7981\u7528\uff08\u4f8b\u5982\u65b9\u6cd5\u6570\u91cf\u7b56\u7565\u5bfc\u81f4 <code>imtSize==0</code>\uff09</li> <li>\u69fd\u51b2\u7a81\u7b56\u7565\uff08\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd/\u6807\u8bb0 conflict\uff09</li> <li>ETS resolve\uff08\u7ebf\u6027\u5316 + vtable \u9a71\u52a8 resolve\uff09</li> <li>vtable build \u5173\u952e\u6b65\u9aa4\uff08\u7ee7\u627f\u7236\u7c7b\u69fd + \u672c\u7c7b override \u5339\u914d + default interface -&gt; copied methods\uff09</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#24-ets-nativemanaged-gate","title":"2.4 ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\uff08native\u2192managed gate\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>plugins/ets/runtime/ets_class_linker_context.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li>native \u94fe\u5f0f\u904d\u5386 parent/shared-libs</li> <li>\u4ec5\u5f53\u7ebf\u7a0b\u6ee1\u8db3\u6761\u4ef6\uff08managed/coro\uff09\u624d\u5141\u8bb8\u8fdb\u5165 managed \u56de\u9000\uff08<code>RuntimeLinker.loadClass(final)</code>\uff09</li> <li>\u975e managed \u7ebf\u7a0b\u7981\u6b62\u56de\u9000\uff08\u907f\u514d VM \u5185\u90e8\u7ebf\u7a0b re-enter managed\uff09</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#25-cnfe-vs-ncdfe","title":"2.5 \u201c\u627e\u4e0d\u5230\u7c7b\u201d\u5f02\u5e38\u7c7b\u578b\uff08CNFE vs NCDFE\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/class_linker_extension.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>WrapClassNotFoundExceptionIfNeeded</code>\uff1aCNFE \u5728\u67d0\u4e9b\u60c5\u5883\u4e0b\u5305\u88c5\u4e3a NCDFE</li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#26-abcan-classlinkeraotmanager","title":"2.6 <code>.abc/.an</code> \u6587\u4ef6\u8fdb\u5165 ClassLinker/AotManager","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/file_manager.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>.abc</code> \u88c5\u8f7d\u5931\u8d25\u76f4\u63a5 <code>LOG(ERROR, PANDAFILE)</code></li> <li><code>enable-an</code> \u65f6\u5c1d\u8bd5 <code>.an</code> \u4f34\u968f <code>TryLoadAnFileForLocation</code></li> </ul>"},{"location":"03_ClassLoading/Completion_Review/#3","title":"3) \u6587\u6863\u4ea4\u4ed8\u5f62\u6001\u9a8c\u6536\uff08\u6458\u8981\uff09","text":"<ul> <li>README\uff1a\u573a\u666f\u51b3\u7b56\u6811\u4e0e\u4e3b\u6d41\u7a0b\u56fe\u5b8c\u6574\uff1b\u5efa\u8bae\u628a\u201c\u7aef\u5230\u7aef\u810a\u67f1\u56fe/\u6700\u5c0f\u8c03\u8bd5\u624b\u518c/\u5b8c\u5de5\u5ba1\u67e5\u201d\u4f5c\u4e3a\u663e\u6027\u5165\u53e3\u6302\u5728\u5bfc\u822a\u533a\u3002</li> <li><code>Flows/*</code>\uff1a\u8986\u76d6 GetClass/LoadClass\u3001builders/link\u3001layout/link\u3001ETS \u4e24\u6bb5\u5f0f\u3001FileManager \u8f93\u5165\u94fe\uff1b\u5df2\u7edf\u4e00\u8865\u9f50\u201c0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e/\u4e0b\u4e00\u6b65\u201d\u5bfc\u822a\uff08\u540e\u7eed\u65b0\u589e flow \u8bf7\u4fdd\u6301\u8be5\u683c\u5f0f\uff09\u3002</li> <li><code>DataStructures/*</code>\uff1a\u5361\u7247\u7ed3\u6784\u6e05\u6670\uff1b\u5df2\u8865\u9f50\u201c0) \u4f4d\u7f6e/\u4e0b\u4e00\u6b65\u201d\u5e76\u5728\u5173\u952e\u5361\u7247\u589e\u52a0 03\u219204 \u4ea4\u754c\u4e92\u94fe\uff08\u4ecd\u5efa\u8bae\u540e\u7eed\u628a InitializeClass/ \u7684\u8de8\u7ae0\u8854\u63a5\u505a\u6210\u66f4\u663e\u6027\u7684\u5355\u72ec\u5c0f\u8282\uff09\u3002"},{"location":"03_ClassLoading/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"03_ClassLoading/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>Stage1 \u7b2c 03 \u7ae0\u201c\u8bed\u8a00\u6269\u5c55\u5b9e\u73b0\u6587\u4ef6/\u5165\u53e3\u201d\u5217\u8868\u4e0d\u5b8c\u6574\uff08\u9700\u8981\u8865\u9f50\u8bc1\u636e\u94fe\uff09\uff1a</li> <li>\u95ee\u9898\uff1aStage1 \u91cd\u70b9\u63cf\u8ff0\u4e86 <code>ClassLinker</code>\u3001<code>ClassLinkerExtension</code> \u62bd\u8c61\u4e0e ETS \u63d2\u4ef6\uff0c\u4f46\u6ca1\u6709\u628a\u4ee5\u4e0b 4 \u4e2a\u201c\u5b9e\u9645\u5165\u53e3/\u9ed8\u8ba4\u5b9e\u73b0\u201d\u6587\u4ef6\u7eb3\u5165\u5173\u952e\u8bc1\u636e\u94fe\uff0c\u5bfc\u81f4\u8bfb\u8005\u5f88\u96be\u4ece Stage1 \u76f4\u63a5\u5b9a\u4f4d\u5230\u201croots \u81ea\u4e3e/\u9ed8\u8ba4 AppContext LoadClass/ETS fa\u00e7ade\u201d\u7684\u5b9e\u73b0\u843d\u70b9\u3002</li> <li>\u4f9d\u636e\uff08\u5b9e\u73b0\u843d\u70b9\uff09\uff1a<ul> <li><code>runtime/class_linker_extension.cpp</code>\uff1aBoot/AppContext \u7684\u9ed8\u8ba4 <code>LoadClass</code> \u7b56\u7565\u3001<code>created/new/obsolete classes</code> \u5bb9\u5668\u8bed\u4e49\u3001\u4ee5\u53ca CNFE\u2192NCDFE \u7684\u5f02\u5e38\u5305\u88c5\uff08\u6309 <code>pf,id</code> \u53d6\u7c7b\u5931\u8d25\u65f6\uff09\u3002</li> <li><code>runtime/core/core_class_linker_extension.cpp</code>\uff1acore\uff08PANDA_ASSEMBLY\uff09\u8bed\u8a00\u7684 roots \u81ea\u4e3e\u5b9e\u73b0\uff08primitive/array/synthetic\uff09\uff0c\u4ee5\u53ca String \u5b50\u7c7b\u5728 roots \u9636\u6bb5\u5199\u5165 GC ref-fields \u5143\u6570\u636e \u4e0e <code>CreateClass</code> \u7684 NonMovable \u5206\u914d+managed/runtime \u7ed1\u5b9a\u3002</li> <li><code>plugins/ets/runtime/ets_class_linker.h</code> / <code>plugins/ets/runtime/ets_class_linker.cpp</code>\uff1aETS \u5bf9\u5916 fa\u00e7ade\uff08\u628a <code>Class*</code> \u8bed\u4e49\u5305\u88c5\u6210 <code>EtsClass*</code>\uff09\uff0c\u5e76\u5305\u542b async \u6ce8\u89e3 \u2192 impl method \u7684\u89e3\u6790\u94fe\u8def\u4e0e\u5f02\u5e38\u8bed\u4e49\u3002</li> </ul> </li> <li>\u5904\u7406\uff1aStage2 \u5df2\u5c06\u4e0a\u8ff0\u6587\u4ef6\u7eb3\u5165 <code>03_ClassLoading/Manifests/files.yaml</code> \u5e76\u8865\u9f50\u9010\u884c <code>FileNotes/</code>\uff1b\u540c\u65f6\u5df2\u56de\u5199\u4fee\u6b63 Stage1 \u7684 03_Class_Loading_and_Linking\uff0c\u628a\u8fd9\u4e9b\u6587\u4ef6\u4f5c\u4e3a\u201c\u8bed\u8a00\u6269\u5c55\u5b9e\u73b0/\u5165\u53e3\u201d\u7684\u5fc5\u8bfb\u843d\u70b9\u8865\u5145\u8fdb\u53bb\u3002</li> </ul>"},{"location":"03_ClassLoading/Index/","title":"03_ClassLoading - Index","text":""},{"location":"03_ClassLoading/Index/#index","title":"\u8fd9\u4efd Index \u7684\u7528\u6cd5\uff08\u9762\u5411\u65b0\u540c\u5b66\uff09","text":"<p>\u4f60\u53ef\u4ee5\u628a\u5b83\u5f53\u6210\u201c\u5b66\u4e60\u8def\u7ebf\u56fe\u201d\u800c\u4e0d\u662f\u6587\u4ef6\u6e05\u5355\uff1a - \u53ea\u60f3 30 \u5206\u949f\u770b\u61c2\u5927\u6982\uff1a\u8d70\u300c30min \u8def\u7ebf\u300d\u2014\u2014\u770b\u56fe + \u770b\u4e3b\u7ebf\u6545\u4e8b\uff0c\u4e0d\u4e0b\u6f5c\u9010\u884c - \u8981\u80fd\u6392\u67e5\u5e38\u89c1\u95ee\u9898\uff08\u627e\u4e0d\u5230\u7c7b/\u63a5\u53e3\u6d3e\u53d1/ETS loader\uff09\uff1a\u8d70\u300c2h \u8def\u7ebf\u300d - \u8981\u80fd\u4fee\u6539\u4ee3\u7801\u6216\u5b9a\u4f4d\u590d\u6742 bug\uff1a\u8d70\u300c1d \u8def\u7ebf\u300d\u2014\u2014\u518d\u4e0b\u6f5c <code>FileNotes/</code></p> <p>\u5efa\u8bae\u540c\u65f6\u6253\u5f00\uff1a - FileNotes/_Glossary\uff08\u672f\u8bed\u901f\u67e5\uff09 - README\uff08\u672c\u7ae0\u6545\u4e8b\u7ebf + \u5173\u952e\u6d41\u7a0b\u56fe\uff09 - Flows/ClassLoading_EndToEnd\uff08\u7aef\u5230\u7aef\u810a\u67f1\u56fe\uff1a\u65b0\u4eba 0 \u53f7\u5165\u53e3\uff09 - Newbie_MinDebug_Playbook\uff08\u65b0\u4eba\u53ef\u590d\u73b0\u6392\u969c\u624b\u518c\uff09</p>"},{"location":"03_ClassLoading/Index/#30min-filenotes","title":"30min \u8def\u7ebf\uff1a\u5efa\u7acb\u6574\u4f53\u6a21\u578b\uff08\u4e0d\u8bfb FileNotes \u4e5f\u80fd\u61c2\uff09","text":"<ol> <li>Flows/ClassLoading_EndToEnd\uff08\u7aef\u5230\u7aef\u810a\u67f1\u56fe\uff1a\u5148\u628a\u6574\u6761\u94fe\u8def\u4e32\u8d77\u6765\uff09</li> <li>README\uff08\u5148\u770b 5 \u5f20 Mermaid \u56fe\uff1a\u7ec4\u4ef6\u603b\u89c8\u3001GetClass\u3001LoadClass\u3001ETS LoadClass\u3001Context \u5173\u7cfb\uff09</li> <li>Diagrams/Index\uff08\u5982\u679c\u4f60\u60f3\u590d\u5236\u56fe\u5230\u5206\u4eab/\u8bbe\u8ba1\u6587\u6863\uff09</li> <li>Flows/Index\uff08\u770b\u6bcf\u6761\u8c03\u7528\u94fe\u7684\u201c\u5165\u53e3/\u51fa\u53e3/\u5173\u952e\u51b3\u7b56\u70b9\u201d\uff09</li> <li>DataStructures/Index\uff08\u53ea\u770b\u6bcf\u5f20\u5361\u7247\u201c\u5b83\u662f\u4ec0\u4e48/\u4e0d\u53d8\u91cf/\u8c01\u5199\u8c01\u8bfb\u201d\uff09</li> </ol>"},{"location":"03_ClassLoading/Index/#2h","title":"2h \u8def\u7ebf\uff1a\u80fd\u6392\u67e5\u95ee\u9898\uff08\u5efa\u8bae\u6309\u4f60\u9047\u5230\u7684\u573a\u666f\u9009\u8bfb\uff09","text":""},{"location":"03_ClassLoading/Index/#a-cnfe-vs-ncdfe","title":"\u573a\u666f A\uff1a\u627e\u4e0d\u5230\u7c7b / \u5f02\u5e38\u7c7b\u578b\u4e0d\u5bf9\uff08CNFE vs NCDFE\uff09","text":"<ul> <li>FileNotes/runtime_class_linker_extension.cpp\uff08WrapClassNotFoundExceptionIfNeeded + AppContext \u9ed8\u8ba4 LoadClass\uff09</li> <li>FileNotes/runtime_class_linker.cpp\uff08GetClass/LoadClass \u4e3b\u94fe\u8def\uff0c\u542b boot filter\uff09</li> <li>Flows/GetClass_and_LoadClass\uff08\u628a\u5165\u53e3\u3001\u5206\u652f\u3001\u56de\u9000\u7b56\u7565\u4e32\u8d77\u6765\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#b-multiple_implement-imt","title":"\u573a\u666f B\uff1a\u63a5\u53e3\u6d3e\u53d1 / \u9ed8\u8ba4\u65b9\u6cd5 / MULTIPLE_IMPLEMENT / IMT \u4e3a\u7a7a","text":"<ul> <li>DataStructures/ITable_and_IMT\uff08\u5148\u8bb0\u4f4f IMT \u662f\u201c\u53ef\u9009\u52a0\u901f\u7ed3\u6784\u201d\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_itable_builder.cpp\uff08ETS resolve \u7b56\u7565\u4e0e\u51b2\u7a81\uff09</li> <li>FileNotes/runtime_imtable_builder.cpp\uff08IMT size \u7b56\u7565 + \u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff09</li> <li>Flows/Builders_and_LinkMethods\uff08builder \u7684 Build/Resolve/UpdateClass \u987a\u5e8f\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#cets-native-managed","title":"\u573a\u666f C\uff1aETS \u5e94\u7528\u52a0\u8f7d\u5668\uff08native \u5148\u5c1d\u8bd5 / managed \u56de\u9000\u6761\u4ef6\uff09","text":"<ul> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp\uff08\u4e24\u6bb5\u5f0f\u52a0\u8f7d\u4e0e\u94fe\u5f0f\u904d\u5386\uff09</li> <li>Flows/ETS_Context_Native_vs_Managed_Load\uff08\u4e00\u5f20\u56fe\u89e3\u91ca\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5728\u975e managed \u7ebf\u7a0b\u56de\u9000\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#1d","title":"1d \u8def\u7ebf\uff1a\u4e0b\u6f5c\u9010\u884c\uff08\u6309\u4f9d\u8d56\u987a\u5e8f\uff0c\u4e0d\u5bb9\u6613\u8ff7\u8def\uff09","text":"<p>\u5efa\u8bae\u6309\u201c\u5148\u5143\u6570\u636e\u5951\u7ea6 \u2192 \u518d\u6d3e\u53d1\u8868/\u5e03\u5c40\u7b97\u6cd5 \u2192 \u518d ClassLinker \u7ba1\u7ebf \u2192 \u518d ETS \u63d2\u4ef6\u843d\u5730\u201d\u7684\u987a\u5e8f\u9605\u8bfb\uff1a</p>"},{"location":"03_ClassLoading/Index/#1","title":"1) \u5143\u6570\u636e\u5951\u7ea6\u4e0e\u5bf9\u8c61/\u6307\u9488\u6a21\u578b","text":"<ul> <li>FileNotes/runtime_include_class.h\uff08<code>runtime/include/class.h</code>\uff09</li> <li>FileNotes/runtime_include_class-inl.h\uff08<code>runtime/include/class-inl.h</code>\uff09</li> <li>FileNotes/runtime_include_method.h\uff08<code>runtime/include/method.h</code>\uff09</li> <li>FileNotes/runtime_include_field.h\uff08<code>runtime/include/field.h</code>\uff09</li> <li>FileNotes/runtime_include_itable.h\uff08<code>runtime/include/itable.h</code>\uff09</li> <li>FileNotes/runtime_include_class_helper.h\uff08<code>runtime/include/class_helper.h</code>\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#2-context-gc-roots-ets","title":"2) Context\uff1a\u7f13\u5b58\u3001\u5e76\u53d1\u534f\u8c03\u4e0e GC roots\uff08\u57fa\u7c7b\u4e0e ETS \u7279\u5316\uff09","text":"<ul> <li>FileNotes/runtime_class_linker_context.h\uff08<code>runtime/class_linker_context.h</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.h\uff08<code>plugins/ets/runtime/ets_class_linker_context.h</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp\uff08<code>plugins/ets/runtime/ets_class_linker_context.cpp</code>\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#3-vtable-itable-imt","title":"3) \u6d3e\u53d1\u8868\u6784\u5efa\uff1avtable / itable / imt\uff08\u542b\u51b2\u7a81\u7b56\u7565\uff09","text":"<ul> <li>FileNotes/runtime_include_vtable_builder_interface.h\uff08<code>runtime/include/vtable_builder_interface.h</code>\uff09</li> <li>FileNotes/runtime_include_vtable_builder_base.h\uff08<code>runtime/include/vtable_builder_base.h</code>\uff09</li> <li>FileNotes/runtime_include_vtable_builder_base-inl.h\uff08<code>runtime/include/vtable_builder_base-inl.h</code>\uff09</li> <li>FileNotes/runtime_include_vtable_builder_variance.h\uff08<code>runtime/include/vtable_builder_variance.h</code>\uff09</li> <li>FileNotes/runtime_include_vtable_builder_variance-inl.h\uff08<code>runtime/include/vtable_builder_variance-inl.h</code>\uff09</li> <li>FileNotes/runtime_include_itable_builder.h\uff08<code>runtime/include/itable_builder.h</code>\uff1a\u63a5\u53e3\u5951\u7ea6\uff09</li> <li>FileNotes/runtime_include_imtable_builder.h\uff08<code>runtime/include/imtable_builder.h</code>\uff1a\u63a5\u53e3\u5951\u7ea6\uff09</li> <li>FileNotes/runtime_imtable_builder.cpp\uff08<code>runtime/imtable_builder.cpp</code>\uff1aIMT \u6784\u5efa/\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_itable_builder.h\uff08<code>plugins/ets/runtime/ets_itable_builder.h</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_itable_builder.cpp\uff08<code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff1aETS itable \u7ebf\u6027\u5316 + vtable \u9a71\u52a8 resolve\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#4-classlinker","title":"4) ClassLinker \u4e3b\u7ba1\u7ebf\uff1a\u52a0\u8f7d/\u94fe\u63a5/\u5e03\u5c40/\u7f13\u5b58/\u8fc7\u6ee4","text":"<ul> <li>FileNotes/runtime_include_class_linker.h\uff08<code>runtime/include/class_linker.h</code>\uff1aAPI \u4e0e\u5185\u90e8\u7ba1\u7ebf\u5206\u89e3\uff09</li> <li>FileNotes/runtime_class_linker.cpp\uff08<code>runtime/class_linker.cpp</code>\uff1a\u5b8c\u6574\u5b9e\u73b0\u95ed\u73af\uff0c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09</li> <li>FileNotes/runtime_include_class_linker_extension.h\uff08<code>runtime/include/class_linker_extension.h</code>\uff1aextension \u62bd\u8c61 + roots/contexts/new roots\uff09</li> <li>FileNotes/runtime_class_linker_extension.cpp\uff08<code>runtime/class_linker_extension.cpp</code>\uff1aBoot/AppContext \u9ed8\u8ba4 LoadClass + new/obsolete/created classes \u5bb9\u5668\u8bed\u4e49\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#5-corepanda_assembly-extension-roots","title":"5) Core\uff08PANDA_ASSEMBLY\uff09\uff1a\u9ed8\u8ba4\u8bed\u8a00 Extension \u7684 roots \u81ea\u4e3e\u5b9e\u73b0","text":"<ul> <li>FileNotes/runtime_core_core_class_linker_extension.cpp\uff08<code>runtime/core/core_class_linker_extension.cpp</code>\uff1aprimitive/array/synthetic roots + String \u5b50\u7c7b GC \u5143\u6570\u636e + CreateClass\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#6-etslanguagecontextextensionfacade","title":"6) ETS\uff1aLanguageContext/Extension/Facade \u7684\u843d\u5730\uff08\u628a\u7b56\u7565\u53d8\u6210\u5b9e\u73b0\uff09","text":"<ul> <li>FileNotes/plugins_ets_runtime_ets_language_context.h\uff08<code>plugins/ets/runtime/ets_language_context.h</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_language_context.cpp\uff08<code>plugins/ets/runtime/ets_language_context.cpp</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_extension.h\uff08<code>plugins/ets/runtime/ets_class_linker_extension.h</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp\uff08<code>plugins/ets/runtime/ets_class_linker_extension.cpp</code>\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker.h\uff08<code>plugins/ets/runtime/ets_class_linker.h</code>\uff1aETS fa\u00e7ade API\uff09</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker.cpp\uff08<code>plugins/ets/runtime/ets_class_linker.cpp</code>\uff1aETS fa\u00e7ade + async \u6ce8\u89e3\u89e3\u6790\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#7-classlinkeraotabcan","title":"7) \u6587\u4ef6\u52a0\u8f7d\u5230 ClassLinker/AOT\uff1a.abc/.an","text":"<ul> <li>FileNotes/runtime_include_file_manager.h\uff08<code>runtime/include/file_manager.h</code>\uff09</li> <li>FileNotes/runtime_file_manager.cpp\uff08<code>runtime/file_manager.cpp</code>\uff09</li> </ul>"},{"location":"03_ClassLoading/Index/#_1","title":"\u9605\u8bfb\u63d0\u793a\uff08\u907f\u514d\u65b0\u624b\u5e38\u89c1\u8bef\u89e3\uff09","text":"<ul> <li>IMT \u4e0d\u662f\u5fc5\u7136\u5b58\u5728\uff1a\u63a5\u53e3\u65b9\u6cd5\u8fc7\u591a\u4f1a\u76f4\u63a5 <code>imtSize=0</code>\uff0c\u6d3e\u53d1\u56de\u9000\u5230 itable\uff08\u89c1 FileNotes/runtime_imtable_builder.cpp\uff09\u3002</li> <li>\u201c\u52a0\u8f7d\u201d\u4e0e\u201c\u521d\u59cb\u5316\u201d\u662f\u4e24\u4ef6\u4e8b\uff1aLoadClass \u521b\u5efa\u5e76\u94fe\u63a5 <code>Class/Method/Field</code>\uff0cInitializeClass \u624d\u89e6\u53d1 <code>&lt;clinit&gt;</code>/\u8bed\u8a00\u4fa7\u521d\u59cb\u5316\uff08\u672c\u7ae0\u8986\u76d6\u63a5\u53e3\u70b9\uff1b\u6267\u884c\u7ec6\u8282\u5728 04/\u6267\u884c\u5f15\u64ce\u4e0e 06/\u9a8c\u8bc1\u7b49\u7ae0\u8282\u4f1a\u66f4\u6df1\u5165\uff09\u3002</li> <li>Context \u51b3\u5b9a\u201c\u53ef\u89c1\u57df\u201d\uff1a\u540c\u540d descriptor \u5728\u4e0d\u540c context \u53ef\u4ee5\u6709\u4e0d\u540c\u7684 <code>Class*</code>\uff1bETS \u8fd8\u6709 parent/shared libs \u94fe\uff08\u89c1 README \u7684 Context \u56fe\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/","title":"03_ClassLoading\uff1a\u65b0\u4eba\u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff08\u53ef\u590d\u73b0 + \u53ef\u843d\u5730\uff09","text":"<p>\u76ee\u6807\uff1a\u65b0\u4eba\u5728 10 \u5206\u949f\u5185\u628a\u201c\u627e\u4e0d\u5230\u7c7b/\u63a5\u53e3\u6d3e\u53d1\u51b2\u7a81/ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u5931\u8d25\u201d\u5b9a\u4f4d\u5230\u7b2c\u4e00\u843d\u70b9\u4e0e\u7b2c\u4e8c\u843d\u70b9\uff0c\u5e76\u80fd\u7528\u65e5\u5fd7/\u6700\u5c0f\u5b9e\u9a8c\u590d\u73b0\u4e0e\u9a8c\u8bc1\u3002</p>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#0","title":"0) \u5feb\u901f\u76ee\u5f55\uff08\u76f4\u63a5\u70b9\uff09","text":"<ul> <li>\u7aef\u5230\u7aef\u4e3b\u7ebf\uff1aFlows/ClassLoading_EndToEnd</li> <li>\u4e09\u5927\u573a\u666f\u51b3\u7b56\u6811\uff08README \u91cc\u4e09\u5f20\uff09\uff1aREADME \u7684 \u573a\u666f A/B/C</li> <li>GetClass/LoadClass \u4e3b\u94fe\uff1aFlows/GetClass_and_LoadClass</li> <li>ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\uff1aFlows/ETS_Context_Native_vs_Managed_Load</li> <li><code>.abc/.an</code> \u88c5\u8f7d\uff1aFlows/FileManager_ABC_AN</li> </ul>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#1-90","title":"1) \u5148\u628a\u65e5\u5fd7\u5f00\u5bf9\uff0890% \u7684\u65b0\u624b\u95ee\u9898\u5728\u8fd9\u91cc\uff09","text":"<p>\u65e5\u5fd7\u9009\u9879\u6765\u81ea <code>libarkbase/utils/logger_options.yaml</code>\uff08\u6ce8\u610f\uff1aruntime/options.yaml \u91cc\u65e7\u7684 log \u9009\u9879\u5df2\u4e0d\u63a8\u8350\u4f7f\u7528\uff09\u3002</p>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#11","title":"1.1 \u5e38\u7528\u7ec4\u5408\uff08\u5efa\u8bae\u76f4\u63a5\u590d\u5236\uff09","text":"<ul> <li>\u53ea\u770b\u7c7b\u52a0\u8f7d\uff08\u6700\u5e38\u7528\uff09\uff1a</li> <li><code>--log-level=debug</code></li> <li><code>--log-components=classlinker</code></li> <li>\u518d\u52a0\u4e0a\u6587\u4ef6\u88c5\u8f7d\uff08.abc/.an\uff09\uff1a</li> <li><code>--log-level=debug</code></li> <li><code>--log-components=classlinker:pandafile:aot</code></li> <li>\u6000\u7591\u4e0e\u6267\u884c\u5f15\u64ce/\u521d\u59cb\u5316\u4ea4\u754c\uff08\u8de8\u7ae0\uff09\uff1a</li> <li><code>--log-level=debug</code></li> <li><code>--log-components=classlinker:interpreter:runtime</code></li> </ul> <p>\u8bc1\u636e\uff1a\u6e90\u7801\u4e2d\u7c7b\u52a0\u8f7d\u76f8\u5173\u65e5\u5fd7\u5927\u91cf\u4f7f\u7528 <code>LOG(*, CLASS_LINKER)</code>\uff08\u4f8b\u5982 <code>runtime/class_linker.cpp</code>\u3001<code>runtime/class_linker_extension.cpp</code>\uff09\uff0c\u6587\u4ef6\u88c5\u8f7d\u4f7f\u7528 <code>LOG(*, PANDAFILE)</code>\uff08<code>runtime/file_manager.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#2","title":"2) \u201c\u75c7\u72b6 \u2192 \u7b2c\u4e00\u843d\u70b9 \u2192 \u7b2c\u4e8c\u843d\u70b9\u201d\uff08\u65b0\u4eba\u6700\u5feb\u8def\u7ebf\uff09","text":"\u75c7\u72b6/\u65e5\u5fd7 \u7b2c\u4e00\u843d\u70b9\uff08\u4f18\u5148\u770b\uff09 \u7b2c\u4e8c\u843d\u70b9\uff08\u9700\u8981\u786c\u8bc1\u636e\u65f6\uff09 <code>Cannot find class '&lt;descriptor&gt;'</code> / <code>CLASS_NOT_FOUND</code> <code>runtime/class_linker.cpp</code>\uff08GetClass \u2192 FindClassInBootPandaFiles \u2192 LoadClass\uff09 FileNotes/runtime_class_linker.cpp\uff08boot filter/\u9519\u8bef\u8def\u5f84/InsertClass \u5e76\u53d1\u53bb\u91cd\uff09 CNFE / NCDFE \u5f02\u5e38\u7c7b\u578b\u4e0d\u7b26\u5408\u9884\u671f <code>runtime/class_linker_extension.cpp</code>\uff08WrapClassNotFoundExceptionIfNeeded\uff09 FileNotes/runtime_class_linker_extension.cpp\uff08CNFE\u2192NCDFE \u5305\u88c5\u7b56\u7565\uff09 boot \u542f\u52a8\u671f\u7c7b\u627e\u4e0d\u5230 Flows/FileManager_ABC_AN\uff08boot panda files \u6ce8\u518c\uff09 <code>runtime/file_manager.cpp</code>\uff08LoadAbcFile\uff09+ <code>runtime/class_linker.cpp</code>\uff08boot filter Add/Lookup\uff09 <code>MULTIPLE_IMPLEMENT</code> / default interface method \u51b2\u7a81 <code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff08Resolve/\u51b2\u7a81\u5224\u5b9a\uff09 <code>runtime/include/vtable_builder_*</code> + <code>runtime/imtable_builder.cpp</code>\uff08\u51b2\u7a81\u7b56\u7565/IMT \u884c\u4e3a\uff09 IMT \u4e3a\u7a7a / itable \u56de\u9000\u5bfc\u81f4\u6027\u80fd\u5dee <code>runtime/imtable_builder.cpp</code>\uff08imtSize \u7b56\u7565 + UpdateClass\uff09 DataStructures/ITable_and_IMT + Flows/Builders_and_LinkMethods default interface method \u770b\u8d77\u6765\u201c\u51ed\u7a7a\u51fa\u73b0\u4e00\u5806 copied methods\u201d <code>runtime/include/vtable_builder_base-inl.h</code>\uff08AddDefaultInterfaceMethods\uff09 Flows/Builders_and_LinkMethods\uff08vtable build \u7b97\u6cd5\u56fe + copied methods \u89e3\u91ca\uff09 \u8c03\u8bd5\u65f6 <code>Class*-&gt;GetVTable()</code>/IMT \u8bfb\u51fa\u6765\u50cf\u201c\u4e71\u6307\u9488/\u8d8a\u754c\u201d <code>runtime/include/coretypes/class.h</code>\uff08InitClass placement new + GetSize\uff09 DataStructures/Class\uff08\u53d8\u957f\u5bf9\u8c61\u5c3e\u968f\u5e03\u5c40\u56fe + \u8bc1\u636e\u94fe\uff09 \u540c\u4e00\u7c7b\u52a0\u8f7d\u201c\u5076\u73b0\u91cd\u590d\u521b\u5efa/\u91cd\u590d FreeClass/prepare \u987a\u5e8f\u4e0d\u7a33\u5b9a\u201d <code>runtime/class_linker.cpp::LoadClass(... addToRuntime)</code>\uff08InsertClass \u51b2\u7a81\u56de\u6536\uff09 Flows/Concurrency_and_ClassLock\uff08\u5e76\u53d1\u53bb\u91cd\u771f\u5b9e\u6a21\u578b\uff09 \u62a5 <code>CLASS_CIRCULARITY</code>\uff08\u81ea\u5df1\u7684\u7236\u7c7b/\u7236\u63a5\u53e3\uff09 <code>runtime/class_linker.cpp::TryInsertClassLoading</code> Flows/Concurrency_and_ClassLock\uff08thread_local ClassLoadingSet\uff09 ETS app context \u201c\u4e0d\u5141\u8bb8\u56de\u9000\u5230 managed\u201d <code>plugins/ets/runtime/ets_class_linker_context.cpp</code>\uff08\u7ebf\u7a0b\u72b6\u6001 gate\uff1acoro/managed\uff09 Flows/ETS_Context_Native_vs_Managed_Load\uff08\u4e3a\u4ec0\u4e48\u8981\u7981\uff09"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#21","title":"2.1 \u66f4\u5f3a\u4ea4\u4ed8\u6807\u51c6\uff1a\u75c7\u72b6\u77e9\u9635\uff08\u65e5\u5fd7\u5173\u952e\u8bcd \u2192 \u7b2c\u4e00\u843d\u70b9\u51fd\u6570 \u2192 \u5fc5\u67e5\u5206\u652f\u6761\u4ef6 \u2192 \u7b2c\u4e8c\u843d\u70b9\uff09","text":"<p>\u4f7f\u7528\u65b9\u5f0f\uff1a\u5148\u5728\u65e5\u5fd7\u91cc\u5339\u914d\u5173\u952e\u8bcd\uff0c\u7136\u540e\u76f4\u63a5\u8df3\u5230\u201c\u7b2c\u4e00\u843d\u70b9\u51fd\u6570\u201d\u91cc\u6838\u5bf9\u201c\u5fc5\u67e5\u5206\u652f\u6761\u4ef6\u201d\u3002 \u76ee\u6807\uff1a\u628a\u201c\u731c\u6d4b\u5f0f\u6392\u969c\u201d\u53d8\u6210\u201c\u5206\u652f\u9a71\u52a8\u6392\u969c\u201d\u3002</p> \u75c7\u72b6/\u65e5\u5fd7\u5173\u952e\u8bcd\uff08\u6293\u5173\u952e\u5b57\u5373\u53ef\uff09 \u7b2c\u4e00\u843d\u70b9\u51fd\u6570\uff08\u6e90\u7801\uff09 \u5fc5\u67e5\u5206\u652f\u6761\u4ef6\uff08\u4f60\u8981\u9a8c\u8bc1\u7684 if/\u72b6\u6001\uff09 \u7b2c\u4e8c\u843d\u70b9\uff08\u8bc1\u636e/\u56fe\uff09 <code>Cannot find class ... in boot class bloom filter</code> <code>runtime/class_linker.cpp::LookupInFilter</code> <code>Runtime::GetOptions().IsUseBootClassFilter()==true</code> \u4e14 <code>bootClassFilter_.PossiblyContains(descriptor)==false</code> \u4e14 <code>errorHandler!=nullptr</code> Flows/GetClass_and_LoadClass\uff08BootFilter \u8bed\u4e49\uff09+ FileNotes/runtime_class_linker.cpp <code>Cannot find class ... in boot panda files:</code> <code>runtime/class_linker.cpp::GetClass(descriptor, bootCtx)</code> <code>LookupInFilter!=IMPOSSIBLY_HAS</code> \u4e14 <code>FindClassInPandaFiles</code> \u627e\u4e0d\u5230 <code>classId</code> \u540c\u4e0a <code>Cannot find class ... in all app panda files</code> <code>runtime/class_linker_extension.cpp::AppContext::LoadClass</code> \u904d\u5386 app panda files \u540e\u4ecd\u627e\u4e0d\u5230 classId\uff08\u901a\u5e38\u610f\u5473\u7740\u201c\u6587\u4ef6\u672a\u6ce8\u518c/\u4e0a\u4e0b\u6587\u4e0d\u5bf9\u201d\uff09 FileNotes/runtime_class_linker_extension.cpp\uff08AppContext LoadClass\uff09 <code>Class or interface \"&lt;X&gt;\" is its own superclass or superinterface</code> / <code>CLASS_CIRCULARITY</code> <code>runtime/class_linker.cpp::TryInsertClassLoading</code> <code>threadLocalSet-&gt;insert(key).second == false</code>\uff08\u540c\u7ebf\u7a0b\u9012\u5f52\u81ea\u6307\uff09 Flows/Concurrency_and_ClassLock\uff08ClassLoadingSet \u5224\u5b9a\u6811\uff09 <code>Method overrides final method</code> / <code>OVERRIDES_FINAL</code> <code>runtime/include/vtable_builder_*::ProcessClassMethod</code> base \u69fd\u6ee1\u8db3 override \u6761\u4ef6\u4e14 <code>itInfo-&gt;IsFinal()==true</code> Flows/Builders_and_LinkMethods\uff08override \u51b3\u7b56\u6811\uff09 <code>MULTIPLE_IMPLEMENT</code>\uff08\u6216 \u201cConflicting default implementations\u201d\uff09 <code>runtime/include/vtable_builder_variance-inl.h</code> \u6216 <code>plugins/ets/runtime/ets_itable_builder.cpp</code> vtable/default method \u51b3\u7b56\u6811\u5bfc\u81f4\u51b2\u7a81\uff0c\u6216 ETS resolve \u5728 vtable \u4e2d\u627e\u5230\u591a\u4e2a\u5b9e\u73b0\u5019\u9009 Flows/Builders_and_LinkMethods\uff08copied/default \u51b3\u7b56\u6811\uff09+ DataStructures/ITable_and_IMT <code>Language specific initialization for class '&lt;descriptor&gt;' failed</code> <code>runtime/class_linker.cpp::LoadClass(... addToRuntime)</code> <code>ext-&gt;CanInitializeClasses()==true</code> \u4e14 <code>ext-&gt;InitializeClass(klass)==false</code> Flows/ClassLoading_EndToEnd\uff08\u52a0\u8f7d\u2194\u521d\u59cb\u5316\u4ea4\u754c\uff09 <code>Cannot layout static fields ...</code> / <code>Cannot layout instance fields ...</code> <code>runtime/class_linker.cpp::LinkFields</code> \u2192 <code>LayoutFields</code> <code>LayoutFields(..., isStatic)==false</code> \u6216 <code>LayoutFields(..., !isStatic)==false</code> Flows/LayoutFields_and_LinkFields\uff08\u5e03\u5c40\u7b97\u6cd5\u56fe\uff09"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#3","title":"3) \u4e09\u4e2a\u6700\u5c0f\u5b9e\u9a8c\uff08\u5f3a\u70c8\u5efa\u8bae\u65b0\u4eba\u505a\u4e00\u904d\uff09","text":""},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#1-boot-app","title":"\u5b9e\u9a8c 1\uff1a\u590d\u73b0\u201c\u627e\u4e0d\u5230\u7c7b\u201d\uff08\u9a8c\u8bc1\u4f60\u8d70\u5230\u7684\u662f boot \u8fd8\u662f app\uff09","text":"<ul> <li>\u64cd\u4f5c\uff1a\u9009\u62e9\u4e00\u4e2a\u4f60\u786e\u4fe1\u5b58\u5728/\u4e0d\u5b58\u5728\u7684 descriptor\uff0c\u5206\u522b\u5728 boot \u4e0e app \u60c5\u51b5\u4e0b\u89e6\u53d1\u4e00\u6b21 <code>GetClass</code>\u3002</li> <li>\u65e5\u5fd7\uff1a</li> <li><code>--log-level=debug --log-components=classlinker:pandafile</code></li> <li>\u89c2\u6d4b\u70b9\uff1a</li> <li>\u662f\u5426\u8d70 <code>BootContext</code> \u5206\u652f\uff08boot filter / boot panda files\uff09</li> <li>\u662f\u5426\u8d70 <code>AppContext::LoadClass</code>\uff08\u6216 ETS context \u7684 <code>LoadClass</code>\uff09</li> <li>\u5173\u952e\u65e5\u5fd7\u5173\u952e\u8bcd\uff08\u7528\u4e8e\u5feb\u901f\u5224\u5206\u652f\uff09\uff1a</li> <li>boot filter \u5feb\u901f\u5426\u5b9a\uff1a<code>Cannot find class ... in boot class bloom filter</code></li> <li>boot files \u67e5\u4e0d\u5230\uff1a<code>Cannot find class ... in boot panda files:</code></li> <li>app files \u67e5\u4e0d\u5230\uff1a<code>Cannot find class ... in all app panda files</code></li> <li>\u5173\u952e\u51fd\u6570\uff1a</li> <li>boot\uff1a<code>ClassLinker::GetClass</code> \u2192 <code>LookupInFilter</code> \u2192 <code>FindClassInPandaFiles</code></li> <li>app\uff1a<code>AppContext::LoadClass</code>\uff08\u9ed8\u8ba4\u5b9e\u73b0\uff09/ <code>EtsClassLinkerContext::LoadClass</code>\uff08ETS \u7279\u5316\uff09</li> <li>\u7b2c\u4e00\u843d\u70b9\uff1aFlows/GetClass_and_LoadClass</li> <li>\u7b2c\u4e8c\u843d\u70b9\uff1aFileNotes/runtime_class_linker.cpp\u3001FileNotes/runtime_class_linker_extension.cpp</li> </ul>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#2-ets-gate","title":"\u5b9e\u9a8c 2\uff1a\u590d\u73b0 ETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d gate\uff08\u9a8c\u8bc1\u201c\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u56de\u9000\u201d\uff09","text":"<ul> <li>\u64cd\u4f5c\uff1a\u5728 ETS app context \u4e0b\u89e6\u53d1\u4e00\u6b21 class load\uff1a</li> <li>\u5728\u201c\u975e managed \u7ebf\u7a0b/\u65e0 coroutine\u201d\u89e6\u53d1\uff08\u5e94\u7981\u6b62 managed \u56de\u9000\uff09</li> <li>\u5728\u201cmanaged \u7ebf\u7a0b\uff08\u6709 coroutine\uff09\u201d\u89e6\u53d1\uff08\u5141\u8bb8 managed \u56de\u9000\uff09</li> <li>\u65e5\u5fd7\uff1a</li> <li><code>--log-level=debug --log-components=classlinker</code></li> <li>\u89c2\u6d4b\u70b9\uff1a</li> <li>native \u94fe\u5f0f\u67e5\u627e\u662f\u5426\u904d\u5386 parent/shared-libs</li> <li>\u662f\u5426\u8fdb\u5165 <code>RuntimeLinker.loadClass(final)</code> managed \u56de\u9000</li> <li>\u5173\u952e\u51fd\u6570/\u6761\u4ef6\uff1a</li> <li>gate\uff1a<code>EtsCoroutine::GetCurrent()==nullptr || !coro-&gt;IsManagedCode()</code> \u2192 \u7981\u6b62\u56de\u9000</li> <li>\u767d\u540d\u5355 linker\uff1a<code>coreAbcRuntimeLinker/coreMemoryRuntimeLinker</code>\uff08\u5426\u5219\u76f4\u63a5\u8981\u6c42\u8d70 managed\uff09</li> <li>\u7b2c\u4e00\u843d\u70b9\uff1aFlows/ETS_Context_Native_vs_Managed_Load</li> <li>\u7b2c\u4e8c\u843d\u70b9\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_context.cpp</li> </ul>"},{"location":"03_ClassLoading/Newbie_MinDebug_Playbook/#3multiple_implement-imt","title":"\u5b9e\u9a8c 3\uff1a\u590d\u73b0\u63a5\u53e3\u6d3e\u53d1\u51b2\u7a81\uff08MULTIPLE_IMPLEMENT / IMT \u51b2\u7a81\uff09","text":"<ul> <li>\u64cd\u4f5c\uff1a\u6784\u9020\u4e00\u4e2a\u6700\u5c0f\u7528\u4f8b\uff1a</li> <li>\u4e24\u4e2a interface \u4ea7\u751f\u540c\u540d\u540c\u7b7e\u540d\u9ed8\u8ba4\u65b9\u6cd5 / \u591a\u5b9e\u73b0\u51b2\u7a81\uff08\u6216\u8ba9\u63a5\u53e3\u65b9\u6cd5\u603b\u6570\u8d85\u8fc7 IMT \u7b56\u7565\u9608\u503c\uff09</li> <li>\u65e5\u5fd7\uff1a</li> <li><code>--log-level=debug --log-components=classlinker</code></li> <li>\u89c2\u6d4b\u70b9\uff1a</li> <li>vtable/itable/imt \u7684 build/resolve/update \u987a\u5e8f</li> <li>\u51b2\u7a81\u7b56\u7565\u662f\u5426\u201c\u6e05\u7a7a IMT \u69fd/\u7981\u7528 IMT\u201d</li> <li>\u5173\u952e\u843d\u5730\u6548\u679c\uff1a</li> <li>copied default method \u7684 <code>Status</code> \u4f1a\u5728 <code>ClassLinker::SetupCopiedMethods</code> \u8f6c\u4e3a\u4e0d\u540c stub entrypoint\uff08ABSTRACT/CONFLICT\uff09</li> <li>\u7b2c\u4e00\u843d\u70b9\uff1aFlows/Builders_and_LinkMethods</li> <li>\u7b2c\u4e8c\u843d\u70b9\uff1aFileNotes/runtime_imtable_builder.cpp\u3001FileNotes/plugins_ets_runtime_ets_itable_builder.cpp</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/","title":"Class\uff08\u8fd0\u884c\u65f6\u7c7b\u5143\u6570\u636e\u5bf9\u8c61\uff09","text":""},{"location":"03_ClassLoading/DataStructures/Class/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201c\u4e3b\u7ba1\u7ebf\uff1aLoadClass\u201d\u6846\uff1b\u4ee5\u53ca\u540e\u7eed\u521d\u59cb\u5316\u4ea4\u754c\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>Class</code> \u662f\u8fd0\u884c\u65f6\u5bf9\u201c\u4e00\u4e2a\u7c7b\u578b\u201d\u7684\u5143\u6570\u636e\u5bf9\u8c61\uff1a\u5b83\u5305\u542b\u7ee7\u627f\u5173\u7cfb\u3001\u63a5\u53e3\u4fe1\u606f\u3001\u5b57\u6bb5/\u65b9\u6cd5\u6570\u7ec4\uff0c\u4ee5\u53ca vtable/itable/IMT \u7b49\u6d3e\u53d1\u8868\u3002\u5b83\u672c\u8eab\u4e5f\u662f\u4e00\u4e2a managed object\uff08\u6709 class object \u5f62\u6001\uff09\uff0c\u4e0d\u540c\u8bed\u8a00\u901a\u8fc7 <code>ClassLinkerExtension::FromClassObject</code> \u505a\u6620\u5c04\u3002</p>"},{"location":"03_ClassLoading/DataStructures/Class/#1-umlclass-mermaid-classdiagram","title":"1) UML\uff1aClass \u7ed3\u6784\uff08Mermaid classDiagram\uff09","text":"<p>\u8bf4\u660e\uff1a\u8fd9\u662f\u201c\u8bfb\u4ee3\u7801/\u6392\u969c\u9700\u8981\u7684\u4e3b\u5e72\u5b57\u6bb5\u201d\uff0c\u4e0d\u662f\u628a <code>class.h</code> \u5168\u90e8\u5b57\u6bb5\u7a77\u4e3e\uff1b\u91cd\u70b9\u7a81\u51fa\u6d3e\u53d1\u8868\u3001\u5bb9\u5668\u5206\u533a\u3001\u52a0\u8f7d\u57df\u3001\u72b6\u6001\u673a\u3002</p> <pre><code>classDiagram\n  class BaseClass {\n    +GetSourceLang()\n    +GetObjectSize()\n    +GetManagedObject()\n    -uint32 flags_\n    -uint32 objectSize_\n    -ObjectHeader* managedObject_\n    -SourceLang lang_\n  }\n\n  class Class {\n    +State state_\n    +Class* base_\n    +const File* pandaFile_\n    +const uint8_t* descriptor_\n    +Method* methods_\n    +Field* fields_\n    +Class** ifaces_\n    +ITable itable_\n    +uint32 vtableSize_\n    +uint32 imtSize_\n    +uint32 classSize_\n    +ClassLinkerContext* loadContext_\n    +GetVTable()\n    +GetITable()\n    +ResolveVirtualMethod()\n    +ComputeClassSize()\n    -componentType_\n    -constituentTypes_\n  }\n\n  class ITable {\n    +Size()\n    +Entry* Get()\n  }\n\n  class Method\n  class Field\n  class ClassLinkerContext\n  class ObjectHeader\n  class File\n\n  BaseClass &lt;|-- Class\n  BaseClass o-- ObjectHeader : managedObject_\n  Class o-- File : pandaFile_\n  Class --&gt; Class : base_\n  Class o-- ITable : itable_\n  Class --&gt; ClassLinkerContext : loadContext_\n  Class --&gt; Method : methods_[]\n  Class --&gt; Field : fields_[]\n  Class --&gt; Class : ifaces_[]</code></pre>"},{"location":"03_ClassLoading/DataStructures/Class/#2-class-placement-new-vtableimt","title":"2) \u5173\u952e\u5751\u70b9\uff1a<code>Class</code> \u662f\u201c\u53d8\u957f\u5bf9\u8c61\u5c3e\u968f\u5e03\u5c40\u201d\uff08placement new + \u5c3e\u968f vtable/imt/\u9759\u6001\u533a\uff09","text":"<p>\u8fd9\u662f\u4f60\u63d0\u5230\u7684\u6838\u5fc3\u5751\u70b9\uff1a<code>ark::Class</code> \u4e0d\u662f\u4e00\u4e2a\u201c\u5355\u72ec malloc/new \u7684 C++ \u5bf9\u8c61\u201d\u3002\u5728 core\uff08PANDA_ASSEMBLY\uff09\u8def\u5f84\u91cc\uff0c\u5b83\u88ab\u5185\u5d4c\u5728 <code>coretypes::Class</code>\uff08\u4e00\u4e2a GC \u7ba1\u7406\u7684 NonMovable object\uff09\u91cc\uff1a</p> <ul> <li>\u5206\u914d\uff1a<code>CoreClassLinkerExtension::CreateClass</code> \u7528 HeapManager \u5206\u914d <code>coretypes::Class::GetSize(size)</code> \u5b57\u8282\uff08\u5176\u4e2d <code>size</code> \u662f <code>Class::ComputeClassSize(...)</code> \u8ba1\u7b97\u51fa\u7684\u201cruntime class \u603b\u5927\u5c0f\u201d\uff09\u3002</li> <li>\u6784\u9020\uff1a<code>coretypes::Class::InitClass(...)</code> \u7528 placement new\uff1a<code>new (&amp;klass_) ark::Class(...)</code> \u5728\u201c\u5df2\u5206\u914d\u7684\u5bf9\u8c61\u5185\u5b58\u201d\u91cc\u539f\u5730\u6784\u9020 <code>ark::Class</code>\u3002</li> <li>\u5173\u952e\u539f\u56e0\uff08\u6e90\u7801\u6ce8\u91ca\u76f4\u8bf4\uff09\uff1a\u4e0d\u8981\u5728 InitClass \u91cc\u91cd\u65b0 init object header\uff0c\u5426\u5219 GC \u5e76\u53d1\u8bbf\u95ee\u5bf9\u8c61\u7684 class \u65f6\u53ef\u80fd data race\u3002</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/#21-mermaid","title":"2.1 Mermaid\uff1a\u5185\u5b58\u5e03\u5c40\uff08\u7b80\u5316\u793a\u610f\uff09","text":"<p>\u4e0b\u56fe\u5bf9\u5e94 <code>runtime/include/class-inl.h::Class::ComputeClassSize</code> \u7684\u5206\u6bb5\u8ba1\u7b97\u903b\u8f91\uff08\u5148\u5bf9\u9f50\uff0c\u518d\u52a0 vtable/imt/ref static fields/\u5404\u7c7b padding\uff09\uff1a</p> <pre><code>flowchart LR\n  subgraph Obj[\"NonMovable managed object: coretypes::Class / EtsClass\uff08GC \u7ba1\uff09\"]\n    H[\"ObjectHeader\uff08GC header\uff09\"] --&gt; RT[\"ark::Class \u56fa\u5b9a\u5b57\u6bb5\u533a\\n(sizeof(Class))\"]\n    RT --&gt; AL[\"AlignUp(sizeof(Class), OBJECT_POINTER_SIZE)\"]\n    AL --&gt; VT[\"vtable \u533a\uff1aMethod* \u00d7 vtableSize_\"]\n    VT --&gt; IMT[\"imt \u533a\uff1aMethod* \u00d7 imtSize_\"]\n    IMT --&gt; SREF[\"static ref fields \u533a\uff1aObjectHeader* \u00d7 numRefSfields\"]\n    SREF --&gt; SPAD[\"static primitive/tagged \u533a + padding\\n(\u6309 64/32/16 \u5bf9\u9f50\u586b\u6d1e)\"]\n  end</code></pre> <p>\u76f4\u63a5\u5f71\u54cd\u6392\u969c\uff1a\u5f53\u4f60\u5728 gdb \u91cc\u770b <code>Class*</code> \u6307\u9488\u65f6\uff0c<code>GetVTable()/GetIMTOffset()/GetClassSpan()</code> \u90fd\u662f\u5728\u540c\u4e00\u5757\u201cclassSize_ \u6307\u5b9a\u7684\u5c3e\u968f\u5185\u5b58\u201d\u4e0a\u505a subspan\uff1b\u5982\u679c\u628a\u5b83\u5f53\u6210\u666e\u901a C++ \u6210\u5458\u6570\u7ec4\uff0c\u4f1a\u4ea7\u751f\u975e\u5e38\u9690\u853d\u7684\u8d8a\u754c/\u8bef\u5224\u3002</p>"},{"location":"03_ClassLoading/DataStructures/Class/#03","title":"\u5173\u952e\u5b57\u6bb5/\u4e0d\u53d8\u91cf\uff08\u53ea\u5217 03 \u7ae0\u5173\u5fc3\u7684\uff09","text":"<ul> <li>\u5e03\u5c40\u76f8\u5173\uff1a</li> <li><code>classSize_</code>\uff1a<code>Class</code> \u5bf9\u8c61\u81ea\u8eab\u5927\u5c0f\uff08\u542b vtable/imt/static fields \u7684\u5185\u5d4c\u533a\u95f4\uff09</li> <li><code>objectSize_</code>\uff1a\u5b9e\u4f8b\u5bf9\u8c61\u5927\u5c0f\uff08\u7531 <code>LayoutFields</code> \u8ba1\u7b97\u5e76\u5199\u56de\uff1b\u53d8\u957f\u5bf9\u8c61\u4f8b\u5916\uff09</li> <li><code>refFieldsNum/refFieldsOffset/volatileRefFieldsNum</code>\uff1aGC \u9700\u8981\u7684 ref \u5b57\u6bb5\u4fe1\u606f\uff08static/instance \u5404\u4e00\u5957\uff09</li> <li>\u6d3e\u53d1\u8868\u76f8\u5173\uff1a</li> <li><code>vtableSize_/imtSize_</code>\uff1a\u8868\u5927\u5c0f</li> <li><code>ITable itable_</code>\uff1a\u63a5\u53e3\u8868\uff08Entry: interface Class + Method span\uff09</li> <li><code>IMT</code>\uff1a\u63a5\u53e3\u65b9\u6cd5\u5feb\u901f\u8868\uff08\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff0c\u53ef\u80fd\u6574\u4f53\u7981\u7528\uff09</li> <li>\u5bb9\u5668\u76f8\u5173\uff1a</li> <li><code>methods_</code>\uff1a\u6309 <code>numVmethods/numSmethods</code> \u5206\u533a\uff1b\u672b\u5c3e\u53ef\u80fd\u6709 copied methods\uff08default interface\uff09</li> <li><code>fields_</code>\uff1a\u6309 <code>numSfields</code> \u5206\u533a\uff08\u9759\u6001\u5b57\u6bb5\u5728\u524d\uff09</li> <li><code>interfaces_</code>\uff1a\u63a5\u53e3\u5217\u8868\uff08class linker \u89e3\u6790\u5f97\u5230\uff09</li> <li>\u72b6\u6001\u673a\uff1a</li> <li><code>State::{INITIAL, LOADED, VERIFIED, INITIALIZING, ERRONEOUS, INITIALIZED}</code></li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/#_2","title":"\u8c01\u5199\u5b83\u3001\u8c01\u8bfb\u5b83\uff08\u5bf9\u9f50\u70b9\uff09","text":"<ul> <li>\u5199\u5165\uff08\u4e3b\u8981\u5728 ClassLinker\uff09\uff1a</li> <li><code>runtime/class_linker.cpp</code>\uff1a<ul> <li><code>SetupClassInfo</code>\uff1a\u51b3\u5b9a <code>Class::ComputeClassSize(...)</code> \u7684\u8f93\u5165\uff08vtable/imt/static field types\uff09</li> <li><code>LoadMethods/LoadFields</code>\uff1a\u586b <code>methods_/fields_</code></li> <li><code>LinkMethods</code>\uff1avtable/itable/imtable \u7684 UpdateClass \u5199\u56de</li> <li><code>LinkFields/LayoutFields</code>\uff1a\u5199 <code>Field::offset_</code>\uff0c\u5e76\u5199\u56de <code>objectSize_</code> \u4e0e ref \u5b57\u6bb5\u7edf\u8ba1</li> </ul> </li> <li>\u8bfb\u53d6\uff08\u6d3e\u53d1/\u53cd\u5c04/\u6267\u884c\uff09\uff1a</li> <li><code>Class::ResolveVirtualMethod</code> \u8d70 IMT/ITable/VTable\uff08\u89c1 FileNotes/runtime_include_class-inl.h\uff09</li> <li>field/method \u67e5\u627e\uff08Find / GetByName\uff09\u5728 <code>class-inl.h</code>\uff08\u540c\u4e0a\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/#_3","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_include_class.h</li> <li>FileNotes/runtime_include_class-inl.h</li> <li>FileNotes/runtime_class_linker.cpp</li> <li>\u5173\u952e\u6e90\u7801\u951a\u70b9\uff08placement new + \u53d8\u957f\u5e03\u5c40\uff09\uff1a</li> <li><code>runtime/include/coretypes/class.h</code>\uff08<code>InitClass</code> \u7684 placement new\uff1b<code>GetSize(klassSize)</code>\uff1b\u201cklass field must be last\u201d static_assert\uff09</li> <li><code>runtime/include/class-inl.h</code>\uff08<code>ComputeClassSize/GetVTableOffset/GetVTable/GetIMTOffset/GetClassSpan</code>\uff09</li> <li><code>runtime/core/core_class_linker_extension.cpp::CreateClass</code>\uff08\u6309 <code>coretypes::Class::GetSize(size)</code> \u5206\u914d NonMovable object \u5e76\u8c03\u7528 <code>InitClass</code>\uff09</li> <li><code>plugins/ets/runtime/ets_class_linker_extension.cpp::CreateClass</code>\uff08ETS \u4fa7\u540c\u6837\u901a\u8fc7 managed Class \u5bf9\u8c61\u627f\u8f7d runtime Class\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Class/#_4","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cGetClass/LoadClass \u4e3b\u8c03\u7528\u94fe\u201d \u2192 ../Flows/GetClass_and_LoadClass</li> <li>\u60f3\u770b\u201cvtable/itable/IMT \u6784\u5efa\u4e0e\u51b2\u7a81\u201d \u2192 ITable_and_IMT \u4e0e ../Flows/Builders_and_LinkMethods</li> <li>\u60f3\u770b\u201c\u52a0\u8f7d\u2194\u521d\u59cb\u5316\u4ea4\u754c\uff08 \u771f\u6b63\u6267\u884c\uff09\u201d \u2192 04_ExecutionEngine/README"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/","title":"ClassLinkerContext\uff08\u52a0\u8f7d\u57df/\u7c7b\u52a0\u8f7d\u5668\u4e0a\u4e0b\u6587\uff09","text":""},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201c\u5165\u53e3\uff1a\u6309 descriptor \u627e Class\uff08FindLoadedClass/ctx-&gt;LoadClass\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>ClassLinkerContext</code> \u662f\u201c\u7c7b\u52a0\u8f7d\u9694\u79bb\u57df\u201d\u7684\u62bd\u8c61\uff1a\u5b83\u6301\u6709\u672c\u57df\u5185\u5df2\u52a0\u8f7d\u7c7b\u7f13\u5b58\uff0c\u5e76\u63d0\u4f9b\u5e76\u53d1\u534f\u8c03\u4e0e GC roots \u7ba1\u7406\u63a5\u53e3\u3002\u8bed\u8a00\u63d2\u4ef6\u53ef\u7ee7\u627f\u5b83\uff0c\u5b9a\u4e49\u81ea\u5df1\u7684 <code>LoadClass</code> \u4e0e panda files \u679a\u4e3e\u7b56\u7565\u3002</p>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#_2","title":"\u5173\u952e\u80fd\u529b","text":"<ul> <li>\u7f13\u5b58\uff1a<code>descriptor -&gt; Class*</code>\uff08<code>FindClass/InsertClass/RemoveClass</code>\uff09</li> <li>\u5e76\u53d1\u534f\u8c03\uff1a</li> <li><code>classesLock_</code>\uff1a\u4fdd\u62a4 loadedClasses_\uff08\u9012\u5f52\u9501\uff0c\u652f\u6301 InsertClass \u5185\u91cd\u5165 FindClass\uff09</li> <li><code>mutexTable_</code>\uff1a\u6bcf\u4e2a Class* \u4e00\u4e2a <code>ClassMutexHandler(RecursiveMutex+CondVar)</code>\uff0c\u7528\u4e8e\u7c7b\u52a0\u8f7d/\u521d\u59cb\u5316\u7b49\u5f85\u5524\u9192</li> <li>GC roots\uff1a<code>roots_</code> + <code>VisitGCRoots/UpdateGCRoots/AddGCRoot</code></li> <li>\u6587\u4ef6\u679a\u4e3e\uff1a</li> <li><code>EnumeratePandaFiles</code>\uff08\u672c context\uff09</li> <li><code>EnumeratePandaFilesInChain</code>\uff08\u94fe\u5f0f context\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#ets-etsclasslinkercontext","title":"ETS \u7279\u5316\uff1aEtsClassLinkerContext","text":"<p><code>EtsClassLinkerContext</code> \u7684\u6838\u5fc3\u6269\u5c55\uff1a - context \u4e0e\u4e00\u4e2a managed <code>RuntimeLinker</code> \u7ed1\u5b9a\uff08weak ref\uff09 - <code>LoadClass</code> \u5b9e\u73b0\u4e3a\u4e24\u6bb5\u5f0f\uff1a   - native \u5148\u884c\u6cbf parent+shared libs \u94fe\u5c1d\u8bd5\uff08\u4ec5\u5bf9\u767d\u540d\u5355 linker \u751f\u6548\uff09   - \u5fc5\u8981\u65f6\u624d\u8c03\u7528 managed <code>RuntimeLinker.loadClass(final)</code>\uff0c\u5e76\u4e14 \u7981\u6b62\u5728\u975e managed \u7ebf\u7a0b\u8c03\u7528 - <code>EnumeratePandaFilesImpl</code> \u4ece RuntimeLinker \u7684 AbcFiles \u5217\u8868\u679a\u4e3e panda files</p>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#_3","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_class_linker_context.h</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.h</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#3","title":"3) \u5e76\u53d1\u6a21\u578b\uff08\u5fc5\u987b\u6309\u771f\u5b9e\u4ee3\u7801\u7406\u89e3\uff09","text":"<p>\u5f53\u524d <code>ClassLinker</code> \u7684 <code>LoadClass</code> \u4e3b\u7ebf\u5e76\u6ca1\u6709\u201c\u6309 descriptor \u4e0a\u9501\u6392\u961f\u201d\uff0c\u800c\u662f\u5141\u8bb8\u91cd\u590d\u6784\u5efa\uff0c\u6700\u540e\u7528 <code>InsertClass</code> \u53bb\u91cd\uff1a</p> <pre><code>flowchart TD\n  A[\"GetClass/LoadClass \u5e76\u53d1\u8fdb\u5165\"] --&gt; B[\"\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u53ef\u80fd\u521b\u5efa klass \u5e76\u6784\u5efa\\n(load methods/fields + link)\"]\n  B --&gt; C[\"InsertClass(klass)\\n(classesLock_ \u4fdd\u62a4 loadedClasses_)\"]\n  C --&gt;|\u5df2\u6709\u540c\u540d| D[\"\u8fd4\u56de otherKlass\\n\u8c03\u7528\u65b9 FreeClass(klass)\"]\n  C --&gt;|\u65e0\u540c\u540d| E[\"\u63d2\u5165 loadedClasses_[descriptor]=klass\\n\u5e76\u521b\u5efa mutexTable_[klass]\"]</code></pre> <p>\u8be6\u7ec6\u65f6\u5e8f\u56fe\u4e0e\u9012\u5f52\u52a0\u8f7d\u9632\u62a4\uff08CLASS_CIRCULARITY\uff09\u89c1\uff1a../Flows/Concurrency_and_ClassLock\u3002</p>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#4-classlockper-class-condvar","title":"4) ClassLock\uff08per-class condvar\uff09\u7684\u5b9a\u4f4d\u4e0e\u73b0\u5b9e","text":"<p><code>ClassLinkerContext</code> \u786e\u5b9e\u7ef4\u62a4 <code>mutexTable_</code>\uff0c\u5e76\u63d0\u4f9b <code>runtime/class_lock.{h,cpp}</code> \u7684 <code>ClassLock</code>\uff08\u57fa\u4e8e <code>ClassMutexHandler</code>\uff09\u3002 \u4f46\u9700\u8981\u6ce8\u610f\uff1a\u5f53\u524d class loading \u53bb\u91cd\u4e3b\u7ebf\u5e76\u672a\u4f7f\u7528 ClassLock\uff08\u5b83\u66f4\u50cf\u4e00\u4e2a\u901a\u7528\u5de5\u5177/\u672a\u6765\u63a5\u5165\u70b9\uff09\u3002\u4e0d\u8981\u5728\u6392\u969c\u65f6\u5148\u5047\u8bbe\u201c\u7c7b\u52a0\u8f7d\u4f1a\u88ab per-class \u9501\u4e32\u884c\u5316\u201d\u3002</p>"},{"location":"03_ClassLoading/DataStructures/ClassLinkerContext/#_4","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cContext \u51b3\u5b9a\u53ef\u89c1\u57df\uff08boot vs app vs ETS \u94fe\uff09\u201d \u2192 ../Flows/ClassLoading_EndToEnd</li> <li>\u60f3\u770b\u201cETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u7684 gate \u7ec6\u8282\u201d \u2192 ../Flows/ETS_Context_Native_vs_Managed_Load</li> <li>\u60f3\u770b\u201c\u5e76\u53d1\u53bb\u91cd/\u9012\u5f52\u52a0\u8f7d\u9632\u62a4/\uff08ClassLock \u7684\u73b0\u5b9e\u5b9a\u4f4d\uff09\u201d \u2192 ../Flows/Concurrency_and_ClassLock</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/","title":"ETS \u63d2\u4ef6\u4fa7\u95ed\u73af\uff08LanguageContext / Extension / Context / ITableBuilder\uff09","text":""},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201cETS\uff1acontext \u7684 native\u2192managed \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u201d\u4e0e\u201cExtension \u81ea\u4e3e/entrypoint\u201d\u76f8\u5173\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#1-languagecontext","title":"1) LanguageContext\uff1a\u7b56\u7565\u5de5\u5382\uff08\u5165\u53e3\uff09","text":"<p><code>EtsLanguageContext</code> \u8d1f\u8d23\u628a runtime \u7684\u201c\u62bd\u8c61\u7b56\u7565\u70b9\u201d\u843d\u5230 ETS\uff1a - CreateITableBuilder \u2192 <code>EtsITableBuilder</code> - CreateVTableBuilder \u2192 <code>EtsVTableBuilder</code> - CreateClassLinkerExtension \u2192 <code>EtsClassLinkerExtension</code> - InitializeClass \u2192 <code>ClassInitializer&lt;MT_MODE_TASK&gt;::Initialize</code> - CreateVM / CreateGC / ThrowException / ThrowStackOverflow / VerificationInitAPI</p> <p>\u8bc1\u636e\u94fe\uff1a - FileNotes/plugins_ets_runtime_ets_language_context.h - FileNotes/plugins_ets_runtime_ets_language_context.cpp</p>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#2-classlinkerextension-managed-runtime-class-native","title":"2) ClassLinkerExtension\uff1a\u81ea\u4e3e + managed&lt;-&gt;runtime Class \u7ed1\u5b9a + native \u5165\u53e3\u70b9","text":"<p><code>EtsClassLinkerExtension</code> \u8d1f\u8d23\uff1a - boot \u81ea\u4e3e\uff1aOBJECT/CLASS/String \u4f53\u7cfb\u4e0e primitive/array/synthetic roots - class object \u5206\u914d\uff1aNonMovable <code>EtsClass</code> \u5bf9\u8c61\u5185\u5d4c runtime <code>Class</code>\uff0c\u5e76\u901a\u8fc7 <code>AddCreatedClass/OnClassPrepared</code> \u8ddf\u8e2a\u751f\u547d\u5468\u671f - native \u5165\u53e3\u70b9\uff1a\u6309\u6ce8\u89e3\u9009\u62e9 GENERIC/FAST/CRITICAL/ASYNC\uff0c\u5e76\u5199\u56de Method flags + entrypoint - app context \u521b\u5efa\uff1a<code>CreateApplicationRuntimeLinker(path)</code> - common-context\uff1a\u4e3a union/\u8de8\u57df\u7c7b\u578b\u96c6\u5408\u627e\u5171\u540c loadContext</p> <p>\u8bc1\u636e\u94fe\uff1a - FileNotes/plugins_ets_runtime_ets_class_linker_extension.h - FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</p>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#3-classlinkercontextets-boot","title":"3) ClassLinkerContext\uff1aETS \u975e boot \u52a0\u8f7d\u57df","text":"<p><code>EtsClassLinkerContext</code>\uff1a - native \u4f18\u5148\u94fe\u5f0f\u89e3\u6790\uff08parent + shared libs\uff09\uff0c\u5931\u8d25\u518d\u8c03\u7528 managed <code>loadClass(final)</code> - \u53ea\u5141\u8bb8\u5728 managed \u7ebf\u7a0b\u8fdb\u5165 managed \u8def\u5f84\uff0c\u4fdd\u62a4 VM \u5185\u90e8\u7ebf\u7a0b\uff08JIT/AOT\uff09\u4e0d re-enter managed - panda files \u679a\u4e3e\u76f4\u63a5\u6765\u81ea RuntimeLinker \u7684 AbcFiles \u5217\u8868</p> <p>\u8bc1\u636e\u94fe\uff1a - FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp</p>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#4-itablebuilderets-resolvevtable","title":"4) ITableBuilder\uff1aETS \u63a5\u53e3\u6d3e\u53d1 resolve\uff08vtable \u9a71\u52a8\uff09","text":"<p><code>EtsITableBuilder</code>\uff1a - \u7ebf\u6027\u5316\u63a5\u53e3\u53ca\u5176\u7236\u63a5\u53e3\uff0cclone base itable - Resolve \u65f6\u4f18\u5148\u590d\u7528 base \u7684 vtableIndex\uff08\u6d3e\u53d1\u4f4d\u7f6e\uff09\uff0c\u5426\u5219\u5728 vtable \u53cd\u5411\u5339\u914d name+proto - \u591a\u5b9e\u73b0\u5019\u9009\u76f4\u63a5 MULTIPLE_IMPLEMENT \u62a5\u9519\u5e76\u5931\u8d25</p> <p>\u8bc1\u636e\u94fe\uff1a - FileNotes/plugins_ets_runtime_ets_itable_builder.cpp</p>"},{"location":"03_ClassLoading/DataStructures/ETS_Plugin_Summary/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cETS \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u201d\u7684\u51b3\u7b56\u6811\u4e0e gate \u2192 ../Flows/ETS_Context_Native_vs_Managed_Load</li> <li>\u60f3\u770b\u201cETS native entrypoint \u5982\u4f55\u5199\u56de Method \u5e76\u5f71\u54cd\u6267\u884c\u5165\u53e3\uff08\u8de8\u7ae0\uff09\u201d \u2192 04_ExecutionEngine/README</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Field/","title":"Field\uff08\u8fd0\u884c\u65f6\u5b57\u6bb5\u5143\u6570\u636e\u5bf9\u8c61\uff09","text":""},{"location":"03_ClassLoading/DataStructures/Field/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201cLoadFields/LinkFields\uff1aLayoutFields \u5199\u56de offset\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Field/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>Field</code> \u662f\u8fd0\u884c\u65f6\u5bf9\u201c\u4e00\u4e2a\u5b57\u6bb5\u201d\u7684\u5143\u6570\u636e\u5bf9\u8c61\u3002\u5b83\u523b\u610f\u4fdd\u6301\u6781\u7b80\uff1atype \u7f16\u7801\u8fdb accessFlags \u4f4d\u6bb5 + offset \u5355\u72ec\u5b58\u50a8\uff0c\u4ee5\u4fbf class linker \u5728\u5e03\u5c40\u9636\u6bb5\u5199\u56de offset\u3002</p>"},{"location":"03_ClassLoading/DataStructures/Field/#_2","title":"\u5173\u952e\u5b57\u6bb5/\u4e0d\u53d8\u91cf","text":"<ul> <li><code>accessFlags_</code>\uff1a\u5305\u542b ACC_PUBLIC/STATIC/VOLATILE/FINAL/READONLY \u7b49\uff0c\u540c\u65f6\u8fd8\u5305\u542b <code>TypeId</code> \u4f4d\u6bb5\uff08<code>ACC_TYPE_SHIFT</code>\uff09</li> <li><code>offset_</code>\uff1a\u5b57\u6bb5\u504f\u79fb\uff08static \u4e0e instance \u90fd\u7528\u540c\u4e00\u5b57\u6bb5\u8868\u8fbe\uff0c\u89e3\u91ca\u7531 <code>klass-&gt;GetStaticFieldsOffset</code> \u4e0e object base \u51b3\u5b9a\uff09</li> <li><code>classWord_</code>\uff1a\u6240\u5c5e <code>Class*</code> \u7684 word \u8868\u793a\uff08\u9002\u914d\u538b\u7f29\u6307\u9488\u6a21\u578b\uff09</li> <li><code>fileId_</code>\uff1apanda_file::EntityId\uff08\u5b9a\u4f4d\u5b57\u6bb5\u5b9a\u4e49\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Field/#_3","title":"\u8c01\u5199\u5b83\u3001\u8c01\u8bfb\u5b83\uff08\u5bf9\u9f50\u70b9\uff09","text":"<ul> <li>\u5199\u5165 type/flags\uff1a<code>runtime/class_linker.cpp::LoadFields</code>\uff08InitializeMemory(field, ..., TypeFromEncoding)\uff09</li> <li>\u5199\u5165 offset\uff1a<code>runtime/class_linker.cpp::LayoutFields</code>\uff08\u552f\u4e00\u5199\u5165\u70b9\uff09</li> <li>\u8bfb\u53d6 offset \u505a\u8bbf\u95ee\uff1a</li> <li>\u5b9e\u9645\u8bfb\u5199\u7531 <code>Class::GetFieldObject/SetFieldObject</code> \u901a\u8fc7 <code>ObjectAccessor</code> \u5b8c\u6210\uff08\u89c1 FileNotes/runtime_include_class-inl.h\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Field/#_4","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_include_field.h</li> <li>FileNotes/runtime_class_linker.cpp\uff08LayoutFields \u6bb5\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Field/#_5","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u5b57\u6bb5\u5e03\u5c40\u7b97\u6cd5\u4e0e\u5bf9\u9f50/\u57fa\u7c7b padding \u56de\u586b\u201d \u2192 ../Flows/LayoutFields_and_LinkFields</li> <li>\u60f3\u770b\u201cClass \u7684 refFields*/objectSize \u7b49\u5143\u6570\u636e\u5982\u4f55\u88ab\u5199\u56de\u201d \u2192 Class</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/","title":"ITable \u4e0e IMT\uff08\u63a5\u53e3\u6d3e\u53d1\u7ed3\u6784\uff09","text":""},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201cLinkMethods\uff1avtable/itable/imtable UpdateClass\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#1-itableinterface-table","title":"1) ITable\uff1a\u63a5\u53e3\u8868\uff08Interface Table\uff09","text":""},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>ITable</code> \u662f <code>Class</code> \u5185\u90e8\u4fdd\u5b58\u7684\u63a5\u53e3\u6d3e\u53d1\u7ed3\u6784\uff1a\u4e00\u7ec4 <code>ITable::Entry</code>\uff0c\u6bcf\u4e2a entry \u5173\u8054\uff1a - <code>interface_</code>\uff1a\u63a5\u53e3 <code>Class*</code> - <code>methods_</code>\uff1a<code>Span&lt;Method*&gt;</code>\uff0c\u957f\u5ea6\u4e0e\u8be5\u63a5\u53e3\u7684 virtual methods \u6570\u91cf\u4e00\u81f4\u3001\u540c\u5e8f\u5bf9\u9f50</p>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_2","title":"\u8c01\u5efa\u5b83","text":"<ul> <li>\u6784\u5efa\u63a5\u53e3\uff08\u5951\u7ea6\uff09\uff1a<code>runtime/include/itable_builder.h</code></li> <li>ETS \u5b9e\u73b0\uff1a<code>plugins/ets/runtime/ets_itable_builder.cpp</code></li> <li>Build\uff1aclone base itable + \u7ebf\u6027\u5316\u63a5\u53e3/\u7236\u63a5\u53e3</li> <li>Resolve\uff1avtable \u9a71\u52a8\u89e3\u6790\uff0c\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u69fd\u5199\u5165\u6700\u7ec8\u5b9e\u73b0\uff08\u6216\u56de\u9000\u5230\u63a5\u53e3\u65b9\u6cd5\u672c\u8eab\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#etsbuildresolve","title":"\u7b97\u6cd5\u7ec6\u8282\uff08ETS\uff1aBuild/Resolve \u4e24\u9636\u6bb5\uff09","text":"<p>\u4e3a\u4ec0\u4e48\u8981\u5206\u4e24\u9636\u6bb5\uff1aBuild \u9636\u6bb5\u51b3\u5b9a itable \u7684\u201c\u5f62\u72b6\u201d\uff08\u6709\u54ea\u4e9b\u63a5\u53e3 entry\u3001\u6bcf\u4e2a entry \u7684 methods \u6570\u7ec4\u5927\u5c0f\uff09\uff0cResolve \u9636\u6bb5\u624d\u628a\u6bcf\u4e2a\u69fd\u6620\u5c04\u5230\u6700\u7ec8\u5b9e\u73b0\uff08\u4f9d\u8d56 vtable \u5df2\u5c31\u7eea\uff09\u3002</p>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#buildlinearize-entry-methods","title":"Build\uff1a\u7ebf\u6027\u5316\uff08Linearize\uff09+ \u4e3a entry \u5206\u914d methods \u6570\u7ec4","text":"<p>\u5173\u952e\u6b65\u9aa4\uff08<code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff09\uff1a</p> <ul> <li>\u6536\u96c6\u9700\u8981\u7684\u63a5\u53e3\u96c6\u5408\uff1a</li> <li>\u5148\u628a base \u7684 itable \u91cc\u5df2\u6709\u63a5\u53e3\u52a0\u5165\u96c6\u5408\uff08\u907f\u514d\u91cd\u590d entry\uff09</li> <li>\u518d\u628a <code>classInterfaces</code> \u53ca\u5176 itable \u5185\u7684\u201c\u7236\u63a5\u53e3\u201d\u52a0\u5165\u96c6\u5408</li> <li>\u751f\u6210 itable\uff1a</li> <li>\u5148 clone base itable \u7684 entries\uff08\u4fdd\u6301 base \u7aef entry \u987a\u5e8f\u4e0e\u542b\u4e49\u4e0d\u53d8\uff09</li> <li>\u518d\u6309\u201c\u76f4\u63a5\u63a5\u53e3\u987a\u5e8f\u201d\u8ffd\u52a0\u5176\u7236\u63a5\u53e3 entries \u4e0e\u63a5\u53e3\u81ea\u8eab entry\uff08\u53bb\u91cd\uff0c\u4fdd\u8bc1\u7a33\u5b9a\u987a\u5e8f\uff09</li> <li>\u5bf9\u6bcf\u4e2a\u65b0\u589e entry\uff1a</li> <li><code>methods = entry.interface-&gt;GetVirtualMethods()</code></li> <li>\u5206\u914d <code>Method** methodsAlloc</code>\uff08\u957f\u5ea6 = methods.size\uff09</li> <li><code>entry.SetMethods({methodsAlloc, methods.size})</code></li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#resolve-j","title":"Resolve\uff1a\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u69fd j \u6620\u5c04\u5230\u6700\u7ec8\u5b9e\u73b0","text":"<p>Resolve \u7684\u6838\u5fc3\u5faa\u73af\uff08\u6309\u6e90\u7801\u7684\u771f\u5b9e\u4f18\u5148\u7ea7\uff09\uff1a</p> <ol> <li>\u4f18\u5148\u590d\u7528 base\uff08\u5982\u679c baseEntry \u5b58\u5728\u4e14 baseMethod \u662f class method\uff09\uff1a</li> <li>\u901a\u8fc7 <code>baseMethod-&gt;GetVTableIndex()</code> \u5728\u5f53\u524d\u7c7b <code>klass-&gt;GetVTable()</code> \u91cc\u53d6\u5b9e\u73b0\uff08\u8fd9\u4e00\u6b65\u5f88\u5feb\uff0c\u4e5f\u907f\u514d\u91cd\u590d name+proto \u5339\u914d\uff09</li> <li>\u5426\u5219\u5728\u5f53\u524d vtable \u53cd\u5411\u5339\u914d\uff1a<code>FindMethodInVTable(klass, imethod)</code></li> <li>\u53ea\u6bd4\u5bf9\u201c\u540c\u540d\u201d\u5019\u9009\uff0c\u518d\u7528 <code>ETSProtoIsOverriddenBy</code> \u505a\u7b7e\u540d\u517c\u5bb9\u5224\u65ad</li> <li>\u627e\u5230\u591a\u4e2a\u5019\u9009\u76f4\u63a5 <code>MULTIPLE_IMPLEMENT</code> fail-fast</li> <li>\u5199\u56de\u69fd\u4f4d\uff1a</li> <li>\u627e\u5230\u5b9e\u73b0\uff1a\u5199 class method</li> <li>\u627e\u4e0d\u5230\u5b9e\u73b0\uff1a\u5199\u63a5\u53e3\u65b9\u6cd5\u672c\u8eab\uff08\u540e\u7eed\u6d3e\u53d1\u4f1a\u4f53\u73b0\u4e3a\u201c\u65e0\u5b9e\u73b0/\u9ed8\u8ba4\u8def\u5f84\u201d\uff09</li> </ol> <p>Mermaid\uff08ETS itable Resolve \u5173\u952e\u51b3\u7b56\u6811\uff09\uff1a</p> <pre><code>flowchart TD\n  S[\"Resolve(klass): for entry in itable, for j in iface.virtualMethods\"] --&gt; B{\"baseEntry \u5b58\u5728?\"}\n  B --&gt;|no| F[\"FindMethodInVTable(name+proto)\"]\n  B --&gt;|yes| C{\"baseMethod \u662f interface?\"}\n  C --&gt;|no| V[\"resolved = klass.vtable[ baseMethod.vtableIndex ]\"]\n  C --&gt;|yes| F\n  F --&gt;|\u591a\u5019\u9009| ERR[\"OnVTableConflict: MULTIPLE_IMPLEMENT -&gt; return false\"]\n  F --&gt;|0/1\u5019\u9009| W[\"entry.methods[j] = resolved ?: imethod\"] --&gt; S\n  V --&gt; W</code></pre>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_3","title":"\u5173\u952e\u4e0d\u53d8\u91cf","text":"<ul> <li><code>Entry.methods_.Size == Entry.interface_-&gt;GetVirtualMethods().Size</code></li> <li>Resolve \u540e\uff1a</li> <li><code>Entry.methods_[j]</code> \u8981\u4e48\u662f\u5b9e\u73b0\u65b9\u6cd5\uff08class\uff09\uff0c\u8981\u4e48\u662f\u63a5\u53e3\u65b9\u6cd5\uff08interface\uff0c\u8868\u793a\u65e0\u5b9e\u73b0/\u9ed8\u8ba4\u8def\u5f84\uff09</li> <li>\u51b2\u7a81\uff08Multiple implement\uff09\u5fc5\u987b fail-fast</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#2-imtinterface-method-table","title":"2) IMT\uff1a\u63a5\u53e3\u65b9\u6cd5\u5feb\u901f\u8868\uff08Interface Method Table\uff09","text":""},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_4","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p>IMT \u662f Class \u5185\u90e8\u7684\u4e00\u6bb5 <code>Method*</code> \u6570\u7ec4\uff0c\u7528\u4e8e\u628a\u201c\u63a5\u53e3\u65b9\u6cd5 id/hash\u201d\u6620\u5c04\u5230\u5b9e\u73b0\u65b9\u6cd5\uff0c\u51cf\u5c11 itable \u904d\u5386\u3002</p>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_5","title":"\u8c01\u5efa\u5b83","text":"<ul> <li><code>runtime/imtable_builder.cpp</code></li> <li>\u89c4\u6a21\u7b56\u7565\uff1a\u63a5\u53e3\u65b9\u6cd5\u6570\u8fc7\u591a\u65f6\u76f4\u63a5 <code>imtSize=0</code>\uff08\u7981\u7528\uff09</li> <li>\u51b2\u7a81\u7b56\u7565\uff1a\u540c\u69fd\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff0c\u5e76\u6807\u8bb0\u8be5\u69fd\u4e3a conflict\uff08\u540e\u7eed\u4e0d\u518d\u5c1d\u8bd5\u586b\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_6","title":"\u5173\u952e\u4e0d\u53d8\u91cf","text":"<ul> <li>IMT \u662f\u201c\u53ef\u9009\u52a0\u901f\u7ed3\u6784\u201d\uff1a</li> <li><code>imtSize==0</code> \u2192 \u6d3e\u53d1\u5fc5\u987b\u56de\u9000\u5230 itable</li> <li>\u69fd\u4e3a\u7a7a\uff08FREE SLOT\uff09 \u2192 \u56de\u9000\u5230 itable</li> <li>\u69fd\u51b2\u7a81 \u2192 \u4e5f\u56de\u9000\u5230 itable\uff08\u901a\u8fc7\u6e05\u7a7a\u69fd\u4fdd\u8bc1\u4e0d\u4f1a\u8bef\u6d3e\u53d1\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#3","title":"3) \u6d3e\u53d1\u8def\u5f84\uff08\u6982\u5ff5\uff09","text":"<ul> <li>\u4f18\u5148 IMT\uff1a\u5feb\u8def\u5f84\u547d\u4e2d\u5219\u76f4\u63a5\u8c03\u7528\u69fd\u5185 Method*</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_7","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cBuild/Resolve/UpdateClass \u7684\u771f\u5b9e\u987a\u5e8f\u201d \u2192 ../Flows/Builders_and_LinkMethods</li> <li>\u60f3\u6392\u67e5 MULTIPLE_IMPLEMENT / IMT \u51b2\u7a81 / IMT \u7981\u7528 \u2192 ../Newbie_MinDebug_Playbook\uff08\u5b9e\u9a8c 3\uff09</li> <li>\u56de\u9000 ITable\uff1a\u6309\u63a5\u53e3 entry + vtableIndex/resolve \u7ed3\u679c\u53d6\u5b9e\u73b0</li> <li>\u6700\u7ec8 vtable\uff1a\u5bf9\u7c7b\u865a\u65b9\u6cd5\u6d3e\u53d1\u5219\u76f4\u63a5\u8d70 vtable</li> </ul>"},{"location":"03_ClassLoading/DataStructures/ITable_and_IMT/#_8","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_include_itable.h</li> <li>FileNotes/runtime_include_itable_builder.h</li> <li>FileNotes/plugins_ets_runtime_ets_itable_builder.cpp</li> <li>FileNotes/runtime_imtable_builder.cpp</li> <li>FileNotes/runtime_include_class-inl.h\uff08ResolveVirtualMethod \u7684 IMT/ITable/VTable \u5206\u652f\uff09</li> <li>\u5173\u952e\u6e90\u7801\u951a\u70b9\uff1a</li> <li><code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff08LinearizeITable/CloneBaseITable/Build/Resolve/FindMethodInVTable\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Index/","title":"03_ClassLoading / DataStructures","text":"<p>\u672c\u76ee\u5f55\u662f\u201c\u53ef\u590d\u7528\u7684\u7ed3\u6784\u5361\u7247\u201d\u3002\u6bcf\u5f20\u5361\u7247\u53ea\u5199\u4e09\u4ef6\u4e8b\uff1a\u7ed3\u6784\u662f\u4ec0\u4e48\u3001\u5173\u952e\u5b57\u6bb5/\u4e0d\u53d8\u91cf\u3001\u5728\u54ea\u91cc\u88ab\u5199\u5165/\u6d88\u8d39\uff08\u56de\u94fe\u5230 FileNotes\uff09\u3002</p>"},{"location":"03_ClassLoading/DataStructures/Index/#_1","title":"\u7ed3\u6784\u5361\u7247\u6e05\u5355\uff08\u5efa\u8bae\u987a\u5e8f\uff09","text":"<ol> <li>Class\uff1aClass \u5143\u6570\u636e\u5bf9\u8c61\uff08\u5927\u5c0f/\u8868\u533a\u5e03\u5c40/\u72b6\u6001\u673a/\u5b57\u6bb5\u4e0e\u65b9\u6cd5\u5bb9\u5668\uff09</li> <li>Method\uff1aMethod \u5143\u6570\u636e\uff08\u7b7e\u540d/\u5165\u53e3\u70b9/\u70ed\u70b9\u4e0e\u7f16\u8bd1\u72b6\u6001/\u6d3e\u53d1\u7d22\u5f15\uff09</li> <li>Field\uff1aField \u5143\u6570\u636e\uff08type \u4f4d\u6bb5/offset/\u6240\u5c5e\u7c7b\uff09</li> <li>ITable_and_IMT\uff1a\u63a5\u53e3\u6d3e\u53d1\u7ed3\u6784\uff08ITable entries\u3001IMT \u51b2\u7a81\u7b56\u7565\uff09</li> <li>ClassLinkerContext\uff1a\u4e0a\u4e0b\u6587\u7f13\u5b58 + per-Class mutex + GC roots</li> <li>ETS_Plugin_Summary\uff1aETS \u7684 LanguageContext/Extension/Context/ITableBuilder \u7684\u804c\u8d23\u5206\u5de5</li> </ol> <p>\u65b0\u4eba\u63a8\u8350\uff1a\u5148\u770b ../Flows/ClassLoading_EndToEnd \u5efa\u7acb\u4e3b\u7ebf\uff0c\u518d\u6309\u5361\u7247\u8865\u4e0d\u53d8\u91cf\u3002</p>"},{"location":"03_ClassLoading/DataStructures/Method/","title":"Method\uff08\u8fd0\u884c\u65f6\u65b9\u6cd5\u5143\u6570\u636e\u5bf9\u8c61\uff09","text":""},{"location":"03_ClassLoading/DataStructures/Method/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1a../Flows/ClassLoading_EndToEnd\uff08\u201cLoadMethods\uff1a\u8bbe\u7f6e entrypoint / copied methods\u201d\u6846\uff1b\u4ee5\u53ca\u540e\u7eed\u6267\u884c\u5165\u53e3\u8de8\u7ae0\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Method/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>Method</code> \u662f\u8fd0\u884c\u65f6\u5bf9\u201c\u4e00\u4e2a\u65b9\u6cd5/\u51fd\u6570\u201d\u7684\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u8d1f\u8d23\u627f\u8f7d\uff1a - \u7b7e\u540d\uff08Proto/ProtoId/shorty\uff09 - \u8bbf\u95ee\u6807\u5fd7\u4f4d\uff08\u542b compilation/verification stage \u4f4d\u6bb5\uff09 - \u6d3e\u53d1\u7d22\u5f15\uff08vtableIndex\uff09 - \u6267\u884c\u5165\u53e3\u70b9\uff08\u89e3\u91ca\u5668\u6865\u63a5 / JIT/AOT / native / stub\uff09 - \u70ed\u70b9\u8ba1\u6570\u4e0e profilingData\uff08union \u590d\u7528\u69fd\uff09</p>"},{"location":"03_ClassLoading/DataStructures/Method/#_2","title":"\u5173\u952e\u5b57\u6bb5/\u4e0d\u53d8\u91cf","text":"<ul> <li>\u7b7e\u540d\uff1a</li> <li><code>Proto</code>\uff1a\u5c55\u5f00 shorty/refTypes</li> <li><code>ProtoId</code>\uff1a\u8f7b\u91cf\u6807\u8bc6\uff08pf + proto EntityId\uff09\uff0c\u7528\u4e8e override/\u517c\u5bb9\u5224\u65ad</li> <li><code>shorty_</code>\uff1a\u6307\u5411 proto shorty \u6570\u636e</li> <li>\u5165\u53e3\u70b9\uff1a</li> <li><code>compiledEntryPoint_</code>\uff08atomic\uff09\uff1a\u9ed8\u8ba4\u6307\u5411 C2I bridge\uff1bnative \u6307\u5411 ANI/critical/async\uff1bAOT \u53ef\u8986\u76d6</li> <li><code>SetInterpreterEntryPoint()</code>\uff1a\u628a\u975e native \u65b9\u6cd5\u91cd\u7f6e\u4e3a C2I bridge</li> <li>\u72b6\u6001\u4f4d\u6bb5\uff08\u90fd\u585e\u8fdb <code>accessFlags_</code>\uff09\uff1a</li> <li><code>CompilationStage</code>\uff08NOT_COMPILED/WAITING/COMPILATION/COMPILED/FAILED\uff09</li> <li><code>VerificationStage</code></li> <li>\u8bbf\u95ee\u6807\u5fd7\uff08ACC_*\uff09\u4e0e\u8fd0\u884c\u671f\u6807\u8bb0\uff08DEFAULT_INTERFACE_METHOD/DESTROYED/PROFILING\u2026\uff09</li> <li>\u6d3e\u53d1\u7d22\u5f15\uff1a</li> <li><code>stor16Pair_.vtableIndex</code>\uff1a\u7531 vtable builder \u7684 <code>UpdateClass</code> \u5199\u56de</li> <li>profilingData vs nativePointer\uff1a</li> <li>union <code>PointerInMethod</code>\uff1anative/proxy \u4f7f\u7528 <code>nativePointer</code>\uff0c\u5426\u5219\u4f7f\u7528 <code>profilingData</code></li> </ul>"},{"location":"03_ClassLoading/DataStructures/Method/#_3","title":"\u8c01\u5199\u5b83\u3001\u8c01\u8bfb\u5b83\uff08\u5bf9\u9f50\u70b9\uff09","text":"<ul> <li>\u521b\u5efa\u4e0e\u5165\u53e3\u70b9\u8bbe\u7f6e\uff1a<code>runtime/class_linker.cpp::LoadMethod/LoadMethods/SetupCopiedMethods</code></li> <li>native \u5165\u53e3\u70b9\u7b56\u7565\uff08ETS\uff09\uff1a<code>plugins/ets/runtime/ets_class_linker_extension.cpp::GetNativeEntryPointFor</code></li> <li>\u6d3e\u53d1\u7d22\u5f15\u5199\u56de\uff1a<code>vtableBuilder-&gt;UpdateClass</code>\uff08class_linker.cpp::LinkMethods \u8c03\u7528\uff09</li> <li>\u8c03\u7528\u4e0e frame \u76f8\u5173\u5165\u53e3\uff1a<code>Method::Invoke/InvokeDyn/InvokeContext</code>\uff08\u6267\u884c\u5f15\u64ce\u7ae0\u8282 04 \u8be6\u8ff0\uff09</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Method/#_4","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_include_method.h</li> <li>FileNotes/runtime_class_linker.cpp</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</li> </ul>"},{"location":"03_ClassLoading/DataStructures/Method/#_5","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201centrypoint \u5728\u8fd0\u884c\u671f\u5982\u4f55\u5f71\u54cd\u89e3\u91ca\u5668\u2194compiled \u6d3e\u53d1\uff08\u8de8\u7ae0\uff09\u201d \u2192 04_ExecutionEngine/README</li> <li>\u60f3\u770b\u201cLinkMethods \u5982\u4f55\u5199\u56de vtableIndex/\u6d3e\u53d1\u7ed3\u6784\u201d \u2192 ../Flows/Builders_and_LinkMethods</li> </ul>"},{"location":"03_ClassLoading/Diagrams/Index/","title":"03_ClassLoading / Diagrams","text":"<p>\u672c\u76ee\u5f55\u5b58\u653e\u53ef\u590d\u7528\u7684 Mermaid \u56fe\u3002README \u4e2d\u5d4c\u5165\u4e86\u6838\u5fc3\u56fe\uff1b\u8fd9\u91cc\u4fdd\u7559\u201c\u5355\u72ec\u6587\u4ef6\u7248\u672c\u201d\uff0c\u4fbf\u4e8e\u5728\u5176\u4ed6\u7ae0\u8282\u590d\u7528\u6216\u5f15\u7528\u3002</p>"},{"location":"03_ClassLoading/Diagrams/Index/#_1","title":"\u56fe\u6e05\u5355","text":"<ul> <li><code>Architecture_Overview.mmd</code>\uff1a03 \u7ae0\u7ec4\u4ef6\u603b\u89c8\uff08Runtime core vs ETS plugin\uff09</li> <li><code>GetClass_Decision_Tree.mmd</code>\uff1aGetClass \u51b3\u7b56\u6811\uff08boot vs app\uff09</li> <li><code>LoadClass_Pipeline.mmd</code>\uff1aLoadClass \u4e3b\u7ba1\u7ebf\uff08builders/layout/link\uff09</li> <li><code>ETS_LoadClass_Native_vs_Managed.mmd</code>\uff1aETS context \u4e24\u6bb5\u5f0f\u52a0\u8f7d\uff08native\u2192managed\uff09</li> <li><code>Builders_Sequence.mmd</code>\uff1a\u4e09\u7c7b builder \u7684 Build/Resolve/UpdateClass \u987a\u5e8f</li> </ul>"},{"location":"03_ClassLoading/FileNotes/Index/","title":"03 ClassLoading / FileNotes / Index","text":"<p>\u672c\u76ee\u5f55\u662f \u6e90\u7801\u8bc1\u636e\u94fe\u5361\u7247\uff1a\u6bcf\u4e2a\u6587\u4ef6\u4e00\u9875\uff0c\u89e3\u91ca\u201c\u8fd9\u4e2a\u6587\u4ef6\u8d1f\u8d23\u4ec0\u4e48\u3001\u5173\u952e\u5165\u53e3\u51fd\u6570\u3001\u5e38\u89c1\u5751\u3001\u4ee5\u53ca\u4e0e Flows/DataStructures \u7684\u5bf9\u5e94\u5173\u7cfb\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/Index/#_1","title":"\u5feb\u901f\u5165\u53e3","text":"<ul> <li>\u672f\u8bed\u8868\uff1a_Glossary</li> <li>ClassLinker \u4e3b\u903b\u8f91\uff1aruntime_class_linker.cpp</li> <li>ClassLock / ClassMutexHandler\uff1aruntime_class_lock.h / runtime_class_lock.cpp</li> <li>FileManager\uff08.abc/.an\uff09\uff1aruntime_file_manager.cpp</li> </ul>"},{"location":"03_ClassLoading/FileNotes/Index/#all-pages","title":"\u6587\u4ef6\u5217\u8868\uff08\u624b\u5de5\u7ef4\u62a4\u7d22\u5f15\uff0c\u5b8c\u6574\u5217\u8868\u53ef\u770b All Pages\uff09","text":"<ul> <li>runtime_class_linker.cpp</li> <li>runtime_class_linker_context.h</li> <li>runtime_class_linker_extension.cpp</li> <li>runtime_class_lock.h</li> <li>runtime_class_lock.cpp</li> <li>runtime_file_manager.cpp</li> <li>runtime_imtable_builder.cpp</li> <li>runtime_include_class.h</li> <li>runtime_include_class-inl.h</li> <li>runtime_include_vtable_builder_base.h</li> <li>runtime_include_vtable_builder_base-inl.h</li> <li>runtime_include_vtable_builder_interface.h</li> <li>runtime_include_vtable_builder_variance.h</li> <li>runtime_include_vtable_builder_variance-inl.h</li> <li>runtime_include_itable.h</li> <li>runtime_include_itable_builder.h</li> <li>runtime_include_imtable_builder.h</li> <li>runtime_include_method.h</li> <li>runtime_include_field.h</li> <li>runtime_include_file_manager.h</li> <li>runtime_include_class_linker.h</li> <li>runtime_include_class_linker_extension.h</li> <li>runtime_include_class_helper.h</li> <li>ETS \u63d2\u4ef6\u76f8\u5173\uff1a\u89c1 All_Pages \u4e2d\u7684 <code>plugins_ets_runtime_ets_*</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/","title":"03_ClassLoading / FileNotes \u672f\u8bed\u901f\u67e5\uff08Glossary\uff09","text":"<p>\u7528\u6cd5\u5efa\u8bae\uff1a\u8bfb\u4efb\u4f55\u9010\u884c FileNote \u524d\uff0c\u5148\u5728\u8fd9\u91cc\u628a\u4e0d\u719f\u7684\u540d\u8bcd\u626b\u4e00\u904d\uff08\u5efa\u8bae\u4ece FileNotes/Index \u8fdb\u5165\uff09\u3002 \u672c\u7ae0\u539f\u5219\uff1a\u5c3d\u91cf\u5728 03 \u7ae0\u5185\u95ed\u73af\u89e3\u91ca\uff1b\u6d89\u53ca\u5176\u4ed6\u7ae0\u8282\uff08\u5982 GC/\u89e3\u91ca\u5668\uff09\u53ea\u7ed9\u51fa\u201c\u662f\u4ec0\u4e48/\u4e3a\u4ec0\u4e48\u8981\u5b83\u201d\uff0c\u4e0d\u5f3a\u5236\u8df3\u8f6c\u3002</p>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#_1","title":"\u6838\u5fc3\u5bf9\u8c61\u4e0e\u6807\u8bc6","text":"<ul> <li>descriptor\uff08\u7c7b\u63cf\u8ff0\u7b26\uff09\uff1a\u7c7b\u540d\u7684\u89c4\u8303\u7f16\u7801\uff08\u591a\u4e3a MUTF8 \u5b57\u7b26\u4e32\uff09\u3002\u7528\u4e8e <code>descriptor -&gt; Class*</code> \u67e5\u627e\u4e0e\u7f13\u5b58\u3002  </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_class_linker.cpp\uff08GetClass/LoadClass\uff09\uff1bFileNotes/runtime_class_linker_context.h\uff08loadedClasses_ key\uff09\u3002</p> </li> <li> <p>PandaFile / <code>.abc</code>\uff1aArk/Panda \u7684\u5b57\u8282\u7801\u6587\u4ef6\u5bb9\u5668\uff1b\u8fd0\u884c\u65f6\u901a\u8fc7 <code>panda_file::File</code>/<code>OpenPandaFile(OrZip)</code> \u6253\u5f00\u5e76\u6ce8\u518c\u5230 <code>ClassLinker</code>\u3002  </p> </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_file_manager.cpp\u3001FileNotes/runtime_class_linker.cpp\uff08AddPandaFile\uff09\u3002</p> </li> <li> <p>EntityId\uff08panda_file::File::EntityId\uff09\uff1aPandaFile \u5185\u90e8\u5b9e\u4f53\uff08\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5/\u6ce8\u89e3\u7b49\uff09\u7684\u7d22\u5f15\u6807\u8bc6\u3002  </p> </li> <li> <p>\u5178\u578b\u7528\u9014\uff1a<code>GetClass(pf,id)</code>\u3001<code>GetMethod(pf,id)</code>\u3001<code>GetField(pf,id)</code>\u3002</p> </li> <li> <p>ClassDataAccessor / MethodDataAccessor / FieldDataAccessor\uff1a\u8bfb\u53d6 PandaFile \u5143\u6570\u636e\u7684\u8bbf\u95ee\u5668\uff08\u4e0d\u4f1a\u76f4\u63a5\u521b\u5efa runtime \u5bf9\u8c61\uff09\u3002  </p> </li> <li>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_class_linker.cpp\uff08LoadClass/LoadMethod/LoadFields\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#classlinker-extension-context","title":"ClassLinker / Extension / Context\uff08\u8c01\u8d1f\u8d23\u4ec0\u4e48\uff09","text":"<ul> <li>ClassLinker\uff1a\u8bed\u8a00\u65e0\u5173\u7684\u201c\u52a0\u8f7d/\u94fe\u63a5\u201d\u4e3b\u7ba1\u7ebf\uff08GetClass/LoadClass/BuildClass\uff1b\u6d3e\u53d1\u8868 builder\u3001\u5b57\u6bb5\u5e03\u5c40\u3001\u7f13\u5b58/\u5e76\u53d1\u3001boot filter\uff09\u3002  </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_include_class_linker.h + FileNotes/runtime_class_linker.cpp\u3002</p> </li> <li> <p>ClassLinkerExtension\uff1a\u8bed\u8a00\u6269\u5c55\u70b9\uff08roots\u3001\u81ea\u5b9a\u4e49 CreateClass/FreeClass\u3001native entrypoint\u3001context \u7ba1\u7406\u3001\u9519\u8bef\u6620\u5c04\u7b49\uff09\u3002  </p> </li> <li>\u62bd\u8c61\u4e0e\u5bb9\u5668\uff1aFileNotes/runtime_include_class_linker_extension.h </li> <li> <p>\u9ed8\u8ba4\u5b9e\u73b0\uff08Boot/AppContext LoadClass\u3001new/created/obsolete classes\u3001CNFE\u2192NCDFE \u5305\u88c5\uff09\uff1aFileNotes/runtime_class_linker_extension.cpp</p> </li> <li> <p>(Boot)Context / AppContext / chained context\uff1a</p> </li> <li>BootContext\uff1aboot \u7c7b\u52a0\u8f7d\u57df\uff1b\u679a\u4e3e boot panda files\uff1b\u901a\u5e38\u914d\u5408 boot bloom filter\u3002  </li> <li>AppContext\uff1a\u5e94\u7528\u52a0\u8f7d\u57df\uff1b\u9ed8\u8ba4\u5b9e\u73b0\u4f1a\u5728\u672c\u57df panda files \u4e2d\u6309 classId \u52a0\u8f7d\u3002  </li> <li>Chained context\uff1a\u5b58\u5728 parent/\u5171\u4eab\u5e93\u94fe\u7684\u52a0\u8f7d\u57df\uff08ETS \u5f3a\u76f8\u5173\uff09\u3002</li> <li>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_class_linker_extension.cpp\uff08Boot/AppContext \u9ed8\u8ba4\uff09\uff1bFileNotes/runtime_class_linker_context.h\uff08\u57fa\u7c7b\u5951\u7ea6\uff09\uff1bFileNotes/plugins_ets_runtime_ets_class_linker_context.cpp\uff08ETS \u94fe\u5f0f\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#roots","title":"roots\uff08\u6839\u7c7b\u81ea\u4e3e\uff09","text":"<ul> <li>class roots\uff1a\u8fd0\u884c\u65f6\u5fc5\u987b\u6700\u65e9\u53ef\u7528\u7684\u4e00\u7ec4\u201c\u57fa\u7840\u7c7b\u201d\uff08Object/Class/String/Array/primitive \u7b49\uff09\uff0c\u7531\u5404\u8bed\u8a00 extension \u5728\u521d\u59cb\u5316\u9636\u6bb5\u521b\u5efa/\u6ce8\u518c\u3002  </li> <li>core\uff08PANDA_ASSEMBLY\uff09\u5b9e\u73b0\uff1aFileNotes/runtime_core_core_class_linker_extension.cpp </li> <li> <p>ETS \u5b9e\u73b0\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</p> </li> <li> <p>NonMovable allocation\uff1aroots/class object \u5e38\u9700\u8981\u4e0d\u53ef\u79fb\u52a8\u5206\u914d\uff0c\u907f\u514d\u65e9\u671f\u9636\u6bb5\u5bf9\u8c61\u79fb\u52a8\u5e26\u6765\u989d\u5916\u590d\u6742\u6027\u3002  </p> </li> <li>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_core_core_class_linker_extension.cpp\uff08CreateClass \u4f7f\u7528 AllocateNonMovableObject\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#dispatch-tables","title":"\u6d3e\u53d1\u8868\uff08Dispatch Tables\uff09","text":"<ul> <li>vtable\uff08\u865a\u65b9\u6cd5\u8868\uff09\uff1a\u7c7b\u865a\u65b9\u6cd5\u6d3e\u53d1\u8868\uff1b\u9700\u8981\u5904\u7406 override\u3001final\u3001default interface method\uff08copied methods\uff09\u7b49\u3002  </li> <li> <p>\u8bc1\u636e\u94fe\uff1a<code>FileNotes/runtime_include_vtable_builder_*</code>\uff08builder \u5951\u7ea6/\u7b56\u7565\uff09\u3002</p> </li> <li> <p>copied methods\uff08\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u590d\u5236\u4f53\uff09\uff1a\u4e3a default interface method \u751f\u6210\u7684 <code>Method</code> \u590d\u5236\u4f53\uff0c\u6302\u5728 methods \u5c3e\u90e8\uff1b\u51b2\u7a81\u4f1a\u7528 stub \u8868\u8fbe\u3002  </p> </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_include_vtable_builder_interface.h\u3001FileNotes/runtime_class_linker.cpp\uff08SetupCopiedMethods/LoadMethods\uff09\u3002</p> </li> <li> <p>ITable\uff08\u63a5\u53e3\u8868\uff09\uff1a\u6309 \u201cinterface Class \u2192 Method \u6620\u5c04\u6570\u7ec4\u201d \u5b58\u50a8\u63a5\u53e3\u6d3e\u53d1\u4fe1\u606f\u3002  </p> </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_include_itable.h\u3001FileNotes/plugins_ets_runtime_ets_itable_builder.cpp\u3002</p> </li> <li> <p>IMT\uff08Interface Method Table\uff09\uff1a\u63a5\u53e3\u65b9\u6cd5\u5feb\u901f\u8868\uff08\u53ef\u9009\u52a0\u901f\uff09\uff1b\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff0c\u5fc5\u8981\u65f6\u6574\u4f53\u7981\u7528\uff08imtSize=0\uff09\u3002  </p> </li> <li>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_imtable_builder.cpp\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#_2","title":"\u9519\u8bef\u4e0e\u5f02\u5e38\uff08\u5e38\u89c1\u7f29\u5199\uff09","text":"<ul> <li>CNFE\uff08ClassNotFoundException\uff09\uff1a\u7c7b\u672a\u627e\u5230\uff08\u66f4\u504f\u201c\u67e5\u627e/\u52a0\u8f7d\u201d\uff09\u3002  </li> <li>NCDFE\uff08NoClassDefFoundError\uff09\uff1a\u7c7b\u5b9a\u4e49\u4e0d\u53ef\u7528\uff08\u66f4\u504f\u201c\u94fe\u63a5/\u89e3\u6790\u4f9d\u8d56\u5931\u8d25\u201d\uff09\u3002  </li> <li>\u672c\u7ae0\u5173\u952e\u884c\u4e3a\uff1a\u6309 <code>pf,id</code> \u53d6\u7c7b\u5931\u8d25\u89e6\u53d1 CNFE \u65f6\uff0cExtension \u4f1a\u5728\u5fc5\u8981\u65f6\u5305\u88c5\u4e3a NCDFE\u3002  </li> <li>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_class_linker_extension.cpp\uff08WrapClassNotFoundExceptionIfNeeded\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/_Glossary/#_3","title":"\u5176\u5b83\u5e38\u89c1\u540d\u8bcd","text":"<ul> <li>AOT / <code>.an</code>\uff1a\u63d0\u524d\u7f16\u8bd1\u4ea7\u7269\uff1b\u8fd0\u884c\u65f6\u901a\u8fc7 <code>AotManager</code> \u6ce8\u518c\u5e76\u53c2\u4e0e method entrypoint/linking\u3002  </li> <li> <p>\u8bc1\u636e\u94fe\uff1aFileNotes/runtime_file_manager.cpp\u3001FileNotes/runtime_class_linker.cpp\uff08AotManager \u63a5\u5165\u70b9\uff09\u3002</p> </li> <li> <p>CHA\uff08Class Hierarchy Analysis\uff09\uff1a\u7c7b\u5c42\u6b21\u5206\u6790\uff0c\u7528\u4e8e\u7f16\u8bd1/\u4f18\u5316\uff1b\u5728 runtime \u521d\u59cb\u5316\u9636\u6bb5\u53ef\u80fd\u89e6\u53d1\u6821\u9a8c\uff08VerifyClassHierarchy\uff09\u3002  </p> </li> <li>\u8bf4\u660e\uff1a\u8c03\u7528\u70b9\u4e3b\u8981\u5728 <code>runtime/runtime.cpp</code>\uff0c\u5c5e\u4e8e\u201c\u542f\u52a8/\u521d\u59cb\u5316\u8fb9\u754c\u201d\uff0c\u672c\u7ae0\u53ea\u89e3\u91ca\u5176\u4e0e ClassLinker/AotManager \u7684\u63a5\u53e3\u542b\u4e49\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/","title":"<code>plugins/ets/runtime/ets_class_linker.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cETS fa\u00e7ade \u5b9e\u73b0 + async \u6ce8\u89e3\u89e3\u6790\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u89c4\u6a21\uff1a94 \u884c \u76ee\u6807\uff1a\u8bf4\u660e ETS fa\u00e7ade \u5982\u4f55\u628a runtime <code>ClassLinker</code>/<code>ClassLinkerExtension</code> \u7684 API \u8f6c\u6362\u4e3a <code>EtsClass</code> \u8bed\u4e49\uff0c\u5e76\u8865\u5145 async \u6ce8\u89e3\u5230 impl method \u7684\u89e3\u6790\u94fe\u8def\u4e0e\u5f02\u5e38\u8bed\u4e49\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#0-include-l16l24","title":"0. include \u4e0e\u4f9d\u8d56\uff08L16\u2013L24\uff09","text":"<ul> <li><code>ets_annotation.h</code>\uff1a\u67e5\u627e async \u6ce8\u89e3\u3002</li> <li><code>ets_class_linker.h</code>\uff1a\u672c\u6587\u4ef6\u5bf9\u5e94\u5934\u3002</li> <li><code>ets_class_linker_extension.h</code>\uff1a\u628a core <code>ClassLinkerExtension*</code> \u8f6c\u4e3a ETS \u4fa7\u7c7b\u578b\u3002</li> <li><code>ets_coroutine.h</code> / <code>ets_exceptions.h</code> / <code>ets_panda_file_items.h</code>\uff1a\u629b ETS \u5f02\u5e38\u6240\u9700\u3002</li> <li><code>types/ets_class.h</code>\uff1a\u628a runtime <code>Class*</code> \u6620\u5c04\u56de <code>EtsClass*</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#1-l27l34","title":"1. \u6784\u9020\u4e0e\u5de5\u5382\uff08L27\u2013L34\uff09","text":"<ul> <li>L27\uff1a\u6784\u9020\u4ec5\u4fdd\u5b58 <code>classLinker_</code> \u6307\u9488\uff08\u4e0d owned\uff09\u3002</li> <li>L29\u2013L34\uff1a<code>Create(classLinker)</code>\uff1a</li> <li><code>MakePandaUnique&lt;EtsClassLinker&gt;(classLinker)</code>\uff0c\u5e76\u5305\u88c5\u8fdb <code>Expected</code> \u8fd4\u56de\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#2-initialize-ets-extensionl36l41","title":"2. Initialize\uff1a\u7f13\u5b58 ETS extension\uff08L36\u2013L41\uff09","text":"<ul> <li><code>classLinker_-&gt;GetExtension(SourceLang::ETS)</code> \u62ff\u5230 core extension \u6307\u9488\u3002</li> <li><code>ext_ = EtsClassLinkerExtension::FromCoreType(ext)</code>\uff1a\u7c7b\u578b\u5b89\u5168\u7684 downcast/adapter\u3002</li> </ul> <p>\u8fd9\u4e00\u6b65\u8ba9\u540e\u7eed <code>GetClass</code>/<code>GetClassRoot</code> \u90fd\u53ef\u4ee5\u901a\u8fc7 <code>ext_</code> \u5b8c\u6210\u201cruntime Class \u2194 ETS EtsClass\u201d\u8f6c\u6362\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#3-initializeclassl43l47","title":"3. InitializeClass\uff1a\u5bf9\u5916\u8f6c\u53d1\uff08L43\u2013L47\uff09","text":"<ul> <li>\u8f93\u5165\u662f <code>EtsClass*</code>\uff0c\u5185\u90e8\u53d6 <code>klass-&gt;GetRuntimeClass()</code> \u518d\u8c03\u7528 <code>classLinker_-&gt;InitializeClass(coroutine, runtimeClass)</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#4-getclassroot-getclass-runtime-class-etsclassl49l67","title":"4. GetClassRoot / GetClass\uff1a\u628a runtime Class \u8f6c\u4e3a EtsClass\uff08L49\u2013L67\uff09","text":"<ul> <li>GetClassRoot\uff08L49\u2013L52\uff09\uff1a</li> <li><code>ext_-&gt;GetClassRoot(static_cast&lt;ark::ClassRoot&gt;(root))</code> \u2192 runtime <code>Class*</code></li> <li><code>EtsClass::FromRuntimeClass(cls)</code> \u2192 <code>EtsClass*</code></li> <li>GetClass(name)\uff08L54\u2013L60\uff09\uff1a</li> <li><code>utf::CStringAsMutf8(name)</code> \u2192 descriptor</li> <li><code>ext_-&gt;GetClass(descriptor, needCopyDescriptor, context, errorHandler)</code> \u2192 runtime <code>Class*</code></li> <li>\u975e\u7a7a\u5219\u8f6c <code>EtsClass*</code> \u8fd4\u56de</li> <li>GetClass(pf,id)\uff08L62\u2013L67\uff09\u540c\u7406\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#5-getmethod-runtimel69l73","title":"5. GetMethod\uff1a\u76f4\u63a5\u8d70 runtime\uff08L69\u2013L73\uff09","text":"<ul> <li>\u4e0d\u505a ETS \u5305\u88c5\uff0c\u76f4\u63a5\u8fd4\u56de <code>Method*</code>\uff1a<code>classLinker_-&gt;GetMethod(pf, id, ctx, errorHandler)</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#6-ets-specificgetasyncimplmethodl75l92","title":"6. ETS-specific\uff1aGetAsyncImplMethod\uff08L75\u2013L92\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#61-l78l83","title":"6.1 \u6ce8\u89e3\u89e3\u6790\uff08L78\u2013L83\uff09","text":"<ul> <li><code>asyncAnnId = EtsAnnotation::FindAsyncAnnotation(method)</code>\uff0c\u5e76\u65ad\u8a00\u6709\u6548\u3002</li> <li>\u7528 <code>AnnotationDataAccessor</code> \u8bfb\u53d6\u7b2c 0 \u4e2a element \u7684 scalar value\uff0c\u53d6\u51fa <code>implMethodId</code>\uff08EntityId\uff09\u3002</li> <li><code>ctx = method-&gt;GetClass()-&gt;GetLoadContext()</code>\uff1aimpl method \u6309 \u201c\u5f53\u524d\u65b9\u6cd5\u6240\u5c5e\u7c7b\u7684\u52a0\u8f7d\u57df\u201d \u89e3\u6790\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#62-impl-methodl84l90","title":"6.2 \u89e3\u6790 impl method\uff08L84\u2013L90\uff09","text":"<ul> <li><code>result = GetMethod(pf, implMethodId, ctx)</code>\u3002</li> <li>\u82e5\u4e3a\u7a7a\uff1a</li> <li>\u7528 <code>MethodDataAccessor</code> \u62ff <code>GetFullName()</code> \u62fc message</li> <li>\u629b ETS \u5f02\u5e38\uff1a<code>LINKER_UNRESOLVED_METHOD_ERROR</code></li> </ul> <p>\u7ed3\u8bba\uff1aasync \u6ce8\u89e3\u7684\u8bed\u4e49\u662f\u201c\u58f0\u660e\u5f0f\u5730\u6307\u5411\u53e6\u4e00\u4e2a impl method\u201d\uff0c\u89e3\u6790\u5931\u8d25\u5c5e\u4e8e\u94fe\u63a5\u9519\u8bef\uff0c\u5e76\u4e14\u6309 ETS \u7684\u5f02\u5e38\u7c7b\u578b\u4e0a\u629b\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.cpp/#_1","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>ETS extension \u5165\u53e3\u70b9/\u9519\u8bef\u6620\u5c04\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</li> <li>ClassLinker GetMethod\uff1aFileNotes/runtime_class_linker.cpp</li> <li>async \u6ce8\u89e3\u6570\u636e\u7ed3\u6784\uff1a<code>plugins/ets/runtime/ets_annotation.h</code>\uff08\u82e5\u540e\u7eed\u9700\u8981\u53ef\u7eb3\u5165 03 \u52a8\u6001\u53d1\u73b0\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/","title":"<code>plugins/ets/runtime/ets_class_linker.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cETS fa\u00e7ade\uff1a\u628a ClassLinker \u53d8\u6210 EtsClass API\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u89c4\u6a21\uff1a75 \u884c \u76ee\u6807\uff1a\u89e3\u91ca ETS \u4e3a\u4f55\u9700\u8981\u4e00\u4e2a\u201c\u95e8\u9762\uff08fa\u00e7ade\uff09\u7c7b\u201d\u5305\u88f9 <code>ClassLinker</code>\uff1a\u5bf9\u5916\u66b4\u9732 <code>EtsClass*</code> \u8bed\u4e49\u3001\u9690\u85cf <code>ClassLinkerExtension</code> \u8f6c\u6362\uff0c\u5e76\u8865\u5145 ETS \u7279\u6709\u7684 async \u6ce8\u89e3\u89e3\u6790\u5165\u53e3\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/#0-include-l19l29","title":"0. include \u4e0e\u524d\u7f6e\u58f0\u660e\uff08L19\u2013L29\uff09","text":"<ul> <li>\u5f15\u5165 <code>ets_class_root.h</code>\uff08ETS \u81ea\u5df1\u7684 root \u679a\u4e3e\uff09\u3002</li> <li>\u5f15\u5165 panda smart pointers/string/containers\uff08Expected/PandaUniquePtr/PandaString \u7b49\uff09\u3002</li> <li>\u524d\u7f6e\u58f0\u660e core runtime \u7c7b\u578b\uff1a<code>Method/ClassLinker/ClassLinkerContext/ClassLinkerErrorHandler</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/#1-etsclasslinker-apil37l55","title":"1. <code>EtsClassLinker</code>\uff1a\u5bf9\u5916 API\uff08L37\u2013L55\uff09","text":"<ul> <li>L39\uff1a<code>Create(ClassLinker*) -&gt; Expected&lt;PandaUniquePtr&lt;EtsClassLinker&gt;, PandaString&gt;</code></li> <li>\u91c7\u7528 Expected \u8fd4\u56de\uff0c\u4fbf\u4e8e\u672a\u6765\u6269\u5c55\u9519\u8bef\u8def\u5f84\uff08\u5f53\u524d\u5b9e\u73b0\u57fa\u672c\u4e0d\u4f1a\u5931\u8d25\uff09\u3002</li> <li>L42\u2013L43\uff1a<code>Initialize()</code>\uff1a\u628a <code>classLinker_</code> \u4e2d ETS extension \u7f13\u5b58\u5230 <code>ext_</code>\uff08\u89c1 cpp\uff09\u3002</li> <li>L44\uff1a<code>InitializeClass(EtsCoroutine*, EtsClass*)</code>\uff1a\u5bf9\u5916\u628a runtime <code>InitializeClass</code> \u66b4\u9732\u7ed9 ETS\u3002</li> <li>L45\uff1a<code>GetClassRoot(EtsClassRoot)</code>\uff1a\u8fd4\u56de <code>EtsClass*</code>\u3002</li> <li>L46\u2013L53\uff1a\u4e24\u79cd GetClass\uff08\u6309 name \u6216\u6309 pf+id\uff09\u4e0e <code>GetMethod</code>\uff08\u6309 pf+id\uff09\u3002</li> <li>L54\uff1a<code>GetAsyncImplMethod(Method*, EtsCoroutine*)</code>\uff1aETS async \u6ce8\u89e3\u89e3\u6790\u5165\u53e3\uff08\u975e\u5e38 ETS-specific\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/#2-l64l71","title":"2. \u5185\u90e8\u72b6\u6001\u4e0e\u8bed\u4e49\uff08L64\u2013L71\uff09","text":"<ul> <li><code>classLinker_</code>\uff1a\u5e95\u5c42 runtime <code>ClassLinker*</code>\uff08\u4e0d owned\uff09\u3002</li> <li><code>ext_</code>\uff1a<code>EtsClassLinkerExtension*</code>\uff08\u4e0d owned\uff09\uff0c\u7531 <code>Initialize()</code> \u89e3\u6790\u5f97\u5230\u3002</li> <li><code>friend class mem::Allocator</code>\uff1a\u5141\u8bb8 <code>MakePandaUnique</code>/allocator \u6784\u9020\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/#_1","title":"\u7ed3\u8bba","text":"<p><code>EtsClassLinker</code> \u4e0d\u662f ClassLinker \u7684\u201c\u66ff\u4ee3\u54c1\u201d\uff0c\u800c\u662f ETS \u7684\u7c7b\u578b\u7cfb\u7edf\u89c6\u89d2\uff1a - \u8f93\u5165/\u8f93\u51fa\u5c3d\u53ef\u80fd\u662f <code>EtsClass*</code>\uff0c\u628a <code>Class*</code> \u7684\u7ec6\u8282\u85cf\u5230 extension \u8f6c\u6362\u91cc\u3002 - \u63d0\u4f9b\u4e00\u4e2a\u989d\u5916\u7684 ETS-specific \u5de5\u5177\u5165\u53e3\uff1aasync \u6ce8\u89e3 \u2192 impl method\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker.h/#_2","title":"\u8bc1\u636e\u94fe","text":"<ul> <li>\u5b9e\u73b0\uff1aFileNotes/plugins_ets_runtime_ets_class_linker.cpp</li> <li>ETS extension\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/","title":"<code>plugins/ets/runtime/ets_class_linker_context.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS AppContext \u7684\u6838\u5fc3\u5b9e\u73b0\uff1a\u628a \u201cdescriptor\u2192Class\u201d \u7684\u67e5\u627e/\u52a0\u8f7d\uff0c\u62c6\u6210 native \u5feb\u8def\u5f84\uff08\u8d70 linker chain\uff09 \u4e0e managed \u6162\u8def\u5f84\uff08\u8c03\u7528 RuntimeLinker.loadClass\uff09\u3002 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 332 \u884c\uff08\u4e3b\u8981\u903b\u8f91\u96c6\u4e2d\u5728 LoadClass \u4e0e\u94fe\u5f0f\u67e5\u627e/\u679a\u4e3e\uff09\u3002</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#ets-loadclassnative-managed","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aETS LoadClass\uff08native \u4f18\u5148\u94fe\u5f0f\u89e3\u6790 \u2192 managed \u56de\u9000\uff09","text":"<pre><code>flowchart TD\n  A[\"EtsClassLinkerContext::LoadClass(descriptor)\"] --&gt; B{\"FindClass \u7f13\u5b58\u547d\u4e2d\uff1f\"}\n  B --&gt;|\u662f| R1[\"\u8fd4\u56de Class*\"]\n  B --&gt;|\u5426| C[\"TryLoadingClassFromNative\\n(\u6cbf RuntimeLinker parent/shared libs \u94fe)\"]\n  C --&gt; D{\"\u627e\u5230 Class* \u6216\u9047\u5230\u975e CNFE \u9519\u8bef\uff1f\"}\n  D --&gt;|\u662f| R2[\"\u8fd4\u56de Class* \u6216\u4f20\u64ad\u9519\u8bef\"]\n  D --&gt;|\u5426| E{\"\u5141\u8bb8\u8fdb\u5165 managed\uff1f\\n(thread is managed &amp;&amp; coro!=null)\"}\n  E --&gt;|\u5426| R3[\"\u4e0a\u62a5 CLASS_NOT_FOUND\\n\u8fd4\u56de nullptr\"]\n  E --&gt;|\u662f| F[\"\u8c03\u7528 managed RuntimeLinker.loadClass(final)\\n(\u6784\u9020 args)\"]\n  F --&gt; G{\"\u8fd4\u56de class object / exception\"}\n  G --&gt;|class object| R4[\"\u8f6c\u4e3a runtime Class* \u8fd4\u56de\"]\n  G --&gt;|exception| R5[\"\u4e0a\u62a5 CLASS_NOT_FOUND\\n\u8fd4\u56de nullptr\"]</code></pre>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#1-decoratorerrorhandlerl31l67","title":"1. \u91cd\u8981\u5185\u90e8\u5de5\u5177\uff1aDecoratorErrorHandler\uff08L31\u2013L67\uff09","text":"<p><code>DecoratorErrorHandler</code> \u5305\u88c5\u4e00\u4e2a\u771f\u5b9e <code>ClassLinkerErrorHandler*</code>\uff0c\u7528\u4e8e\uff1a - \u6355\u83b7\u6700\u540e\u4e00\u6b21\u9519\u8bef\uff08<code>lastError_</code>\uff09 - \u5224\u65ad/\u8bfb\u53d6\u9519\u8bef\uff08HasError/GetErrorCode\uff09 - \u4f20\u64ad\u9519\u8bef\u5230\u5916\u90e8 handler\uff08PropagateError\uff09 - \u6e05\u7a7a\u9519\u8bef\uff08ClearError\uff09</p> <p>\u5173\u952e\u7528\u9014\uff1a\u5728 native \u94fe\u5f0f\u5c1d\u8bd5\u8fc7\u7a0b\u4e2d\uff1a - \u9047\u5230 <code>CLASS_NOT_FOUND</code>\uff1a\u8ba4\u4e3a\u201c\u53ef\u4ee5\u7ee7\u7eed\u5411\u4e0b\u59d4\u6258/\u56de\u9000\u201d\uff0c\u56e0\u6b64\u6e05\u7a7a\u9519\u8bef\uff08L84\u2013L87\uff09 - \u9047\u5230\u5176\u5b83\u9519\u8bef\uff1a\u7acb\u5373\u4f20\u64ad\u5e76\u505c\u6b62\u56de\u9000\uff08L87\u2013L90\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#2-reportclassnotfoundl69l76","title":"2. ReportClassNotFound\uff08L69\u2013L76\uff09","text":"<p>\u5982\u679c errorHandler \u975e\u7a7a\uff0c\u4e0a\u62a5 <code>CLASS_NOT_FOUND</code> + \u201cCannot find class \u201d\u3002"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#3-bootcontext-loadfrombootcontextl78l93","title":"3. BootContext \u52a0\u8f7d\u5c01\u88c5\uff1aLoadFromBootContext\uff08L78\u2013L93\uff09","text":"<p>\u8bed\u4e49\uff1a\u5f53 ctx \u662f boot context \u65f6\uff0c\u76f4\u63a5\u8c03\u7528 core <code>ClassLinker::GetClass(descriptor, true, ctx, &amp;decoratorHandler)</code>\uff1a - \u5982\u679c\u51fa\u73b0\u9519\u8bef\uff1a   - <code>CLASS_NOT_FOUND</code>\uff1a\u6e05\u7a7a\uff08\u5141\u8bb8\u540e\u7eed\u201c\u59d4\u6258/\u56de\u9000\u201d\uff09   - \u5176\u5b83\u9519\u8bef\uff1a\u4f20\u64ad\uff08\u8bf4\u660e\u52a0\u8f7d\u8fc7\u7a0b\u51fa\u9519\uff0c\u4f8b\u5982 link/verify/oom \u7b49\uff09</p> <p>\u8fd9\u4f7f\u5f97 ETS app context \u4e5f\u80fd\u201c\u501f\u7528\u201d boot context \u7684\u67e5\u627e/\u52a0\u8f7d\u80fd\u529b\uff0c\u5e76\u7edf\u4e00 error \u5904\u7406\u7b56\u7565\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#4-tryloadingclassinchain-runtimelinker-native-l95l165","title":"4. TryLoadingClassInChain\uff1a\u6cbf RuntimeLinker \u94fe\u505a native \u89e3\u6790\uff08L95\u2013L165\uff09","text":"<p>\u8fd9\u662f\u672c\u6587\u4ef6\u6700\u5173\u952e\u7684\u201c\u95ed\u73af\u70b9\u201d\uff1a\u628a managed \u94fe\u5f0f class loader \u903b\u8f91\u90e8\u5206\u590d\u523b\u5230 native \u5c42\uff0c\u51cf\u5c11\u8c03\u7528 managed \u7684\u6b21\u6570\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#41","title":"4.1 \u57fa\u672c\u7ed3\u6784","text":"<p>\u8f93\u5165\uff1a - descriptor - DecoratorErrorHandler - ctx\uff08\u5f53\u524d ClassLinkerContext\uff0c\u53ef\u80fd\u662f boot \u6216 ETS app context\uff09 - \u8f93\u51fa <code>Class** klass</code>\uff08\u521d\u59cb\u5fc5\u987b\u4e3a nullptr\uff09</p> <p>\u8f85\u52a9\uff1a - <code>isClassFound(cls)</code>\uff1a\u53ea\u8981 cls \u975e\u7a7a \u6216 errorHandler \u5df2\u8bb0\u5f55\u9519\u8bef\uff0c\u5c31\u7b97\u201c\u5df2\u5f97\u5230\u7ed3\u8bba\u201d\uff08L102\u2013L103\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#42-boot-context-l104l108","title":"4.2 boot context \u5206\u652f\uff08L104\u2013L108\uff09","text":"<p>\u76f4\u63a5 <code>LoadFromBootContext</code>\uff0c\u5e76\u8fd4\u56de true\uff08\u94fe\u904d\u5386\u6210\u529f\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#43-boot-context-l110l118","title":"4.3 \u975e boot context \u7684\u524d\u7f6e\u7ea6\u675f\uff08L110\u2013L118\uff09","text":"<p>\u5f3a\u5047\u8bbe\uff1a\u6240\u6709\u975e boot context \u90fd\u662f <code>EtsClassLinkerContext</code>\uff1a - <code>EtsClassLinkerContext::FromCoreType(ctx)</code>\uff08L111\uff09 - \u53d6 <code>runtimeLinker</code>\uff08L112\uff09 - \u5982\u679c runtimeLinker \u7684 class \u4e0d\u662f <code>coreAbcRuntimeLinker</code> \u6216 <code>coreMemoryRuntimeLinker</code>\uff1a   - \u8ba4\u4e3a\u65e0\u6cd5\u5728 native \u4fa7\u904d\u5386\u94fe \u2192 \u8fd4\u56de false\uff0c\u5fc5\u987b\u8c03\u7528 managed \u5b9e\u73b0\uff08L114\u2013L118\uff09</p> <p>\u8fd9\u4f53\u73b0\u4e86\u4e00\u4e2a\u201c\u5b89\u5168\u767d\u540d\u5355\u201d\uff1a\u53ea\u6709\u6838\u5fc3 runtime linker \u7c7b\u578b\u5141\u8bb8 native \u590d\u523b\u903b\u8f91\uff0c\u5176\u4f59\u7528\u6237\u81ea\u5b9a\u4e49 linker \u5fc5\u987b\u8d70 managed\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#44-parent-chainl120l133","title":"4.4 parent chain\uff08L120\u2013L133\uff09","text":"<ul> <li><code>abcRuntimeLinker-&gt;GetParentLinker()</code> \u2192 parentContext</li> <li>\u9012\u5f52 <code>TryLoadingClassInChain</code>\uff1a</li> <li>\u5982\u679c\u9012\u5f52\u8fd4\u56de false\uff1a\u5fc5\u987b\u8d70 managed\uff08\u94fe\u904d\u5386\u5931\u8d25\uff09</li> <li>\u5982\u679c parent \u5df2\u627e\u5230 class \u6216\u6709\u9519\u8bef\uff1a\u76f4\u63a5\u8fd4\u56de true\uff08\u4e0d\u518d\u7ee7\u7eed\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#45-shared-libraries-linkersl133l158","title":"4.5 shared libraries linkers\uff08L133\u2013L158\uff09","text":"<p>\u91cd\u590d managed \u4fa7 <code>findAndLoadClass</code> \u7684\u903b\u8f91\uff1a - \u679a\u4e3e <code>sharedLibraryRuntimeLinkers</code>\uff08\u6ce8\u91ca\u8bf4\u660e\u7406\u8bba\u4e0a\u5b58\u5728 undefined\uff0c\u4f46\u6784\u9020\u65f6\u5df2\u4fdd\u8bc1\u975e\u7a7a\uff09 - \u5bf9\u6bcf\u4e2a shared linker\uff1a   - \u540c\u6837\u767d\u540d\u5355\u68c0\u67e5   - \u9012\u5f52 TryLoadingClassInChain   - \u82e5\u627e\u5230/\u6709\u9519\u8bef\uff1a\u8fd4\u56de true</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#46-context-filesl160l164","title":"4.6 \u5f53\u524d context \u81ea\u5df1\u7684 files\uff08L160\u2013L164\uff09","text":"<p>\u5982\u679c\u94fe\u90fd\u6ca1\u627e\u5230\u4e14\u672a\u6709\u9519\u8bef\uff1a\u8c03\u7528 <code>etsLinkerContext-&gt;FindAndLoadClass(descriptor, &amp;decoratorHandler)</code>\u3002 \u6700\u540e\u8fd4\u56de true\uff08\u8868\u793a\u94fe\u904d\u5386\u201c\u903b\u8f91\u4e0a\u6210\u529f\u5b8c\u6210\u201d\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#5-tryenumeratepandafilesinchainl167l197","title":"5. TryEnumeratePandaFilesInChain\uff08L167\u2013L197\uff09","text":"<p>\u76ee\u7684\uff1a\u6cbf RuntimeLinker parent chain \u679a\u4e3e\u6240\u6709 panda files\uff0c\u7528\u4e8e\uff1a - AOT class context\u3001dump\u3001\u8c03\u8bd5\u5de5\u5177\u7b49</p> <p>\u903b\u8f91\uff1a - boot context\uff1a\u76f4\u63a5 <code>ctx-&gt;EnumeratePandaFiles(cb)</code>\uff08L173\u2013L175\uff09 - \u975e boot\uff1a   - \u8981\u6c42 runtimeLinker \u662f <code>coreAbcRuntimeLinker</code>\uff08\u5426\u5219\u8fd4\u56de false\uff0c\u8868\u793a\u65e0\u6cd5\u904d\u5386\uff09   - \u9012\u5f52\u904d\u5386 parentContext   - \u7136\u540e\u518d\u679a\u4e3e\u5f53\u524d ctx \u81ea\u5df1\u7684 panda files\uff08L195\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#6-etsclasslinkercontextloadclassl201l244","title":"6. EtsClassLinkerContext::LoadClass\uff08L201\u2013L244\uff09","text":"<p>\u8fd9\u662f ETS app context \u5bf9 core <code>GetClass</code> \u7684\u66ff\u4ee3\u5165\u53e3\uff08\u88ab <code>ClassLinker::GetClass</code> \u7684\u975e boot \u5206\u652f\u8c03\u7528\uff09\u3002</p> <p>\u6b65\u9aa4\uff1a 1) \u5148\u67e5 <code>FindClass(descriptor)</code>\uff08context \u5185 cache\uff09\uff08L204\u2013L207\uff09 2) \u65ad\u8a00 GC/MutatorLock \u72b6\u6001\uff08L209\uff09\uff1a    - \u82e5 GC \u5728\u8dd1\uff0c\u5fc5\u987b\u6301\u6709 mutator lock\uff08\u907f\u514d\u5728 GC \u5e76\u53d1\u671f\u968f\u610f\u89e6\u53d1\u52a0\u8f7d\uff09 3) <code>TryLoadingClassFromNative(descriptor, errorHandler, &amp;klass)</code>\uff08L211\u2013L214\uff09\uff1a    - \u5982\u679c succeeded\uff08\u65e0\u8bba klass \u662f\u5426\u627e\u5230/\u662f\u5426\u9519\u8bef\uff09\u2192 \u76f4\u63a5\u8fd4\u56de klass 4) \u82e5 native \u5931\u8d25\uff1a\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u8c03\u7528 managed\uff1a    - <code>EtsCoroutine::GetCurrent()</code> \u4e3a\u7a7a\u6216\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f managed code \u2192 \u7981\u6b62\u8c03\u7528 managed\uff08L218\u2013L222\uff09      - \u4f8b\u5982 JIT/AOT \u7ebf\u7a0b\uff1a\u53ea\u80fd\u62a5 CLASS_NOT_FOUND 5) \u6784\u9020 managed \u8c03\u7528\u53c2\u6570\uff1a    - <code>clsName = ClassHelper::GetName(descriptor)</code> \u8f6c\u6210 ETS string\uff08L224\u2013L227\uff09    - <code>args = { runtimeLinker, etsClsName, nullptr }</code>\uff08L233\uff09 6) \u8c03\u7528 managed <code>RuntimeLinker.loadClass</code>\uff08L236\u2013L238\uff09\uff1a    - \u65b9\u6cd5\u6765\u81ea <code>PlatformTypes(coro)-&gt;coreRuntimeLinkerLoadClass</code>\uff08\u8bf4\u660e\u8fd9\u4e2a\u65b9\u6cd5\u5728\u5e73\u53f0\u7c7b\u578b\u8868\u4e2d\u56fa\u5b9a\uff09    - \u65e0\u5f02\u5e38\uff1a\u628a\u8fd4\u56de\u7684 class object \u8f6c\u6210 <code>Class*</code>\uff08L239\uff09    - \u6709\u5f02\u5e38\uff1aReportClassNotFound + return nullptr\uff08L242\u2013L243\uff09</p> <p>\u7ed3\u8bba\uff1aETS \u7684\u7c7b\u52a0\u8f7d\u5141\u8bb8\u201cmanaged \u9012\u5f52\u201d\u53ea\u53d1\u751f\u5728 managed \u7ebf\u7a0b\uff0c\u5426\u5219\u5fc5\u987b\u8d70 native \u6216\u5931\u8d25\u3002 \u8fd9\u662f\u9632\u6b62 VM \u5185\u90e8\u7ebf\u7a0b\uff08JIT/AOT/GC\uff09\u610f\u5916 re-enter managed runtime \u7684\u5173\u952e\u9632\u7ebf\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#7-enumeratepandafilesimplenumeratepandafilesl246l269","title":"7. EnumeratePandaFilesImpl/EnumeratePandaFiles\uff08L246\u2013L269\uff09","text":"<p><code>EnumeratePandaFilesImpl</code>\uff1a - ASSERT \u6301\u6709 ETS mutator lock\uff08L248\uff09 - \u4ec5\u5f53 runtimeLinker \u662f AbcRuntimeLinker \u5b9e\u4f8b\u65f6\u624d\u679a\u4e3e\uff08L251\u2013L253\uff09 - \u4ece runtimeLinker \u83b7\u53d6 <code>AbcFiles</code> \u5217\u8868\uff0c\u9010\u4e2a\u53d6\u51fa <code>EtsAbcFile-&gt;GetPandaFile()</code> \u5e76\u56de\u8c03\uff08L254\u2013L263\uff09</p> <p><code>EnumeratePandaFiles</code> \u7b80\u5355\u8f6c\u53d1\u5230 Impl\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#8-enumeratepandafilesinchainl271l277","title":"8. EnumeratePandaFilesInChain\uff08L271\u2013L277\uff09","text":"<p>\u8c03\u7528 <code>TryEnumeratePandaFilesInChain(this, cb)</code> \u5e76 ASSERT \u6210\u529f\uff1a - \u6ce8\u91ca\u8bf4\u660e\uff1aAbcRuntimeLinker \u662f\u6240\u6709\u7528\u6237\u81ea\u5b9a\u4e49 linker \u7684\u57fa\u7c7b\uff0c\u56e0\u6b64\u94fe\u904d\u5386\u5e94\u5f53\u603b\u80fd\u6210\u7acb\uff08\u5728 ETS \u7684\u8fd0\u884c\u65f6\u6a21\u578b\u4e0b\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#9-findandloadclassl279l291","title":"9. FindAndLoadClass\uff08L279\u2013L291\uff09","text":"<p>\u5728\u5f53\u524d context \u7684 panda files \u4e2d\u67e5\u627e\u5e76\u52a0\u8f7d\uff1a - <code>pf.GetClassId(descriptor)</code> \u547d\u4e2d\u4e14\u975e external \u2192 <code>Runtime::GetCurrent()-&gt;GetClassLinker()-&gt;LoadClass(pf, classId, this, errorHandler)</code> - \u4e00\u65e6\u52a0\u8f7d\u6210\u529f/\u5931\u8d25\uff08\u5373\u5c1d\u8bd5\u8fc7\uff09\uff0c\u8fd4\u56de false \u505c\u6b62\u679a\u4e3e\uff08L288\u2013L289\uff09</p> <p>\u8fd9\u662f native \u94fe\u8def\u201c\u843d\u5230\u771f\u6b63 class_linker.cpp \u52a0\u8f7d\u7ba1\u7ebf\u201d\u7684\u5165\u53e3\u70b9\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#10-tryloadingclassfromnativel293l309","title":"10. TryLoadingClassFromNative\uff08L293\u2013L309\uff09","text":"<p>\u628a <code>TryLoadingClassInChain</code> \u5305\u4e00\u5c42\uff1a - \u5982\u679c DecoratorErrorHandler \u6355\u83b7\u5230\u9519\u8bef\uff1a\u4f20\u64ad\uff08L301\u2013L305\uff09 - \u5982\u679c\u94fe\u904d\u5386\u6210\u529f\u4f46\u6ca1\u627e\u5230 class\uff1aReportClassNotFound\uff08L305\u2013L307\uff09 - \u8fd4\u56de succeeded\uff08\u94fe\u662f\u5426\u53ef\u904d\u5386\uff1b\u4e0d\u53ef\u904d\u5386\u610f\u5473\u7740\u5fc5\u987b\u8d70 managed\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#11-weak-refl311l320","title":"11. \u6790\u6784\uff1a\u91ca\u653e weak ref\uff08L311\u2013L320\uff09","text":"<p>\u6790\u6784\u65f6\uff1a - \u65ad\u8a00 <code>ClassLinker</code> \u9500\u6bc1\u65e9\u4e8e <code>PandaVM</code>\uff08\u56e0\u6b64\u53ef\u5b89\u5168\u8bbf\u95ee <code>PandaEtsVM::GetCurrent()</code>\uff09 - \u4ece global object storage \u79fb\u9664 <code>refToLinker_</code>\uff08\u907f\u514d\u6cc4\u6f0f\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp/#12-fromcoretypel322l329","title":"12. FromCoreType\uff08L322\u2013L329\uff09","text":"<p>\u5f3a\u65ad\u8a00\uff1a - ctx \u975e\u7a7a\u3001\u8bed\u8a00 ETS\u3001\u4e14\u975e boot context - \u7136\u540e reinterpret_cast \u4e3a <code>EtsClassLinkerContext*</code></p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/","title":"<code>plugins/ets/runtime/ets_class_linker_context.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 <code>ClassLinkerContext</code> \u5b9e\u73b0\uff1a\u628a\u201c\u7c7b\u52a0\u8f7d\u57df\u201d\u7ed1\u5b9a\u5230\u4e00\u4e2a managed RuntimeLinker\uff08AbcRuntimeLinker \u7b49\uff09\uff0c\u5e76\u63d0\u4f9b\uff1aLoadClass/\u679a\u4e3e panda files/\u94fe\u5f0f\u679a\u4e3e/\u83b7\u53d6 file paths\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#1-context-runtimelinker-l33l39","title":"1. \u5173\u952e\u8bbe\u8ba1\uff1acontext \u6301\u6709 RuntimeLinker \u7684\u5f31\u5f15\u7528\uff08L33\u2013L39\uff09","text":"<p>\u6784\u9020\u51fd\u6570 <code>EtsClassLinkerContext(EtsRuntimeLinker *runtimeLinker)</code>\uff1a - \u7ee7\u627f <code>ClassLinkerContext(SourceLang::ETS)</code>\uff08L33\uff09 - \u901a\u8fc7 <code>PandaEtsVM::GetCurrent()-&gt;GetGlobalObjectStorage()</code> \u83b7\u53d6\u5168\u5c40\u5bf9\u8c61\u5b58\u50a8 - \u628a <code>runtimeLinker-&gt;GetCoreType()</code> \u4ee5 WEAK \u5f15\u7528 \u5b58\u5165 object storage\uff08L35\u2013L38\uff09   - \u76ee\u7684\uff1a\u4e0d\u963b\u6b62 managed RuntimeLinker \u88ab GC \u56de\u6536\uff08context \u4e0d\u5e94\u6210\u4e3a\u5f3a\u6839\uff09   - \u540e\u7eed\u901a\u8fc7 <code>GetRuntimeLinker()</code> \u52a8\u6001\u89e3\u5f15\u7528\u53d6\u56de</p> <p>\u6790\u6784\uff08L44\uff09\u4f1a\u628a\u8be5 weak ref \u4ece object storage \u79fb\u9664\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#2-overrideloadclass-panda-files-l48l67","title":"2. \u5bf9\u5916 override\uff1aLoadClass + panda files \u679a\u4e3e\uff08L48\u2013L67\uff09","text":"<ul> <li><code>LoadClass(descriptor, needCopyDescriptor, errorHandler)</code> override\uff08L48\u2013L50\uff09\uff1a</li> <li>\u8bed\u4e49\uff1a\u6309\u5bf9\u5e94 RuntimeLinker \u7684\u52a0\u8f7d\u89c4\u5219\u89e3\u6790\u7c7b\uff08native \u5148\u884c\uff0c\u5fc5\u8981\u65f6\u8c03\u7528 managed \u5b9e\u73b0\uff09\u3002</li> <li><code>EnumeratePandaFiles(cb)</code>\uff08L52\uff09\uff1a</li> <li>\u679a\u4e3e\u5f53\u524d context \u5bf9\u5e94\u7684 abc files\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</li> <li><code>EnumeratePandaFilesInChain(cb)</code>\uff08L54\uff09\uff1a</li> <li>\u94fe\u5f0f\u679a\u4e3e\uff1a\u6cbf parent linker chain \u5411\u4e0a\u904d\u5386\u540e\u518d\u679a\u4e3e\u5f53\u524d context\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</li> <li><code>GetPandaFilePaths()</code>\uff08L56\u2013L64\uff09\uff1a</li> <li>\u57fa\u4e8e <code>EnumeratePandaFiles</code> \u628a <code>pf.GetFilename()</code> \u6536\u96c6\u6210\u5217\u8868\uff08\u4f9b dump/AOT class context\uff09\u3002</li> <li><code>FindAndLoadClass(descriptor, errorHandler)</code>\uff08L66\u2013L67\uff09\uff1a</li> <li>\u5728\u5f53\u524d context \u7684 panda files \u4e2d\u67e5\u627e\u5e76\u76f4\u63a5\u8c03\u7528 core <code>ClassLinker::LoadClass(pf, classId, this, handler)</code>\u3002</li> <li>\u8fd9\u662f native \u8def\u5f84\u201c\u6700\u540e\u4e00\u6b65\u5b9e\u9645\u52a0\u8f7d\u201d\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#3-getruntimelinker-weak-ref-l69l74","title":"3. GetRuntimeLinker\uff1a\u4ece weak ref \u89e3\u5f15\u7528\uff08L69\u2013L74\uff09","text":"<p><code>GetRuntimeLinker()</code>\uff1a - \u4ece global object storage \u53d6\u56de <code>refToLinker_</code> \u6307\u5411\u7684 core \u5bf9\u8c61 - <code>EtsRuntimeLinker::FromCoreType(linker)</code> \u8f6c\u56de ETS \u5305\u88c5\u7c7b\u578b - ASSERT linker \u975e\u7a7a\uff08\u610f\u5473\u7740\uff1acontext \u88ab\u4f7f\u7528\u65f6 RuntimeLinker \u5fc5\u987b\u4ecd\u7136\u5b58\u6d3b\uff09</p> <p>\u8fd9\u5957\u8bbe\u8ba1\u628a\u201ccontext \u751f\u547d\u5468\u671f\u201d\u4e0e\u201cmanaged RuntimeLinker \u751f\u547d\u5468\u671f\u201d\u89e3\u8026\uff1a - context \u4e0d\u5f3a\u6301\u6709 linker - \u4f46\u5728\u4f7f\u7528\u65f6\u8981\u6c42 linker \u5b58\u6d3b\uff08\u5426\u5219\u5c5e\u4e8e\u903b\u8f91\u9519\u8bef\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#4-abcfilesmutex_l76l98","title":"4. \u5e76\u53d1\u4fdd\u62a4\uff1aabcFilesMutex_\uff08L76\u2013L98\uff09","text":"<ul> <li><code>GetAbcFilesMutex()</code> \u8fd4\u56de <code>abcFilesMutex_</code>\uff08\u9012\u5f52 mutex\uff09\u3002</li> <li>\u7ed3\u5408 <code>.cpp</code> \u4e2d\u5bf9 <code>GetAbcFiles()</code> \u7684\u8bbf\u95ee\uff0c\u53ef\u63a8\u65ad\uff1a abc files \u5217\u8868\u5728 ETS \u4fa7\u53ef\u80fd\u5e76\u53d1\u66f4\u65b0\uff0c\u9700\u8981\u4e00\u4e2a\u4e92\u65a5\u91cf\u4fdd\u62a4\u904d\u5386/\u4fee\u6539\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#5-l81l93","title":"5. \u79c1\u6709\u8f85\u52a9\uff08L81\u2013L93\uff09","text":"<ul> <li><code>TryLoadingClassFromNative(...)</code>\uff1a\u5c1d\u8bd5\u6cbf AbcRuntimeLinker chain \u627e/\u52a0\u8f7d\u7c7b\uff08\u4e0d\u8c03\u7528 managed \u5b9e\u73b0\uff09\u3002</li> <li><code>EnumeratePandaFilesImpl(cb)</code>\uff1a\u5b9e\u9645\u679a\u4e3e\u5b9e\u73b0\uff0c\u4f9b <code>EnumeratePandaFiles</code> \u4e0e <code>FindAndLoadClass</code> \u590d\u7528\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_context.h/#6-l96l98","title":"6. \u5b57\u6bb5\uff08L96\u2013L98\uff09","text":"<ul> <li><code>abcFilesMutex_</code>\uff1a\u4fdd\u62a4 abc files \u76f8\u5173\u8bbf\u95ee\uff08\u9012\u5f52\uff0c\u5339\u914d\u94fe\u5f0f\u904d\u5386\u53ef\u80fd\u7684\u91cd\u5165\uff09\u3002</li> <li><code>refToLinker_</code>\uff1aweak ref \u6307\u9488\uff08object storage \u6761\u76ee\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/","title":"<code>plugins/ets/runtime/ets_class_linker_extension.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u529f\u80fd\u6bb5\u843d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS <code>ClassLinkerExtension</code> \u5b9e\u73b0\uff1aroots \u521b\u5efa\u3001class object \u5206\u914d\u4e0e\u521d\u59cb\u5316\u3001native \u5165\u53e3\u70b9\u7b56\u7565\u3001builtin classes \u6807\u8bb0\u3001app context \u521b\u5efa\u3001common-context \u63a8\u5bfc\u3002 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 836 \u884c\uff08\u6309\u201c\u529f\u80fd\u6bb5\u843d\u201d\u7ec4\u7ec7\u9010\u884c\u7b14\u8bb0\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#0-include-l16l39","title":"0. include \u4e0e\u4e3b\u9898\uff08L16\u2013L39\uff09","text":"<p>\u53ef\u4ee5\u628a\u8fd9\u4e9b include \u5206\u6210\u4e09\u7c7b\uff1a - ClassLoading \u4e3b\u94fe\uff1a<code>ets_class_linker_extension.h</code>\u3001<code>ets_class_linker_context.h</code>\u3001<code>class_linker-inl.h</code>\u3001<code>panda_vm.h</code> - ETS \u7c7b\u578b\u7cfb\u7edf\uff1a<code>ets_method.h</code>\u3001<code>ets_platform_types.h</code>\u3001<code>ets_panda_file_items.h</code> - ANI/native\uff1a<code>ani_helpers.h</code> + native entrypoint \u83b7\u53d6</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#1-native-etsnapitype-l41l73","title":"1. Native \u8c03\u7528\u7c7b\u578b\uff1aEtsNapiType + \u6ce8\u89e3\u8bc6\u522b\uff08L41\u2013L73\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#11-etsnapitypel42l53","title":"1.1 EtsNapiType\uff08L42\u2013L53\uff09","text":"<p>\u4e09\u79cd native \u6a21\u5f0f\uff1a - GENERIC\uff1a\u5207 coroutine \u5230 native mode\uff08\u5141\u8bb8 GC\uff09\uff0c\u5e76\u5728\u53c2\u6570\u524d\u8ffd\u52a0 NAPI env + this/class - FAST\uff1a\u4fdd\u6301 managed mode\uff08\u7981\u6b62 GC\uff09\uff0c\u4ecd\u8ffd\u52a0 env+this/class\uff1bnative \u4ee3\u7801\u7981\u6b62\u89e6\u53d1\u5206\u914d - CRITICAL\uff1a\u4fdd\u6301 managed mode\uff08\u7981\u6b62 GC\uff09\uff0c\u53c2\u6570\u539f\u6837\u4f20\u9012\uff08callee \u5fc5\u987b static\uff09\uff1b\u540c\u6837\u7981\u6b62\u5206\u914d</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#12-getetsnapitypel58l73","title":"1.2 GetEtsNapiType\uff08L58\u2013L73\uff09","text":"<p>\u4ece panda_file \u7684\u65b9\u6cd5\u6ce8\u89e3\u91cc\u8bc6\u522b\uff1a - <code>ANI_UNSAFE_QUICK</code> \u2192 FAST - <code>ANI_UNSAFE_DIRECT</code> \u2192 CRITICAL \u5426\u5219\u9ed8\u8ba4 GENERIC</p> <p>\u5bf9\u9f50 <code>Method</code>\uff1a\u540e\u7eed <code>GetNativeEntryPointFor</code> \u4f1a\u57fa\u4e8e\u8be5\u7c7b\u578b\u8bbe\u7f6e <code>ACC_FAST_NATIVE/ACC_CRITICAL_NATIVE</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#2-classlinkererror-ets-l75l103","title":"2. ClassLinkerError \u2192 ETS \u5f02\u5e38\uff08L75\u2013L103\uff09","text":"<ul> <li><code>GetClassLinkerErrorDescriptor(error)</code>\uff08L75\u2013L97\uff09\uff1a\u628a core <code>ClassLinker::Error</code> \u6620\u5c04\u5230 ETS \u4fa7\u9519\u8bef\u7c7b descriptor\uff1a</li> <li>CLASS_NOT_FOUND / FIELD_NOT_FOUND / METHOD_NOT_FOUND / NO_CLASS_DEF / CIRCULARITY / METHOD_CONFLICT \u7b49</li> <li>\u5176\u5b83 case \u76f4\u63a5 FATAL\uff08\u8981\u6c42\u8986\u76d6\u5b8c\u6574\uff09</li> <li><code>ErrorHandler::OnError</code>\uff08L99\u2013L102\uff09\uff1a\u76f4\u63a5 <code>ThrowEtsException(currentCoroutine, descriptor, message)</code></li> </ul> <p>\u8bed\u4e49\uff1aETS \u628a class linker \u9519\u8bef\u89c6\u4e3a\u201c\u53ef\u629b\u5f02\u5e38\u201d\uff0c\u800c\u4e0d\u662f\u4ec5\u56de\u8c03\u9519\u8bef\u5904\u7406\u5668\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#3-initializeclassrootsprimitivearraysynthetic-rootsl104l140","title":"3. InitializeClassRoots\uff1aprimitive/array/synthetic roots\uff08L104\u2013L140\uff09","text":"<p>\u901a\u8fc7\u57fa\u7c7b\u63d0\u4f9b\u7684 helper\uff1a - <code>InitializeArrayClassRoot(ClassRoot::ARRAY_CLASS, ClassRoot::CLASS, ClassArrayDescriptor)</code>\uff08L106\u2013L108\uff09 - <code>InitializePrimitiveClassRoot(root, typeId, shortDescriptor)</code>\uff1a   - VOID\u2192\"V\"\u3001U1\u2192\"Z\"\u3001I8\u2192\"B\"\u3001U8\u2192\"H\"\u3001\u2026\u3001TAGGED\u2192\"A\" - \u4e3a\u6bcf\u4e2a primitive \u521b\u5efa\u5bf9\u5e94 array root\uff1a\u5982 <code>\"[I\" \"[J\" ...</code>\uff08L123\u2013L134\uff09 - <code>InitializeArrayClassRoot(ClassRoot::ARRAY_STRING, ClassRoot::STRING, StringArrayDescriptor)</code>\uff08L135\u2013L136\uff09 - synthetic roots\uff1aANY(\"Y\")\u3001NEVER(\"N\")\uff08L138\u2013L139\uff09</p> <p>\u8fd9\u4e9b roots \u6700\u7ec8\u4f1a\u901a\u8fc7 <code>SetClassRoot(root, klass)</code> \u63d2\u5165\u5230 boot context\uff08\u57fa\u7c7b\u5b9e\u73b0\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#4-string-class-gc-l142l235","title":"4. String class \u4f53\u7cfb\uff1a\u4e3b\u7c7b + \u5b50\u7c7b + GC \u5e03\u5c40\u5143\u6570\u636e\uff08L142\u2013L235\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#41-createstringsubclassl142l187","title":"4.1 CreateStringSubClass\uff08L142\u2013L187\uff09","text":"<p>\u7528 core <code>ClassLinker::BuildClass</code> \u4ece <code>stringClass</code> \u6d3e\u751f\u521b\u5efa\u5b50\u7c7b\uff1a - \u7ee7\u627f <code>stringClass</code> \u7684 accessFlags \u5e76\u52a0 <code>ACC_FINAL</code>\uff08L147\uff09 - <code>BuildClass(descriptor, needCopy=true, accessFlags, empty methods/fields/interfaces, base=stringClass, context=stringClass-&gt;GetLoadContext())</code> - \u8bbe\u7f6e state\uff1aINITIALIZING \u2192 \u8bbe\u7f6e string \u7c7b\u578b\u6807\u5fd7 \u2192 \u6839\u636e\u5b50\u7c7b\u7c7b\u578b\u5199\u5165 GC \u76f8\u5173\u5143\u6570\u636e\uff1a   - SLICED_STRING\uff1a\u8bbe\u7f6e refFieldsNum/refFieldsOffset + objectSize\uff08L164\u2013L169\uff09   - TREE_STRING\uff1a\u8bbe\u7f6e refFieldsNum/refFieldsOffset + objectSize\uff08L172\u2013L178\uff09 - \u6700\u7ec8\u7f6e\u4e3a INITIALIZED\uff08L185\uff09</p> <p>\u5173\u952e\uff1a\u8fd9\u91cc\u624b\u5de5\u5199\u4e86 <code>refFieldsNum/refFieldsOffset/objectSize</code>\uff0c\u8bf4\u660e\u8fd9\u4e9b String \u5b50\u7c7b\u7684\u5e03\u5c40\u662f runtime \u7ea6\u5b9a\u7684\uff08GC \u4f9d\u8d56\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#42-initializestringclassl206l235","title":"4.2 InitializeStringClass\uff08L206\u2013L235\uff09","text":"<ul> <li>\u5148\u521b\u5efa String \u7c7b\u5e76\u585e\u4e3a class root\uff1a <code>GetClassLinker()-&gt;GetClass(StringDescriptor, false, BootContext)</code>\uff08L209\uff09   \u7136\u540e <code>RemoveFinal/SetStringClass/SetClassRoot(STRING, strCls)</code>\uff08L214\u2013L218\uff09</li> <li>\u518d\u5faa\u73af\u521b\u5efa Line/Sliced/Tree \u4e09\u4e2a\u5b50\u7c7b\u5e76\u5404\u81ea SetFinal + SetClassRoot\uff08L220\u2013L232\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#5-initializeimplboot-roots-objectclassl237l280","title":"5. InitializeImpl\uff1aboot roots \u7684\u6700\u65e9\u4e24\u7c7b\uff08OBJECT/CLASS\uff09\u4e0e\u5b57\u7b26\u4e32\u538b\u7f29\u5f00\u5173\uff08L237\u2013L280\uff09","text":"<p>\u6838\u5fc3\u6b65\u9aa4\uff1a - <code>langCtx_ = Runtime::GetLanguageContext(ETS)</code>\uff08L243\uff09 - \u4ece boot context \u83b7\u53d6\u5e76\u8bbe\u7f6e OBJECT\u3001CLASS roots\uff08L247\u2013L260\uff09 - \u8ba9 managed <code>EtsClass</code> \u5bf9\u8c61\u7684 <code>Class</code> \u6307\u9488\u6307\u5411 classClass\uff08L261\u2013L263\uff09 - <code>coretypes::String::SetCompressedStringsEnabled(compressedStringEnabled)</code>\uff08L264\uff09 - \u521d\u59cb\u5316 String \u4f53\u7cfb\uff08L266\u2013L270\uff09 - \u52a0\u8f7d JS_VALUE \u7c7b\u5e76 <code>SetXRefClass</code>\uff08L272\u2013L277\uff09\uff08ETS \u4e0e interop/js \u76f8\u5173\uff09 - <code>InitializeClassRoots()</code>\uff08L278\uff09</p> <p>\u8fd9\u5bf9\u5e94 <code>ClassLinkerExtension::InitializeImpl</code> \u7684\u201c\u8bed\u8a00\u81ea\u4e3e\u201d\uff1a\u5148\u62ff\u5230 OBJECT/CLASS\uff0c\u518d\u9010\u6b65\u8865\u9f50\u5176\u5b83 roots\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#6-arrayunionprimitivesynthetic-initializexxxl282l366","title":"6. array/union/primitive/synthetic \u7684 InitializeXXX\uff08L282\u2013L366\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#61-initializearrayclassl282l310","title":"6.1 InitializeArrayClass\uff08L282\u2013L310\uff09","text":"<ul> <li>base \u7edf\u4e00\u8bbe\u4e3a OBJECT\uff08\u5e76\u540c\u6b65 ETS \u7684 SuperClass\uff09\uff08L289\u2013L292\uff09</li> <li>componentType \u8bbe\u4e3a componentClass\uff08L292\uff09</li> <li>accessFlags\uff1a\u4ece componentClass \u53d6 file mask\uff0c\u53bb\u6389 interface\uff0c\u52a0\u4e0a FINAL|ABSTRACT\uff08L294\u2013L297\uff09</li> <li>\u590d\u5236 OBJECT \u7684 vtable \u5230 arrayClass vtable\uff08L300\u2013L304\uff09</li> <li>state \u2192 INITIALIZED\uff08L306\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#62-initializeunionclassl312l326","title":"6.2 InitializeUnionClass\uff08L312\u2013L326\uff09","text":"<ul> <li>base=null\u3001superClass=null</li> <li>\u8bb0\u5f55 constituent types</li> <li>state \u2192 INITIALIZED</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#63-initializeclassl328l345","title":"6.3 InitializeClass\uff08L328\u2013L345\uff09","text":"<p><code>InitializeClass(klass, handler)</code>\uff1a - \u65ad\u8a00\u5df2\u521d\u59cb\u5316 + \u5141\u8bb8\u8bbf\u95ee managed objects\uff08L335\u2013L336\uff09 - \u628a core <code>Class</code> \u7684 base/flags/primitive \u5c5e\u6027\u540c\u6b65\u5230 <code>EtsClass::Initialize(...)</code>\uff08L340\u2013L343\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#64-primitivesyntheticl347l366","title":"6.4 primitive/synthetic\uff08L347\u2013L366\uff09","text":"<p>\u7edf\u4e00\u8bbe public|final|abstract\uff0c\u5e76\u7f6e INITIALIZED\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#7-roots-vtableimtsize-l368l480l545","title":"7. roots \u7684 vtable/imt/size \u8ba1\u7b97\uff08L368+\uff0cL480\u2013L545\uff09","text":"<p>\u4ece\u6211\u4eec\u8bfb\u5230\u7684\u7247\u6bb5\u53ef\u89c1\uff1a - primitives/any/never/tagged\uff1avtableSize/imtSize/size \u90fd\u8d70 0 \u6216 ComputeClassSize(0,0,...)\uff08L493\u2013L515\uff09 - arrays\uff1a\u8d70 <code>GetArrayClass{VTable,IMT,Size}</code>\uff08L525\u2013L544\uff09 - OBJECT/STRING/Line/Sliced/Tree\uff1a\u8d70\u5bf9\u5e94 root class \u7684 vtableSize \u6216 ComputeClassSize\uff08L509\u2013L515\uff09</p> <p>\u5bf9\u9f50 <code>class_linker.cpp::CreateArrayClass</code>\uff1aarray class \u7684 vtable/imt/size \u7531 extension \u51b3\u5b9a\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#8-class-managedruntimel546l616","title":"8. Class \u5bf9\u8c61\u5206\u914d\u4e0e\u201cmanaged\u2194runtime\u201d\u7ed1\u5b9a\uff08L546\u2013L616\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#81-initializeclassobjectheader-l546l559","title":"8.1 InitializeClass(ObjectHeader*, ...)\uff08L546\u2013L559\uff09","text":"<ul> <li>\u628a <code>ObjectHeader*</code> reinterpret \u4e3a <code>EtsClass* managedClass</code></li> <li><code>managedClass-&gt;InitClass(descriptor, vtableSize, imtSize, size)</code>\uff1a\u5728 managed \u5bf9\u8c61\u5185\u90e8\u521d\u59cb\u5316 runtime class \u5143\u6570\u636e\u533a</li> <li>\u53d6\u51fa <code>klass = managedClass-&gt;GetRuntimeClass()</code> \u5e76\uff1a</li> <li><code>klass-&gt;SetManagedObject(objectHeader)</code></li> <li><code>klass-&gt;SetSourceLang(ETS)</code></li> <li><code>AddCreatedClass(klass)</code>\uff08\u8fdb\u5165 createdClasses_\uff0c\u7b49\u5f85\u63d2\u5165 context \u540e\u518d\u8fc1\u79fb\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#82-createclassdescriptor-vtablesize-imtsize-sizel561l579","title":"8.2 CreateClass(descriptor, vtableSize, imtSize, size)\uff08L561\u2013L579\uff09","text":"<ul> <li>\u4ece heapManager \u5206\u914d NonMovable \u5bf9\u8c61\uff08<code>AllocateNonMovableObject&lt;...&gt;(classClassRoot, EtsClass::GetSize(size))</code>\uff09</li> <li>\u7279\u6b8a\uff1a\u5f53 CLASS root \u5c1a\u672a\u5efa\u7acb\u65f6\uff0c\u5141\u8bb8 <code>classClassRoot==nullptr</code>\uff08\u7528\u4e8e\u81ea\u4e3e OBJECT/CLASS\uff09</li> <li>\u5206\u914d\u5931\u8d25\u8fd4\u56de nullptr</li> <li>\u6210\u529f\u540e\u8c03\u7528\u4e0a\u9762\u7684 InitializeClass(objectHeader, ...)\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#83-createclassrootl581l607","title":"8.3 CreateClassRoot\uff08L581\u2013L607\uff09","text":"<ul> <li>root==CLASS \u7684\u81ea\u4e3e\u8def\u5f84\uff1a\u76f4\u63a5\u5206\u914d nonmovable + InitializeClass + \u8bbe\u7f6e objectSize + \u8ba9\u81ea\u8eab class \u6307\u5411\u81ea\u8eab\uff08L589\u2013L596\uff09</li> <li>\u5176\u5b83 root\uff1a\u8d70 CreateClass</li> <li>\u516c\u5171\u6536\u5c3e\uff1a</li> <li>base \u8bbe\u4e3a OBJECT\uff08L601\u2013L602\uff09</li> <li>state=LOADED\u3001loadContext=BootContext\uff08L603\u2013L604\uff09</li> <li><code>GetClassLinker()-&gt;AddClassRoot(root, klass)</code>\uff08L605\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#84-freeclass-l609l624","title":"8.4 FreeClass / \u6790\u6784\uff08L609\u2013L624\uff09","text":"<ul> <li><code>FreeClass</code>\uff1a<code>RemoveOverloadMap()</code> + <code>RemoveCreatedClass(klass)</code>\uff08\u4ece createdClasses \u8fc1\u79fb/\u6e05\u7406\uff09</li> <li>\u6790\u6784\uff1a\u82e5\u5df2\u521d\u59cb\u5316\u5219 <code>FreeLoadedClasses()</code>\uff08\u57fa\u7c7b helper\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#9-native-flags-l626l699","title":"9. native \u5165\u53e3\u70b9\u9009\u62e9\u4e0e flags \u5199\u56de\uff08L626\u2013L699\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#91-ismethodnativeapil626l630","title":"9.1 IsMethodNativeApi\uff08L626\u2013L630\uff09","text":"<p>native \u4e14\u975e intrinsic \u4e14\u975e async \u6ce8\u89e3\uff0c\u624d\u7b97 native API\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#92-canthrowexception-switchthreadstate-useobjectsl632l660","title":"9.2 CanThrowException / SwitchThreadState / UseObjects\uff08L632\u2013L660\uff09","text":"<p>\u5168\u90e8\u57fa\u4e8e <code>EtsMethod</code> \u7684 <code>IsFastNative/IsCriticalNative</code> \u7b49\u5c5e\u6027\u51b3\u5b9a\uff1a - critical native\uff1a\u4e0d\u80fd\u629b\u5f02\u5e38\u3001\u4e0d\u80fd\u7528\u5bf9\u8c61\u3001\u4e5f\u4e0d\u9700\u8981\u5207\u7ebf\u7a0b\u6001\uff08\u56e0\u4e3a\u4e00\u76f4\u5728 managed mode \u4e14\u4e0d\u80fd GC\uff09 - fast native\uff1a\u4e0d\u5207\u7ebf\u7a0b\u6001\u4f46\u4e5f\u4e0d\u80fd\u5206\u914d\uff08\u95f4\u63a5\u9650\u5236\uff09 - generic\uff1a\u9700\u8981\u5207\u7ebf\u7a0b\u6001\uff08\u5141\u8bb8 GC\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#93-getnativeentrypointforl662l689","title":"9.3 GetNativeEntryPointFor\uff08L662\u2013L689\uff09","text":"<ul> <li>async \u6ce8\u89e3 \u2192 <code>EtsAsyncEntryPoint</code></li> <li>\u5426\u5219\u6839\u636e <code>GetEtsNapiType</code>\uff1a</li> <li>GENERIC\uff1a<code>ani::GetANIEntryPoint()</code></li> <li>FAST\uff1a\u7ed9 method \u5199 <code>ACC_FAST_NATIVE</code>\uff0c\u4ecd\u7528 <code>GetANIEntryPoint</code></li> <li>CRITICAL\uff1a\u5199 <code>ACC_CRITICAL_NATIVE</code>\uff0c\u7528 <code>ani::GetANICriticalEntryPoint()</code></li> </ul> <p>\u5bf9\u9f50 <code>class_linker.cpp::LoadMethod</code>\uff1anative \u65b9\u6cd5\u7684 entrypoint \u7531 extension \u51b3\u5b9a\uff0c\u5e76\u5728 Method \u4e0a\u5199\u56de flags/entrypoint\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#10-builtin-classescacheclass-platformtypesl701l789","title":"10. builtin classes\uff1aCacheClass + PlatformTypes\uff08L701\u2013L789\uff09","text":"<ul> <li><code>CacheClass(descriptor, forceInit)</code>\uff1a\u4ece boot context GetClass\uff1b\u53ef\u9009\u5f3a\u5236 InitializeClass\uff1b\u5931\u8d25\u6253\u5370\u9519\u8bef\u3002</li> <li><code>InitializeBuiltinSpecialClasses()</code>\uff1a\u5bf9 String/NullValue/Boxed/BigInt/Function/Enum/WeakRef \u7b49\u7c7b\u8bbe\u7f6e ETS \u7684\u8bed\u4e49\u6807\u5fd7\u3002</li> <li><code>InitializeBuiltinClasses()</code>\uff1a</li> <li>\u521d\u59cb\u5316 special classes</li> <li>\u521b\u5efa <code>plaformTypes_</code>\uff08\u7528 internal allocator new\uff09</li> <li>\u628a coroutine \u7684 pseudo TLS\uff08PromiseClass/JobClass/StringClassPtr/ArrayU16/U8\uff09\u6307\u5411\u5bf9\u5e94 root\uff08L779\u2013L784\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#initializefinishl786l789","title":"InitializeFinish\uff08L786\u2013L789\uff09","text":"<p><code>plaformTypes_-&gt;InitializeClasses(currentCoroutine)</code>\uff1a\u5b8c\u6210\u5e73\u53f0\u7c7b\u578b\u8868\u7684 class \u521d\u59cb\u5316\uff08\u5178\u578b\uff1a\u7f13\u5b58\u5e38\u7528 Method/Class \u6307\u9488\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp/#11-app-context-common-contextl791l833","title":"11. app context \u521b\u5efa\u4e0e common-context\uff08L791\u2013L833\uff09","text":"<ul> <li><code>CreateApplicationClassLinkerContext(path)</code>\uff1a\u8c03\u7528 <code>PandaEtsVM::CreateApplicationRuntimeLinker(path)</code> \u8fd4\u56de context\uff08L793\u2013L795\uff09</li> <li><code>GetParentContext(ctx)</code>\uff1a\u4ece <code>EtsClassLinkerContext</code> \u53d6 runtime linker\uff0c\u8981\u6c42\u662f AbcRuntimeLinker\uff0c\u8fd4\u56de parentLinker-&gt;GetClassLinkerContext\uff08L799\u2013L812\uff09</li> <li><code>GetCommonContext(classes)</code>\uff1a</li> <li>\u4ece\u7b2c\u4e00\u4e2a class \u7684 loadContext \u5f00\u59cb</li> <li>while \u975e boot\uff1a\u68c0\u67e5\u8be5 context \u662f\u5426\u5305\u542b\u6240\u6709 class descriptor\uff08<code>FindClass</code>\uff09\uff0c\u5426\u5219\u4e0a\u79fb\u5230 parent context</li> <li>\u627e\u5230\u5219\u8fd4\u56de\uff1b\u82e5\u4e00\u8def\u4e0a\u79fb\u5230 boot\uff0c\u5219\u8fd4\u56de boot</li> </ul> <p>\u5bf9\u9f50 <code>class_linker.cpp::LoadUnionClass</code>\uff1aunion class \u9700\u8981\u4e00\u4e2a commonContext \u4f5c\u4e3a\u63d2\u5165/\u53bb\u91cd\u57df\uff0c\u8fd9\u91cc\u7ed9\u51fa ETS \u7684\u8ba1\u7b97\u65b9\u5f0f\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/","title":"<code>plugins/ets/runtime/ets_class_linker_extension.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 <code>ClassLinkerExtension</code> \u6d3e\u751f\u7c7b\uff1a\u5b9a\u4e49\u201cETS \u7684 class roots / class \u521b\u5efa\u4e0e\u91ca\u653e / \u8bed\u8a00\u4fa7\u521d\u59cb\u5316 / native \u5165\u53e3\u70b9\u7b56\u7565 / app context \u521b\u5efa / common-context \u63a8\u5bfc\u201d\u3002 \u6ce8\u610f\uff1a\u5b9e\u73b0\u4e3b\u4f53\u5728 <code>.cpp</code>\uff0c\u672c\u5934\u6587\u4ef6\u662f ETS \u4fa7 ClassLoading \u7684\u201c\u80fd\u529b\u6e05\u5355\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#1-l44l129","title":"1. \u5173\u952e\u804c\u8d23\u4e00\u89c8\uff08L44\u2013L129\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#11-roots","title":"1.1 roots \u4e0e\u7279\u6b8a\u7c7b\u521d\u59cb\u5316","text":"<ul> <li><code>InitializeClassRoots()</code>\uff1a\u521b\u5efa primitive/array/synthetic roots\uff08\u4e0e <code>ClassLinkerExtension</code> \u7684 root helpers \u5bf9\u9f50\uff09\u3002</li> <li>String \u76f8\u5173\uff1a</li> <li><code>InitializeStringClass(classClass)</code>\uff1a\u521b\u5efa String \u4ee5\u53ca\u5176\u5b50\u7c7b\uff08LineString/SlicedString/TreeString\uff09</li> <li><code>CreateStringSubClass(descriptor, stringClass, type)</code></li> <li><code>GetStringClassDescriptor(ClassRoot strCls)</code></li> <li><code>InitializeBuiltinClasses()</code> / <code>InitializeBuiltinSpecialClasses()</code>\uff1a\u7f13\u5b58\u5e76\u7ed9\u67d0\u4e9b builtin class \u6253 ETS \u7279\u5b9a\u6807\u5fd7\uff08\u503c\u7c7b\u578b/boxed/bigint/weak ref\u2026\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#12-class-managed-object","title":"1.2 class \u521b\u5efa/\u91ca\u653e\u4e0e managed-object \u7ed1\u5b9a","text":"<ul> <li><code>CreateClass(descriptor, vtableSize, imtSize, size)</code>\uff1a\u5728 ETS heap \u4e0a\u5206\u914d NonMovable \u7684 class object\uff08<code>EtsClass</code>\uff09\uff0c\u5e76\u521d\u59cb\u5316 runtime <code>Class</code>\u3002</li> <li><code>FreeClass(klass)</code>\uff1a\u6e05\u7406 ETS class \u7684\u989d\u5916\u6570\u636e\uff08\u5982 overload map\uff09\uff0c\u5e76\u628a\u5176\u4ece createdClasses \u4e2d\u79fb\u9664\uff08\u5bf9\u9f50\u57fa\u7c7b\u7684 created/new/obsolete \u8bed\u4e49\uff09\u3002</li> <li><code>FromClassObject(obj)</code>\uff1a\u4ece managed class object\uff08<code>EtsClass*</code>\uff09\u53cd\u67e5 runtime <code>Class*</code>\u3002</li> <li><code>GetClassObjectSizeFromClassSize(size)</code>\uff1aClass \u5bf9\u8c61\u5927\u5c0f\u6620\u5c04\uff08ETS \u7528 <code>EtsClass::GetSize(size)</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#13-initializeclass","title":"1.3 \u8bed\u8a00\u4fa7 InitializeClass","text":"<ul> <li><code>InitializeClass(klass)</code> \u4e0e <code>InitializeClass(klass, handler)</code>\uff1a</li> <li>\u628a core <code>Class</code> \u7684 metadata \u540c\u6b65/\u6620\u5c04\u5230 <code>EtsClass</code>\uff08ETS \u7684 <code>Class</code> \u5305\u88c5\u7c7b\u578b\uff09\uff0c\u5e76\u63a5\u5165 ETS \u7684\u9519\u8bef\u5904\u7406\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#14-native-ani-fast-critical-async","title":"1.4 native \u5165\u53e3\u70b9\u7b56\u7565\uff08ANI / fast / critical / async\uff09","text":"<ul> <li><code>IsMethodNativeApi(method)</code>\uff1a\u533a\u5206\u201c\u771f native API \u8c03\u7528\u201d\u4e0e\u201cintrinsic/async \u4f2a native\u201d\u3002</li> <li><code>GetNativeEntryPointFor(method)</code>\uff1a\u6839\u636e\u6ce8\u89e3\u4e0e\u7b56\u7565\u8fd4\u56de\uff1a</li> <li>generic/fast\uff1aANI \u666e\u901a\u5165\u53e3\u70b9</li> <li>critical\uff1aANI critical \u5165\u53e3\u70b9</li> <li>async\uff1aEtsAsyncEntryPoint</li> <li><code>IsNecessarySwitchThreadState / CanNativeMethodUseObjects / CanThrowException</code>\uff1a\u6307\u5bfc runtime \u5728 native \u8c03\u7528\u65f6\u662f\u5426\u8981\u5207\u7ebf\u7a0b\u6001\u3001\u662f\u5426\u5141\u8bb8\u89e6\u8fbe managed objects\u3001\u662f\u5426\u53ef\u629b\u5f02\u5e38\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#15-context-unioncommon-context","title":"1.5 context \u7ba1\u7406\u4e0e union/common-context","text":"<ul> <li><code>CreateApplicationClassLinkerContext(path)</code>\uff1a\u7531 ETS VM \u521b\u5efa app runtime linker/context\uff08\u975e boot\uff09\u3002</li> <li><code>GetCommonContext(classes)</code>\uff1a\u7ed9 union \u7c7b\u6216\u8de8\u4e0a\u4e0b\u6587\u7c7b\u578b\u96c6\u5408\u627e\u5171\u540c context\uff08\u6cbf parent \u9010\u7ea7\u5411\u4e0a\uff09\u3002</li> <li><code>GetParentContext(ctx)</code>\uff1a\u4ece app context \u5f97\u5230\u7236 context\uff08\u901a\u8fc7 AbcRuntimeLinker parentLinker\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#2-l145l148","title":"2. \u9519\u8bef\u5904\u7406\u5668\uff08L145\u2013L148\uff09","text":"<p>\u5185\u90e8 <code>ErrorHandler : ClassLinkerErrorHandler</code>\uff1a - <code>OnError(error, message)</code>\uff1a\u5c06 class linker \u9519\u8bef\u8f6c\u6362\u4e3a ETS \u5f02\u5e38\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</p> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 <code>GetErrorHandler()</code> \u8fd4\u56de <code>&amp;errorHandler_</code>\uff1aETS \u628a class linker \u9519\u8bef\u201c\u8bed\u4e49\u5316\u201d\u4e3a\u53ef\u6355\u83b7\u5f02\u5e38\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_class_linker_extension.h/#3-l150l155","title":"3. \u79c1\u6709\u72b6\u6001\uff08L150\u2013L155\uff09","text":"<ul> <li><code>langCtx_</code>\uff1aETS \u7684 <code>LanguageContext</code>\uff08\u7528\u4e8e descriptor/name/\u521d\u59cb\u5316\u7b56\u7565\u7b49\uff09\u3002</li> <li><code>heapManager_</code>\uff1a\u7528\u4e8e\u5206\u914d NonMovable class object\uff08<code>EtsClass</code>\uff09\u3002</li> <li><code>plaformTypes_</code>\uff1aETS \u5e73\u53f0\u7c7b\u578b\u8868\uff08\u63d0\u4f9b <code>coreRuntimeLinkerLoadClass</code>\u3001Promise/Job \u7b49\u6838\u5fc3 class/method \u53e5\u67c4\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/","title":"<code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 itable \u6784\u5efa\u4e0e\u89e3\u6790\u5b9e\u73b0\uff08Build / Resolve / UpdateClass\uff09\u3002 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 205 \u884c\uff08\u5b9e\u73b0\u76f8\u5bf9\u96c6\u4e2d\uff09\u3002</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#ets-itablebuilderbuild-resolve-updateclass","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aETS ITableBuilder\uff08Build \u2192 Resolve \u2192 UpdateClass\uff09","text":"<pre><code>flowchart TD\n  A[\"Build(base, interfaces, isInterface)\"] --&gt; B{\"base \u6709 itable\uff1f\"}\n  B --&gt;|\u6709| C[\"CloneBaseITable\\n(Entry::Copy \u6df1\u62f7\u8d1d methods span)\"]\n  B --&gt;|\u65e0| C\n  C --&gt; D{\"\u672c\u7c7b\u6709\u65b0 interfaces\uff1f\"}\n  D --&gt;|\u65e0| E[\"\u4ec5\u590d\u5236\u7236 itable \u5373\u53ef\"]\n  D --&gt;|\u6709| F[\"LinearizeITable\\n(interfaces + \u7236\u63a5\u53e3\u6241\u5e73\u5316 + \u53bb\u91cd)\"]\n  E --&gt; G[\"\u4e3a\u6bcf\u4e2a Entry \u5206\u914d Method* slots\\n(\u975e interface \u7c7b\u624d\u9700\u8981)\"]\n  F --&gt; G\n  G --&gt; H[\"Resolve(klass)\"]\n  H --&gt; I{\"klass \u662f interface\uff1f\"}\n  I --&gt;|\u662f| R1[\"\u76f4\u63a5\u6210\u529f\u8fd4\u56de\\n(\u4e0d\u505a\u5b9e\u73b0\u89e3\u6790)\"]\n  I --&gt;|\u5426| J[\"UpdateClass(\u5148\u628a itable \u5199\u5230 klass)\"]\n  J --&gt; K[\"\u5012\u5e8f\u904d\u5386 itable entries\"]\n  K --&gt; L[\"\u5bf9\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u69fd j\uff1a\\n\u4f18\u5148\u590d\u7528 base \u89e3\u6790\u7ed3\u679c\\n\u5426\u5219 FindMethodInVTable(name+proto)\"]\n  L --&gt; M{\"Multiple implement \u51b2\u7a81\uff1f\"}\n  M --&gt;|\u662f| R2[\"OnVTableConflict + Resolve=false\"]\n  M --&gt;|\u5426| N[\"\u5199\u5165 impMethods[j]\\n(\u627e\u4e0d\u5230\u5219\u5199 imethod \u81ea\u8eab)\"]\n  N --&gt; R3[\"Resolve=true\\nUpdateClass(\u53ef dump)\"]</code></pre>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#0-include-l16l25","title":"0. include \u4e0e\u4f9d\u8d56\uff08L16\u2013L25\uff09","text":"<p>\u8be5\u5b9e\u73b0\u76f4\u63a5\u4f9d\u8d56\uff1a - core <code>ClassLinker</code>\uff08\u7528\u4e8e allocator \u4e0e\u7c7b\u578b\u52a0\u8f7d\uff09 - ETS <code>EtsVTableBuilder</code> \u7684 override/\u51b2\u7a81\u68c0\u6d4b\u5de5\u5177\uff08<code>ETSProtoIsOverriddenBy</code>\u3001<code>OnVTableConflict</code>\uff09 - <code>runtime/include/exceptions.h</code>\uff1a\u7528\u4e8e\u51b2\u7a81\u9519\u8bef\u6784\u9020</p> <p>\u8fd9\u4e5f\u89e3\u91ca\u4e86\uff1aETS \u7684 itable resolve \u4e0d\u662f\u201c\u7eaf\u63a5\u53e3\u8868\u201d\uff0c\u800c\u662f\u4e0e vtable override \u89c4\u5219\u5f3a\u8026\u5408\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#1-findmethodinvtable-vtable-l28l53","title":"1. FindMethodInVTable\uff1a\u5728 vtable \u4e2d\u627e\u63a5\u53e3\u5b9e\u73b0\uff08L28\u2013L53\uff09","text":"<p>\u8f93\u5165\uff1a - <code>klass</code>\uff1a\u5f53\u524d\u7c7b - <code>imethod</code>\uff1a\u63a5\u53e3\u65b9\u6cd5\uff08virtual method\uff09 - <code>errHandler</code>\uff1a\u9519\u8bef\u5904\u7406\u5668</p> <p>\u7b97\u6cd5\uff1a - \u53d6 <code>vtable = klass-&gt;GetVTable()</code>\u3001<code>imethodName = imethod-&gt;GetName()</code>\u3001<code>ctx = klass-&gt;GetLoadContext()</code>\u3002 - \u4ece vtable \u672b\u5c3e\u5411\u524d\u626b\u63cf\uff08L36\u2013L51\uff09\uff1a   - \u5148\u6bd4 name\uff08\u5feb\u901f\u8fc7\u6ee4\uff09   - \u518d\u7528 <code>ETSProtoIsOverriddenBy(ctx, imethod-&gt;GetProtoId(), kmethod-&gt;GetProtoId())</code> \u5224\u5b9a\u7b7e\u540d/\u534f\u53d8\u8986\u76d6\u517c\u5bb9   - \u8bb0\u5f55\u5019\u9009 <code>candidate</code>   - \u82e5\u53d1\u73b0\u7b2c\u4e8c\u4e2a\u5019\u9009\uff1a\u8c03\u7528 <code>OnVTableConflict(errHandler, MULTIPLE_IMPLEMENT, ...)</code> \u5e76\u8fd4\u56de <code>nullopt</code> - \u8fd4\u56de\uff1a   - <code>std::optional&lt;Method*&gt;</code>\uff1a\u7a7a optional \u8868\u793a\u201c\u51b2\u7a81\uff08\u81f4\u547d\uff09\u201d\uff1b\u6709\u503c\u4f46\u4e3a nullptr \u8868\u793a\u201c\u6ca1\u627e\u5230\u5b9e\u73b0\u201d\uff08\u5141\u8bb8\u56de\u9000\u5230\u63a5\u53e3\u9ed8\u8ba4\u5b9e\u73b0\uff0c\u5373\u586b imethod \u81ea\u5df1\uff09\u3002</p> <p>\u5173\u952e\u70b9\uff1a\u5b83\u663e\u5f0f\u9632\u6b62\u201c\u4e00\u63a5\u53e3\u65b9\u6cd5\u591a\u5b9e\u73b0\u5019\u9009\u201d\u7684\u6b67\u4e49\uff0c\u8fd9\u4e0e ClassLinker \u7684 Error::MULTIPLE_IMPLEMENT \u5bf9\u9f50\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#2-clonebaseitable-base-itable-l55l72","title":"2. CloneBaseITable\uff1a\u628a base \u7684 itable \u6df1\u62f7\u8d1d\u51fa\u6765\uff08L55\u2013L72\uff09","text":"<p>\u8f93\u5165\uff1a<code>classLinker</code>\u3001<code>base</code>\u3001<code>size</code>\uff08\u76ee\u6807 itable entry \u6570\uff09</p> <ul> <li>\u7528 <code>classLinker-&gt;GetAllocator()</code> \u5206\u914d <code>ITable::Entry</code> \u6570\u7ec4\uff08L57\u2013L58\uff09\u3002</li> <li>\u5148\u628a\u6bcf\u4e2a entry \u7684 methods span \u8bbe\u7f6e\u6210 <code>{nullptr,nullptr}</code>\uff08L60\u2013L62\uff09\uff0c\u907f\u514d\u60ac\u7a7a\u3002</li> <li>\u82e5 base \u975e\u7a7a\uff1a</li> <li><code>superItable = base-&gt;GetITable().Get()</code></li> <li>\u5bf9\u6bcf\u4e2a entry \u6267\u884c <code>superItable[i].Copy(allocator)</code>\uff08L67\u2013L69\uff09<ul> <li>\u6ce8\u610f\uff1a<code>ITable::Entry::Copy</code> \u4f1a\u6df1\u62f7\u8d1d methods span\uff08\u89c1\u6211\u4eec\u4e4b\u524d\u5bf9 <code>itable.h</code> \u7684\u9010\u884c\u7b14\u8bb0\uff09\u3002</li> </ul> </li> </ul> <p>\u7ed3\u8bba\uff1a\u5b50\u7c7b itable \u6784\u5efa\u4ee5\u201c\u590d\u5236\u7236\u7c7b itable\u201d\u4e3a\u57fa\u5e95\uff0c\u518d\u8ffd\u52a0\u5f53\u524d\u7c7b\u63a5\u53e3\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#3-linearizeitable-interfaces-itablel74l117","title":"3. LinearizeITable\uff1a\u628a interfaces + \u5b50\u63a5\u53e3\u6241\u5e73\u5316\u5e76\u8ffd\u52a0\u5230 itable\uff08L74\u2013L117\uff09","text":"<p>\u76ee\u6807\uff1a\u628a\u201c\u7c7b\u76f4\u63a5\u5b9e\u73b0\u7684\u63a5\u53e3\u201d\u4e0e\u201c\u63a5\u53e3\u7684\u7236\u63a5\u53e3\u201d\u90fd\u52a0\u5165 itable\uff0c\u540c\u65f6\u4fdd\u6301\u53bb\u91cd\u4e0e\u4e00\u5b9a\u7684\u7ebf\u6027\u5316\u987a\u5e8f\u3002</p> <p>\u6b65\u9aa4\uff1a 1) \u5efa <code>PandaUnorderedMap&lt;Class*, bool&gt; interfaces</code>\uff1a    - key\uff1ainterface class    - value\uff1a\u662f\u5426\u5df2\u5199\u5165 itable\uff08true=\u5df2\u653e\u5165\uff09 2) \u82e5 base \u975e\u7a7a\uff1a    - \u628a base \u7684 itable entry interface \u5168\u90e8\u6807\u8bb0\u4e3a true\uff08L80\u2013L85\uff09 3) \u904d\u5386 <code>classInterfaces</code>\uff1a    - \u5148 <code>interfaces.insert({interface,false})</code>    - \u82e5\u8fd9\u662f\u9996\u6b21\u63d2\u5165\uff08second==true\uff09\uff0c\u518d\u628a\u8be5 interface \u7684 itable\uff08\u5373\u5176\u7236\u63a5\u53e3\u5217\u8868\uff09\u90fd insert \u4e3a false\uff08L89\u2013L94\uff09 4) <code>itable = CloneBaseITable(..., interfaces.size())</code>\uff08L97\uff09    - <code>shift = base!=nullptr ? base-&gt;GetITable().Size() : 0</code>\uff08L98\uff09 5) \u518d\u904d\u5386 <code>classInterfaces</code>\uff0c\u5bf9\u6bcf\u4e2a interface\uff1a    - \u82e5\u5728 map \u4e2d\u4e14 value==false\uff08\u672a\u653e\u5165\uff09\uff0c\u5219\u5148\u904d\u5386\u5176 <code>interface-&gt;GetITable().Get()</code>\uff1a      - \u5bf9\u6bcf\u4e2a item\uff08\u7236\u63a5\u53e3\uff09\u5982\u679c map \u91cc value==false\uff1a<code>itable[shift++] = item.Copy(allocator)</code> \u5e76\u7f6e true\uff08L105\u2013L110\uff09    - \u7136\u540e <code>itable[shift++].SetInterface(interface)</code>\uff08L112\uff09    - \u628a\u8be5 interface \u6807\u8bb0\u4e3a true\uff08L113\u2013L114\uff09</p> <p>\u8fd9\u4e2a\u7ebf\u6027\u5316\u7b56\u7565\u975e\u5e38\u5173\u952e\uff1a - \u5148\u8ffd\u52a0\u7236\u63a5\u53e3\uff0c\u518d\u8ffd\u52a0\u76f4\u63a5\u63a5\u53e3 - \u901a\u8fc7 bool \u53bb\u91cd\uff0c\u907f\u514d\u91cd\u590d entry - \u4fdd\u8bc1 itable \u7684 entries \u662f\u201c\u53ef\u679a\u4e3e\u3001\u53ef\u89e3\u6790\u201d\u7684\u6241\u5e73\u5e8f\u5217</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#4-build-itable-entries-l119l141","title":"4. Build\uff1a\u6784\u9020 itable entries + \u4e3a\u6bcf\u4e2a\u63a5\u53e3\u865a\u65b9\u6cd5\u5206\u914d\u5b9e\u73b0\u69fd\uff08L119\u2013L141\uff09","text":""},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#41-itable-entries-l121l124","title":"4.1 itable entries \u6765\u6e90\uff08L121\u2013L124\uff09","text":"<ul> <li>\u82e5 <code>classInterfaces</code> \u4e3a\u7a7a\uff1a</li> <li>\u4ec5 clone base itable\uff08size=base-&gt;GetITable().Size()\uff09</li> <li>\u5426\u5219\uff1a</li> <li><code>LinearizeITable(classLinker, base, classInterfaces)</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#42-entry-methods-l125l137","title":"4.2 \u975e\u63a5\u53e3\u7c7b\uff1a\u4e3a\u65b0\u8ffd\u52a0\u7684\u63a5\u53e3 entry \u5206\u914d methods \u6570\u7ec4\uff08L125\u2013L137\uff09","text":"<p>\u5f53 <code>!isInterface</code>\uff1a - <code>superItableSize = base ? base-&gt;GetITable().Size() : 0</code> - \u5bf9 <code>[superItableSize, itable.Size())</code> \u7684\u65b0\u589e entries\uff1a   - <code>methods = entry.GetInterface()-&gt;GetVirtualMethods()</code>   - \u5206\u914d <code>Method** methodsAlloc</code>\uff08\u957f\u5ea6=methods.size()\uff09   - <code>entry.SetMethods(Span&lt;Method*&gt;{methodsAlloc, methods.size()})</code></p> <p>\u8fd9\u91cc\u7684\u5173\u952e\u5951\u7ea6\uff1a\u6bcf\u4e2a itable entry \u7684 methods span \u4e0e \u201c\u63a5\u53e3\u7684 virtual methods \u5217\u8868\u201d\u540c\u957f\u5ea6\u540c\u5e8f\u5bf9\u9f50\uff0c \u540e\u7eed Resolve \u4f1a\u6309 index j \u586b\u5165\u5bf9\u5e94\u5b9e\u73b0\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#43-itable_l139l140","title":"4.3 \u5199\u5165\u6210\u5458 itable_\uff08L139\u2013L140\uff09","text":"<p><code>itable_ = ITable(itable)</code>\uff0cBuild \u5b8c\u6210\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#5-resolvel144l181","title":"5. Resolve\uff1a\u628a\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u6620\u5c04\u5230\u6700\u7ec8\u5b9e\u73b0\uff08L144\u2013L181\uff09","text":"<p>\u603b\u4f53\u7b56\u7565\uff1a\u5bf9\u6bcf\u4e2a itable entry \u7684\u6bcf\u4e2a\u63a5\u53e3\u865a\u65b9\u6cd5 j\uff0c\u6c42\u51fa\u4e00\u4e2a <code>resolved</code>\uff1a - \u80fd\u7ee7\u627f\u590d\u7528\u7684 \u2192 \u76f4\u63a5\u590d\u7528 base \u7684\u5b9e\u73b0\uff08\u901a\u8fc7 vtableIndex \u56de\u5230\u6d3e\u53d1\u76ee\u6807\uff09 - \u5426\u5219 \u2192 \u5728\u5f53\u524d klass \u7684 vtable \u91cc\u627e name+proto \u7684\u5019\u9009\u5b9e\u73b0 - \u82e5\u6ca1\u627e\u5230\u5b9e\u73b0 \u2192 \u9000\u5316\u4e3a\u63a5\u53e3\u65b9\u6cd5\u672c\u8eab\uff08\u586b <code>imethod</code> \u6307\u9488\uff09</p> <p>\u9010\u6b65\uff1a - interface class \u76f4\u63a5 true\uff08L146\u2013L148\uff09 - <code>UpdateClass(klass)</code> \u5148\u628a itable \u5199\u56de class\uff08L149\uff09   - \u8fd9\u6837\u540e\u7eed <code>klass-&gt;GetITable()</code> \u53ef\u7528\uff08\u4e5f\u4fbf\u4e8e\u8c03\u8bd5\uff09 - <code>baseEntry</code> \u7684\u590d\u7528\u8def\u5f84\uff08L163\u2013L167\uff09\uff1a   - <code>baseMethod = baseEntry-&gt;GetMethods()[j]</code>   - \u5982\u679c <code>baseMethod-&gt;GetClass()-&gt;IsInterface()</code>\uff1a\u8bf4\u660e base \u91cc\u8fd9\u4e2a\u69fd\u8fd8\u6ca1\u89e3\u6790\u5230\u5177\u4f53\u5b9e\u73b0\uff08\u4ecd\u662f\u63a5\u53e3\u65b9\u6cd5\uff09\u2192 \u4e0d\u590d\u7528   - \u5426\u5219\uff1a<code>resolved = klass-&gt;GetVTable()[ baseMethod-&gt;GetVTableIndex() ]</code>     - \u8fd9\u91cc\u975e\u5e38\u5173\u952e\uff1a\u901a\u8fc7 vtableIndex \u8ba9\u201c\u5b9e\u73b0\u65b9\u6cd5\u6307\u9488\u201d\u5728\u5b50\u7c7b vtable \u4e2d\u627e\u5230\u6b63\u786e override \u7684\u6700\u7ec8\u76ee\u6807\u3002 - \u82e5 resolved \u4ecd\u4e3a\u7a7a\uff1a   - <code>FindMethodInVTable(klass, imethod, errorHandler_)</code>   - \u8fd4\u56de nullopt \u2192 \u51b2\u7a81\uff08MULTIPLE_IMPLEMENT\uff09\u2192 Resolve \u5931\u8d25   - \u6709\u503c\uff08\u53ef\u80fd nullptr\uff09\u2192 \u8d4b\u7ed9 resolved - \u6700\u7ec8\u586b\u69fd\uff08L176\uff09\uff1a   - <code>entry-&gt;GetMethods()[j] = resolved != nullptr ? resolved : imethod</code></p> <p>\u7ed3\u8bba\uff1aETS \u7684 itable resolve \u662f vtable \u9a71\u52a8 \u7684\uff1a - \u5148\u7528 base \u7684 vtableIndex \u590d\u7528\u201c\u6d3e\u53d1\u4f4d\u7f6e\u201d - \u518d\u5728\u5f53\u524d\u7c7b vtable \u91cc\u505a override \u5339\u914d - \u51b2\u7a81\u4e25\u683c\u62a5\u9519\u5e76\u5931\u8d25</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.cpp/#6-updateclass-dumpitablel183l202","title":"6. UpdateClass / DumpITable\uff08L183\u2013L202\uff09","text":"<ul> <li><code>UpdateClass</code>\uff1a<code>klass-&gt;SetITable(itable_)</code> \u5e76 <code>DumpITable</code></li> <li><code>DumpITable</code>\uff08debug only\uff09\uff1a\u6253\u5370 itable \u7684 interface \u5217\u8868\uff08\u6ce8\u91ca\u63d0\u5230 <code>#22950 itable has nullptr entries</code>\uff0c\u6697\u793a\u5b58\u5728 \u201cinterface==nullptr\u201d \u7684\u5360\u4f4d entry\uff0cdump \u65f6\u9700\u8981\u66f4\u5b8c\u5584\u8f93\u51fa\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.h/","title":"<code>plugins/ets/runtime/ets_itable_builder.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 <code>ITableBuilder</code> \u5b9e\u73b0\u58f0\u660e\uff1a<code>EtsITableBuilder</code>\u3002 \u8bf4\u660e\uff1a\u771f\u6b63\u7684\u6784\u5efa/\u89e3\u6790\u903b\u8f91\u5728 <code>ets_itable_builder.cpp</code>\uff0c\u672c\u5934\u6587\u4ef6\u5b9a\u4e49\u72b6\u6001\u4e0e\u63a5\u53e3\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.h/#1-l32l52","title":"1. \u7c7b\u7ed3\u6784\uff08L32\u2013L52\uff09","text":"<p><code>EtsITableBuilder : public ITableBuilder</code>\uff0c\u6838\u5fc3\u70b9\uff1a - \u6784\u9020\u6ce8\u5165 <code>ClassLinkerErrorHandler*</code>\uff08L34\uff09\uff1a   - ETS \u7684 itable resolve \u5728\u53d1\u73b0\u51b2\u7a81/\u7f3a\u5931\u5b9e\u73b0\u65f6\u4f1a\u8d70 errorHandler\uff08\u901a\u5e38\u6700\u7ec8\u629b ETS \u5f02\u5e38\uff09\u3002 - override \u56db\u4e2a\u5173\u952e\u65b9\u6cd5\uff1a   - <code>Build(classLinker, base, classInterfaces, isInterface)</code>   - <code>Resolve(klass)</code>   - <code>UpdateClass(klass)</code>   - <code>DumpITable(klass)</code> - <code>GetITable()</code> \u8fd4\u56de\u5185\u90e8\u7f13\u5b58\u7684 <code>itable_</code>\uff08L44\u2013L47\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_itable_builder.h/#2-l49l51","title":"2. \u5185\u90e8\u72b6\u6001\uff08L49\u2013L51\uff09","text":"<ul> <li><code>ITable itable_</code>\uff1a\u6784\u5efa\u51fa\u6765\u7684 itable\uff08\u8868\u5143\u7d20\u4e3a <code>ITable::Entry</code>\uff09\u3002</li> <li><code>ClassLinkerErrorHandler *errorHandler_</code>\uff1a\u51b2\u7a81/\u9519\u8bef\u4e0a\u62a5\u901a\u9053\u3002</li> </ul> <p>\u5bf9\u9f50 <code>class_linker.cpp</code>\uff1a<code>SetupClassInfo</code> \u4f1a\u628a builder \u5b58\u5728 <code>ClassInfo</code>\uff0c\u968f\u540e <code>LinkMethods</code> \u8c03\u7528 <code>Resolve/UpdateClass</code> \u5199\u56de <code>Class</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/","title":"<code>plugins/ets/runtime/ets_language_context.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 <code>LanguageContextBase</code> \u5b9e\u73b0\uff1a\u628a\u201c\u8bed\u8a00\u7b56\u7565\u201d\u843d\u5230\u5177\u4f53 builder / VM / GC / \u5f02\u5e38\u673a\u5236\u3002 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 108 \u884c\uff08\u5b9e\u73b0\u96c6\u4e2d\uff0c\u4e3b\u8981\u662f\u5de5\u5382\u65b9\u6cd5\u4e0e\u5f02\u5e38\u6865\u63a5\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#1-include-l16l26","title":"1. include \u4e0e\u4f9d\u8d56\u5b9a\u4f4d\uff08L16\u2013L26\uff09","text":"<p>\u8be5 <code>.cpp</code> \u660e\u786e\u63ed\u793a ETS \u5728 03 \u7ae0\u7684\u5173\u952e\u5b9e\u73b0\u70b9\uff1a - L16\uff1a<code>ets_itable_builder.h</code>\uff1aETS \u7684 ITableBuilder \u5b9e\u73b0\uff08\u5df2\u9010\u884c\uff1a\u89c1 plugins_ets_runtime_ets_itable_builder.h / plugins_ets_runtime_ets_itable_builder.cpp\uff09\u3002 - L18\uff1a<code>ets_vtable_builder.h</code>\uff1aETS \u7684 VTableBuilder \u5b9e\u73b0\uff08\u672c\u7ae0\u76ee\u524d\u4ee5 <code>EtsVTableBuilder</code> \u4e3a\u201c\u5b58\u5728\u70b9\u201d\u8bf4\u660e\uff1b\u5176\u9010\u884c\u53ef\u5728\u540e\u7eed\u6309\u52a8\u6001\u53d1\u73b0\u7eb3\u5165\uff0c\u82e5\u4f60\u5e0c\u671b\u628a ETS vtable override \u89c4\u5219\u4e5f\u5b8c\u5168\u95ed\u73af\u5230\u4ee3\u7801\uff09\u3002 - L19\u2013L24\uff1aETS \u7684\u65b9\u6cd5/\u5b57\u7b26\u4e32/\u5f02\u5e38/handle scope\uff1a\u7528\u4e8e\u5f02\u5e38\u521b\u5efa\u4e0e ThrowStackOverflow\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#2-throwexceptionl29l33","title":"2. ThrowException\uff08L29\u2013L33\uff09","text":"<ul> <li>\u628a <code>ManagedThread*</code> cast \u6210 <code>EtsCoroutine*</code>\uff08ETS \u7684\u7ebf\u7a0b/\u534f\u7a0b\u6a21\u578b\uff09\u3002</li> <li>\u8c03\u7528 <code>ThrowEtsException(coroutine, name, msg)</code>\uff0c\u628a MUTF8 descriptor \u8f6c\u4e3a C string\u3002</li> </ul> <p>\u8bed\u4e49\uff1aLanguageContext \u8d1f\u8d23\u201c\u629b\u5f02\u5e38\u7684\u7edf\u4e00\u5165\u53e3\u201d\uff0c\u4f46\u5177\u4f53\u5f02\u5e38\u5bf9\u8c61\u521b\u5efa\u5728 ETS runtime \u5b50\u7cfb\u7edf\u4e2d\u5b8c\u6210\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#3-createitablebuilder-createvtablebuilderl35l43","title":"3. CreateITableBuilder / CreateVTableBuilder\uff08L35\u2013L43\uff09","text":"<ul> <li>L35\u2013L38\uff1a<code>CreateITableBuilder(errHandler)</code> \u2192 <code>MakePandaUnique&lt;EtsITableBuilder&gt;(errHandler)</code>   \u7ed3\u8bba\uff1aETS \u7684 itable \u6784\u5efa\u7b97\u6cd5\u5728 <code>EtsITableBuilder</code>\uff0c\u4e0e core \u7684\u7a7a\u5b9e\u73b0\u4e0d\u540c\u3002</li> <li>L40\u2013L43\uff1a<code>CreateVTableBuilder(errHandler)</code> \u2192 <code>MakePandaUnique&lt;EtsVTableBuilder&gt;(errHandler)</code>   \u7ed3\u8bba\uff1aETS \u4e5f\u6709\u81ea\u5df1\u7684 vtable builder\uff08\u53ef\u80fd\u5728 override/\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\u7b56\u7565\u4e0a\u505a ETS \u7279\u5316\uff09\u3002</li> </ul> <p>\u4e0e <code>class_linker.cpp</code> \u5bf9\u9f50\uff1a<code>SetupClassInfo</code> \u6b63\u662f\u901a\u8fc7 <code>LanguageContext::Create*Builder</code> \u6ce8\u5165\u8fd9\u4e24\u4e2a builder\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#4-createvml45l56","title":"4. CreateVM\uff08L45\u2013L56\uff09","text":"<p>\u8c03\u7528 <code>ets::PandaEtsVM::Create(runtime, options)</code>\uff1a - \u5931\u8d25\uff1a\u6253\u5370\u9519\u8bef\u5e76\u8fd4\u56de nullptr - \u6210\u529f\uff1a\u8fd4\u56de VM \u6307\u9488</p> <p>\u8fd9\u628a\u201cRuntimeOptions \u2192 \u5177\u4f53\u8bed\u8a00 VM\u201d \u7684\u6784\u5efa\u6743\u4ea4\u7ed9 LanguageContext\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#5-creategcl58l62","title":"5. CreateGC\uff08L58\u2013L62\uff09","text":"<p><code>mem::CreateGC&lt;EtsLanguageConfig&gt;(gcType, objectAllocator, settings)</code>\uff1a - ETS \u7684 GC \u914d\u7f6e\u901a\u8fc7 <code>EtsLanguageConfig</code> \u53c2\u4e0e\u9009\u62e9/\u5b9e\u4f8b\u5316\uff08\u4e0d\u540c\u8bed\u8a00\u53ef\u80fd\u5f71\u54cd barrier/\u5bf9\u8c61\u6a21\u578b\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#6-throwstackoverflowexceptionl64l77","title":"6. ThrowStackOverflowException\uff08L64\u2013L77\uff09","text":"<p>\u5173\u952e\u94fe\u8def\uff1a - <code>EtsCoroutine::CastFromThread(thread)</code> \u83b7\u53d6\u534f\u7a0b - \u53d6 <code>EtsClassLinker*</code>\uff08\u901a\u8fc7 VM\uff09 - <code>GetStackOverflowErrorClassDescriptor()</code> \u5f97\u5230\u5f02\u5e38\u7c7b descriptor - <code>classLinker-&gt;GetClass(descriptor, true)</code> \u83b7\u53d6 <code>EtsClass*</code> - \u521b\u5efa\u5f02\u5e38\u5bf9\u8c61 <code>EtsObject::Create(cls)</code> \u5e76\u8bbe\u7f6e\u5230 coroutine exception</p> <p>\u8fd9\u5bf9\u5e94 core \u8bed\u8a00\u91cc\u7528 <code>ObjectHeader::Create(cls)</code> \u521b\u5efa\u5f02\u5e38\u5bf9\u8c61\u7684\u8def\u5f84\uff0c\u4f46 ETS \u4f7f\u7528 ETS \u7c7b\u578b\u7cfb\u7edf\u5305\u88c5\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.cpp/#7-getverificationinitapil79l105","title":"7. GetVerificationInitAPI\uff08L79\u2013L105\uff09","text":"<p>\u8fd4\u56de verification \u521d\u59cb\u5316\u6570\u636e\uff1a - primitiveRootsForVerification\uff1a\u5305\u542b TAGGED/VOID/U1..F64 \u7b49\u7c7b\u578b\u96c6\u5408 - arrayElementsForVerification\uff1a<code>[Z [B [S [C [I [J [F [D</code>\uff08\u5e03\u5c14/\u5b57\u8282/\u77ed/char/int/long/float/double\uff09 - isNeed*SyntheticClass\uff1a   - need Class synthetic\uff1atrue   - need Object/String synthetic\uff1afalse</p> <p>\u8fd9\u76f4\u63a5\u5f71\u54cd verification \u7ae0\u8282\uff0806\uff09\u7684\u201c\u57fa\u7840\u7c7b\u578b roots \u4e0e\u5408\u6210\u7c7b\u9700\u6c42\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/","title":"<code>plugins/ets/runtime/ets_language_context.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aETS \u7684 <code>LanguageContextBase</code> \u58f0\u660e\uff1a\u63d0\u4f9b descriptor/\u540d\u79f0\u5e38\u91cf\u3001class init \u7b56\u7565\u3001builder \u5de5\u5382\u3001VM/GC \u5de5\u5382\u3001verification \u521d\u59cb\u5316\u4fe1\u606f\u7b49\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#1-l19l46","title":"1. \u4f9d\u8d56\u4e0e\u6574\u4f53\u5b9a\u4f4d\uff08L19\u2013L46\uff09","text":"<p>\u8be5\u5934\u6587\u4ef6\u628a ETS \u4e0e runtime \u7684\u201c\u63a5\u53e3\u5951\u7ea6\u201d\u57fa\u672c\u4e00\u6b21\u6027\u5217\u5168\uff1a - \u7ee7\u627f <code>LanguageContextBase</code>\uff08runtime/include/language_context.h\uff09 - \u76f4\u63a5\u4f9d\u8d56 class linker\uff08<code>class_linker.h</code>\u3001<code>class_linker_extension.h</code>\u3001<code>class_initializer.h</code>\uff09 - \u4f9d\u8d56 <code>ITableBuilder/VTableBuilder</code>\uff08\u8bf4\u660e ETS \u4f1a\u81ea\u5b9a\u4e49 builder\uff09 - \u4f9d\u8d56 GC\uff08<code>gc.h/gc_types/gc_settings</code>\uff09\u4e0e allocator\uff08\u8868\u660e LanguageContext \u4e5f\u53c2\u4e0e\u521b\u5efa GC\uff09 - ETS \u79c1\u6709\u4f9d\u8d56\uff1a<code>ets_panda_file_items.h</code>\uff08descriptor \u5e38\u91cf\u6e90\uff09\u3001<code>pt_ets_extension</code>\uff08\u8c03\u8bd5/\u5de5\u5177\u6269\u5c55\uff09\u3001<code>ets_vm.h</code>\u3001<code>ets_class_linker_extension.h</code></p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#2-l58l66","title":"2. \u8bed\u8a00\u8eab\u4efd\uff08L58\u2013L66\uff09","text":"<ul> <li><code>GetLanguage()</code> \u56fa\u5b9a\u8fd4\u56de <code>SourceLang::ETS</code></li> <li><code>GetLanguageType()</code> \u8fd4\u56de <code>EtsLanguageConfig::LANG_TYPE</code></li> </ul> <p>\u8fd9\u662f LanguageContext \u4e0e <code>extensions_[langIndex]</code>\u3001\u4ee5\u53ca runtime \u7684\u7c7b\u578b\u5206\u53d1\u7684\u57fa\u7840\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#3-descriptor-ets-l68l250","title":"3. Descriptor / \u540d\u79f0\u5e38\u91cf\uff1a\u628a ETS \u7684\u201c\u6839\u7c7b/\u9519\u8bef\u7c7b/\u7279\u6b8a\u540d\u5b57\u201d\u6620\u5c04\u5230\u5b57\u7b26\u4e32\uff08L68\u2013L250\uff09","text":"<p>\u8fd9\u4e00\u5927\u6bb5\u57fa\u672c\u90fd\u662f\uff1a - \u4ece <code>plugins/ets/runtime/ets_panda_file_items.h</code> \u62ff\u5230\u5e38\u91cf string - \u901a\u8fc7 <code>utf::CStringAsMutf8(...)</code> \u8f6c\u6210 MUTF8 \u6307\u9488\u8fd4\u56de</p> <p>\u8986\u76d6\u8303\u56f4\u5305\u62ec\uff1a - roots\uff1aOBJECT\u3001CLASS\u3001NULL_VALUE\u3001CLASS_ARRAY\u3001STRING_ARRAY - \u7279\u6b8a\u65b9\u6cd5\u540d\uff1a<code>&lt;init&gt;</code>\uff08CTOR\uff09\u3001<code>&lt;clinit&gt;</code>\uff08CCTOR\uff09 - \u5e38\u89c1\u5f02\u5e38/\u9519\u8bef\u7c7b descriptor\uff1aNPE\u3001SOE\u3001AIOOBE\u3001ClassCast\u3001AbstractMethodError\u3001OOM\u3001NoClassDef\u3001Circularity\u3001VerificationError \u7b49</p> <p>\u8fd9\u4e9b descriptor \u662f ClassLinker/Verifier/Exception \u4f53\u7cfb\u7684\u201c\u7edf\u4e00 key\u201d\uff0c\u7528\u6765\u901a\u8fc7 <code>GetClass(descriptor)</code> \u53d6\u5230\u5bf9\u5e94 <code>Class*</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#4-taggedvalue-overridel252l292","title":"4. TaggedValue \u4e0e\u8c03\u7528\u76f8\u5173\u7684 override\uff08L252\u2013L292\uff09","text":"<p>\u591a\u4e2a\u51fd\u6570\u5bf9 ETS \u6765\u8bf4\u662f <code>UNREACHABLE()</code>\uff1a - <code>GetInitialTaggedValue</code> / <code>GetEncodedTaggedValue</code> - <code>IsCallableObject</code> / <code>GetCallTarget</code> - <code>GetReferenceErrorDescriptor</code> / <code>GetTypedErrorDescriptor</code></p> <p>\u4f46 <code>SetExceptionToVReg</code> \u662f\u6709\u5b9e\u73b0\u7684\uff08L265\u2013L268\uff09\uff1a\u628a\u5f02\u5e38\u5bf9\u8c61\u5199\u5165 accumulator/vreg \u7684 reference \u69fd\u3002</p> <p>\u89e3\u91ca\uff1aETS \u4e0d\u662f\u52a8\u6001\u8bed\u8a00 TaggedValue \u8c03\u7528\u6a21\u578b\uff0c\u56e0\u6b64\u8fd9\u4e9b\u52a8\u6001\u8bed\u8a00\u4e13\u7528\u63a5\u53e3\u5728 ETS \u4e0b\u88ab\u663e\u5f0f\u7981\u6b62\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#5-class-init-l299l313","title":"5. \u6784\u5efa\u5668\u5de5\u5382\u4e0e class init \u7b56\u7565\uff08L299\u2013L313\uff09","text":"<p>\u5173\u952e\u70b9\uff1a - <code>ThrowException</code>\uff1a\u7edf\u4e00\u629b\u5f02\u5e38\u5165\u53e3\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002 - <code>CreateITableBuilder(errHandler)</code>\uff1a\u8fd4\u56de ETS \u7684 itable builder\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code> \u2192 <code>EtsITableBuilder</code>\uff09\u3002 - <code>CreateVTableBuilder(errHandler)</code>\uff1a\u8fd4\u56de ETS \u7684 vtable builder\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code> \u2192 <code>EtsVTableBuilder</code>\uff09\u3002 - <code>InitializeClass(classLinker, thread, klass)</code>\uff1a   - \u76f4\u63a5\u4f7f\u7528 <code>ClassInitializer&lt;MT_MODE_TASK&gt;::Initialize(...)</code>\uff08\u5bf9\u9f50 runtime \u7684 class state machine\uff09\u3002 - <code>CreateClassLinkerExtension()</code>\uff1a   - \u8fd4\u56de <code>std::make_unique&lt;EtsClassLinkerExtension&gt;()</code>\uff08ETS \u63d2\u4ef6\u6269\u5c55\u70b9\u7684\u843d\u5730\u7c7b\u578b\uff09\u3002</p> <p>\u8fd9\u6bb5\u628a 03 \u7ae0\u201c\u8bed\u8a00\u4fa7\u7b56\u7565\u6ce8\u5165\u70b9\u201d\u5168\u90e8\u660e\u786e\u5316\uff1abuilder + extension + initializer \u90fd\u7531 LanguageContext \u51b3\u5b9a\u3002</p>"},{"location":"03_ClassLoading/FileNotes/plugins_ets_runtime_ets_language_context.h/#6-vmgcstackoverflowverificationl315l352","title":"6. VM/GC/StackOverflow/Verification\uff08L315\u2013L352\uff09","text":"<ul> <li><code>CreateVM(runtime, options)</code>\uff1a\u521b\u5efa ETS VM\uff08\u89c1 <code>.cpp</code>\uff09\u3002</li> <li><code>CreateGC(gcType, objectAllocator, settings)</code>\uff1a\u521b\u5efa ETS GC\uff08\u89c1 <code>.cpp</code>\uff0c\u901a\u8fc7 <code>EtsLanguageConfig</code>\uff09\u3002</li> <li><code>ThrowStackOverflowException(thread)</code>\uff1a\u521b\u5efa\u5e76\u8bbe\u7f6e SOE\uff08\u89c1 <code>.cpp</code>\uff09\u3002</li> <li><code>GetVerificationInitAPI()</code>\uff1a\u8fd4\u56de verification \u7684 roots/\u6570\u7ec4\u5143\u7d20/\u5408\u6210\u7c7b\u9700\u6c42\uff08\u89c1 <code>.cpp</code>\uff09\u3002</li> <li><code>GetVerificationTypeClass/Object/Throwable</code>\uff1a\u8fd4\u56de\u9a8c\u8bc1\u7cfb\u7edf\u4e2d\u7528\u4e8e\u5b9a\u4f4d\u6838\u5fc3\u7c7b\u578b\u7684\u201c\u7c7b\u578b\u540d\u5b57\u7b26\u4e32\u201d\u3002</li> <li><code>WrapClassInitializerException</code>\uff1a\u7a7a\u5b9e\u73b0\uff08ETS \u5f53\u524d\u4e0d\u5305\u88c5 class init \u5f02\u5e38\uff09\u3002</li> <li><code>CreatePtLangExt</code>\uff1a\u8fd4\u56de <code>PtEtsExtension</code>\uff08\u8c03\u8bd5/\u5de5\u5177\u6269\u5c55\uff09\u3002</li> <li><code>HasValueEqualitySemantic</code>\uff1atrue\uff08ETS \u503c\u8bed\u4e49\u76f8\u5173\u884c\u4e3a\u5f00\u5173\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/","title":"<code>runtime/class_linker.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u89c4\u6a21\uff1a1895 \u884c\uff08\u5b9e\u73b0\u6587\u4ef6\uff0c\u6309\u201c\u51fd\u6570\u7c07 + \u884c\u6bb5\u201d\u505a\u9010\u884c\u8bb0\u5f55\uff09 \u76ee\u6807\uff1a\u628a ClassLinker \u7684\u771f\u5b9e\u6267\u884c\u7ba1\u7ebf\u3001\u5e03\u5c40\u7b97\u6cd5\u3001\u7f13\u5b58/\u5e76\u53d1\u7b56\u7565\u3001\u4ee5\u53ca AOT/boot filter \u7684\u63a5\u5165\u70b9\u8bb2\u6e05\u695a\u3002</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#getclass-loadclass-link","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aGetClass \u2192 LoadClass \u2192 Link\uff08\u672c\u6587\u4ef6\u4e3b\u7ebf\uff09","text":"<pre><code>flowchart TD\n  A[\"GetClass(descriptor/pf,id)\"] --&gt; B{\"context \u7f13\u5b58\u547d\u4e2d\uff1f\\nFindLoadedClass\"}\n  B --&gt;|\u662f| R1[\"\u8fd4\u56de Class*\"]\n  B --&gt;|\u5426| C{\"union/array?\"}\n  C --&gt;|union| U[\"LoadUnionClass\\nLoadConstituentClasses\"] --&gt; L[\"LoadClass(\u4e3b\u7ba1\u7ebf)\"]\n  C --&gt;|array| AR[\"LoadArrayClass\\ncomponent resolve\"] --&gt; L\n  C --&gt;|\u666e\u901a| D{\"boot context?\"}\n  D --&gt;|\u662f| F[\"boot bloom filter + bootPandaFiles \u67e5 classId\"] --&gt; L\n  D --&gt;|\u5426| E[\"context-&gt;LoadClass(\u865a\u51fd\u6570)\\n(ETS \u6709\u7279\u5316)\"] --&gt; L\n  L --&gt; M[\"SetupClassInfo\\nCreate builders + compute size\"]\n  M --&gt; N[\"CreateClass(ext)\\nLoadMethods/LoadFields\"]\n  N --&gt; O[\"LinkMethods\\n(vtable/itable/IMT)\"]\n  O --&gt; P[\"LinkFields\\n(LayoutFields \u5199 offset/refFields/objectSize)\"]\n  P --&gt; Q[\"InsertClass \u5e76\u53d1\u53bb\u91cd\\n(\u5931\u8d25\u5219\u56de\u6536\u65b0\u5bf9\u8c61)\"]\n  Q --&gt; R2[\"\u8fd4\u56de Class* / nullptr\"]</code></pre>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#0-include-l16l49","title":"0. \u9876\u90e8 include \u4e0e\u547d\u540d\u7a7a\u95f4\uff08L16\u2013L49\uff09","text":"<ul> <li>L16\uff1a\u5b9e\u73b0\u5bf9\u5e94\u5934\uff1a<code>runtime/include/class_linker.h</code>\u3002</li> <li>L17\uff1abridge\uff1a<code>GetCompiledCodeToInterpreterBridge</code>\uff08LoadMethod \u8bbe\u7f6e entrypoint \u7528\uff09\u3002</li> <li>L18\u2013L19\uff1a<code>cha.h</code>\u3001<code>class_initializer.h</code>\uff08\u7c7b\u521d\u59cb\u5316\u4e0e CHA \u76f8\u5173\uff09\u3002</li> <li>L33\u2013L39\uff1apanda_file \u7684\u5404\u7c7b accessor\uff08Class/Method/Field/Proto/Code\uff09\u4e0e <code>panda_cache.h</code>\uff08\u7f13\u5b58\uff09\u3002</li> <li>L45\u2013L49\uff1a<code>namespace ark</code>\uff1b<code>using Type/SourceLang</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#1-pandafile-classlinkeraddpandafilel50l79","title":"1. PandaFile \u6ce8\u518c\uff1a<code>ClassLinker::AddPandaFile</code>\uff08L50\u2013L79\uff09","text":"<p>\u6838\u5fc3\u903b\u8f91\uff1a - L58\u2013L61\uff1a\u5728 <code>pandaFilesLock_</code> \u4e0b\u628a <code>{context, pf}</code> push \u5230 <code>pandaFiles_</code>\uff08\u5168\u91cf\u6587\u4ef6\u96c6\uff09\u3002 - L63\uff1a\u8c03\u7528 <code>AotManager::UpdatePandaFilesSnapshot(file, context, IsArkAot)</code>\uff0c\u8ba9 AOT \u4fa7\u540c\u6b65\u53ef\u89c1\u6587\u4ef6\u96c6\u3002 - L65\u2013L71\uff1a\u5982\u679c\u662f boot context\uff08\u6216 context==nullptr\uff09\uff1a   - \u52a0\u5165 <code>bootPandaFiles_</code>\uff08\u53d7 <code>bootPandaFilesLock_</code> \u4fdd\u62a4\uff09   - \u5982\u679c\u542f\u7528 <code>boot class filter</code>\uff08bloom filter\uff09\uff0c\u8c03\u7528 <code>AddBootClassFilter(file)</code> \u9884\u70ed\u8fc7\u6ee4\u5668\u3002 - L73\u2013L76\uff1aRuntime \u5df2\u521d\u59cb\u5316\u65f6\uff0c\u53d1\u51fa <code>LoadModuleEvent</code>\uff08\u901a\u77e5\u7cfb\u7edf\uff09\u3002 - L78\uff1a<code>tooling::DebugInf::AddCodeMetaInfo</code>\uff08\u8c03\u8bd5\u5143\u4fe1\u606f\u6ce8\u518c\uff09\u3002</p> <p>\u7ed3\u8bba\uff1aAddPandaFile \u662f\u201c\u6587\u4ef6\u6ce8\u518c\u4e2d\u5fc3\u201d\uff1a\u5b83\u540c\u65f6\u9a71\u52a8 AOT snapshot\u3001boot files \u96c6\u5408\u3001\u4ee5\u53ca\u8c03\u8bd5/\u901a\u77e5\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#2-freeclassdatafreeclassclasslinkerl81l160","title":"2. \u91ca\u653e\u8def\u5f84\uff1a<code>FreeClassData/FreeClass/~ClassLinker</code>\uff08L81\u2013L160\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#21-freeclassdatal81l147","title":"2.1 <code>FreeClassData</code>\uff08L81\u2013L147\uff09","text":"<ul> <li>\u91ca\u653e <code>fields</code> \u6570\u7ec4\uff08L83\u2013L87\uff09\u3002</li> <li>\u91ca\u653e <code>methods</code> \u6570\u7ec4\u524d\uff0c\u5148\u91ca\u653e\u6bcf\u4e2a method \u7684 <code>ProfilingData</code>\uff08L91\u2013L97\uff09\u3002   \u8fd9\u91cc\u5f3a\u8c03\uff1aprofiling data \u901a\u8fc7 <code>InternalAllocator</code> \u5206\u914d\uff0c\u56e0\u6b64\u4e5f\u5fc5\u987b\u901a\u8fc7\u540c allocator free\u3002</li> <li>\u5bf9 copied methods\uff08default interface method \u62f7\u8d1d\u51fa\u6765\u7684 Method\uff09\uff1a</li> <li>L99\u2013L120\uff1a\u5b58\u5728\u201cprofilingData \u501f\u7528\u539f\u65b9\u6cd5\u201d\u7684\u53ef\u80fd\u6027\uff0c\u6545\u5148\u5728\u539f methods \u4e2d\u67e5\u540c (fileId,pf) \u7684\u65b9\u6cd5\uff0c     \u4ec5\u5f53 copied method \u7684 profilingData \u5e76\u975e\u6307\u5411\u539f\u65b9\u6cd5\u7684\u540c\u4e00\u5757\u65f6\u624d free\uff08L115\u2013L119\uff09\u3002</li> <li>L125\u2013L136\uff1a\u91ca\u653e itable \u53ca\u5176\u6bcf\u4e2a entry \u7684 methods span\uff1b\u6570\u7ec4\u7c7b\u53ef\u80fd\u4e0d\u62e5\u6709\u81ea\u5df1\u7684 itable\uff08<code>!IsArrayClass()</code>\uff09\u3002</li> <li>L137\u2013L146\uff1a\u91ca\u653e interfaces / constituent types spans\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#22-freeclassl149l153","title":"2.2 <code>FreeClass</code>\uff08L149\u2013L153\uff09","text":"<p>\u5148 <code>FreeClassData</code>\uff0c\u518d\u59d4\u6258 extension \u505a\u8bed\u8a00\u7279\u5b9a\u7684 <code>FreeClass</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#23-l155l160","title":"2.3 \u6790\u6784\uff08L155\u2013L160\uff09","text":"<p>\u91ca\u653e <code>copiedNames_</code> \u4e2d\u4fdd\u5b58\u7684\u201c\u88ab\u590d\u5236\u8fc7\u7684 descriptor \u5b57\u7b26\u4e32\u201d\u5185\u5b58\uff08\u7531 <code>CopyMutf8String</code> \u5206\u914d\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#3-extension-classlinkerclasslinkerresetextensionl162l179","title":"3. \u6784\u9020\u4e0e extension \u88c5\u914d\uff1a<code>ClassLinker::ClassLinker/ResetExtension</code>\uff08L162\u2013L179\uff09","text":"<ul> <li>L164\u2013L168\uff1a\u521d\u59cb\u5316\uff1a</li> <li><code>aotManager_ = MakePandaUnique&lt;AotManager&gt;()</code></li> <li><code>isTraceEnabled_</code> \u6765\u81ea options</li> <li><code>bootClassFilter_</code> \u4ee5\u5e38\u91cf\u53c2\u6570\u6784\u9020\uff08NUM_BOOT_CLASSES / FILTER_RATE\uff09\u3002</li> <li>L170\u2013L172\uff1a\u628a\u5916\u90e8\u4f20\u5165\u7684 extensions vector \u8f6c\u6362\u586b\u5145\u5230 <code>extensions_[langIndex]</code>\u3002</li> <li>L175\u2013L179\uff1a<code>ResetExtension(lang)</code>\uff1a\u901a\u8fc7 <code>Runtime::GetLanguageContext(lang)</code> \u91cd\u65b0\u521b\u5efa\u8be5\u8bed\u8a00 extension\uff08\u70ed\u66f4/\u91cd\u7f6e\u573a\u666f\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#4-initializeinitializerootsl187l221","title":"4. \u521d\u59cb\u5316\uff1a<code>Initialize/InitializeRoots</code>\uff08L187\u2013L221\uff09","text":"<ul> <li>Initialize\uff1a\u904d\u5386\u6240\u6709 non-null extension\uff0c\u8c03\u7528 <code>ext-&gt;Initialize(this, compressedStringEnabled)</code>\uff1b\u6210\u529f\u540e <code>isInitialized_ = true</code>\u3002</li> <li>InitializeRoots\uff1a\u904d\u5386 extension \u8c03 <code>ext-&gt;InitializeRoots(thread)</code>\uff0c\u7528\u4e8e\u6784\u5efa class roots\uff08Object/Class/String/Array\u2026\uff09\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u4f53\u73b0\u4e86\u4e24\u9636\u6bb5\uff1aInitialize\uff08\u521d\u59cb\u5316 extension \u4e0e linker\uff09 \u4e0e InitializeRoots\uff08\u6784\u5efa\u6839\u7c7b\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#5-boot-files-findclassinpandafiles-findloadedclassl223l242","title":"5. Boot files \u67e5\u627e\uff1a<code>FindClassInPandaFiles</code> + <code>FindLoadedClass</code>\uff08L223\u2013L242\uff09","text":"<ul> <li><code>FindClassInPandaFiles(descriptor, pandaFiles)</code>\uff1a\u7ebf\u6027\u626b\u63cf\u6587\u4ef6\u5217\u8868\uff0c<code>pf-&gt;GetClassId(descriptor)</code> \u547d\u4e2d\u4e14\u975e external \u5219\u8fd4\u56de <code>(classId,pf)</code>\u3002</li> <li><code>FindLoadedClass(descriptor, context)</code>\uff1a\u76f4\u63a5\u8f6c\u53d1 <code>context-&gt;FindClass</code>\uff08\u5185\u90e8\u5e26 <code>classesLock_</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#6-class-getclasssizel244l297","title":"6. \u8ba1\u7b97 Class \u5bf9\u8c61\u603b\u5927\u5c0f\uff1a<code>GetClassSize</code>\uff08L244\u2013L297\uff09","text":"<p>\u8be5\u6a21\u677f\u51fd\u6570\u679a\u4e3e \u9759\u6001\u5b57\u6bb5\u7c7b\u578b\u5206\u5e03\uff0c\u7edf\u8ba1\uff1a - 8/16/32/64 \u4f4d primitive - reference - tagged\uff08\u52a8\u6001\u8bed\u8a00 TaggedValue\uff09</p> <p>\u5e76\u8c03\u7528\uff1a - L295\u2013L296\uff1a<code>Class::ComputeClassSize(vtableSize, imtSize, numXxxSfields...)</code></p> <p>\u5173\u952e\u70b9\uff1aClass \u7684\u5185\u5b58\u5927\u5c0f\u4e0d\u4ec5\u53d6\u51b3\u4e8e vtable/imt\uff0c\u8fd8\u53d6\u51b3\u4e8e\u9759\u6001\u5b57\u6bb5\u7c7b\u578b\u5206\u5e03\uff08\u5e03\u5c40\u7531 Class::ComputeClassSize \u5b9a\u4e49\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#7-setupclassinfo-builder-sizel345l421","title":"7. SetupClassInfo\uff1a\u521b\u5efa\u4e09\u7c7b builder \u5e76\u7b97 size\uff08L345\u2013L421\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#71-a-panda_fileclassdataaccessorl345l370","title":"7.1 \u7248\u672c A\uff1a\u57fa\u4e8e <code>panda_file::ClassDataAccessor*</code>\uff08L345\u2013L370\uff09","text":"<ul> <li>L349\uff1a<code>LanguageContext ctx = Runtime::GetLanguageContext(dataAccessor)</code>\uff08\u4ece classData \u89e3\u6790\u8bed\u8a00\uff09\u3002</li> <li>L351\u2013L353\uff1a\u521b\u5efa builder\uff1a</li> <li><code>ctx.CreateVTableBuilder(errorHandler)</code></li> <li><code>ctx.CreateITableBuilder(errorHandler)</code></li> <li><code>ctx.CreateIMTableBuilder()</code></li> <li>L356\u2013L358\uff1aitableBuilder \u5148 Build\uff08\u9700\u8981 base + interfaces + \u662f\u5426\u63a5\u53e3\uff09\u3002</li> <li>L360\u2013L363\uff1avtableBuilder Build \u5931\u8d25\u5219\u91ca\u653e itable/interfaces\uff08<code>FreeITableAndInterfaces</code>\uff09\u3002</li> <li>L364\uff1aimtableBuilder Build\u3002</li> <li>L366\u2013L368\uff1a\u901a\u8fc7 wrapper \u679a\u4e3e\u9759\u6001\u5b57\u6bb5\u7c7b\u578b \u2192 <code>GetClassSize</code> \u7b97\u51fa <code>info.size</code> \u4e0e <code>info.numSfields</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#72-b-spanmethodspanfieldl397l421","title":"7.2 \u7248\u672c B\uff1a\u57fa\u4e8e <code>Span&lt;Method&gt;/Span&lt;Field&gt;</code>\uff08L397\u2013L421\uff09","text":"<p>\u7528\u4e8e <code>BuildClass</code>\uff08\u5408\u6210\u7c7b\uff09\u8def\u5f84\uff1a\u8bed\u8a00\u4ece <code>*base</code> \u51b3\u5b9a\uff08L400\uff09\uff0c\u5176\u4f59\u6b65\u9aa4\u4e0e\u7248\u672c A \u4e00\u81f4\u3002</p> <p>\u7ed3\u8bba\uff1aSetupClassInfo \u662f\u7ba1\u7ebf\u7684\u201c\u88c5\u914d\u70b9\u201d\uff1a\u5b83\u540c\u65f6\u51b3\u5b9a\u4e09\u7c7b\u6d3e\u53d1\u8868\u6784\u5efa\u7b56\u7565\u4e0e class \u5bf9\u8c61\u6574\u4f53\u5e03\u5c40\u5927\u5c0f\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#8-loadmethod-copied-methods-aot-l423l545","title":"8. LoadMethod / copied methods / AOT \u5165\u53e3\u70b9\uff08L423\u2013L545\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#81-loadmethodl423l453","title":"8.1 <code>LoadMethod</code>\uff08L423\u2013L453\uff09","text":"<ul> <li>\u53d6 proto shorty\uff1a<code>ProtoDataAccessor pda(pf, protoId)</code>\u3002</li> <li>\u6839\u636e ctor/cctor \u540d\u79f0\u4e3a method \u6253\u4e0a <code>ACC_CONSTRUCTOR</code>\uff08L431\u2013L434\uff09\u3002</li> <li>\u8ba1\u7b97 <code>numArgs</code>\uff1astatic \u7528 <code>pda.GetNumArgs()</code>\uff0c\u975e static +1\uff08\u9690\u5f0f this\uff09\uff08L437\uff09\u3002</li> <li>\u82e5\u65e0 codeId\uff08L439\u2013L447\uff09\uff1a</li> <li><code>InitializeMemory(method, klass, pf, methodId, codeId=0, accessFlags, numArgs, shorty)</code></li> <li>native\uff1a<code>SetCompiledEntryPoint(ext-&gt;GetNativeEntryPointFor(method))</code></li> <li>\u975e native\uff1a<code>SetInterpreterEntryPoint()</code>\uff08C2I bridge\uff09</li> <li>\u82e5\u6709 codeId\uff08L448\u2013L452\uff09\uff1a</li> <li><code>InitializeMemory(..., codeId)</code></li> <li><code>SetCompiledEntryPoint(GetCompiledCodeToInterpreterBridge(method))</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#82-aot-maybelinkmethodtoaotcodel455l472","title":"8.2 AOT \u94fe\u63a5\uff1a<code>MaybeLinkMethodToAotCode</code>\uff08L455\u2013L472\uff09","text":"<p>\u82e5 method \u975e intrinsic \u4e14 AOT class \u6709\u8be5 methodIndex \u7684 code entry\uff0c\u5219\u76f4\u63a5\u628a entrypoint \u5207\u5230 AOT code\uff08\u5e76\u6253\u4e8b\u4ef6\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#83-copied-methodssetupcopiedmethodsl474l493","title":"8.3 copied methods\uff1a<code>SetupCopiedMethods</code>\uff08L474\u2013L493\uff09","text":"<p>\u628a vtable builder \u4ea7\u51fa\u7684 <code>CopiedMethod</code> \u590d\u5236\u6210\u65b0\u7684 <code>Method</code> \u5bf9\u8c61\uff1a - <code>InitializeMemory(method, copiedMethods[i].GetMethod())</code>\uff08\u8c03\u7528 Method \u7684\u201c\u4ece Method* \u62f7\u8d1d\u6784\u9020\u201d\uff09 - <code>SetIsDefaultInterfaceMethod()</code> - \u82e5 status \u662f ABSTRACT/CONFLICT\uff0c\u8bbe\u7f6e entrypoint \u4e3a\u5bf9\u5e94 stub\uff08AbstractMethodError / DefaultConflict\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#84-loadmethodsl495l545","title":"8.4 <code>LoadMethods</code>\uff08L495\u2013L545\uff09","text":"<p>\u8981\u70b9\uff1a - \u8ba1\u7b97 vmethods/smethods \u5206\u533a\uff08L500\u2013L502\uff09\u3002 - totalNumMethods = \u539f methods + copiedMethods\uff08L503\u2013L505\uff09\u3002 - \u5206\u914d\u8fde\u7eed <code>Span&lt;Method&gt;</code>\uff08L509\uff09\u3002 - \u679a\u4e3e panda_file \u65b9\u6cd5\uff1a   - static \u653e\u5165 <code>methods[smethodIdx++]</code>\uff0cvirtual \u653e <code>methods[vmethodIdx++]</code>\uff08L529\uff09\u3002   - <code>LoadMethod</code> \u521d\u59cb\u5316\u3002   - \u82e5 AOT class valid \u2192 <code>MaybeLinkMethodToAotCode</code>\uff08L531\u2013L533\uff09\u3002   - abstract method \u76f4\u63a5\u628a entrypoint \u8bbe\u4e3a <code>GetAbstractMethodStub()</code>\uff08L534\u2013L538\uff09\uff0c\u907f\u514d\u6bcf\u6b21\u6d3e\u53d1\u524d\u5224\u65ad abstract\u3002 - \u672b\u5c3e <code>SetupCopiedMethods</code>\uff0c\u5e76 <code>klass-&gt;SetMethods(methods, numVmethods, numSmethods)</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#9-loadfields-field-l547l571","title":"9. <code>LoadFields</code>\uff1a\u6784\u5efa Field \u6570\u7ec4\uff08L547\u2013L571\uff09","text":"<ul> <li>\u5206\u914d <code>Span&lt;Field&gt; fields</code>\uff0c\u5e76\u6309 static/instance \u5206\u533a\u5199\u5165\uff08L559\u2013L566\uff09\uff1a</li> <li><code>InitializeMemory(field, klass, fieldId, accessFlags, TypeFromEncoding(fda.GetType()))</code></li> <li><code>klass-&gt;SetFields(fields, numSfields)</code>\uff08L568\uff09\u3002</li> </ul> <p>\u4e0e <code>field.h</code> \u5bf9\u9f50\uff1aField \u7684 type \u7f16\u7801\u8fdb <code>accessFlags_</code>\uff1boffset \u4ecd\u672a\u8bbe\u7f6e\uff0c\u540e\u7eed\u7531 LayoutFields \u5199\u5165\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#10-layoutfieldsl573l819","title":"10. \u5b57\u6bb5\u5e03\u5c40\u7b97\u6cd5\uff1a<code>LayoutFields*</code>\uff08L573\u2013L819\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#101-l577l581","title":"10.1 \u6838\u5fc3\u8bbe\u8ba1\u76ee\u6807\uff08L577\u2013L581\uff09","text":"<p>\u6ce8\u91ca\u660e\u786e\uff1a\u5fc5\u987b\u4fdd\u6301\u4e0e\u201c\u8bed\u8a00\u4fa7 class \u8868\u793a\u201d\u4e00\u81f4\u7684\u5b57\u6bb5\u987a\u5e8f\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u5982 String \u7684\u5b57\u6bb5\u987a\u5e8f\u4e0d\u4e00\u81f4\u95ee\u9898\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#102-layoutfieldswithoutalignmentl573l601","title":"10.2 <code>LayoutFieldsWithoutAlignment</code>\uff08L573\u2013L601\uff09","text":"<p>\u5bf9\u540c\u5c3a\u5bf8\u5b57\u6bb5\u5217\u8868\u6309\u987a\u5e8f\u6279\u91cf\u5199 offset\uff1a - \u6b63\u5411\uff1a<code>field-&gt;SetOffset(*offset); *offset += size</code> - \u9006\u5411\uff08REVERSE_LAYOUT=true\uff09\uff1a\u7528\u4e8e\u628a\u5b50\u7c7b\u5c0f\u5b57\u6bb5\u585e\u56de base \u7684 padding \u672b\u5c3e\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#103-layoutreferencefieldsl603l621","title":"10.3 \u5f15\u7528\u5b57\u6bb5\u7279\u6b8a\u5904\u7406\uff1a<code>LayoutReferenceFields</code>\uff08L603\u2013L621\uff09","text":"<p>\u5148\u5e03\u5c40 <code>volatile</code> \u5f15\u7528\u5b57\u6bb5\uff0c\u518d\u5e03\u5c40\u975e volatile\uff1b\u8fd4\u56de volatile \u5f15\u7528\u5b57\u6bb5\u6570\u91cf\u3002 \u8fd9\u548c <code>Class::SetVolatileRefFieldsNum/SetRefFieldsOffset</code> \u914d\u5957\uff0c\u7528\u4e8e GC/\u5e76\u53d1\u53ef\u89c1\u6027\u7b56\u7565\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#104-padding-layoutfieldsinbaseclasspaddingl629l661","title":"10.4 \u201c\u57fa\u7c7b padding \u56de\u586b\u201d\uff1a<code>LayoutFieldsInBaseClassPadding</code>\uff08L629\u2013L661\uff09","text":"<p>\u786e\u5b9a\u8d77\u59cb offset\uff1a - static\uff1a<code>klass-&gt;GetStaticFieldsOffset()</code> - instance\uff1a<code>base-&gt;GetObjectSize()</code> \u6216 <code>ObjectHeaderSize()</code></p> <p>\u6839\u636e\u201c\u6700\u9ad8\u5bf9\u9f50\u9700\u6c42\u201d\uff08ref &gt; 64 &gt; 32 &gt; 16\uff09\u5bf9\u9f50\u5230 <code>alignOffset</code>\uff0c\u82e5\u6709 padding\uff0c\u5219 \u9006\u5411\u628a 32/16/8 \u4f4d\u5b57\u6bb5\u585e\u8fdb padding\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#105-layoutfieldsl664l717","title":"10.5 \u4e3b\u5e03\u5c40\uff1a<code>LayoutFields</code>\uff08L664\u2013L717\uff09","text":"<p>\u987a\u5e8f\uff1a 1) \u5148\u5904\u7406 refFields\uff1a\u5bf9\u9f50\u5230 OBJECT_POINTER_SIZE\uff0c\u5199 <code>refFieldsNum/refFieldsOffset/volatileRefFieldsNum</code> 2) \u5904\u7406 TaggedValue \u4e0e 64 \u4f4d\u5b57\u6bb5\uff1a\u5fc5\u8981\u65f6\u7528 32/16/8 \u586b\u5145\u5bf9\u9f50\u7f3a\u53e3 3) \u518d\u5904\u7406 32 \u4f4d\u5b57\u6bb5\uff1a\u5fc5\u8981\u65f6\u7528 16/8 \u586b\u5145 4) \u518d\u5904\u7406 16 \u4f4d\u5b57\u6bb5\uff1a\u5fc5\u8981\u65f6\u7528 8 \u586b\u5145 5) \u6700\u540e\u5904\u7406 8 \u4f4d\u5b57\u6bb5</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#106-classlinkerlayoutfieldsl732l791","title":"10.6 \u5bf9\u5916\u5165\u53e3\uff1a<code>ClassLinker::LayoutFields</code>\uff08L732\u2013L791\uff09","text":"<p>\u628a fields \u6309\u7c7b\u578b\u5206\u6876\u5230 tagged/64/32/16/8/ref\uff0c\u7136\u540e\u8c03\u7528 <code>ark::LayoutFields(...)</code> \u5f97\u5230\u6700\u7ec8 size\uff1a - instance \u4e14\u975e variable-size\uff1a<code>klass-&gt;SetObjectSize(size)</code>\uff08L786\u2013L788\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#107-linkmethodslinkfieldsl793l819","title":"10.7 <code>LinkMethods/LinkFields</code>\uff08L793\u2013L819\uff09","text":"<ul> <li><code>LinkMethods</code>\uff1a<code>vtableBuilder-&gt;UpdateClass</code> \u5199\u56de vtableIndex \u7b49\uff1b<code>itableBuilder-&gt;Resolve/UpdateClass</code>\uff1b<code>imtableBuilder-&gt;UpdateClass</code>\u3002</li> <li><code>LinkFields</code>\uff1a\u5206\u522b\u5bf9 static/instance fields \u8c03 <code>LayoutFields</code>\uff0c\u5931\u8d25\u5219 log \u5e76\u8fd4\u56de false\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a\u5b57\u6bb5 offset \u7684\u552f\u4e00\u5199\u5165\u70b9\u5c31\u5728\u8fd9\u91cc\uff0c\u5b83\u76f4\u63a5\u51b3\u5b9a\u5bf9\u8c61\u5e03\u5c40\u4e0e\u53cd\u5c04/\u89e3\u91ca\u5668\u5b57\u6bb5\u8bbf\u95ee\u7684\u6b63\u786e\u6027\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#11-baseinterfaces-loadclass-l821l1103","title":"11. base/interfaces \u89e3\u6790\u4e0e\u4e3b LoadClass \u7ba1\u7ebf\uff08L821\u2013L1103\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#111-loadbaseclassl821l841","title":"11.1 <code>LoadBaseClass</code>\uff08L821\u2013L841\uff09","text":"<p>\u4ece superClassId \u89e3\u6790 base\uff1a - offset==0 \u2192 Object root - \u5426\u5219\u901a\u8fc7 extension \u7684 <code>GetClass(pf, baseClassId, context, handler)</code> \u83b7\u53d6 base\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#112-loadinterfacesl843l872","title":"11.2 <code>LoadInterfaces</code>\uff08L843\u2013L872\uff09","text":"<p>\u5206\u914d <code>Span&lt;Class*&gt;</code>\uff0c\u9010\u4e2a <code>GetClass(pf, ifaceId, context, handler)</code>\uff1b\u5931\u8d25\u5219\u91ca\u653e\u6570\u7ec4\u5e76\u8fd4\u56de empty optional\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#113-l874","title":"11.3 \u201c\u5e76\u53d1\u52a0\u8f7d/\u5faa\u73af\u68c0\u6d4b\u201d\u9aa8\u67b6\uff08L874+\uff09","text":"<p>\u6587\u4ef6\u4e2d\u5f15\u5165 <code>ClassLoadingSet</code> \u4e0e <code>ClassScopeStaticSetAutoCleaner</code>\uff08\u89c1\u540e\u7eed\u5b9e\u9645\u4f7f\u7528\u70b9\uff09\uff0c\u7528\u4e8e\u9632\u6b62\u540c\u7ebf\u7a0b\u9012\u5f52\u52a0\u8f7d\u5bfc\u81f4\u7684\u5faa\u73af\u95ee\u9898\uff1b\u5176\u6838\u5fc3\u662f\u628a <code>(pandaFileHash,classId)</code> \u7ec4\u5408\u6210\u4e00\u4e2a 64-bit hash\uff08L900\u2013L904\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#114-loadclassclassdataaccessor-l906l959","title":"11.4 <code>LoadClass(ClassDataAccessor*, ...)</code>\uff08L906\u2013L959\uff09","text":"<p>\u5173\u952e\u9636\u6bb5\uff1a 1) <code>SetupClassInfo</code>\uff08builders + size + numSfields\uff09 2) <code>ext-&gt;CreateClass(descriptor, vtableSize, imtSize, size)</code> \u521b\u5efa <code>Class</code> \u5bf9\u8c61\uff08L916\u2013L919\uff09 3) \u5199\u5165 class \u5143\u4fe1\u606f\uff1acontext/base/interfaces/fileId/pandaFile/accessFlags/indexes\uff08L924\u2013L936\uff09 4) \u5199\u5165 counts\uff1anumVirtualMethods/numCopiedMethods/numStaticFields\uff08L937\u2013L939\uff09 5) onFail lambda\uff1a\u5931\u8d25\u7edf\u4e00 <code>FreeClass(klass)</code> \u5e76\u6253 log\uff08L941\u2013L945\uff09 6) <code>LoadMethods</code> \u2192 <code>LoadFields</code> \u2192 <code>LinkMethods</code> \u2192 <code>LinkFields</code>\uff08L946\u2013L957\uff09 7) \u8fd4\u56de klass\uff08\u4ecd\u672a\u52a0\u5165 context\uff1b\u52a0\u5165\u53d1\u751f\u5728\u66f4\u5916\u5c42 LoadClass wrapper \u4e2d\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#115-runtimecontext-l1088l1102","title":"11.5 \u201c\u52a0\u5165 runtime/context &amp; \u4e8b\u4ef6\u201d\u5305\u88c5\u5c42\uff08L1088\u2013L1102\uff09","text":"<p>\u5f53 <code>addToRuntime</code> \u4e3a true\uff1a - <code>ClassLoadEvent</code> - <code>context-&gt;InsertClass(klass)</code>\uff1a\u82e5\u8fd4\u56de otherKlass\uff0c\u8bf4\u660e\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5df2\u521b\u5efa\u540c descriptor \u7684\u7c7b \u2192 FreeClass \u5e76\u8fd4\u56de otherKlass\uff08L1091\u2013L1096\uff09 - <code>RemoveCreatedClassInExtension(klass)</code>\uff1a\u901a\u77e5 extension \u201c\u8be5 class \u5df2 prepared\u201d - <code>ClassPrepareEvent</code></p> <p>\u8fd9\u91cc\u4f53\u73b0\u4e86\uff1a\u5e76\u53d1\u4e0b\u7684\u201c\u6700\u540e\u5199\u5165\u8005\u8d62/\u63d2\u5165\u51b2\u7a81\u56de\u6536\u201d\u7b56\u7565\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#12-buildclass-arrayunionl1105l1390","title":"12. BuildClass\uff08\u5408\u6210\u7c7b\uff09\u4e0e array/union\uff08L1105\u2013L1390\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#121-descriptor-copymutf8stringl1105l1111","title":"12.1 descriptor \u590d\u5236\uff1a<code>CopyMutf8String</code>\uff08L1105\u2013L1111\uff09","text":"<p>\u5206\u914d\u5e76\u590d\u5236 descriptor\uff08null-terminated\uff09\uff0c\u7528\u4e8e needCopyDescriptor \u4e3a\u771f\u65f6\u907f\u514d\u5f15\u7528\u5916\u90e8\u4e34\u65f6\u5185\u5b58\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#122-linkentitiesandinitclassl1113l1133","title":"12.2 <code>LinkEntitiesAndInitClass</code>\uff08L1113\u2013L1133\uff09","text":"<p>\u5bf9 BuildClass/\u67d0\u4e9b\u8def\u5f84\u590d\u7528\uff1a - <code>LinkMethods</code>\u3001<code>LinkFields</code>\u3001<code>ext-&gt;InitializeClass</code></p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#123-buildclassl1135l1205","title":"12.3 <code>BuildClass</code>\uff08L1135\u2013L1205\uff09","text":"<p>\u6d41\u7a0b\uff1a - \u53ef\u9009\u590d\u5236 descriptor \u5e76\u8bb0\u5f55\u5230 <code>copiedNames_</code>\uff08L1140\u2013L1144\uff09\u3002 - <code>SetupClassInfo</code>\uff08\u57fa\u4e8e spans\uff09\u3002 - <code>ext-&gt;CreateClass</code> \u521b\u5efa class\u3002 - \u586b\u5145 base/interfaces/accessFlags/counts\u3001\u5199\u5165 methods/fields spans\uff0c\u5e76\u628a Method/Field \u7684 <code>classWord_</code> \u91cd\u7ed1\u5230\u65b0 klass\uff08L1178\u2013L1184\uff09\u3002 - <code>LinkEntitiesAndInitClass</code> \u2192 state=LOADED \u2192 \u4e8b\u4ef6 \u2192 <code>context-&gt;InsertClass</code> \u5e76\u5904\u7406\u5e76\u53d1\u51b2\u7a81\uff08L1194\u2013L1199\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#124-union-l1207l1317","title":"12.4 union \u7c7b\uff08L1207\u2013L1317\uff09","text":"<ul> <li><code>LoadConstituentClasses</code>\uff1a\u89e3\u6790 union descriptor \u7684 component \u5217\u8868\uff0c\u9010\u4e2a <code>GetClass</code>\uff08\u5931\u8d25\u91ca\u653e\uff09\u3002</li> <li><code>LoadUnionClass</code>\uff1a</li> <li>\u901a\u8fc7 <code>ext-&gt;GetCommonContext(constituentClasses)</code> \u83b7\u53d6 commonContext\uff08\u53ef\u80fd\u4e0e\u5f53\u524d context \u4e0d\u540c\uff09</li> <li>\u5728 commonContext \u4e2d <code>FindLoadedClass</code> \u505a\u53bb\u91cd</li> <li><code>CreateUnionClass</code>\uff08\u8c03\u7528 <code>ext-&gt;InitializeUnionClass</code>\uff09</li> <li>\u4e8b\u4ef6 + InsertClass\uff08\u4e0e\u666e\u901a\u7c7b\u4e00\u81f4\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#125-array-l1319l1390","title":"12.5 array \u7c7b\uff08L1319\u2013L1390\uff09","text":"<ul> <li><code>LoadArrayClass</code>\uff1a</li> <li>\u901a\u8fc7 <code>GetClass(componentDescriptor)</code> \u83b7\u53d6 componentClass</li> <li><code>componentClassContext</code> \u51b3\u5b9a\u6700\u7ec8\u63d2\u5165\u7684 context\uff08\u907f\u514d\u8de8 context \u590d\u5236\uff09</li> <li><code>CreateArrayClass</code>\uff08<code>ext-&gt;InitializeArrayClass</code>\uff09</li> <li>\u4e8b\u4ef6 + InsertClass\uff08\u540c\u4e0a\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#13-getclassdescriptorpath-boot-filterl1410l1535","title":"13. GetClass\uff1adescriptor/path \u7684\u7f13\u5b58\u4e0e boot filter\uff08L1410\u2013L1535\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#131-getclassdescriptor-l1410l1463","title":"13.1 <code>GetClass(descriptor, ...)</code>\uff08L1410\u2013L1463\uff09","text":"<p>\u987a\u5e8f\uff1a 1) \u5728 context \u67e5 loadedClasses\uff08L1420\u2013L1423\uff09 2) union/array descriptor \u7279\u5224\uff08L1425\u2013L1431\uff09 3) \u82e5 boot context\uff1a    - \u5148 <code>LookupInFilter</code>\uff0cIMPOSSIBLY_HAS \u76f4\u63a5\u8fd4\u56de nullptr\uff08L1434\u2013L1436\uff09    - \u5728 <code>bootPandaFiles_</code> \u4e2d\u67e5 classId\uff08\u53d7 <code>bootPandaFilesLock_</code> \u4fdd\u62a4\uff09\uff08L1442\u2013L1444\uff09    - \u672a\u627e\u5230\uff1a\u6784\u9020\u9519\u8bef\u4fe1\u606f\uff08\u6ce8\u610f\u7f29\u5c0f lock scope \u9632\u9012\u5f52\uff09\u5e76 <code>OnError</code>\uff08L1446\u2013L1455\uff09    - \u627e\u5230\uff1a\u8d70 <code>LoadClass(pandaFile, classId, descriptor, context, errorHandler)</code>\uff08L1459\uff09 4) \u975e boot context\uff1a\u59d4\u6258 <code>context-&gt;LoadClass</code>\uff08\u865a\u51fd\u6570\uff0c\u53ef\u7531\u8bed\u8a00\u63d2\u4ef6\u5b9e\u73b0 app context \u7684\u52a0\u8f7d\u7b56\u7565\uff09\uff08L1462\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#132-getclasspfidl1466l1535","title":"13.2 <code>GetClass(pf,id,...)</code>\uff08L1466\u2013L1535\uff09","text":"<p>\u989d\u5916\u589e\u52a0 panda_cache\uff1a 1) <code>pf.GetPandaCache()-&gt;GetClassFromCache(id)</code> \u547d\u4e2d\u76f4\u63a5\u8fd4\u56de\uff08L1475\u2013L1478\uff09 2) \u5426\u5219\u6309 descriptor \u67e5 loadedClasses\uff1b\u547d\u4e2d\u5219\u5199\u56de cache\uff08L1481\u2013L1485\uff09 3) union/array \u5206\u652f\u540c\u6837\u4f1a\u5728\u6210\u529f\u540e\u5199\u56de cache\uff08L1487\u2013L1500\uff09 4) boot context\uff1a\u540c\u6837\u5148 <code>LookupInFilter</code>\uff0c\u518d\u67e5 bootPandaFiles_\uff0c\u6700\u540e <code>LoadClass</code> \u5e76\u5199 cache\uff08L1503\u2013L1531\uff09 5) \u975e boot\uff1a<code>context-&gt;LoadClass(descriptor, false, handler)</code>\uff08L1534\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#14-getmethod-getfield-id-l1537l1815","title":"14. GetMethod / GetField\uff1a\u7f13\u5b58\u4e0e\u201c\u6309 id / \u6309\u7b7e\u540d\u201d\u53cc\u8def\u5f84\uff08L1537\u2013L1815\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#141-getmethodl1537","title":"14.1 GetMethod\uff08L1537+\uff09","text":"<ul> <li>\u5148 panda_cache\uff1a<code>GetMethodFromCache</code>\u3002</li> <li>\u65e0 context \u65f6\uff1a\u7528 <code>ClassDataAccessor</code> \u63a8\u5bfc\u8bed\u8a00\uff0c\u53d6 extension \u7684 bootContext\uff08L1548\u2013L1558\uff09\u3002</li> <li><code>klass = GetClass(pf, classId, context, handler)</code>\uff0c\u5931\u8d25\u8fd4\u56de nullptr\u3002</li> <li><code>GetMethod(klass, methodDataAccessor, handler)</code>\uff1a</li> <li>\u82e5\u65b9\u6cd5\u5b9a\u4e49\u5728\u540c pf \u4e14\u975e external\uff1a\u4f18\u5148\u7528 id \u76f4\u63a5\u53d6\uff08\u63a5\u53e3/\u7c7b\u5206\u522b\u53d6 static/virtual \u5206\u533a\uff09\uff08L1613\u2013L1618\uff09</li> <li>\u5426\u5219\uff1a\u7528 name + proto \u5728 class \u4e2d\u67e5\u627e\uff08\u5fc5\u8981\u65f6 abstract class \u5141\u8bb8\u67e5\u63a5\u53e3\u65b9\u6cd5\uff09\uff08L1632\u2013L1643\uff09</li> <li>\u627e\u4e0d\u5230\u4f1a\u6784\u9020 <code>METHOD_NOT_FOUND</code> \u9519\u8bef\u5e76\u8fd4\u56de nullptr\uff08L1620\u2013L1626 / L1645\u2013L1651\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#142-getfield-id-l1660l1743","title":"14.2 GetField\uff1a\u6309 id / \u6309\u7b7e\u540d\uff08L1660\u2013L1743\uff09","text":"<ul> <li><code>GetFieldById</code>\uff1a<code>FindStaticFieldById/FindInstanceFieldById</code>\uff0c\u5931\u8d25 OnError(FIELD_NOT_FOUND)\u3002</li> <li><code>GetFieldBySignature</code>\uff1aname+type \u8fc7\u6ee4\uff1a</li> <li>primitive\uff1a\u53ea\u6bd4 type + name</li> <li>reference\uff1a\u8fd8\u8981\u6bd4\u8f83 \u201c\u5b57\u6bb5\u7c7b\u578b\u7684 class type\u201d\uff08\u901a\u8fc7\u5bf9\u6bd4 typeId \u7684 stringData\uff09\uff08L1693\u2013L1701\uff09</li> <li><code>GetField(pf,id,...)</code>\uff1a\u5148 cache\uff1b<code>klass = GetClass(pf, classId, ...)</code>\uff1b</li> <li>\u82e5\u975e external \u4e14 <code>klass-&gt;GetPandaFile()==&amp;pf</code> \u7528 byId\uff0c\u5426\u5219\u7528 bySignature\uff08L1737\u2013L1741\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#143-initializeclassl1745l1754","title":"14.3 InitializeClass\uff08L1745\u2013L1754\uff09","text":"<p>\u82e5\u5df2 initialized \u76f4\u63a5 true\uff0c\u5426\u5219\u59d4\u6258 <code>LanguageContext::InitializeClass(this, thread, klass)</code>\uff08\u8bed\u8a00\u76f8\u5173\u7684 init state machine\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#15-aot-boot-class-bloom-filterl1828l1894","title":"15. AOT \u91cd\u65b0\u94fe\u63a5\u4e0e boot class bloom filter\uff08L1828\u2013L1894\uff09","text":"<ul> <li><code>TryReLinkAotCodeForBoot</code>\uff1a\u904d\u5386 bootContext \u5df2\u52a0\u8f7d\u7c7b\uff0c\u679a\u4e3e methods \u5e76\u8c03\u7528 <code>MaybeLinkMethodToAotCode</code>\uff08\u7528\u4e8e boot \u671f\u95f4\u8865\u6302 AOT entry\uff09\u3002</li> <li><code>AddBootClassFilter</code>\uff1a\u9501 <code>bootClassFilterLock_</code>\uff0c\u628a boot file \u7684\u6240\u6709 className \u52a0\u5165 bloom filter\uff08L1857\u2013L1867\uff09\u3002</li> <li><code>LookupInFilter</code>\uff1a</li> <li>\u672a\u542f\u7528\u8fc7\u6ee4\uff1aDISABLED</li> <li>\u5426\u5219 <code>PossiblyContains(descriptor)</code>\uff1b\u82e5 false\uff1a<ul> <li>errorHandler \u4e3a\u7a7a\uff1a\u76f4\u63a5 IMPOSSIBLY_HAS</li> <li>\u5426\u5219\u4e0a\u62a5 <code>CLASS_NOT_FOUND</code> \u5e76\u8fd4\u56de IMPOSSIBLY_HAS</li> </ul> </li> <li>\u547d\u4e2d\u5219 POSSIBLY_HAS</li> </ul> <p>\u8fc7\u6ee4\u5668\u8bed\u4e49\uff1a\u53ea\u505a\u201c\u5feb\u901f\u5426\u5b9a\u201d\uff08bloom filter false \u2192 \u4e00\u5b9a\u4e0d\u5b58\u5728\uff1btrue \u2192 \u8fd8\u9700\u53bb bootPandaFiles \u67e5\u8bc1\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker.cpp/#16-03","title":"16. \u672c\u6587\u4ef6\u5bf9 03 \u7ae0\u7684\u201c\u5951\u7ea6\u56de\u6307\u201d","text":"<p>\u672c\u6587\u4ef6\u662f <code>Method/Field/Class</code> \u5951\u7ea6\u7684\u4e3b\u8981\u5199\u5165\u70b9\uff1a - Method\uff1a   - <code>SetCompiledEntryPoint</code>\uff08\u89e3\u91ca\u5668\u6865 / native / AOT / stub\uff09   - <code>SetIsDefaultInterfaceMethod</code>\uff08copied method\uff09   - abstract method stub\uff08\u907f\u514d\u6d3e\u53d1\u524d\u68c0\u67e5\uff09 - Field\uff1a   - <code>SetOffset</code>\uff08\u5e03\u5c40\u7b97\u6cd5\u552f\u4e00\u5199\u5165\u70b9\uff09 - Class\uff1a   - <code>SetRefFieldsNum/Offset/VolatileRefFieldsNum</code>   - <code>SetObjectSize</code>   - <code>SetMethods/SetFields/SetInterfaces/SetBase/SetLoadContext</code>   - <code>SetState(LOADED)</code> \u4e0e\u63d2\u5165 context\uff08\u5e76\u53d1\u51b2\u7a81\u56de\u6536\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/","title":"<code>runtime/class_linker_context.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\uff08ClassLoader/Context\uff09\u57fa\u7c7b\uff1a\u8d1f\u8d23\u201c\u5df2\u52a0\u8f7d\u7c7b\u7f13\u5b58 + \u5e76\u53d1\u534f\u8c03 + panda files \u679a\u4e3e + GC roots\u201d \u91cd\u8981\u63d0\u9192\uff1a\u672c\u6587\u4ef6 include \u4e86 GC \u76f8\u5173\u5934\uff08<code>gc.h/gc_root.h</code>\uff09\uff0c\u4f46\u8fd9\u91cc\u53ea\u662f root \u5217\u8868\u7684\u5bb9\u5668\u4e0e\u66f4\u65b0\u63a5\u53e3\uff1b\u5c4f\u969c/\u79fb\u52a8/\u6807\u8bb0\u7b49\u7ec6\u8282\u5c5e\u4e8e Stage2/02\uff08Memory\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#1-classlinkercontext","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08ClassLinkerContext \u7684\u804c\u8d23\u8fb9\u754c\uff09","text":"<p><code>ClassLinkerContext</code> \u662f ClassLinker \u7684\u201c\u52a0\u8f7d\u9694\u79bb\u57df\u201d\u62bd\u8c61\uff1a - \u7f13\u5b58\uff1adescriptor \u2192 <code>Class*</code> \u7684\u6620\u5c04\uff08<code>loadedClasses_</code>\uff09\u3002 - \u5e76\u53d1\u63a7\u5236\uff1a   - <code>classesLock_</code> \u4fdd\u62a4 <code>loadedClasses_</code>\u3002   - <code>mutexTable_</code> \u4e3a\u6bcf\u4e2a <code>Class*</code> \u63d0\u4f9b\u4e00\u4e2a <code>ClassMutexHandler</code>\uff08\u9012\u5f52 mutex + condvar\uff09\uff0c\u7528\u4e8e\u534f\u8c03\u540c\u4e00\u7c7b\u7684\u5e76\u53d1\u52a0\u8f7d/\u521d\u59cb\u5316\uff08\u5178\u578b\uff1a\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u89e6\u53d1\u67d0 class \u7684\u521d\u59cb\u5316\uff09\u3002 - \u53ef\u6269\u5c55\uff1a\u63d2\u4ef6\u53ef\u7ee7\u627f\u5e76\u8986\u5199 <code>LoadClass/EnumeratePandaFiles/GetPandaFilePaths/...</code> \u5b9e\u73b0\u8bed\u8a00\u7279\u5b9a\u52a0\u8f7d\u7b56\u7565\u3002 - GC roots\uff1a\u7ef4\u62a4 <code>roots_</code> \u5e76\u652f\u6301 update\uff08\u4f9b\u79fb\u52a8 GC \u66f4\u65b0\u5f15\u7528\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#2-l1l34","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L34\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_CLASS_LINKER_CONTEXT_H_</code>\u3002</li> <li>L18\uff1a<code>&lt;atomic&gt;</code>\uff08\u672c\u6587\u4ef6\u5b57\u6bb5\u672a\u76f4\u63a5\u4f7f\u7528 atomic\uff0c\u4f46\u4f9d\u8d56\u94fe\u4e0e\u5b8f\u6ce8\u89e3\u4f1a\u4f7f\u7528\uff09\u3002</li> <li>L19\u2013L22\uff1amacros/mutex/bit_utils\uff1a\u9501\u4e0e\u6ce8\u89e3\uff08<code>GUARDED_BY/ACQUIRE/RELEASE</code>\uff09\u3002</li> <li>L20\uff1a<code>object_pointer.h</code>\uff1a\u5bf9\u8c61\u6307\u9488\u5de5\u5177\uff08\u4e0e GC root \u66f4\u65b0\u76f8\u5173\uff09\u3002</li> <li>L23\uff1a<code>mem/refstorage/reference.h</code>\uff1a\u5f15\u7528\u5b58\u50a8\u76f8\u5173\u7c7b\u578b\uff08\u95f4\u63a5\u652f\u6491 root/handles\uff09\u3002</li> <li>L24\uff1a<code>runtime/include/class.h</code>\uff1a<code>Class</code> \u7c7b\u578b\u4e0e descriptor\u3002</li> <li>L25\uff1apanda \u5bb9\u5668\u3002</li> <li>L26\u2013L28\uff1aGC\uff1a<code>gc.h/gc_root.h/object_helpers.h</code>\uff1a</li> <li><code>ObjectVisitor</code>/<code>GCRootUpdater</code> \u7b49\u7c7b\u578b\u88ab <code>VisitGCRoots/UpdateGCRoots</code> \u4f7f\u7528\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#3-classmutexhandlerl35l71","title":"3. <code>ClassMutexHandler</code>\uff08L35\u2013L71\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#31","title":"3.1 \u76ee\u7684","text":"<p>\u4f5c\u4e3a\u4e00\u4e2a\u5c0f\u5c01\u88c5\uff1a\u628a <code>RecursiveMutex + ConditionVariable</code> \u7ec4\u5408\u8d77\u6765\uff0c\u63d0\u4f9b\uff1a - <code>Lock/Unlock</code> - <code>Wait/Signal/SignalAll</code></p> <p>\u7528\u4e8e \u201c\u6309 Class \u7c92\u5ea6\u201d \u505a\u5e76\u53d1\u534f\u8c03\uff08\u89c1\u540e\u7eed <code>mutexTable_</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#32","title":"3.2 \u9010\u884c\u8981\u70b9","text":"<ul> <li>L36\uff1a\u7c7b\u5b9a\u4e49\uff08\u6ce8\u91ca NOLINT\uff1a\u4e0d\u8981\u6c42\u663e\u5f0f\u5b9a\u4e49 special members\uff09\u3002</li> <li>L40\u2013L48\uff1a<code>Lock/Unlock</code> \u76f4\u63a5\u8f6c\u53d1\u7ed9 <code>clsHandlerMtx_</code>\uff0c\u5e76\u7528\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3 <code>ACQUIRE/RELEASE</code>\u3002</li> <li>L50\u2013L53\uff1a<code>Wait()</code>\uff1a\u5bf9 condvar \u8c03\u7528 <code>Wait(&amp;mutex)</code>\uff08\u5178\u578b\u6761\u4ef6\u53d8\u91cf\u7528\u6cd5\uff09\u3002</li> <li>L55\u2013L63\uff1a<code>Signal/SignalAll</code>\uff1a\u5524\u9192\u7b49\u5f85\u8005\u3002</li> <li>L65\u2013L66\uff1a\u7981\u6b62 copy/move\u3002</li> <li>L69\u2013L70\uff1a\u5185\u90e8\u5b57\u6bb5\uff1a\u9012\u5f52 mutex + condvar\u3002</li> </ul> <p>\u9012\u5f52 mutex \u7684\u9009\u62e9\u6697\u793a\uff1a\u540c\u4e00\u7ebf\u7a0b\u53ef\u80fd\u5728\u67d0\u4e9b\u52a0\u8f7d/\u89e3\u6790\u8def\u5f84\u4e2d\u91cd\u5165\uff08\u4f8b\u5982\u9012\u5f52\u89e3\u6790\u4f9d\u8d56\u7c7b\uff09\uff0c\u9700\u8981\u907f\u514d\u6b7b\u9501\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#4-classlinkercontextl73l233","title":"4. <code>ClassLinkerContext</code>\uff08L73\u2013L233\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#41-lang_l80l103","title":"4.1 \u6784\u9020\u4e0e lang_\uff08L80\u2013L103\uff09","text":"<ul> <li>L81\uff1a<code>explicit ClassLinkerContext(SourceLang lang)</code>\uff1a\u4e0a\u4e0b\u6587\u4e0e\u8bed\u8a00\u7ed1\u5b9a\u3002</li> <li>L99\u2013L102\uff1a<code>GetSourceLang()</code>\uff1a\u8fd4\u56de lang_\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#42-findinsertremovel83l131","title":"4.2 \u7c7b\u7f13\u5b58\uff1aFind/Insert/Remove\uff08L83\u2013L131\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#findclassl83l92","title":"FindClass\uff08L83\u2013L92\uff09","text":"<ul> <li>L85\uff1a<code>LockHolder lock(classesLock_)</code>\uff1a\u4fdd\u62a4 <code>loadedClasses_</code>\u3002</li> <li>L86\u2013L91\uff1a\u5728 <code>loadedClasses_</code> \u91cc\u6309 descriptor \u67e5\u627e\uff0c\u547d\u4e2d\u8fd4\u56de <code>Class*</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#insertclassl110l123","title":"InsertClass\uff08L110\u2013L123\uff09","text":"<p>\u8fd9\u91cc\u7684\u903b\u8f91\u503c\u5f97\u6ce8\u610f\uff08\u4e5f\u63d0\u793a\u4e86\u6f5c\u5728\u7684\u9501\u987a\u5e8f\u95ee\u9898\uff0c\u540e\u7eed\u5b9e\u73b0\u6587\u4ef6\u91cc\u9700\u8981\u9a8c\u8bc1\uff09\uff1a - L112\uff1a\u5148\u9501 <code>classesLock_</code>\u3002 - L113\uff1a\u8c03\u7528 <code>FindClass(klass-&gt;GetDescriptor())</code>\uff1a   - <code>FindClass</code> \u81ea\u5df1\u4e5f\u4f1a\u9501 <code>classesLock_</code>\uff0c\u8fd9\u91cc\u4f9d\u8d56 <code>classesLock_</code> \u662f <code>RecursiveMutex</code>\uff08\u89c1 L226\uff09\u624d\u80fd\u91cd\u5165\u3002 - L118\uff1a\u65ad\u8a00\u63d2\u5165\u7c7b\u7684\u8bed\u8a00\u4e0e context \u4e00\u81f4\uff08\u9632\u8de8\u8bed\u8a00\u6c61\u67d3\uff09\u3002 - L119\uff1a\u63d2\u5165 <code>loadedClasses_</code>\uff08key \u662f descriptor \u6307\u9488\uff0c\u4ee5 Mutf8Hash/Equal \u6bd4\u8f83\u5185\u5bb9\uff09\u3002 - L120\u2013L121\uff1a\u518d\u9501 <code>mapLock_</code> \u5e76 <code>mutexTable_[klass];</code>\uff1a   - <code>operator[]</code> \u4f1a\u9ed8\u8ba4\u6784\u9020\u4e00\u4e2a <code>ClassMutexHandler</code>\uff0c\u4e3a\u8be5 class \u9884\u7f6e\u540c\u6b65\u5668\u3002 - L122\uff1a\u8fd4\u56de nullptr\uff08\u8bed\u4e49\uff1a\u5982\u679c\u53d1\u73b0\u5df2\u5b58\u5728\u5219\u8fd4\u56de existing class\uff0c\u5426\u5219\u63d2\u5165\u6210\u529f\u8fd4\u56de nullptr\uff1b\u8c03\u7528\u65b9\u9700\u636e\u6b64\u5224\u65ad\u201c\u662f\u5426\u66ff\u6362\u4e3a\u5df2\u5b58\u5728 class\u201d\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#removeclassl125l131","title":"RemoveClass\uff08L125\u2013L131\uff09","text":"<ul> <li>\u6301 <code>classesLock_</code> \u5220\u9664 loadedClasses_ \u4e2d descriptor\u3002</li> <li>\u6301 <code>mapLock_</code> \u5220\u9664 mutexTable_ \u4e2d\u5bf9\u5e94\u6761\u76ee\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#43-isbootcontextloadclassl94l108","title":"4.3 \u53ef\u6269\u5c55\u7684\u52a0\u8f7d\u7b97\u6cd5\uff1aIsBootContext/LoadClass\uff08L94\u2013L108\uff09","text":"<ul> <li>L94\u2013L97\uff1a\u9ed8\u8ba4\u4e0d\u662f boot context\u3002</li> <li>L104\u2013L108\uff1a\u9ed8\u8ba4 <code>LoadClass</code> \u8fd4\u56de nullptr\uff0c\u63d2\u4ef6\u53ef override\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#44-enumerateclasses-enumeratepandafiles-chainl133l151","title":"4.4 \u679a\u4e3e\uff1aEnumerateClasses / EnumeratePandaFiles / Chain\uff08L133\u2013L151\uff09","text":"<ul> <li>EnumerateClasses\uff08L133\u2013L143\uff09\uff1a</li> <li>\u5728 <code>classesLock_</code> \u4e0b\u904d\u5386 loadedClasses_\uff0c\u56de\u8c03\u8fd4\u56de false \u5219\u63d0\u524d\u7ec8\u6b62\u3002</li> <li>EnumeratePandaFiles\uff08L145\uff09\uff1a</li> <li>\u9ed8\u8ba4\u7a7a\u5b9e\u73b0\uff1b\u6d3e\u751f\u7c7b\u5e94\u63d0\u4f9b\u201c\u672c context \u5173\u8054\u7684 panda_file \u96c6\u5408\u201d\u3002</li> <li>EnumeratePandaFilesInChain\uff08L147\u2013L151\uff09\uff1a</li> <li>\u7528\u4e8e\u201c\u94fe\u5f0f\u4e0a\u4e0b\u6587\u201d\uff08\u4f8b\u5982 parent loader chain\uff09\uff0c\u9ed8\u8ba4\u53ea\u679a\u4e3e\u672c context\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#45-l153l166l200l205","title":"4.5 \u7edf\u8ba1\u4e0e\u8c03\u8bd5\u8f93\u51fa\uff08L153\u2013L166\uff0cL200\u2013L205\uff09","text":"<ul> <li><code>NumLoadedClasses()</code>\uff1a\u8fd4\u56de map size\uff08\u5e26\u9501\uff09\u3002</li> <li><code>VisitLoadedClasses(flag)</code>\uff1a\u904d\u5386\u6240\u6709 loaded classes \u5e76\u8c03\u7528 <code>DumpClass</code> \u8f93\u51fa\uff08log stream\uff09\u3002</li> <li><code>Dump(std::ostream&amp;)</code>\uff1a\u6253\u5370 loader \u5730\u5740\u4e0e loaded class \u6570\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#46-gc-roots-l168l193","title":"4.6 GC roots \u7ba1\u7406\uff08L168\u2013L193\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#visitgcrootsl168l173","title":"VisitGCRoots\uff08L168\u2013L173\uff09","text":"<ul> <li>\u904d\u5386 <code>roots_</code> \u5e76\u5bf9\u6bcf\u4e2a root \u8c03\u7528 visitor\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#addgcrootl175l186","title":"AddGCRoot\uff08L175\u2013L186\uff09","text":"<ul> <li>\u5728 <code>classesLock_</code> \u4e0b\u505a\u53bb\u91cd\uff08\u7ebf\u6027\u626b\u63cf roots_\uff09\u3002</li> <li>\u4e0d\u5b58\u5728\u5219 push_back \u5e76\u8fd4\u56de true\uff1b\u91cd\u590d\u5219 false\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#updategcrootsl188l193","title":"UpdateGCRoots\uff08L188\u2013L193\uff09","text":"<ul> <li>\u5bf9\u6bcf\u4e2a <code>root</code> \u8c03\u7528 <code>gcRootUpdater(&amp;root)</code>\uff1a</li> <li>\u8fd9\u662f\u4e00\u79cd\u5178\u578b\u201c\u79fb\u52a8 GC \u66f4\u65b0 root \u6307\u9488\u201d\u7684\u63a5\u53e3\u8bbe\u8ba1\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u6ca1\u6709\u5c4f\u969c/\u538b\u7f29\u903b\u8f91\u672c\u8eab\uff0c\u53ea\u662f\u8c03\u7528 updater\uff1bupdater \u7684\u5b9e\u73b0\u5c5e\u4e8e GC \u5b50\u7cfb\u7edf\uff08Stage2/02\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#47-panda-file-paths-parent-loaderl195l210","title":"4.7 Panda file paths \u4e0e parent loader\uff08L195\u2013L210\uff09","text":"<ul> <li><code>GetPandaFilePaths()</code>\uff1a\u9ed8\u8ba4\u8fd4\u56de\u7a7a vector\uff0c\u6d3e\u751f\u7c7b\u5e94\u8fd4\u56de\u8def\u5f84\u5217\u8868\uff08AOT class context \u7b49\u4f1a\u4f7f\u7528\uff09\u3002</li> <li><code>FindClassLoaderParent(parent)</code>\uff1a\u9ed8\u8ba4 false\uff08\u94fe\u5f0f\u4e0a\u4e0b\u6587\u7684 parent \u5173\u7cfb\u7531\u6d3e\u751f\u7c7b\u51b3\u5b9a\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#48-per-class-mutextablegetclassmutexhandlerl212l216","title":"4.8 per-Class MutexTable\uff1aGetClassMutexHandler\uff08L212\u2013L216\uff09","text":"<ul> <li>\u5728 <code>mapLock_</code> \u4e0b <code>mutexTable_.at(cls)</code>\uff0c\u8fd4\u56de\u8be5 class \u7684 <code>ClassMutexHandler*</code>\u3002</li> <li>\u8be5\u540c\u6b65\u5668\u901a\u5e38\u88ab class initialization / link steps \u7528\u4e8e\u7b49\u5f85/\u5524\u9192\uff08\u5df2\u5728 FileNotes/runtime_class_linker.cpp \u7684\u5e76\u53d1\u52a0\u8f7d/InsertClass/LoadClass \u4e92\u65a5\u6bb5\u843d\u5bf9\u9f50\u5230\u4f7f\u7528\u70b9\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_context.h/#49-l224l233","title":"4.9 \u79c1\u6709\u5b57\u6bb5\uff08L224\u2013L233\uff09","text":"<ul> <li>L226\uff1a<code>classesLock_</code> \u662f <code>RecursiveMutex</code>\uff1a\u652f\u6491 InsertClass \u91cc FindClass \u7684\u91cd\u5165\u9501\u3002</li> <li>L227\u2013L228\uff1a<code>loadedClasses_</code>\uff1a</li> <li>key\uff1a<code>const uint8_t*</code> descriptor\uff08MUTF8\uff09</li> <li>hash/eq\uff1a<code>utf::Mutf8Hash/utf::Mutf8Equal</code>\uff08\u6309\u5185\u5bb9\u800c\u975e\u6307\u9488\uff09</li> <li>\u5b8f <code>GUARDED_BY(classesLock_)</code> \u6807\u6ce8\u3002</li> <li>L229\uff1a<code>mapLock_</code>\uff1a\u4fdd\u62a4 <code>mutexTable_</code>\u3002</li> <li>L230\uff1a<code>mutexTable_</code>\uff1a<code>Class* -&gt; ClassMutexHandler</code>\u3002</li> <li>L231\uff1a<code>roots_</code>\uff1a<code>ObjectHeader*</code> \u7684 root \u5217\u8868\u3002</li> <li>L232\uff1a<code>lang_</code>\uff1a\u9ed8\u8ba4 PANDA_ASSEMBLY\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/","title":"<code>runtime/class_linker_extension.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u9ed8\u8ba4 Extension \u884c\u4e3a\uff1aBoot/App Context + roots + \u751f\u547d\u5468\u671f\u5bb9\u5668\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u89c4\u6a21\uff1a377 \u884c\uff08\u5b9e\u73b0\u6587\u4ef6\uff0c\u9010\u6bb5\u9010\u884c\u8bb0\u5f55\uff09 \u76ee\u6807\uff1a\u8865\u9f50 <code>ClassLinkerExtension</code> \u62bd\u8c61\u5728 core runtime \u4fa7\u7684\u201c\u9ed8\u8ba4\u5b9e\u73b0\u884c\u4e3a\u201d\uff1aBoot/App context \u7684 LoadClass\u3001roots \u521d\u59cb\u5316 helper\u3001context \u6ce8\u518c\u3001created/new/obsolete classes \u5bb9\u5668\u8bed\u4e49\uff0c\u4ee5\u53ca\u4e00\u4e2a\u5f88\u5173\u952e\u7684\u201c\u5f02\u5e38\u5305\u88c5\u201d\u903b\u8f91\u3002</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#bootappcontext-loadclass-createdpreparednewclasses","title":"\u4e00\u56fe\u8bfb\u61c2\uff1a\u9ed8\u8ba4 Boot/AppContext \u7684 LoadClass \u4e0e \u201ccreated\u2192prepared\u2192newClasses\u201d","text":"<pre><code>flowchart TD\n  subgraph LoadClass[\"\u9ed8\u8ba4 LoadClass \u7b56\u7565\"]\n    A[\"BootContext::LoadClass\"] --&gt; A1[\"\u59d4\u6258 ClassLinker::GetClass(..., bootCtx)\"]\n    B[\"AppContext::LoadClass\"] --&gt; B1[\"\u5148\u63a2\u6d4b\uff1aextension-&gt;GetClass(descriptor, ctx=nullptr)\\n(SuppressErrorHandler)\"]\n    B1 --&gt;|\u547d\u4e2d| R1[\"\u8fd4\u56de Class*\"]\n    B1 --&gt;|\u672a\u547d\u4e2d| B2[\"\u904d\u5386\u672c context \u7684 pfs_:\\nclassId=pf-&gt;GetClassId(descriptor)\\nLoadClass(*pf,classId,this)\"]\n    B2 --&gt;|\u627e\u5230| R2[\"\u8fd4\u56de Class*\"]\n    B2 --&gt;|\u627e\u4e0d\u5230| R3[\"OnError(CLASS_NOT_FOUND) / nullptr\"]\n  end\n\n  subgraph Lifecycle[\"\u7c7b\u5bf9\u8c61\u751f\u547d\u5468\u671f\u5bb9\u5668\"]\n    C[\"CreateClass(\u8bed\u8a00\u5b9e\u73b0)\\nAddCreatedClass\"] --&gt; D[\"AddClass: InsertClass \u5e76\u53d1\u53bb\u91cd\"]\n    D --&gt;|\u6210\u529f| E[\"OnClassPrepared:\\n(recordNewClass_? push newClasses_)\\nRemoveCreatedClass\"]\n    D --&gt;|\"\u5931\u8d25(\u53e6\u7ebf\u7a0b\u5df2\u63d2\u5165)\"| F[\"FreeClass(\u8bed\u8a00) + FreeClassData(\u901a\u7528)\"]\n  end</code></pre>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#0-include-l16l24","title":"0. include \u4e0e\u5b9a\u4f4d\uff08L16\u2013L24\uff09","text":"<ul> <li><code>class_linker_extension.h</code>\uff1a\u62bd\u8c61\u63a5\u53e3\u4e0e\u6570\u636e\u6210\u5458\u5b9a\u4e49\uff08roots/contexts/new roots \u7b49\uff09\u3002</li> <li><code>class_linker-inl.h</code>\u3001<code>class_linker.h</code>\uff1a\u5177\u4f53\u59d4\u6258\u5230 <code>ClassLinker</code> \u7684 GetClass/LoadClass/FreeClassData \u7b49\u3002</li> <li><code>coretypes/class.h</code>\uff1a<code>FromClassObject</code> \u7684\u5b9e\u73b0\u9700\u8981 <code>coretypes::Class</code> \u7684 <code>GetRuntimeClass()</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#1-extension-contextsl27l33","title":"1. Extension \u6790\u6784\uff1a\u91ca\u653e\u6ce8\u518c\u7684 contexts\uff08L27\u2013L33\uff09","text":"<ul> <li>L29\u2013L32\uff1a\u5728 <code>contextsLock_</code> \u4e0b\u904d\u5386 <code>contexts_</code>\uff0c\u7528 <code>classLinker_-&gt;GetAllocator()-&gt;Delete(ctx)</code> \u91ca\u653e\u3002</li> <li>\u8fd9\u8bf4\u660e <code>contexts_</code> \u91cc\u7684 context \u5bf9\u8c61\u7531 ClassLinker \u7684 allocator \u5206\u914d\uff0c\u5e76\u7531 Extension \u8d1f\u8d23\u6790\u6784\u56de\u6536\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#2-bootcontextloadclassenumeratepandafiles-l35l47","title":"2. BootContext\uff1aLoadClass/EnumeratePandaFiles \u7684\u201c\u59d4\u6258\u5f0f\u5b9e\u73b0\u201d\uff08L35\u2013L47\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#21-bootcontextloadclassl35l41","title":"2.1 <code>BootContext::LoadClass</code>\uff08L35\u2013L41\uff09","text":"<ul> <li>\u65ad\u8a00 extension \u5df2\u521d\u59cb\u5316\uff08roots/panda files \u7ed3\u6784\u53ef\u7528\uff09\u3002</li> <li>\u76f4\u63a5\u59d4\u6258 <code>classLinker-&gt;GetClass(descriptor, needCopyDescriptor, this, errorHandler)</code>\u3002</li> <li>\u5173\u952e\u70b9\uff1aBootContext \u7684 <code>LoadClass</code> \u672c\u8d28\u4e0a\u5c31\u662f\u201c\u5e26 boot context \u53c2\u6570\u8c03\u7528 ClassLinker::GetClass\u201d\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#22-bootcontextenumeratepandafilesl43l47","title":"2.2 <code>BootContext::EnumeratePandaFiles</code>\uff08L43\u2013L47\uff09","text":"<ul> <li>\u76f4\u63a5\u59d4\u6258 <code>ClassLinker::EnumerateBootPandaFiles(cb)</code>\u3002</li> <li>\u4e0e <code>ClassLinker</code> \u5185\u90e8\u7684 <code>bootPandaFiles_</code> \u5bf9\u9f50\uff08\u89c1 FileNotes/runtime_class_linker.cpp \u7684 AddPandaFile \u6bb5\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#3-appcontext-loadclass-l49l78","title":"3. AppContext\uff1a\u9ed8\u8ba4\u5e94\u7528\u57df\u7684 LoadClass \u7b56\u7565\uff08L49\u2013L78\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#31-suppresserrorhandlerl49l51","title":"3.1 <code>SuppressErrorHandler</code>\uff08L49\u2013L51\uff09","text":"<ul> <li>\u8986\u76d6 <code>OnError</code> \u4e3a\u7a7a\u5b9e\u73b0\uff0c\u7528\u4e8e\u201c\u63a2\u6d4b\u5f0f GetClass\uff08\u4e0d\u8981\u6c61\u67d3 error state\uff09\u201d\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#32-appcontextloadclassl53l78","title":"3.2 <code>AppContext::LoadClass</code>\uff08L53\u2013L78\uff09","text":"<p>\u7b97\u6cd5\u5206\u4e24\u6b65\uff1a - Step A\uff08L58\u2013L62\uff09\uff1a\u5148\u7528 Suppress handler \u8c03 <code>extension_-&gt;GetClass(..., nullptr, &amp;handler)</code>\uff1a   - \u8fd9\u91cc <code>context=nullptr</code> \u4f1a\u5728 <code>ResolveContext</code> \u91cc\u88ab\u89e3\u6790\uff08\u901a\u5e38\u56de\u5230 boot context \u6216 extension \u9ed8\u8ba4\u4e0a\u4e0b\u6587\uff09\uff0c\u7528\u4e8e\u5feb\u901f\u547d\u4e2d\u201c\u5df2\u52a0\u8f7d/\u53ef\u89c1\u201d\u7684\u7c7b\u3002   - \u547d\u4e2d\u5219\u76f4\u63a5\u8fd4\u56de\u3002 - Step B\uff08L64\u2013L70\uff09\uff1a\u904d\u5386 <code>pfs_</code>\uff08AppContext \u6301\u6709\u7684 panda files \u6307\u9488\u5217\u8868\uff09\uff1a   - <code>pf-&gt;GetClassId(descriptor)</code> \u2192 \u8fc7\u6ee4 invalid/external \u2192 <code>classLinker-&gt;LoadClass(*pf, classId, this, errorHandler)</code>\u3002   - \u6ce8\u610f\uff1a\u8fd9\u91cc\u8d70\u7684\u662f ClassLinker::LoadClass\uff08\u76f4\u63a5\u6309 pf+id \u52a0\u8f7d\uff09\uff0c\u4e0e <code>GetClass(descriptor)</code> \u7684 boot filter \u5206\u652f\u4e0d\u540c\u3002 - Step C\uff08L72\u2013L77\uff09\uff1a\u90fd\u627e\u4e0d\u5230\u65f6\u4e0a\u62a5 <code>CLASS_NOT_FOUND</code>\uff08message \u5305\u542b descriptor\uff09\u3002</p> <p>\u7ed3\u8bba\uff1aAppContext \u9ed8\u8ba4\u5b9e\u73b0\u5c31\u662f\u201c\u5148\u770b\u5168\u5c40/boot \u53ef\u89c1\u7f13\u5b58\uff0c\u518d\u5728\u672c context \u7684 panda files \u91cc\u6309 classId \u52a0\u8f7d\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#4-roots-helperprimitivearraysyntheticl80l124","title":"4. roots \u521d\u59cb\u5316 helper\uff1aprimitive/array/synthetic\uff08L80\u2013L124\uff09","text":"<p>\u8fd9\u4e09\u4e2a helper \u662f extension \u5b9e\u73b0\u91cc\u975e\u5e38\u9ad8\u9891\u7684\u81ea\u4e3e\u5de5\u5177\uff0c\u62bd\u8c61\u4e86 CreateClass + language-specific InitializeXxxClass + AddClass + SetClassRoot \u7684\u5957\u8def\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#41-initializearrayclassrootl80l96","title":"4.1 <code>InitializeArrayClassRoot</code>\uff08L80\u2013L96\uff09","text":"<ul> <li><code>CreateClass(descriptor, vtableSize, imtSize, size)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\u63d0\u4f9b\uff09</li> <li><code>arrayClass-&gt;SetLoadContext(&amp;bootContext_)</code></li> <li>\u53d6 <code>componentClass = GetClassRoot(componentRoot)</code> \u5e76\u8c03\u7528 <code>InitializeArrayClass(arrayClass, componentClass)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\uff09</li> <li><code>AddClass(arrayClass)</code>\uff1a\u63d2\u5165\u5230 context\uff08\u542b\u5e76\u53d1\u53bb\u91cd\u4e0e OnClassPrepared \u94a9\u5b50\uff0c\u89c1\u4e0b\uff09</li> <li><code>SetClassRoot(root, arrayClass)</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#42-initializeprimitiveclassrootl98l111","title":"4.2 <code>InitializePrimitiveClassRoot</code>\uff08L98\u2013L111\uff09","text":"<ul> <li>\u540c\u6837\u7684\u5957\u8def\uff0c\u4f46\u989d\u5916\u8bbe\u7f6e\uff1a</li> <li><code>primitiveClass-&gt;SetType(Type(typeId))</code></li> <li><code>InitializePrimitiveClass(primitiveClass)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#43-initializesyntheticclassrootl113l124","title":"4.3 <code>InitializeSyntheticClassRoot</code>\uff08L113\u2013L124\uff09","text":"<ul> <li>synthetic class\uff1a<code>CreateClass(descriptor, 0, 0, size)</code></li> <li><code>synClass-&gt;SetType(REFERENCE)</code> + <code>InitializeSyntheticClass(synClass)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#5-initialize-vs-initializerootsl126l169","title":"5. <code>Initialize</code> vs <code>InitializeRoots</code>\uff1a\u4e24\u9636\u6bb5\u521d\u59cb\u5316\u8bed\u4e49\uff08L126\u2013L169\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#51-classlinkerextensioninitializel126l151","title":"5.1 <code>ClassLinkerExtension::Initialize</code>\uff08L126\u2013L151\uff09","text":"<ul> <li>\u8bb0\u5f55 <code>classLinker_</code> \u5e76\u8c03\u7528 <code>InitializeImpl(compressedStringEnabled)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\uff1a\u521b\u5efa roots\u3001\u542f\u7528\u538b\u7f29\u5b57\u7b26\u4e32\u7b49\uff09\u3002</li> <li>\u8bbe\u7f6e <code>canInitializeClasses_ = true</code>\uff0c\u7136\u540e\u4ece boot context \u679a\u4e3e\u51fa\u201c\u672a LOADED \u7684\u7c7b\u201d\u590d\u5236\u5230 <code>klasses</code>\u3002</li> <li>\u539f\u56e0\uff08L132\u2013L134\uff09\uff1a<code>InitializeClass</code> \u671f\u95f4\u53ef\u80fd\u4f1a\u52a0\u8f7d\u66f4\u591a\u7c7b\u3001\u4fee\u6539 boot context\uff1b\u5148\u590d\u5236\u907f\u514d\u8fed\u4ee3\u5668\u5931\u6548/\u5e76\u53d1\u4fee\u6539\u3002</li> <li>\u5bf9\u6bcf\u4e2a\u672a LOADED \u7684\u7c7b\u8c03\u7528 <code>InitializeClass(klass)</code> \u5e76\u5c06\u5176 state \u7f6e\u4e3a <code>LOADED</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#52-classlinkerextensioninitializerootsl153l168","title":"5.2 <code>ClassLinkerExtension::InitializeRoots</code>\uff08L153\u2013L168\uff09","text":"<ul> <li>\u904d\u5386 <code>classRoots_</code>\uff0c\u5bf9\u6bcf\u4e2a root \u8c03 <code>classLinker_-&gt;InitializeClass(thread, klass)</code>\u3002</li> <li>\u8fd9\u4e00\u6b65\u662f\u628a roots \u53d8\u6210\u201c\u53ef\u7528\u7684\u5df2\u521d\u59cb\u5316 Class\u201d\uff0c\u901a\u5e38\u53d1\u751f\u5728 runtime \u5b8c\u6210 VM/heap \u5efa\u7acb\u540e\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#6-getclass-findloadedclass-contexterrorhandler-l171l184-l211l226","title":"6. GetClass / FindLoadedClass\uff1a\u628a context/errorHandler \u89e3\u6790\u6210\u201c\u771f\u5b9e\u5bf9\u8c61\u201d\uff08L171\u2013L184 + L211\u2013L226\uff09","text":"<ul> <li><code>FindLoadedClass</code>\uff08L171\u2013L174\uff09\uff1a\u59d4\u6258 <code>ClassLinker::FindLoadedClass(descriptor, ResolveContext(context))</code>\u3002</li> <li><code>GetClass(descriptor)</code>\uff08L176\u2013L184\uff09\uff1a\u59d4\u6258 <code>ClassLinker::GetClass(descriptor, ..., ResolveContext, ResolveErrorHandler)</code>\u3002</li> <li><code>GetClass(pf,id)</code>\uff08L211\u2013L226\uff09\uff1a\u59d4\u6258 <code>ClassLinker::GetClass(pf,id, ...)</code>\uff0c\u5e76\u5728\u5931\u8d25\u65f6\u89e6\u53d1\u5f02\u5e38\u5305\u88c5\uff08\u89c1\u4e0b\u4e00\u8282\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#7-wrapclassnotfoundexceptionifneededl186l209","title":"7. \u5173\u952e\u70b9\uff1aWrapClassNotFoundExceptionIfNeeded\uff08L186\u2013L209\uff09","text":"<p>\u8fd9\u662f\u672c\u6587\u4ef6\u4e2d\u6700\u5bb9\u6613\u88ab Stage1/Stage2 \u5ffd\u7565\u4f46\u975e\u5e38\u91cd\u8981\u7684\u8bed\u4e49\uff1a - \u4ec5\u5f53\u5f53\u524d\u7ebf\u7a0b <code>HasPendingException()</code> \u624d\u5de5\u4f5c\u3002 - \u53d6 <code>classNotFoundExceptionClass = extension(ctx)-&gt;GetClass(ClassNotFoundExceptionDescriptor)</code>\uff1a   - \u82e5\u53d6\u4e0d\u5230\uff0c\u8ba4\u4e3a\u662f OOM \u8def\u5f84\uff08\u4fdd\u6301\u539f\u5f02\u5e38\uff09\u3002 - \u82e5\u5f53\u524d pending exception \u7684\u7c7b\u578b\u662f ClassNotFoundException\uff1a   - \u53d6 <code>name = ClassHelper::GetName(descriptor)</code>   - \u629b <code>NoClassDefFoundError</code>\uff08<code>ctx.GetNoClassDefFoundErrorDescriptor()</code>\uff09\u5e76\u5e26\u4e0a\u7c7b\u540d\u3002</p> <p>\u7ed3\u8bba\uff1a\u5f53\u201c\u6309 pf+id \u53d6 class \u5931\u8d25\u201d\u89e6\u53d1 CNFE \u65f6\uff0cextension \u4f1a\u628a\u5b83\u5347\u7ea7/\u8f6c\u6362\u4e3a NCDFE\uff08\u66f4\u8d34\u8fd1\u94fe\u63a5\u9636\u6bb5\u8bed\u4e49\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#8-addclasscontext-onclasspreparedl228l242","title":"8. <code>AddClass</code>\uff1acontext \u63d2\u5165 + \u5e76\u53d1\u53bb\u91cd + OnClassPrepared\uff08L228\u2013L242\uff09","text":"<ul> <li>\u901a\u8fc7 <code>klass-&gt;GetLoadContext()</code> \u53d6 context\uff0c\u5e76 <code>ResolveContext(context)-&gt;InsertClass(klass)</code>\uff1a</li> <li>\u82e5\u8fd4\u56de\u975e\u7a7a\uff08\u53e6\u7ebf\u7a0b\u5df2\u63d2\u5165\u540c\u540d\u7c7b\uff09\uff0c\u91ca\u653e\u5f53\u524d\u65b0\u7c7b\uff1a<code>classLinker_-&gt;FreeClass(klass)</code> \u5e76\u8fd4\u56de\u5df2\u6709\u7c7b\u3002</li> <li>\u63d2\u5165\u6210\u529f\u5219\u8c03\u7528 <code>OnClassPrepared(klass)</code>\uff08\u89c1\u4e0b\uff1anew class recording\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#9-loaded-classes-l244l289","title":"9. Loaded classes \u904d\u5386\u4e0e\u91ca\u653e\uff08L244\u2013L289\uff09","text":"<ul> <li><code>NumLoadedClasses/VisitLoadedClasses</code>\uff1aboot + \u6240\u6709 contexts \u7d2f\u52a0/\u904d\u5386\u3002</li> <li><code>FreeLoadedClasses</code>\uff1a</li> <li>\u5bf9 boot context \u4e0e\u6bcf\u4e2a app context \u679a\u4e3e\u6240\u6709\u7c7b\uff1a<ul> <li>\u5148 <code>FreeClass(klass)</code>\uff08\u8bed\u8a00\u5b9e\u73b0\uff1a\u4f8b\u5982 ETS \u4f1a\u4ece created map \u79fb\u9664\uff09</li> <li>\u518d <code>classLinker_-&gt;FreeClassData(klass)</code>\uff08\u8bed\u8a00\u65e0\u5173\u91ca\u653e\uff1afields/methods/itable/interfaces \u7b49\uff09</li> </ul> </li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#10-appcontext-panda-files-classlinkerl291l320","title":"10. \u521b\u5efa AppContext\uff1a\u4ece\u8def\u5f84\u6253\u5f00 panda files \u5e76\u6ce8\u518c\u5230 ClassLinker\uff08L291\u2013L320\uff09","text":"<ul> <li><code>CreateApplicationClassLinkerContext(paths)</code>\uff1a</li> <li><code>OpenPandaFileOrZip</code> \u6253\u5f00\u6bcf\u4e2a path\uff0c\u7d2f\u79ef <code>PandaFilePtr</code>\u3002</li> <li>\u8c03\u7528\u91cd\u8f7d <code>CreateApplicationClassLinkerContext(std::move(appFiles))</code>\u3002</li> <li><code>CreateApplicationClassLinkerContext(appFiles)</code>\uff1a</li> <li>\u63d0\u53d6 <code>const panda_file::File*</code> \u5217\u8868\u7ed9 <code>AppContext</code> \u6784\u9020\uff08\u53ea\u5b58\u6307\u9488\uff09</li> <li>\u7528 <code>allocator-&gt;New&lt;AppContext&gt;(this, std::move(appFilePtrs))</code> \u5206\u914d context</li> <li><code>RegisterContext(...)</code> \u628a\u5b83\u6302\u5230 <code>contexts_</code></li> <li>\u904d\u5386 <code>appFiles</code>\uff0c\u9010\u4e2a <code>classLinker_-&gt;AddPandaFile(std::move(pf), ctx)</code> \u6ce8\u518c\u5230 ClassLinker\uff08\u53ef\u89e6\u53d1 AOT snapshot/\u901a\u77e5/boot filter \u7b49\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#11-creatednewobsolete-classesl322l375","title":"11. created/new/obsolete classes\uff1a\u4e09\u7c7b\u5bb9\u5668\u8bed\u4e49\uff08L322\u2013L375\uff09","text":"<ul> <li><code>AddCreatedClass/RemoveCreatedClass</code>\uff1a<code>createdClasses_</code> \u53d7 <code>createdClassesLock_</code> \u4fdd\u62a4\uff0c\u7528\u4e8e\u8ddf\u8e2a\u201c\u521a\u521b\u5efa\u8fd8\u672a prepared \u7684\u7c7b\u201d\u3002</li> <li><code>OnClassPrepared</code>\uff08L337\u2013L347\uff09\uff1a</li> <li>\u82e5 <code>recordNewClass_</code> \u4e3a\u771f\uff08seq_cst\uff09\uff0c\u628a klass push \u5230 <code>newClasses_</code>\u3002</li> <li>\u7136\u540e\u4ece <code>createdClasses_</code> \u79fb\u9664\uff08prepared \u540e\u4e0d\u518d\u5c5e\u4e8e created\uff09\u3002</li> <li>seq_cst \u6ce8\u91ca\uff08L339\u2013L340\uff09\uff1a\u5f3a\u8c03 record_new_class_ \u7684\u4e00\u81f4\u53ef\u89c1\u6027\u9700\u6c42\u3002</li> <li><code>AddObsoleteClass/FreeObsoleteData</code>\uff1a\u652f\u6301 hot reload/obsolete class \u6570\u636e\u56de\u6536\uff08\u672c\u7ae0\u4ec5\u9700\u77e5\u9053\u5b83\u4eec\u5b58\u5728\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#12-managed-class-object-l349l357","title":"12. managed class object \u6620\u5c04\uff08L349\u2013L357\uff09","text":"<ul> <li><code>FromClassObject(ObjectHeader*)</code>\uff1a\u628a managed <code>coretypes::Class*</code> \u8f6c\u4e3a runtime <code>Class*</code>\u3002</li> <li><code>GetClassObjectSizeFromClassSize(size)</code>\uff1a<code>coretypes::Class::GetSize(size)</code>\uff08managed class object size \u4e0e runtime class size \u7684\u6362\u7b97\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_linker_extension.cpp/#_1","title":"\u8bc1\u636e\u94fe\u4e0e\u5173\u8054\u9605\u8bfb","text":"<ul> <li>\u62bd\u8c61\u4e0e\u6570\u636e\u6210\u5458\uff1aFileNotes/runtime_include_class_linker_extension.h</li> <li><code>ClassLinker</code> \u4e3b\u7ba1\u7ebf/FreeClassData\uff1aFileNotes/runtime_class_linker.cpp</li> <li>core \u8bed\u8a00\u5b9e\u73b0\uff08roots \u4e0e CreateClass\uff09\uff1a<code>runtime/core/core_class_linker_extension.cpp</code>\uff08\u5c06\u8865\u9f50\u9010\u884c\uff09</li> <li>ETS \u8bed\u8a00\u5b9e\u73b0\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.cpp/","title":"FileNote\uff1a<code>runtime/class_lock.cpp</code>\uff08ClassLock \u7684\u771f\u5b9e\u884c\u4e3a\uff1a\u7ebf\u7a0b\u72b6\u6001 + per-class condvar\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.cpp/#1-managed-class-object-class","title":"1) \u6784\u9020\uff1a\u628a managed class object \u6620\u5c04\u5230 <code>Class*</code>\uff0c\u5e76\u52a0\u9501","text":"<p>\u5173\u952e\u6b65\u9aa4\uff08<code>ClassLock::ClassLock(const ObjectHeader *obj)</code>\uff09\uff1a</p> <ul> <li><code>cls_ = Class::FromClassObject(obj)</code>\uff1a\u4ece class object \u53d6 runtime <code>Class*</code></li> <li><code>clsLinkerCtx = cls_-&gt;GetLoadContext()</code></li> <li><code>clsMtx_ = clsLinkerCtx-&gt;GetClassMutexHandler(cls_)</code>\uff1a\u62ff\u5230 per-class \u7684 <code>ClassMutexHandler</code></li> <li><code>ScopedChangeThreadStatus(..., IS_BLOCKED)</code>\uff1a\u628a\u5f53\u524d\u7ebf\u7a0b\u72b6\u6001\u6807\u4e3a blocked</li> <li><code>clsMtx_-&gt;Lock()</code>\uff1a\u8fdb\u5165 recursive mutex</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.cpp/#2-waitnotify-condvar","title":"2) Wait/Notify\uff1a\u5bf9\u5916\u8bed\u4e49\u5c31\u662f condvar","text":"<ul> <li><code>Wait()</code>\uff1a<code>ScopedChangeThreadStatus(..., IS_WAITING)</code> + <code>clsMtx_-&gt;Wait()</code></li> <li><code>Notify()</code>\uff1a<code>Signal()</code></li> <li><code>NotifyAll()</code>\uff1a<code>SignalAll()</code></li> <li>\u6790\u6784\uff1a<code>Unlock()</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.cpp/#3-classloading","title":"3) \u4f60\u5e94\u8be5\u5982\u4f55\u628a\u5b83\u653e\u8fdb ClassLoading \u7684\u5fc3\u667a\u6a21\u578b","text":"<p><code>ClassLock</code> \u4f53\u73b0\u4e86 runtime \u5185\u786e\u5b9e\u5b58\u5728\u201c\u6309 Class \u7c92\u5ea6\u7684 condvar \u673a\u5236\u201d\uff0c\u4f46\u8981\u907f\u514d\u8bef\u5224\uff1a</p> <ul> <li>\u5f53\u524d class loading \u7684\u53bb\u91cd\u4e3b\u7ebf\u5e76\u672a\u4f7f\u7528 ClassLock\uff08\u4e5f\u672a\u76f4\u63a5\u4f7f\u7528 <code>GetClassMutexHandler</code>\uff09</li> <li>\u6240\u4ee5\u5e76\u53d1\u52a0\u8f7d\u540c\u4e00\u7c7b\u65f6\uff0c\u4f18\u5148\u7528\u201c\u91cd\u590d\u6784\u5efa + InsertClass \u53bb\u91cd\u201d\u7684\u6a21\u578b\u7406\u89e3</li> </ul> <p>\u5bf9\u5e94\u603b\u8ff0\uff1a - Flows/Concurrency_and_ClassLock</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.h/","title":"FileNote\uff1a<code>runtime/class_lock.h</code>\uff08per-class lock/condvar \u7684 RAII \u5305\u88c5\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.h/#0-filenote","title":"0) \u8fd9\u4efd FileNote \u8986\u76d6\u4ec0\u4e48","text":"<p>\u672c\u6587\u4ef6\u5b9a\u4e49 <code>ClassLock</code>\uff1a\u4e00\u4e2a\u56f4\u7ed5 <code>ClassLinkerContext::ClassMutexHandler</code> \u7684 RAII \u5c01\u88c5\uff0c\u63d0\u4f9b <code>Wait/Notify/NotifyAll</code>\u3002</p> <p>\u6ce8\u610f\uff1a\u5b83\u662f\u201c\u901a\u7528\u5de5\u5177/\u6f5c\u5728\u63a5\u5165\u70b9\u201d\uff0c\u5f53\u524d <code>runtime/class_linker.cpp</code> \u7684\u7c7b\u52a0\u8f7d\u53bb\u91cd\u4e3b\u7ebf\u5e76\u672a\u4f7f\u7528\u5b83\uff1b\u5e76\u53d1\u53bb\u91cd\u4e3b\u8981\u4f9d\u8d56 <code>InsertClass</code>\uff08\u89c1 Flows/Concurrency_and_ClassLock\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.h/#1","title":"1) \u6838\u5fc3\u63a5\u53e3","text":"<ul> <li><code>ClassLock(const ObjectHeader *obj)</code>\uff1a\u4ece managed class object \u63d0\u53d6 <code>Class*</code> \u5e76\u52a0\u9501</li> <li><code>Wait()</code>\uff1acondvar wait</li> <li><code>Notify()/NotifyAll()</code>\uff1asignal/signalAll</li> <li><code>~ClassLock()</code>\uff1a\u89e3\u9501</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_class_lock.h/#2","title":"2) \u8bc1\u636e\u94fe","text":"<ul> <li>\u5b9e\u73b0\uff1a<code>runtime/class_lock.cpp</code></li> <li>\u4f9d\u8d56\uff1a<code>runtime/class_linker_context.h</code>\uff08<code>ClassMutexHandler</code> \u4e0e <code>GetClassMutexHandler</code>\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/","title":"<code>runtime/core/core_class_linker_extension.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cCore \u8bed\u8a00 Extension\uff1aroots \u81ea\u4e3e + CreateClass\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u89c4\u6a21\uff1a481 \u884c \u76ee\u6807\uff1a\u628a\u201c\u9ed8\u8ba4 ClassLinkerExtension \u62bd\u8c61\u201d\u5728 core\uff08PANDA_ASSEMBLY\uff09\u8bed\u8a00\u4e0b\u7684\u843d\u5730\u8bb2\u6e05\u695a\uff1a\u9519\u8bef\u6620\u5c04\u3001\u6839\u7c7b\u81ea\u4e3e\uff08primitive/array/synthetic/String \u5b50\u7c7b\uff09\u3001CreateClass \u7684 heap \u5206\u914d\u4e0e managed&lt;-&gt;runtime \u7ed1\u5b9a\u3001\u4ee5\u53ca\u5404 root \u7684 vtable/IMT/size \u7b56\u7565\u3002</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#core-roots-classobjectstring-string-primitivearray","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aCore roots \u81ea\u4e3e\uff08Class/Object/String + String \u5b50\u7c7b + primitive/array\uff09","text":"<pre><code>flowchart TD\n  A[\"InitializeImpl(compressedStringEnabled)\"] --&gt; C[\"Create CLASS root\\n(coretypes::Class::SetClass(self))\"]\n  C --&gt; O{\"GetClass(Object) from boot?\"}\n  O --&gt;|\u6709 stdlib| O1[\"SetClassRoot(OBJECT, objClass)\"]\n  O --&gt;|\u65e0 stdlib| O2[\"Create OBJECT root\\nSetObjectSize(ObjectHeaderSize)\\nAddClassRoot(OBJECT)\"]\n  O1 --&gt; B[\"classClass-&gt;SetBase(objClass)\"]\n  O2 --&gt; B\n  B --&gt; S[\"Create STRING root\\n(base=Object, state=LOADED)\\nAddClassRoot(STRING)\"]\n  S --&gt; SS[\"BuildClass: Line/Sliced/TreeString \u5b50\u7c7b\\nFillStringClass \u5199 GC \u5143\u6570\u636e\\nAddClassRoot(*)\"]\n  SS --&gt; P[\"InitializeClassRoots:\\nprimitive + array + synthetic(ANY/NEVER)\"]\n  P --&gt; R[\"roots \u81ea\u4e3e\u5b8c\u6210\"]\n\n  subgraph CreateClass[\"CreateClass(descriptor, size) \u7684\u5173\u952e\u8bed\u4e49\"]\n    X[\"AllocateNonMovableObject\\n(coretypes::Class sized)\"] --&gt; Y[\"coretypes::Class::InitClass\"]\n    Y --&gt; Z[\"klass = GetRuntimeClass\\nklass-&gt;SetManagedObject(res)\\nAddCreatedClass(klass)\"]\n  end</code></pre>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#0-include-l16l23","title":"0. include \u4e0e\u5b9a\u4f4d\uff08L16\u2013L23\uff09","text":"<ul> <li><code>core_class_linker_extension.h</code>\uff1a<code>CoreClassLinkerExtension</code> \u58f0\u660e\uff08\u7ee7\u627f <code>ClassLinkerExtension</code>\uff09\u3002</li> <li><code>include/class_root.h</code>\uff1a<code>ClassRoot</code> \u679a\u4e3e\uff08OBJECT/CLASS/STRING/ARRAY_* \u7b49\uff09\u3002</li> <li><code>coretypes/class.h</code>\uff1amanaged <code>coretypes::Class</code> \u4e0e runtime <code>Class</code> \u7684\u6620\u5c04\u3002</li> <li><code>exceptions.h</code>\u3001<code>panda_vm.h</code>\uff1a\u629b\u5f02\u5e38\u4e0e\u62ff VM/heap manager\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#1-errorhandler-classlinkererror-l29l60","title":"1. ErrorHandler\uff1a\u628a ClassLinker::Error \u6620\u5c04\u4e3a\u5f02\u5e38\uff08L29\u2013L60\uff09","text":"<ul> <li>\u53d6\u5f53\u524d\u7ebf\u7a0b <code>ManagedThread::GetCurrent()</code>\u3002</li> <li>\u7528 <code>PANDA_ASSEMBLY</code> \u7684 <code>LanguageContext</code> \u4f5c\u4e3a\u629b\u5f02\u5e38\u8bed\u5883\uff08L32\uff09\u3002</li> <li><code>switch(error)</code>\uff1a</li> <li><code>CLASS_NOT_FOUND</code> \u2192 <code>ClassNotFoundException</code></li> <li><code>FIELD_NOT_FOUND</code> \u2192 <code>NoSuchFieldError</code></li> <li><code>METHOD_NOT_FOUND</code> \u2192 <code>NoSuchMethodError</code></li> <li><code>NO_CLASS_DEF</code> \u2192 <code>NoClassDefFoundError</code></li> <li><code>CLASS_CIRCULARITY</code> \u2192 <code>ClassCircularityError</code></li> <li>default\uff1aFATAL</li> </ul> <p>\u5bf9\u9f50\u70b9\uff1a\u8fd9\u662f core \u8bed\u8a00\u5bf9 <code>ClassLinkerErrorHandler</code> \u7684\u9ed8\u8ba4\u5b9e\u73b0\uff1bETS \u6709\u81ea\u5df1\u7684\u4e00\u5957\u6620\u5c04\uff08\u89c1 <code>plugins/ets/runtime/ets_class_linker_extension.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#2-initializeclassrootsprimitivearraysynthetic-rootsl62l94","title":"2. InitializeClassRoots\uff1aprimitive/array/synthetic roots\uff08L62\u2013L94\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#21-primitive-rootsl64l76","title":"2.1 primitive roots\uff08L64\u2013L76\uff09","text":"<ul> <li>\u5178\u578b\uff1a<code>U1 -&gt; \"Z\"</code>, <code>I32 -&gt; \"I\"</code>, <code>F64 -&gt; \"D\"</code>, <code>TAGGED -&gt; \"A\"</code> \u7b49\u3002</li> <li>\u901a\u8fc7\u57fa\u7c7b helper\uff1a<code>InitializePrimitiveClassRoot(root, typeId, descriptor)</code>\uff08\u5b9e\u73b0\u5728 <code>runtime/class_linker_extension.cpp</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#22-array-rootsl77l90","title":"2.2 array roots\uff08L77\u2013L90\uff09","text":"<ul> <li>\u5178\u578b\uff1a<code>ARRAY_I32 -&gt; \"[I\"</code>\uff0c<code>ARRAY_STRING -&gt; String[] descriptor</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#23-synthetic-rootsl92l93","title":"2.3 synthetic roots\uff08L92\u2013L93\uff09","text":"<ul> <li><code>ANY -&gt; \"Y\"</code>, <code>NEVER -&gt; \"N\"</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#3-string-fillstringclass-getstringclassdescriptorl96l145","title":"3. String \u5b50\u7c7b\uff1aFillStringClass + GetStringClassDescriptor\uff08L96\u2013L145\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#31-fillstringclassl96l127","title":"3.1 FillStringClass\uff08L96\u2013L127\uff09","text":"<ul> <li>\u8fdb\u5165 <code>INITIALIZING</code>\u3002</li> <li>\u5bf9\u4e0d\u540c\u5b50\u7c7b\u8bbe\u7f6e\u6807\u5fd7\u4f4d\uff1a</li> <li><code>LINE_STRING</code>\uff1a\u4ec5 <code>SetLineStringClass()</code></li> <li><code>SLICED_STRING</code> / <code>TREE_STRING</code>\uff1a\u989d\u5916\u5199\u5165 GC \u6240\u9700\u5143\u6570\u636e<ul> <li><code>SetRefFieldsNum(...)</code></li> <li><code>SetRefFieldsOffset(...)</code></li> <li><code>SetObjectSize(common::{Sliced,Tree}String::SIZE)</code>\uff08\u6ce8\u610f\u8fd9\u91cc cast \u5230 <code>BaseClass*</code> \u5199 object size\uff09</li> </ul> </li> <li>\u6700\u7ec8\uff1a<code>SetStringClass()</code>\u3001<code>SetState(INITIALIZED)</code>\u3001<code>SetFinal()</code></li> </ul> <p>\u5173\u952e\u7ed3\u8bba\uff1aString \u5b50\u7c7b\u7684 GC ref-fields \u5143\u6570\u636e\u5728 root \u521d\u59cb\u5316\u9636\u6bb5\u5c31\u5199\u6b7b\uff0c\u800c\u4e0d\u662f\u7531 LayoutFields \u52a8\u6001\u8ba1\u7b97\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#32-getstringclassdescriptorl129l144","title":"3.2 GetStringClassDescriptor\uff08L129\u2013L144\uff09","text":"<ul> <li>\u76f4\u63a5\u8fd4\u56de\u56fa\u5b9a descriptor\uff1a<code>Lpanda/LineString;</code> / <code>Lpanda/SlicedString;</code> / <code>Lpanda/TreeString;</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#4-initializestringclass-string-buildclass-l146l185","title":"4. InitializeStringClass\uff1a\u5148 String\uff0c\u518d\u7528 BuildClass \u9020\u5b50\u7c7b\uff08L146\u2013L185\uff09","text":"<ul> <li>\u5148\u7528 <code>CreateClass(ctx.GetStringClassDescriptor(), ...)</code> \u521b\u5efa String root\uff1a</li> <li><code>SetBase(objCls)</code>\u3001<code>SetStringClass()</code>\u3001<code>RemoveFinal()</code>\u3001state=LOADED\u3001loadContext=boot\u3002</li> <li><code>AddClassRoot(STRING, strCls)</code>\uff08\u5199\u5165 roots \u8868\u5e76\u63d2\u5165 boot context\uff09\u3002</li> <li>\u518d\u521b\u5efa <code>LINE/SLICED/TREE</code> \u5b50\u7c7b\uff1a</li> <li>\u590d\u7528 base String \u7684 fields/methods/interfaces\uff08\u7a7a span\uff09\uff0c\u7528 <code>ClassLinker::BuildClass(descriptor, ..., base=strCls, bootContext)</code> \u521b\u5efa runtime class\u3002</li> <li>\u8c03 <code>FillStringClass(subStrCls, flag)</code> \u5199\u5165\u5b50\u7c7b\u7279\u6027\u4e0e GC \u5143\u6570\u636e\u3002</li> <li><code>AddClassRoot(flag, subStrCls)</code> \u6ce8\u518c\u3002</li> </ul> <p>\u5bf9\u9f50\u70b9\uff1a\u8fd9\u6761\u94fe\u8def\u89e3\u91ca\u4e86 Stage1 \u4e2d\u63d0\u5230\u7684\u201cString \u5b50\u7c7b\u5728\u521d\u59cb\u5316\u65f6\u663e\u5f0f\u5199\u5165 refFieldsNum/Offset/objectSize\u201d\u7684\u4f9d\u636e\uff0c\u4f46\u5b9e\u73b0\u4e3b\u4f53\u662f\u5728 CoreClassLinkerExtension\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#5-initializeimplclassclassclassobject-fallback-compressed-stringsl187l222","title":"5. InitializeImpl\uff1aclass/classClass/object fallback + compressed strings\uff08L187\u2013L222\uff09","text":"<ul> <li>\u521b\u5efa <code>ClassRoot::CLASS</code>\uff1a</li> <li><code>CreateClass(ClassDescriptor, ...)</code></li> <li><code>coretypes::Class::FromRuntimeClass(classClass)-&gt;SetClass(classClass)</code>\uff08class object \u7684 class \u6307\u5411\u81ea\u8eab\uff09</li> <li>state=LOADED\u3001loadContext=boot\u3001<code>AddClassRoot(CLASS, classClass)</code></li> <li>\u83b7\u53d6/\u521b\u5efa <code>OBJECT</code>\uff1a</li> <li>\u5c1d\u8bd5 <code>GetClassLinker()-&gt;GetClass(ObjectDescriptor, false, bootContext)</code></li> <li>\u82e5\u6ca1\u6709 pandastdlib\uff08\u8fd4\u56de\u7a7a\uff09\uff0c\u5c31 <code>CreateClass(ObjectDescriptor, ...)</code> \u5e76 <code>SetObjectSize(ObjectHeaderSize)</code>\uff0c\u518d <code>AddClassRoot(OBJECT, objClass)</code></li> <li>\u5426\u5219 <code>SetClassRoot(OBJECT, objClass)</code></li> <li><code>classClass-&gt;SetBase(objClass)</code></li> <li><code>coretypes::String::SetCompressedStringsEnabled(compressedStringEnabled)</code></li> <li><code>InitializeStringClass()</code> + <code>InitializeArrayClassRoot(ARRAY_CLASS, CLASS, ...)</code> + <code>InitializeClassRoots(ctx)</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#6-initializearrayclassinitializeunionclassinitializeprimitiveclassinitializesyntheticclassl224l271","title":"6. InitializeArrayClass/InitializeUnionClass/InitializePrimitiveClass/InitializeSyntheticClass\uff08L224\u2013L271\uff09","text":"<ul> <li>Array\uff1a</li> <li>base=OBJECT\uff1bcomponentType\uff1b\u4ece component \u7684 accessFlags \u6d3e\u751f\uff08\u53bb\u6389 interface\uff0c\u52a0 final|abstract\uff09\uff1bstate=INITIALIZED\u3002</li> <li>Union\uff1a</li> <li>base=OBJECT\uff1b\u5199 constituentTypes\uff1b</li> <li>accessFlags \u53d6 constituent \u4ea4\u96c6\uff0c\u518d\u52a0 final|abstract\uff1bstate=INITIALIZED\u3002</li> <li>Primitive/Synthetic\uff1a\u90fd\u8bbe <code>ACC_PUBLIC|ACC_FINAL|ACC_ABSTRACT</code> \u4e14 state=INITIALIZED\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#7-root-vtableimtsize-l273l436","title":"7. root \u7684 vtable/IMT/size \u7b56\u7565\uff08L273\u2013L436\uff09","text":"<ul> <li><code>GetClassVTableSize/GetClassIMTSize</code>\uff1a</li> <li>primitive/any/never/tagged \u2192 0</li> <li>array_* \u2192 \u590d\u7528 OBJECT \u7684 array size getter</li> <li>OBJECT/CLASS/STRING/LINE_STRING \u2192 0</li> <li><code>GetClassSize</code>\uff1a</li> <li>\u5927\u591a\u6570 root \u7528 <code>Class::ComputeClassSize(vtableSize, imtSize, 0,0,0,0,0,0)</code>\uff08\u65e0\u989d\u5916\u9759\u6001\u5b57\u6bb5/\u65b9\u6cd5\u7a7a\u95f4\uff09</li> <li>array roots \u2192 <code>GetArrayClassSize()</code></li> <li><code>GetArrayClass*</code>\uff1a</li> <li>\u76f4\u63a5\u590d\u7528 OBJECT \u7684\u53c2\u6570\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#8-createclassnonmovable-coretypesclass-initclass-runtime-l438l463","title":"8. CreateClass\uff1aNonMovable \u5206\u914d + coretypes::Class InitClass + runtime \u7ed1\u5b9a\uff08L438\u2013L463\uff09","text":"<ul> <li>\u53d6 <code>vm-&gt;GetHeapManager()</code>\uff0c\u5206\u914d NonMovable object\uff1a</li> <li>\u82e5 classRoot==nullptr\uff08\u521b\u5efa CLASS \u81ea\u5df1\u65f6\uff09\u8d70 <code>AllocateNonMovableObject&lt;true&gt;</code></li> <li>\u5426\u5219\u8d70 <code>AllocateNonMovableObject&lt;false&gt;</code>\uff08\u4ee5 classRoot \u4f5c\u4e3a klass\uff09</li> <li><code>reinterpret_cast&lt;coretypes::Class*&gt;(objectHeader)</code>\uff1a</li> <li><code>res-&gt;InitClass(descriptor, vtableSize, imtSize, size)</code></li> <li><code>klass = res-&gt;GetRuntimeClass()</code></li> <li><code>klass-&gt;SetManagedObject(res)</code>\uff08managed&lt;-&gt;runtime \u7ed1\u5b9a\uff09</li> <li><code>AddCreatedClass(klass)</code>\uff08\u8fdb\u5165 createdClasses_\uff0c\u7b49\u5f85 prepared\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#9-freeclass-l465l479","title":"9. FreeClass \u4e0e\u6790\u6784\uff08L465\u2013L479\uff09","text":"<ul> <li><code>FreeClass</code>\uff1a\u4ece createdClasses_ \u79fb\u9664\u3002</li> <li>\u6790\u6784\uff1a\u82e5 initialized \u5219 <code>FreeLoadedClasses()</code>\uff08\u7531\u57fa\u7c7b\u5b9e\u73b0\u904d\u5386 boot+contexts\uff0c\u5e76 free class data\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_core_core_class_linker_extension.cpp/#_1","title":"\u8bc1\u636e\u94fe\u4e0e\u5173\u8054\u9605\u8bfb","text":"<ul> <li>\u62bd\u8c61\u4e0e\u5bb9\u5668\u8bed\u4e49\uff1aFileNotes/runtime_include_class_linker_extension.h + FileNotes/runtime_class_linker_extension.cpp</li> <li>ClassLinker roots \u521d\u59cb\u5316\u8c03\u5ea6\uff1aFileNotes/runtime_class_linker.cpp\uff08Initialize/InitializeRoots \u8c03\u7528 ext-&gt;Initialize/InitializeRoots\uff09</li> <li>ETS \u5bf9\u5e94\u5b9e\u73b0\uff1aFileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/","title":"<code>runtime/file_manager.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aFileManager \u5b9e\u73b0\uff1a<code>.abc</code>/<code>.an</code> \u7684\u52a0\u8f7d\u7b56\u7565\u4e0e ClassLinker/AotManager \u7684\u8fde\u63a5\u70b9\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/#1-l16l21","title":"1. \u4f9d\u8d56\u4e0e\u547d\u540d\u7a7a\u95f4\uff08L16\u2013L21\uff09","text":"<ul> <li>L16\uff1a\u5bf9\u5e94\u5934\uff1a<code>runtime/include/file_manager.h</code></li> <li>L17\uff1a<code>runtime/include/runtime.h</code>\uff1a\u83b7\u53d6 <code>Runtime::GetCurrent()</code>\u3001options\u3001classLinker\u3002</li> <li>L18\uff1afilesystem\uff1a<code>os::GetAbsolutePath</code>\u3002</li> <li>L20\uff1a<code>namespace ark {</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/#2-loadabcfilel22l39","title":"2. <code>LoadAbcFile</code>\uff08L22\u2013L39\uff09","text":"<p>\u6d41\u7a0b\uff1a - L24\u2013L28\uff1a<code>OpenPandaFile(location, \"\", openMode)</code>\uff1b\u5931\u8d25\u5219 log \u5e76\u8fd4\u56de false\u3002 - L29\uff1a\u53d6 <code>runtime = Runtime::GetCurrent()</code>\u3002 - L30\u2013L36\uff1a\u5f53\u542f\u7528 <code>.an</code> \u4e14\u975e ArkAot \u6a21\u5f0f\uff1a   - <code>TryLoadAnFileForLocation(location)</code>\uff1a\u5c1d\u8bd5\u52a0\u8f7d\u5bf9\u5e94 AOT \u6587\u4ef6   - \u901a\u8fc7 <code>runtime-&gt;GetClassLinker()-&gt;GetAotManager()-&gt;FindPandaFile(location)</code> \u67e5\u627e aotFile   - \u82e5\u5b58\u5728\uff1a\u628a <code>aotFile-&gt;GetClassHashTable()</code> \u56de\u586b\u7ed9 panda file\uff08<code>pf-&gt;SetClassHashTable(...)</code>\uff09     - \u76ee\u7684\uff1a\u52a0\u901f class id/hash \u76f8\u5173\u67e5\u627e\uff08\u5c5e\u4e8e class linker \u7684 boot/filter \u8def\u5f84\u6027\u80fd\u4f18\u5316\uff09 - L37\uff1a<code>runtime-&gt;GetClassLinker()-&gt;AddPandaFile(std::move(pf))</code>\uff1a   - \u89e6\u53d1\uff1apandaFiles_/bootPandaFiles_ \u6ce8\u518c\u3001boot bloom filter \u9884\u70ed\u3001notification/debug \u6ce8\u518c\uff08\u89c1 <code>class_linker.cpp</code>\uff09\u3002 - L38\uff1a\u6210\u529f\u8fd4\u56de true\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/#3-tryloadanfileforlocationl41l64","title":"3. <code>TryLoadAnFileForLocation</code>\uff08L41\u2013L64\uff09","text":"<p>\u7ed9\u5b9a <code>.abc</code> \u8def\u5f84\uff0c\u63a8\u5bfc <code>.an</code> \u4f4d\u7f6e\u4e0e\u6587\u4ef6\u540d\u524d\u7f00\uff1a - L43\u2013L47\uff1a\u4ece <code>abcPath</code> \u627e\u6700\u540e\u4e00\u4e2a <code>'/'</code> \u4e0e <code>'.'</code>\uff0c\u4efb\u4e00\u4e0d\u5b58\u5728\u76f4\u63a5\u8fd4\u56de true\uff08\u4e0d\u89c6\u4e3a\u9519\u8bef\uff09\u3002 - L48\u2013L50\uff1a<code>abcFilePrefix = abcPath.substr(posStart, posEnd-posStart)</code>\uff08\u6ce8\u610f\u5305\u542b <code>/</code>\uff0c\u4f8b\u5982 <code>/foo/bar.abc</code> \u2192 <code>/bar</code>\uff09\u3002 - L51\u2013L58\uff1a\u82e5\u914d\u7f6e <code>boot-an-location</code>\uff0c\u4f18\u5148\u5728\u8be5\u76ee\u5f55\u4e0b\u5c1d\u8bd5 <code>TryLoadAnFileFromLocation</code>\uff1a   - \u6210\u529f\u76f4\u63a5 true - L60\u2013L63\uff1a\u5426\u5219/\u5931\u8d25\u540e\uff0c\u5728 abc \u6587\u4ef6\u540c\u76ee\u5f55\u7ee7\u7eed\u5c1d\u8bd5\u4e00\u6b21\u3002 - L63\uff1a\u6574\u4f53\u8fd4\u56de true\uff08\u8bbe\u8ba1\u4e0a\uff1a\u627e\u4e0d\u5230 <code>.an</code> \u4e0d\u7b97\u9519\u8bef\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/#4-tryloadanfilefromlocationl66l90","title":"4. <code>TryLoadAnFileFromLocation</code>\uff08L66\u2013L90\uff09","text":"<ul> <li>L69\u2013L71\uff1a\u62fc\u51fa <code>anFilePath = anFileLocation + abcFilePrefix + \".an\"</code>\u3002</li> <li>L72\u2013L77\uff1a<code>access(filename, F_OK)</code> \u4e0d\u5b58\u5728\u5219 DEBUG log \u5e76\u8fd4\u56de false\u3002</li> <li>L78\u2013L89\uff1a\u8c03\u7528 <code>LoadAnFile(anFilePath, force=false)</code>\uff1a</li> <li><code>res &amp;&amp; res.Value()</code>\uff1aINFO log \u6210\u529f\u5e76\u8fd4\u56de true</li> <li><code>!res</code>\uff1aINFO log \u5e76\u6253\u5370 <code>res.Error()</code></li> <li><code>res</code> \u4f46 Value=false\uff1aINFO log unknown reason</li> <li>\u6700\u7ec8 false</li> </ul> <p>\u8fd9\u6bb5\u8bf4\u660e\uff1a<code>.an</code> \u52a0\u8f7d\u5931\u8d25\u4f1a\u88ab\u8bb0\u5f55\uff0c\u4f46\u4e0d\u963b\u65ad <code>.abc</code> \u7684\u52a0\u8f7d\u8def\u5f84\uff08\u4e0a\u5c42\u4ecd\u53ef\u80fd\u7ee7\u7eed\u8fd0\u884c\u89e3\u91ca\u5668/\u975e AOT\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_file_manager.cpp/#5-loadanfilel92l101","title":"5. <code>LoadAnFile</code>\uff08L92\u2013L101\uff09","text":"<p>\u771f\u6b63\u7684 AOT \u6587\u4ef6\u52a0\u8f7d\u5165\u53e3\uff1a - L94\uff1a\u6784\u9020 <code>PandaRuntimeInterface runtimeIface</code>\uff08\u4f5c\u4e3a AOT manager \u7684\u8fd0\u884c\u65f6\u56de\u8c03\u63a5\u53e3\uff09\u3002 - L95\uff1a<code>runtime = Runtime::GetCurrent()</code>\u3002 - L96\u2013L97\uff1a\u6839\u636e runtime options + runtime type \u63a8\u5bfc <code>gcType</code>\uff0c\u5e76\u65ad\u8a00\u975e INVALID\u3002 - L98\uff1a<code>realAnFilePath = os::GetAbsolutePath(anLocation)</code>\uff1a\u7528\u7edd\u5bf9\u8def\u5f84\u4f5c\u4e3a AOT file key\u3002 - L99\u2013L100\uff1a<code>AotManager::AddFile(realAnFilePath, &amp;runtimeIface, gcType, force)</code>\uff1a   - \u8fd4\u56de <code>Expected&lt;bool,std::string&gt;</code>\uff1a\u6210\u529f\u4e0e\u5426 + \u9519\u8bef\u5b57\u7b26\u4e32\u3002</p> <p>\u5173\u952e\u70b9\uff1aAOT \u6587\u4ef6\u52a0\u8f7d\u4e0e GC \u7c7b\u578b\u5f3a\u7ed1\u5b9a\uff08\u56e0\u4e3a AOT \u4ee3\u7801/metadata \u53ef\u80fd\u4f9d\u8d56\u7279\u5b9a barrier/\u5bf9\u8c61\u6a21\u578b\u7b56\u7565\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/","title":"<code>runtime/imtable_builder.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a<code>IMTableBuilder</code> \u5b9e\u73b0\uff08IMT \u6784\u5efa\u4e0e\u5199\u56de\uff09 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 129 \u884c\uff08\u5b9e\u73b0\u975e\u5e38\u96c6\u4e2d\uff09</p> <p>\u672f\u8bed\u901f\u67e5\uff1a\u89c1 FileNotes/_Glossary\uff08\u540c\u76ee\u5f55\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#imt","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aIMT \u7684\u201c\u662f\u5426\u6784\u5efa/\u6784\u5efa\u591a\u5927\u201d\u4e0e\u201c\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\u201d","text":"<pre><code>flowchart TD\n  A[\"Build(itable, isInterface)\"] --&gt; B{\"isInterface \u6216 itable \u4e3a\u7a7a\uff1f\"}\n  B --&gt;|\u662f| S0[\"imtSize=0\\n(\u4e0d\u6784\u5efa)\"]\n  B --&gt;|\u5426| C[\"\u7edf\u8ba1 ifmNum = \u03a3 entry.methods.size\"]\n  C --&gt; D{\"ifmNum &lt;= IMTABLE_SIZE ?\"}\n  D --&gt;|\u662f| S1[\"imtSize = ifmNum\"]\n  D --&gt;|\u5426| E{\"ifmNum &lt;= IMTABLE_SIZE*OVERSIZE_MULTIPLE ?\"}\n  E --&gt;|\u662f| S2[\"imtSize = IMTABLE_SIZE\\n(\u5141\u8bb8\u51b2\u7a81)\"]\n  E --&gt;|\u5426| S3[\"imtSize = 0\\n(\u51b2\u7a81\u6982\u7387\u592a\u9ad8\uff0c\u7981\u7528)\"]\n\n  S1 --&gt; U[\"UpdateClass(klass)\"]\n  S2 --&gt; U\n  U --&gt; F{\"klass \u662f abstract/interface \u6216 imtSize==0?\"}\n  F --&gt;|\u662f| R0[\"\u76f4\u63a5\u8fd4\u56de\uff08\u4e0d\u586b\u8868\uff09\"]\n  F --&gt;|\u5426| G[\"\u904d\u5386 itable: (itfMethods, impMethods)\"]\n  G --&gt; H[\"id = GetIMTableIndex(itfMethod.fileIdOffset)\"]\n  H --&gt; I{\"\u8be5\u69fd\u5df2\u6807\u8bb0\u51b2\u7a81\uff1f\"}\n  I --&gt;|\u662f| G\n  I --&gt;|\u5426| J[\"AddMethod(slot, impMethod)\"]\n  J --&gt; K{\"slot \u4e3a\u7a7a\uff1f\"}\n  K --&gt;|\u662f| R1[\"\u5199\u5165\u6210\u529f\"]\n  K --&gt;|\u5426| R2[\"\u51b2\u7a81\uff1a\u6e05\u7a7a slot\\n\u6807\u8bb0 conflict=true\\n\u540e\u7eed\u4e0d\u518d\u5c1d\u8bd5\u8be5\u69fd\"]</code></pre>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#1-build-imt-l21l61","title":"1. Build\uff1a\u51b3\u5b9a IMT \u7684\u201c\u662f\u5426\u6784\u5efa + \u6784\u5efa\u591a\u5927\u201d\u7b56\u7565\uff08L21\u2013L61\uff09","text":"<p>\u8be5\u5b9e\u73b0\u6709\u4e24\u4e2a Build overload\uff0c\u4f46\u7b56\u7565\u4e00\u81f4\uff1a - \u77ed\u8def\u6761\u4ef6\uff08L23\u2013L25 / L46\u2013L48\uff09\uff1a   - \u5982\u679c\u76ee\u6807\u662f interface\uff08\u63a5\u53e3\u672c\u8eab\uff09\uff0c\u6216 itable \u4e3a\u7a7a \u2192 \u4e0d\u6784\u5efa\uff08\u4fdd\u6301 imtSize_=0\uff09\u3002 - \u7edf\u8ba1\u63a5\u53e3\u65b9\u6cd5\u603b\u6570 ifmNum\uff08L27\u2013L32 / L50\u2013L55\uff09\uff1a   - \u904d\u5386 itable \u7684\u6bcf\u4e2a entry\uff0c\u628a <code>entry.GetMethods().Size()</code> \u7d2f\u52a0\u3002   - \u6ce8\u610f\uff1a\u8fd9\u91cc\u7d2f\u52a0\u7684\u662f\u201c\u5b9e\u73b0\u65b9\u6cd5\u6570\u7ec4\u201d\u7684\u957f\u5ea6\uff0c\u7b49\u4ef7\u4e8e\u8be5\u7c7b\u9700\u8981\u5b9e\u73b0\u7684\u63a5\u53e3\u865a\u65b9\u6cd5\u603b\u6570\u3002 - IMT size \u89c4\u5219\uff08L34\u2013L41 / L57\u2013L60\uff09\uff1a   - (1) <code>ifmNum &lt;= Class::IMTABLE_SIZE</code>\uff1aIMT \u53d6 <code>ifmNum</code>\uff08\u521a\u597d\u5bb9\u7eb3\uff09   - (2) <code>Class::IMTABLE_SIZE &lt; ifmNum &lt;= Class::IMTABLE_SIZE * OVERSIZE_MULTIPLE</code>\uff1aIMT \u56fa\u5b9a\u4e3a <code>Class::IMTABLE_SIZE</code>     - \u4e5f\u5c31\u662f\u5728 [32, 64]\uff08\u6ce8\u91ca\u4f8b\u5b50\uff09\u8303\u56f4\u5185\uff0c\u7528\u56fa\u5b9a\u69fd\u6570\uff0c\u63a5\u53d7\u4e00\u5b9a\u51b2\u7a81\u3002   - (3) <code>ifmNum</code> \u66f4\u5927\uff1a<code>imtSize_ = 0</code>     - \u539f\u56e0\uff1a\u51b2\u7a81\u6982\u7387\u592a\u9ad8\uff0cIMT \u4f1a\u201c\u51e0\u4e4e\u5168\u7a7a/\u4e0d\u53ef\u7528\u201d\uff0c\u4e0d\u5982\u76f4\u63a5\u653e\u5f03\uff0c\u8ba9\u63a5\u53e3\u6d3e\u53d1\u56de\u9000\u5230 itable \u8def\u5f84\u3002</p> <p>\u5173\u952e\u70b9\uff1aIMT \u4e0d\u662f\u201c\u603b\u662f\u6784\u5efa\u201d\uff0c\u5b83\u662f\u4e00\u4e2a \u53ef\u9009\u7684\u52a0\u901f\u7ed3\u6784\uff0c\u5e76\u4e14\u5bf9\u201c\u63a5\u53e3\u65b9\u6cd5\u6570\u91cf\u8fc7\u591a\u201d\u7684\u7c7b\u578b\u4f1a\u76f4\u63a5\u7981\u7528\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#2-updateclass-itable-imtl63l97","title":"2. UpdateClass\uff1a\u628a itable \u6620\u5c04\u586b\u5165 IMT\uff08L63\u2013L97\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#21-l65l72","title":"2.1 \u9002\u7528\u5bf9\u8c61\u8fc7\u6ee4\uff08L65\u2013L72\uff09","text":"<ul> <li>interface\uff1a\u4e0d\u6784\u5efa</li> <li>abstract\uff1a\u4e0d\u6784\u5efa\uff08\u56e0\u4e3a\u62bd\u8c61\u7c7b\u53ef\u80fd\u6709\u672a\u5b9e\u73b0\u63a5\u53e3\u65b9\u6cd5\uff0cIMT \u586b\u5145\u65e0\u610f\u4e49\u6216\u4f1a\u8bef\u5bfc\u6d3e\u53d1\uff09</li> <li><code>imtableSize == 0</code>\uff1a\u4e0d\u6784\u5efa\uff08Build \u9636\u6bb5\u5df2\u7981\u7528\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#22-l74","title":"2.2 \u51b2\u7a81\u8ddf\u8e2a\u8868\uff08L74\uff09","text":"<p><code>std::array&lt;bool, Class::IMTABLE_SIZE&gt; isMethodConflict</code>\uff1a - \u6bcf\u4e2a\u69fd\u4f4d\u4e00\u4e2a bool\uff0c\u8868\u793a\u8be5\u69fd\u662f\u5426\u5df2\u7ecf\u88ab\u5224\u5b9a\u4e3a\u51b2\u7a81\u69fd\u3002 - \u6ce8\u610f\uff1a\u6570\u7ec4\u7ef4\u5ea6\u56fa\u5b9a\u4e3a <code>Class::IMTABLE_SIZE</code>\uff0c\u6240\u4ee5 <code>klass-&gt;GetIMTSize()</code> \u5373\u4f7f\u5c0f\u4e8e\u5b83\u4e5f\u6ca1\u95ee\u9898\uff08\u4f7f\u7528\u65f6\u53d6 <code>itfMethodId</code>\uff0c\u8be5 id \u5fc5\u987b &lt; imtableSize\uff0c\u89c1 AddMethod \u7684 ASSERT\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#23-l76l92","title":"2.3 \u586b\u8868\u903b\u8f91\uff08L76\u2013L92\uff09","text":"<p>\u6570\u636e\u6e90\uff1a - <code>itable = klass-&gt;GetITable()</code> - <code>imtable = klass-&gt;GetIMT()</code>\uff08\u8fd9\u662f Class \u5bf9\u8c61\u5185\u90e8 IMT \u533a\u57df\u7684 span\uff09</p> <p>\u904d\u5386\u7b56\u7565\uff1a - \u904d\u5386\u6bcf\u4e2a itable entry\uff1a   - <code>itfMethods = entry.GetInterface()-&gt;GetVirtualMethods()</code>\uff08\u63a5\u53e3\u865a\u65b9\u6cd5\u5217\u8868\uff09   - <code>impMethods = entry.GetMethods()</code>\uff08\u8be5\u7c7b\u5bf9\u63a5\u53e3\u65b9\u6cd5\u7684\u5b9e\u73b0\u6620\u5c04\uff0c\u6309\u540c\u5e8f\u5bf9\u9f50\uff09 - \u5bf9\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5 j\uff1a   - <code>impMethod = impMethods[j]</code>   - <code>itfMethodId = klass-&gt;GetIMTableIndex(itfMethods[j].GetFileId().GetOffset())</code>     - \u5173\u952e\uff1aIMT \u69fd\u4f4d id \u6765\u81ea <code>Class::GetIMTableIndex(fileIdOffset)</code>\uff0c\u5c5e\u4e8e Class \u7684 hash/\u6620\u5c04\u7b56\u7565\uff08\u4e0e ART \u7684 imt hash \u7c7b\u4f3c\uff09\u3002   - \u82e5\u8be5\u69fd\u672a\u88ab\u6807\u8bb0\u51b2\u7a81\uff1a     - <code>ret = AddMethod(imtable, imtableSize, itfMethodId, impMethod)</code>     - <code>isMethodConflict[itfMethodId] = !ret</code></p> <p>\u8fd9\u5f62\u6210\u4e00\u4e2a\u201c\u4e8c\u503c\u51b2\u7a81\u7b56\u7565\u201d\uff1a - \u7b2c\u4e00\u6b21\u586b\u5165\u6210\u529f - \u7b2c\u4e8c\u6b21\u547d\u4e2d\u540c\u69fd \u2192 <code>AddMethod</code> \u4f1a\u6e05\u7a7a\u8be5\u69fd\u5e76\u8fd4\u56de false \u2192 \u51b2\u7a81\u6807\u8bb0\u4e3a true \u2192 \u540e\u7eed\u4e0d\u518d\u5c1d\u8bd5\u586b\u8be5\u69fd</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#24-debug-dumpl94l96","title":"2.4 Debug dump\uff08L94\u2013L96\uff09","text":"<p>\u4ec5\u5728 <code>!NDEBUG</code> \u4e0b dump IMT\uff08\u6253\u5370\u6bcf\u4e2a\u69fd\u7684\u65b9\u6cd5\u6216 FREE SLOT\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#3-addmethodl99l111","title":"3. AddMethod\uff1a\u51b2\u7a81\u5373\u6e05\u7a7a\uff08L99\u2013L111\uff09","text":"<ul> <li>L103\uff1a\u65ad\u8a00 <code>id &lt; imtableSize</code>\u3002</li> <li>L104\u2013L110\uff1a</li> <li>\u82e5 <code>imtable[id] == nullptr</code> \u2192 \u586b\u5165 method\uff0c\u8fd4\u56de true</li> <li>\u5426\u5219 \u2192 \u7f6e\u56de nullptr\uff0c\u8fd4\u56de false</li> </ul> <p>\u8bbe\u8ba1\u542b\u4e49\uff1aIMT \u69fd\u662f\u201c\u5355\u4e00\u5019\u9009\u201d\uff0c\u4e00\u65e6\u51b2\u7a81\u5c31\u628a\u69fd\u5e9f\u5f03\uff0c\u907f\u514d\u9519\u8bef\u6d3e\u53d1\uff08\u5b81\u53ef\u56de\u9000\u6162\u8def\u5f84\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#4-dumpimtablel113l127","title":"4. DumpIMTable\uff08L113\u2013L127\uff09","text":"<p>\u904d\u5386 <code>i in [0, imtableSize)</code>\uff1a - \u975e\u7a7a\u6253\u5370\u65b9\u6cd5\u5168\u540d - \u7a7a\u6253\u5370 FREE SLOT</p>"},{"location":"03_ClassLoading/FileNotes/runtime_imtable_builder.cpp/#5-class_linkercpp","title":"5. \u4e0e <code>class_linker.cpp</code> \u7684\u5bf9\u9f50\u70b9","text":"<ul> <li><code>SetupClassInfo</code> \u9636\u6bb5\u8c03\u7528 <code>imtableBuilder-&gt;Build(...)</code> \u51b3\u5b9a <code>imtSize_</code>\uff08\u968f\u540e\u5f71\u54cd <code>Class::ComputeClassSize</code>\uff09\u3002</li> <li><code>LinkMethods</code> \u9636\u6bb5\u8c03\u7528 <code>imtableBuilder-&gt;UpdateClass(klass)</code> \u771f\u6b63\u5199\u5165 <code>klass-&gt;GetIMT()</code> \u5185\u5bb9\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/","title":"<code>runtime/include/class-inl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a<code>Class</code> \u7684\u5185\u8054\u5b9e\u73b0\uff08\u6a21\u677f/\u6027\u80fd\u5173\u952e\u8def\u5f84/\u5e03\u5c40\u8ba1\u7b97/\u6d3e\u53d1\u89e3\u6790\uff09 \u4e0e <code>class.h</code> \u7684\u5173\u7cfb\uff1a<code>class.h</code> \u5b9a\u4e49\u5951\u7ea6\u4e0e\u5b57\u6bb5\u5e03\u5c40\uff1b\u672c\u6587\u4ef6\u7ed9\u51fa\u5927\u91cf inline/constexpr \u5b9e\u73b0\uff08\u67e5\u627e\u3001\u6d3e\u53d1\u3001\u5e03\u5c40\u8ba1\u7b97\u3001\u5b57\u6bb5\u8bbf\u95ee\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#1","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u672c\u6587\u4ef6\u201c\u771f\u6b63\u505a\u4e86\u4ec0\u4e48\u201d\uff09","text":"<p>\u672c\u6587\u4ef6\u628a <code>Class</code> \u4e0a\u6700\u6027\u80fd\u654f\u611f\u7684\u903b\u8f91\u653e\u5728 header \u5185\u8054\u5b9e\u73b0\u91cc\uff0c\u4e3b\u8981\u5305\u62ec\uff1a</p> <ul> <li>\u7c7b\u578b\u4e0e\u5e03\u5c40\uff1a<code>GetTypeSize</code>\u3001<code>GetComponentSize</code>\u3001<code>ComputeClassSize</code>\u3001<code>GetVTableOffset</code>\u3001<code>GetIMTOffset</code>\u3002</li> <li>\u7c7b\u578b\u5173\u7cfb\uff1a<code>IsSubClassOf</code>\u3001<code>IsAssignableFrom</code>\uff08\u542b union \u8bed\u4e49\uff09\u3001<code>Implements</code>\u3002</li> <li>\u5b57\u6bb5\u4e0e\u65b9\u6cd5\u67e5\u627e\uff1a\u4e8c\u5206\u641c\u7d22 + \u53ef\u53d8\u8c13\u8bcd\u8fc7\u6ee4\u3001\u6cbf\u7ee7\u627f\u94fe\u67e5\u627e\u3001\u63a5\u53e3\u65b9\u6cd5\u67e5\u627e\uff08itable\uff09\u3002</li> <li>\u6d3e\u53d1\u89e3\u6790\uff1a<code>ResolveVirtualMethod</code>\uff08vtable / IMT / ITable\uff09\u3002</li> <li>\u5b57\u6bb5\u8bbf\u95ee\uff1a\u901a\u8fc7 <code>ObjectAccessor</code> \u505a primitive/object \u7684\u8bfb\u5199\u4e0e\u539f\u5b50 RMW\uff08\u542b read/write barrier / memory_order\uff09\u3002</li> </ul> <p>\u4ea4\u53c9\u5f15\u7528\uff1a - <code>ObjectAccessor</code> \u4e0e\u5c4f\u969c/GC\uff1a<code>runtime/include/object_accessor-inl.h</code>\uff08\u8de8\u7ae0\u4f9d\u8d56 Stage2/02\uff09\u3002 - <code>ITable</code> \u7684\u7ed3\u6784\uff1a<code>runtime/include/itable.h</code>\uff0803 \u7ae0\u52a8\u6001\u7eb3\u5165\uff09\u3002 - vtable/itable \u7684\u6784\u5efa\uff1a<code>runtime/include/vtable_builder_*</code>\uff0803 \u7ae0 P0\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#2-l1l26","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L26\uff09","text":"<ul> <li>L1\u2013L14\uff1aLicense \u5934\u3002</li> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_CLASS_INL_H_</code>\u3002</li> <li>L18\uff1a\u5305\u542b <code>class.h</code>\uff0c\u83b7\u53d6 <code>Class</code> \u7684\u58f0\u660e\u4e0e\u5b57\u6bb5\u5e03\u5c40\u5951\u7ea6\u3002</li> <li>L19\uff1a<code>class_helper.h</code>\uff1a\u63d0\u4f9b <code>OBJECT_POINTER_SIZE/POINTER_SIZE</code> \u7b49\u4e0e ABI/\u5e73\u53f0\u76f8\u5173\u7684\u5e38\u91cf\u4e0e\u8f85\u52a9\u3002</li> <li>L20\uff1a<code>field.h</code>\uff1a\u5b57\u6bb5\u5143\u6570\u636e\u5728\u67e5\u627e\u4e0e\u8bbf\u95ee\u65f6\u4f7f\u7528\u3002</li> <li>L21\uff1a<code>object_header.h</code>\uff1a\u7c7b\u5bf9\u8c61\uff08managed object\uff09\u6620\u5c04\u3001\u5bf9\u8c61\u5927\u5c0f\u7b49\uff08\u8de8\u7ae0\uff1a\u5bf9\u8c61\u5934/GC\uff09\u3002</li> <li>L22\uff1a<code>coretypes/tagged_value.h</code>\uff1aTAGGED \u7c7b\u578b\u5927\u5c0f\u4e0e\u5bf9\u9f50\u5047\u8bbe\uff08ComputeClassSize \u7528\u5230\uff09\u3002</li> <li>L23\uff1a<code>object_accessor-inl.h</code>\uff1a\u5b57\u6bb5\u8bfb\u5199\u3001\u5c4f\u969c\u3001\u539f\u5b50\u64cd\u4f5c\u7684\u5b9e\u9645\u6267\u884c\u8005\uff08\u8de8\u7ae0\u5b9e\u73b0\uff09\u3002</li> <li>L25\u2013L26\uff1a<code>namespace ark {</code> \u5f00\u59cb\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#3-l27l83","title":"3. \u67e5\u627e\u57fa\u7840\u8bbe\u65bd\uff1a\u6bd4\u8f83\u5668 + \u8c13\u8bcd\u7ec4\u5408 + \u4e8c\u5206\u641c\u7d22\uff08L27\u2013L83\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#31-namecompl27l38","title":"3.1 <code>NameComp</code>\uff08L27\u2013L38\uff09","text":"<ul> <li>L27\uff1a\u6a21\u677f <code>NameComp&lt;Item&gt;</code>\uff1a\u6309 name \u6392\u5e8f/\u76f8\u7b49\u6bd4\u8f83\u3002</li> <li>L30\u2013L33\uff1a<code>equal(Item&amp;, StringData)</code>\uff1a\u5224\u65ad <code>GetName()</code> \u76f8\u7b49\uff08\u7528\u4e8e lower_bound \u540e\u7684\u201c\u540c key \u7ebf\u6027\u626b\u63cf\u201d\uff09\u3002</li> <li>L34\u2013L37\uff1a<code>operator()(Method&amp;, StringData)</code>\uff1a\u7528\u4e8e <code>lower_bound</code> \u7684\u4e25\u683c\u5f31\u5e8f\u6bd4\u8f83\uff08<code>&lt;</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#32-entityidcompl40l51","title":"3.2 <code>EntityIdComp</code>\uff08L40\u2013L51\uff09","text":"<ul> <li>L40\uff1a\u6a21\u677f <code>EntityIdComp&lt;Item&gt;</code>\uff1a\u6309 <code>EntityId offset</code> \u6392\u5e8f/\u76f8\u7b49\u6bd4\u8f83\u3002</li> <li>L43\u2013L46\uff1a<code>equal</code>\uff1a\u6bd4\u8f83 <code>GetFileId().GetOffset()</code> \u4e0e <code>id.GetOffset()</code>\u3002</li> <li>L47\u2013L50\uff1a<code>operator()</code>\uff1a\u6309 offset \u505a <code>&lt;</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#33-l53l55","title":"3.3 \u7c7b\u578b\u522b\u540d\uff08L53\u2013L55\uff09","text":"<ul> <li>L53\uff1a<code>MethodNameComp</code>\uff1a<code>NameComp&lt;Method&gt;</code>\u3002</li> <li>L54\uff1a<code>MethodIdComp</code>\uff1a<code>EntityIdComp&lt;Method&gt;</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#34-predcompl56l66","title":"3.4 <code>PredComp</code>\uff08L56\u2013L66\uff09","text":"<ul> <li>L56\u2013L60\uff1a<code>PredComp(item)</code> \u57fa\u4f8b\uff1a\u6ca1\u6709\u989d\u5916\u8c13\u8bcd\u65f6\u6052\u771f\u3002</li> <li>L62\u2013L66\uff1a\u53ef\u53d8\u53c2\u9012\u5f52\uff1a\u6240\u6709\u8c13\u8bcd\u90fd\u5fc5\u987b\u6ee1\u8db3\uff08\u77ed\u8def AND\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#35-binsearchl68l83","title":"3.5 <code>BinSearch</code>\uff08L68\u2013L83\uff09","text":"<p>\u8fd9\u662f\u6574\u4e2a\u201c\u6309 key \u4e8c\u5206 + \u540c key \u591a\u91cd\u5339\u914d\u201d\u7684\u6838\u5fc3\u6a21\u677f\uff1a - L69\u2013L71\uff1a\u5bf9 <code>Span&lt;Item&gt;</code> \u505a <code>lower_bound</code>\uff0c\u5b9a\u4f4d\u5230\u7b2c\u4e00\u4e2a\u4e0d\u5c0f\u4e8e key \u7684\u4f4d\u7f6e\u3002 - L72\u2013L81\uff1a\u4ece\u8be5\u4f4d\u7f6e\u5411\u540e\u7ebf\u6027\u626b\u63cf\uff1a   - L74\u2013L76\uff1a\u4e00\u65e6 key \u4e0d\u518d\u76f8\u7b49\u5c31\u9000\u51fa\uff08\u56e0\u4e3a\u540c key \u8fde\u7eed\uff09\u3002   - L77\u2013L79\uff1a\u82e5\u8c13\u8bcd\u5168\u901a\u8fc7\u5219\u8fd4\u56de item \u5730\u5740\u3002 - L82\uff1a\u627e\u4e0d\u5230\u8fd4\u56de <code>nullptr</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#4-l85l120","title":"4. \u7c7b\u578b\u5927\u5c0f\u4e0e\u6570\u7ec4\u5143\u7d20\u5927\u5c0f\uff08L85\u2013L120\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#41-classgettypesizel85l111","title":"4.1 <code>Class::GetTypeSize</code>\uff08L85\u2013L111\uff09","text":"<ul> <li>L86\uff1ainline \u5b9e\u73b0\uff08perf critical\uff09\u3002</li> <li>L88\u2013L110\uff1a\u6309 <code>TypeId</code> switch\uff1a</li> <li>U1/I8/U8 \u2192 1 \u5b57\u8282</li> <li>I16/U16 \u2192 2 \u5b57\u8282</li> <li>I32/U32/F32 \u2192 4 \u5b57\u8282</li> <li>I64/U64/F64 \u2192 8 \u5b57\u8282</li> <li>TAGGED \u2192 <code>TaggedValue::TaggedTypeSize()</code>\uff08\u8981\u6c42\u4e3a 8\uff0c\u89c1\u540e\u9762 static_assert\uff09</li> <li>REFERENCE \u2192 <code>ClassHelper::OBJECT_POINTER_SIZE</code>\uff08\u4e0e\u538b\u7f29\u6307\u9488\u76f8\u5173\uff09</li> <li>default \u2192 <code>UNREACHABLE()</code>\uff08\u7c7b\u578b id \u4e0d\u5e94\u51fa\u73b0\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#42-classgetcomponentsizel113l120","title":"4.2 <code>Class::GetComponentSize</code>\uff08L113\u2013L120\uff09","text":"<ul> <li>L115\u2013L117\uff1a\u975e\u6570\u7ec4\u7c7b <code>componentType_ == nullptr</code> \u2192 0\u3002</li> <li>L119\uff1a\u6570\u7ec4\u7c7b\u8fd4\u56de componentType \u7684 <code>GetType()</code> \u5bf9\u5e94 size\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#5-unionl122l237","title":"5. \u7c7b\u578b\u5173\u7cfb\uff08\u7ee7\u627f/\u8d4b\u503c\u517c\u5bb9/union\uff09\uff08L122\u2013L237\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#51-isclassclassl122l125","title":"5.1 <code>IsClassClass</code>\uff08L122\u2013L125\uff09","text":"<ul> <li>L124\uff1a\u901a\u8fc7 <code>GetManagedObject()-&gt;ClassAddr&lt;Class&gt;() == this</code> \u5224\u65ad\uff1amanaged \u4fa7 ClassObject \u7684\u201c\u7c7b\u5730\u5740\u201d\u662f\u5426\u6307\u56de\u5f53\u524d <code>Class*</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#52-issubclassofl127l140","title":"5.2 <code>IsSubClassOf</code>\uff08L127\u2013L140\uff09","text":"<ul> <li>L129\u2013L137\uff1a\u4ece <code>this</code> \u6cbf <code>GetBase()</code> \u7ebf\u6027\u4e0a\u6eaf\uff0c\u9047\u5230\u76ee\u6807 <code>klass</code> \u8fd4\u56de true\u3002</li> <li>L139\uff1a\u8d70\u5230\u9876\u4ecd\u672a\u547d\u4e2d \u2192 false\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#53-assignableunionref-l142l237","title":"5.3 Assignable\uff1aunion/ref \u7684\u62c6\u5206\uff08L142\u2013L237\uff09","text":"<p>\u8fd9\u90e8\u5206\u662f CheckCast/IsInstance/\u7c7b\u578b\u68c0\u67e5\u5feb\u8def\u5f84\u7684\u201c\u57fa\u7840\u8bed\u4e49\u201d\u3002</p> <ul> <li>L142\u2013L145\uff1a\u524d\u7f6e\u58f0\u660e\uff1a<code>IsAssignableFromUnion</code>\u3001<code>IsAssignableFromRef</code>\uff08\u6a21\u677f\u53c2\u6570\u63a7\u5236\u662f\u5426\u5141\u8bb8 super \u94fe\u904d\u5386\uff09\u3002</li> <li>L146\u2013L174\uff1a<code>IsAssignableFromUnionImpl&lt;IS_STRICT, IS_UNION_SUPER&gt;</code>\uff1a</li> <li>L151\u2013L156\uff1a\u5185\u90e8 <code>isAssignable</code> lambda\uff1a\u5982\u679c\u4e24\u4fa7\u4efb\u610f\u4e00\u4fa7\u4e3a union \u2192 \u9012\u5f52 union \u8bed\u4e49\uff0c\u5426\u5219\u8d70 <code>IsAssignableFromRef&lt;true&gt;</code>\uff08\u5b8c\u6574\u8bed\u4e49\uff09\u3002</li> <li>L157\u2013L173\uff1a\u904d\u5386 union constituent types\uff1a<ul> <li><code>IS_UNION_SUPER</code> \u4e3a true\uff1a\u68c0\u67e5 \u201cconsClass \u662f\u5426\u80fd\u8d4b\u503c\u7ed9 ref\u201d\uff08super=consClass\uff09</li> <li>\u5426\u5219\uff1a\u68c0\u67e5 \u201cref \u662f\u5426\u80fd\u8d4b\u503c\u7ed9 consClass\u201d\uff08super=ref\uff09</li> <li><code>IS_STRICT</code> \u4e3a true\uff1a\u4efb\u4e00\u4e0d\u6ee1\u8db3\u5219\u7acb\u523b false\uff1b\u5426\u5219 OR \u805a\u5408\u3002</li> </ul> </li> <li>L177\u2013L193\uff1a<code>IsAssignableFromUnion(sub, super)</code>\uff1a</li> <li>super \u975e union\uff1a\u8f6c\u4e3a <code>IsAssignableFromUnionImpl&lt;true,false&gt;(super, sub)</code>\uff08\u4e25\u683c\uff09\u3002</li> <li>sub \u975e union\uff1a\u8f6c\u4e3a <code>IsAssignableFromUnionImpl&lt;false,true&gt;(sub, super)</code>\uff08\u975e\u4e25\u683c\uff09\u3002</li> <li>\u53cc\u65b9\u90fd\u662f union\uff1a\u904d\u5386 sub \u7684 constituent\uff0c\u4efb\u4e00\u80fd\u4e25\u683c\u8d4b\u503c\u5230 super \u5219 true\uff1b\u5426\u5219\u4ecd\u8fd4\u56de true\uff08\u8be5\u5206\u652f\u7684\u6700\u7ec8\u8bed\u4e49\u9700\u8981\u7ed3\u5408\u4e0a\u5c42\u4f7f\u7528\u70b9\u590d\u6838\uff09\u3002</li> <li>L195\u2013L216\uff1a<code>IsAssignableFromRef&lt;ALLOW_SUPER_TRAVERSAL&gt;</code>\uff1a</li> <li>\u76f8\u540c\u6307\u9488 \u2192 true\u3002</li> <li>super \u662f Object \u6839\u7c7b \u2192 sub \u53ea\u8981\u4e0d\u662f primitive \u5373\u53ef\u3002</li> <li>super \u662f interface \u2192 sub-&gt;Implements(super)\u3002</li> <li>sub \u662f array \u2192 \u8981\u6c42 super \u4e5f\u662f array \u4e14 component \u53ef\u8d4b\u503c\u3002</li> <li>\u5426\u5219\uff1a<ul> <li><code>ALLOW_SUPER_TRAVERSAL=true</code>\uff1a\u8981\u6c42 sub \u975e interface \u4e14\u6cbf\u7236\u7c7b\u94fe\u662f\u5b50\u7c7b\u3002</li> <li><code>ALLOW_SUPER_TRAVERSAL=false</code>\uff1a\u76f4\u63a5 false\uff08\u7528\u4e8e <code>IsAssignableFromRefNoSuper</code> \u7684\u6162\u8def\u5f84\u5951\u7ea6\uff09\u3002</li> </ul> </li> <li>L219\u2013L228\uff1a<code>Class::IsAssignableFrom(klass)</code>\uff1a</li> <li>\u5feb\u901f\u7b49\u4ef7\u5224\u65ad</li> <li>union \u4efb\u4e00\u4fa7\u4e3a union \u2192 union \u8bed\u4e49</li> <li>\u5426\u5219 ref \u5b8c\u6574\u8bed\u4e49\uff08\u5141\u8bb8 super traversal\uff09</li> <li>L230\u2013L237\uff1a<code>IsAssignableFromRefNoSuper</code>\uff1a</li> <li>union\uff1a\u4ecd\u8d70\u5b8c\u6574 union\uff08\u6ce8\u91ca\u8bf4\u660e correctness\uff09</li> <li>\u5426\u5219 ref \u8bed\u4e49\u7981\u7528 super traversal\uff08\u914d\u5408 entrypoint fast path \u7684\u201c\u5df2\u904d\u5386\u7236\u7c7b\u94fe\u201d\u524d\u7f6e\u6761\u4ef6\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#6-itablel239l248","title":"6. \u63a5\u53e3\u5b9e\u73b0\u4e0e itable\uff08L239\u2013L248\uff09","text":"<ul> <li>L241\u2013L245\uff1a\u904d\u5386 <code>itable_.Get()</code> \u7684\u6bcf\u4e2a entry\uff0c\u6bd4\u8f83 <code>GetInterface()</code> \u662f\u5426\u7b49\u4e8e\u76ee\u6807\u63a5\u53e3\u3002</li> <li>L247\uff1a\u672a\u547d\u4e2d\u8fd4\u56de false\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#7-l250l348-name","title":"7. \u5b57\u6bb5\u67e5\u627e\uff08L250\u2013L348\uff0c\u53ca\u540e\u7eed\u6309 name \u5c01\u88c5\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#71-getfieldsfilterl250l263","title":"7.1 <code>GetFields&lt;FILTER&gt;</code>\uff08L250\u2013L263\uff09","text":"<ul> <li>STATIC \u2192 <code>GetStaticFields()</code>\uff1bINSTANCE \u2192 <code>GetInstanceFields()</code>\uff1bALL \u2192 <code>GetFields()</code>\uff1b\u5426\u5219 unreachable\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#72-finddeclaredfieldpredl265l274","title":"7.2 <code>FindDeclaredField(Pred)</code>\uff08L265\u2013L274\uff09","text":"<ul> <li>\u5bf9\u9009\u5b9a\u5b57\u6bb5 span \u505a <code>find_if</code>\uff0c\u547d\u4e2d\u8fd4\u56de\u5730\u5740\uff0c\u5426\u5219 nullptr\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#73-binarysearchfieldl276l284","title":"7.3 <code>BinarySearchField</code>\uff08L276\u2013L284\uff09","text":"<ul> <li>\u5bf9\u6309 <code>FieldId</code> \u6392\u5e8f\u7684 span \u505a <code>lower_bound</code>\uff0c\u5e76\u989d\u5916\u68c0\u67e5\u76f8\u7b49\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#74-finddeclaredfieldentityidl286l310","title":"7.4 <code>FindDeclaredField(EntityId)</code>\uff08L286\u2013L310\uff09","text":"<ul> <li>FILTER=ALL\uff1a\u5148\u5728 staticFields \u4e8c\u5206\uff0c\u518d\u5728 instanceFields \u4e8c\u5206\u3002</li> <li>\u5426\u5219\uff1a\u53ea\u5728\u5bf9\u5e94\u5b57\u6bb5\u96c6\u5408\u4e8c\u5206\u3002</li> <li>\u627e\u4e0d\u5230 \u2192 nullptr\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#75-findfieldininterfaces-findfieldl312l348","title":"7.5 <code>FindFieldInInterfaces / FindField</code>\uff08L312\u2013L348\uff09","text":"<ul> <li>FindFieldInInterfaces\uff1a\u6cbf <code>kls</code> \u7684\u7ee7\u627f\u94fe\uff0c\u679a\u4e3e\u6bcf\u4e2a\u7c7b\u7684 interfaces\uff0c\u5bf9\u6bcf\u4e2a iface \u9012\u5f52 <code>iface-&gt;FindField</code>\u3002</li> <li>FindField\uff1a\u5148\u6cbf superclass \u94fe\u505a declared \u67e5\u627e\uff1b\u82e5\u672a\u547d\u4e2d\u4e14 FILTER \u662f STATIC/ALL\uff0c\u624d\u53bb interfaces \u67e5\uff08\u7b26\u5408\u201c\u5b9e\u4f8b\u5b57\u6bb5\u4e0d\u4ece\u63a5\u53e3\u7ee7\u627f\u201d\u7684\u8bed\u4e49\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#8-l350l456-wrapper","title":"8. \u65b9\u6cd5\u96c6\u5408\u4e0e\u65b9\u6cd5\u67e5\u627e\uff08L350\u2013L456\uff0c\u53ca\u540e\u7eed wrapper\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#81-getmethodsfilterl350l366","title":"8.1 <code>GetMethods&lt;FILTER&gt;</code>\uff08L350\u2013L366\uff09","text":"<ul> <li>STATIC \u2192 <code>GetStaticMethods()</code>\uff1bINSTANCE \u2192 <code>GetVirtualMethods()</code>\uff1bALL \u2192 <code>GetMethods()</code>\uff1bCOPIED \u2192 <code>GetCopiedMethods()</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#82-finddirectmethodl368l403","title":"8.2 <code>FindDirectMethod</code>\uff08L368\u2013L403\uff09","text":"<ul> <li>FILTER=ALL/STATIC\uff1a\u5148\u5728 static methods \u4e0a\u7528 <code>BinSearch</code>\u3002</li> <li>FILTER=ALL/INSTANCE\uff1a\u518d\u5728 virtual methods \u4e0a\u7528 <code>BinSearch</code>\u3002</li> <li>FILTER=COPIED\uff1acopied methods \u201c\u6765\u81ea\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u4e14\u65e0\u5e8f\u201d\uff0c\u56e0\u6b64\u9000\u5316\u4e3a\u7ebf\u6027\u626b\u63cf\u5e76\u505a key+pred \u68c0\u67e5\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#83-findclassmethodl405l423","title":"8.3 <code>FindClassMethod</code>\uff08L405\u2013L423\uff09","text":"<ul> <li>\u6cbf <code>GetBase()</code> \u4e0a\u6eaf\uff0c\u6bcf\u5c42\u5bf9 <code>FindDirectMethod</code> \u67e5\u627e\u3002</li> <li>\u82e5 FILTER=ALL/INSTANCE\uff1a\u989d\u5916\u67e5 copied methods\uff08\u628a\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u4e5f\u7eb3\u5165\u201c\u7c7b\u65b9\u6cd5\u201d\u7684\u53ef\u89c1\u96c6\u5408\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#84-findinterfacemethodl425l456","title":"8.4 <code>FindInterfaceMethod</code>\uff08L425\u2013L456\uff09","text":"<ul> <li>\u9759\u6001\u65ad\u8a00\uff1a\u63a5\u53e3\u4e0d\u5e94\u8be5\u6709 copied methods\u3002</li> <li>\u82e5 <code>this</code> \u672c\u8eab\u662f interface\uff1a</li> <li>\u5148\u5728\u81ea\u8eab direct methods \u4e2d\u627e\uff08FILTER \u6307\u5b9a static/instance/all\uff09\u3002</li> <li>\u82e5 FILTER=STATIC\uff1a\u76f4\u63a5\u8fd4\u56de nullptr\uff08\u201c\u4ece itable \u89e3\u6790\u63a5\u53e3\u9759\u6001\u65b9\u6cd5\u201d\u8bed\u4e49\u4e0a\u4e0d\u6210\u7acb\uff09\u3002</li> <li>\u5426\u5219\u904d\u5386 <code>itable_</code>\uff1a</li> <li>\u5bf9\u6bcf\u4e2a entry \u7684 interface\uff0c\u67e5\u5176 instance direct methods\u3002</li> <li>\u82e5 <code>this</code> \u662f interface\uff1a\u6700\u540e\u56de\u9000\u5230 <code>GetBase()</code> \u91cc\u67e5 public \u7684 instance \u65b9\u6cd5\uff08\u6ce8\u610f\u8c13\u8bcd\uff1a\u5f3a\u5236 <code>method.IsPublic()</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#9-api-l458l706","title":"9. \u7531\u58f0\u660e\u5230\u4fbf\u6377 API \u7684\u5c01\u88c5\uff08\u7ea6 L458\u2013L706\uff0c\u5206\u5e03\u5728\u6587\u4ef6\u4e2d\u6bb5\uff09","text":"<p>\u8fd9\u4e00\u6bb5\u4e3b\u8981\u628a <code>class.h</code> \u91cc\u58f0\u660e\u7684 <code>Get*ByName/Get*ById</code> \u7b49\u5c01\u88c5\u4e3a\u5bf9 <code>Find*</code> \u7684\u8c03\u7528\uff1a - Field\uff1a\u628a <code>mutf8Name</code> \u8f6c <code>StringData</code>\uff0c\u518d <code>Find*Field</code>\u3002 - Method\uff1a\u6309 <code>FindFilter</code>\uff08STATIC/INSTANCE/ALL\uff09+ <code>KeyComp</code>\uff08Name/EntityId\uff09+ <code>Proto</code> \u8c13\u8bcd\u7ec4\u5408\u67e5\u627e\u3002</p> <p>\uff08\u8fd9\u4e00\u6bb5\u4ee3\u7801\u884c\u6570\u5f88\u591a\u4f46\u8bed\u4e49\u91cd\u590d\uff1a\u6784\u9020 key + \u8c03 Find* + \u8fd4\u56de\u6307\u9488\u3002\u9010\u884c\u7b14\u8bb0\u65f6\u4f1a\u6309\u201c\u51fd\u6570\u5757\u201d\u8986\u76d6\u3002\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#10-resolvevirtualmethodl708l748","title":"10. \u6d3e\u53d1\u89e3\u6790\uff1a<code>ResolveVirtualMethod</code>\uff08L708\u2013L748\uff09","text":"<p>\u5173\u952e\u8bed\u4e49\uff1a\u5728\u975e\u63a5\u53e3\u7c7b\u4e0a\uff0c\u89e3\u6790\u4e00\u4e2a <code>Method*</code>\uff08\u53ef\u80fd\u6765\u81ea\u63a5\u53e3\uff09\u5728\u5f53\u524d\u7c7b\u7684\u5b9e\u9645\u6d3e\u53d1\u76ee\u6807\u3002</p> <ul> <li>L713\uff1a\u65ad\u8a00\u5f53\u524d\u7c7b\u4e0d\u662f interface\u3002</li> <li>L715\u2013L739\uff1a\u5f53\u88ab\u89e3\u6790\u7684 method \u5c5e\u4e8e interface \u4e14\u4e0d\u662f\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\uff1a</li> <li>\u5148\u5c1d\u8bd5 IMT\uff08\u82e5 imtSize != 0\uff09\uff1a<code>GetIMTableIndex(methodIdOffset)</code> \u53d6\u69fd\uff1b\u975e\u7a7a\u5219\u76f4\u63a5\u8fd4\u56de\u3002</li> <li>\u5426\u5219\u626b\u63cf itable\uff1a\u5339\u914d entry.GetInterface()\uff0c\u518d\u6309 <code>method-&gt;GetVTableIndex()</code> \u4ece entry.GetMethods() \u53d6\u76ee\u6807\u3002</li> <li>L739\u2013L745\uff1a\u5426\u5219\u8d70 vtable\uff1a\u7528 <code>method-&gt;GetVTableIndex()</code> \u76f4\u63a5\u7d22\u5f15 vtable\u3002</li> <li>\u8fd4\u56de resolved\uff08\u53ef\u80fd\u4e3a nullptr\uff0c\u53d6\u51b3\u4e8e itable \u662f\u5426\u547d\u4e2d\uff09\u3002</li> </ul> <p>\u4ea4\u53c9\u5f15\u7528\uff1a<code>GetIMTableIndex/IMT \u51b2\u7a81\u89e3\u51b3/\u9ed8\u8ba4\u65b9\u6cd5 copied</code> \u7684\u6784\u5efa\u903b\u8f91\u5728 vtable builder\uff0803 \u7ae0 P0\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#11-class-computeclasssizevtableoffsetimtoffsetl750l824","title":"11. Class \u5bf9\u8c61\u5c3e\u90e8\u5e03\u5c40\uff1aComputeClassSize/VTableOffset/IMTOffset\uff08L750\u2013L824\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#111-computeclasssizel750l796","title":"11.1 <code>ComputeClassSize</code>\uff08L750\u2013L796\uff09","text":"<p>\u8fd9\u662f <code>class.h::ComputeClassSize</code> \u7684 constexpr \u5b9e\u73b0\uff0c\u5b9a\u4e49\u4e86 <code>Class</code> \u5bf9\u8c61\u7684\u201c\u5c3e\u90e8\u6269\u5c55\u533a\u201d\u5e03\u5c40\u4e0e\u5bf9\u9f50\u7b56\u7565\uff1a</p> <ul> <li>\u4ece <code>sizeof(Class)</code> \u5f00\u59cb\uff0c\u5148\u6309 <code>OBJECT_POINTER_SIZE</code> \u5bf9\u9f50\u3002</li> <li>\u7d2f\u52a0\uff1a</li> <li>vtable\uff08<code>vtableSize * POINTER_SIZE</code>\uff09</li> <li>imt\uff08<code>imtSize * POINTER_SIZE</code>\uff09</li> <li>\u9759\u6001\u5f15\u7528\u5b57\u6bb5\uff08<code>numRefSfields * OBJECT_POINTER_SIZE</code>\uff09</li> <li>\u7136\u540e\u5c1d\u8bd5\u7528\u8f83\u5c0f\u5c3a\u5bf8\u5b57\u6bb5\u586b\u5145\u5bf9\u9f50\u7a7a\u6d1e\uff08Pad \u903b\u8f91\uff09\uff1a</li> <li>\u5148\u5904\u7406 64-bit \u5bf9\u9f50\u7a7a\u6d1e\uff1a\u4f18\u5148\u6263\u6389 32/16/8 \u7684\u5b57\u6bb5\u8ba1\u6570</li> <li>\u518d\u5904\u7406 32-bit\u300116-bit \u7684\u5bf9\u9f50\u7a7a\u6d1e</li> <li>\u6700\u540e\u628a\u5269\u4f59\u5404\u5c3a\u5bf8\u9759\u6001\u5b57\u6bb5\u4e0e tagged \u5b57\u6bb5\u7684 payload size \u52a0\u4e0a\u3002</li> </ul> <p>\u8fd9\u6bb5\u903b\u8f91\u51b3\u5b9a\uff1a - <code>GetVTableOffset()</code> \u7684\u503c\uff08\u5373\u201c\u6269\u5c55\u533a\u8d77\u70b9\u201d\uff09 - <code>GetStaticFieldsOffset()</code> \u7684\u503c\uff08\u5728 vtable/imt \u4e4b\u540e\uff09 - GC/\u53cd\u5c04/\u7c7b\u5bf9\u8c61\u5e03\u5c40\u4e0e offset \u7684\u4e00\u81f4\u6027</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#112-padl798l804","title":"11.2 <code>Pad</code>\uff08L798\u2013L804\uff09","text":"<p>\u5728 padding \u7a7a\u6d1e\u8db3\u591f\u5927\u4e14\u8fd8\u6709\u5b57\u6bb5\u53ef\u7528\u65f6\uff0c\u51cf\u5c11 padding \u4e0e\u5b57\u6bb5\u6570\uff08\u201c\u7528\u5b57\u6bb5\u586b\u6d1e\u201d\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#113-getvtableoffsetl806l809","title":"11.3 <code>GetVTableOffset</code>\uff08L806\u2013L809\uff09","text":"<ul> <li>\u76f4\u63a5\u8fd4\u56de <code>ComputeClassSize(0,0,0,...)</code>\uff1a\u5373\u53ea\u6709 <code>sizeof(Class)</code> + \u5bf9\u9f50\u540e\u7684\u8d77\u70b9\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#114-getvtablegetimtoffsetl811l824","title":"11.4 <code>GetVTable()/GetIMTOffset</code>\uff08L811\u2013L824\uff09","text":"<ul> <li><code>GetVTable()</code>\uff1a\u5728 <code>GetClassSpan()</code> \u4e0a\u4ece <code>GetVTableOffset()</code> \u8d77\u53d6 <code>vtableSize_</code> \u4e2a <code>Method*</code>\u3002</li> <li><code>GetIMTOffset()</code>\uff1a\u7d27\u8ddf vtable\uff1a<code>GetVTableOffset() + vtableSize_ * sizeof(uintptr_t)</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#12-class-managed-object-objectaccessorl826l1023","title":"12. \u5b57\u6bb5\u8bbf\u95ee\uff1a\u628a <code>Class*</code> \u6620\u5c04\u5230 managed object \u5e76\u8c03\u7528 ObjectAccessor\uff08L826\u2013L1023\uff09","text":"<p>\u8fd9\u91cc\u5b9e\u73b0\u4e86 <code>class.h</code> \u58f0\u660e\u7684\u5404\u79cd <code>Get/Set/CAS/RMW</code>\uff1a</p> <ul> <li>primitive\uff1a\u76f4\u63a5 <code>ObjectAccessor::Get/SetFieldPrimitive</code>\u3002</li> <li>object\uff1a\u5173\u952e\u70b9\u5728\u4e8e Class \u7684\u5b57\u6bb5\u5b9e\u9645\u4e0a\u5b58\u50a8\u5728 managed ClassObject \u91cc\uff1a</li> <li>L856\u2013L860 \u7b49\u5904\uff1a\u5148\u53d6 <code>auto object = GetManagedObject()</code>\uff0c\u65ad\u8a00 <code>object &lt; this &lt; object+ObjectSize()</code>\uff08\u4fdd\u8bc1 <code>this</code> \u6307\u9488\u4f4d\u4e8e managed object \u7684\u5730\u5740\u8303\u56f4\u5185\uff09\u3002</li> <li>\u628a <code>Class*</code> \u7684 offset \u8f6c\u6210 \u201c\u76f8\u5bf9 managed object \u7684 offset\u201d\uff1a<code>offset + (this - object)</code>\u3002</li> <li>\u518d\u5bf9 managed object \u8fdb\u884c\u771f\u6b63\u7684\u8bfb\u5199/\u5c4f\u969c/\u539f\u5b50\u64cd\u4f5c\u3002</li> </ul> <p>\u5e76\u4e14\uff1a - \u5bf9 volatile \u5b57\u6bb5\u4f1a\u9009\u62e9 <code>ObjectAccessor::SetObject&lt;true,...&gt;</code> \u5206\u652f\u3002 - \u5bf9 class state \u505a\u65ad\u8a00\uff1a<code>IsInitializing/IsInitialized/IsErroneous</code>\uff08\u6ce8\u91ca\u8bf4\u660e GC \u53ef\u80fd\u8df3\u8fc7 Erroneous classes\uff1b\u907f\u514d\u6602\u8d35\u7684\u539f\u5b50\u5316 state+field \u68c0\u67e5\uff09\u3002</p> <p>\u8de8\u7ae0\u8df3\u8f6c\uff1a<code>ObjectAccessor</code> \u7684 read/write barrier\u3001\u539f\u5b50\u8bed\u4e49\u3001\u5bf9\u8c61\u6a21\u578b\u7ec6\u8282\u5728 Stage2/02\uff08Memory\uff09\u9010\u884c\u89e3\u91ca\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#13-l1025l1028","title":"13. \u6587\u4ef6\u5c3e\uff08L1025\u2013L1028\uff09","text":"<ul> <li>L1025\uff1a\u7ed3\u675f\u547d\u540d\u7a7a\u95f4\u3002</li> <li>L1027\u2013L1028\uff1a\u7ed3\u675f include guard\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class-inl.h/#14","title":"14. \u52a8\u6001\u7eb3\u5165\u5019\u9009\uff08\u540c\u7ae0\u5f3a\u76f8\u5173\uff09","text":"<p>\u7531\u672c\u6587\u4ef6 <code>#include</code> \u4e0e\u8bed\u4e49\u8026\u5408\u53ef\u5224\u5b9a\u4e3a 03 \u7ae0\u5f3a\u76f8\u5173\uff08\u5c06\u8ffd\u52a0\u5230 <code>03_ClassLoading/Manifests/files.yaml</code>\uff09\uff1a - <code>runtime/include/class_helper.h</code>\uff08\u5e03\u5c40/\u5bf9\u9f50\u5e38\u91cf\uff09 - <code>runtime/include/field.h</code>\u3001<code>runtime/include/method.h</code>\u3001<code>runtime/include/itable.h</code></p> <p>\u8de8\u7ae0\u4f46\u5f3a\u4f9d\u8d56\uff08\u672c\u7ae0\u53ea\u505a\u4f9d\u8d56\u8bf4\u660e\u4e0e\u8df3\u8f6c\uff0c\u4e0d\u91cd\u590d\u9010\u884c\uff09\uff1a - <code>runtime/include/object_header.h</code> - <code>runtime/include/object_accessor-inl.h</code></p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/","title":"<code>runtime/include/class.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u6838\u5fc3\u8fd0\u884c\u65f6\u5143\u6570\u636e\u5934\u6587\u4ef6\uff08Class / Method / Field \u7684\u201c\u7c7b\u89c6\u89d2\u805a\u5408\u201d\uff09 \u9010\u884c\u7b56\u7565\uff1a\u6309\u884c\u53f7\u6bb5\u8986\u76d6\u5230\u6bcf\u4e00\u884c\uff1b\u5bf9\u201c\u58f0\u660e\u5217\u8868/\u6837\u677f\u4ee3\u7801/\u7a7a\u884c\u201d\u91c7\u7528\u201c\u9010\u884c\u7b49\u4ef7\u8bf4\u660e\u201d\uff08\u660e\u786e\u8986\u76d6\u7684\u6bcf\u4e00\u884c\u5c5e\u4e8e\u54ea\u7c7b\u8bed\u4e49\uff09\uff0c\u5bf9\u5173\u952e\u7b97\u6cd5/\u5173\u952e\u4e0d\u53d8\u91cf\u7ed9\u51fa\u66f4\u7ec6\u7c92\u5ea6\u89e3\u91ca\u4e0e\u4ea4\u53c9\u5f15\u7528\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#1-classloading","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u4e3a\u4ec0\u4e48\u5b83\u5c5e\u4e8e ClassLoading \u7ae0\u8282\uff09","text":"<p><code>Class</code> \u662f\u8fd0\u884c\u65f6\u201c\u7c7b\u5143\u6570\u636e\u5bf9\u8c61\u201d\uff0c\u5728 ClassLinker \u5b8c\u6210\u89e3\u6790/\u94fe\u63a5/\u521d\u59cb\u5316\u540e\u88ab\u5404\u5b50\u7cfb\u7edf\u6d88\u8d39\uff08\u89e3\u91ca\u5668\u3001AOT/JIT\u3001\u53cd\u5c04/\u9a8c\u8bc1\u3001\u5bf9\u8c61\u5206\u914d\u4e0e\u5e03\u5c40\u8ba1\u7b97\u7b49\uff09\u3002\u672c\u6587\u4ef6\u540c\u65f6\u627f\u8f7d\uff1a</p> <ul> <li>\u7c7b\u72b6\u6001\u673a\uff1a<code>Class::State</code>\uff08\u52a0\u8f7d/\u9a8c\u8bc1/\u521d\u59cb\u5316/\u9519\u8bef/\u5df2\u521d\u59cb\u5316\uff09\u3002</li> <li>\u65b9\u6cd5\u4e0e\u5b57\u6bb5\u7684\u201c\u7c7b\u7ea7\u805a\u5408\u89c6\u56fe\u201d\uff1a<code>methods_ / fields_ / ifaces_</code> \u4ee5\u53ca\u6309\u8fc7\u6ee4\u5668\u67e5\u627e\u65b9\u6cd5/\u5b57\u6bb5\u7684\u58f0\u660e\uff08\u5b9e\u73b0\u5927\u591a\u5728 <code>class-inl.h</code> / <code>class.cpp</code>\uff09\u3002</li> <li>\u6d3e\u53d1\u76f8\u5173\u7ed3\u6784\uff1a<code>VTable</code>\uff08\u865a\u8868\uff09\u4e0e <code>IMT</code>\uff08Interface Method Table\uff09\u4e0e <code>ITable</code>\uff08\u63a5\u53e3\u8868\u5165\u53e3\uff0c\u5177\u4f53\u7ed3\u6784\u5728 <code>runtime/include/itable.h</code>\uff09\u3002</li> <li>\u5bf9\u8c61\u5e03\u5c40\u76f8\u5173\u7d22\u5f15\u4fe1\u606f\uff1a\u5f15\u7528\u5b57\u6bb5\u6570/\u504f\u79fb\u3001\u9759\u6001/\u5b9e\u4f8b\u5f15\u7528\u5b57\u6bb5\u7edf\u8ba1\uff0c\u7528\u4e8e GC/\u5199\u5c4f\u969c/\u5feb\u901f\u8def\u5f84\uff08\u5177\u4f53\u5b9e\u73b0\u4f9d\u8d56 Memory \u6a21\u5757\uff1b\u672c\u7ae0\u4ec5\u8bb0\u5f55\u4f9d\u8d56\u70b9\uff09\u3002</li> </ul> <p>\u4ea4\u53c9\u5f15\u7528\uff1a - \u865a\u8868/\u9ed8\u8ba4\u65b9\u6cd5\u51b2\u7a81\u5904\u7406\uff1a<code>runtime/include/vtable_builder_base.h</code>\u3001<code>runtime/include/vtable_builder_variance-inl.h</code>\uff08\u672c\u7ae0 P0 \u9010\u884c\uff09\u3002 - \u65b9\u6cd5/\u5b57\u6bb5\u5bf9\u8c61\u672c\u4f53\uff1a<code>runtime/include/method.h</code>\u3001<code>runtime/include/field.h</code>\uff08\u672c\u7ae0\u4f1a\u52a8\u6001\u7eb3\u5165\u9010\u884c\uff09\u3002 - \u5bf9\u8c61\u5934/\u5c4f\u969c\u7ec6\u8282\uff08\u8de8\u7ae0\uff09\uff1a<code>runtime/object_header*</code>\u3001<code>runtime/mem/*</code>\uff08Stage2/02\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#2-l1l36","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L36\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#l1l14license","title":"L1\u2013L14\uff1aLicense \u5934","text":"<ul> <li>L1\u2013L14\uff1aApache 2.0 \u8bb8\u53ef\u58f0\u660e\uff1b\u4e0d\u5f71\u54cd\u7f16\u8bd1\u8bed\u4e49\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#l15l16include-guard","title":"L15\u2013L16\uff1ainclude guard","text":"<ul> <li>L15\uff1a<code>#ifndef PANDA_RUNTIME_CLASS_H_</code> \u9632\u6b62\u91cd\u590d\u5305\u542b\u3002</li> <li>L16\uff1a<code>#define PANDA_RUNTIME_CLASS_H_</code> \u4e0e L15 \u6210\u5bf9\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#l18l29","title":"L18\u2013L29\uff1a\u7cfb\u7edf/\u9879\u76ee\u4f9d\u8d56","text":"<ul> <li>L18\uff1a<code>securec.h</code>\uff08\u5b89\u5168 C \u5e93\u63a5\u53e3\uff0c\u5e38\u7528\u4e8e <code>memcpy_s/strcpy_s</code> \u7b49\uff1b\u672c\u6587\u4ef6\u540e\u7eed\u53ef\u80fd\u5728\u5b9e\u73b0\u5904\u4f7f\u7528\uff09\u3002</li> <li>L19\uff1a<code>&lt;atomic&gt;</code>\uff1a<code>std::atomic&lt;State&gt;</code>\u3001<code>std::atomic&lt;UniqId&gt;</code> \u7b49\u3002</li> <li>L20\uff1a<code>&lt;cstdint&gt;</code>\uff1a\u56fa\u5b9a\u5bbd\u5ea6\u6574\u6570\u7c7b\u578b\u3002</li> <li>L21\uff1a<code>&lt;iostream&gt;</code>\uff1a<code>DumpClass(std::ostream&amp;, ...)</code> \u4e0e <code>operator&lt;&lt;</code> \u58f0\u660e\u3002</li> <li>L22\uff1a<code>&lt;memory&gt;</code>\uff1a\u53ef\u80fd\u4e3a\u540e\u7eed\u5b9e\u73b0\u63d0\u4f9b\u667a\u80fd\u6307\u9488\uff08\u672c\u6587\u4ef6\u4e2d\u4e3b\u8981\u4e3a\u524d\u5411/\u58f0\u660e\u4fdd\u7559\uff09\u3002</li> <li>L24\u2013L25\uff1a<code>libarkfile/file.h</code> / <code>file_items.h</code>\uff1a\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5\u5728 panda_file \u4e2d\u7684 <code>EntityId</code>\u3001<code>StringData</code> \u7b49\u3002</li> <li>L26\uff1a<code>runtime/include/field.h</code>\uff1a\u5b57\u6bb5\u5143\u6570\u636e <code>Field</code> \u7c7b\u578b\u3002</li> <li>L27\uff1a<code>runtime/include/itable.h</code>\uff1a\u63a5\u53e3\u8868 <code>ITable</code> \u4e0e\u63a5\u53e3\u6d3e\u53d1\u76f8\u5173\u7ed3\u6784\u3002</li> <li>L28\uff1a<code>runtime/include/method.h</code>\uff1a\u65b9\u6cd5\u5143\u6570\u636e <code>Method</code> \u7c7b\u578b\uff08\u542b <code>ProtoId/Proto</code>\uff09\u3002</li> <li>L29\uff1a<code>libarkbase/macros.h</code>\uff1a<code>PANDA_PUBLIC_API</code>\u3001<code>ASSERT</code>\u3001<code>MEMBER_OFFSET</code>\u3001<code>DEFAULT_*</code> \u7b49\u5b8f\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#l31l36","title":"L31\u2013L36\uff1a\u547d\u540d\u7a7a\u95f4\u4e0e\u524d\u5411\u58f0\u660e","text":"<ul> <li>L31\uff1a<code>namespace ark {</code> \u7edf\u4e00\u8fd0\u884c\u65f6\u547d\u540d\u7a7a\u95f4\u3002</li> <li>L33\uff1a<code>class ClassLinkerContext;</code>\uff1a\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\uff08Boot/App/\u63d2\u4ef6\uff09\uff0c\u7528\u4e8e\u9694\u79bb\u4e0e\u6743\u9650\u8fb9\u754c\u3002</li> <li>L34\uff1a<code>class ManagedThread;</code>\uff1a\u7ebf\u7a0b\u5bf9\u8c61\uff08\u7528\u4e8e\u5b57\u6bb5\u8bbf\u95ee\u5feb\u8def\u5f84\u7684 thread \u5f62\u53c2\uff09\u3002</li> <li>L35\uff1a<code>class ObjectHeader;</code>\uff1a\u5806\u5bf9\u8c61\u5934\uff08\u7528\u4e8e\u5b57\u6bb5\u8bbf\u95ee\u3001ClassObject \u6620\u5c04\uff09\u3002</li> <li>L36\uff1a\u7a7a\u884c\uff0c\u5206\u9694\u8bed\u4e49\u5757\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#3-stringtype-baseclassl37l177","title":"3. <code>StringType</code> \u4e0e <code>BaseClass</code>\uff08L37\u2013L177\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#31-stringtypel37l42","title":"3.1 <code>StringType</code>\uff08L37\u2013L42\uff09","text":"<ul> <li>L37\uff1a\u5b9a\u4e49 <code>enum class StringType : uint64_t</code>\uff1b\u7528 64bit \u627f\u8f7d\u4fbf\u4e8e\u4e0e\u5176\u4ed6 header/\u4f4d\u6bb5\u5171\u5b58\u3002</li> <li>L38\uff1a<code>LINE_STRING_CLASS = 1</code>\uff1a\u7ebf\u6027\u5b57\u7b26\u4e32\u7c7b\u6807\u8bb0\u3002</li> <li>L39\uff1a<code>SLICED_STRING_CLASS</code>\uff1a\u5207\u7247\u5b57\u7b26\u4e32\u7c7b\u6807\u8bb0\uff08\u9690\u5f0f\u81ea\u589e\uff09\u3002</li> <li>L40\uff1a<code>TREE_STRING_CLASS</code>\uff1a\u6811\u5f62\u5b57\u7b26\u4e32\u7c7b\u6807\u8bb0\u3002</li> <li>L41\uff1a<code>LAST_STRING_CLASS = TREE_STRING_CLASS</code>\uff1a\u679a\u4e3e\u4e0a\u754c\uff08\u4fbf\u4e8e\u68c0\u67e5\uff09\u3002</li> <li>L42\uff1a\u7ed3\u675f\u679a\u4e3e\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#32-baseclass-l44l176","title":"3.2 <code>BaseClass</code> \u58f0\u660e\uff08L44\u2013L176\uff09","text":"<ul> <li>L44\uff1a\u6ce8\u91ca\u63d0\u793a\uff1a\u672a\u6765\u53ef\u80fd\u628a <code>BaseClass</code> \u62c6\u5230\u72ec\u7acb\u6587\u4ef6\uff0c\u4f46\u4ecd\u4fdd\u7559 <code>Class.h</code>\u3002</li> <li>L45\uff1a<code>class BaseClass {</code>\uff1a<code>Class</code> \u7684\u57fa\u7c7b\uff0c\u627f\u8f7d\u201c\u52a8\u6001\u7c7b/\u5b57\u7b26\u4e32\u7c7b\u201d\u7b49\u901a\u7528\u4f4d\u3002</li> <li>L46\uff1a<code>public:</code>\uff1a\u516c\u5f00\u63a5\u53e3\u533a\u5f00\u59cb\u3002</li> <li>L47\uff1a<code>DYNAMIC_CLASS</code> \u4f4d\uff1a\u7528\u4e8e\u6807\u8bc6\u52a8\u6001\u8bed\u8a00\u7c7b\uff08\u4e0e\u9759\u6001\u7c7b\u533a\u5206\uff09\u3002</li> <li>L48\uff1a<code>using HeaderType = uint64_t;</code>\uff1a\u4e3a <code>hclass_</code> \u9884\u7559\u7684\u5934\u5b57\u6bb5\u7c7b\u578b\u3002</li> <li>L49\u2013L50\uff1a\u7a7a\u884c + <code>public:</code> \u5197\u4f59\u58f0\u660e\uff08\u98ce\u683c\u4e0a\u7528\u4e8e\u5206\u6bb5\uff09\u3002</li> <li>L51\uff1a\u6784\u9020\u51fd\u6570\uff1a\u5fc5\u987b\u63d0\u4f9b <code>panda_file::SourceLang</code> \u4f5c\u4e3a\u8bed\u8a00\u6807\u8bb0\u3002</li> <li>L53\uff1a\u9ed8\u8ba4\u6790\u6784\u3002</li> <li>L55\u2013L56\uff1a\u5141\u8bb8\u62f7\u8d1d/\u79fb\u52a8\u8bed\u4e49\uff08<code>BaseClass</code> \u4f5c\u4e3a POD-ish \u5143\u6570\u636e\u5bb9\u5668\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#baseclassbitfieldflagsobjectsizemanagedobjectlang-l58l175","title":"BaseClass\uff1abitField/flags/objectSize/managedObject/lang \u7684\u8bbf\u95ee\u5668\uff08L58\u2013L175\uff09","text":"<p>\u8fd9\u4e9b\u51fd\u6570\u57fa\u672c\u662f\u201c\u9010\u884c\u76f4\u8bd1\u201d\uff1a\u6bcf\u4e2a getter/setter \u90fd\u53ea\u8bfb\u5199\u4e00\u4e2a\u5b57\u6bb5\uff1b\u5173\u952e\u70b9\u5728\u4e8e\u201c\u5b57\u6bb5\u8bed\u4e49\u4e0e\u5e03\u5c40\u504f\u79fb\u88ab\u66b4\u9732\u7ed9\u6c47\u7f16/\u5feb\u8def\u5f84\u201d\u3002</p> <ul> <li>L58\u2013L61\uff1a<code>GetBitField()</code> \u8fd4\u56de <code>bitField_</code>\u3002</li> <li>L63\u2013L66\uff1a<code>GetFlags()</code> \u8fd4\u56de <code>flags_</code>\u3002</li> <li>L68\u2013L71\uff1a<code>IsDynamicClass()</code>\uff1a<code>flags_ &amp; DYNAMIC_CLASS</code> \u5224\u5b9a\u3002</li> <li>L73\u2013L76\uff1a<code>GetObjectSize()</code>\uff1a\u8fd4\u56de <code>objectSize_</code>\uff08\u6ce8\u610f\uff1a\u5bf9\u62bd\u8c61/\u63a5\u53e3/\u53d8\u957f\u5bf9\u8c61\u53ef\u80fd\u4e3a 0\uff0c\u89c1 L170\u2013L173 \u6ce8\u91ca\uff09\u3002</li> <li>L78\u2013L81\uff1a<code>SetObjectSize(size)</code>\uff1a\u5199\u5165 <code>objectSize_</code>\u3002</li> <li>L83\u2013L86\uff1a<code>SetManagedObject(ObjectHeader*)</code>\uff1a\u7ed1\u5b9a\u201cClass \u7684 managed \u955c\u50cf\u5bf9\u8c61\u201d\uff08\u7528\u4e8e\u53cd\u5c04/\u7c7b\u5bf9\u8c61\uff09\u3002</li> <li>L88\u2013L91\uff1a<code>GetManagedObject()</code>\uff1a\u53d6\u56de\u955c\u50cf\u5bf9\u8c61\u6307\u9488\u3002</li> <li>L93\u2013L96\uff1a<code>GetSourceLang()</code>\uff1a\u8bed\u8a00\u679a\u4e3e getter\u3002</li> <li>L98\u2013L101\uff1a<code>SetSourceLang(lang)</code>\uff1a\u8bed\u8a00\u679a\u4e3e setter\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#baseclassstringtype-l103l136","title":"BaseClass\uff1aStringType \u76f8\u5173\u5feb\u6377\u4f4d\uff08L103\u2013L136\uff09","text":"<ul> <li>L103\u2013L106\uff1a<code>SetLineStringClass()</code>\uff1a\u5c06 <code>bitField_</code> \u7f6e\u4e3a LINE\u3002</li> <li>L108\u2013L111\uff1a<code>IsLineStringClass()</code>\uff1a\u5224\u65ad <code>GetStringType()</code> \u7b49\u4e8e LINE\u3002</li> <li>L113\u2013L116\uff1a<code>SetSlicedStringClass()</code>\uff1a\u5c06 <code>bitField_</code> \u7f6e\u4e3a SLICED\u3002</li> <li>L118\u2013L121\uff1a<code>IsSlicedStringClass()</code>\uff1a\u5224\u65ad\u7b49\u4e8e SLICED\u3002</li> <li>L123\u2013L126\uff1a<code>SetTreeStringClass()</code>\uff1a\u5c06 <code>bitField_</code> \u7f6e\u4e3a TREE\u3002</li> <li>L128\u2013L131\uff1a<code>IsTreeStringClass()</code>\uff1a\u5224\u65ad\u7b49\u4e8e TREE\u3002</li> <li>L133\u2013L136\uff1a<code>GetStringType()</code>\uff1a\u5f53\u524d\u5b9e\u73b0\u7b49\u4ef7\u4e8e <code>GetBitField()</code>\uff0c\u4fdd\u7559\u8bed\u4e49\u5c42\u547d\u540d\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#baseclassl138l153","title":"BaseClass\uff1a\u5b57\u6bb5\u504f\u79fb\u66b4\u9732\uff08L138\u2013L153\uff09","text":"<p>\u8fd9\u4e9b\u9759\u6001\u51fd\u6570\u7528 <code>MEMBER_OFFSET</code> \u8ba1\u7b97\u5b57\u6bb5\u504f\u79fb\uff0c\u5178\u578b\u7528\u9014\uff1a - \u751f\u6210\u6c47\u7f16\u5feb\u8def\u5f84/entrypoint \u65f6\u4f7f\u7528\u3002 - GC/\u5c4f\u969c/\u53cd\u5c04\u7b49\u9700\u8981\u201c\u65e0 C++ \u8bbf\u95ee\u201d\u7684\u56fa\u5b9a\u504f\u79fb\u3002</p> <ul> <li>L138\u2013L141\uff1a<code>GetFlagsOffset()</code> \u2192 <code>flags_</code> \u7684\u504f\u79fb\u3002</li> <li>L142\u2013L145\uff1a<code>GetManagedObjectOffset()</code> \u2192 <code>managedObject_</code> \u504f\u79fb\u3002</li> <li>L146\u2013L149\uff1a<code>GetObjectSizeOffset()</code> \u2192 <code>objectSize_</code> \u504f\u79fb\u3002</li> <li>L150\u2013L153\uff1a<code>GetStringTypeOffset()</code> \u2192 <code>bitField_</code> \u504f\u79fb\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#baseclassl155l164","title":"BaseClass\uff1a\u53d7\u4fdd\u62a4\u5199\u63a5\u53e3\uff08L155\u2013L164\uff09","text":"<ul> <li>L155\uff1a<code>protected:</code>\uff1a\u4ec5\u6d3e\u751f\u7c7b\u53ef\u5199\u3002</li> <li>L156\u2013L159\uff1a<code>SetBitField(StringType)</code>\uff1a\u5199 <code>bitField_</code>\u3002</li> <li>L161\u2013L164\uff1a<code>SetFlags(uint32_t)</code>\uff1a\u5199 <code>flags_</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#baseclassl166l176","title":"BaseClass\uff1a\u79c1\u6709\u5b57\u6bb5\u5e03\u5c40\uff08L166\u2013L176\uff09","text":"<ul> <li>L166\uff1a<code>private:</code>\uff1a\u5b57\u6bb5\u5f00\u59cb\u3002</li> <li>L167\uff1a<code>hclass_</code>\uff1a\u9884\u7559/\u672a\u7528\u5934\u5b57\u6bb5\uff08\u6ce8\u91ca \u201cstore ptr\u201d \u6697\u793a\u53ef\u80fd\u7528\u4e8e\u955c\u50cf/\u5143\u5bf9\u8c61\u6307\u9488\uff1b\u5f53\u524d <code>FIELD_UNUSED</code> \u8868\u793a\u672a\u53c2\u4e0e\u8bed\u4e49\uff09\u3002</li> <li>L168\uff1a<code>bitField_</code>\uff1a\u627f\u8f7d <code>StringType</code>\uff08\u540c\u65f6\u4e5f\u53ef\u6269\u5c55\u66f4\u591a\u4f4d\uff09\u3002</li> <li>L169\uff1a<code>flags_</code>\uff1a\u627f\u8f7d <code>DYNAMIC_CLASS/STRING_CLASS/...</code> \u7684\u4f4d\u96c6\u5408\uff08<code>BaseClass</code> \u7ea7\uff09\u3002</li> <li>L170\u2013L173\uff1a<code>objectSize_</code>\uff1a\u6ce8\u91ca\u660e\u786e\uff1a\u9759\u6001\u7c7b/\u62bd\u8c61/\u63a5\u53e3/\u53d8\u957f\u5bf9\u8c61\u53ef\u80fd\u4e3a 0\uff1b\u8fd9\u5bf9\u5206\u914d/\u5e03\u5c40\u81f3\u5173\u91cd\u8981\u3002</li> <li>L174\uff1a<code>managedObject_</code>\uff1aClass \u7684\u955c\u50cf\u5bf9\u8c61\u6307\u9488\u3002</li> <li>L175\uff1a<code>lang_</code>\uff1a\u6e90\u8bed\u8a00\u3002</li> <li>L176\uff1a\u7ed3\u675f <code>BaseClass</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#4-classl178l1095","title":"4. <code>Class</code>\uff1a\u8fd0\u884c\u65f6\u7c7b\u5143\u6570\u636e\uff08L178\u2013L1095\uff09","text":"<p>\u8bf4\u660e\uff1a\u672c\u6587\u4ef6\u4e2d\u7684 <code>Class</code> \u7edd\u5927\u591a\u6570\u201c\u7b97\u6cd5\u5b9e\u73b0\u201d\u4e0d\u5728\u8fd9\u91cc\uff08\u591a\u4e3a\u58f0\u660e\uff09\uff0c\u4f46\u5b57\u6bb5\u5e03\u5c40/\u72b6\u6001\u673a/\u8868\u7ed3\u6784\u7684\u5951\u7ea6\u90fd\u5728\u8fd9\u91cc\u5b9a\u4e49\uff0c\u56e0\u6b64\u5c5e\u4e8e 03 \u7684\u6838\u5fc3\u9010\u884c\u6750\u6599\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#41-l178l205","title":"4.1 \u5e38\u91cf/\u679a\u4e3e/\u6784\u9020\uff08L178\u2013L205\uff09","text":"<ul> <li>L178\uff1a<code>class Class : public BaseClass {</code>\uff1a<code>Class</code> \u7ee7\u627f <code>BaseClass</code>\u3002</li> <li>L179\uff1a<code>public:</code>\u3002</li> <li>L180\uff1a<code>UniqId</code>\uff1a\u7c7b\u552f\u4e00\u6807\u8bc6\uff08\u8fd0\u884c\u65f6 lazily \u8ba1\u7b97\uff0c\u89c1 L881\u2013L893/L1083\uff09\u3002</li> <li>L181\u2013L183\uff1a<code>STRING_CLASS/IS_CLONEABLE/XREF_CLASS</code>\uff1a\u57fa\u4e8e <code>DYNAMIC_CLASS</code> \u4f4d\u79fb\u6269\u5c55\u7684\u6807\u8bb0\u4f4d\uff08\u5b58\u4e8e <code>BaseClass::flags_</code>\uff09\u3002</li> <li>L184\uff1a<code>IMTABLE_SIZE = 32</code>\uff1a\u9ed8\u8ba4 IMTable \u5927\u5c0f\uff08\u5e38\u91cf 32 \u8868\u793a IMT \u69fd\u4f4d\u6570\u91cf\uff1b\u5177\u4f53\u51b2\u7a81\u7b56\u7565\u5728 vtable builder \u4e2d\uff09\u3002</li> <li>L186\u2013L190\uff1adump flags\uff08\u7528\u4e8e <code>DumpClass</code> \u63a7\u5236\u8f93\u51fa\u8be6\u7565\uff09\u3002</li> <li>L192\uff1a<code>enum class State</code>\uff1a\u7c7b\u751f\u547d\u5468\u671f\u72b6\u6001\u673a\uff08\u521d\u59cb\u2192\u5df2\u52a0\u8f7d\u2192\u5df2\u9a8c\u8bc1\u2192\u521d\u59cb\u5316\u4e2d\u2192\u9519\u8bef\u2192\u5df2\u521d\u59cb\u5316\uff09\u3002</li> <li>L194\uff1a\u6784\u9020\u51fd\u6570\u58f0\u660e\uff1a\u4f20\u5165 descriptor/lang/vtableSize/imtSize/size\uff08size=classSize?\uff0c\u89c1 L1057 \u5b57\u6bb5\uff09\u3002</li> <li>L196\u2013L205\uff1a<code>base_</code> \u7684 getter/setter\uff08\u7236\u7c7b\u6307\u9488\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#42-panda_file-descriptorl206l235","title":"4.2 panda_file \u8eab\u4efd\u4e0e descriptor\uff08L206\u2013L235\uff09","text":"<ul> <li>L206\u2013L214\uff1a<code>fileId_</code>\uff08EntityId\uff09 getter/setter\uff1a\u6307\u5411 panda_file \u4e2d\u8be5\u7c7b\u7684\u5b9a\u4e49\u9879\u3002</li> <li>L216\u2013L224\uff1a<code>pandaFile_</code> getter/setter\uff1a\u62e5\u6709\u8be5 <code>EntityId</code> \u7684\u6587\u4ef6\u5bf9\u8c61\u3002</li> <li>L226\u2013L234\uff1a<code>descriptor_</code> getter/setter\uff1a\u7c7b\u63cf\u8ff0\u7b26\uff08MUTF8\uff09\uff0c\u7528\u4e8e\u5feb\u901f\u6bd4\u8f83/\u67e5\u627e\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#43-methods_fields_-l236l305","title":"4.3 methods_/fields_ \u805a\u5408\u4e0e\u8ba1\u6570\uff08L236\u2013L305\uff09","text":"<p>\u6838\u5fc3\u5951\u7ea6\uff1a<code>methods_</code> \u662f\u4e00\u6bb5\u8fde\u7eed\u6570\u7ec4\uff0c\u5934\u90e8\u662f virtual methods\uff0c\u7136\u540e\u662f static methods\uff0c\u7136\u540e\u53ef\u80fd\u8ffd\u52a0 copied methods\uff08\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u590d\u5236\u4f53\uff09\u3002</p> <ul> <li>L236\u2013L242\uff1a<code>SetMethods(methods, numVmethods, numSmethods)</code>\uff1a</li> <li>L238\uff1a\u5b58 <code>methods_ = methods.data()</code>\uff08\u5916\u90e8\u8d1f\u8d23\u5206\u914d/\u751f\u547d\u5468\u671f\uff09\u3002</li> <li>L239\u2013L240\uff1a\u8ba1\u7b97 <code>numMethods_</code> \u4e0e <code>numVmethods_</code>\u3002</li> <li>L241\uff1a<code>numCopiedMethods_ = methods.size() - numMethods_</code>\uff1a\u5c3e\u90e8\u591a\u51fa\u6765\u7684\u90e8\u5206\u89c6\u4e3a copied methods\u3002</li> <li>L244\u2013L247\uff1a<code>GetRawFirstMethodAddr()</code>\uff1a\u88f8\u6307\u9488\u3002</li> <li>L249\u2013L252\uff1a<code>GetMethods()</code>\uff1a\u8fd4\u56de <code>[methods_, numMethods_)</code>\u3002</li> <li>L254\u2013L257\uff1a<code>GetMethodsWithCopied()</code>\uff1a\u8fd4\u56de\u5305\u542b copied \u7684\u8303\u56f4\u3002</li> <li>L259\u2013L262\uff1a<code>GetStaticMethods()</code>\uff1a\u5bf9 <code>GetMethods()</code> \u505a <code>SubSpan(numVmethods_)</code>\u3002</li> <li>L264\u2013L267\uff1a<code>GetVirtualMethods()</code>\uff1a<code>{methods_, numVmethods_}</code>\u3002</li> <li>L269\u2013L273\uff1a<code>GetCopiedMethods()</code>\uff1a\u5148\u6269\u6210 <code>numMethods_ + numCopiedMethods_</code>\uff0c\u518d <code>SubSpan(numMethods_)</code>\u3002</li> </ul> <p>\u5b57\u6bb5\uff1a - L275\u2013L278\uff1a<code>GetFields()</code>\uff1a\u8fd4\u56de <code>fields_</code> + <code>numFields_</code>\u3002 - L280\u2013L283\uff1a<code>GetRawFirstFieldAddr()</code>\uff1a\u88f8\u6307\u9488\u3002 - L285\u2013L288\uff1a<code>GetNumFields()</code>\uff1a\u8ba1\u6570\u3002 - L290\u2013L293\uff1a<code>GetStaticFields()</code>\uff1a\u9759\u6001\u5b57\u6bb5\u524d\u7f00\u3002 - L295\u2013L298\uff1a<code>GetInstanceFields()</code>\uff1a\u5b9e\u4f8b\u5b57\u6bb5\u540e\u7f00\u3002 - L300\u2013L305\uff1a<code>SetFields(fields, numSfields)</code>\uff1a\u540c\u6837\u7531\u5916\u90e8\u51c6\u5907\u5185\u5b58\uff0c\u7c7b\u53ea\u4fdd\u5b58 span+\u8ba1\u6570\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#44-vtableinterfacesimtl307l336","title":"4.4 VTable/Interfaces/IMT\uff08L307\u2013L336\uff09","text":"<ul> <li>L307\u2013L309\uff1a<code>GetVTable()</code> \u58f0\u660e\uff08\u975e\u5e38\u5173\u952e\uff09\uff1a\u8fd4\u56de <code>Span&lt;Method*&gt;</code>\uff0c\u5b9e\u73b0\u4f9d\u8d56 <code>GetVTableOffset()</code>\uff08\u89c1 L656\uff09\u4e0e\u7c7b\u5c3e\u90e8\u53ef\u53d8\u957f\u5e03\u5c40\uff1b\u5177\u4f53\u5e03\u5c40\u5728 vtable builder \u4e0e <code>ComputeClassSize</code> \u7684\u5951\u7ea6\u4e2d\u786e\u5b9a\u3002</li> <li>L311\u2013L320\uff1a\u63a5\u53e3\u6570\u7ec4 <code>ifaces_</code> \u4e0e\u6570\u91cf <code>numIfaces_</code>\u3002</li> <li>L322\u2013L330\uff1a<code>GetIMT()</code>\uff1a\u901a\u8fc7 <code>GetClassSpan().SubSpan&lt;Method*&gt;(GetIMTOffset(), imtSize_)</code> \u628a class \u5bf9\u8c61\u5c3e\u90e8\u67d0\u4e00\u6bb5\u89c6\u4e3a IMT \u6570\u7ec4\u3002</li> <li>\u5173\u952e\u70b9\uff1aIMT \u5b58\u50a8\u5728 <code>Class</code> \u5bf9\u8c61\u7684\u201c\u5c3e\u90e8\u6269\u5c55\u533a\u201d\uff0c\u56e0\u6b64\u9700\u8981 <code>classSize_</code>\uff08L1057\uff09\u6765\u754c\u5b9a\u8303\u56f4\u3002</li> <li>L332\u2013L336\uff1a<code>GetIMTableIndex(methodOffset)</code>\uff1a\u53d6\u6a21\u6620\u5c04\u5230 IMT \u69fd\u4f4d\uff1b\u51b2\u7a81/\u8986\u76d6\u7b56\u7565\u5728 vtable builder\uff08Stage2/03 \u7684 vtable_* \u6587\u4ef6\uff09\u91cc\u5b9e\u73b0\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#45-accessflags_-l338l391","title":"4.5 accessFlags_ \u7684\u5e38\u7528\u8c13\u8bcd\uff08L338\u2013L391\uff09","text":"<ul> <li>L338\u2013L346\uff1aaccessFlags getter/setter\u3002</li> <li>L348\u2013L356\uff1a<code>SetFinal/RemoveFinal</code>\uff1a\u76f4\u63a5\u7f6e\u4f4d/\u6e05\u4f4d <code>ACC_FINAL</code>\u3002</li> <li>L358\u2013L371\uff1a<code>IsPublic/IsProtected/IsPrivate</code>\uff1a\u6309\u4f4d\u5224\u65ad\u3002</li> <li>L373\u2013L381\uff1a<code>IsFinal</code> \u4e0e <code>IsExtensible</code>\uff1a\u53ef\u6269\u5c55 = \u975e final \u4e14\u4e0d\u662f string class\uff08string class \u7981\u6b62\u6269\u5c55\u662f\u8fd0\u884c\u65f6\u7ea6\u675f\uff09\u3002</li> <li>L383\u2013L391\uff1a<code>IsAnnotation/IsEnum</code>\uff1a\u6309\u4f4d\u5224\u65ad\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#46-vtableimtclasssize-uniontypel393l533","title":"4.6 vtable/imt/classSize \u4e0e\u6570\u7ec4/union/type\uff08L393\u2013L533\uff09","text":"<ul> <li>L393\u2013L406\uff1a<code>GetVTableSize/GetIMTSize/GetClassSize</code>\uff1a\u76f4\u63a5\u8fd4\u56de <code>vtableSize_ / imtSize_ / classSize_</code>\u3002</li> <li>L408\u2013L417\uff1a<code>GetObjectSize/SetObjectSize</code>\uff1a\u590d\u7528 <code>BaseClass::objectSize_</code>\uff0c\u5e76\u5728 setter \u91cc\u65ad\u8a00\u975e\u53d8\u957f\uff08\u6570\u7ec4/\u5b57\u7b26\u4e32\uff09\u3002</li> <li>L419\u2013L421\uff1a<code>GetTypeSize(Type)</code> \u4e0e <code>GetComponentSize()</code>\uff1a\u58f0\u660e\uff1b\u7528\u4e8e\u5bf9\u8c61\u5e03\u5c40\u8ba1\u7b97\u3002</li> <li>L422\u2013L447\uff1a\u6570\u7ec4\u7c7b\u578b\u5224\u5b9a\uff1a<code>componentType_</code> \u975e\u7a7a\u8868\u793a\u6570\u7ec4\u7c7b\uff1b\u5bf9\u8c61\u6570\u7ec4\u989d\u5916\u8981\u6c42 component \u975e primitive\u3002</li> <li>L448\u2013L451\uff1aunion \u7c7b\u578b\u5224\u5b9a\uff1a<code>constituentTypes_</code> \u975e\u7a7a\u3002</li> <li>L458\u2013L486\uff1astring/xref/cloneable \u76f8\u5173 flags \u7ec4\u5408 + <code>IsVariableSize()</code>\uff1a\u6570\u7ec4\u6216 string \u4e3a\u53d8\u957f\u5bf9\u8c61\u3002</li> <li>L488\uff1a<code>GetStaticFieldsOffset()</code>\uff1a\u58f0\u660e\uff1b\u5bf9\u8c61\u5e03\u5c40\u5173\u952e\uff08\u5b9e\u73b0\u5904\u4f1a\u6d89\u53ca\u5185\u5b58\u5e03\u5c40/\u5bf9\u9f50\uff0c\u8de8\u7ae0\u4f9d\u8d56\uff09\u3002</li> <li>L490\u2013L508\uff1a<code>type_</code> getter/setter + primitive/void \u5224\u5b9a\u3002</li> <li>L510\u2013L533\uff1a\u62bd\u8c61/\u63a5\u53e3/\u7c7b/\u53ef\u5b9e\u4f8b\u5316/\u662f\u5426 Object \u6839\u7c7b\u7684\u5224\u5b9a\u7ec4\u5408\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#47-isclassclasssubclassassignableimplementsl535l572","title":"4.7 \u7c7b\u578b\u5173\u7cfb\uff1aIsClassClass/SubClass/Assignable/Implements\uff08L535\u2013L572\uff09","text":"<ul> <li>L535\u2013L539\uff1a<code>IsClassClass()</code>\uff1a\u5224\u65ad\u5bf9\u8c61\u662f\u5426\u4e3a <code>Class</code> \u7684\u5b9e\u4f8b\uff08\u53cd\u5c04/\u7c7b\u5bf9\u8c61\u5224\u5b9a\uff09\u3002</li> <li>L541\uff1a<code>IsSubClassOf</code>\uff1a\u5b50\u7c7b\u5173\u7cfb\u3002</li> <li>L543\u2013L548\uff1a<code>IsAssignableFrom</code>\uff1a\u8d4b\u503c\u517c\u5bb9\uff08\u6570\u7ec4/\u5c42\u6b21\u7ed3\u6784\u89c4\u5219\uff09\u3002</li> <li>L550\u2013L565\uff1a<code>IsAssignableFromRefNoSuper</code>\uff1a\u4e3a CheckCast/IsInstance \u7684 slow-path \u670d\u52a1\uff1b\u6ce8\u91ca\u5f3a\u8c03\u201cfast path \u5df2\u505a\u8fc7\u7ebf\u6027\u7236\u7c7b\u94fe\u904d\u5386\uff0c\u56e0\u6b64\u8fd9\u91cc\u907f\u514d\u91cd\u590d\u904d\u5386\u201d\u3002</li> <li>L567\u2013L570\uff1a<code>IsProxy()</code>\uff1a\u6309 <code>ACC_PROXY</code>\u3002</li> <li>L572\uff1a<code>Implements</code>\uff1a\u63a5\u53e3\u5b9e\u73b0\u5173\u7cfb\uff08\u4e0e itable/ifaces \u76f8\u5173\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#48-itable-statel574l615","title":"4.8 ITable \u4e0e State\uff08L574\u2013L615\uff09","text":"<ul> <li>L574\u2013L582\uff1a<code>ITable</code> setter/getter\uff1a<code>itable_</code> \u4fdd\u5b58\u63a5\u53e3\u65b9\u6cd5\u89e3\u6790\u7528\u8868\u3002</li> <li>L584\u2013L589\uff1a\u72b6\u6001 getter + <code>SetState</code> \u58f0\u660e\uff08<code>PANDA_PUBLIC_API</code> \u5bfc\u51fa\uff0c\u901a\u5e38\u4f1a\u5305\u542b\u540c\u6b65/\u5185\u5b58\u5e8f\u7ea6\u675f\uff0c\u9700\u5728\u5b9e\u73b0\u5904\u9010\u884c\u786e\u8ba4\uff09\u3002</li> <li>L591\u2013L614\uff1a\u72b6\u6001\u8c13\u8bcd\uff1aVerified/Initializing/Initialized/Loaded/Erroneous\uff08\u6ce8\u610f\u6bd4\u8f83\u8fd0\u7b97\u4e0e\u679a\u4e3e\u987a\u5e8f\u7ed1\u5b9a\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#49-l616l656","title":"4.9 \u504f\u79fb\u5e38\u91cf\uff08L616\u2013L656\uff09","text":"<p>\u8fd9\u4e9b <code>Get*Offset()</code> \u4e00\u6837\u662f\u5bf9\u5916\u66b4\u9732\u201c\u56fa\u5b9a\u5e03\u5c40\u201d\uff1a - L616\u2013L635\uff1a<code>base_ / componentType_ / type_ / state_ / itable_</code> \u504f\u79fb\u3002 - L637\u2013L640\uff1a<code>GetInitializedValue()</code>\uff1a\u628a <code>State::INITIALIZED</code> \u8f6c\u4e3a <code>uint8_t</code>\uff08\u4fbf\u4e8e\u539f\u5b50/\u5feb\u8def\u5f84\u6bd4\u8f83\uff09\u3002 - L642\u2013L645\uff1a<code>IsVerifiedSuccess()</code>\uff1aVerified \u4e14\u975e Erroneous\u3002 - L646\u2013L654\uff1a<code>initTid_</code> setter/getter\uff1a\u8bb0\u5f55\u89e6\u53d1\u521d\u59cb\u5316\u7684\u7ebf\u7a0b id\uff08\u7528\u4e8e\u5e76\u53d1\u521d\u59cb\u5316\u534f\u8c03\uff09\u3002 - L656\uff1a<code>GetVTableOffset()</code> \u58f0\u660e\uff1a\u865a\u8868\u5728 class \u5bf9\u8c61\u5c3e\u90e8\u7684\u504f\u79fb\uff08\u4e0e <code>ComputeClassSize</code>\u3001vtable builder \u5f3a\u8026\u5408\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#410-default-method-l658l697","title":"4.10 \u865a\u65b9\u6cd5/\u590d\u5236\u65b9\u6cd5/\u9759\u6001\u5b57\u6bb5\u8ba1\u6570 + default method \u4f4d\uff08L658\u2013L697\uff09","text":"<ul> <li>L658\u2013L666\uff1a<code>numVmethods_</code> getter/setter\u3002</li> <li>L668\u2013L676\uff1a<code>numCopiedMethods_</code> getter/setter\u3002</li> <li>L678\u2013L686\uff1a<code>numSfields_</code> getter/setter\u3002</li> <li>L688\u2013L696\uff1a<code>ACC_HAS_DEFAULT_METHODS</code> \u4f4d\uff1a\u6807\u8bc6\u8be5\u7c7b\u201c\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\u76f8\u5173\u201d\uff0c\u4f9b\u6d3e\u53d1/\u89e3\u6790\u8def\u5f84\u8d70\u4e0d\u540c\u5206\u652f\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#411-imt-loadcontextl698l712","title":"4.11 IMT \u504f\u79fb\u3001\u7c7b\u540d\u3001LoadContext\uff08L698\u2013L712\uff09","text":"<ul> <li>L698\uff1a<code>GetIMTOffset()</code> \u58f0\u660e\uff1aIMT \u5728 class \u5c3e\u90e8\u7684\u504f\u79fb\uff08\u4e0e <code>GetIMT()</code> \u914d\u5957\uff09\u3002</li> <li>L700\uff1a<code>GetName()</code>\uff1a\u5bfc\u51fa\u63a5\u53e3\uff0c\u901a\u5e38\u628a <code>descriptor_</code> \u8f6c\u53ef\u8bfb\u540d\uff08\u9700\u8981\u5b9e\u73b0\u9010\u884c\u786e\u8ba4\uff09\u3002</li> <li>L702\u2013L712\uff1a<code>loadContext_</code> getter/setter\uff1a</li> <li>getter \u5bf9 null \u505a <code>ASSERT</code>\uff0c\u610f\u5473\u7740\uff1aClassLinker \u6784\u5efa Class \u65f6\u5fc5\u987b\u5148\u8bbe\u7f6e context\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#412-apil714l796","title":"4.12 \u5b57\u6bb5\u67e5\u627e\u4e0e\u65b9\u6cd5\u67e5\u627e API\uff08L714\u2013L796\uff09","text":"<p>\u672c\u6bb5\u57fa\u672c\u662f\u201c\u67e5\u8be2 API \u58f0\u660e\u201d\uff0c\u5b9e\u73b0\u901a\u5e38\u5728 <code>class-inl.h</code>\uff08\u6a21\u677f\uff09\u4e0e <code>class.cpp</code>\uff08\u975e\u6a21\u677f\uff09\u4e2d\uff1a</p> <ul> <li>L714\u2013L729\uff1aField \u67e5\u627e\u6a21\u677f\u4e0e\u6309 id \u67e5\u627e\uff08instance/static/declared \u7b49\uff09\u3002</li> <li>L730\u2013L747\uff1a\u6309\u540d\u79f0\u67e5\u627e Field\uff08MUTF8 \u4e0e <code>std::string_view</code> \u4e24\u5957\u5165\u53e3\uff0c\u907f\u514d\u9891\u7e41\u8f6c\u6362\uff09\u3002</li> <li>L748\u2013L795\uff1a\u6309\u540d\u79f0/\u539f\u578b/EntityId \u67e5\u627e Method\uff08\u533a\u5206 class vs interface\uff0cstatic vs virtual\uff0c\u76f4\u63a5\u65b9\u6cd5 direct method\uff09\u3002</li> <li>L796\uff1a<code>ResolveVirtualMethod(const Method*)</code>\uff1a\u57fa\u4e8e vtable/itable \u89e3\u6790\u5b9e\u9645\u6d3e\u53d1\u76ee\u6807\uff08\u4e0e vtable builder \u76f4\u63a5\u76f8\u5173\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#413-l798l873","title":"4.13 \u5b57\u6bb5\u8bbf\u95ee\u6a21\u677f\uff08\u542b\u5c4f\u969c/\u539f\u5b50\u5185\u5b58\u5e8f\uff09\uff08L798\u2013L873\uff09","text":"<p>\u8fd9\u4e9b\u662f\u201c\u5bf9\u8c61\u5b9e\u4f8b\u5b57\u6bb5\u8bbf\u95ee\u201d\u63a5\u53e3\u7684\u58f0\u660e\uff08\u5177\u4f53\u5b9e\u73b0\u4f9d\u8d56 <code>ObjectHeader</code> \u4e0e\u5c4f\u969c\uff0c\u8de8\u7ae0\u4f9d\u8d56 02_Memory\uff09\uff0c\u4f46\u5728\u7c7b/\u53cd\u5c04/\u89e3\u91ca\u5668\u5feb\u8def\u5f84\u4e2d\u4f7f\u7528\u6781\u5e7f\uff1a</p> <ul> <li>L798\u2013L803\uff1a\u6309 offset \u7684 primitive get/set \u6a21\u677f\uff08\u53ef\u9009 volatile\uff09\u3002</li> <li>L804\u2013L809\uff1a\u6309 offset \u7684 object get/set \u6a21\u677f\uff08\u53ef\u9009 read/write barrier\uff09\u3002</li> <li>L810\u2013L820\uff1a\u6309 <code>Field&amp;</code> \u7684 primitive/object get/set \u6a21\u677f\u3002</li> <li>L822\u2013L827\uff1a\u5e26 <code>ManagedThread*</code> \u7684 object get/set\uff08\u6ce8\u91ca\u8bf4\u660e\u201c\u52a0 thread \u5f62\u53c2\u52a0\u901f\u89e3\u91ca\u5668\u201d\uff0c\u901a\u5e38\u7528\u4e8e\u51cf\u5c11 TLS/\u5f53\u524d\u7ebf\u7a0b\u67e5\u627e\uff09\u3002</li> <li>L829\u2013L840\uff1a\u663e\u5f0f\u6307\u5b9a <code>std::memory_order</code> \u7684 primitive/object get/set\u3002</li> <li>L841\u2013L855\uff1aCAS / CompareExchange\uff08primitive/object\uff09\u3002</li> <li>L856\u2013L873\uff1aGetAndSet/GetAndAdd/GetAndBitwise* \u539f\u5b50\u8bfb\u6539\u5199\u65cf\u3002</li> </ul> <p>\u8de8\u7ae0\u8df3\u8f6c\uff1a\u8fd9\u4e9b\u6a21\u677f\u7684\u5c4f\u969c\u542b\u4e49\u3001\u5bf9\u8c61\u5b57\u6bb5\u5e03\u5c40\u4e0e\u5199\u5c4f\u969c\u5b9e\u73b0\u7ec6\u8282\u5728 Stage2/02\uff08Memory\uff09\u4e2d\u9010\u884c\u5c55\u5f00\uff1bStage2/03 \u8fd9\u91cc\u4ec5\u5b9a\u4e49\u201c\u8c01\u63d0\u4f9b\u63a5\u53e3\u3001\u8c01\u8d1f\u8d23\u8c03\u7528\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#414-dumpuniqidl874l939","title":"4.14 Dump/UniqId/\u5f15\u7528\u5b57\u6bb5\u7edf\u8ba1\uff08L874\u2013L939\uff09","text":"<ul> <li>L874\uff1a<code>DumpClass</code>\uff1a\u5c06\u7c7b\u4fe1\u606f\u8f93\u51fa\u5230\u6d41\uff08debug/diagnostic\uff09\u3002</li> <li>L876\u2013L880\uff1a<code>CalcUniqId</code> \u4e24\u4e2a\u91cd\u8f7d\uff1a\u4ece file+id \u6216 descriptor \u8ba1\u7b97\u552f\u4e00 id\uff08\u6570\u7ec4\u7b49 synthetic \u7c7b\u8d70 descriptor\uff09\u3002</li> <li>L881\u2013L893\uff1a<code>GetUniqId()</code>\uff1a</li> <li>L883\u2013L885\uff1a\u4ee5 <code>memory_order_acquire</code> \u8bfb\u53d6 <code>uniqId_</code>\uff08\u4fdd\u8bc1\u540e\u7eed\u4f9d\u8d56\u8bfb\u53d6\u7684\u53ef\u89c1\u6027\uff09\u3002</li> <li>L886\u2013L890\uff1a\u82e5\u4e3a 0 \u5219\u8ba1\u7b97\u5e76\u4ee5 <code>memory_order_release</code> \u5199\u56de\uff08\u53d1\u5e03\u8ba1\u7b97\u7ed3\u679c\uff09\u3002</li> <li>L895\u2013L902\uff1a<code>SetRefFieldsNum(num, isStatic)</code>\uff1a\u8bbe\u7f6e\u5b9e\u4f8b/\u9759\u6001\u5f15\u7528\u5b57\u6bb5\u6570\u91cf\u3002</li> <li>L904\u2013L911\uff1a<code>SetRefFieldsOffset(offset, isStatic)</code>\uff1a\u8bbe\u7f6e\u5b9e\u4f8b/\u9759\u6001\u5f15\u7528\u5b57\u6bb5\u8d77\u59cb\u504f\u79fb\u3002</li> <li>L913\u2013L920\uff1a<code>SetVolatileRefFieldsNum(num, isStatic)</code>\uff1avolatile \u5f15\u7528\u5b57\u6bb5\u6570\u91cf\uff08\u7528\u4e8e\u66f4\u4fdd\u5b88\u7684\u539f\u5b50/\u5c4f\u969c\u8def\u5f84\uff09\u3002</li> <li>L922\u2013L938\uff1a\u4e09\u4e2a\u6a21\u677f getter\uff1a\u6309 <code>IS_STATIC</code> \u5206\u652f\u8fd4\u56de\u4e0d\u540c\u7edf\u8ba1\u5b57\u6bb5\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#415-index-spanl940l983","title":"4.15 index \u89e3\u6790\u4e0e\u7d22\u5f15 span\uff08L940\u2013L983\uff09","text":"<p>\u8fd9\u4e00\u6bb5\u901a\u5e38\u7528\u4e8e\u201c\u5feb\u901f\u4ece\u7d22\u5f15\u6620\u5c04\u5230 EntityId\u201d\uff08\u4f8b\u5982 quickened bytecode\u3001\u7f13\u5b58\u7684\u7d22\u5f15\u8868\uff09\uff1a - L940\u2013L953\uff1a<code>ResolveClassIndex/ResolveMethodIndex/ResolveFieldIndex</code>\uff1a<code>Index -&gt; EntityId</code>\uff08\u8bfb\u53d6 <code>classIdx_/methodIdx_/fieldIdx_</code>\uff09\u3002 - L955\u2013L983\uff1a\u4e09\u7ec4 getter/setter\uff1a\u66b4\u9732 span \u5e76\u5141\u8bb8\u5916\u90e8\u4e00\u6b21\u6027\u8bbe\u7f6e\u6574\u5f20\u7d22\u5f15\u8868\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#416-classobject-computeclasssizel985l1095","title":"4.16 ClassObject \u6620\u5c04\u3001ComputeClassSize\u3001\u5185\u90e8\u67e5\u627e\u5668\u3001\u5c3e\u90e8\u5e03\u5c40\uff08L985\u2013L1095\uff09","text":"<ul> <li>L985\uff1a<code>FromClassObject(ObjectHeader*)</code>\uff1a\u4ece managed \u5c42 Class \u5bf9\u8c61\u53cd\u89e3\u5230 <code>Class*</code>\uff08\u53cd\u5c04/\u8fd0\u884c\u65f6\u7c7b\u578b\u7cfb\u7edf\u6838\u5fc3\u5165\u53e3\uff09\u3002</li> <li>L987\uff1a<code>GetClassObjectSizeFromClass</code>\uff1a\u6309\u8bed\u8a00/\u7c7b\u4fe1\u606f\u8ba1\u7b97 ClassObject \u5927\u5c0f\u3002</li> <li>L989\u2013L992\uff1a<code>GetMethodsOffset()</code>\uff1a\u66b4\u9732 <code>methods_</code> \u5b57\u6bb5\u504f\u79fb\u3002</li> <li>L994\uff1a\u9ed8\u8ba4\u6790\u6784\u3002</li> <li>L996\u2013L997\uff1a<code>Class</code> \u7981\u6b62\u62f7\u8d1d/\u79fb\u52a8\uff08Class \u662f\u5168\u5c40\u552f\u4e00\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u751f\u547d\u5468\u671f\u7531 ClassLinker \u7ba1\u7406\uff09\u3002</li> <li>L999\u2013L1001\uff1a<code>ComputeClassSize(...)</code>\uff1a\u8ba1\u7b97 <code>Class</code> \u5bf9\u8c61\u6574\u4f53\u5927\u5c0f\uff08\u542b\u5c3e\u90e8 vtable/imt/static fields \u7b49\u6269\u5c55\u533a\uff09\uff1b\u662f vtable builder \u4e0e\u5206\u914d\u5668\u534f\u4f5c\u7684\u6838\u5fc3\u5951\u7ea6\u4e4b\u4e00\u3002</li> </ul> <p>\u79c1\u6709\u533a\uff1a - L1003\u2013L1034\uff1a<code>Pad/FindFilter/GetFields/GetMethods/Find*Method</code> \u7b49\u5185\u90e8\u6a21\u677f\u58f0\u660e\uff1a\u7528\u4e8e\u590d\u7528\u67e5\u627e\u903b\u8f91\u5e76\u6309\u201cstatic/instance/all/copied\u201d\u8fc7\u6ee4\u3002 - L1035\u2013L1043\uff1a<code>GetClassSpan()</code>\uff1a\u628a <code>this</code> \u89c6\u4e3a <code>[this, this+classSize_)</code> \u7684\u5b57\u8282 span\uff1b\u4e0a\u5c42 <code>GetIMT()</code> \u7b49\u901a\u8fc7\u5b83\u5728\u5c3e\u90e8\u505a <code>SubSpan&lt;T*&gt;</code> \u89c6\u56fe\u3002 - L1046\u2013L1094\uff1a\u5b57\u6bb5\u5e03\u5c40\uff08\u975e\u5e38\u5173\u952e\uff09\uff1a   - <code>base_/pandaFile_/descriptor_/methods_/fields_/ifaces_</code>\uff1a\u7c7b\u8eab\u4efd\u4e0e\u805a\u5408\u6307\u9488\u3002   - <code>fileId_</code>\uff1apanda_file \u4e2d\u5b9a\u4e49\u3002   - <code>vtableSize_/imtSize_/classSize_</code>\uff1a\u5c3e\u90e8\u8868\u5927\u5c0f\u4e0e\u603b\u5927\u5c0f\u3002   - <code>accessFlags_</code>\uff1aACC_\u3002   - <code>num*</code> \u7cfb\u5217\uff1a\u65b9\u6cd5/\u5b57\u6bb5/\u63a5\u53e3/union constituent \u6570\u91cf\u7b49\u3002   - <code>initTid_</code>\uff1a\u521d\u59cb\u5316\u7ebf\u7a0b\u3002   - <code>itable_</code>\uff1a\u63a5\u53e3\u8868\u3002   - <code>componentType_/constituentTypes_</code>\uff1a\u6570\u7ec4/union \u7c7b\u578b\u627f\u8f7d\u3002   - <code>loadContext_</code>\uff1a\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\uff08\u4e0d\u53ef\u4e3a\u7a7a\uff09\u3002   - <code>type_</code>\uff1aprimitive/void/reference \u7b49\u3002   - <code>state_</code>\uff1a\u539f\u5b50\u72b6\u6001\u673a\uff08\u5e76\u53d1\u521d\u59cb\u5316/\u9a8c\u8bc1\uff09\u3002   - <code>uniqId_</code>\uff1alazy \u521d\u59cb\u5316\u7684\u552f\u4e00 id\u3002   - \u5f15\u7528\u5b57\u6bb5\u7edf\u8ba1\u4e0e offset\uff1a\u670d\u52a1 GC/\u5c4f\u969c/\u5feb\u8def\u5f84\u3002   - \u4e09\u5f20 index span\uff1aIndex-&gt;EntityId \u89e3\u6790\u8868\u3002 - L1095*\uff1a\u7ed3\u675f <code>Class</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#5-l1097l1102","title":"5. \u6587\u4ef6\u5c3e\uff08L1097\u2013L1102\uff09","text":"<ul> <li>L1097\uff1a\u5bfc\u51fa <code>operator&lt;&lt;</code>\uff1a\u628a <code>Class::State</code> \u6253\u5370\u4e3a\u6587\u672c\uff08\u8c03\u8bd5\u8bca\u65ad\uff09\u3002</li> <li>L1099\uff1a<code>}</code> \u7ed3\u675f\u547d\u540d\u7a7a\u95f4\u3002</li> <li>L1101\u2013L1102\uff1a\u7ed3\u675f include guard\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class.h/#6","title":"6. \u672c\u6587\u4ef6\u5f15\u51fa\u7684\u201c\u540c\u7ae0\u5f3a\u76f8\u5173\u6587\u4ef6\u201d\uff08\u52a8\u6001\u7eb3\u5165\u5019\u9009\uff09","text":"<p>\u5728\u9010\u884c\u8fc7\u7a0b\u4e2d\u5df2\u786e\u8ba4\uff1a<code>class.h</code> \u76f4\u63a5\u4f9d\u8d56/\u5f3a\u8026\u5408\u4ee5\u4e0b\u6587\u4ef6\uff08\u8bed\u4e49\u5f52\u5c5e 03\uff0c\u540e\u7eed\u4f1a\u6309\u89c4\u5219\u7eb3\u5165\u9010\u884c\uff09\uff1a - <code>runtime/include/field.h</code> - <code>runtime/include/method.h</code> - <code>runtime/include/itable.h</code> - <code>runtime/include/vtable_builder_*</code>\uff08\u4f60\u5df2\u70b9\u540d\u4e3a 03 \u5fc5\u8bfb\uff09 - \u4ee5\u53ca <code>ClassLinkerContext</code> \u7684\u5b9e\u73b0\u5934\uff1a<code>runtime/class_linker_context.h</code></p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/","title":"<code>runtime/include/class_helper.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aClass/Descriptor/Type \u7684\u8f85\u52a9\u5de5\u5177\u4e0e ABI \u5e38\u91cf\uff08\u5c24\u5176\u662f <code>OBJECT_POINTER_SIZE</code> / <code>POINTER_SIZE</code>\uff09\u3002 \u4e0e\u6267\u884c/\u5185\u5b58\u7684\u5173\u7cfb\uff1a\u8fd9\u91cc\u7684\u5e38\u91cf\u4f1a\u76f4\u63a5\u5f71\u54cd <code>Class::ComputeClassSize</code> \u7684\u5e03\u5c40\u8ba1\u7b97\uff1b\u540c\u65f6\u4f9d\u8d56 <code>runtime/object_header_config.h</code>\uff08MemoryModelConfig\uff0c\u8de8\u7ae0\u4f46\u5728\u6b64\u53ea\u89e3\u91ca\u5176\u5bf9\u6307\u9488\u5927\u5c0f\u9009\u62e9\u7684\u5f71\u54cd\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#1-03","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u4e3a\u4ec0\u4e48\u5b83\u5c5e\u4e8e 03\uff09","text":"<p>\u7c7b\u52a0\u8f7d/\u94fe\u63a5\u9636\u6bb5\u9700\u8981\u5927\u91cf\u5904\u7406\uff1a - \u7c7b\u540d \u2194 descriptor \u7684\u4e92\u8f6c\uff08\u4f8b\u5982 <code>Ljava/lang/String;</code>\uff09 - \u6570\u7ec4 descriptor \u7684 rank/component \u63d0\u53d6 - primitive type \u7684 descriptor \u5b57\u7b26 - union descriptor \u7684\u89e3\u6790\uff08\u672c\u6587\u4ef6\u58f0\u660e\u4e86 union \u76f8\u5173 API\uff09</p> <p>\u6b64\u5916\uff0c\u672c\u6587\u4ef6\u7528 <code>MemoryModelConfig</code> \u5bfc\u51fa <code>OBJECT_POINTER_SIZE</code>\uff0c\u7528\u4e8e\uff1a - <code>class-inl.h</code>\uff1a<code>GetTypeSize(REFERENCE)</code> \u8fd4\u56de <code>OBJECT_POINTER_SIZE</code> - <code>ComputeClassSize</code>\uff1avtable/imt/\u9759\u6001\u5f15\u7528\u5b57\u6bb5\u533a\u57df\u7684\u5bf9\u9f50\u4e0e\u5927\u5c0f\u8ba1\u7b97</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#2-l1l25","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L25\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_KLASS_HELPER_H_</code>\u3002</li> <li>L18\uff1a<code>&lt;cstdint&gt;</code>\uff1a\u57fa\u672c\u6574\u6570\u7c7b\u578b\u3002</li> <li>L20\uff1a<code>Span</code>\uff1a\u7528\u4e8e\u5904\u7406 descriptor \u7684\u8f7b\u91cf\u89c6\u56fe\uff08\u4f8b\u5982 <code>IsArrayDescriptor</code>\uff09\u3002</li> <li>L21\uff1a<code>file_items.h</code>\uff1a<code>panda_file::Type</code> \u4e0e <code>TypeId</code>\u3002</li> <li>L22\uff1a<code>TaggedValue</code>\uff1a\u7528\u4e8e tagged \u7c7b\u578b\u5927\u5c0f\uff08\u4e0e class object \u5e03\u5c40\u8ba1\u7b97\u4e00\u81f4\u6027\uff09\u3002</li> <li>L23\uff1a<code>panda_string.h</code>\uff1a<code>PandaString</code>\uff08\u7528\u4e8e\u6784\u9020/\u5b58\u50a8 descriptor \u5b57\u7b26\u4e32\uff09\u3002</li> <li>L24\uff1a<code>object_header_config.h</code>\uff1a\u5bfc\u51fa <code>MemoryModelConfig</code>\uff08\u51b3\u5b9a\u5bf9\u8c61\u5f15\u7528\u5927\u5c0f\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#3-classconfig-l28l40","title":"3. <code>ClassConfig</code> \u4e0e\u524d\u5411\u58f0\u660e\uff08L28\u2013L40\uff09","text":"<ul> <li>L28\u2013L33\uff1a\u6a21\u677f <code>ClassConfig&lt;Config&gt;</code>\uff1a</li> <li>L32\uff1a<code>using ClassWordSize = typename Config::Size;</code></li> <li>\u76ee\u7684\uff1a\u628a <code>MemoryModelConfig::Size</code> \u62bd\u8c61\u6210\u4e00\u4e2a\u53ef\u590d\u7528\u7684 \u201cClassWordSize\u201d\u3002</li> <li>L35\u2013L40\uff1a\u524d\u5411\u58f0\u660e <code>Class/ClassLinker/...</code>\uff1aunion \u76f8\u5173 API \u9700\u8981\u8fd9\u4e9b\u7c7b\u578b\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#4-classhelper-descriptor-l41l111","title":"4. <code>ClassHelper</code>\uff1a\u6838\u5fc3\u5e38\u91cf\u4e0e descriptor \u5de5\u5177\uff08L41\u2013L111\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#41-object_pointer_size-pointer_sizel41l48","title":"4.1 <code>OBJECT_POINTER_SIZE</code> \u4e0e <code>POINTER_SIZE</code>\uff08L41\u2013L48\uff09","text":"<ul> <li>L41\uff1a<code>ClassHelper : private ClassConfig&lt;MemoryModelConfig&gt;</code>\uff1a\u628a MemoryModelConfig \u6ce8\u5165\u3002</li> <li>L43\uff1a\u5bfc\u51fa <code>ClassWordSize</code>\uff08\u5bf9\u5916\u53ef\u89c1\uff09\u3002</li> <li>L45\uff1a<code>OBJECT_POINTER_SIZE = sizeof(ClassWordSize)</code>\uff1a</li> <li>\u8868\u793a \u8fd0\u884c\u65f6\u5bf9\u8c61\u5f15\u7528 \u7684\u5927\u5c0f\uff08\u53ef\u80fd\u4e0e <code>sizeof(void*)</code> \u4e0d\u540c\uff0c\u5178\u578b\u539f\u56e0\u662f\u538b\u7f29\u6307\u9488/\u4e0d\u540c\u5185\u5b58\u6a21\u578b\uff09\u3002</li> <li>L47\uff1a<code>POINTER_SIZE = sizeof(uintptr_t)</code>\uff1a</li> <li>\u8868\u793a \u672c\u673a\u6307\u9488\u5bbd\u5ea6\uff08C++ \u6307\u9488\u5927\u5c0f\uff09\u3002</li> <li>L46 \u6ce8\u91ca\u5f3a\u8c03\uff1a\u5bf9\u4efb\u610f <code>T</code>\uff0c<code>sizeof(T*)</code> \u4e0d\u4e00\u5b9a\u7b49\u4e8e <code>OBJECT_POINTER_SIZE</code>\u3002</li> </ul> <p>\u8fd9\u4e24\u8005\u7684\u533a\u5206\u662f\u7406\u89e3 <code>ComputeClassSize</code>/\u5bf9\u8c61\u5e03\u5c40/\u5f15\u7528\u5b57\u6bb5\u5927\u5c0f\u7684\u5173\u952e\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#42-descriptor-api-l49l71","title":"4.2 descriptor \u751f\u6210/\u89e3\u6790 API \u58f0\u660e\uff08L49\u2013L71\uff09","text":"<p>\u672c\u6bb5\u5927\u591a\u662f\u58f0\u660e\uff08\u5b9e\u73b0\u5e94\u5728 <code>.cpp</code> \u6216\u5176\u4ed6 inl \u4e2d\uff09\uff1a - <code>GetDescriptor(name, storage, strictPublicDescriptor)</code> - <code>GetTypeDescriptor(name, storage)</code> - <code>GetArrayDescriptor(componentName, rank, storage)</code> - <code>GetPrimitiveTypeDescriptorChar/Str</code> - <code>GetPrimitiveTypeStr</code> - <code>GetPrimitiveDescriptor/GetPrimitiveArrayDescriptor</code> - <code>GetName/GetNameUndecorated</code>\uff08\u6a21\u677f\uff0c\u540e\u9762 inline \u5b9e\u73b0\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#43-descriptor-l72l94","title":"4.3 \u6570\u7ec4 descriptor \u5224\u65ad\u4e0e\u5206\u89e3\uff08L72\u2013L94\uff09","text":"<ul> <li>L72\u2013L76\uff1a<code>IsArrayDescriptor</code>\uff1a\u5224\u65ad\u9996\u5b57\u7b26\u662f\u5426 <code>'['</code>\u3002</li> <li>L78\u2013L83\uff1a<code>GetComponentDescriptor</code>\uff1a\u8fd4\u56de <code>descriptor + 1</code>\uff08\u8df3\u8fc7\u4e00\u4e2a <code>'['</code>\uff09\uff1a</li> <li>\u6ce8\u610f\uff1a\u8fd9\u91cc\u53ea\u5265\u4e00\u5c42\uff1b\u591a\u7ef4\u6570\u7ec4\u9700\u914d\u5408 <code>GetDimensionality</code>\u3002</li> <li>L85\u2013L94\uff1a<code>GetDimensionality</code>\uff1a</li> <li>\u7edf\u8ba1\u8fde\u7eed <code>'['</code> \u7684\u6570\u91cf\uff08rank\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#44-union-descriptor-apil96l104","title":"4.4 union descriptor API\uff08L96\u2013L104\uff09","text":"<p>\u58f0\u660e\u4e86 union \u76f8\u5173\u7684\u68c0\u67e5\u4e0e LUB\uff08\u6700\u5c0f\u4e0a\u754c\uff09\u6c42\u89e3\u5165\u53e3\uff1a - <code>IsUnionDescriptor/IsUnionOrArrayUnionDescriptor</code> - <code>GetUnionComponent</code> - <code>GetUnionLUBClass(descriptor, classLinker, ctx, ext, handler)</code></p> <p>union \u63cf\u8ff0\u7b26\u7684\u52a0\u8f7d/\u7ec4\u6210\u7c7b\u578b\u89e3\u6790\u5df2\u5728 <code>runtime/class_linker.cpp</code> \u7684 <code>LoadUnionClass/LoadConstituentClasses</code> \u7b49\u8def\u5f84\u9010\u884c\u786e\u8ba4\uff08\u89c1 FileNotes/runtime_class_linker.cpp \u7684 union \u6bb5\u843d\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#5-getnamedescriptor-l113l167","title":"5. <code>GetName</code>\uff1adescriptor \u2192 \u4eba\u7c7b\u53ef\u8bfb\u540d\uff08L113\u2013L167\uff09","text":"<p>\u8be5\u6a21\u677f\u652f\u6301 <code>std::string</code> \u6216 <code>PandaString</code>\uff1a</p> <ul> <li>L118\u2013L148\uff1a\u5bf9\u5355\u5b57\u7b26 primitive/\u7279\u6b8a\u7c7b\u578b\u505a\u6620\u5c04\uff1a</li> <li><code>V</code>\u2192<code>void</code>\uff0c<code>Z</code>\u2192<code>u1</code>\uff0c<code>B</code>\u2192<code>i8</code>\uff0c<code>H</code>\u2192<code>u8</code>\uff0c<code>S</code>\u2192<code>i16</code>\uff0c<code>C</code>\u2192<code>u16</code>\uff0c<code>I</code>\u2192<code>i32</code>\uff0c<code>U</code>\u2192<code>u32</code>\uff0c<code>J</code>\u2192<code>i64</code>\uff0c<code>Q</code>\u2192<code>u64</code>\uff0c<code>F</code>\u2192<code>f32</code>\uff0c<code>D</code>\u2192<code>f64</code></li> <li><code>A</code>\u2192<code>any</code>\uff08\u52a8\u6001/\u6cdb\u578b\u76f8\u5173\u8bed\u4e49\uff09</li> <li><code>Y/N</code>\uff1a\u4fdd\u7559\u5b57\u9762\u8fd4\u56de\uff08\u9700\u8981\u7ed3\u5408\u8bed\u8a00\u63d2\u4ef6\u5b9a\u4e49\u5176\u8bed\u4e49\uff09</li> <li>L154\uff1a\u9ed8\u8ba4\u5206\u652f\u628a descriptor \u5f53\u4f5c MUTF8 \u5b57\u7b26\u4e32\uff1a</li> <li>\u82e5\u4ee5 <code>'['</code> \u5f00\u5934\uff08\u6570\u7ec4 descriptor\uff09\uff0c\u76f4\u63a5\u8fd4\u56de\u539f\u4e32\uff08\u4e0d\u53bb\u6389\u88c5\u9970\uff09\u3002</li> <li>\u5426\u5219\uff1a<ul> <li>\u66ff\u6362 <code>'/'</code> \u4e3a <code>'.'</code></li> <li>\u53bb\u6389\u524d\u7f00 <code>'L'</code> \u4e0e\u672b\u5c3e <code>';'</code>\uff08\u65ad\u8a00\u957f\u5ea6 &gt; 2\uff09</li> </ul> </li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#6-getnameundecorated-l169l189","title":"6. <code>GetNameUndecorated</code>\uff1a\u6570\u7ec4\u7528 <code>[]</code> \u8868\u793a\uff08L169\u2013L189\uff09","text":"<ul> <li>L176\u2013L179\uff1a\u5148\u7edf\u8ba1 rank\uff08\u8fde\u7eed <code>'['</code> \u6570\uff09\u3002</li> <li>L181\uff1a<code>AppendType(descriptor, rank, result)</code>\uff1a\u628a component \u7684\u57fa\u7840\u7c7b\u578b\u5199\u5165 result\u3002</li> <li>L183\u2013L186\uff1a\u518d\u8ffd\u52a0 rank \u4e2a <code>\"[]\"</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#7-appendtypeappendnonprimitivetypel191l255","title":"7. <code>AppendType/AppendNonPrimitiveType</code>\uff08L191\u2013L255\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#71-appendtypel193l242","title":"7.1 <code>AppendType</code>\uff08L193\u2013L242\uff09","text":"<ul> <li>\u8bfb <code>descriptor[rank]</code>\uff08\u8df3\u8fc7 <code>'['</code>\uff09\uff1a</li> <li>primitive \u6620\u5c04\u540c <code>GetName</code></li> <li><code>'L'</code>\uff1a\u8c03\u7528 <code>AppendNonPrimitiveType</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#72-appendnonprimitivetypel246l255","title":"7.2 <code>AppendNonPrimitiveType</code>\uff08L246\u2013L255\uff09","text":"<ul> <li>\u8ffd\u52a0 <code>descriptor + rank + 1</code> \u7684\u5b57\u7b26\u4e32\uff08\u8df3\u8fc7 <code>'L'</code>\uff09\uff0c\u518d <code>pop_back()</code> \u53bb\u6389 <code>';'</code>\u3002</li> <li>\u66ff\u6362 <code>'/'</code> \u4e3a <code>'.'</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_helper.h/#8-l257l259","title":"8. \u6587\u4ef6\u5c3e\uff08L257\u2013L259\uff09","text":"<ul> <li>\u7ed3\u675f\u547d\u540d\u7a7a\u95f4\u4e0e include guard\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/","title":"<code>runtime/include/class_linker.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a<code>ClassLinker</code> \u5bf9\u5916 API + \u5185\u90e8\u7c7b\u52a0\u8f7d/\u94fe\u63a5/\u521d\u59cb\u5316\u7ba1\u7ebf\u58f0\u660e\uff08\u8bed\u8a00\u65e0\u5173\u5bb9\u5668\uff09\uff0c\u5e76\u96c6\u6210 AOT \u4e0a\u4e0b\u6587\u3001boot class filter \u7b49\u3002 \u5173\u952e\uff1a\u8fd9\u4efd\u5934\u6587\u4ef6\u57fa\u672c\u7ed9\u51fa\u4e86 ClassLoading \u7684\u201c\u5168\u94fe\u8def\u51fd\u6570\u5206\u89e3\u56fe\u201d\uff0c\u5b9e\u73b0\u4e3b\u8981\u5728 <code>runtime/class_linker.cpp</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#1-classlinker-runtime","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08ClassLinker \u5728 Runtime \u4e2d\u7684\u89d2\u8272\uff09","text":"<p>\u6587\u4ef6\u6ce8\u91ca\uff08L50\u2013L53\uff09\u660e\u786e\uff1a - <code>ClassLinker</code> \u662f\u7ebf\u7a0b\u5b89\u5168\u3001\u8bed\u8a00\u65e0\u5173\u7684\u201c\u7c7b\u64cd\u4f5c\u5bb9\u5668\u201d\uff1b - \u5b9e\u4f8b\u7531 <code>Runtime</code> \u6301\u6709\uff0c\u7b49\u4ef7\u4e8e\u5355\u4f8b\uff1b - \u901a\u8fc7 <code>extensions_</code>\uff08\u6309\u8bed\u8a00\u6570\u7ec4\u7d22\u5f15\uff09\u628a\u201c\u8bed\u8a00\u76f8\u5173\u7b56\u7565\u201d\u59d4\u6258\u7ed9 <code>ClassLinkerExtension</code>\u3002</p> <p>\u5728 Stage2/03 \u7684\u7ed3\u6784\u4e0a\uff1a - <code>Class</code>/<code>Method</code>/<code>Field</code> \u5b9a\u4e49\u5143\u6570\u636e\u5951\u7ea6\uff1b - <code>vtable/itable/imtable builder</code> \u8d1f\u8d23\u6d3e\u53d1\u8868\u7ed3\u6784\u6784\u5efa\uff1b - <code>ClassLinkerContext</code> \u8d1f\u8d23\u201c\u4e0a\u4e0b\u6587\u9694\u79bb + \u7f13\u5b58 + \u5e76\u53d1\u534f\u8c03 + roots\u201d\uff1b - <code>ClassLinker</code> \u628a\u8fd9\u4e9b\u62fc\u88c5\u6210\u4e00\u4e2a\u53ef\u5e76\u53d1\u6267\u884c\u7684\u52a0\u8f7d/\u94fe\u63a5/\u521d\u59cb\u5316\u7ba1\u7ebf\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#2-l1l48","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L48\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_CLASS_LINKER_H_</code>\u3002</li> <li>L24\uff1a<code>compiler/aot/aot_manager.h</code>\uff1aAOT \u7ba1\u7406\u5668\u96c6\u6210\u5230 ClassLinker\uff08<code>.an</code> \u6587\u4ef6\u52a0\u8f7d\u4e0e class context\uff09\u3002</li> <li>L25\u2013L27\uff1aArena allocator\u3001mutex\u3001BloomFilter\uff1a\u7528\u4e8e\u5185\u90e8\u6570\u636e\u7ed3\u6784\u4e0e boot class filter\u3002</li> <li>L29\u2013L31\uff1apanda_file accessor\uff1a<code>ClassDataAccessor</code>\u3001<code>File</code>\u3001<code>EntityId</code>\u3002</li> <li>L32\uff1a<code>class_linker_context.h</code>\uff1a\u4e0a\u4e0b\u6587\u3002</li> <li>L33\u2013L35, L41\uff1a<code>class.h/field.h/method.h</code>\uff1a\u5143\u6570\u636e\u5bf9\u8c61\u3002</li> <li>L35\u2013L36\uff1a<code>itable_builder.h/imtable_builder.h</code>\uff1a\u6d3e\u53d1\u8868\u6784\u5efa\u5668\uff08\u4e0e vtable builder \u540c\u5c42\uff09\u3002</li> <li>L37\uff1a<code>language_context.h</code>\uff1a\u8bed\u8a00\u679a\u4e3e\u4e0e\u7d22\u5f15\u6620\u5c04\uff08<code>GetLangArrIndex</code>\uff09\u3002</li> <li>L38\u2013L40\uff1apanda \u5bb9\u5668\u4e0e\u5b57\u7b26\u4e32\u3002</li> <li>L42\uff1a<code>vtable_builder_interface.h</code>\uff1a<code>VTableBuilder</code> \u62bd\u8c61\u63a5\u53e3\u3002</li> <li>L46\u2013L47\uff1a<code>using compiler::AotManager;</code>\uff1a\u66b4\u9732\u7c7b\u578b\u522b\u540d\u3002</li> <li>L48\uff1a<code>ClassLinkerErrorHandler</code> \u524d\u5411\u58f0\u660e\uff08\u9519\u8bef\u4e0a\u62a5\u901a\u9053\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#3-classlinkererrorl56l67","title":"3. <code>ClassLinker::Error</code>\uff08L56\u2013L67\uff09","text":"<p>\u7edf\u4e00\u7684\u9519\u8bef\u679a\u4e3e\uff0c\u8986\u76d6\uff1a - not found\uff08class/field/method\uff09 - no class def / circularity - override/final\u3001multiple override\u3001multiple implement\uff08\u76f4\u63a5\u5bf9\u5e94 vtable builder \u51b2\u7a81\uff09 - invalid lambda/overload\uff08\u8bed\u8a00/\u5b57\u8282\u7801\u7ea6\u675f\uff09</p> <p>\u8fd9\u4e9b\u9519\u8bef\u6700\u7ec8\u901a\u8fc7 <code>ClassLinkerErrorHandler::OnError</code> \u4e0a\u629b\uff08\u89c1\u6587\u4ef6\u672b\u5c3e L448+\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#4-l69l76","title":"4. \u6784\u9020/\u6790\u6784/\u521d\u59cb\u5316\uff08L69\u2013L76\uff09","text":"<ul> <li>L69\uff1a\u6784\u9020\u51fd\u6570\uff1a\u6ce8\u5165 <code>InternalAllocator</code> + \u4e00\u7ec4 <code>ClassLinkerExtension</code>\uff08unique_ptr vector\uff0c\u968f\u540e\u4f1a\u6574\u7406\u5230 <code>extensions_</code> \u6570\u7ec4\uff09\u3002</li> <li>L71\u2013L72\uff1a\u6790\u6784\uff1a\u9700\u8981\u91ca\u653e extensions\u3001copied names\u3001pandaFiles_ \u7b49\u3002</li> <li>L73\uff1a<code>Initialize(bool compressedStringEnabled=true)</code>\uff1a\u603b\u4f53\u521d\u59cb\u5316\uff08roots/boot files/filter \u7b49\uff09\u3002</li> <li>L75\uff1a<code>InitializeRoots(thread)</code>\uff1a\u521d\u59cb\u5316 class roots\uff08\u8bed\u8a00\u76f8\u5173 root \u96c6\u5408\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#5-getclass-loadclass-buildclassl77l106l303l306l373l378","title":"5. \u6838\u5fc3\u5165\u53e3\uff1aGetClass / LoadClass / BuildClass\uff08L77\u2013L106\uff0cL303\u2013L306\uff0cL373\u2013L378\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#51-getclassl77l85","title":"5.1 GetClass\uff08L77\u2013L85\uff09","text":"<p>\u4e09\u5957\u5165\u53e3\uff1a - \u6309 descriptor + context\uff08\u6700\u5e38\u89c1\uff09 - \u6309 (pf,id) + context\uff08\u5df2\u77e5\u5b9a\u4e49\u6587\u4ef6\u4e0e id\uff09 - \u6309 caller method + id\uff08\u7528\u4e8e \u201c\u76f8\u5bf9\u8c03\u7528\u8005\u7684 resolve\u201d\uff0ccontext \u53ef\u4ece caller \u63a8\u5bfc\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#52-loadclassl89l93-l373l378","title":"5.2 LoadClass\uff08L89\u2013L93 / L373\u2013L378\uff09","text":"<p>\u516c\u5f00 wrapper\uff08L89\u2013L93\uff09\u628a <code>pf+classId</code> \u8f6c\u6210 <code>descriptor</code> \u5e76\u8c03\u7528\u79c1\u6709 <code>LoadClass(pf*, classId, descriptor, context, ...)</code>\u3002</p> <p>\u79c1\u6709 overload\uff08L373\u2013L378\uff09\u4e0e <code>LoadClass(ClassDataAccessor*, descriptor, base, interfaces, context, ext, ...)</code> \u5171\u540c\u7ec4\u6210\u52a0\u8f7d\u7ba1\u7ebf\uff1a - \u89e3\u6790 base class - \u89e3\u6790 interfaces - LoadFields/LoadMethods - SetupClassInfo\uff08builders + size + numSfields\uff09 - LinkEntitiesAndInitClass\uff08\u94fe\u63a5\u5e76\u89e6\u53d1\u521d\u59cb\u5316\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#53-buildclassl303l306","title":"5.3 BuildClass\uff08L303\u2013L306\uff09","text":"<p>\u8fd9\u662f\u201c\u4ece\u5df2\u6784\u9020\u7684 methods/fields/interfaces/base \u76f4\u63a5\u6784\u5efa Class\u201d\u7684\u5165\u53e3\uff08\u7528\u4e8e\u5408\u6210\u7c7b\u3001\u6570\u7ec4/union \u7c7b\u7b49\u573a\u666f\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#6-methodfield-apil95l112","title":"6. Method/Field \u83b7\u53d6 API\uff08L95\u2013L112\uff09","text":"<p><code>GetMethod/GetField</code> \u65e2\u63d0\u4f9b \u201c\u6309 (pf,id)\u201d \u7684\u5165\u53e3\uff0c\u4e5f\u63d0\u4f9b \u201c\u6309 caller method + id\u201d \u7684\u5165\u53e3\uff0c\u5185\u90e8\u4f1a\u8d70\uff1a - <code>GetMethod(klass, MethodDataAccessor, handler)</code>\uff1a\u4ece\u5177\u4f53 class + accessor \u6784\u9020 Method \u5143\u6570\u636e - <code>GetField(klass, FieldDataAccessor, isStatic, handler)</code>\uff1a\u6784\u9020 Field \u5143\u6570\u636e</p> <p>\u5e76\u4e14\u79c1\u6709\u533a\u8fd8\u533a\u5206\uff1a - <code>GetFieldById</code> vs <code>GetFieldBySignature</code>\uff08L355\u2013L360\uff09\uff0c\u6697\u793a\uff1a\u5b57\u6bb5 resolve \u53ef\u80fd\u9700\u8981\u517c\u5bb9\u6027/\u7b7e\u540d\u5339\u914d\u89c4\u5219\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#7-panda-files-l113l146l416l426","title":"7. Panda files \u6ce8\u518c\u4e0e\u679a\u4e3e\uff08L113\u2013L146\uff0cL416\u2013L426\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#71-addpandafilel113l115","title":"7.1 AddPandaFile\uff08L113\u2013L115\uff09","text":"<p>\u6ce8\u518c\u4e00\u4e2a panda_file \u5230 ClassLinker\uff08\u53ef\u9009\u6307\u5b9a context\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#72-enumeratepandafilesl116l129","title":"7.2 EnumeratePandaFiles\uff08L116\u2013L129\uff09","text":"<ul> <li>L119\uff1a<code>pandaFilesLock_</code> \u4fdd\u62a4 <code>pandaFiles_</code>\u3002</li> <li>L121\u2013L123\uff1a<code>skipIntrinsics</code> \u65f6\u8df3\u8fc7 \u201cfilename \u4e3a\u7a7a\u201d\u7684 file\uff08\u5178\u578b\uff1a\u5185\u5efa intrinsics file\uff09\u3002</li> <li>L125\u2013L127\uff1acb \u8fd4\u56de false \u5219\u505c\u6b62\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#73-boot-panda-filesl131l146","title":"7.3 Boot panda files\uff08L131\u2013L146\uff09","text":"<p>boot files \u7528\u72ec\u7acb\u7684 <code>bootPandaFilesLock_</code> \u4e0e <code>bootPandaFiles_</code> \u7ba1\u7406\u3002</p> <p>\u8fd9\u4e24\u5957\u9501\u4e0e\u5bb9\u5668\u89e3\u91ca\u4e86\uff1aClassLinker \u65e2\u7ef4\u62a4\u5168\u91cf panda files\uff0c\u53c8\u7ef4\u62a4 boot subset\uff08\u7528\u4e8e\u542f\u52a8/\u8fc7\u6ee4/\u5feb\u901f\u67e5\u627e\u7b49\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#8-aot-l147l157l339l341l427","title":"8. AOT \u96c6\u6210\uff08L147\u2013L157\uff0cL339\u2013L341\uff0cL427\uff09","text":"<ul> <li>L147\u2013L150\uff1a<code>GetAotManager()</code> \u76f4\u63a5\u8fd4\u56de <code>aotManager_</code>\u3002</li> <li>L152\u2013L157\uff1a<code>GetClassContextForAot(useAbsPath)</code>\uff1a</li> <li>\u7528 <code>AotClassContextCollector</code> \u904d\u5386 pandaFiles_\uff0c\u628a\u8def\u5f84\u62fc\u6210 class context \u5b57\u7b26\u4e32\u3002</li> <li>L339\u2013L341\uff1a<code>TryReLinkAotCodeForBoot</code>\uff1aboot \u573a\u666f\u4e0b\u5c1d\u8bd5\u91cd\u65b0\u94fe\u63a5 AOT code\uff08\u4e34\u65f6\u65b9\u6848 Issue 29288\uff09\u3002</li> <li>L427\uff1a<code>aotManager_</code> \u4e3a unique_ptr\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#9-extensionsl234l258l432","title":"9. Extensions\uff1a\u8bed\u8a00\u5206\u53d1\uff08L234\u2013L258\uff0cL432\uff09","text":"<ul> <li><code>HasExtension/GetExtension/ResetExtension</code>\uff1a\u6309 language index \u8bbf\u95ee <code>extensions_</code>\u3002</li> <li><code>ObjectToClass</code>\uff08L260\u2013L267\uff09\uff1a</li> <li>\u8981\u6c42 object \u662f ClassObject\uff08<code>IsClassClass()</code>\uff09</li> <li>\u6839\u636e object \u7684 source lang \u9009\u62e9 extension \u5e76\u8c03\u7528 <code>FromClassObject</code>\u3002</li> <li><code>GetClassObjectSize</code>\uff08L269\u2013L274\uff09\uff1a</li> <li>\u4e0d\u80fd\u4ece cls \u8bfb source lang\uff08\u6ce8\u91ca\u8bf4\u660e\u53ef\u80fd\u672a\u521d\u59cb\u5316 #12894\uff09</li> <li>\u56e0\u6b64\u901a\u8fc7\u663e\u5f0f <code>lang</code> \u53c2\u6570\u9009\u62e9 extension \u8ba1\u7b97 class object size\u3002</li> </ul> <p><code>extensions_</code> \u5b57\u6bb5\uff08L432\uff09\uff1a - <code>std::array&lt;std::unique_ptr&lt;ClassLinkerExtension&gt;, LANG_COUNT&gt;</code>\uff1a\u6bcf\u79cd\u8bed\u8a00\u6700\u591a\u4e00\u4e2a extension\uff0c\u5b9e\u73b0\u201c\u8bed\u8a00\u65e0\u5173\u5bb9\u5668 + \u8bed\u8a00\u76f8\u5173\u7b56\u7565\u201d\u7684\u5206\u5c42\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#10-classinfo-l343l446","title":"10. \u52a0\u8f7d/\u94fe\u63a5/\u5e03\u5c40\uff1aClassInfo \u4e0e\u5185\u90e8\u7ba1\u7ebf\uff08L343\u2013L446\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#101-classinfol344l350","title":"10.1 <code>ClassInfo</code>\uff08L344\u2013L350\uff09","text":"<p>\u8fd9\u662f class linker \u5728\u6784\u5efa\u4e00\u4e2a\u7c7b\u65f6\u7684\u4e34\u65f6\u5de5\u4f5c\u5305\uff1a - <code>vtableBuilder</code> / <code>itableBuilder</code> / <code>imtableBuilder</code>\uff1a\u4e09\u7c7b\u6d3e\u53d1\u8868 builder - <code>size</code>\uff1a\u7c7b\u5bf9\u8c61 size\uff08\u901a\u5e38\u662f <code>Class::ComputeClassSize</code> \u7684\u7ed3\u679c + static field \u5e03\u5c40\uff09 - <code>numSfields</code>\uff1a\u9759\u6001\u5b57\u6bb5\u6570\u91cf\uff08\u7528\u4e8e\u628a fields span \u5207\u5206\u6210 static/instance\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#102-linkentitiesandinitclassl352l353","title":"10.2 <code>LinkEntitiesAndInitClass</code>\uff08L352\u2013L353\uff09","text":"<p>\u628a \u201c\u5b57\u6bb5/\u65b9\u6cd5/\u8868\u7ed3\u6784/\u7c7b\u72b6\u6001\u673a\u201d \u4e32\u6210\u6700\u7ec8\u53ef\u7528\u7684 <code>Class</code>\uff1a - \u5178\u578b\u5305\u542b\uff1aLinkFields/LinkMethods\u3001\u6d3e\u53d1\u8868\u6784\u5efa\u3001\u8bbe\u7f6e offsets\u3001\u53ef\u80fd\u89e6\u53d1 class init\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#103-fieldsmethods-l388l406","title":"10.3 Fields/Methods \u5206\u6bb5\uff08L388\u2013L406\uff09","text":"<p>\u51fd\u6570\u547d\u540d\u5df2\u7ecf\u628a\u7ba1\u7ebf\u62c6\u6210\u51e0\u6bb5\uff1a - <code>LoadFields/LoadMethods</code>\uff1a\u4ece panda_file accessor \u8bfb\u53d6\u5143\u6570\u636e\u5e76\u521b\u5efa <code>Field/Method</code> \u5bf9\u8c61\u6570\u7ec4 - <code>LinkFields/LinkMethods</code>\uff1a\u94fe\u63a5\u9636\u6bb5\uff08resolve type\u3001\u8ba1\u7b97 offset\u3001\u6784\u5efa\u6d3e\u53d1\u8868\u3001\u8bbe\u7f6e vtableIndex \u7b49\uff09 - <code>SetupClassInfo</code>\uff1a\u521b\u5efa/\u914d\u7f6e builders\u3001\u8ba1\u7b97 size/numSfields - <code>LayoutFields</code>\uff1a\u9759\u6001\u51fd\u6570\uff0c\u8ba1\u7b97 offset \u5e76\u5199\u5165 <code>Field::offset_</code>\uff08Field \u7684\u5951\u7ea6\u70b9\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#104-arrayunion-l363l371","title":"10.4 Array/Union \u7c7b\uff08L363\u2013L371\uff09","text":"<p>ClassLinker \u5185\u7f6e\u5bf9\u6570\u7ec4\u7c7b\u4e0e union \u7c7b\u7684\u52a0\u8f7d\u5165\u53e3\uff08\u4e0e <code>ClassHelper</code> \u7684 descriptor/union \u5de5\u5177\u76f8\u547c\u5e94\uff09\uff1a - <code>LoadArrayClass/LoadUnionClass</code> - <code>LoadConstituentClasses</code>\uff1a\u89e3\u6790 union constituent types - <code>CreateArrayClass/CreateUnionClass</code>\uff1a\u771f\u6b63\u521b\u5efa\u5408\u6210\u7c7b\u5bf9\u8c61</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#11-boot-class-filterbloomfilterl408l443","title":"11. Boot class filter\uff08BloomFilter\uff09\uff08L408\u2013L443\uff09","text":"<ul> <li><code>AddBootClassFilter</code>\uff1a\u628a boot files \u7684 class descriptor \u52a0\u5165 bloom filter\u3002</li> <li><code>LookupInFilter</code>\uff1a\u8fd4\u56de FilterResult\uff08DISABLED/POSSIBLY_HAS/IMPOSSIBLY_HAS\uff09\u3002</li> <li>\u5e38\u91cf\uff1a</li> <li><code>NUM_BOOT_CLASSES = 400000</code></li> <li><code>FILTER_RATE = 0.01</code></li> <li>\u5b57\u6bb5\uff1a</li> <li><code>bootClassFilter_</code> + <code>bootClassFilterLock_</code></li> </ul> <p>\u8fd9\u662f\u4e00\u79cd\u542f\u52a8\u4f18\u5316\uff1a\u5feb\u901f\u5224\u65ad\u67d0 descriptor \u201c\u4e0d\u53ef\u80fd\u5728 boot class \u4e2d\u201d\uff0c\u4ece\u800c\u51cf\u5c11\u67e5\u627e\u6210\u672c\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#12-classlinkererrorhandlerl448l458","title":"12. <code>ClassLinkerErrorHandler</code>\uff08L448\u2013L458\uff09","text":"<p>\u7eaf\u865a\u63a5\u53e3\uff1a - <code>OnError(error, message)</code>\uff1a\u7531\u4e0a\u5c42\u5b9e\u73b0\uff08Runtime/\u8bed\u8a00\u63d2\u4ef6/\u5de5\u5177\uff09\u51b3\u5b9a\u5982\u4f55\u5904\u7406\u9519\u8bef\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker.h/#13","title":"13. \u52a8\u6001\u7eb3\u5165\u7ed3\u679c\uff08\u672c\u6587\u4ef6\u5f15\u51fa\u7684\u540c\u7ae0\u5f3a\u76f8\u5173\u6587\u4ef6\uff09","text":"<p>\u672c\u6587\u4ef6\u76f4\u63a5\u5305\u542b/\u5f3a\u8026\u5408\u7684 03 \u7ae0\u6587\u4ef6 \u5df2\u5168\u90e8\u7eb3\u5165\u9010\u884c\uff08\u89c1 <code>03_ClassLoading/Manifests/files.yaml</code>\uff09\uff0c\u6838\u5fc3\u843d\u70b9\u5982\u4e0b\uff1a - <code>runtime/class_linker.cpp</code>\uff1aClassLinker \u4e3b\u5b9e\u73b0\uff08\u6309\u51fd\u6570\u7c07\u5206\u6bb5\u9010\u884c\uff09 - <code>runtime/include/class_linker_extension.h</code> + <code>runtime/class_linker_extension.cpp</code>\uff1aextension \u62bd\u8c61 + \u9ed8\u8ba4\u5b9e\u73b0\uff08Boot/AppContext/new/created/obsolete\uff09 - <code>runtime/core/core_class_linker_extension.cpp</code>\uff1acore\uff08PANDA_ASSEMBLY\uff09roots \u81ea\u4e3e + CreateClass - <code>runtime/include/itable_builder.h</code>\u3001<code>runtime/include/imtable_builder.h</code>\u3001<code>runtime/imtable_builder.cpp</code>\uff1a\u63a5\u53e3\u6d3e\u53d1\u8868\u6784\u5efa\u4e0e IMT \u7b56\u7565 - <code>runtime/file_manager.*</code>\uff1a<code>.abc/.an</code> \u6587\u4ef6\u52a0\u8f7d\u4e0e\u6ce8\u518c\uff08AddPandaFile \u4e0a\u6e38\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/","title":"<code>runtime/include/class_linker_extension.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u8bed\u8a00\u63d2\u4ef6\u6269\u5c55\u70b9\uff08ClassLinkerExtension\uff09\uff1a\u5b9a\u4e49\u201c\u8bed\u8a00\u76f8\u5173\u7684 class \u521b\u5efa/\u6839\u7c7b\u521d\u59cb\u5316/\u4e0a\u4e0b\u6587\u7ba1\u7406/\u7c7b\u521d\u59cb\u5316\u7b56\u7565/GC roots \u679a\u4e3e\u201d\u3002 \u5173\u952e\u7ed3\u8bba\uff1a<code>ClassLinker</code> \u662f\u8bed\u8a00\u65e0\u5173\u7ba1\u7ebf\uff1bExtension \u51b3\u5b9a\u8bed\u8a00\u76f8\u5173\u7684\u521b\u5efa\u4e0e\u521d\u59cb\u5316\uff0c\u5e76\u4e14\u6301\u6709 BootContext/AppContext\uff08\u90fd\u662f <code>ClassLinkerContext</code> \u7684\u6d3e\u751f\uff09\u4f5c\u4e3a\u52a0\u8f7d\u57df\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#1-l18l30","title":"1. \u4f9d\u8d56\u4e0e\u5b9a\u4f4d\uff08L18\u2013L30\uff09","text":"<ul> <li>L18\uff1amutex\uff1aextension \u5185\u90e8\u7ef4\u62a4\u591a\u4e2a\u5217\u8868\u4e0e\u4e0a\u4e0b\u6587\u96c6\u5408\uff0c\u9700\u8981\u5e76\u53d1\u4fdd\u62a4\uff08\u591a\u5904\u7528 <code>RecursiveMutex</code>\uff09\u3002</li> <li>L19\u2013L20\uff1apanda_file File / EntityId\uff1aGetClass \u7b49 API \u9700\u8981\u6587\u4ef6\u5b9a\u4f4d\u3002</li> <li>L21\uff1a<code>runtime/class_linker_context.h</code>\uff1a\u4e0a\u4e0b\u6587\u672c\u4f53\uff08descriptor\u2192Class \u7f13\u5b58\u3001per-Class mutex\u3001roots\uff09\u3002</li> <li>L22\u2013L23\uff1a<code>class_root.h</code> / <code>class.h</code>\uff1aclass roots \u4e0e Class \u5143\u6570\u636e\u5bf9\u8c61\u3002</li> <li>L24\uff1apanda \u5bb9\u5668\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#2-l31l35","title":"2. \u7c7b\u6574\u4f53\u804c\u8d23\uff08L31\u2013L35\uff09","text":"<p>\u6ce8\u91ca\u660e\u786e\uff1a\u63d2\u4ef6\u5fc5\u987b\u7ee7\u627f\u5b83\uff0c\u4ee5\u5b9a\u4e49\u8bed\u8a00\u76f8\u5173\u7684\u7c7b\u64cd\u4f5c\uff1b\u5b9e\u4f8b\u7531 <code>ClassLinker</code> \u62e5\u6709\uff08\u6309\u8bed\u8a00 one-to-many \u5173\u7cfb\uff1aClassLinker \u6709\u4e00\u4e2a\u6570\u7ec4\uff0c\u67d0\u8bed\u8a00\u6700\u591a\u4e00\u4e2a extension\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#3-l38l47","title":"3. \u6784\u9020/\u521d\u59cb\u5316\u9636\u6bb5\uff08L38\u2013L47\uff09","text":"<ul> <li>L38\uff1a\u6784\u9020\u51fd\u6570\u8bb0\u5f55 <code>lang_</code>\uff0c\u5e76\u521d\u59cb\u5316 <code>bootContext_(this)</code>\uff1aboot context \u603b\u662f\u5b58\u5728\u3002</li> <li>L42\uff1a<code>Initialize(ClassLinker*, compressedStringEnabled)</code>\uff1aextension \u4e0e class linker \u7684\u7ed1\u5b9a\u5165\u53e3\uff08\u5b9e\u73b0\u4e0d\u5728\u5934\u6587\u4ef6\uff09\u3002</li> <li>L44\uff1a<code>InitializeFinish()</code>\uff1a\u4e8c\u9636\u6bb5\u6536\u5c3e\uff08\u901a\u5e38\u5728 roots \u5b8c\u6210\u540e\uff09\u3002</li> <li>L46\uff1a<code>InitializeRoots(thread)</code>\uff1a\u521d\u59cb\u5316 class roots\uff08Object/Class/String/Array/Primitive\u2026\uff09\uff0c\u5e76\u628a roots \u63d2\u5165 boot context\uff08\u89c1 <code>SetClassRoot</code>\uff09\u3002</li> </ul> <p>\u8fd9\u4e0e <code>ClassLinker::Initialize/InitializeRoots</code> \u7684\u4e24\u9636\u6bb5\u5b8c\u5168\u5bf9\u9f50\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#4-l48l86","title":"4. \u8bed\u8a00\u5fc5\u987b\u5b9e\u73b0\u7684\u6838\u5fc3\u865a\u63a5\u53e3\uff08L48\u2013L86\uff09","text":"<p>\u8fd9\u4e9b\u662f\u201c\u8bed\u8a00\u5dee\u5f02\u201d\u7684\u4e3b\u8981\u627f\u8f7d\u70b9\uff1a - \u7c7b\u521b\u5efa/\u91ca\u653e\uff1a   - <code>CreateClass(descriptor, vtableSize, imtSize, size)</code>\uff08L72\uff09   - <code>FreeClass(Class*)</code>\uff08L74\uff09 - \u7c7b\u521d\u59cb\u5316\uff1a   - <code>InitializeClass(Class*)</code>\uff08L76\uff09   - \u8fd8\u6709\u4e00\u4e2a\u5e26 errorHandler \u7684\u91cd\u8f7d\u9ed8\u8ba4\u8f6c\u53d1\uff08L78\u2013L81\uff09 - \u6570\u7ec4/union/\u5408\u6210\u7c7b\u521d\u59cb\u5316\uff1a   - <code>InitializeArrayClass(arrayClass, componentClass)</code>\uff08\u7eaf\u865a\uff0cL48\uff09   - <code>InitializeUnionClass</code> \u9ed8\u8ba4 false\uff08L50\u2013L54\uff09\uff0c\u53ea\u6709\u652f\u6301 union \u7684\u8bed\u8a00\u624d override   - <code>InitializeSyntheticClass/InitializePrimitiveClass</code>\uff08L56\u2013L58\uff09 - roots \u7684\u5e03\u5c40\u53c2\u6570\uff1a   - <code>GetClassVTableSize/GetClassIMTSize/GetClassSize</code>\uff08\u6309 ClassRoot\uff0cL60\u2013L64\uff09   - <code>GetArrayClassVTableSize/GetArrayClassIMTSize/GetArrayClassSize</code>\uff08L66\u2013L70\uff09 - native \u6865\u63a5\u5951\u7ea6\uff1a   - <code>GetNativeEntryPointFor(Method*)</code>\uff08L83\uff09\uff1anative \u65b9\u6cd5\u5165\u53e3\u70b9\u7531\u8bed\u8a00\u51b3\u5b9a\uff08ETS/JS/\u2026\uff09   - <code>CanThrowException/IsMethodNativeApi/IsNecessarySwitchThreadState/CanNativeMethodUseObjects</code>\uff08L85\u2013L100\uff09\uff1anative \u8c03\u7528\u65f6\u7ebf\u7a0b\u72b6\u6001\u5207\u6362\u3001\u5bf9\u8c61\u53ef\u7528\u6027\u7b49\u7b56\u7565\u5f00\u5173 - \u9519\u8bef\u5904\u7406\uff1a   - <code>GetErrorHandler()</code>\uff08L102\uff09\uff1aextension \u63d0\u4f9b\u9ed8\u8ba4\u9519\u8bef\u5904\u7406\u5668\uff08ClassLinker \u5728\u67d0\u4e9b\u8def\u5f84\u4f1a\u7528\u5b83\u515c\u5e95\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#5-context-bootcontext-appcontextl303l360","title":"5. Context \u7ba1\u7406\uff1aBootContext + AppContext\uff08L303\u2013L360\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#51-bootcontextl303l322","title":"5.1 BootContext\uff08L303\u2013L322\uff09","text":"<p>BootContext \u662f <code>ClassLinkerContext</code> \u7684\u6d3e\u751f\u7c7b\uff0c\u4e14\u4e0e extension \u7ed1\u5b9a\uff1a - L305\u2013L308\uff1a\u6784\u9020\u65f6\u628a SourceLang \u8bbe\u4e3a extension \u8bed\u8a00\u3002 - L310\u2013L313\uff1a<code>IsBootContext()</code> \u8fd4\u56de true\uff08\u914d\u5408 ClassLinker \u7684 boot fast-path \u4e0e bloom filter\uff09\u3002 - L315\u2013L316\uff1a<code>LoadClass(descriptor, needCopyDescriptor, errorHandler)</code> override\uff1aboot \u7684\u52a0\u8f7d\u7b97\u6cd5\u7531 extension \u5b9a\u4e49\uff08\u4e00\u822c\u4f1a\u59d4\u6258 ClassLinker \u5728 boot files \u4e2d\u67e5\u627e/\u52a0\u8f7d\uff09\u3002 - L318\uff1a<code>EnumeratePandaFiles(cb)</code> override\uff1a\u679a\u4e3e boot panda files\uff08\u6765\u6e90\u901a\u5e38\u662f ClassLinker \u6ce8\u518c\u7684 boot files + extension \u79c1\u6709\u8d44\u6e90\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#52-appcontextl324l360","title":"5.2 AppContext\uff08L324\u2013L360\uff09","text":"<p>AppContext \u4e5f\u662f <code>ClassLinkerContext</code> \u6d3e\u751f\u7c7b\uff0c\u6301\u6709\u4e00\u7ec4 <code>pfs_</code>\uff08\u8be5 context \u5173\u8054\u7684 panda files\uff09\uff1a - L331\u2013L332\uff1a<code>LoadClass</code> override\uff1a\u5e94\u7528\u7c7b\u52a0\u8f7d\u7b97\u6cd5\uff08\u901a\u5e38\u53ea\u5728 pfs_ \u5185\u67e5\u627e\uff0c\u627e\u4e0d\u5230\u53ef\u80fd\u8d70 parent chain \u6216\u5931\u8d25\uff09\u3002 - L334\u2013L344\uff1a<code>EnumeratePandaFiles(cb)</code>\uff1a\u904d\u5386 pfs_ \u8c03 cb\u3002 - L346\u2013L355\uff1a<code>GetPandaFilePaths()</code>\uff1a\u8fd4\u56de pfs_ \u6587\u4ef6\u540d\uff0c\u7528\u4e8e AOT class context/\u8c03\u8bd5 dump\u3002</p> <p>\u5bf9\u9f50 <code>ClassLinker::GetClass</code>\uff1a\u975e boot context \u60c5\u51b5\u4e0b\u4f1a\u76f4\u63a5 <code>context-&gt;LoadClass</code>\uff0c\u6240\u4ee5 AppContext \u7684 override \u662f\u201c\u5e94\u7528\u52a0\u8f7d\u7b97\u6cd5\u201d\u7684\u5173\u952e\u843d\u70b9\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#6-roots-bootcontext-l111l125","title":"6. roots \u4e0e bootContext \u63d2\u5165\uff08L111\u2013L125\uff09","text":"<ul> <li>L111\u2013L114\uff1a<code>GetClassRoot(root)</code>\uff1a\u4ece <code>classRoots_</code> \u6570\u7ec4\u53d6\u3002</li> <li>L116\u2013L119\uff1a<code>GetBootContext()</code>\uff1a\u8fd4\u56de <code>bootContext_</code> \u5730\u5740\u3002</li> <li>L121\u2013L125\uff1a<code>SetClassRoot(root, klass)</code>\uff1a</li> <li>\u5199\u5165 <code>classRoots_[root]</code></li> <li>\u5173\u952e\uff1a<code>bootContext_.InsertClass(klass)</code>\uff1aroots \u4e00\u5b9a\u5c5e\u4e8e boot context\uff0c\u5e76\u4e14\u4f1a\u8fdb\u5165 <code>loadedClasses_</code>\uff08descriptor\u2192Class\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#7-getclass-apiextension-l127l150","title":"7. GetClass API\uff1aextension \u4f5c\u4e3a\u201c\u8bed\u8a00\u5165\u53e3\u201d\uff08L127\u2013L150\uff09","text":"<ul> <li>L127\uff1a<code>FindLoadedClass(descriptor, context)</code>\uff1a\u5728\u6307\u5b9a context\uff08\u82e5\u4e3a\u7a7a\u4e00\u822c\u4f1a resolve \u5230 boot\uff09\u91cc\u67e5\u627e loaded class\u3002</li> <li>L129\u2013L135\uff1a\u4e24\u5957 <code>GetClass</code> \u5bfc\u51fa API\uff1a</li> <li><code>(descriptor, needCopyDescriptor=true, context=nullptr, errorHandler=nullptr)</code></li> <li><code>(pf,id, context=nullptr, errorHandler=nullptr)</code></li> </ul> <p>\u8fd9\u4e9b\u901a\u5e38\u4f1a\u59d4\u6258 <code>classLinker_</code> \u7684\u540c\u540d\u65b9\u6cd5\uff1b\u4f46 extension \u53ef\u4ee5\u5728\u5176\u4e2d\u51b3\u5b9a context \u7684 resolve\uff08\u89c1 <code>ResolveContext</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#8-gc-roots-creatednewbootappobsoletel157l224","title":"8. GC roots \u679a\u4e3e\u8bed\u4e49\uff1acreated/new/boot/app/obsolete\uff08L157\u2013L224\uff09","text":"<p>\u8fd9\u662f\u672c\u6587\u4ef6\u6700\u201c\u5bb9\u6613\u88ab\u5ffd\u7565\u4f46\u5f88\u5173\u952e\u201d\u7684\u90e8\u5206\uff1aextension \u7ef4\u62a4\u4e86\u591a\u4e2a class \u5217\u8868\uff0c\u7528\u4e8e\u4e0d\u540c GC root \u8bbf\u95ee\u7b56\u7565\uff1a</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#81-recordnewclass_-l157l172","title":"8.1 recordNewClass_ \u5f00\u5173\uff08L157\u2013L172\uff09","text":"<ul> <li><code>RecordNewRoot(flags)</code>\uff1a\u5904\u7406 <code>VisitGCRootFlags::{START_RECORDING_NEW_ROOT, END_RECORDING_NEW_ROOT}</code>\uff1a</li> <li>START\uff1a<code>recordNewClass_=true</code>\uff08seq_cst\uff09</li> <li>END\uff1a<code>recordNewClass_=false</code>\uff08seq_cst\uff09\u5e76\u6e05\u7a7a <code>newClasses_</code>\uff08\u53d7 <code>newClassesLock_</code>\uff09</li> </ul> <p>\u7528\u9014\uff1aGC \u53ef\u4ee5\u9009\u62e9\u4ec5\u8bbf\u95ee\u201c\u81ea\u4e0a\u6b21\u8bb0\u5f55\u4ee5\u6765\u65b0\u521b\u5efa\u7684\u7c7b\u201d\uff0c\u51cf\u5c11 STW/\u5e76\u53d1 root \u626b\u63cf\u6210\u672c\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#82-enumerateclassescb-flagsl174l224","title":"8.2 <code>EnumerateClasses(cb, flags)</code>\uff08L174\u2013L224\uff09","text":"<p>\u6309 flags \u7ec4\u5408\u679a\u4e3e\uff1a - \u82e5 ACCESS_ROOT_ALL \u6216 ACCESS_ROOT_ONLY_NEW\uff1a   - \u5148\u679a\u4e3e <code>createdClasses_</code>\uff08createdClassesLock_\uff09 - \u82e5 ACCESS_ROOT_ONLY_NEW\uff1a   - \u518d\u679a\u4e3e <code>newClasses_</code>\uff08newClassesLock_\uff09 - \u82e5 ACCESS_ROOT_ALL\uff1a   - \u679a\u4e3e <code>bootContext_</code> \u7684 loadedClasses_   - \u679a\u4e3e\u6240\u6709\u6ce8\u518c\u7684 <code>contexts_</code>\uff08contextsLock_\uff09\uff0c\u5bf9\u6bcf\u4e2a context \u8c03 <code>ctx-&gt;EnumerateClasses</code> - \u65e0\u8bba flags\uff1a\u6700\u540e\u90fd\u4f1a\u679a\u4e3e <code>obsoleteClasses_</code>\uff08obsoleteClassesLock_\uff09 - \u672b\u5c3e <code>RecordNewRoot(flags)</code>\uff0c\u628a START/END \u7684\u8bed\u4e49\u5185\u805a\u5728\u540c\u4e00\u5904</p> <p>\u7ed3\u8bba\uff1aClassLinker \u5728 GC \u65f6\u8c03\u7528 <code>ext-&gt;EnumerateClasses</code>\uff0c\u53ef\u4ee5\u7cbe\u786e\u63a7\u5236\u201c\u626b\u5168\u90e8 / \u53ea\u626b\u65b0\u7c7b / \u4e0d\u626b\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#9-l226l249","title":"9. \u4e0a\u4e0b\u6587\u6ce8\u518c\u4e0e\u679a\u4e3e\uff08L226\u2013L249\uff09","text":"<ul> <li><code>RegisterContext(fn)</code>\uff1a\u5728 <code>contextsLock_</code> \u4e0b\u628a fn() \u8fd4\u56de\u7684 context push \u5230 <code>contexts_</code>\u3002</li> <li><code>EnumerateContexts(cb)</code>\uff1a\u5148\u56de\u8c03 bootContext_\uff0c\u518d\u5728\u9501\u4e0b\u904d\u5386 contexts_\u3002</li> </ul> <p>\u8fd9\u4e0e <code>ClassLinker::EnumerateContexts</code>/<code>EnumerateContextsForDump</code> \u7684\u5b9e\u73b0\u5b8c\u5168\u5bf9\u9f50\uff1aClassLinker \u53ea\u662f\u201c\u904d\u5386 extension\uff0c\u518d\u904d\u5386 extension \u5185\u90e8 contexts\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#10-resolvecontext-onclasspreparedobsoletel255l269","title":"10. ResolveContext \u4e0e OnClassPrepared/obsolete\uff08L255\u2013L269\uff09","text":"<ul> <li><code>ResolveContext(context)</code>\uff1a\u82e5\u4f20\u5165 nullptr\uff0c\u7edf\u4e00\u56de\u9000\u5230 <code>bootContext_</code>\uff08L255\u2013L262\uff09\u3002</li> <li><code>OnClassPrepared(Class*)</code>\uff1a\u7531 ClassLinker \u5728 class \u63d2\u5165 context \u540e\u8c03\u7528\uff08\u89c1 <code>ClassLinker::RemoveCreatedClassInExtension</code>\uff09\uff0cextension \u5728\u8fd9\u91cc\u901a\u5e38\u4f1a\uff1a</li> <li>\u628a class \u4ece <code>createdClasses_</code> \u79fb\u9664</li> <li>\u5982\u5f00\u542f recordNewClass_\uff0c\u628a class \u653e\u5230 <code>newClasses_</code></li> <li>\u4ee5\u53ca\u53ef\u80fd\u505a\u8bed\u8a00\u4fa7\u7684\u989d\u5916 bookkeeping</li> <li><code>AddObsoleteClass/FreeObsoleteData</code>\uff1a\u70ed\u91cd\u8f7d/\u66ff\u6362\u65e7\u7c7b\u540e\uff0c\u628a\u65e7\u6570\u636e\u4fdd\u7559\u5230 <code>obsoleteClasses_</code>\uff0c\u786e\u4fdd\u4ecd\u53ef\u6267\u884c\uff08\u6ce8\u91ca L266\u2013L268\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#11-l282l400","title":"11. \u4fdd\u62a4\u65b9\u6cd5\u4e0e\u5185\u90e8\u7ed3\u6784\uff08L282\u2013L400\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#111-root-l283l288","title":"11.1 Root \u521d\u59cb\u5316\u8f85\u52a9\uff08L283\u2013L288\uff09","text":"<p><code>InitializePrimitiveClassRoot / InitializeArrayClassRoot / InitializeSyntheticClassRoot</code>\uff1a\u628a\u5404\u79cd roots \u4ee5\u7edf\u4e00\u6a21\u5f0f\u521b\u5efa\u5e76\u585e\u5230 classRoots_\uff08\u5b9e\u73b0\u4e0d\u5728\u5934\u6587\u4ef6\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#112-creatednewobsolete-l289l298","title":"11.2 created/new/obsolete \u7684\u7ef4\u62a4\uff08L289\u2013L298\uff09","text":"<ul> <li><code>FreeLoadedClasses()</code>\uff1a\u91ca\u653e\u5df2\u52a0\u8f7d\u7c7b\uff08\u901a\u5e38\u7528\u4e8e\u9500\u6bc1/\u91cd\u7f6e\uff09\u3002</li> <li><code>AddClass</code>\uff1a\u628a class \u52a0\u5165\u5230\u5408\u9002\u96c6\u5408\uff08\u5e76\u53ef\u80fd\u63d2\u5165 context\uff09\u3002</li> <li><code>AddCreatedClass</code>\uff1a\u4ec5\u52a0\u5165 created list\uff08\u201c\u521a\u521b\u5efa\u3001\u672a\u63d2\u5165 context\u201d\u9636\u6bb5\uff09\u3002</li> <li><code>RemoveCreatedClass</code>\uff1a\u5f53 class \u5df2\u63d2\u5165 context \u540e\uff0c\u4ece created list \u79fb\u9664\u3002</li> </ul> <p>\u5bf9\u9f50 <code>ClassLinker::LoadClass</code>\uff1a\u5728 <code>context-&gt;InsertClass</code> \u6210\u529f\u540e\uff0c\u4f1a\u8c03\u7528 <code>ext-&gt;OnClassPrepared</code>\uff0c\u8fd9\u91cc\u5c31\u662f created\u2192(new?) \u7684\u8fc1\u79fb\u70b9\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#113-createapplicationclasslinkercontextl299l301","title":"11.3 CreateApplicationClassLinkerContext\uff08L299\u2013L301\uff09","text":"<p>\u4e24\u5c42\uff1a - public <code>CreateApplicationClassLinkerContext(path)</code>\uff08L104\uff09\u8fd4\u56de <code>ClassLinkerContext*</code> - protected <code>CreateApplicationClassLinkerContext(PandaVector&lt;PandaFilePtr&gt;&amp;&amp;)</code>\uff08L300\uff09\u7528\u4e8e\u201c\u5df2\u6253\u5f00 panda files\u201d\u76f4\u63a5\u6784\u9020 AppContext</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_class_linker_extension.h/#114-l380l399","title":"11.4 \u79c1\u6709\u5b57\u6bb5\uff08L380\u2013L399\uff09","text":"<ul> <li><code>lang_</code>\uff1a\u8bed\u8a00</li> <li><code>bootContext_</code>\uff1aboot context\uff08\u5f3a\u7ed1\u5b9a\uff09</li> <li><code>classRoots_</code>\uff1aroots \u6570\u7ec4\uff08CLASS_ROOT_COUNT\uff09</li> <li><code>classLinker_</code>\uff1a\u56de\u6307 ClassLinker\uff08Initialize \u540e\u7f6e\u4f4d\uff09</li> <li><code>contexts_</code>\uff1a\u5df2\u6ce8\u518c\u7684 app contexts</li> <li><code>createdClasses_</code>\uff1a\u521a\u521b\u5efa/\u5f85\u63d2\u5165 context \u7684\u7c7b</li> <li><code>recordNewClass_ + newClasses_</code>\uff1a\u8bb0\u5f55\u201c\u65b0\u6839\u7c7b\u201d\u7684\u589e\u91cf\u5217\u8868</li> <li><code>obsoleteClasses_</code>\uff1a\u70ed\u66f4\u4fdd\u7559\u65e7\u7c7b</li> <li><code>canInitializeClasses_</code>\uff1a\u662f\u5426\u5141\u8bb8\u521d\u59cb\u5316\uff08\u7531 Initialize/InitializeFinish \u51b3\u5b9a\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/","title":"<code>runtime/include/field.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u8fd0\u884c\u65f6 <code>Field</code> \u5143\u6570\u636e\u5bf9\u8c61\uff08\u5b57\u6bb5\u540d/\u7c7b\u578b/\u8bbf\u95ee\u6807\u5fd7/\u5bf9\u8c61\u5e03\u5c40 offset/\u6240\u5c5e\u7c7b\u6307\u9488\u7f16\u7801\uff09\u3002 \u6587\u4ef6\u7279\u70b9\uff1a\u5b9e\u73b0\u975e\u5e38\u77ed\uff0c\u4f46\u5b83\u5b9a\u4e49\u4e86\u201c\u5b57\u6bb5\u7c7b\u578b\u5982\u4f55\u7f16\u7801\u201d\u201c\u5b57\u6bb5 offset \u7531\u8c01\u5199\u5165\u201d\u201c\u5982\u4f55\u4ece Field \u53cd\u67e5 type class\u201d\u7684\u5173\u952e\u5951\u7ea6\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#1-field-classloading","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08Field \u5728 ClassLoading \u94fe\u8def\u91cc\u7684\u4f5c\u7528\uff09","text":"<p><code>Class</code> \u805a\u5408 <code>Field* fields_</code> \u5e76\u628a\u5b57\u6bb5\u6309\u9759\u6001/\u5b9e\u4f8b\u5206\u533a\u3002<code>Field</code> \u9700\u8981\u63d0\u4f9b\uff1a - \u8eab\u4efd\uff1a<code>fileId_</code>\uff08panda_file::EntityId\uff09 - \u8bbf\u95ee\u63a7\u5236/\u4fee\u9970\u7b26\uff1a<code>accessFlags_</code>\uff08\u542b public/private/static/volatile/final/readonly\u2026\uff09 - \u5b57\u6bb5\u7c7b\u578b\uff1a\u901a\u8fc7 <code>accessFlags_</code> \u7684\u4e00\u4e2a\u4f4d\u6bb5\u7f16\u7801 <code>TypeId</code>\uff08\u800c\u4e0d\u662f\u5355\u72ec\u5b57\u6bb5\uff09 - \u5e03\u5c40 offset\uff1a<code>offset_</code>\uff0c\u7528\u4e8e\u5bf9\u8c61\u5b57\u6bb5\u8bbf\u95ee/\u9759\u6001\u5b57\u6bb5\u533a\u8bbf\u95ee - \u6240\u5c5e\u7c7b\uff1a<code>classWord_</code>\uff08\u7528 <code>ClassHelper::ClassWordSize</code> \u5b58\u50a8\uff0c\u9002\u914d\u538b\u7f29\u6307\u9488\u6a21\u578b\uff09</p> <p>\u4ea4\u53c9\u5f15\u7528\uff1a - \u5b57\u6bb5\u8bbf\u95ee\u5b9e\u9645\u8bfb\u5199\uff08\u542b\u5c4f\u969c/\u539f\u5b50\uff09\uff1a\u5728 <code>Class::GetFieldObject/SetFieldObject</code>\uff08<code>class-inl.h</code>\uff09\u91cc\u901a\u8fc7 <code>ObjectAccessor</code> \u5b9e\u73b0\uff08\u8de8\u7ae0 Memory\uff09\u3002 - \u5b57\u6bb5 offset \u7684\u6765\u6e90\uff1a\u5728 <code>runtime/class_linker.cpp</code> \u7684 <code>LayoutFields/LinkFields</code> \u9636\u6bb5\u5199\u5165\uff08\u89c1 FileNotes/runtime_class_linker.cpp \u7684\u5b57\u6bb5\u5e03\u5c40\u6bb5\u843d\uff09\u3002  </p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#2-l1l35","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L35\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_FIELD_H_</code>\u3002</li> <li>L18\u2013L20\uff1a<code>&lt;cstdint&gt;/&lt;atomic&gt;</code>\uff1a\u672c\u6587\u4ef6\u81ea\u8eab\u5b57\u6bb5\u6ca1\u6709\u539f\u5b50\uff0c\u4f46\u4f9d\u8d56\u94fe\u4e2d\u53ef\u80fd\u9700\u8981\uff08\u4ee5\u53ca\u4e0e compiler_interface \u7b49\u4ea4\u53c9\uff09\u3002</li> <li>L21\uff1a<code>intrinsics_enum.h</code>\uff1a\u53ef\u80fd\u7528\u4e8e\u7f16\u8bd1/\u4f18\u5316\u76f8\u5173\u7684\u5b57\u6bb5\u5904\u7406\uff08\u672c\u6587\u4ef6\u672a\u76f4\u63a5\u4f7f\u7528\u7b26\u53f7\uff09\u3002</li> <li>L22\u2013L24\uff1a<code>libarkfile/*</code>\uff1a<code>File/EntityId/modifiers</code>\uff08ACC_*\u3001EntityId\uff09\u3002</li> <li>L25\uff1a<code>compiler_interface.h</code>\uff1a\u7f16\u8bd1\u5668\u4ea4\u4e92\uff08\u672c\u6587\u4ef6\u672a\u5c55\u5f00\uff0c\u4f46\u5c5e\u4e8e\u8fd0\u884c\u65f6\u5143\u6570\u636e\u901a\u7528\u4f9d\u8d56\uff09\u3002</li> <li>L26\uff1a<code>class_helper.h</code>\uff1a<code>ClassWordSize</code> \u4e0e <code>ToObjPtrType</code> \u7684\u6307\u9488\u6a21\u578b\u9002\u914d\u3002</li> <li>L27\uff1a<code>value-inl.h</code>\uff1a\u503c\u7c7b\u578b\u5de5\u5177\uff08\u672c\u6587\u4ef6\u672a\u76f4\u63a5\u4f7f\u7528\uff0c\u4f46\u5e38\u89c1\u4e8e\u5143\u6570\u636e\u5934\u7684\u901a\u7528\u4f9d\u8d56\uff09\u3002</li> <li>L28\uff1a<code>macros.h</code>\uff1a<code>PANDA_PUBLIC_API/MEMBER_OFFSET/NO_COPY_SEMANTIC</code> \u7b49\u3002</li> <li>L30\uff1a<code>namespace ark {</code>\u3002</li> <li>L32\u2013L35\uff1a\u524d\u5411\u58f0\u660e <code>Class</code> \u4e0e <code>ClassLinkerErrorHandler</code>\uff08ResolveTypeClass \u9700\u8981\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#3-field-l36l166","title":"3. <code>Field</code> \u7c7b\uff08L36\u2013L166\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#31-type-accessflagsl40l44","title":"3.1 \u6784\u9020\u51fd\u6570\uff1a\u628a Type \u7f16\u7801\u8fdb accessFlags\uff08L40\u2013L44\uff09","text":"<pre><code>Field(Class *klass, EntityId fileId, uint32_t accessFlags, panda_file::Type type)\n</code></pre> <ul> <li>L41\uff1a<code>classWord_</code> \u5b58\u6240\u5c5e\u7c7b\u6307\u9488\uff08\u901a\u8fc7 <code>ToObjPtrType(klass)</code> \u518d cast \u5230 <code>ClassWordSize</code>\uff09\u3002</li> <li>L41\u2013L42\uff1a\u4fdd\u5b58 <code>fileId_</code>\u3002</li> <li>L43\uff1a\u5173\u952e\uff1a<code>accessFlags_ = accessFlags | (type.GetEncoding() &lt;&lt; ACC_TYPE_SHIFT)</code>\uff1a</li> <li><code>type.GetEncoding()</code> \u4ea7\u751f\u4e00\u4e2a <code>TypeId</code> \u7684\u7f16\u7801\u503c\uff1b</li> <li>\u901a\u8fc7 <code>ACC_TYPE_SHIFT</code> \u5de6\u79fb\u585e\u5165 <code>accessFlags_</code> \u7684\u201c\u7c7b\u578b\u4f4d\u6bb5\u201d\uff1b</li> <li>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 <code>Field</code> \u6ca1\u6709\u5355\u72ec\u7684 <code>type_</code> \u5b57\u6bb5\uff1a\u7c7b\u578b\u4e0e\u4fee\u9970\u7b26\u5171\u7528\u4e00\u4e2a word\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#32-getset-offset-l46l59","title":"3.2 \u6240\u5c5e\u7c7b\uff1aGet/Set + offset \u66b4\u9732\uff08L46\u2013L59\uff09","text":"<ul> <li>L46\u2013L49\uff1a<code>GetClass()</code>\uff1a\u628a <code>classWord_</code> reinterpret \u6210 <code>Class*</code>\u3002</li> <li>L51\u2013L54\uff1a<code>SetClass(Class*)</code>\uff1a\u6309\u540c\u6837\u65b9\u5f0f\u5199\u5165 <code>classWord_</code>\u3002</li> <li>L56\u2013L59\uff1a<code>GetClassOffset()</code>\uff1a\u66b4\u9732 <code>classWord_</code> \u5b57\u6bb5\u504f\u79fb\uff08\u4f9b\u5feb\u8def\u5f84/\u53cd\u5c04\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#33-panda_file-getpandafile-getfileidl61l66","title":"3.3 panda_file \u8eab\u4efd\uff1aGetPandaFile / GetFileId\uff08L61\u2013L66\uff09","text":"<ul> <li>L61\uff1a<code>GetPandaFile()</code>\uff1a\u5bfc\u51fa API\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\uff0c\u901a\u5e38\u4f1a\u901a\u8fc7 <code>GetClass()-&gt;GetPandaFile()</code> \u6216 ClassLinker \u67e5\u627e\u3002</li> <li>L63\u2013L66\uff1a<code>GetFileId()</code>\uff1a\u8fd4\u56de <code>fileId_</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#34-accessflags-offsetl68l86","title":"3.4 accessFlags \u4e0e offset\uff08L68\u2013L86\uff09","text":"<ul> <li>L68\u2013L71\uff1a<code>GetAccessFlags()</code>\uff1a\u8fd4\u56de <code>accessFlags_</code>\uff08\u6ce8\u610f\uff1a\u7c7b\u578b\u4f4d\u6bb5\u4e5f\u5305\u542b\u5728\u5176\u4e2d\uff09\u3002</li> <li>L73\u2013L76\uff1a<code>GetOffset()</code>\uff1a\u8fd4\u56de <code>offset_</code>\u3002</li> <li>L78\u2013L81\uff1a<code>SetOffset(offset)</code>\uff1a\u5199 <code>offset_</code>\uff08\u8c01\u8c03\u7528\uff1f\u901a\u5e38\u662f class linker \u5728\u5e03\u5c40\u8ba1\u7b97\u540e\u5199\u5165\uff09\u3002</li> <li>L83\u2013L86\uff1a<code>GetOffsetOffset()</code>\uff1a\u66b4\u9732 <code>offset_</code> \u5b57\u6bb5\u504f\u79fb\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#35-resolvetypeclass-gettypeidl88l99","title":"3.5 \u5b57\u6bb5\u7c7b\u578b\u89e3\u6790\uff1aResolveTypeClass / GetTypeId\uff08L88\u2013L99\uff09","text":"<ul> <li>L88\uff1a<code>ResolveTypeClass(errorHandler)</code>\uff1a\u5bfc\u51fa API\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\uff1a</li> <li>\u8bed\u4e49\uff1a\u628a\u5b57\u6bb5\u7c7b\u578b\uff08primitive/reference/array/union \u7b49\uff09\u89e3\u6790\u6210 <code>Class*</code>\u3002</li> <li>\u5931\u8d25\u65f6\u901a\u8fc7 <code>ClassLinkerErrorHandler</code> \u4e0a\u62a5\u3002</li> <li>L90\u2013L93\uff1a<code>GetType()</code>\uff1a<code>panda_file::Type(GetTypeId())</code>\u3002</li> <li>L95\u2013L98\uff1a<code>GetTypeId()</code>\uff1a\u4ece <code>accessFlags_</code> \u7684\u7c7b\u578b\u4f4d\u6bb5\u89e3\u7801\uff1a</li> <li><code>(accessFlags_ &amp; ACC_TYPE) &gt;&gt; ACC_TYPE_SHIFT</code></li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#36-name-l100l140","title":"3.6 name \u4e0e\u8bbf\u95ee\u8c13\u8bcd\uff08L100\u2013L140\uff09","text":"<ul> <li>L100\u2013L103\uff1a<code>GetAccessFlagsOffset()</code>\uff1a\u66b4\u9732 <code>accessFlags_</code> \u5b57\u6bb5\u504f\u79fb\u3002</li> <li>L105\uff1a<code>GetName()</code>\uff1a\u5bfc\u51fa API\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\uff0c\u901a\u5e38\u4ece panda_file \u7684 field item \u4e2d\u53d6\u5b57\u7b26\u4e32\u3002</li> <li>L107\u2013L140\uff1a\u4e00\u7ec4\u8c13\u8bcd\uff1a</li> <li><code>IsPublic/IsPrivate/IsProtected/IsStatic/IsVolatile/IsFinal/IsReadonly</code></li> <li>\u5747\u4e3a <code>accessFlags_ &amp; ACC_*</code> \u5224\u5b9a\uff08\u6ce8\u610f\uff1a\u7c7b\u578b\u4f4d\u6bb5\u5171\u5b58\u4f46\u4e0d\u5f71\u54cd\u8fd9\u4e9b\u4f4d\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#37-iduniqidl142l154","title":"3.7 \u552f\u4e00 id\uff1a<code>UniqId</code>\uff08L142\u2013L154\uff09","text":"<ul> <li>L142\u2013L149\uff1a<code>CalcUniqId(file, fileId)</code>\uff1a</li> <li><code>file-&gt;GetFilenameHash()</code> \u5de6\u79fb 32 bit\uff0c\u518d OR <code>fileId offset</code>\u3002</li> <li>L151\u2013L154\uff1a<code>GetUniqId()</code>\uff1a\u7528 <code>GetPandaFile()</code> \u4e0e <code>fileId_</code> \u8ba1\u7b97\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#38-l156l160","title":"3.8 \u751f\u547d\u5468\u671f\u4e0e\u4e0d\u53ef\u62f7\u8d1d\uff08L156\u2013L160\uff09","text":"<ul> <li>\u9ed8\u8ba4\u6790\u6784\u3002</li> <li><code>NO_COPY_SEMANTIC/NO_MOVE_SEMANTIC</code>\uff1aField \u4f5c\u4e3a\u5143\u6570\u636e\u5bf9\u8c61\u4e0d\u5141\u8bb8\u62f7\u8d1d/\u79fb\u52a8\uff08\u4fdd\u6301\u5730\u5740\u7a33\u5b9a\uff0c\u4f9b\u5404\u79cd\u7f13\u5b58/\u7d22\u5f15\u5f15\u7528\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_field.h/#39-l161l166","title":"3.9 \u79c1\u6709\u5b57\u6bb5\u5e03\u5c40\uff08L161\u2013L166\uff09","text":"<ul> <li>classWord_\uff1a\u6240\u5c5e\u7c7b\u6307\u9488\u7684 word \u8868\u793a\uff08\u4e0e\u6307\u9488\u6a21\u578b\u76f8\u5173\uff09\u3002</li> <li>fileId_\uff1apanda_file \u4e2d\u7684\u5b57\u6bb5\u5b9e\u4f53 id\u3002</li> <li>accessFlags_\uff1a\u4fee\u9970\u7b26 + type \u4f4d\u6bb5\u3002</li> <li>offset_\uff1a\u5e03\u5c40 offset\uff08\u9ed8\u8ba4 0\uff0c\u521d\u59cb\u5316\u540e\u5fc5\u987b\u7531 linker \u5199\u5165\u6b63\u786e\u503c\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_file_manager.h/","title":"<code>runtime/include/file_manager.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aFileManager API \u58f0\u660e\uff1a\u8d1f\u8d23\u628a <code>.abc</code>\uff08panda file\uff09\u4e0e <code>.an</code>\uff08AOT \u6587\u4ef6\uff09\u52a0\u8f7d\u8fdb Runtime/ClassLinker/AotManager\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_file_manager.h/#1-l16l22","title":"1. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L16\u2013L22\uff09","text":"<ul> <li>L16\u2013L17\uff1ainclude guard\uff1a<code>PANDA_FILE_MANAGER_H_</code>\u3002</li> <li>L19\uff1a<code>libarkfile/file.h</code>\uff1apanda file open \u63a5\u53e3\u4e0e\u7c7b\u578b\u5b9a\u4e49\u3002</li> <li>L20\uff1a<code>runtime/compiler.h</code>\uff1a\u63d0\u4f9b <code>Expected&lt;bool, std::string&gt;</code> \u7b49\u7f16\u8bd1/\u8fd0\u884c\u65f6\u6865\u63a5\u7c7b\u578b\uff08\u4ee5\u53ca AOT \u76f8\u5173\u63a5\u53e3\uff09\u3002</li> <li>L21\uff1a<code>panda_string.h</code>\uff1a\u7528\u4e8e\u62fc\u8def\u5f84\u4e0e\u8fd4\u56de\u524d\u7f00\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_file_manager.h/#2-filemanager-apil25l35","title":"2. <code>FileManager</code> \u7684\u804c\u8d23\u4e0e API\uff08L25\u2013L35\uff09","text":"<ul> <li>L27\uff1a<code>LoadAbcFile(location, openMode)</code>\uff1a</li> <li>\u6253\u5f00 <code>.abc</code> \u5e76\u6ce8\u518c\u5230 <code>Runtime::GetCurrent()-&gt;GetClassLinker()-&gt;AddPandaFile(...)</code>\uff08\u5b9e\u73b0\u5728 <code>.cpp</code>\uff09\u3002</li> <li>L29\uff1a<code>TryLoadAnFileForLocation(abcPath)</code>\uff1a</li> <li>\u7ed9\u5b9a <code>.abc</code> \u8def\u5f84\uff0c\u63a8\u5bfc\u540c\u540d <code>.an</code> \u5e76\u5c1d\u8bd5\u52a0\u8f7d\uff08\u4f18\u5148 boot-an-location\uff09\u3002</li> <li>L31\u2013L32\uff1a<code>TryLoadAnFileFromLocation(anFileLocation, abcFilePrefix, pandaFileLocation)</code>\uff1a</li> <li>\u5728\u6307\u5b9a\u76ee\u5f55\u4e0b\u62fc <code>.an</code> \u6587\u4ef6\u5e76\u5c1d\u8bd5\u52a0\u8f7d\uff1b\u6210\u529f\u4e0e\u5426\u8fd4\u56de bool\u3002</li> <li>L34\uff1a<code>LoadAnFile(anLocation, force=false)</code>\uff1a</li> <li>\u901a\u8fc7 <code>AotManager::AddFile(...)</code> \u52a0\u8f7d <code>.an</code>\uff0c\u8fd4\u56de Expected\uff08\u643a\u5e26\u9519\u8bef\u5b57\u7b26\u4e32\uff09\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aFileManager \u662f\u201c\u6587\u4ef6\u2192ClassLinker/AotManager\u201d\u7684 glue layer\uff1a - <code>.abc</code> \u8d70 <code>AddPandaFile</code>\uff08\u89e6\u53d1 boot/filter/notification/debug\uff09 - <code>.an</code> \u8d70 <code>AotManager::AddFile</code> \u5e76\u53ef\u56de\u586b class hash table \u7ed9 panda file\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/","title":"<code>runtime/include/imtable_builder.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a<code>IMTableBuilder</code> \u58f0\u660e\uff1a\u4ece <code>ITable</code> \u6784\u5efa IMT\uff08Interface Method Table\uff09\uff0c\u5e76\u5199\u56de <code>Class</code>\u3002 \u8bf4\u660e\uff1a\u5177\u4f53\u7b97\u6cd5\u5728 <code>runtime/imtable_builder.cpp</code>\uff08\u672c\u6587\u4ef6\u4ec5\u58f0\u660e\u63a5\u53e3\u4e0e\u5b57\u6bb5\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#1-l18l22","title":"1. \u4f9d\u8d56\u4e0e\u5b9a\u4f4d\uff08L18\u2013L22\uff09","text":"<ul> <li>L19\uff1a<code>class_data_accessor.h</code>\uff1a\u4ece panda_file \u7684\u63a5\u53e3\u65b9\u6cd5\u679a\u4e3e\u4fe1\u606f\u6784\u5efa IMT\uff08\u63a5\u53e3/\u7c7b\u4e24\u79cd Build overload\uff09\u3002</li> <li>L20\uff1a<code>class-inl.h</code>\uff1a\u5199\u56de <code>Class</code> \u7684 IMT \u533a\u57df\uff08<code>klass-&gt;GetIMT()</code>/offset \u7b49\uff09\u9700\u8981 inline \u8bbf\u95ee\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#2-imtablebuilder-l27l59","title":"2. <code>IMTableBuilder</code> \u7684\u804c\u8d23\uff08L27\u2013L59\uff09","text":"<p>IMT \u7684\u4f5c\u7528\uff1a\u4e3a\u63a5\u53e3\u8c03\u7528\u63d0\u4f9b\u4e00\u4e2a\u201c\u5feb\u901f\u54c8\u5e0c\u8868/\u7d22\u5f15\u8868\u201d\uff0c\u907f\u514d\u6bcf\u6b21\u904d\u5386 itable\u3002\u5927\u81f4\u6d41\u7a0b\uff1a - Build\uff1a\u904d\u5386 itable \u7684\u63a5\u53e3\u65b9\u6cd5\uff0c\u628a\u6bcf\u4e2a\u65b9\u6cd5\u6309\u67d0\u79cd id/hash \u653e\u5165 IMT \u7684\u69fd\u4f4d\uff1b - UpdateClass\uff1a\u628a IMT \u5199\u5165 <code>Class</code>\uff08\u5185\u5b58\u4f4d\u4e8e Class object \u7684 IMT \u533a\u95f4\uff09\uff1b - Dump\uff1a\u8c03\u8bd5\u8f93\u51fa\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#3-api","title":"3. API \u9010\u9879\u89e3\u91ca","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#31-oversize_multiplel29","title":"3.1 OVERSIZE_MULTIPLE\uff08L29\uff09","text":"<p><code>OVERSIZE_MULTIPLE = 2</code>\uff1a\u6784\u5efa IMT \u65f6\u53ef\u80fd\u4f1a\u628a\u8868\u5927\u5c0f\u6269\u5927\u4e00\u5b9a\u500d\u6570\u4ee5\u964d\u4f4e\u51b2\u7a81\uff08\u5177\u4f53\u7b56\u7565\u89c1 <code>.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#32-buildl31l34","title":"3.2 Build\uff08L31\u2013L34\uff09","text":"<p>\u4e24\u79cd\u5165\u53e3\uff1a - <code>Build(const ClassDataAccessor *cda, ITable itable)</code>\uff1a\u4ece panda_file \u7684 class \u4fe1\u606f + itable \u6784\u5efa\uff08\u7528\u4e8e\u6b63\u5e38\u52a0\u8f7d\u8def\u5f84\uff09\u3002 - <code>Build(ITable itable, bool isInterface)</code>\uff1a\u4ece\u5df2\u6784\u9020\u7684 itable + \u662f\u5426\u63a5\u53e3\u6784\u5efa\uff08\u7528\u4e8e <code>BuildClass</code> \u7b49\u5408\u6210\u7c7b\u8def\u5f84\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#33-updateclassl35","title":"3.3 UpdateClass\uff08L35\uff09","text":"<p>\u628a\u6784\u5efa\u7ed3\u679c\u5199\u56de klass\uff08\u901a\u5e38\u5305\u542b\uff1a\u5199 <code>imtSize_</code>\u3001\u628a <code>Method*</code> \u586b\u5165 <code>klass-&gt;GetIMT()</code> \u7684 span\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#34-addmethodl37","title":"3.4 AddMethod\uff08L37\uff09","text":"<p>\u628a\u67d0\u4e2a\u63a5\u53e3\u65b9\u6cd5\u52a0\u5165 imtable\uff1a - <code>imtable</code>\uff1a\u76ee\u6807 span\uff08Method \u6570\u7ec4\uff09   - <code>imtableSize</code>\uff1a\u69fd\u6570\u91cf   - <code>id</code>\uff1a\u65b9\u6cd5 id/hash   - <code>method</code>\uff1a\u5b9e\u9645 Method\uff08\u591a\u4e3a\u63a5\u53e3\u65b9\u6cd5\u6216\u5176\u89e3\u6790\u540e\u7684\u5b9e\u73b0\uff09 \u8fd4\u56de bool\uff1a\u901a\u5e38\u8868\u793a\u662f\u5426\u6210\u529f\u653e\u5165/\u662f\u5426\u9700\u8981\u6269\u8868\uff08\u5177\u4f53\u903b\u8f91\u89c1 <code>.cpp</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#35-getset-imtsizel41l49","title":"3.5 Get/Set IMTSize\uff08L41\u2013L49\uff09","text":"<p><code>imtSize_</code> \u662f builder \u7684\u5185\u90e8\u72b6\u6001\uff0c\u6700\u7ec8\u4f1a\u7528\u4e8e\u5199\u56de Class \u7684 IMT \u533a\u57df\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_imtable_builder.h/#4-l57l59","title":"4. \u79c1\u6709\u5b57\u6bb5\uff08L57\u2013L59\uff09","text":"<ul> <li><code>imtSize_</code>\uff1aIMT \u5927\u5c0f\uff08\u69fd\u6570\u91cf\uff09\uff0c\u9ed8\u8ba4 0\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/","title":"<code>runtime/include/itable.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u63a5\u53e3\u6d3e\u53d1\u8868\uff08ITable\uff09\u2014\u2014\u201c\u63a5\u53e3 -&gt; \u65b9\u6cd5\u6570\u7ec4\u201d\u7684\u6620\u5c04\u5bb9\u5668\u3002 \u4f7f\u7528\u4f4d\u7f6e\uff1a<code>Class::ResolveVirtualMethod</code> \u7684 itable \u5206\u652f\u3001vtable builder \u7684 default \u65b9\u6cd5\u904d\u5386\uff08<code>AddDefaultInterfaceMethods</code>\uff09\u7b49\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#1-itable","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08ITable \u5728\u6d3e\u53d1\u94fe\u8def\u91cc\u7684\u804c\u8d23\uff09","text":"<p>\u5f53 <code>Class::ResolveVirtualMethod</code> \u89e3\u6790\u201c\u63a5\u53e3\u65b9\u6cd5\u5728\u5f53\u524d\u7c7b\u7684\u5b9e\u73b0\u201d\u65f6\uff1a</p> <ul> <li>\u9996\u5148\u5c1d\u8bd5 IMT\uff08<code>GetIMT()</code>\uff0c\u69fd\u4f4d\u547d\u4e2d\u5219\u76f4\u63a5\u8fd4\u56de\uff09\u3002</li> <li>\u82e5 IMT miss\uff0c\u5219\u8fdb\u5165 ITable\uff1a</li> <li>\u5728 <code>ITable</code> \u4e2d\u627e\u5230\u76ee\u6807\u63a5\u53e3 <code>Entry</code>\uff08\u6309 <code>entry.GetInterface()</code> \u5339\u914d\uff09</li> <li>\u518d\u7528 <code>method-&gt;GetVTableIndex()</code> \u5728 <code>entry.GetMethods()</code> \u4e2d\u7d22\u5f15\u5230\u8be5\u63a5\u53e3\u65b9\u6cd5\u5bf9\u5e94\u7684\u5b9e\u73b0\u3002</li> </ul> <p>\u56e0\u6b64 ITable \u7684\u6838\u5fc3\u5951\u7ea6\u662f\uff1a - <code>Entry.interface_</code>\uff1a\u6307\u5411\u63a5\u53e3 <code>Class*</code> - <code>Entry.methods_</code>\uff1a\u4e00\u4e2a <code>Span&lt;Method*&gt;</code>\uff0c\u957f\u5ea6\u81f3\u5c11\u8986\u76d6\u63a5\u53e3\u7684\u201c\u865a\u65b9\u6cd5\u69fd\u4f4d\u6570\u201d\uff08\u5373\u63a5\u53e3\u4e2d non-static \u65b9\u6cd5\u88ab\u8d4b\u4e88\u7684 vtable_index\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#2-l1l25","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L25\uff09","text":"<ul> <li>L1\u2013L14\uff1aLicense\u3002</li> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_ITABLE_H_</code>\u3002</li> <li>L18\uff1a<code>span.h</code>\uff1a<code>Span&lt;T&gt;</code> \u5bb9\u5668\uff08<code>methods_</code> \u4e0e <code>elements_</code> \u90fd\u662f Span\uff09\u3002</li> <li>L19\uff1a<code>allocator.h</code>\uff1a<code>mem::InternalAllocatorPtr</code>\uff08\u7528\u4e8e Entry::Copy \u5206\u914d method \u6570\u7ec4\uff09\u3002</li> <li>L21\uff1a<code>namespace ark {</code>\u3002</li> <li>L23\u2013L24\uff1a\u524d\u5411\u58f0\u660e <code>Class</code> \u4e0e <code>Method</code>\uff08Entry/ITable \u90fd\u53ea\u6301\u6307\u9488\u6216 span\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#3-itableentryl26l71","title":"3. <code>ITable::Entry</code>\uff08L26\u2013L71\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#31-setgetinterface-methodsl30l48","title":"3.1 Set/Get\uff1ainterface \u4e0e methods\uff08L30\u2013L48\uff09","text":"<ul> <li>L30\u2013L33\uff1a<code>SetInterface(Class*)</code>\uff1a\u5199\u5165 <code>interface_</code>\u3002</li> <li>L35\u2013L38\uff1a<code>GetInterface()</code>\uff1a\u8fd4\u56de <code>interface_</code>\u3002</li> <li>L40\u2013L43\uff1a<code>SetMethods(Span&lt;Method*&gt;)</code>\uff1a\u5199\u5165 <code>methods_</code>\uff08\u4e0d\u62f7\u8d1d\uff09\u3002</li> <li>L45\u2013L48\uff1a<code>GetMethods()</code>\uff1a\u8fd4\u56de <code>methods_</code>\uff08span \u89c6\u56fe\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#32-entry-copyinternalallocatorptrl50l61","title":"3.2 \u6df1\u62f7\u8d1d\uff1a<code>Entry Copy(InternalAllocatorPtr)</code>\uff08L50\u2013L61\uff09","text":"<p>\u8be5\u51fd\u6570\u5b9a\u4e49\u4e86 Entry \u7684\u6df1\u62f7\u8d1d\u8bed\u4e49\uff1a - L52\u2013L53\uff1a\u65b0\u5efa\u5c40\u90e8 <code>Entry entry</code>\uff0c\u590d\u5236 <code>interface_</code>\u3002 - L54\u2013L59\uff1a\u82e5 <code>methods_.data() != nullptr</code>\uff1a   - L55\uff1a\u4e3a <code>methods_.size()</code> \u5206\u914d <code>Method*</code> \u6570\u7ec4\uff1a<code>allocator-&gt;AllocArray&lt;Method*&gt;(n)</code>   - \u6784\u9020 span\uff1a<code>{ptr, size}</code>   - L56\u2013L58\uff1a\u9010\u9879\u590d\u5236\u6307\u9488\u3002 - L60\uff1a\u8fd4\u56de\u65b0 entry\uff08\u62e5\u6709\u72ec\u7acb\u7684 <code>methods_</code> \u6570\u7ec4\uff09\u3002</p> <p>\u6ce8\u610f\uff1a\u8fd9\u610f\u5473\u7740 ITable \u7684 elements_ \u53ef\u80fd\u88ab\u590d\u5236\uff08\u4f8b\u5982\u7c7b\u590d\u5236/\u955c\u50cf/\u7279\u6b8a runtime \u884c\u4e3a\uff09\uff0c\u4e14 methods span \u7684 ownership \u7531 allocator \u63d0\u4f9b\u7684\u5185\u5b58\u7ba1\u7406\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#33-getinterfaceoffsetl63l66","title":"3.3 \u504f\u79fb\u66b4\u9732\uff1a<code>GetInterfaceOffset</code>\uff08L63\u2013L66\uff09","text":"<ul> <li>\u7528 <code>MEMBER_OFFSET(Entry, interface_)</code> \u66b4\u9732\u5b57\u6bb5\u504f\u79fb\uff1a</li> <li>\u7528\u9014\uff1a\u6c47\u7f16\u5feb\u8def\u5f84/\u53cd\u5c04/\u8c03\u8bd5\u5de5\u5177\u76f4\u63a5\u8bbf\u95ee layout\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#34-entry-l68l71","title":"3.4 Entry \u5b57\u6bb5\uff08L68\u2013L71\uff09","text":"<ul> <li>L69\uff1a<code>interface_</code>\uff1a\u63a5\u53e3\u7c7b\u6307\u9488\u3002</li> <li>L70\uff1a<code>methods_</code>\uff1a<code>Span&lt;Method*&gt;</code>\uff0c\u9ed8\u8ba4 <code>{nullptr, nullptr}</code>\uff08\u7a7a span\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#4-itablel73l126","title":"4. <code>ITable</code>\uff08L73\u2013L126\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#41-l73l100","title":"4.1 \u6784\u9020\u4e0e\u57fa\u672c\u8bbf\u95ee\uff08L73\u2013L100\uff09","text":"<ul> <li>L73\uff1a\u9ed8\u8ba4\u6784\u9020\uff1aelements_ \u4e3a\u7a7a\u3002</li> <li>L75\uff1a<code>ITable(Span&lt;Entry&gt; elements)</code>\uff1a\u4fdd\u5b58 span\uff08\u4e0d\u62f7\u8d1d\uff09\u3002</li> <li>L77\u2013L85\uff1a<code>Get()</code>\uff1a</li> <li>\u975e const\uff1a\u8fd4\u56de <code>Span&lt;Entry&gt;</code>\uff08\u53ef\u4fee\u6539 entries\uff09\u3002</li> <li>const\uff1a\u8fd4\u56de <code>Span&lt;const Entry&gt;</code>\uff08\u53ea\u8bfb\u89c6\u56fe\uff09\u3002</li> <li>L87\u2013L90\uff1a<code>Size()</code>\uff1aentries \u6570\u91cf\u3002</li> <li>L92\u2013L100\uff1a<code>operator[]</code>\uff1a\u6309\u4e0b\u6807\u8bbf\u95ee entry\uff08const/\u975e const\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#42-l102l105","title":"4.2 \u62f7\u8d1d/\u79fb\u52a8\u8bed\u4e49\uff08L102\u2013L105\uff09","text":"<ul> <li>\u9ed8\u8ba4\u6790\u6784\u3002</li> <li><code>DEFAULT_COPY_SEMANTIC/DEFAULT_MOVE_SEMANTIC</code>\uff1a</li> <li>\u8fd9\u610f\u5473\u7740 ITable \u672c\u8eab\u662f\u201c\u8f7b\u91cf span \u5305\u88c5\u201d\uff0c\u590d\u5236\u53ea\u590d\u5236 span \u6307\u9488\u4e0e size\uff1b</li> <li>\u771f\u6b63\u7684\u6df1\u62f7\u8d1d\u53ea\u53d1\u751f\u5728 <code>Entry::Copy</code> \u88ab\u663e\u5f0f\u8c03\u7528\u65f6\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#43-layout-l107l118","title":"4.3 layout \u504f\u79fb\u66b4\u9732\uff08L107\u2013L118\uff09","text":"<p>\u8fd9\u7ec4\u9759\u6001 constexpr \u7528\u4e8e\u201c\u4ece ITable \u5bf9\u8c61\u5730\u5740\uff0c\u76f4\u63a5\u5b9a\u4f4d entries \u7684 data/size\u201d\uff1a</p> <ul> <li>L107\u2013L110\uff1a<code>GetEntriesDataOffset()</code>\uff1a</li> <li><code>GetElementsOffset()</code>\uff08itable.elements_ \u5b57\u6bb5\u504f\u79fb\uff09</li> <li> <ul> <li><code>Span&lt;Entry&gt;::GetDataOffset()</code>\uff08span \u5185 data \u6307\u9488\u504f\u79fb\uff09</li> </ul> </li> <li>L111\u2013L114\uff1a<code>GetEntriesSizeOffset()</code>\uff1a</li> <li><code>GetElementsOffset()</code> + <code>Span&lt;Entry&gt;::GetSizeOffset()</code></li> <li>L115\u2013L118\uff1a<code>GetEntrySize()</code>\uff1a<code>sizeof(Entry)</code>\uff08\u4fbf\u4e8e\u904d\u5386/\u5e8f\u5217\u5316/\u8c03\u8bd5\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#44-l120l126","title":"4.4 \u79c1\u6709\u5b9e\u73b0\uff08L120\u2013L126\uff09","text":"<ul> <li>L121\u2013L124\uff1a<code>GetElementsOffset()</code>\uff1a<code>MEMBER_OFFSET(ITable, elements_)</code>\u3002</li> <li>L125\uff1a<code>elements_</code>\uff1a<code>Span&lt;Entry&gt;</code>\uff0c\u627f\u8f7d\u6240\u6709 entries\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable.h/#5-resolvevirtualmethod","title":"5. \u4e0e <code>ResolveVirtualMethod</code> \u7684\u5bf9\u9f50\u70b9\uff08\u5173\u952e\u5951\u7ea6\u590d\u8ff0\uff09","text":"<p><code>Class::ResolveVirtualMethod</code> \u7684 itable \u8def\u5f84\uff08\u89c1 <code>class-inl.h</code>\uff09\u5bf9 ITable \u7684\u4f9d\u8d56\u5982\u4e0b\uff1a - <code>for (size_t i = 0; i &lt; itable.Size(); i++)</code> - <code>auto &amp;entry = itable[i]</code> - <code>entry.GetInterface() == iface</code> - <code>entry.GetMethods()[method-&gt;GetVTableIndex()]</code></p> <p>\u56e0\u6b64\u6784\u5efa\u65f6\u5fc5\u987b\u4fdd\u8bc1\uff1a - \u5bf9\u6bcf\u4e2a\u5b9e\u73b0\u63a5\u53e3\u7684\u7c7b\uff0c<code>itable_</code> entries \u8986\u76d6\u6240\u6709\u63a5\u53e3\uff1b - <code>entry.methods_</code> \u7684\u957f\u5ea6\u4e0e\u7d22\u5f15\u89c4\u5219\u4e0e\u201c\u63a5\u53e3\u65b9\u6cd5\u7684 vtable_index \u5206\u914d\u89c4\u5219\u201d\u4e00\u81f4\uff08\u7531 vtable builder \u7684 <code>UpdateClass</code> \u5bf9\u63a5\u53e3\u65b9\u6cd5\u5199\u56de vtable_index \u6765\u4fdd\u8bc1\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable_builder.h/","title":"<code>runtime/include/itable_builder.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a<code>ITableBuilder</code> \u62bd\u8c61\u63a5\u53e3\uff08itable \u6784\u5efa/\u89e3\u6790/\u5199\u56de\uff09\uff1b\u672c\u6587\u4ef6\u53ea\u5b9a\u4e49\u5951\u7ea6\uff0c\u5177\u4f53\u7b97\u6cd5\u5728\u5b9e\u73b0\u7c7b\u4e2d\uff08\u52a8\u6001\u53d1\u73b0\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable_builder.h/#1-l18l22","title":"1. \u4f9d\u8d56\u4e0e\u5b9a\u4f4d\uff08L18\u2013L22\uff09","text":"<ul> <li>L19\uff1a<code>class_data_accessor-inl.h</code>\uff1a\u63a5\u53e3\u6784\u5efa\u53ef\u80fd\u76f4\u63a5\u679a\u4e3e panda_file \u7684 interface/method \u4fe1\u606f\u3002</li> <li>L20\uff1a<code>class-inl.h</code>\uff1a\u6784\u5efa/\u5199\u56de itable \u65f6\u9700\u8981 <code>Class</code> \u7684 inline \u65b9\u6cd5\uff08\u4f8b\u5982\u8bbf\u95ee\u63a5\u53e3\u5217\u8868\u3001itable setter \u7b49\uff09\u3002</li> <li>L21\uff1apanda smart pointers\uff1a\u5b9e\u73b0\u53ef\u80fd\u7528 <code>PandaUniquePtr</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable_builder.h/#2-itablebuilder-l27l46","title":"2. <code>ITableBuilder</code> \u63a5\u53e3\u5951\u7ea6\uff08L27\u2013L46\uff09","text":"<p>\u56db\u4e2a\u6838\u5fc3\u9636\u6bb5 + \u4e00\u4e2a\u6570\u636e\u51fa\u53e3\uff1a - Build\uff08L31\u2013L32\uff09\uff1a\u8f93\u5165 <code>ClassLinker*</code>\u3001<code>base</code>\u3001<code>classInterfaces</code>\u3001<code>isInterface</code>\uff0c\u6784\u5efa itable\uff08\u901a\u5e38\u5305\u542b\u7ee7\u627f/\u5408\u5e76\u63a5\u53e3\u5217\u8868\u3001\u9884\u5206\u914d\u8868\u7ed3\u6784\u7b49\uff09\u3002 - Resolve\uff08L34\uff09\uff1a\u5bf9\u5df2\u521b\u5efa\u7684 <code>klass</code> \u505a\u201c\u89e3\u6790\u201d\u6b65\u9aa4\uff08\u5178\u578b\uff1a\u628a\u63a5\u53e3\u65b9\u6cd5\u6620\u5c04\u5230\u5b9e\u9645\u5b9e\u73b0 Method\uff1b\u53ef\u80fd\u4f9d\u8d56\u5df2\u5efa\u597d\u7684 vtable\uff09\u3002 - UpdateClass\uff08L36\uff09\uff1a\u628a\u6784\u5efa/\u89e3\u6790\u7ed3\u679c\u5199\u56de <code>Class</code>\uff08\u5982\u8bbe\u7f6e <code>klass-&gt;SetITable(...)</code>\u3001\u4fee\u6b63 interfaces span\u3001\u6807\u8bb0 flags\uff09\u3002 - DumpITable\uff08L38\uff09\uff1a\u8c03\u8bd5\u8f93\u51fa\u3002 - GetITable*\uff08L40\uff09\uff1a\u5bfc\u51fa\u6784\u5efa\u51fa\u7684 <code>ITable</code>\uff08\u4f9b <code>VTableBuilder</code>/<code>IMTableBuilder</code>/ClassLinker \u4f7f\u7528\uff09\u3002</p> <p>\u7ea6\u675f\uff1a - L44\u2013L45\uff1a\u7981\u6b62 copy/move\uff08Builder \u4f5c\u4e3a\u4e00\u6b21\u6027\u6784\u5efa\u5bf9\u8c61\uff0c\u6301\u6709 arena/\u4e2d\u95f4\u72b6\u6001\uff09\u3002</p> <p>\u4e0e <code>class_linker.cpp</code> \u5bf9\u9f50\uff1a <code>SetupClassInfo</code> \u4e2d <code>itableBuilder-&gt;Build(...)</code> \u2192 <code>vtableBuilder-&gt;Build(..., itable)</code> \u2192 <code>imtableBuilder-&gt;Build(..., itable)</code>\uff0c <code>LinkMethods</code> \u4e2d <code>itableBuilder-&gt;Resolve(klass)</code> \u2192 <code>itableBuilder-&gt;UpdateClass(klass)</code>\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable_builder.h/#3-dummyitablebuilderl48l69","title":"3. <code>DummyITableBuilder</code>\uff08L48\u2013L69\uff09","text":"<p>\u63d0\u4f9b\u4e00\u4e2a\u201c\u7a7a\u5b9e\u73b0\u201d\u7528\u4e8e\u4e0d\u9700\u8981 itable \u7684\u8bed\u8a00/\u6a21\u5f0f\uff1a - Build/Resolve \u6052 true - Update/Dump \u7a7a - <code>GetITable()</code> \u8fd4\u56de\u7a7a <code>ITable()</code></p> <p>\u8fd9\u4e5f\u89e3\u91ca\u4e86\uff1aitable \u5728\u67d0\u4e9b\u8bed\u8a00/\u8fd0\u884c\u6a21\u5f0f\u4e0b\u53ef\u4ee5\u88ab\u7981\u7528\uff0c\u4f46 ClassLinker \u7ba1\u7ebf\u4ecd\u4fdd\u6301\u7edf\u4e00\u8c03\u7528\u7ed3\u6784\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_itable_builder.h/#4","title":"4. \u52a8\u6001\u53d1\u73b0\u70b9\uff08\u4e0b\u4e00\u6b65\uff09","text":"<p>\u672c\u5934\u6587\u4ef6\u672c\u8eab\u4e0d\u5305\u542b\u5b9e\u73b0\u7c7b\uff0c\u56e0\u6b64\u9700\u8981\u5728\u4ed3\u5e93\u91cc\u5b9a\u4f4d\uff1a - \u54ea\u4e9b concrete \u7c7b <code>: public ITableBuilder</code> - <code>LanguageContext::CreateITableBuilder</code> \u8fd4\u56de\u7684\u5177\u4f53\u5b9e\u73b0</p> <p>\u8fd9\u4e9b\u5b9e\u73b0\u6587\u4ef6\u4f1a\u88ab\u52a0\u5165 <code>03_ClassLoading/Manifests/files.yaml</code> \u5e76\u9010\u884c\u843d\u76d8\uff0c\u5f62\u6210 itable \u6784\u5efa\u7684\u5b8c\u6574\u95ed\u73af\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/","title":"<code>runtime/include/method.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u8fd0\u884c\u65f6 <code>Method</code> \u5143\u6570\u636e\u5bf9\u8c61\uff08\u7b7e\u540d/\u8bbf\u95ee\u6807\u5fd7/\u6d3e\u53d1\u7d22\u5f15/\u5165\u53e3\u70b9/\u70ed\u70b9\u4e0e\u9a8c\u8bc1\u72b6\u6001/ProfilingData \u590d\u7528\u6307\u9488\uff09 \u4ea4\u53c9\u4f9d\u8d56\uff1a\u6267\u884c\u5f15\u64ce\uff08\u89e3\u91ca\u5668/\u6865\u63a5/Frame\uff09\u4e0e Memory\uff08ObjectHeader/\u5c4f\u969c\uff09\u90fd\u88ab\u5b83\u76f4\u63a5 include\uff1b\u672c\u7ae0\u805a\u7126\u201c\u5951\u7ea6\u4e0e\u72b6\u6001\u201d\uff0c\u7ec6\u8282\u5b9e\u73b0\u5206\u522b\u8df3\u8f6c\u5230 04/02\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#1-method","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08Method \u5728\u8fd0\u884c\u65f6\u7c7b\u578b\u7cfb\u7edf\u91cc\u7684\u5730\u4f4d\uff09","text":"<p><code>Class</code> \u662f\u201c\u7c7b\u5143\u6570\u636e\u5bf9\u8c61\u201d\uff0c\u800c <code>Method</code> \u662f\u201c\u65b9\u6cd5\u5143\u6570\u636e\u5bf9\u8c61\u201d\u3002\u5b83\u9700\u8981\u540c\u65f6\u670d\u52a1\uff1a - \u7c7b\u94fe\u63a5\uff0803\uff09\uff1avtable/itable/IMT \u6784\u5efa\u4e0e\u6d3e\u53d1\u7d22\u5f15\uff08<code>vtableIndex</code>\uff09\u3001default interface method \u6807\u8bb0\u7b49\u3002 - \u6267\u884c\u5f15\u64ce\uff0804\uff09\uff1a\u89e3\u91ca\u5668\u4e0e\u7f16\u8bd1\u4ee3\u7801\u5165\u53e3\u70b9\u5207\u6362\uff08<code>compiledEntryPoint_</code>\uff09\u3001Invoke/InvokeDyn/InvokeContext\u3001Frame \u521b\u5efa\u4e0e\u9500\u6bc1\u3002 - JIT/PGO\uff0804/06\uff09\uff1ahotness counter\u3001profile saver \u89e6\u53d1\u3001ProfilingData \u6302\u8f7d\u3002 - \u9a8c\u8bc1\uff0806\uff09\uff1averification stage \u4f4d\u5b58\u50a8\u5728 <code>accessFlags_</code> \u7684 bitfield \u4e2d\u3002</p> <p>\u672c\u6587\u4ef6\u4e2d\u6700\u5173\u952e\u7684\u8bbe\u8ba1\u70b9\u662f\uff1a\u628a\u5927\u91cf\u72b6\u6001\u585e\u8fdb <code>accessFlags_</code> \u7684 bitfield + \u5c11\u91cf\u539f\u5b50\u6307\u9488\u7f13\u5b58\uff0c\u4ee5\u4fbf\u5728\u591a\u7ebf\u7a0b/\u591a\u6267\u884c\u6a21\u5f0f\u4e0b\u5feb\u901f\u8bfb\u5199\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#2-l1l64","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L64\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#l15l37include-guard","title":"L15\u2013L37\uff1ainclude guard \u4e0e\u4f9d\u8d56","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_METHOD_H_</code>\u3002</li> <li>L23\uff1a<code>intrinsics_enum.h</code>\uff1aintrinsic id\uff08JIT/\u89e3\u91ca\u5668\u7684\u5185\u5efa\u51fd\u6570\u8bc6\u522b\uff09\u3002</li> <li>L24\u2013L25\uff1aarch/logger\uff1a\u4e0e\u8fd0\u884c\u65f6\u65e5\u5fd7/\u5e73\u53f0\u76f8\u5173\u5de5\u5177\u3002</li> <li>L26\u2013L30\uff1a<code>libarkfile/*</code>\uff1a\u4ece panda_file \u8bfb\u53d6 code/method \u5143\u6570\u636e\uff08<code>CodeDataAccessor/MethodDataAccessor/modifiers</code>\uff09\u3002</li> <li>L31\uff1a<code>runtime/bridge/bridge.h</code>\uff1a\u83b7\u53d6 C2I bridge\uff1a<code>GetCompiledCodeToInterpreterBridge</code>/Dyn\uff08\u6267\u884c\u5f15\u64ce\u4f9d\u8d56\u70b9\uff09\u3002</li> <li>L32\uff1a<code>compiler_interface.h</code>\uff1a\u4e0e\u7f16\u8bd1\u5668\u4ea4\u4e92\uff08\u5165\u53e3\u70b9\u8bbe\u7f6e\u7b49\uff09\u3002</li> <li>L33\uff1a<code>class_helper.h</code>\uff1a<code>ClassWordSize/OBJECT_POINTER_SIZE</code> \u7b49\uff08\u6307\u9488\u6a21\u578b\uff09\u3002</li> <li>L34\u2013L35\uff1aarena \u5bb9\u5668\u4e0e\u667a\u80fd\u6307\u9488\u3002</li> <li>L36\uff1a<code>interpreter/frame.h</code>\uff1aFrame \u7ed3\u6784\u4e0e <code>Frame::GetAllocSize</code>\uff08\u6267\u884c\u5f15\u64ce\u4f9d\u8d56\u70b9\uff09\u3002</li> <li>L37\uff1a<code>value.h</code>\uff1a\u9759\u6001\u8bed\u8a00\u8c03\u7528\u7684 <code>Value</code> \u53c2\u6570/\u8fd4\u56de\u503c\u7c7b\u578b\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#l41l54accvregistert","title":"L41\u2013L54\uff1aAccVRegisterT \u6761\u4ef6\u7c7b\u578b\u522b\u540d","text":"<ul> <li>L45\u2013L54\uff1a\u5728 <code>PANDA_ENABLE_GLOBAL_REGISTER_VARIABLES</code> \u6253\u5f00\u65f6\uff0c\u4f7f\u7528\u4e0d\u540c\u7684 accumulator \u7c7b\u578b\u522b\u540d <code>AccVRegisterT</code>\uff08\u4e3a\u6027\u80fd/ABI \u4f18\u5316\u505a\u5f00\u5173\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#l56l64framedeleter","title":"L56\u2013L64\uff1aFrameDeleter","text":"<ul> <li>L56\u2013L64\uff1a<code>FrameDeleter</code> \u662f\u4e00\u4e2a\u6301\u6709 <code>ManagedThread*</code> \u7684\u81ea\u5b9a\u4e49 deleter\uff0c\u7528\u4e8e <code>PandaUniquePtr&lt;Frame, FrameDeleter&gt;</code> \u5728\u9000\u51fa\u65f6\u91ca\u653e frame\uff08\u5176 operator() \u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#3-methodproto-methodprotoidl84l172","title":"3. <code>Method::Proto</code> / <code>Method::ProtoId</code>\uff08L84\u2013L172\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#31-proto","title":"3.1 Proto\uff1a\u65b9\u6cd5\u7b7e\u540d\u7684\u201c\u5c55\u5f00\u7248\u672c\u201d","text":"<ul> <li>L84\u2013L137\uff1a<code>class Proto</code>\uff1a</li> <li><code>ShortyVector</code>\uff1a<code>panda_file::Type</code> \u5e8f\u5217\uff08shorty[0] \u662f\u8fd4\u56de\u7c7b\u578b\uff09\u3002</li> <li><code>RefTypeVector</code>\uff1a\u5f15\u7528\u7c7b\u578b\u7684 descriptor \u5b57\u7b26\u4e32\u89c6\u56fe\uff08\u4e0e shorty \u4e2d REFERENCE \u5bf9\u5e94\u4f4d\u7f6e\u5173\u8054\uff09\u3002</li> <li><code>Proto(pf, protoId)</code>\uff1a\u53ef\u4ece panda_file \u7684 proto item \u6784\u5efa\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\u3002</li> <li><code>GetReturnType()</code>\uff1a\u8fd4\u56de shorty_[0]\uff08\u7ea6\u5b9a\uff1ashorty \u7684\u7b2c 0 \u4f4d\u662f\u8fd4\u56de\u503c\u7c7b\u578b\uff09\u3002</li> <li><code>GetReturnTypeDescriptor()</code>\u3001<code>GetSignature()</code>\uff1a\u5bfc\u51fa API\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\u3002</li> <li>\u5177\u5907 copy/move \u8bed\u4e49\uff0c\u4fbf\u4e8e\u4f5c\u4e3a\u503c\u5bf9\u8c61\u4f7f\u7528\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#32-protoid","title":"3.2 ProtoId\uff1a\u7b7e\u540d\u7684\u201c\u60f0\u6027\u6807\u8bc6\u7248\u672c\u201d","text":"<ul> <li>L139\u2013L172\uff1a<code>class ProtoId</code>\uff1a</li> <li>\u6301\u6709 <code>const panda_file::File&amp;</code> \u4e0e <code>EntityId protoId_</code>\u3002</li> <li><code>operator==(ProtoId)</code>/<code>operator==(Proto)</code>\uff1a\u5141\u8bb8\u628a ProtoId \u4e0e Proto \u6216\u5176\u4ed6 ProtoId \u6bd4\u8f83\uff08\u6bd4\u8f83\u89c4\u5219\u7531\u5b9e\u73b0\u51b3\u5b9a\uff0c\u901a\u5e38\u4f1a\u89e3\u6790 proto item\uff09\u3002</li> <li>\u8bbe\u8ba1\u610f\u56fe\uff1a\u5728\u4e0d\u5c55\u5f00 shorty/refTypes \u7684\u60c5\u51b5\u4e0b\uff0c\u4ee5\u8f7b\u91cf id \u8868\u793a\u7b7e\u540d\uff08\u88ab vtable builder \u7528\u4e8e override/compat \u5224\u65ad\uff09\u3002</li> <li>\u7981\u6b62 copy operator \u4e0e move\uff08\u4fdd\u7559\u5f15\u7528\u8bed\u4e49\uff1b\u4f46\u5141\u8bb8 copy ctor\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#4-method-l174l209","title":"4. Method \u7684\u6784\u9020\u4e0e\u62f7\u8d1d\u6784\u9020\uff08L174\u2013L209\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#41-l174l176","title":"4.1 \u4e3b\u6784\u9020\u51fd\u6570\uff08L174\u2013L176\uff09","text":"<p><code>Method(Class *klass, const File *pf, EntityId fileId, EntityId codeId, accessFlags, numArgs, shorty)</code>\uff1a - \u628a\u201c\u5f52\u5c5e\u7c7b/\u6587\u4ef6\u5b9a\u4f4d/code \u5b9a\u4f4d/\u8bbf\u95ee\u6807\u5fd7/\u53c2\u6570\u4e2a\u6570/shorty\u201d\u7ed1\u5b9a\u5230 method \u5bf9\u8c61\u4e0a\u3002 - \u5177\u4f53\u521d\u59cb\u5316\u7ec6\u8282\u5728\u5b9e\u73b0\u5904\u9010\u884c\u786e\u8ba4\uff08\u4e0d\u5728\u672c\u5934\u6587\u4ef6\u8303\u56f4\u5185\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#42-explicit-methodconst-methodl178l208","title":"4.2 \u62f7\u8d1d\u6784\u9020\uff08\u53ea\u5141\u8bb8 <code>explicit Method(const Method*)</code>\uff09\uff08L178\u2013L208\uff09","text":"<p>\u8fd9\u91cc\u7684\u62f7\u8d1d\u6784\u9020\u975e\u5e38\u5173\u952e\uff1a\u5b83\u5c55\u793a\u4e86 Method \u7684\u591a\u7ebf\u7a0b\u5185\u5b58\u5e8f\u5951\u7ea6\u3002</p> <ul> <li>L180\u2013L183\uff1a\u4ee5 <code>memory_order_acquire</code> \u8bfb\u53d6 <code>accessFlags_</code>\uff0c\u786e\u4fdd\u4f9d\u8d56\u4e8e flags \u7684\u5176\u5b83\u8bfb\u53d6\u5728 acquire \u4e4b\u540e\u53ef\u89c1\u3002</li> <li>L186\u2013L190\uff1a\u6d45\u62f7\u8d1d <code>pandaFile_ / fileId_ / codeId_ / shorty_ / saverTryCounter_</code>\u3002</li> <li>L193\u2013L196\uff1a\u590d\u5236 <code>nativePointer</code>\uff08relaxed\uff09\uff0c\u56e0\u4e3a\u540e\u7eed\u4f1a\u505a release store\uff08compiledEntryPoint_\uff09\u6765\u53d1\u5e03\u5fc5\u8981\u4f9d\u8d56\u3002</li> <li>L198\u2013L202\uff1a\u8bbe\u7f6e <code>compiledEntryPoint_</code>\uff1a</li> <li>native \u65b9\u6cd5\uff1a\u590d\u7528\u539f <code>GetCompiledEntryPoint()</code>\uff1b</li> <li>\u975e native\uff1a\u91cd\u7f6e\u4e3a <code>GetCompiledCodeToInterpreterBridge(method)</code>\uff08\u5373\u9ed8\u8ba4\u8d70\u89e3\u91ca\u5668\u6865\u63a5\u5165\u53e3\uff09\u3002</li> <li>\u4f7f\u7528 <code>memory_order_release</code> \u53d1\u5e03\u3002</li> <li>L204\u2013L206\uff1a\u628a <code>numVregs_</code> \u4e0e <code>instructions_</code> \u4ee5 release \u53d1\u5e03\uff08\u4e3a\u5e76\u53d1\u8bfb\u7f13\u5b58\u63d0\u4f9b\u540c\u6b65\u70b9\uff09\u3002</li> <li>L207\uff1a\u521d\u59cb\u5316\u7f16\u8bd1\u72b6\u6001\u4e3a <code>NOT_COMPILED</code>\uff08\u5199\u5165 accessFlags bitfield\uff09\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aMethod \u7684\u62f7\u8d1d\u4e0d\u662f\u201c\u7b80\u5355 memcpy\u201d\uff0c\u800c\u662f\u6309\u8bbf\u95ee\u6807\u5fd7/\u5165\u53e3\u70b9/\u7f13\u5b58\u5b57\u6bb5\u7684\u5e76\u53d1\u7ea6\u675f\u8fdb\u884c\u91cd\u5efa\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#5-code-getnumvregs-getinstructionsl222l259","title":"5. code \u7f13\u5b58\uff1a<code>GetNumVregs</code> / <code>GetInstructions</code>\uff08L222\u2013L259\uff09","text":"<p>\u8fd9\u4e24\u8005\u90fd\u662f\u201c\u60f0\u6027\u521d\u59cb\u5316\u7f13\u5b58\u201d\uff1a - GetNumVregs\uff1a   - \u82e5 <code>codeId_</code> \u65e0\u6548 \u2192 0   - acquire \u8bfb <code>numVregs_</code>\uff0c\u82e5\u4e3a <code>NUM_VREGS_UNKNOWN</code> \u5219\u4ece <code>CodeDataAccessor::GetNumVregs</code> \u8bfb\u53d6\u5e76\u4ee5 release \u5199\u56de\u3002 - GetInstructions\uff1a   - \u82e5 <code>codeId_</code> \u65e0\u6548 \u2192 nullptr   - acquire \u8bfb <code>instructions_</code>\uff0c\u82e5\u4e3a\u7a7a\u5219\u4ece <code>CodeDataAccessor::GetInstructions</code> \u8bfb\u53d6\u5e76\u4ee5 release \u5199\u56de\u3002</p> <p>\u8fd9\u5957\u6a21\u5f0f\u786e\u4fdd\uff1a\u5e76\u53d1\u7ebf\u7a0b\u8bfb\u53d6\u540c\u4e00\u4e2a Method \u7684\u6307\u4ee4/\u5bc4\u5b58\u5668\u6570\u65f6\u4e0d\u4f1a\u6570\u636e\u7ade\u4e89\uff0c\u540c\u65f6\u907f\u514d\u6bcf\u6b21\u90fd\u8bbf\u95ee panda_file\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#6-invoke-l261l318","title":"6. Invoke \u7cfb\u5217\uff08L261\u2013L318\uff09","text":"<p>\u672c\u6bb5\u5b9a\u4e49\u4e86 Method \u4f5c\u4e3a\u201c\u53ef\u6267\u884c\u5b9e\u4f53\u201d\u7684\u51e0\u79cd\u5165\u53e3\uff08\u5b9e\u73b0\u5206\u6563\u5728 <code>.cpp</code> \u6216\u5176\u4ed6 inl\uff09\uff1a</p> <ul> <li>L265\uff1a<code>Value Invoke(thread, args, proxyCall)</code>\uff1a\u9759\u6001\u8bed\u8a00\u8c03\u7528\u5165\u53e3\uff08args \u5fc5\u987b\u5339\u914d\u7b7e\u540d\uff09\u3002</li> <li>L279\uff1a<code>InvokeDyn</code>\uff1a\u52a8\u6001\u8bed\u8a00\u8c03\u7528\u5165\u53e3\uff08TaggedValue \u53c2\u6570\uff0cargs[0] \u7ea6\u5b9a\u4e3a callee function object\uff09\u3002</li> <li>L285\uff1a<code>InvokeEntry</code>\uff1a\u66f4\u5e95\u5c42\u5165\u53e3\uff0c\u663e\u5f0f\u7ed9\u51fa frame/pc \u7b49\uff08\u7528\u4e8e bridge/\u89e3\u91ca\u5668\u91cd\u5165\uff09\u3002</li> <li>L295\uff1a<code>InvokeContext</code>\uff1aECMAScript generator \u7b49\u201c\u6062\u590d\u6267\u884c\u4e0a\u4e0b\u6587\u201d\u5165\u53e3\u3002</li> <li>L310\u2013L317\uff1anative \u65b9\u6cd5 frame \u8fdb\u5165/\u9000\u51fa\uff1a<code>EnterNativeMethodFrame</code> \u4e0e <code>ExitNativeMethodFrame</code>\u3002</li> </ul> <p>\u4ea4\u53c9\u5f15\u7528\uff08\u6267\u884c\u5f15\u64ce\u7ae0\u8282 04\uff09\uff1a\u8fd9\u4e9b\u5165\u53e3\u6700\u7ec8\u4f1a\u5728\u89e3\u91ca\u5668\u6267\u884c\u3001I2C/C2I bridge\u3001\u4ee5\u53ca native \u8c03\u7528\u8def\u5f84\u4e4b\u95f4\u5207\u6362\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#7-l411l483","title":"7. \u5165\u53e3\u70b9\u4e0e\u7f16\u8bd1\u72b6\u6001\uff08L411\u2013L483\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#71-compiled-entrypointl411l437","title":"7.1 compiled entrypoint\uff08L411\u2013L437\uff09","text":"<ul> <li><code>GetCompiledEntryPoint()</code>\uff1aacquire \u8bfb <code>compiledEntryPoint_</code>\u3002</li> <li><code>SetCompiledEntryPoint(ep)</code>\uff1arelease \u5199 <code>compiledEntryPoint_</code>\u3002</li> <li><code>SetInterpreterEntryPoint()</code>\uff1a\u82e5\u975e native\uff0c\u628a entrypoint \u91cd\u7f6e\u4e3a <code>GetCompiledCodeToInterpreterBridge(this)</code>\uff08\u9ed8\u8ba4\u89e3\u91ca\u5668\u5165\u53e3\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#72-hascompiledcodel439l444","title":"7.2 HasCompiledCode\uff08L439\u2013L444\uff09","text":"<p>\u901a\u8fc7\u6bd4\u8f83 entrypoint \u662f\u5426\u7b49\u4e8e \u201cC2I bridge\uff08\u9759\u6001/\u52a8\u6001\uff09\u201d \u6765\u5224\u5b9a\u662f\u5426\u5df2\u5b89\u88c5\u7f16\u8bd1\u4ee3\u7801\u5165\u53e3\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#73-bitfieldl446l482","title":"7.3 \u7f16\u8bd1\u72b6\u6001 bitfield\uff08L446\u2013L482\uff09","text":"<p>\u7f16\u8bd1\u9636\u6bb5\uff08NOT_COMPILED/WAITING/COMPILATION/COMPILED/FAILED\uff09\u88ab\u7f16\u7801\u5728 <code>accessFlags_</code> \u7684\u67d0\u4e2a\u4f4d\u6bb5\u4e2d\uff1a - <code>GetCompilationStatus()</code>\uff1a\u4ece <code>accessFlags_</code> \u4e2d\u53d6 mask+shift\u3002 - <code>SetCompilationStatus(new)</code>\uff1a\u8bfb\u65e7\u503c\uff08acquire\uff09\uff0c\u6539\u4f4d\u6bb5\u540e\u4ee5 release store\u3002 - <code>AtomicSetCompilationStatus(old,new)</code>\uff1aCAS \u5faa\u73af\uff0c\u53ea\u6709\u5f53\u5f53\u524d\u72b6\u6001\u7b49\u4e8e old \u624d\u66f4\u65b0\u3002</p> <p>\u8fd9\u8bf4\u660e\uff1aMethod \u7684 compilation stage \u662f\u4e00\u4e2a\u5e76\u53d1\u53ef\u66f4\u65b0\u72b6\u6001\u673a\uff0cJIT/AOT/OSR \u7ebf\u7a0b\u4f1a\u901a\u8fc7 CAS \u534f\u8c03\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#8-accessflags-l520l666","title":"8. accessFlags \u4e0e\u5404\u79cd\u8c13\u8bcd\uff08L520\u2013L666\uff09","text":"<p>\u5927\u91cf <code>IsStatic/IsNative/IsPublic/...</code> \u90fd\u91c7\u7528\u540c\u4e00\u6a21\u5f0f\uff1a - acquire \u8bfb <code>accessFlags_</code>\uff0c\u6309 <code>ACC_*</code> \u4f4d\u5224\u65ad\u3002 - \u66f4\u65b0\u7c7b flag\uff08\u4f8b\u5982 <code>SetProfiled/SetDestroyed/SetHasSingleImplementation/SetIntrinsic/SetIsDefaultInterfaceMethod</code>\uff09\u91c7\u7528 <code>fetch_or/fetch_and</code> \u7684 <code>acq_rel</code>\u3002</p> <p>\u5173\u952e\u70b9\uff1a - <code>SetIntrinsic</code> \u4f1a\u5148\u4ee5 relaxed \u5199 <code>intrinsicId_</code>\uff0c\u518d\u4ee5 <code>fetch_or(acq_rel)</code> \u8bbe\u7f6e <code>ACC_INTRINSIC</code>\uff0c\u7528\u540e\u8005\u4f5c\u4e3a\u53d1\u5e03\u5c4f\u969c\u3002 - <code>IsDestroyed/IsProfiled</code> \u7b49\u6807\u5fd7\u5bf9\u5916\u66b4\u9732 method \u7684\u751f\u547d\u5468\u671f/\u8fd0\u884c\u65f6\u72b6\u6001\uff08\u4f9b profiler/verification \u7b49\u4f7f\u7528\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#9-nativeprofiling-l693l743l1000l1035","title":"9. \u6d3e\u53d1\u7d22\u5f15\u4e0e native/profiling \u6307\u9488\u590d\u7528\uff08L693\u2013L743\uff0cL1000\u2013L1035\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#91-vtableindexl693l701","title":"9.1 vtableIndex\uff08L693\u2013L701\uff09","text":"<ul> <li><code>SetVTableIndex/GetVTableIndex</code> \u5b58\u5728 <code>Storage16Pair</code> \u7684 <code>vtableIndex</code> \u5b57\u6bb5\u4e2d\uff08\u975e\u539f\u5b50\uff09\u3002</li> <li>vtable builder \u7684 <code>UpdateClass</code> \u4f1a\u4e3a\u63a5\u53e3\u4e0e\u7c7b\u65b9\u6cd5\u5199\u56de\u8fd9\u4e2a\u7d22\u5f15\uff1a</li> <li>\u63a5\u53e3\uff1a\u63a5\u53e3\u65b9\u6cd5\u5e8f\u53f7\uff08\u4f9b itable \u7684 <code>methods_[vtableIndex]</code> \u53d6\u5b9e\u73b0\uff09</li> <li>\u7c7b\uff1avtable \u5e8f\u53f7\uff08\u4f9b vtable \u6d3e\u53d1\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#92-nativepointer-profilingdata-unionl703l717l863l903l1000l1005","title":"9.2 nativePointer \u4e0e profilingData \u590d\u7528 union\uff08L703\u2013L717\uff0cL863\u2013L903\uff0cL1000\u2013L1005\uff09","text":"<ul> <li><code>PointerInMethod</code> union\uff1a\u8981\u4e48\u662f <code>nativePointer</code>\uff08native/proxy\uff09\uff0c\u8981\u4e48\u662f <code>profilingData</code>\uff08\u975e native/proxy\uff09\u3002</li> <li><code>SetNativePointer/GetNativePointer</code> \u4ec5\u5141\u8bb8\u5728 <code>IsNative() || IsProxy()</code> \u4e0b\u8c03\u7528\uff0c\u5e76\u7528 relaxed \u539f\u5b50\u8bbf\u95ee\uff08\u6ca1\u6709\u989d\u5916\u540c\u6b65\u4fdd\u8bc1\uff09\u3002</li> <li><code>GetProfilingData*</code>\uff1a</li> <li>native/proxy \u8fd4\u56de nullptr</li> <li>\u5426\u5219 acquire \u8bfb <code>profilingData</code></li> </ul> <p>\u8bbe\u8ba1\u542b\u4e49\uff1a\u540c\u4e00\u5757\u6307\u9488\u69fd\u590d\u7528\u4e24\u79cd\u8bed\u4e49\uff0c\u9760 <code>ACC_NATIVE/ACC_PROXY</code> \u8fdb\u884c\u201c\u7c7b\u578b\u5224\u522b\u201d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#10-default-interface-method-constructor-l731l760","title":"10. default interface method / constructor \u6807\u5fd7\uff08L731\u2013L760\uff09","text":"<ul> <li><code>SetIsDefaultInterfaceMethod()</code>\uff1a<code>fetch_or(ACC_DEFAULT_INTERFACE_METHOD, acq_rel)</code>\u3002</li> <li><code>IsDefaultInterfaceMethod()</code>\uff1aacquire \u8bfb flag\u3002</li> <li><code>IsConstructor()</code>\uff1aacquire \u8bfb <code>ACC_CONSTRUCTOR</code>\u3002</li> <li><code>IsInstanceConstructor()</code>\uff1aconstructor \u4e14\u975e static\u3002</li> <li><code>IsStaticConstructor()</code>\uff1aconstructor \u4e14 static\u3002</li> </ul> <p>\u8fd9\u4e9b\u6807\u5fd7\u4f1a\u76f4\u63a5\u5f71\u54cd\uff1a - vtable builder \u5728 <code>ResolveVirtualMethod</code> \u7684\u63a5\u53e3\u5206\u652f\u4e2d\uff0c\u662f\u5426\u8d70 IMT/ITable\uff08\u4ee3\u7801\u91cc\u660e\u786e\u6392\u9664 default interface methods\uff09\u3002 - \u7c7b\u521d\u59cb\u5316\u4e0e <code>&lt;clinit&gt;</code> \u8bc6\u522b\uff08static constructor\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#11-layout-l762l823","title":"11. layout \u504f\u79fb\u66b4\u9732\uff08L762\u2013L823\uff09","text":"<p>\u5927\u91cf <code>Get*Offset()</code> \u4f7f\u7528 <code>MEMBER_OFFSET</code> \u8ba1\u7b97\u5b57\u6bb5\u504f\u79fb\uff1a - accessFlags/numArgs/vtableIndex/hotnessCounter/classWord/compiledEntryPoint/pandaFile/codeId/nativePointer/shorty/numVregs/instructions \u7b49\u3002</p> <p>\u7528\u9014\uff1a\u89e3\u91ca\u5668/\u6865\u63a5/\u6c47\u7f16\u5feb\u8def\u5f84\u53ef\u76f4\u63a5\u7528\u504f\u79fb\u8bbf\u95ee method \u5143\u6570\u636e\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#12-idprofilingl833l935l905l933","title":"12. \u552f\u4e00 id\u3001profiling\u3001\u9a8c\u8bc1\uff08L833\u2013L935\uff0cL905\u2013L933\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#121-uniqidl834l850","title":"12.1 UniqId\uff08L834\u2013L850\uff09","text":"<ul> <li><code>CalcUniqId(file,fileId)</code>\uff1a\u628a <code>file-&gt;GetUniqId()</code> \u5de6\u79fb 32 bit\uff0c\u518d OR \u4e0a <code>fileId offset</code>\u3002</li> <li><code>GetUniqId()</code>\uff1a\u8fd4\u56de\u4e0a\u8ff0\u7ec4\u5408 id\uff08synthetic method \u53e6\u6709\u91cd\u8f7d\u5165\u53e3\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#122-profilingl856l903","title":"12.2 Profiling\uff08L856\u2013L903\uff09","text":"<ul> <li><code>InitProfilingData/StartProfiling/StopProfiling</code>\uff1a\u5bfc\u51fa\u63a5\u53e3\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff09\u3002</li> <li><code>IsProfiling/IsProfilingWithoutLock</code>\uff1a\u4ee5 profilingData \u662f\u5426\u4e3a nullptr \u5224\u65ad\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#123-verificationstagel78l80l905l933","title":"12.3 VerificationStage\uff08L78\u2013L80\uff0cL905\u2013L933\uff09","text":"<ul> <li>verification stage \u4e5f\u5b58\u653e\u5728 <code>accessFlags_</code> \u7684 bitfield \u4e2d\uff08mask+shift\uff09\u3002</li> <li><code>SetVerificationStage(new)</code>\uff1aCAS loop \u66f4\u65b0\u4f4d\u6bb5\uff08acq_rel\uff09\u3002</li> <li><code>Verify/TryVerify</code>\uff1a\u5bfc\u51fa\u9a8c\u8bc1\u5165\u53e3\uff08\u5b9e\u73b0\u4e0d\u5728\u6b64\u6587\u4ef6\uff0c\u89c1 verification \u7ae0\u8282\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_method.h/#13-l1000l1035","title":"13. \u79c1\u6709\u5b57\u6bb5\u5e03\u5c40\uff08L1000\u2013L1035\uff09","text":"<p><code>Method</code> \u7684\u6838\u5fc3\u5b57\u6bb5\u5982\u4e0b\uff1a - <code>accessFlags_</code>\uff1a\u539f\u5b50 uint32\uff0c\u627f\u8f7d\u5927\u91cf\u4f4d\u6bb5\uff08\u8bbf\u95ee\u6807\u5fd7 + compilation/verification stage + runtime flags\uff09\u3002 - <code>numArgs_</code>\uff1a\u53c2\u6570\u6570\u91cf\u3002 - <code>Storage16Pair</code>\uff1a<code>vtableIndex</code>\uff08uint16\uff09+ <code>hotnessCounter</code>\uff08int16\uff09\u3002 - <code>classWord_</code>\uff1a\u4ee5 <code>ClassHelper::ClassWordSize</code> \u5b58\u50a8\u7684\u7c7b\u6307\u9488\uff08\u53ef\u80fd\u662f\u538b\u7f29\u6307\u9488\u6a21\u578b\uff09\u3002 - <code>compiledEntryPoint_</code>\uff1a\u539f\u5b50\u5165\u53e3\u70b9\u6307\u9488\uff08\u89e3\u91ca\u5668 bridge \u6216 JIT/AOT \u4ee3\u7801\uff09\u3002 - <code>pandaFile_/fileId_/codeId_/shorty_</code>\uff1a\u6307\u5411 panda_file \u7684\u5b9a\u4f4d\u4fe1\u606f\u4e0e\u7b7e\u540d shorty\u3002 - <code>pointer_</code> union\uff1anativePointer / profilingData\u3002 - <code>intrinsicId_</code>\uff1aintrinsic \u7f16\u53f7\uff08\u539f\u5b50\uff09\u3002 - <code>instructions_</code> / <code>numVregs_</code>\uff1a\u60f0\u6027\u7f13\u5b58\uff08\u539f\u5b50\uff0c\u53ef\u5728 const \u65b9\u6cd5\u4e2d\u5199\uff09\u3002</p> <p>\u6587\u4ef6\u5c3e <code>static_assert(!std::is_polymorphic_v&lt;Method&gt;)</code> \u5f3a\u5236 <code>Method</code> \u4e0d\u662f\u591a\u6001\u7c7b\u578b\uff08\u4fdd\u8bc1\u5e03\u5c40\u7a33\u5b9a\u3001\u53ef\u7528\u4e8e offset \u5feb\u8def\u5f84\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/","title":"<code>runtime/include/vtable_builder_base-inl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1avtable \u6784\u5efa\u201c\u9aa8\u67b6\u6d41\u7a0b\u201d\u7684 inline \u5b9e\u73b0\uff08\u5bf9\u5e94 <code>vtable_builder_base.h</code> \u7684\u58f0\u660e\uff09\u3002 \u5173\u952e\u70b9\uff1a\u8fd9\u91cc\u5b9a\u4e49\u4e86 Build \u987a\u5e8f \u4e0e copied default methods \u7684\u679a\u4e3e\u7b56\u7565\uff08\u5012\u5e8f\u904d\u5386 itable\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#1","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u5b83\u5b9e\u73b0\u4e86\u4ec0\u4e48\uff09","text":"<p><code>VTableBuilderBase&lt;VISIT_SUPERITABLE&gt;</code> \u7684\u6838\u5fc3\u6d41\u7a0b\u90fd\u5728\u8fd9\u91cc\uff1a</p> <ul> <li>\u63a5\u53e3\u7c7b\uff1a\u53ea\u7edf\u8ba1 vmethods \u6570\u91cf\uff0c\u5e76\u6807\u8bb0\u662f\u5426\u5b58\u5728 default \u65b9\u6cd5\uff08<code>hasDefaultMethods_</code>\uff09\u3002</li> <li>\u666e\u901a\u7c7b\uff1a\u6309\u987a\u5e8f\u6267\u884c\uff1a   1) \u4ece baseClass \u7684 vtable \u6ce8\u5165 base entries\uff08\u53ef\u88ab\u8986\u76d6\uff09   2) \u679a\u4e3e\u672c\u7c7b non-static \u65b9\u6cd5\u5e76\u4ea4\u7ed9\u7b56\u7565\u94a9\u5b50 <code>ProcessClassMethod</code>   3) \u4ece itable \u4e2d\u679a\u4e3e\u63a5\u53e3 default \u65b9\u6cd5\u5e76\u4ea4\u7ed9\u7b56\u7565\u94a9\u5b50 <code>ProcessDefaultMethod</code>\uff0c\u751f\u6210 copied methods \u5217\u8868   4) <code>UpdateClass</code> \u5199\u56de flags \u4e0e vtable_index\uff0c\u5e76\u7531 <code>VTableInfo::UpdateClass</code> \u5199\u56de\u6700\u7ec8\u8868</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#2-l1l20","title":"2. \u5934\u90e8\uff08L1\u2013L20\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_VTABLE_BUILDER_BASE_INL_H</code>\u3002</li> <li>L18\uff1a\u5305\u542b <code>vtable_builder_base.h</code> \u83b7\u53d6 <code>VTableInfo/MethodInfo/VTableBuilderBase</code> \u58f0\u660e\u3002</li> <li>L20\uff1a<code>namespace ark {</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#3-l22l27","title":"3. \u51b2\u7a81\u4e0a\u62a5\u63a5\u53e3\u58f0\u660e\uff08L22\u2013L27\uff09","text":"<p>\u8fd9\u91cc\u4ec5\u58f0\u660e <code>OnVTableConflict</code> \u4e24\u4e2a\u91cd\u8f7d\uff08\u5b9e\u73b0\u5e94\u5728 <code>.cpp</code> \u4e2d\uff09\uff1a - L22\u2013L23\uff1a\u51b2\u7a81\u5bf9\u8c61\u4e3a <code>MethodInfo*</code>\uff08\u6784\u5efa\u4e2d\u95f4\u8868\u793a\uff09\u3002 - L25\u2013L26\uff1a\u51b2\u7a81\u5bf9\u8c61\u4e3a <code>Method*</code>\uff08\u8fd0\u884c\u65f6\u65b9\u6cd5\u5bf9\u8c61\uff09\u3002</p> <p>\u6784\u5efa\u7b56\u7565\uff08variance \u7b49\uff09\u53d1\u73b0\u51b2\u7a81\u540e\u4f1a\u8c03\u7528\u5b83\uff0c\u5e76\u901a\u8fc7 <code>ClassLinkerErrorHandler</code> \u629b\u7ed9\u4e0a\u5c42\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#4-vtableinfo-l28l48","title":"4. <code>VTableInfo</code> \u7684\u64cd\u4f5c\u5b9e\u73b0\uff08L28\u2013L48\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#41-addentryl28l32","title":"4.1 <code>AddEntry</code>\uff08L28\u2013L32\uff09","text":"<ul> <li>\u63d2\u5165 <code>{info -&gt; MethodEntry(index)}</code>\uff0cindex \u53d6\u5f53\u524d <code>vmethods_.size()</code>\uff08\u63d2\u5165\u524d\u7684 size\uff09\u3002</li> <li><code>ASSERT(res.second)</code>\uff1a\u4fdd\u8bc1\u4e0d\u5b58\u5728\u91cd\u590d key\uff08key \u662f <code>MethodInfo*</code> \u5730\u5740\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#42-addcopiedentryl34l39","title":"4.2 <code>AddCopiedEntry</code>\uff08L34\u2013L39\uff09","text":"<ul> <li>\u5728 <code>copiedMethods_</code> \u4e2d\u63d2\u5165 <code>{info -&gt; CopiedMethodEntry(index)}</code>\uff0cindex \u53d6\u5f53\u524d <code>copiedMethods_.size()</code>\u3002</li> <li>\u8fd4\u56de entry \u7684\u5f15\u7528\uff0c\u4fbf\u4e8e\u5916\u5c42\u7ee7\u7eed\u8bbe\u7f6e status\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#43-updatecopiedentryl41l48","title":"4.3 <code>UpdateCopiedEntry</code>\uff08L41\u2013L48\uff09","text":"<ul> <li>\u7528 repl \u66ff\u6362 orig \u7684 key\uff0c\u4f46\u4fdd\u7559 entry \u7684 index/status\uff1a</li> <li>\u5148 find orig</li> <li>copy \u51fa\u65e7 entry</li> <li>erase orig</li> <li>emplace_hint(repl, entry)</li> </ul> <p>\u8fd9\u4e2a\u64cd\u4f5c\u662f\u201c\u51b2\u7a81\u6d88\u89e3/\u8986\u76d6\u66ff\u6362\u201d\u7684\u57fa\u7840\u8bbe\u65bd\uff1a\u7b56\u7565\u53ef\u4ee5\u628a\u67d0\u4e2a copied method \u7684\u4ee3\u8868\u4ece orig \u6362\u6210 repl\uff0c\u4f46\u4fdd\u6301\u7a33\u5b9a\u5e8f\u53f7\u4e0d\u53d8\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#5-fast-pathbuildforinterfacel50l81","title":"5. \u63a5\u53e3\u7c7b\u7684 fast-path\uff1a<code>BuildForInterface</code>\uff08L50\u2013L81\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#51-panda_file-l50l65","title":"5.1 \u4ece panda_file \u6784\u5efa\uff08L50\u2013L65\uff09","text":"<ul> <li>L53\uff1a\u65ad\u8a00\u786e\u5b9e\u662f\u63a5\u53e3\u3002</li> <li>L54\u2013L64\uff1a\u679a\u4e3e\u65b9\u6cd5\uff1a</li> <li>static \u65b9\u6cd5\u8df3\u8fc7\uff08\u63a5\u53e3\u9759\u6001\u65b9\u6cd5\u4e0d\u8fdb\u5165 vtable/itable \u6d3e\u53d1\u96c6\u5408\uff09</li> <li>\u82e5\u975e abstract \u2192 <code>hasDefaultMethods_=true</code>\uff08\u63a5\u53e3\u5b58\u5728 default \u65b9\u6cd5\uff09</li> <li><code>++numVmethods_</code>\uff1a\u7edf\u8ba1\u63a5\u53e3\u201c\u865a\u65b9\u6cd5\u69fd\u4f4d\u6570\u201d</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#52-spanmethod-l67l81","title":"5.2 \u4ece <code>Span&lt;Method&gt;</code> \u6784\u5efa\uff08L67\u2013L81\uff09","text":"<ul> <li>\u903b\u8f91\u4e0e\u4e0a\u9762\u4e00\u81f4\uff0c\u53ea\u662f\u6765\u6e90\u6362\u6210 runtime Method \u6570\u7ec4\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u63a5\u53e3 fast-path \u6ca1\u6709\u6784\u5efa <code>VTableInfo</code> \u6620\u5c04\uff08\u4e0d\u9700\u8981 base \u8986\u76d6/\u9ed8\u8ba4\u65b9\u6cd5 copied \u5904\u7406\uff09\uff1b\u771f\u6b63\u6d3e\u53d1\u7ed3\u6784\u7531\u7c7b\u5b9e\u73b0\u4fa7\u5728 itable/IMT/vtable \u4e0a\u627f\u8f7d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#6-base-vtableaddbasemethodsl83l94","title":"6. \u6ce8\u5165 base vtable\uff1a<code>AddBaseMethods</code>\uff08L83\u2013L94\uff09","text":"<ul> <li>L86\u2013L88\uff1a\u7528 arena \u5206\u914d <code>ArenaForwardList&lt;MethodInfo&gt;</code> \u4fdd\u5b58 base \u65b9\u6cd5\u7684 <code>MethodInfo</code> \u5bf9\u8c61\uff08\u4fdd\u8bc1\u5730\u5740\u7a33\u5b9a\uff0c\u4f9b map key \u4f7f\u7528\uff09\u3002</li> <li>L89\u2013L93\uff1a\u82e5 baseClass \u975e\u7a7a\uff1a</li> <li>\u904d\u5386 <code>baseClass-&gt;GetVTable()</code>\uff08\u8fd9\u662f\u6700\u7ec8 vtable \u91cc\u7684 <code>Method*</code> \u6307\u9488\u6570\u7ec4\uff09</li> <li>\u5bf9\u6bcf\u4e2a method \u6784\u9020 <code>MethodInfo(method, 0, true)</code>\uff08<code>isBase_=true</code>\uff09</li> <li>\u7acb\u523b <code>vtable_.AddEntry(&amp;emplace_front(...))</code></li> </ul> <p>\u5173\u952e\u8bed\u4e49\uff1abase \u65b9\u6cd5\u5148\u8fdb\u5165 vtable_\uff0c\u540e\u7eed\u672c\u7c7b\u65b9\u6cd5\u901a\u8fc7\u7b56\u7565\u94a9\u5b50\u53ea\u80fd\u8986\u76d6 <code>IsBase()</code> \u7684\u6761\u76ee\uff08variance \u7b56\u7565\u5982\u6b64\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#7-addclassmethodsl96l135","title":"7. \u679a\u4e3e\u672c\u7c7b\u65b9\u6cd5\uff1a<code>AddClassMethods</code>\uff08L96\u2013L135\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#71-panda_file-l97l115","title":"7.1 \u4ece panda_file \u6784\u5efa\uff08L97\u2013L115\uff09","text":"<ul> <li>\u5206\u914d <code>classMethods</code> forward_list\u3002</li> <li><code>EnumerateMethods</code>\uff1a</li> <li>\u53ea\u6536\u96c6 non-static \u65b9\u6cd5</li> <li><code>MethodInfo(mda, numVmethods_++, ctx)</code>\uff1a<ul> <li><code>numVmethods_++</code> \u4f5c\u4e3a vmethodIndex\uff08\u6ce8\u610f\uff1a\u8fd9\u662f\u201c\u672c\u7c7b\u865a\u65b9\u6cd5\u5e8f\u53f7\u201d\uff0c\u7528\u4e8e\u540e\u7eed\u8bbe\u7f6e <code>Method::vtable_index</code>\uff09</li> </ul> </li> <li>\u7b2c\u4e8c\u904d\u904d\u5386 <code>classMethods</code>\uff1a</li> <li>\u5bf9\u6bcf\u4e2a <code>info</code> \u8c03\u7528 <code>ProcessClassMethod(&amp;info)</code></li> <li>\u4efb\u4e00\u5931\u8d25 \u2192 false\uff08\u51b2\u7a81/\u4e0d\u5408\u6cd5\u8986\u76d6\u7b49\uff09</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#72-runtime-methods-l118l135","title":"7.2 \u4ece runtime methods \u6784\u5efa\uff08L118\u2013L135\uff09","text":"<ul> <li>\u540c\u6837\u6536\u96c6 non-static methods\uff0c\u6784\u9020 <code>MethodInfo(&amp;method, numVmethods_++)</code>\u3002</li> <li>\u518d\u8c03\u7528 <code>ProcessClassMethod</code>\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u4f7f\u7528 forward_list \u7684\u539f\u56e0\u901a\u5e38\u662f\u201c\u6784\u9020\u65f6\u5730\u5740\u7a33\u5b9a + \u4fbf\u4e8e arena \u5206\u914d + \u8fed\u4ee3\u987a\u5e8f\u4e0d\u654f\u611f\u201d\uff08\u7b56\u7565\u4e3b\u8981\u6309 name bucket \u5339\u914d\u800c\u4e0d\u662f\u6309\u58f0\u660e\u987a\u5e8f\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#8-adddefaultinterfacemethodsl137l174","title":"8. \u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\uff1a<code>AddDefaultInterfaceMethods</code>\uff08L137\u2013L174\uff09","text":"<p>\u8fd9\u662f\u7406\u89e3 copied methods \u7684\u5173\u952e\uff1a</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#81-visit_superitablel143l145","title":"8.1 \u904d\u5386\u8303\u56f4\u88c1\u526a\uff1a<code>VISIT_SUPERITABLE</code>\uff08L143\u2013L145\uff09","text":"<ul> <li><code>traverseUpTo = VISIT_SUPERITABLE ? 0 : superItableSize</code></li> <li>\u5f53 <code>VISIT_SUPERITABLE=false</code>\uff08variance builder \u7ee7\u627f\u7684\u662f <code>VTableBuilderBase&lt;false&gt;</code>\uff09\uff1a\u53ea\u904d\u5386 \u5b50\u7c7b\u65b0\u589e\u7684 itable \u533a\u95f4\uff08\u4e0d\u56de\u6eaf\u5230 super \u7684 itable \u90e8\u5206\uff09\u3002</li> <li>\u5f53 <code>VISIT_SUPERITABLE=true</code>\uff1a\u904d\u5386\u6574\u4e2a itable\uff08\u5305\u62ec super\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#82-itablel146l163","title":"8.2 \u5012\u5e8f\u904d\u5386 itable\uff08L146\u2013L163\uff09","text":"<ul> <li><code>for (size_t i = itable.Size(); i != traverseUpTo;) { i--; ... }</code></li> <li>\u5012\u5e8f\u904d\u5386\u610f\u5473\u7740\uff1a\u540e\u52a0\u5165\u7684\u63a5\u53e3\uff08\u901a\u5e38\u66f4\u63a5\u8fd1\u5b50\u7c7b\uff09\u4f18\u5148\uff0c\u6709\u5229\u4e8e\u8986\u76d6/\u51b2\u7a81\u6d88\u89e3\uff08\u5177\u4f53\u7b56\u7565\u5728 <code>ProcessDefaultMethod</code>\uff09\u3002</li> <li>\u5bf9\u6bcf\u4e2a interface\uff1a</li> <li>\u82e5 <code>!iface-&gt;HasDefaultMethods()</code> \u2192 \u8df3\u8fc7\uff08\u907f\u514d\u626b\u63cf\u5927\u91cf\u65e0 default \u7684\u63a5\u53e3\uff09</li> <li>\u679a\u4e3e <code>iface-&gt;GetVirtualMethods()</code>\uff1a<ul> <li>\u8df3\u8fc7 abstract</li> <li>\u4e3a\u6bcf\u4e2a default \u65b9\u6cd5\u6784\u9020 <code>MethodInfo(&amp;method)</code>\uff08\u6ce8\u610f\uff1a\u6b64\u5904\u6765\u6e90\u662f runtime Method*\uff09</li> <li>\u8c03\u7528 <code>ProcessDefaultMethod(itable, i, info)</code>\uff1a</li> <li>\u8fd4\u56de false\uff1a\u8868\u793a\u51b2\u7a81\u4e0d\u53ef\u6062\u590d\uff0c\u6784\u5efa\u5931\u8d25</li> </ul> </li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#83-orderedcopiedmethods_l165l173","title":"8.3 \u751f\u6210\u7a33\u5b9a\u6709\u5e8f\u7684 <code>orderedCopiedMethods_</code>\uff08L165\u2013L173\uff09","text":"<ul> <li><code>orderedCopiedMethods_.resize(vtable_.CopiedMethods().size())</code></li> <li>\u904d\u5386 <code>vtable_.CopiedMethods()</code>\uff08unordered map\uff09\uff1a</li> <li>\u628a <code>{Method*, Status}</code> \u8f6c\u6210 <code>CopiedMethod</code> \u5bf9\u8c61</li> <li>\u6309 <code>entry.GetIndex()</code> \u653e\u5230\u6570\u7ec4\u4e2d\uff1a<code>orderedCopiedMethods_[index] = copied</code></li> </ul> <p>\u5173\u952e\u70b9\uff1acopiedMethods_ \u662f unordered_map\uff0c\u4f46 index \u7531\u63d2\u5165\u65f6\u7684 size \u51b3\u5b9a\uff0c\u56e0\u6b64\u6700\u7ec8\u901a\u8fc7 index \u6062\u590d\u4e86\u7a33\u5b9a\u987a\u5e8f\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#9-build-l176l212","title":"9. <code>Build</code> \u4e3b\u6d41\u7a0b\uff08L176\u2013L212\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#91-panda_file-l176l193","title":"9.1 panda_file \u7248\u672c\uff08L176\u2013L193\uff09","text":"<ul> <li>\u82e5 <code>cda-&gt;IsInterface()</code>\uff1a\u8d70 interface fast-path\uff0c\u8fd4\u56de true\u3002</li> <li>\u5426\u5219\uff1a</li> <li><code>AddBaseMethods(baseClass)</code></li> <li><code>AddClassMethods(cda, ctx)</code>\uff08\u5931\u8d25\u5219\u8fd4\u56de false\uff09</li> <li><code>AddDefaultInterfaceMethods(itable, baseClass ? baseClass-&gt;GetITable().Size() : 0)</code>\uff08\u5931\u8d25\u5219\u8fd4\u56de false\uff09</li> <li>\u6210\u529f\u8fd4\u56de true</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#92-runtime-methods-l195l212","title":"9.2 runtime methods \u7248\u672c\uff08L195\u2013L212\uff09","text":"<ul> <li><code>isInterface</code> \u65f6\u540c\u6837\u8d70 interface fast-path\u3002</li> <li>\u5426\u5219\u987a\u5e8f\u540c\u4e0a\uff0c\u53ea\u662f <code>AddClassMethods</code> \u7684\u8f93\u5165\u6362\u6210 <code>Span&lt;Method&gt; methods</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base-inl.h/#10-updateclass-l214l229","title":"10. <code>UpdateClass</code> \u5199\u56de\uff08L214\u2013L229\uff09","text":"<ul> <li>\u5982\u679c <code>klass-&gt;IsInterface()</code>\uff1a</li> <li><code>hasDefaultMethods_</code> \u4e3a true \u65f6\u8bbe\u7f6e <code>klass-&gt;SetHasDefaultMethods()</code>\uff08\u5f71\u54cd\u540e\u7eed itable default \u904d\u5386\u526a\u679d\uff09\u3002</li> <li>\u7ed9\u63a5\u53e3\u7684\u6bcf\u4e2a virtual method \u5199 <code>method.SetVTableIndex(idx++)</code>\uff08\u63a5\u53e3\u65b9\u6cd5\u4e5f\u9700\u8981 vtable_index \u4f5c\u4e3a\u201c\u63a5\u53e3\u65b9\u6cd5\u5e8f\u53f7\u201d\uff0c\u4f9b itable \u6d3e\u53d1 <code>entry.GetMethods()[vtableIndex]</code> \u4f7f\u7528\uff09\u3002</li> <li>\u65e0\u8bba\u662f\u5426\u63a5\u53e3\uff1a</li> <li><code>vtable_.UpdateClass(klass)</code>\uff1a\u628a vtable/candidates/copied \u5199\u56de class\uff08\u5b9e\u73b0\u4e0d\u5728\u672c\u6587\u4ef6\uff0c\u9700\u5728\u540e\u7eed\u52a8\u6001\u7eb3\u5165\u91cc\u8ffd\u8e2a\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/","title":"<code>runtime/include/vtable_builder_base.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1a\u865a\u8868\uff08vtable\uff09/\u63a5\u53e3\u6d3e\u53d1\u8868\uff08IMT/ITable\uff09\u6784\u5efa\u7684\u57fa\u7840\u8bbe\u65bd\u58f0\u660e\uff08\u542b\u5173\u952e\u6570\u636e\u7ed3\u6784 + \u62bd\u8c61\u5904\u7406\u94a9\u5b50\uff09 \u5b9e\u73b0\u4f4d\u7f6e\uff1a\u5927\u91cf inline \u5b9e\u73b0\u5728 <code>runtime/include/vtable_builder_base-inl.h</code>\uff1b\u51b2\u7a81\u5904\u7406\u4e0e\u7b56\u7565\u5728 <code>vtable_builder_variance*</code> \u7b49\u6d3e\u751f\u5b9e\u73b0\u4e2d\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#1-03","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u4e3a\u4ec0\u4e48\u5b83\u5fc5\u987b\u5f52\u5c5e 03\uff09","text":"<p>\u7c7b\u94fe\u63a5\uff08ClassLinker\uff09\u4e0d\u4ec5\u8981\u89e3\u6790\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5\uff0c\u8fd8\u5fc5\u987b\u4e3a\u65b9\u6cd5\u6d3e\u53d1\u51c6\u5907\u597d\u8fd0\u884c\u65f6\u7ed3\u6784\uff1a</p> <ul> <li>vtable\uff1a\u7c7b\u7684\u865a\u65b9\u6cd5\u8868\uff08\u6309 <code>Method::vtable_index</code> \u7d22\u5f15\uff09\u3002</li> <li>IMT\uff08Interface Method Table\uff09\uff1a\u63a5\u53e3\u65b9\u6cd5\u5feb\u901f\u6d3e\u53d1\u69fd\uff08\u6309 <code>methodId % imtSize</code> \u6620\u5c04\uff09\u3002</li> <li>ITable\uff1a\u63a5\u53e3\u5230\u65b9\u6cd5\u6570\u7ec4\u7684\u6620\u5c04\uff08\u7528\u4e8e IMT miss \u7684\u6162\u8def\u5f84\uff09\u3002</li> <li>copied methods\uff1a\u4ece\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\uff08default interface methods\uff09\u590d\u5236\u5230\u7c7b\u7684\u65b9\u6cd5\u96c6\u5408\u4e2d\uff0c\u4ee5\u7edf\u4e00\u6d3e\u53d1/\u53ef\u89c1\u6027\u5904\u7406\u3002</li> </ul> <p>\u672c\u6587\u4ef6\u63d0\u4f9b vtable \u6784\u5efa\u7684\u201c\u901a\u7528\u9aa8\u67b6\u201d\uff0c\u5e76\u628a\u201c\u8986\u76d6\u89c4\u5219/\u534f\u53d8\u517c\u5bb9/\u51b2\u7a81\u5224\u5b9a\u201d\u7b49\u7b56\u7565\u4ea4\u7ed9\u6d3e\u751f\u7c7b\u5b9e\u73b0\uff08\u89c1 <code>vtable_builder_variance-inl.h</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#2-l1l36","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L36\uff09","text":"<ul> <li>L1\u2013L14\uff1aLicense\u3002</li> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_VTABLE_BUILDER_BASE_H</code>\u3002</li> <li>L18\uff1a<code>macros.h</code>\uff1a<code>ASSERT/LIKELY/UNLIKELY/DEFAULT_*</code> \u7b49\u3002</li> <li>L19\uff1ahash\uff1a\u7528\u4e8e <code>MethodNameHash</code>\uff08\u6309\u65b9\u6cd5\u540d\u54c8\u5e0c\uff09\u3002</li> <li>L20\uff1autf\uff1a\u7528\u4e8e\u540d\u79f0/descriptor \u5904\u7406\uff08\u95f4\u63a5\u4f7f\u7528\uff09\u3002</li> <li>L21\u2013L24\uff1a<code>libarkfile/*-inl.h</code> + <code>file_items.h</code>\uff1a\u8bbf\u95ee panda_file \u4e2d\u7684 class/method/proto \u5143\u6570\u636e\uff08<code>ClassDataAccessor/MethodDataAccessor/ProtoDataAccessor</code>\uff09\u3002</li> <li>L25\uff1a<code>runtime/class_linker_context.h</code>\uff1aLoadContext\uff08\u540c\u540d\u65b9\u6cd5\u517c\u5bb9\u6027\u68c0\u67e5\u9700\u8981 context\uff09\u3002</li> <li>L26\uff1a<code>class-inl.h</code>\uff1a<code>Class::GetVTable()</code>\u3001<code>Method</code> \u8bbf\u95ee\u5668\u7b49 inline \u5b9e\u73b0\u88ab\u76f4\u63a5\u7528\u5230\uff08\u6ce8\u610f\uff1a\u8fd9\u8ba9 vtable builder \u6210\u4e3a 03 \u7684\u201c\u5f3a include \u4e2d\u5fc3\u201d\uff09\u3002</li> <li>L27\uff1a<code>class_linker.h</code>\uff1a\u9519\u8bef\u7801 <code>ClassLinker::Error</code>\u3001\u4ee5\u53ca\u94fe\u63a5\u671f\u9519\u8bef\u5904\u7406\u63a5\u53e3\u3002</li> <li>L28\u2013L29\uff1a<code>panda_containers/smart_pointers</code>\uff1aArena \u5bb9\u5668/\u5206\u914d\u5668\u3002</li> <li>L30\uff1a<code>vtable_builder_interface.h</code>\uff1a\u62bd\u8c61\u63a5\u53e3 <code>VTableBuilder</code> \u4e0e <code>CopiedMethod</code> \u5b9a\u4e49\u3002</li> <li>L32\u2013L36\uff1a<code>namespace ark</code> \u4e0e <code>ClassLinker/ClassLinkerContext</code> \u524d\u5411\u58f0\u660e\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#3-methodinfopanda_file-method-vs-runtime-methodl37l153","title":"3. <code>MethodInfo</code>\uff1a\u7edf\u4e00\u5305\u88c5\uff08panda_file method vs runtime Method\uff09\uff08L37\u2013L153\uff09","text":"<p>\u8be5\u7c7b\u578b\u662f\u201c\u6784\u5efa\u9636\u6bb5\u7684\u4e2d\u95f4\u8868\u793a\u201d\uff1a\u540c\u4e00\u4e2a\u903b\u8f91\u65b9\u6cd5\u53ef\u80fd\u6765\u81ea\uff1a - \u672a materialize \u7684 panda_file::MethodDataAccessor\uff08\u7c7b\u8fd8\u5728\u94fe\u63a5/\u6784\u5efa\u4e2d\uff09 - \u5df2\u5b58\u5728\u7684 runtime <code>Method*</code>\uff08\u6bd4\u5982 baseClass \u7684 vtable \u65b9\u6cd5\u3001\u63a5\u53e3 default \u65b9\u6cd5\u5bf9\u8c61\u7b49\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#31-panda_filel39l48","title":"3.1 \u6784\u9020\uff1a\u6765\u81ea panda_file\uff08L39\u2013L48\uff09","text":"<ul> <li>L39\uff1a\u53c2\u6570\uff1a<code>MethodDataAccessor&amp; mda</code>\u3001<code>index</code>\uff08vmethodIndex\uff09\u3001<code>ctx</code>\uff08LoadContext\uff09\u3002</li> <li>L40\uff1a\u4fdd\u5b58 <code>pf_</code> \u6307\u9488\uff08panda file\uff09\u3002</li> <li>L41\uff1a\u7f13\u5b58 <code>name_</code>\uff08\u901a\u8fc7 <code>GetStringData(mda.GetNameId())</code>\uff09\u3002</li> <li>L42\uff1a\u4fdd\u5b58 <code>protoId_</code>\uff08\u6ce8\u610f\u8fd9\u91cc\u662f panda_file \u7684 <code>EntityId</code>\uff0c\u540e\u7eed\u901a\u8fc7 <code>Method::ProtoId(*pf_, protoId_)</code> \u8f6c\u6210\u8fd0\u884c\u65f6 wrapper\uff09\u3002</li> <li>L43\uff1a\u4fdd\u5b58 <code>accessFlags_</code>\u3002</li> <li>L44\uff1a\u4fdd\u5b58 <code>classId_</code>\uff08\u58f0\u660e\u8be5\u65b9\u6cd5\u7684\u7c7b id\uff09\u3002</li> <li>L45\u2013L46\uff1a\u4fdd\u5b58 <code>ctx_</code> \u4e0e <code>vmethodIndex_</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#32-runtime-methodl50l61","title":"3.2 \u6784\u9020\uff1a\u6765\u81ea runtime <code>Method*</code>\uff08L50\u2013L61\uff09","text":"<p>\u7528\u4e8e\u5904\u7406 baseClass \u7684 vtable \u65b9\u6cd5 / default \u65b9\u6cd5\u7b49\uff1a - L51\uff1a<code>pf_ = method-&gt;GetPandaFile()</code>\u3002 - L52\uff1a<code>name_ = method-&gt;GetName()</code>\uff08\u5df2\u662f StringData\uff09\u3002 - L53\uff1a<code>protoId_ = method-&gt;GetProtoId().GetEntityId()</code>\uff08\u4ecd\u56de\u5230 EntityId\uff09\u3002 - L54\uff1a<code>accessFlags_ = method-&gt;GetAccessFlags()</code>\u3002 - L55\uff1a<code>isBase_</code>\uff1a\u6807\u8bb0\u8be5\u65b9\u6cd5\u662f\u5426\u6765\u81ea baseClass\uff08\u7528\u4e8e\u8986\u76d6\u5224\u5b9a\uff1a\u53ea\u5141\u8bb8 override base\uff09\u3002 - L56\uff1a<code>classId_ = method-&gt;GetClass()-&gt;GetFileId()</code>\u3002 - L57\uff1a\u4fdd\u5b58 <code>method_</code>\uff08\u6b64\u65f6\u53ef\u76f4\u63a5\u8bbf\u95ee Method\uff09\u3002 - L58\uff1a<code>ctx_</code> \u53d6\u81ea <code>method-&gt;GetClass()-&gt;GetLoadContext()</code>\u3002 - L59*\uff1a<code>vmethodIndex_</code>\uff08\u9ed8\u8ba4 0\uff0c\u53ef\u7531\u8c03\u7528\u8005\u6307\u5b9a\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#33-l63l132","title":"3.3 \u8bbf\u95ee\u5668\uff08L63\u2013L132\uff09","text":"<p>\u5173\u952e\u70b9\uff1a - L68\u2013L71\uff1a<code>GetClassName()</code>\uff1a\u82e5\u6709 <code>method_</code> \u5219\u7528 runtime class descriptor\uff1b\u5426\u5219\u4ece panda_file \u7684 <code>classId_</code> \u53d6\u5b57\u7b26\u4e32\u6570\u636e\uff08descriptor\uff09\u3002 - L73\u2013L76\uff1a<code>GetProtoId()</code>\uff1a\u7edf\u4e00\u8fd4\u56de <code>Method::ProtoId</code>\uff08\u5c01\u88c5\u4e86 pf+entityId\uff09\u3002 - L113\u2013L121\uff1a<code>IsInterfaceMethod()</code>\uff1a\u82e5 runtime <code>method_</code> \u5b58\u5728\uff0c\u5219\u7528 <code>method_-&gt;GetClass()-&gt;IsInterface()</code>\uff1b\u5426\u5219\u7528 <code>ClassDataAccessor</code> \u5224\u65ad classId \u662f\u5426\u63a5\u53e3\u3002 - L123\u2013L126\uff1a<code>IsBase()</code>\uff1a\u8986\u76d6\u5224\u5b9a\u65f6\u53ea\u5173\u5fc3 base \u6807\u8bb0\u3002 - L128\u2013L131\uff1a<code>GetLoadContext()</code>\uff1a\u8fd4\u56de ctx\uff08\u5f71\u54cd proto \u517c\u5bb9\u6027\u68c0\u67e5\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#34-l133l153","title":"3.4 \u8bed\u4e49\u7ea6\u675f\uff08L133\u2013L153\uff09","text":"<ul> <li>L135\uff1a\u5220\u9664 <code>operator==</code>\uff1a\u907f\u514d\u88ab unordered_map \u7b49\u8bef\u7528\u4e3a\u503c\u8bed\u4e49\u7b49\u4ef7\uff08\u8fd9\u91cc\u53ea\u4f9d\u8d56\u6307\u9488/\u54c8\u5e0c\uff09\u3002</li> <li>L137\u2013L139\uff1a\u5141\u8bb8 copy ctor\uff0c\u4f46\u7981\u7528 copy operator \u4e0e move\uff08\u7ed3\u5408 Arena \u5bb9\u5668\u4f7f\u7528\u4e60\u60ef\uff09\u3002</li> <li>L141\u2013L152\uff1a\u79c1\u6709\u5b57\u6bb5\uff1apf/name/protoId/accessFlags/isBase/classId/method/ctx/vmethodIndex\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#4-vtableinfo-vtable-copied-methods-l155l260","title":"4. <code>VTableInfo</code>\uff1a\u6784\u5efa\u4e2d\u7684 vtable + copied methods \u6620\u5c04\uff08L155\u2013L260\uff09","text":"<p>\u8fd9\u4e2a\u7ed3\u6784\u662f\u201cbuilder \u7684\u5de5\u4f5c\u533a\u201d\uff1a - <code>vmethods_</code>\uff1a<code>MethodInfo* -&gt; MethodEntry</code>\uff08\u5b58 index + candidate override\uff09\u3002 - <code>copiedMethods_</code>\uff1a<code>MethodInfo* -&gt; CopiedMethodEntry</code>\uff08\u5b58 copied index + status\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#41-l157l160","title":"4.1 \u5bb9\u5668\u9009\u62e9\uff08L157\u2013L160\uff09","text":"<ul> <li>\u4f7f\u7528 <code>ArenaUnorderedMap</code>\uff0ckey \u662f <code>MethodInfo const*</code>\uff08\u6ce8\u610f\uff1akey \u7684\u201c\u8eab\u4efd\u201d\u662f MethodInfo \u5bf9\u8c61\u5730\u5740\uff09\u3002</li> <li>\u5206\u914d\u5668\u6765\u81ea builder \u5185\u90e8 <code>ArenaAllocator</code>\uff08\u89c1\u540e\u9762\u7684 <code>allocator_</code>\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#42-methodentryl162l188","title":"4.2 <code>MethodEntry</code>\uff1a\u5019\u9009\u8986\u76d6\uff08L162\u2013L188\uff09","text":"<p>\u6838\u5fc3\u8bed\u4e49\uff1a - index_\uff1a\u8be5\u6761\u76ee\u5728 vtable/copy \u5217\u8868\u4e2d\u7684\u7a33\u5b9a\u5e8f\u53f7\u3002 - candidate_\uff1a\u5982\u679c\u6d3e\u751f\u7c7b\u65b9\u6cd5\u8986\u76d6\u4e86 base \u65b9\u6cd5\uff0c\u5219 candidate_ \u6307\u5411\u201c\u66ff\u6362\u65b9\u6cd5\u201d\uff1b\u5426\u5219\u4e3a\u7a7a\u3002 - CandidateOr(orig)\uff1a\u82e5 candidate \u975e\u7a7a\u8fd4\u56de candidate\uff0c\u5426\u5219\u8fd4\u56de orig\uff08\u7528\u4e8e\u751f\u6210\u6700\u7ec8 vtable\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#43-copiedmethodentryl190l211","title":"4.3 <code>CopiedMethodEntry</code>\uff1a\u9ed8\u8ba4\u65b9\u6cd5\u590d\u5236\u72b6\u6001\uff08L190\u2013L211\uff09","text":"<p>\u6838\u5fc3\u8bed\u4e49\uff1a - index_\uff1acopied method \u5728 copiedMethods_ \u4e2d\u7684\u7a33\u5b9a\u5e8f\u53f7\u3002 - status_\uff1a<code>CopiedMethod::Status</code>\uff08ORDINARY/ABSTRACT/CONFLICT\uff09\u7528\u4e8e\u6807\u8bb0\u51b2\u7a81/\u62bd\u8c61\u7b49\u60c5\u51b5\uff08\u5177\u4f53\u4f55\u65f6\u7f6e\u4f4d\u7531\u6d3e\u751f\u7b56\u7565\u51b3\u5b9a\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#44-methodnamehashl251l256","title":"4.4 <code>MethodNameHash</code>\uff08L251\u2013L256\uff09","text":"<ul> <li>\u5bf9 <code>MethodInfo-&gt;GetName().data</code> \u505a <code>GetHash32String</code>\u3002</li> <li>\u6ce8\u610f\uff1a\u54c8\u5e0c\u53ea\u57fa\u4e8e name\uff0c\u4e0d\u542b proto\uff1b\u56e0\u6b64\u540c\u540d\u4e0d\u540c\u7b7e\u540d\u7684\u65b9\u6cd5\u4f1a\u843d\u5728\u540c bucket\uff0c\u9700\u8981\u901a\u8fc7 <code>SameNameMethodInfoIterator</code> \u8fdb\u4e00\u6b65\u6309 proto \u8fc7\u6ee4\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#45-l233l248","title":"4.5 \u5bf9\u5916\u63a5\u53e3\u58f0\u660e\uff08L233\u2013L248\uff09","text":"<p>\u8fd9\u4e9b\u51fd\u6570\u5927\u591a\u5728 <code>vtable_builder_base-inl.h</code> inline \u5b9e\u73b0\uff1a - <code>AddEntry</code>\uff1a\u63d2\u5165 vmethods_\uff0cindex = \u5f53\u524d size\u3002 - <code>AddCopiedEntry/UpdateCopiedEntry</code>\uff1a\u7ba1\u7406 copiedMethods_ \u7684\u63d2\u5165\u4e0e\u66ff\u6362\u3002 - <code>UpdateClass</code>\uff1a\u628a\u6700\u7ec8 vtable/copy \u5199\u56de\u5230 <code>Class</code> \u5bf9\u8c61\uff08\u4f1a\u8bbe\u7f6e <code>Method::vtable_index</code> \u7b49\uff09\u3002 - <code>DumpMappings/DumpVTable</code>\uff1a\u8c03\u8bd5\u8f93\u51fa\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#5-filterbucketiterator-samenamemethodinfoiteratorl262l316","title":"5. <code>FilterBucketIterator</code> + <code>SameNameMethodInfoIterator</code>\uff08L262\u2013L316\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#51","title":"5.1 \u4e3a\u4ec0\u4e48\u9700\u8981\u5b83","text":"<p>\u56e0\u4e3a <code>ArenaUnorderedMap</code> \u7684 key \u662f <code>MethodInfo*</code>\uff0c\u4f46 <code>MethodNameHash</code> \u53ea\u6309 name \u54c8\u5e0c\uff0c\u6240\u4ee5\uff1a - \u540c bucket \u5185\u53ef\u80fd\u5305\u542b\u201c\u540c\u540d\u4e0d\u540c proto \u7684\u65b9\u6cd5\u201d\uff1b - \u751a\u81f3 key \u4e0d\u540c\u4f46 name \u76f8\u540c\u7684\u65b9\u6cd5\u9700\u8981\u4e00\u8d77\u904d\u5386\u7528\u4e8e override/\u51b2\u7a81\u68c0\u6d4b\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#52-filterbucketiteratorl262l309","title":"5.2 <code>FilterBucketIterator</code>\uff08L262\u2013L309\uff09","text":"<ul> <li>\u6784\u9020\u51fd\u6570\uff1a\u7528 <code>umap.bucket(key)</code> \u5b9a\u4f4d bucket\uff0c\u7136\u540e\u4ece\u8be5 bucket \u7684 begin \u5230 end \u8fed\u4ee3\u3002</li> <li><code>Advance()</code>\uff1a\u8df3\u8fc7\u4e0d\u6ee1\u8db3 pred \u7684\u5143\u7d20\u3002</li> <li><code>IsEmpty()</code>\uff1avalid_ \u6216\u8fed\u4ee3\u5230 end\u3002</li> <li><code>Value()/Next()</code>\uff1a\u8bbf\u95ee\u4e0e\u524d\u8fdb\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#53-samenamemethodinfoiteratorl311l316","title":"5.3 <code>SameNameMethodInfoIterator</code>\uff08L311\u2013L316\uff09","text":"<ul> <li>pred\uff1a<code>other-&gt;first-&gt;GetName() == info-&gt;GetName()</code>\uff08\u6ce8\u610f\uff1a<code>other</code> \u662f bucket iterator \u6307\u5411\u7684 pair\uff0c<code>first</code> \u4e3a <code>MethodInfo*</code>\uff09\u3002</li> <li>\u8fd4\u56de\u8fc7\u6ee4\u540e\u7684 bucket iterator\uff1a\u7528\u4e8e\u6d3e\u751f\u7b56\u7565\uff08\u4f8b\u5982 variance builder\uff09\u904d\u5386\u201c\u540c\u540d\u65b9\u6cd5\u96c6\u5408\u201d\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#6-vtablebuilderbasevisit_superitablel318l369","title":"6. <code>VTableBuilderBase&lt;VISIT_SUPERITABLE&gt;</code>\uff1a\u57fa\u7840\u6784\u5efa\u9aa8\u67b6\uff08L318\u2013L369\uff09","text":"<p>\u5173\u952e\uff1a\u672c\u7c7b\u53ea\u63d0\u4f9b\u201c\u6d41\u7a0b\u9aa8\u67b6\u201d\uff0c\u771f\u6b63\u7684\u8986\u76d6/\u51b2\u7a81/\u534f\u53d8\u517c\u5bb9\u7b56\u7565\u901a\u8fc7\u4e24\u4e2a\u7eaf\u865a\u94a9\u5b50\u6ce8\u5165\uff1a - <code>ProcessClassMethod</code>\uff08\u5904\u7406\u4e00\u4e2a\u672c\u7c7b\u865a\u65b9\u6cd5\uff09 - <code>ProcessDefaultMethod</code>\uff08\u5904\u7406\u4e00\u4e2a\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\uff0c\u51b3\u5b9a\u662f\u5426 copied/\u51b2\u7a81\uff09</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#61-l322l341","title":"6.1 \u5bf9\u5916\u63a5\u53e3\uff08L322\u2013L341\uff09","text":"<ul> <li>L322\uff1a<code>Build(cda, baseClass, itable, ctx)</code>\uff1a\u4ece panda_file \u5143\u6570\u636e\u6784\u5efa\uff08\u5b9e\u73b0\u89c1 <code>vtable_builder_base-inl.h</code>\uff09\u3002</li> <li>L324\uff1a<code>Build(methods, baseClass, itable, isInterface)</code>\uff1a\u4ece runtime <code>Span&lt;Method&gt;</code> \u6784\u5efa\uff08\u7528\u4e8e\u67d0\u4e9b\u8bed\u8a00/\u5408\u6210\u7c7b\u8def\u5f84\uff09\u3002</li> <li>L326\uff1a<code>UpdateClass(klass)</code>\uff1a\u628a\u7ed3\u679c\u5199\u56de Class\uff08\u5b9e\u73b0\u89c1 inl\uff09\u3002</li> <li>L328\u2013L336\uff1a<code>GetNumVirtualMethods/GetVTableSize</code>\uff1a\u63d0\u4f9b\u6784\u5efa\u7edf\u8ba1\u7ed9 ClassLinker\u3002</li> <li>L338\u2013L341\uff1a<code>GetCopiedMethods</code>\uff1a\u8fd4\u56de\u6784\u5efa\u51fa\u7684 copied methods \u5217\u8868\uff08\u6709\u5e8f\u6570\u7ec4\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#62-l343l347","title":"6.2 \u53d7\u4fdd\u62a4\u6784\u9020\u4e0e\u7b56\u7565\u94a9\u5b50\uff08L343\u2013L347\uff09","text":"<ul> <li>L344\uff1a\u6784\u9020\u51fd\u6570\u9700\u8981 <code>ClassLinkerErrorHandler*</code>\uff08\u51b2\u7a81\u62a5\u9519\u901a\u8fc7\u5b83\u4e0a\u629b\uff09\u3002</li> <li>L346\uff1a<code>ProcessClassMethod</code>\uff1a\u7531\u6d3e\u751f\u7c7b\u5b9e\u73b0\uff08\u4f8b\u5982 variance override \u89c4\u5219\uff09\u3002</li> <li>L347\uff1a<code>ProcessDefaultMethod</code>\uff1a\u7531\u6d3e\u751f\u7c7b\u5b9e\u73b0\uff08\u5904\u7406\u9ed8\u8ba4\u65b9\u6cd5\u51b2\u7a81/\u8986\u76d6\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#63-l349l354","title":"6.3 \u5de5\u4f5c\u533a\u5b57\u6bb5\uff08L349\u2013L354\uff09","text":"<ul> <li>allocator_\uff1a\u5185\u90e8 ArenaAllocator\uff08internal space\uff09\u3002</li> <li>vtable_\uff1a<code>VTableInfo</code> \u5de5\u4f5c\u533a\u3002</li> <li>numVmethods_\uff1a\u8ba1\u6570\u672c\u7c7b\u865a\u65b9\u6cd5\u6570\u91cf\uff08\u63a5\u53e3\uff1a\u8ba1\u6570\u975e static \u65b9\u6cd5\uff1b\u666e\u901a\u7c7b\uff1a\u8ba1\u6570 non-static methods \u4f5c\u4e3a vmethods\uff09\u3002</li> <li>orderedCopiedMethods_\uff1a\u6700\u7ec8\u5bf9\u5916\u66b4\u9732\u7684 copied methods \u6570\u7ec4\uff08\u6309 entry.GetIndex() \u653e\u7f6e\uff09\u3002</li> <li>errorHandler_\uff1a\u9519\u8bef\u4e0a\u62a5\u901a\u9053\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#64-l355l368","title":"6.4 \u79c1\u6709\u6d41\u7a0b\u6b65\u9aa4\u58f0\u660e\uff08L355\u2013L368\uff09","text":"<p>\u8fd9\u4e9b\u6b65\u9aa4\u7684 inline \u5b9e\u73b0\u5728 <code>vtable_builder_base-inl.h</code>\uff1a - <code>BuildForInterface(...)</code>\uff1a\u63a5\u53e3\u7279\u6b8a\u5904\u7406\uff1a\u53ea\u8ba1\u6570 &amp; \u8bb0\u5f55\u662f\u5426\u5b58\u5728 default \u65b9\u6cd5\uff08\u4e0d\u6784\u5efa vtable \u6620\u5c04\uff09\u3002 - <code>AddBaseMethods(baseClass)</code>\uff1a\u628a baseClass vtable \u65b9\u6cd5\u4f5c\u4e3a\u201cbase entries\u201d\u585e\u5165 vtable_\uff08isBase_=true\uff09\u3002 - <code>AddClassMethods(...)</code>\uff1a\u679a\u4e3e\u672c\u7c7b\u865a\u65b9\u6cd5\uff0c\u9010\u4e2a\u8c03\u7528 <code>ProcessClassMethod</code>\u3002 - <code>AddDefaultInterfaceMethods(itable, superItableSize)</code>\uff1a\u4ece itable \u4e2d\u5012\u5e8f\u904d\u5386\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\u5e76\u8c03\u7528 <code>ProcessDefaultMethod</code>\uff0c\u540c\u65f6\u751f\u6210 <code>orderedCopiedMethods_</code>\u3002 - <code>hasDefaultMethods_</code>\uff1a\u63a5\u53e3\u6784\u5efa\u8def\u5f84\u4e0b\u6807\u8bb0\u662f\u5426\u5b58\u5728 default \u65b9\u6cd5\uff08\u7528\u4e8e UpdateClass \u5199\u56de <code>ACC_HAS_DEFAULT_METHODS</code>\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#7-vtable_builder_base-inlh","title":"7. \u4e0e <code>vtable_builder_base-inl.h</code> \u7684\u5173\u952e\u5bf9\u5e94\u5173\u7cfb\uff08\u5b9e\u73b0\u5165\u53e3\uff09","text":"<p>\u672c\u6587\u4ef6\u58f0\u660e\u7684\u6838\u5fc3\u6d41\u7a0b\u5728 <code>vtable_builder_base-inl.h</code> \u4e2d\u5b9e\u73b0\uff08\u5efa\u8bae\u4f18\u5148\u9605\u8bfb\u4ee5\u4e0b\u6bb5\u843d\uff09\uff1a - <code>BuildForInterface</code>\uff1aL50\u2013L81\uff08\u7edf\u8ba1 numVmethods_ \u4e0e hasDefaultMethods_\uff09\u3002 - <code>AddBaseMethods</code>\uff1aL83\u2013L94\uff08\u628a baseClass \u7684 vtable \u65b9\u6cd5\u6ce8\u5165 vtable_\uff09\u3002 - <code>AddClassMethods</code>\uff1aL96\u2013L135\uff08\u679a\u4e3e non-static methods \u5e76\u8c03\u7528 <code>ProcessClassMethod</code>\uff09\u3002 - <code>AddDefaultInterfaceMethods</code>\uff1aL137\u2013L174\uff08\u5012\u5e8f\u904d\u5386 itable\uff0c\u5904\u7406 default \u65b9\u6cd5\u5e76\u751f\u6210 copied methods \u6570\u7ec4\uff09\u3002 - <code>Build</code>\uff1aL176\u2013L212\uff08\u6574\u4f53\u987a\u5e8f\uff1ainterface fast path\uff0c\u5426\u5219 base\u2192class\u2192default\uff09\u3002 - <code>UpdateClass</code>\uff1aL214\u2013L229\uff08\u63a5\u53e3\uff1a\u5199\u56de vtable_index\uff1b\u666e\u901a\u7c7b\uff1a<code>vtable_.UpdateClass</code> \u5199\u56de\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_base.h/#8","title":"8. \u672c\u6587\u4ef6\u5f15\u51fa\u7684\u201c\u540c\u7ae0\u5f3a\u76f8\u5173\u6587\u4ef6\u201d\uff08\u52a8\u6001\u7eb3\u5165\u5019\u9009\uff09","text":"<p>\u7531 <code>#include</code> \u4e0e\u5f3a\u8026\u5408\u53ef\u5224\u5b9a\u4e3a 03 \u5f3a\u76f8\u5173\uff08\u5c06\u7eb3\u5165 manifest\uff09\uff1a - <code>runtime/include/vtable_builder_interface.h</code> - <code>runtime/include/vtable_builder_base-inl.h</code> - <code>runtime/include/vtable_builder_variance-inl.h</code>\uff08\u7b56\u7565\u5b9e\u73b0\uff0cP0\uff09 - <code>runtime/include/itable.h</code>\u3001<code>runtime/include/method.h</code>\u3001<code>runtime/include/class-inl.h</code> - <code>runtime/include/class_linker.h</code>\u3001<code>runtime/class_linker_context.h</code></p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/","title":"<code>runtime/include/vtable_builder_interface.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1avtable \u6784\u5efa\u5668\u5bf9\u5916\u63a5\u53e3\u5951\u7ea6 + copied default \u65b9\u6cd5\u7684\u8f93\u51fa\u6570\u636e\u7ed3\u6784\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#1-vtable","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u5b83\u5728 vtable \u6784\u5efa\u94fe\u8def\u91cc\u7684\u4f4d\u7f6e\uff09","text":"<p>\u672c\u6587\u4ef6\u5b9a\u4e49\u4e24\u4ef6\u4e8b\uff1a</p> <ol> <li><code>CopiedMethod</code>\uff1a\u7528\u4e8e\u628a\u201c\u63a5\u53e3 default \u65b9\u6cd5\u590d\u5236\u4f53\u201d\u7684\u8f93\u51fa\u643a\u5e26\u56de ClassLinker\uff08\u5e76\u5e26\u51b2\u7a81/\u62bd\u8c61\u72b6\u6001\uff09\u3002</li> <li><code>VTableBuilder</code>\uff1avtable/itable/imt \u6784\u5efa\u5668\u7684\u62bd\u8c61\u63a5\u53e3\uff0cClassLinker \u53ef\u4ee5\u7528\u4e0d\u540c\u5b9e\u73b0\uff08\u4e0d\u540c\u8bed\u8a00/\u4e0d\u540c\u8986\u76d6\u89c4\u5219\uff09\u6765\u6784\u5efa\u6d3e\u53d1\u8868\u7ed3\u6784\u3002</li> </ol>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#2-l1l25","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L25\uff09","text":"<ul> <li>L1\u2013L14\uff1aLicense\u3002</li> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_VTABLE_BUILDER_INTERFACE_H</code>\u3002</li> <li>L18\uff1a\u4f9d\u8d56 <code>runtime/include/method.h</code>\uff1a</li> <li><code>CopiedMethod</code> \u76f4\u63a5\u6301\u6709 <code>Method*</code></li> <li><code>VTableBuilder::Build</code> \u7684\u7b2c\u4e8c\u4e2a\u91cd\u8f7d\u4f7f\u7528 <code>Span&lt;Method&gt;</code></li> <li>L20\uff1a<code>namespace ark</code>\u3002</li> <li>L22\u2013L24\uff1a\u524d\u5411\u58f0\u660e <code>ClassLinker/ClassLinkerContext/ClassLinkerErrorHandler</code>\uff08\u63a5\u53e3\u53c2\u6570\u4e2d\u4f1a\u7528\u5230\u8fd9\u4e9b\u7c7b\u578b\uff1b\u5b8c\u6574\u5b9a\u4e49\u5728 class_linker \u76f8\u5173\u6587\u4ef6\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#3-copiedmethodl26l54","title":"3. <code>CopiedMethod</code>\uff1a\u9ed8\u8ba4\u65b9\u6cd5\u590d\u5236\u4f53\u8f93\u51fa\uff08L26\u2013L54\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#31-l26l29","title":"3.1 \u6784\u9020\u4e0e\u6301\u6709\uff08L26\u2013L29\uff09","text":"<ul> <li>L27\uff1a\u9ed8\u8ba4\u6784\u9020\uff1a\u5141\u8bb8\u4f5c\u4e3a\u5bb9\u5668\u5143\u7d20\u9ed8\u8ba4\u521d\u59cb\u5316\u3002</li> <li>L28\uff1a\u663e\u5f0f\u6784\u9020\uff1a\u7528 <code>Method* cpMethod</code> \u521d\u59cb\u5316 <code>method_</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#32-statusl30l34","title":"3.2 <code>Status</code>\uff08L30\u2013L34\uff09","text":"<p>\u4e09\u6001\u7528\u4e8e\u63cf\u8ff0 copied method \u7684\u8bed\u4e49\u7ed3\u679c\uff1a - ORDINARY\uff1a\u666e\u901a copied default \u65b9\u6cd5\u3002 - ABSTRACT\uff1adefault \u65b9\u6cd5\u5728\u67d0\u4e9b\u89e3\u6790\u89c4\u5219\u4e0b\u7b49\u4ef7\u4e8e abstract\uff08\u4f8b\u5982\u51b2\u7a81\u6d88\u89e3\u6216\u8bed\u8a00\u89c4\u5219\u5bfc\u81f4\u4e0d\u80fd\u4f5c\u4e3a\u53ef\u8c03\u7528\u5b9e\u73b0\uff09\u3002 - CONFLICT\uff1a\u591a\u4e2a\u63a5\u53e3\u9ed8\u8ba4\u5b9e\u73b0\u51b2\u7a81\uff08\u5e38\u89c1\uff1adiamond default methods\uff09\u3002</p> <p>\u8fd9\u4e9b\u72b6\u6001\u7531\u5177\u4f53 vtable builder \u7b56\u7565\u5728\u6784\u5efa\u8fc7\u7a0b\u4e2d\u7f6e\u4f4d\uff08\u89c1 <code>VTableInfo::CopiedMethodEntry</code> \u4e0e variance builder\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#33-l36l49","title":"3.3 \u8bbf\u95ee\u5668\uff08L36\u2013L49\uff09","text":"<ul> <li><code>GetMethod()</code>\uff1a\u8fd4\u56de <code>Method*</code>\u3002</li> <li><code>GetStatus()/SetStatus()</code>\uff1a\u8bfb\u5199 status\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#34-l51l54","title":"3.4 \u79c1\u6709\u5b57\u6bb5\uff08L51\u2013L54\uff09","text":"<ul> <li>method_\uff1a\u6307\u5411\u8fd0\u884c\u65f6 <code>Method</code> \u5bf9\u8c61\uff08\u4e0d\u662f panda_file accessor\uff09\u3002</li> <li>status_\uff1a\u9ed8\u8ba4 <code>ORDINARY</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#4-vtablebuilderl56l77","title":"4. <code>VTableBuilder</code>\uff1a\u6784\u5efa\u5668\u63a5\u53e3\uff08L56\u2013L77\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#41-build-l60l64","title":"4.1 \u4e24\u4e2a Build \u91cd\u8f7d\uff08L60\u2013L64\uff09","text":"<p>\u540c\u4e00\u7b56\u7565\u9700\u8981\u652f\u6301\u4e24\u7c7b\u8f93\u5165\uff1a - L60\u2013L61\uff1a<code>Build(panda_file::ClassDataAccessor*, Class* baseClass, ITable itable, ClassLinkerContext* ctx)</code>   - \u7528\u4e8e\u201c\u4ece panda_file \u5143\u6570\u636e\u201d\u6784\u5efa\uff08\u5178\u578b\u7c7b\u52a0\u8f7d\u8def\u5f84\uff09\u3002   - <code>ctx</code> \u5f71\u54cd proto \u517c\u5bb9\u6027/\u53ef\u89c1\u6027\u5224\u5b9a\uff08\u591a\u8bed\u8a00/\u591a\u4e0a\u4e0b\u6587\uff09\u3002 - L63\uff1a<code>Build(Span&lt;Method&gt; methods, Class* baseClass, ITable itable, bool isInterface)</code>   - \u7528\u4e8e\u201c\u5df2\u6709 runtime Method \u6570\u7ec4\u201d\u7684\u6784\u5efa\u8def\u5f84\uff08\u4f8b\u5982\u5408\u6210\u7c7b\u3001\u67d0\u4e9b\u8bed\u8a00\u7684\u7279\u6b8a\u6784\u5efa\u6d41\u7a0b\uff09\u3002   - <code>isInterface</code> \u8ba9 builder \u8d70 interface fast-path\uff08\u53ea\u7edf\u8ba1/\u8bbe\u7f6e\u7d22\u5f15\u7b49\uff09\u3002</p> <p>\u4e24\u4e2a\u91cd\u8f7d\u90fd\u8fd4\u56de bool\uff0c\u5e76\u7528 <code>[[nodiscard]]</code> \u5f3a\u5236\u8c03\u7528\u65b9\u68c0\u67e5\u5931\u8d25\uff08\u907f\u514d\u9759\u9ed8\u5ffd\u7565\u51b2\u7a81\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#42-l65l71","title":"4.2 \u5199\u56de\u4e0e\u7edf\u8ba1\u63a5\u53e3\uff08L65\u2013L71\uff09","text":"<ul> <li><code>UpdateClass(Class*)</code>\uff1a\u628a\u6784\u5efa\u7ed3\u679c\u5199\u56de\u5230 <code>Class</code>\uff08vtable/IMT/flags/vtable index \u7b49\uff09\u3002</li> <li><code>GetNumVirtualMethods()</code>\uff1a\u672c\u7c7b\u865a\u65b9\u6cd5\u6570\u91cf\uff08\u63a5\u53e3\uff1a\u975e static \u65b9\u6cd5\u6570\uff09\u3002</li> <li><code>GetVTableSize()</code>\uff1a\u6700\u7ec8 vtable \u5927\u5c0f\uff08\u542b\u65b0\u589e/\u8986\u76d6\u5904\u7406\u540e\u7684\u7ed3\u679c\uff09\u3002</li> <li><code>GetCopiedMethods()</code>\uff1a\u8f93\u51fa copied default methods \u7684\u5217\u8868\uff08\u7a33\u5b9a\u987a\u5e8f\u7531 builder \u5b9a\u4e49\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_interface.h/#43-l73l76","title":"4.3 \u6790\u6784\u4e0e\u4e0d\u53ef\u62f7\u8d1d\uff08L73\u2013L76\uff09","text":"<ul> <li>\u865a\u6790\u6784\uff1a\u5141\u8bb8\u901a\u8fc7\u57fa\u7c7b\u6307\u9488\u5220\u9664\u5b9e\u73b0\u7c7b\u3002</li> <li>\u7981\u6b62 copy/move\uff1abuilder \u4f5c\u4e3a\u72b6\u6001ful \u6784\u5efa\u8fc7\u7a0b\u5bf9\u8c61\uff0c\u4e0d\u5e94\u590d\u5236\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/","title":"<code>runtime/include/vtable_builder_variance-inl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1avtable \u6784\u5efa\u7684\u201c\u8986\u76d6/\u534f\u53d8/\u51b2\u7a81\u201d\u7b56\u7565\u5b9e\u73b0\uff08\u4e3a <code>VarianceVTableBuilder</code> \u63d0\u4f9b inline \u5b9a\u4e49\uff09 \u76f4\u63a5\u4f9d\u8d56\uff1a<code>vtable_builder_variance.h</code>\uff08\u7c7b\u58f0\u660e\uff09\u3001<code>vtable_builder_base-inl.h</code>\uff08\u57fa\u7840\u6d41\u7a0b+VTableInfo \u64cd\u4f5c\uff09\u3001<code>ClassLinker::Error</code>\uff08\u51b2\u7a81\u9519\u8bef\u7801\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#1","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u8fd9\u4efd\u7b56\u7565\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\uff09","text":"<p><code>VTableBuilderBase</code> \u53ea\u7ed9\u51fa\u201c\u6784\u5efa\u6d41\u7a0b\u9aa8\u67b6\u201d\uff0c\u5e76\u901a\u8fc7\u4e24\u4e2a\u94a9\u5b50\u628a\u7b56\u7565\u4ea4\u7ed9\u6d3e\u751f\u7c7b\uff1a - <code>ProcessClassMethod</code>\uff1a\u5f53\u4e00\u4e2a\u201c\u672c\u7c7b\u865a\u65b9\u6cd5\u201d\u51fa\u73b0\u65f6\uff0c\u5982\u4f55\u5224\u5b9a\u5b83\u662f\u5426\u8986\u76d6\uff08override\uff09base \u65b9\u6cd5\uff1f\u5982\u679c\u8986\u76d6\uff0c\u5982\u4f55\u66ff\u6362\u5019\u9009\uff1f\u5982\u679c\u4e0d\u8986\u76d6\uff0c\u662f\u5426\u4f5c\u4e3a\u65b0 entry \u52a0\u5165 vtable\uff1f - <code>ProcessDefaultMethod</code>\uff1a\u5f53\u53d1\u73b0\u63a5\u53e3 default \u65b9\u6cd5\u65f6\uff0c\u662f\u5426\u9700\u8981\u751f\u6210 copied method\uff1f\u5982\u4f55\u5904\u7406\u201c\u591a\u63a5\u53e3\u9ed8\u8ba4\u5b9e\u73b0\u51b2\u7a81\u201d\uff1f</p> <p>\u672c\u6587\u4ef6\u5b9e\u73b0\u7684\u7b56\u7565\u7279\u70b9\uff1a - \u6309 name \u5206\u6876\u904d\u5386\uff08\u540c\u540d\u65b9\u6cd5\u96c6\u5408\uff09\uff0c\u907f\u514d\u5168\u8868\u626b\u63cf\uff08\u4f9d\u8d56 <code>SameNameMethodInfoIterator</code>\uff09\u3002 - \u8986\u76d6\u5224\u5b9a\u4e0d\u4ec5\u57fa\u4e8e\u201cproto \u76f4\u63a5\u76f8\u7b49\u201d\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>ProtoCompatibility(ctx)</code> \u505a\u66f4\u5bbd\u677e/\u534f\u53d8\u7684\u517c\u5bb9\u5224\u65ad\uff08\u6a21\u677f\u53c2\u6570\uff09\u3002 - \u51b2\u7a81\u901a\u8fc7 <code>OnVTableConflict</code> \u4e0a\u62a5\uff0c\u5e76\u8fd4\u56de false \u7ec8\u6b62\u6784\u5efa\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#2-l1l21","title":"2. \u5934\u90e8\uff08L1\u2013L21\uff09","text":"<ul> <li>L1\u2013L14\uff1aLicense\u3002</li> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_VTABLE_BUILDER_VARIANCE_INL_H</code>\u3002</li> <li>L18\uff1a\u5305\u542b <code>vtable_builder_variance.h</code>\uff08<code>VarianceVTableBuilder</code> \u58f0\u660e\uff09\u3002</li> <li>L19\uff1a\u5305\u542b <code>vtable_builder_base-inl.h</code>\uff08<code>VTableInfo</code> \u7684 inline \u64cd\u4f5c\u3001<code>OnVTableConflict</code> \u58f0\u660e\u7b49\uff09\u3002</li> <li>L21\uff1a<code>namespace ark {</code>\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#3-isoverriddenby-isoverriddenoroverridesl23l43","title":"3. \u8986\u76d6\u5173\u7cfb\u5224\u5b9a\uff1a<code>IsOverriddenBy</code> / <code>IsOverriddenOrOverrides</code>\uff08L23\u2013L43\uff09","text":""},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#31-isoverriddenbyctx-base-dervl23l32","title":"3.1 <code>IsOverriddenBy(ctx, base, derv)</code>\uff08L23\u2013L32\uff09","text":"<ul> <li>L28\u2013L30\uff1a\u5feb\u8def\u5f84\uff1a\u82e5 <code>base</code> \u4e0e <code>derv</code> \u6765\u81ea\u540c\u4e00 panda_file \u4e14 entityId \u76f8\u7b49\uff0c\u5219\u89c6\u4e3a\u201c\u540c\u4e00\u539f\u578b\u201d\u2192 true\u3002</li> <li>L31\uff1a\u5426\u5219\u8c03\u7528 <code>ProtoCompatibility(ctx)(base, derv)</code>\uff1a</li> <li><code>ProtoCompatibility</code> \u662f\u4e00\u4e2a\u53ef\u8c03\u7528\u5bf9\u8c61\u7c7b\u578b\uff08functor\uff09\uff0c\u7531\u6a21\u677f\u53c2\u6570\u6ce8\u5165\u3002</li> <li>\u8bed\u4e49\uff1a\u5224\u65ad <code>derv</code> \u662f\u5426\u80fd\u8986\u76d6 <code>base</code>\uff08\u4f8b\u5982\u652f\u6301\u534f\u53d8\u8fd4\u56de\u7c7b\u578b/\u7279\u6b8a\u8bed\u8a00\u89c4\u5219\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#32-isoverriddenoroverridesctx-p1-p2l34l43","title":"3.2 <code>IsOverriddenOrOverrides(ctx, p1, p2)</code>\uff08L34\u2013L43\uff09","text":"<ul> <li>L39\u2013L41\uff1a\u540c file \u540c entity \u2192 true\u3002</li> <li>L42\uff1a\u5426\u5219\uff1a<code>ProtoCompatibility(ctx)(p1, p2) || ProtoCompatibility(ctx)(p2, p1)</code>\uff1a</li> <li>\u7528\u4e8e\u201c\u51b2\u7a81\u68c0\u6d4b\u201d\uff1a\u53ea\u8981\u4e24\u8fb9\u5b58\u5728\u8986\u76d6\u5173\u7cfb\uff08\u4efb\u610f\u65b9\u5411\uff09\uff0c\u5c31\u8ba4\u4e3a\u4e24\u8005\u5b58\u5728\u53ef\u51b2\u7a81\u7684\u8986\u76d6/\u88ab\u8986\u76d6\u8054\u7cfb\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#4-processclassmethodl45l77","title":"4. \u5904\u7406\u672c\u7c7b\u865a\u65b9\u6cd5\uff1a<code>ProcessClassMethod</code>\uff08L45\u2013L77\uff09","text":"<p>\u76ee\u6807\uff1a\u628a\u201c\u672c\u7c7b\u65b9\u6cd5 info\u201d\u52a0\u5165 vtable_\uff0c\u6216\u8005\u66ff\u6362\u67d0\u4e2a base \u65b9\u6cd5 entry \u7684 candidate\u3002</p> <ul> <li>L48\uff1a\u53d6 <code>ctx = info-&gt;GetLoadContext()</code>\uff0c\u7528\u4e8e proto \u517c\u5bb9\u6027\u5224\u5b9a\u3002</li> <li>L49\uff1a<code>compatibleFound=false</code>\uff1a\u6807\u8bb0\u662f\u5426\u627e\u5230\u4e86\u53ef\u8986\u76d6\u7684 base \u65b9\u6cd5\u3002</li> <li>L51\u2013L71\uff1a\u904d\u5386 <code>SameNameMethodInfoIterator(vtable_.Methods(), info)</code>\uff1a</li> <li>\u53ea\u4f1a\u5728\u540c bucket \u5185\u7b5b\u51fa\u201c\u540c\u540d\u65b9\u6cd5\u201d\u96c6\u5408\uff0c\u907f\u514d\u904d\u5386\u6574\u4e2a map\u3002</li> <li>L54\u2013L56\uff1a\u8df3\u8fc7\u975e base \u65b9\u6cd5\uff08\u53ea\u5141\u8bb8\u8986\u76d6 base \u6761\u76ee\uff1b\u672c\u7c7b\u5185\u90e8\u540c\u540d\u65b9\u6cd5\u7684\u5904\u7406\u8d70 <code>AddEntry</code>\uff09\u3002</li> <li>L57\uff1a\u8986\u76d6\u5224\u5b9a\u9700\u8981\u540c\u65f6\u6ee1\u8db3\uff1a<ul> <li><code>IsOverriddenBy(ctx, itInfo-&gt;GetProtoId(), info-&gt;GetProtoId())</code></li> <li><code>OverridePred()(itInfo, info)</code>\uff1a\u7b2c\u4e8c\u4e2a\u6a21\u677f\u53c2\u6570\u6ce8\u5165\u989d\u5916\u8c13\u8bcd\uff08\u4f8b\u5982\u8bbf\u95ee\u63a7\u5236/\u53ef\u89c1\u6027/\u8bed\u8a00\u7279\u5b9a\u89c4\u5219\uff09\u3002</li> </ul> </li> <li>L58\u2013L62\uff1a\u82e5 base \u65b9\u6cd5\u662f final\uff1a\u51b2\u7a81 <code>OVERRIDES_FINAL</code>\uff0c\u6784\u5efa\u5931\u8d25\u8fd4\u56de false\u3002</li> <li>L63\u2013L67\uff1a\u82e5\u8be5 base entry \u5df2\u7ecf\u6709 candidate\uff08\u8bf4\u660e\u51fa\u73b0\u591a\u4e2a override\uff09\uff1a\u51b2\u7a81 <code>MULTIPLE_OVERRIDE</code>\uff0c\u5931\u8d25\u8fd4\u56de false\u3002</li> <li>L68\u2013L70\uff1a\u8bbe\u7f6e candidate \u4e3a\u5f53\u524d info\uff0c\u5e76\u7f6e <code>compatibleFound=true</code>\u3002</li> <li>L73\u2013L75\uff1a\u5982\u679c\u6ca1\u6709\u627e\u5230\u4efb\u4f55\u53ef\u8986\u76d6\u7684 base \u65b9\u6cd5\uff1a\u628a\u5f53\u524d\u65b9\u6cd5\u4f5c\u4e3a\u65b0 entry \u52a0\u5165 <code>vtable_</code>\uff08\u6269\u5c55 vtable\uff09\u3002</li> <li>L76\uff1a\u6210\u529f\u8fd4\u56de true\u3002</li> </ul> <p>\u8fd9\u91cc\u7684\u5173\u952e\u7ea6\u675f\uff1a - \u53ea\u8986\u76d6 base\uff08<code>IsBase()</code>\uff09\u7684\u65b9\u6cd5\u6761\u76ee\uff1b\u907f\u514d\u201c\u540c\u4e00\u7c7b\u5185\u540c\u540d\u65b9\u6cd5\u201d\u4e92\u76f8\u8986\u76d6\u9020\u6210\u4e0d\u7a33\u5b9a\u3002 - \u540c\u4e00 base \u6761\u76ee\u6700\u591a\u5141\u8bb8\u4e00\u4e2a candidate\uff0c\u5426\u5219\u89c6\u4e3a\u591a\u91cd\u8986\u76d6\u9519\u8bef\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#5-scanconflictingdefaultmethodsl79l119","title":"5. \u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u51b2\u7a81\u626b\u63cf\uff1a<code>ScanConflictingDefaultMethods</code>\uff08L79\u2013L119\uff09","text":"<p>\u8fd4\u56de\u7c7b\u578b\uff1a<code>std::optional&lt;MethodInfo const *&gt;</code> - \u8fd4\u56de <code>std::nullopt</code>\uff1a\u8868\u793a\u201c\u8df3\u8fc7\u672c default method\u201d\uff08\u56e0\u4e3a\u5b83\u88ab\u7c7b\u4e2d\u7684\u975e\u63a5\u53e3\u65b9\u6cd5\u8986\u76d6\u4e86\uff0c\u6216\u4e0d\u5e94\u52a0\u5165 copied\uff09\u3002 - \u8fd4\u56de <code>nullptr</code>\uff1a\u8868\u793a\u201c\u6ca1\u6709\u51b2\u7a81\uff0c\u5141\u8bb8\u9996\u6b21\u52a0\u5165 copied methods\u201d\u3002 - \u8fd4\u56de \u975e\u7a7a\u6307\u9488\uff1a\u8868\u793a\u201c\u53d1\u73b0\u51b2\u7a81\u7684\u63a5\u53e3 default \u65b9\u6cd5\u201d\uff0c\u8c03\u7528\u8005\u5e94\u4e0a\u62a5\u51b2\u7a81\u3002</p> <p>\u626b\u63cf\u5206\u4e09\u6bb5\uff1a</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#51-l85l94","title":"5.1 \u68c0\u67e5\u662f\u5426\u88ab\u7c7b\u4e2d\u7684\u975e\u63a5\u53e3\u65b9\u6cd5\u8986\u76d6\uff08L85\u2013L94\uff09","text":"<ul> <li>L86\uff1a\u5bf9\u6bcf\u4e2a\u540c\u540d\u6761\u76ee\uff0c\u53d6 \u201ccandidate \u6216 orig\u201d\uff08<code>CandidateOr</code>\uff09\u4ee3\u8868\u6700\u7ec8\u4f1a\u51fa\u73b0\u5728 vtable \u7684\u65b9\u6cd5\u3002</li> <li>L87\u2013L88\uff1a\u82e5\u8be5\u6761\u76ee\u662f interface \u65b9\u6cd5\u5219\u8df3\u8fc7\uff08\u6211\u4eec\u5173\u5fc3\u7c7b\u65b9\u6cd5\u5bf9 default \u7684\u8986\u76d6\uff09\u3002</li> <li>L90\u2013L92\uff1a\u82e5 default \u7684 proto \u88ab\u8be5\u7c7b\u65b9\u6cd5\u8986\u76d6\uff08<code>IsOverriddenBy(ctx, info, itinfo)</code>\uff09\uff0c\u5219\u8fd4\u56de <code>std::nullopt</code>\uff1a\u8868\u793a default \u4e0d\u9700\u8981 copied\uff08\u7c7b\u65b9\u6cd5\u4f18\u5148\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#52-vtable-l95l105","title":"5.2 \u68c0\u67e5\u4e0e vtable \u4e2d\u7684\u63a5\u53e3\u65b9\u6cd5\u51b2\u7a81\uff08L95\u2013L105\uff09","text":"<ul> <li>\u53ea\u5173\u5fc3 interface \u65b9\u6cd5\u6761\u76ee\u3002</li> <li>L100\uff1a\u65ad\u8a00\u51b2\u7a81\u65b9\u6cd5\u6765\u81ea\u4e0d\u540c\u63a5\u53e3\u7c7b\uff08\u9632\u81ea\u51b2\u7a81\uff09\u3002</li> <li>L101\u2013L103\uff1a\u82e5\u4e24\u8005\u5b58\u5728\u8986\u76d6/\u88ab\u8986\u76d6\u5173\u7cfb\uff08\u4efb\u610f\u65b9\u5411\uff09\uff0c\u8fd4\u56de\u51b2\u7a81\u63a5\u53e3\u65b9\u6cd5\u6307\u9488\uff08\u975e\u7a7a\uff09\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#53-copied-methods-l106l117","title":"5.3 \u68c0\u67e5\u4e0e\u5df2\u52a0\u5165\u7684 copied methods \u51b2\u7a81\uff08L106\u2013L117\uff09","text":"<ul> <li>\u904d\u5386 <code>vtable_.CopiedMethods()</code> \u4e2d\u540c\u540d\u6761\u76ee\u3002</li> <li>\u8df3\u8fc7\u975e\u63a5\u53e3\u65b9\u6cd5\u4e0e\u540c\u4e00\u63a5\u53e3\u7c7b\u7684 default\uff08\u907f\u514d\u91cd\u590d\uff09\u3002</li> <li>\u82e5\u8986\u76d6/\u88ab\u8986\u76d6\u5173\u7cfb\u6210\u7acb\uff0c\u8fd4\u56de\u51b2\u7a81\u6307\u9488\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#54-l118","title":"5.4 \u65e0\u51b2\u7a81\uff08L118\uff09","text":"<ul> <li>\u8fd4\u56de <code>nullptr</code>\uff1a\u8868\u793a\u53ef\u52a0\u5165\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#6-processdefaultmethodl121l141","title":"6. \u5904\u7406\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\uff1a<code>ProcessDefaultMethod</code>\uff08L121\u2013L141\uff09","text":"<ul> <li>L125\uff1a\u5148\u8c03\u7528 <code>ScanConflictingDefaultMethods(methodInfo)</code>\u3002</li> <li>L126\u2013L128\uff1a\u82e5\u8fd4\u56de <code>std::nullopt</code>\uff1a\u8df3\u8fc7\uff08\u89c6\u4e3a\u6210\u529f\uff0c\u7ee7\u7eed\u5904\u7406\u5176\u5b83 default \u65b9\u6cd5\uff09\u3002</li> <li>L129\uff1a\u5426\u5219\u53d6 <code>conflict</code>\uff08\u53ef\u80fd\u4e3a nullptr \u6216\u6307\u5411\u51b2\u7a81\u65b9\u6cd5\uff09\u3002</li> <li>L130\uff1a<code>iface</code> \u4ec5\u7528\u4e8e\u8c03\u8bd5\uff08<code>[[maybe_unused]]</code>\uff09\u3002</li> <li>L132\u2013L136\uff1a\u82e5 <code>conflict == nullptr</code>\uff1a\u8bf4\u660e\u9996\u6b21\u52a0\u5165 \u2192 <code>vtable_.AddCopiedEntry(methodInfo)</code> \u5e76\u8fd4\u56de true\u3002</li> <li>L138\u2013L140\uff1a\u5426\u5219\u4e0a\u62a5\u51b2\u7a81 <code>MULTIPLE_IMPLEMENT</code>\uff08\u591a\u4e2a\u9ed8\u8ba4\u5b9e\u73b0\u51b2\u7a81\uff09\uff0c\u8fd4\u56de false \u7ec8\u6b62\u6784\u5efa\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#7-l143l145","title":"7. \u6587\u4ef6\u5c3e\uff08L143\u2013L145\uff09","text":"<ul> <li>L143\uff1a\u7ed3\u675f\u547d\u540d\u7a7a\u95f4\u3002</li> <li>L145\uff1a\u7ed3\u675f include guard\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance-inl.h/#8","title":"8. \u4e0e\u57fa\u7840\u6d41\u7a0b\u7684\u62fc\u88c5\u70b9\uff08\u8bfb\u8005\u8def\u7ebf\uff09","text":"<p>\u8981\u7406\u89e3\u672c\u6587\u4ef6\u7684\u5b9e\u9645\u6548\u679c\uff0c\u9700\u8981\u628a\u5b83\u653e\u56de <code>VTableBuilderBase::AddClassMethods/AddDefaultInterfaceMethods</code> \u7684\u8c03\u7528\u94fe\uff1a - <code>AddBaseMethods</code> \u628a baseClass vtable \u653e\u5165 <code>vtable_.Methods()</code>\uff08\u6bcf\u4e2a\u6761\u76ee <code>isBase_=true</code>\uff09\u3002 - <code>AddClassMethods</code> \u5bf9\u6bcf\u4e2a\u672c\u7c7b\u865a\u65b9\u6cd5\u8c03\u7528 <code>ProcessClassMethod</code>\uff1a   - \u8986\u76d6 base \u2192 \u8bbe\u7f6e candidate\uff08\u4e0d\u589e\u52a0 vtable \u5927\u5c0f\uff09   - \u65b0\u589e\u65b9\u6cd5 \u2192 <code>AddEntry</code> \u6269\u5c55 vtable - <code>AddDefaultInterfaceMethods</code> \u5bf9\u6bcf\u4e2a default \u65b9\u6cd5\u8c03\u7528 <code>ProcessDefaultMethod</code>\uff1a   - \u65e0\u51b2\u7a81 \u2192 <code>AddCopiedEntry</code>   - \u51b2\u7a81 \u2192 <code>OnVTableConflict(MULTIPLE_IMPLEMENT)</code> \u5e76\u7ec8\u6b62</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance.h/","title":"<code>runtime/include/vtable_builder_variance.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 03_ClassLoading \u6587\u4ef6\u7c7b\u578b\uff1aVariance vtable builder \u7684\u58f0\u660e\uff08\u628a\u201c\u57fa\u7840\u6d41\u7a0b\u9aa8\u67b6\u201d\u4e0e\u201c\u8986\u76d6/\u51b2\u7a81\u7b56\u7565\u5b9e\u73b0\u201d\u62fc\u88c5\u8d77\u6765\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance.h/#1-variance-builder","title":"1. \u6587\u4ef6\u5b9a\u4f4d\uff08\u4e3a\u4ec0\u4e48\u8981\u5355\u72ec\u6709 variance builder\uff09","text":"<p><code>VTableBuilderBase</code> \u7684\u9aa8\u67b6\u6d41\u7a0b\u901a\u8fc7\u4e24\u4e2a\u865a\u51fd\u6570\u94a9\u5b50\u6ce8\u5165\u7b56\u7565\uff1a - <code>ProcessClassMethod</code>\uff1a\u672c\u7c7b\u65b9\u6cd5\u5982\u4f55\u8986\u76d6 base \u65b9\u6cd5\u3001\u5982\u4f55\u5904\u7406 final/multiple override\u3002 - <code>ProcessDefaultMethod</code>\uff1a\u63a5\u53e3\u9ed8\u8ba4\u65b9\u6cd5\u5982\u4f55\u51b3\u5b9a\u662f\u5426 copied\u3001\u5982\u4f55\u5904\u7406 multiple implement \u51b2\u7a81\u3002</p> <p>Variance builder \u63d0\u4f9b\u4e86\u4e00\u79cd\u5177\u4f53\u7b56\u7565\uff1a\u5141\u8bb8\u901a\u8fc7 <code>ProtoCompatibility(ctx)</code> \u5224\u5b9a\u66f4\u5bbd\u677e\u7684 proto \u8986\u76d6\u5173\u7cfb\uff08\u4f8b\u5982\u534f\u53d8\u8fd4\u56de\u7c7b\u578b\uff09\uff0c\u5e76\u53ef\u901a\u8fc7 <code>OverridePred</code> \u589e\u52a0\u989d\u5916\u53ef\u8986\u76d6\u8c13\u8bcd\uff08\u8bbf\u95ee\u63a7\u5236/\u8bed\u8a00\u89c4\u5219\u7b49\uff09\u3002</p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance.h/#2-l1l20","title":"2. \u5934\u90e8\u4e0e\u4f9d\u8d56\uff08L1\u2013L20\uff09","text":"<ul> <li>L15\u2013L16\uff1ainclude guard\uff1a<code>PANDA_RUNTIME_VTABLE_BUILDER_VARIANCE_H</code>\u3002</li> <li>L18\uff1a<code>runtime/class_linker_context.h</code>\uff1a\u6784\u9020 <code>ProtoCompatibility(ctx)</code> \u65f6\u9700\u8981\u4e0a\u4e0b\u6587\u3002</li> <li>L19\uff1a<code>runtime/include/vtable_builder_base.h</code>\uff1a\u7ee7\u627f\u57fa\u7840\u9aa8\u67b6\u4e0e <code>MethodInfo/VTableInfo</code> \u7b49\u5b9a\u4e49\u3002</li> </ul>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance.h/#3-variancevtablebuilderprotocompatibility-overridepredl23l38","title":"3. <code>VarianceVTableBuilder&lt;ProtoCompatibility, OverridePred&gt;</code>\uff08L23\u2013L38\uff09","text":"<ul> <li>L23\u2013L24\uff1a\u6a21\u677f\u53c2\u6570\uff1a</li> <li><code>ProtoCompatibility</code>\uff1a\u53ef\u8c03\u7528\u5bf9\u8c61\u7c7b\u578b\uff0c\u5f62\u5982 <code>ProtoCompatibility(ctx)(baseProto, dervProto)</code>\u3002</li> <li><code>OverridePred</code>\uff1a\u53ef\u8c03\u7528\u5bf9\u8c61\u7c7b\u578b\uff0c\u5f62\u5982 <code>OverridePred()(baseInfo, dervInfo)</code>\u3002</li> <li>L24\uff1a\u7ee7\u627f\u81ea <code>VTableBuilderBase&lt;false&gt;</code>\uff1a</li> <li><code>false</code> \u8868\u793a\u9ed8\u8ba4\u65b9\u6cd5\u679a\u4e3e\u65f6 \u4e0d\u904d\u5386 super itable \u533a\u95f4\uff08\u89c1 <code>vtable_builder_base-inl.h</code> \u7684 <code>traverseUpTo</code> \u903b\u8f91\uff09\u3002</li> <li>L26\uff1a\u6784\u9020\u51fd\u6570\uff1a\u4ec5\u8f6c\u53d1 <code>ClassLinkerErrorHandler*</code> \u7ed9\u57fa\u7c7b\uff08\u7528\u4e8e\u51b2\u7a81\u4e0a\u62a5\uff09\u3002</li> </ul> <p>\u79c1\u6709\u533a\uff08\u5b9e\u73b0\u90fd\u5728 <code>vtable_builder_variance-inl.h</code>\uff09\uff1a - L29\u2013L30\uff1a\u8986\u76d6\u57fa\u7c7b\u94a9\u5b50\uff1a   - <code>ProcessClassMethod</code>   - <code>ProcessDefaultMethod</code> - L32\uff1a<code>ScanConflictingDefaultMethods</code>\uff1a\u7528\u4e8e default \u65b9\u6cd5\u51b2\u7a81\u626b\u63cf\uff08\u8fd4\u56de optional \u8868\u793a skip/ok/conflict\uff09\u3002 - L34\u2013L37\uff1a\u4e24\u4e2a\u9759\u6001 helper\uff1a   - <code>IsOverriddenBy</code>   - <code>IsOverriddenOrOverrides</code></p>"},{"location":"03_ClassLoading/FileNotes/runtime_include_vtable_builder_variance.h/#4-inl","title":"4. \u8bfb\u8005\u8def\u7ebf\uff08\u4e0e inl \u6587\u4ef6\u62fc\u88c5\uff09","text":"<p>\u8981\u7406\u89e3 variance builder \u7684\u5b8c\u6574\u8bed\u4e49\uff0c\u8bf7\u6309\u4ee5\u4e0b\u987a\u5e8f\u9605\u8bfb\uff1a - <code>runtime/include/vtable_builder_base.h</code>\uff08\u9aa8\u67b6+\u6570\u636e\u7ed3\u6784\uff09 - <code>runtime/include/vtable_builder_base-inl.h</code>\uff08Build \u987a\u5e8f\u4e0e itable \u5012\u5e8f\u679a\u4e3e\uff09 - <code>runtime/include/vtable_builder_variance.h</code>\uff08\u672c\u6587\u4ef6\uff1a\u58f0\u660e\u62fc\u88c5\u70b9\uff09 - <code>runtime/include/vtable_builder_variance-inl.h</code>\uff08\u5177\u4f53\u8986\u76d6/\u51b2\u7a81\u7b56\u7565\uff09</p>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/","title":"Flow\uff1aBuilders \u2192 LinkMethods\uff08vtable / itable / IMT\uff09","text":""},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08Flow\uff09\uff08\u201cLinkMethods\uff1avtable/itable/imtable UpdateClass\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#1","title":"1) \u53d1\u751f\u5728\u4ec0\u4e48\u65f6\u5019","text":"<p>\u5728 <code>runtime/class_linker.cpp</code> \u7684 class \u521b\u5efa\u7ba1\u7ebf\u4e2d\uff1a - <code>SetupClassInfo</code> \u9636\u6bb5\u521b\u5efa\u4e09\u7c7b builder\uff0c\u5e76\u5148\u8fdb\u884c Build\uff08\u5176\u4e2d vtable build \u4f9d\u8d56 itable build \u7684\u7ed3\u679c\uff09 - <code>LinkMethods</code> \u9636\u6bb5\u628a builder \u7684\u7ed3\u679c\u5199\u56de <code>Class</code></p>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#2-mermaidbuild","title":"2) Mermaid\uff1aBuild \u4e0e\u5199\u56de\u7684\u8c03\u7528\u987a\u5e8f","text":"<pre><code>sequenceDiagram\n  participant CL as ClassLinker\n  participant LC as LanguageContext\n  participant ITB as ITableBuilder\n  participant VTB as VTableBuilder\n  participant IMTB as IMTableBuilder\n  participant K as Class\n\n  CL-&gt;&gt;LC: CreateITableBuilder(errHandler)\n  CL-&gt;&gt;LC: CreateVTableBuilder(errHandler)\n  CL-&gt;&gt;LC: CreateIMTableBuilder()\n  CL-&gt;&gt;ITB: Build(classLinker, base, interfaces, isInterface)\n  CL-&gt;&gt;VTB: Build(cda/methods, base, ITB.GetITable(), context/isInterface)\n  CL-&gt;&gt;IMTB: Build(cda/ITable, ITB.GetITable(), isInterface)\n  Note over CL: \u4e4b\u540e\u521b\u5efa Class \u5e76 LoadMethods/LoadFields\n  CL-&gt;&gt;VTB: UpdateClass(K)\n  CL-&gt;&gt;ITB: Resolve(K)\n  CL-&gt;&gt;ITB: UpdateClass(K)\n  CL-&gt;&gt;IMTB: UpdateClass(K)</code></pre>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#3","title":"3) \u5173\u952e\u7b56\u7565\u70b9\uff08\u4f60\u9700\u8981\u8bb0\u4f4f\u7684\u201c\u89c4\u5219\u201d\uff09","text":"<ul> <li>vtable builder\uff1a</li> <li>\u8d1f\u8d23 override/\u51b2\u7a81\u7b56\u7565\uff08final override\u3001\u591a override\u3001default interface conflict\uff09</li> <li>\u4f1a\u4ea7\u751f copied methods\uff08default interface methods \u7684\u590d\u5236\u4f53\uff09\uff0cClassLinker \u4f1a\u628a\u5b83\u4eec\u8ffd\u52a0\u5230 methods \u6570\u7ec4\u5c3e\u90e8\u5e76\u8bbe\u7f6e stub</li> <li>itable builder\uff1a</li> <li>\u8d1f\u8d23 itable entries \u7684\u7ebf\u6027\u5316\u4e0e methods \u69fd\u5206\u914d</li> <li>Resolve \u65f6\u628a\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u6620\u5c04\u5230\u6700\u7ec8\u5b9e\u73b0\uff08ETS\uff1a\u4f18\u5148\u590d\u7528 base \u7684 vtableIndex\uff0c\u518d vtable \u53cd\u5411\u5339\u914d\uff09</li> <li>IMT builder\uff1a</li> <li>\u662f\u53ef\u9009\u52a0\u901f\uff1a\u63a5\u53e3\u65b9\u6cd5\u6570\u8fc7\u5927 \u2192 <code>imtSize=0</code> \u7981\u7528</li> <li>\u51b2\u7a81\u7b56\u7565\uff1a\u540c\u69fd\u51b2\u7a81\u5373\u6e05\u7a7a\u69fd\uff0c\u4fdd\u8bc1\u4e0d\u4f1a\u8bef\u6d3e\u53d1\uff08\u56de\u9000 itable\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#31-vtable","title":"3.1 vtable \u6784\u5efa\u7b97\u6cd5\uff08\u6e90\u7801\u7ea7\u6b65\u9aa4 + \u56fe\uff09","text":"<p>\u8fd9\u91cc\u4e0d\u662f\u201c\u6982\u5ff5\u63cf\u8ff0\u201d\uff0c\u800c\u662f\u6309 <code>runtime/include/vtable_builder_base-inl.h</code> \u7684\u771f\u5b9e\u6b65\u9aa4\u62c6\u89e3\uff08\u6838\u5fc3\u8def\u5f84\uff09\uff1a</p> <ul> <li>\u63a5\u53e3\u7c7b\uff1a<code>BuildForInterface(...)</code>\uff08\u53ea\u505a\u63a5\u53e3\u81ea\u5df1\u7684\u865a\u65b9\u6cd5\u7d22\u5f15\uff09</li> <li>\u666e\u901a\u7c7b\uff1a</li> <li><code>AddBaseMethods(baseClass)</code>\uff1a\u628a\u7236\u7c7b vtable \u4f5c\u4e3a\u521d\u59cb\u8868</li> <li><code>AddClassMethods(cda/methods, ctx)</code>\uff1a\u628a\u672c\u7c7b\u865a\u65b9\u6cd5\u6309 name+proto \u505a override \u5339\u914d\u4e0e\u51b2\u7a81\u5904\u7406\uff0c\u51b3\u5b9a\u843d\u5728\u201c\u8986\u76d6\u69fd\u201d\u8fd8\u662f\u201c\u65b0\u589e\u69fd\u201d</li> <li><code>AddDefaultInterfaceMethods(itable, superItableSize)</code>\uff1a\u628a default interface methods \u53d8\u6210 copied methods\uff08\u8ffd\u52a0\u5230 methods \u5c3e\u90e8\uff09\uff0c\u5e76\u5728 vtable \u6620\u5c04\u91cc\u8bb0\u5f55 copied method \u7684\u72b6\u6001\uff08\u51b2\u7a81/\u666e\u901a\u7b49\uff09</li> </ul> <p>Mermaid\uff08\u666e\u901a\u7c7b vtable build \u4e3b\u903b\u8f91\uff09\uff1a</p> <pre><code>flowchart TD\n  A[\"VTableBuilderBase::Build(cda/methods, base, itable, ctx)\"] --&gt; B{\"isInterface?\"}\n  B --&gt;|yes| IF[\"BuildForInterface\\n- \u7ed9\u63a5\u53e3\u865a\u65b9\u6cd5\u5206\u914d vtableIndex\"] --&gt; OUT[return true]\n  B --&gt;|no| C[\"AddBaseMethods(base)\\n- \u7ee7\u627f\u7236\u7c7b vtable\"] --&gt; D[\"AddClassMethods\\n- override \u5339\u914d name+proto\\n- \u51b2\u7a81/\u975e\u6cd5\u8986\u76d6\u5904\u7406\\n- \u5f62\u6210 vtable \u6620\u5c04\"] --&gt; E[\"AddDefaultInterfaceMethods(itable)\\n- default interface -&gt; copied methods\\n- \u8ffd\u52a0\u5230 methods \u5c3e\u90e8\u5e76\u6807\u8bb0\u72b6\u6001\"] --&gt; OUT</code></pre> <p>\u65b0\u4eba\u6700\u5bb9\u6613\u8e29\u7684\u70b9\uff1adefault interface method \u5e76\u4e0d\u76f4\u63a5\u201c\u8fdb vtable \u53d8\u4e00\u4e2a\u69fd\u201d\uff0c\u800c\u662f\u7ecf\u5e38\u4ee5 copied method \u7684\u5f62\u5f0f\u8ffd\u52a0\u5230 methods \u5c3e\u90e8\uff1bvtable builder \u53ea\u8d1f\u8d23\u628a\u201c\u8be5\u8c03\u7528\u8be5\u8df3\u5230\u54ea\u4e2a Method*\u201d\u7684\u6620\u5c04\u5173\u7cfb\u5199\u56de <code>Class</code>\u3002</p>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#311-override-final-processclassmethod","title":"3.1.1 override / final \u51b2\u7a81\uff1a<code>ProcessClassMethod</code> \u7684\u5224\u5b9a\u6811\uff08\u6807\u51c6\u5b9e\u73b0\uff09","text":"<p>\u5bf9\u5e94\u6e90\u7801\uff1a<code>runtime/include/vtable_builder_standard-inl.h::StandardVTableBuilder::ProcessClassMethod</code></p> <pre><code>flowchart TD\n  M[\"\u8f93\u5165\uff1a\u4e00\u4e2a class virtual method\uff08info\uff09\"] --&gt; I[\"\u5728 vtable_.Methods() \u4e2d\u8fed\u4ee3\u201c\u540c\u540d\u201d\u65b9\u6cd5\\n(\u4ec5\u5173\u5fc3 itInfo.IsBase()==true)\"]\n  I --&gt; C{\"proto \u517c\u5bb9 \u4e14 OverridePred()==true ?\\n(IsOverriddenBy(base.proto, info.proto))\"}\n  C --&gt;|\u5426| I\n  C --&gt;|\u662f| F{\"base method \u662f final ?\"}\n  F --&gt;|\u662f| ERR[\"OnVTableConflict: OVERRIDES_FINAL\\n-&gt; return false\"]\n  F --&gt;|\u5426| SET[\"itEntry.SetCandidate(info)\\ncompatibleFound=true\"] --&gt; I\n  I --&gt; END{\"\u626b\u63cf\u7ed3\u675f\uff1acompatibleFound ?\"}\n  END --&gt;|\u5426| ADD[\"vtable_.AddEntry(info)\\n(\u65b0\u589e\u4e00\u4e2a vtable \u69fd)\"] --&gt; OK[return true]\n  END --&gt;|\u662f| OK</code></pre> <p>\u542b\u4e49\uff08\u5bf9\u65b0\u4eba\u5f88\u5173\u952e\uff09\uff1a - override \u53ea\u4f1a\u66ff\u6362\u201c\u7ee7\u627f\u81ea\u7236\u7c7b\u7684\u69fd\u201d\uff08<code>itInfo.IsBase()</code>\uff09\uff0c\u4e0d\u4f1a\u5728\u540c\u4e00\u4e2a\u7c7b\u5185\u5bf9\u201c\u65b0\u52a0\u69fd\u201d\u518d\u505a\u4e8c\u6b21\u8986\u76d6\u3002 - final \u8986\u76d6\u662f P0 \u7ea7\u9519\u8bef\uff1a\u76f4\u63a5\u6253\u5230 errorHandler\uff08<code>OVERRIDES_FINAL</code>\uff09\u5e76\u7ec8\u6b62\u52a0\u8f7d\u3002</p>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#312-default-interface-copied-methods-status","title":"3.1.2 default interface \u2192 copied methods\uff1a\u89e6\u53d1\u6761\u4ef6\u4e0e Status \u843d\u70b9\uff08\u6807\u51c6\u5b9e\u73b0\uff09","text":"<p>\u5bf9\u5e94\u6e90\u7801\uff1a - <code>runtime/include/vtable_builder_base-inl.h::AddDefaultInterfaceMethods</code>\uff08\u904d\u5386 itable \u4e0a\u5e26 default \u7684\u63a5\u53e3\uff0c\u9010\u4e2a <code>ProcessDefaultMethod</code>\uff09 - <code>runtime/include/vtable_builder_standard-inl.h::ProcessDefaultMethod/ScanConflictingDefaultMethods/IsMaxSpecificInterfaceMethod</code> - <code>runtime/class_linker.cpp::SetupCopiedMethods</code>\uff08\u628a <code>Status</code> \u7ffb\u8bd1\u6210 stub entrypoint\uff09</p> <p>\u5148\u7ed9\u7ed3\u8bba\uff08\u65b0\u4eba\u53ef\u76f4\u63a5\u62ff\u53bb\u6392\u969c\uff09\uff1a - \u4f55\u65f6\u4f1a\u4ea7\u751f copied method\uff1a\u5f53\u63a5\u53e3\u65b9\u6cd5\u662f default\uff08\u975e abstract\uff09\uff0c\u4e14\u6ca1\u6709\u88ab\u201c\u67d0\u4e2a class method \u5b9e\u73b0\u201d\u538b\u5236\u65f6\uff0c\u4f1a\u88ab\u52a0\u5165 <code>copiedMethods_</code>\uff0c\u5e76\u5728 <code>LoadMethods</code> \u9636\u6bb5\u8ffd\u52a0\u5230 <code>methods[]</code> \u5c3e\u90e8\u3002 - Status \u8bed\u4e49\uff08\u6700\u7ec8\u4f53\u73b0\u5728 entrypoint\uff09\uff1a   - <code>ORDINARY</code>\uff1a\u6b63\u5e38 default method\uff08\u4fdd\u6301\u539f\u59cb\u884c\u4e3a\uff09   - <code>ABSTRACT</code>\uff1a\u9ed8\u8ba4\u65b9\u6cd5\u201c\u4e0d\u662f max-specific\u201d\uff0c\u88ab\u964d\u7ea7\u4e3a AbstractMethodError stub\uff08\u7b49\u4ef7\u4e8e\u201c\u8be5 default \u5728\u8be5\u7c7b\u4e0a\u4e0d\u53ef\u7528\u201d\uff09   - <code>CONFLICT</code>\uff1adefault method \u51b2\u7a81\uff08ICCE/\u51b2\u7a81 stub\uff09\uff0c\u907f\u514d\u8bef\u6d3e\u53d1</p> <p>Mermaid\uff08default method \u51b3\u7b56\u6811\uff1a\u662f\u5426\u52a0\u5165 copied methods\u3001\u4ee5\u53ca Status \u5982\u4f55\u843d\u70b9\uff09\uff1a</p> <pre><code>flowchart TD\n  S[\"\u8f93\u5165\uff1a\u4e00\u4e2a default interface method\uff08methodInfo\uff09\\n\u5f53\u524d\u63a5\u53e3=itable[itableIdx].GetInterface()\"] --&gt; SCAN[\"ScanConflictingDefaultMethods(methodInfo)\"]\n\n  SCAN --&gt; IMP{\"\u5728 vtable_.Methods() \u540c\u540d proto \u547d\u4e2d\uff1f\"}\n  IMP --&gt;|\u547d\u4e2d\u4e14\u5df2\u6709 class method \u5b9e\u73b0| SKIP[\"skip default\uff08\u4e0d\u751f\u6210 copied\uff09\\n\u539f\u56e0\uff1a\u5df2\u6709 implementing method\\n-&gt; return true\"]\n  IMP --&gt;|\u5426\u5219| COPYS{\"\u5728 vtable_.CopiedMethods() \u4e2d\u662f\u5426\u627e\u5230 proto \u51b2\u7a81\uff1f\"}\n\n  COPYS --&gt;|\u627e\u5230\u66f4 specific \u7684\u5df2\u5b58\u5728 default| SKIP2[\"skip default\uff08\u4e0d\u751f\u6210/\u4e0d\u66ff\u6362\uff09\\n\u539f\u56e0\uff1a\u5df2\u6709\u66f4\u5177\u4f53\u517c\u5bb9 default\\n-&gt; return true\"]\n  COPYS --&gt;|\u672a\u627e\u5230\u51b2\u7a81| ADD[\"AddCopiedEntry(methodInfo)\\n(\u751f\u6210 copied method)\"] --&gt; MS{\"IsMaxSpecificInterfaceMethod ?\"}\n  MS --&gt;|\u5426| ABS[\"entry.status = ABSTRACT\"] --&gt; OK[\"return true\"]\n  MS --&gt;|\u662f| OK\n\n  COPYS --&gt;|\u627e\u5230\u51b2\u7a81 conflictPtr| EX[\"\u53d6 entry = copiedMethods[conflictPtr]\"] --&gt; C1{\"entry.status == CONFLICT ?\"}\n  C1 --&gt;|\u662f| OK\n  C1 --&gt;|\u5426| MS2{\"\u65b0 default \u662f max-specific ?\"}\n  MS2 --&gt;|\u5426| OK\n  MS2 --&gt;|\u662f| C2{\"entry.status != ABSTRACT ?\"}\n  C2 --&gt;|\u662f| SETC[\"entry.status = CONFLICT\\n(\u6807\u8bb0 ICCE/\u51b2\u7a81)\"] --&gt; OK\n  C2 --&gt;|\u5426| REPL[\"entry.status = ORDINARY\\nUpdateCopiedEntry(conflictPtr, methodInfo)\\n(\u7528\u66f4\u5177\u4f53 default \u66ff\u6362)\"] --&gt; OK</code></pre> <p>\u4f60\u5173\u5fc3\u7684\u201cStatus \u6700\u7ec8\u600e\u4e48\u5f71\u54cd\u8fd0\u884c\u201d\uff1a<code>runtime/class_linker.cpp::SetupCopiedMethods</code> \u4f1a\u628a copied method \u6807\u6210 <code>SetIsDefaultInterfaceMethod()</code>\uff0c\u5e76\u6309 Status \u8bbe\u7f6e entrypoint\uff1a<code>ABSTRACT -&gt; GetAbstractMethodStub()</code>\uff0c<code>CONFLICT -&gt; GetDefaultConflictMethodStub()</code>\u3002</p>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#32-itable-ets","title":"3.2 itable \u6784\u5efa\u7b97\u6cd5\uff08\u4ee5 ETS \u4e3a\u4f8b\uff0c\u6700\u5e38\u7528\u4e5f\u6700\u6e05\u6670\uff09","text":"<p>core \u7684 itable builder \u662f\u63a5\u53e3\uff08<code>runtime/include/itable_builder.h</code>\uff09\uff0cETS \u6709\u4e00\u5957\u201c\u6700\u80fd\u770b\u61c2\u201d\u7684\u5b9e\u73b0\uff1a<code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff1a</p> <ul> <li>Build\uff08\u6784\u5efa itable \u5f62\u72b6\uff0c\u4e0d\u586b\u5b9e\u73b0\uff09\uff1a</li> <li><code>LinearizeITable(...)</code>\uff1a\u628a base \u7684 itable + \u76f4\u63a5\u63a5\u53e3 + \u63a5\u53e3\u7684\u7236\u63a5\u53e3\u505a\u53bb\u91cd\u7ebf\u6027\u5316</li> <li>\u4e3a\u6bcf\u4e2a\u65b0 entry \u5206\u914d <code>methods_</code> \u6570\u7ec4\uff1a\u957f\u5ea6 = <code>entry.interface-&gt;GetVirtualMethods().size()</code></li> <li>Resolve\uff08\u628a\u6bcf\u4e2a\u63a5\u53e3\u65b9\u6cd5\u69fd\u89e3\u6790\u5230\u6700\u7ec8\u5b9e\u73b0\uff09\uff1a</li> <li>\u4f18\u5148\u590d\u7528 base \u7684 resolve \u7ed3\u679c\uff08\u5982\u679c baseEntry[j] \u5df2\u7ecf\u662f class method\uff0c\u5219\u7528\u5176 vtableIndex \u53bb\u5f53\u524d\u7c7b vtable \u53d6\u5b9e\u73b0\uff09</li> <li>\u5426\u5219 <code>FindMethodInVTable(klass, imethod)</code>\uff1a\u5728\u672c\u7c7b vtable \u91cc\u6309 name+proto\uff08ETSProtoIsOverriddenBy\uff09\u53cd\u5411\u5339\u914d\u5b9e\u73b0\uff1b\u591a\u5b9e\u73b0\u5019\u9009\u76f4\u63a5\u62a5 <code>MULTIPLE_IMPLEMENT</code></li> <li>\u6700\u7ec8\u5199\u56de\uff1a<code>entry.methods[j] = resolved != nullptr ? resolved : imethod</code>\uff08\u627e\u4e0d\u5230\u5b9e\u73b0\u5219\u56de\u9000\u4e3a\u63a5\u53e3\u65b9\u6cd5\u672c\u8eab\uff09</li> </ul> <p>Mermaid\uff08ETS itable Build+Resolve\uff09\uff1a</p> <pre><code>flowchart TD\n  B0[\"EtsITableBuilder::Build(base, classInterfaces)\"] --&gt; B1[\"LinearizeITable\\n- base itable entries\\n- direct interfaces\\n- parent interfaces\\n- \u53bb\u91cd + \u56fa\u5b9a\u987a\u5e8f\"]\n  B1 --&gt; B2[\"\u4e3a\u6bcf\u4e2a entry \u5206\u914d methods[]\\nlen = iface.virtualMethods.size\"]\n  B2 --&gt; R0[\"EtsITableBuilder::Resolve(klass)\"]\n  R0 --&gt; R1[\"\u5bf9\u6bcf\u4e2a entry\u3001\u6bcf\u4e2a imethod \u69fd j\uff1a\u5148\u5c1d\u8bd5 base \u590d\u7528\"]\n  R1 --&gt; R2{\"baseEntry[j] \u662f class method?\"}\n  R2 --&gt;|yes| R3[\"resolved = klass.vtable[ baseMethod.vtableIndex ]\"]\n  R2 --&gt;|no| R4[\"resolved = FindMethodInVTable\\n- name+proto \u5339\u914d\\n- \u591a\u5019\u9009 -&gt; MULTIPLE_IMPLEMENT\"]\n  R3 --&gt; W[\"entry.methods[j] = resolved ?: imethod\"] --&gt; NEXT[\"\u4e0b\u4e00\u4e2a\u69fd/entry\"]\n  R4 --&gt; W</code></pre>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#4","title":"4) \u8bc1\u636e\u94fe","text":"<ul> <li>runtime_class_linker.cpp\uff08FileNotes\uff09\uff08SetupClassInfo/LinkMethods/LoadMethods/copied methods\uff09</li> <li><code>FileNotes/runtime_include_vtable_builder_*</code>\uff08vtable builder \u5951\u7ea6\u4e0e\u7b56\u7565\uff09</li> <li>runtime_include_itable_builder.h\uff08FileNotes\uff09 + plugins_ets_runtime_ets_itable_builder.cpp\uff08FileNotes\uff09</li> <li>runtime_imtable_builder.cpp\uff08FileNotes\uff09</li> <li>\u5173\u952e\u6e90\u7801\u951a\u70b9\uff1a</li> <li><code>runtime/include/vtable_builder_base-inl.h</code>\uff08Build/AddBaseMethods/AddClassMethods/AddDefaultInterfaceMethods/UpdateClass\uff09</li> <li><code>runtime/include/vtable_builder_standard-inl.h</code>\uff08ProcessClassMethod/ProcessDefaultMethod/Status \u5224\u5b9a\u6811\uff09</li> <li><code>plugins/ets/runtime/ets_itable_builder.cpp</code>\uff08LinearizeITable/Build/Resolve/FindMethodInVTable\uff09</li> <li><code>runtime/class_linker.cpp::SetupCopiedMethods</code>\uff08\u628a CopiedMethod::Status \u7ffb\u8bd1\u6210 stub entrypoint\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Builders_and_LinkMethods/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u5148\u628a GetClass/LoadClass \u4e3b\u7ebf\u5bf9\u9f50 \u2192 GetClass_and_LoadClass\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u63a5\u53e3\u6d3e\u53d1\u7ed3\u6784\u4e0e\u56de\u9000\u8bed\u4e49\u201d \u2192 ITable_and_IMT\uff08DataStructure\uff09</li> <li>\u60f3\u770b\u201c\u5b57\u6bb5\u5e03\u5c40/offset \u5199\u56de\u201d \u2192 LayoutFields_and_LinkFields\uff08Flow\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/","title":"Flow\uff1a\u7c7b\u52a0\u8f7d\u7aef\u5230\u7aef\u4e3b\u7ebf\uff08\u65b0\u4eba\u201c\u810a\u67f1\u56fe\u201d\uff09","text":"<p>\u76ee\u6807\uff1a\u7ed9\u65b0\u540c\u5b66\u4e00\u6761\u552f\u4e00\u4e3b\u7ebf\u2014\u2014\u5148\u7528\u4e00\u5f20\u56fe\u628a\u201c\u7c7b\u662f\u600e\u4e48\u88ab\u627e\u5230/\u52a0\u8f7d/\u94fe\u63a5/\u521d\u59cb\u5316\u7684\u201d\u4e32\u8d77\u6765\uff0c\u7136\u540e\u6bcf\u4e2a\u6846\u90fd\u80fd\u4e00\u952e\u4e0b\u6f5c\u5230\u5bf9\u5e94 Flow / DataStructures / FileNotes\u3002</p>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#0","title":"0) \u4f60\u8be5\u600e\u4e48\u7528\u8fd9\u4efd\u6587\u6863\uff08\u65b0\u4eba\u63a8\u8350\u987a\u5e8f\uff09","text":"<p>\u5efa\u8bae\u6253\u5f00 3 \u4e2a\u9875\u7b7e\uff1a</p> <ul> <li>\u672f\u8bed\u901f\u67e5\uff1aFileNotes/_Glossary</li> <li>\u65b0\u4eba\u5feb\u901f\u81ea\u68c0\uff1aNewbie_MinDebug_Playbook</li> <li>\u672c\u6587\uff08\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\uff09</li> </ul> <p>\u9605\u8bfb\u987a\u5e8f\uff1a</p> <ol> <li>\u5148\u770b 2) \u603b\u56fe\uff1a\u5efa\u7acb ClassLoading \u7684\u6574\u4f53 mental model</li> <li>\u518d\u6309\u4f60\u5173\u5fc3\u7684\u6846\u4e0b\u6f5c\uff1a\u6bcf\u4e2a\u6846\u4e0b\u90fd\u6709\u201c\u8fdb\u4e00\u6b65\u9605\u8bfb\u201d\u5165\u53e3\uff0c\u8fdb\u5165\u5bf9\u5e94 flow/\u5361\u7247</li> <li>\u6700\u540e\u624d\u8bfb\u9010\u884c\u8bc1\u636e\uff1aFlow \u2192 FileNotes \u662f\u6700\u7a33\u5b9a\u7684\u8bc1\u636e\u94fe</li> </ol>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#1","title":"1) \u5148\u8bb0\u4f4f\u4e09\u6761\u73b0\u5b9e\u89c4\u5219\uff08\u65b0\u4eba\u6700\u5e38\u8bef\u5224\uff09","text":"<ul> <li>\u201c\u52a0\u8f7d\u201d\u2260\u201c \u521d\u59cb\u5316\u6267\u884c\u201d\uff1a<code>LoadClass</code> \u7684\u4e3b\u7ebf\u4f1a\u8c03\u7528 <code>ext-&gt;InitializeClass(klass)</code> \u505a\u8bed\u8a00\u4fa7\u201c\u5143\u6570\u636e\u6536\u5c3e\u201d\uff08\u4f8b\u5982 managed&lt;-&gt;runtime \u7ed1\u5b9a\u7b49\uff09\uff0c\u4f46 <code>&lt;clinit&gt;</code>/\u8bed\u8a00\u8bed\u4e49\u521d\u59cb\u5316\u7684\u6267\u884c\u7ec6\u8282\u4ecd\u5c5e\u4e8e 04 \u6267\u884c\u5f15\u64ce\uff08\u5efa\u8bae\u5bf9\u7167 04_ExecutionEngine/README\uff09\u3002 <li>Context \u51b3\u5b9a\u53ef\u89c1\u57df\uff1a\u540c\u540d descriptor \u5728\u4e0d\u540c <code>ClassLinkerContext</code> \u91cc\u53ef\u4ee5\u662f\u4e0d\u540c\u7684 <code>Class*</code>\uff1bETS \u989d\u5916\u5f15\u5165 parent/shared-libs \u94fe\uff0c\u5173\u7cfb\u4e0d\u662f\u7b80\u5355\u6811\u3002</li> <li>\u201c\u627e\u4e0d\u5230\u7c7b\u201d\u5e76\u4e0d\u603b\u662f CNFE\uff1a\u5728 Extension \u5c42\u7ecf\u5e38\u628a\u5e95\u5c42 CNFE \u5305\u88c5\u6210 NCDFE\uff08\u8bc1\u636e\uff1aFileNotes/runtime_class_linker_extension.cpp \u7684 <code>WrapClassNotFoundExceptionIfNeeded</code> \u6bb5\uff09\u3002</li> <li>\u63a5\u53e3\u6d3e\u53d1\u7684\u771f\u5b9e\u6210\u672c\u4e0e\u5751\u70b9\uff1aLinkMethods \u9636\u6bb5\u4e0d\u4ec5\u201c\u5199\u56de\u8868\u201d\uff0c\u8fd8\u6d89\u53ca vtable \u7684 override/copy/default \u51b2\u7a81\u4e0e itable \u7684\u7ebf\u6027\u5316+resolve\uff08\u5efa\u8bae\u4f18\u5148\u8bfb\uff1aBuilders_and_LinkMethods\uff08Flow\uff09 \u4e0e ITable_and_IMT\uff08DataStructure\uff09\uff09\u3002</li> <li>Class \u662f\u5c3e\u968f\u53d8\u957f\u5e03\u5c40\uff1a<code>Class*</code> \u540e\u9762\u8ddf\u7740 vtable/imt/static \u533a\uff08placement new \u6784\u9020\uff09\uff0c\u8c03\u8bd5\u65f6\u4e0d\u8981\u628a\u5b83\u5f53\u666e\u901a\u6210\u5458\u6570\u7ec4\uff08\u5efa\u8bae\u8bfb\uff1aClass\uff08DataStructure\uff09 \u7684\u201c\u53d8\u957f\u5bf9\u8c61\u5c3e\u968f\u5e03\u5c40\u201d\u6bb5\uff09\u3002</li>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#2-mermaid","title":"2) Mermaid\uff1a\u7c7b\u52a0\u8f7d\u7aef\u5230\u7aef\u603b\u56fe\uff08\u4e3b\u7ebf\uff09","text":"<pre><code>flowchart TD\n  subgraph IN[\"\u8f93\u5165\uff08\u6587\u4ef6/\u4e0a\u4e0b\u6587\uff09\"]\n    PF[\".abc PandaFile\\n(runtime/file_manager.cpp)\"] --&gt; CLReg[\"ClassLinker::AddPandaFile\\n(\u6ce8\u518c\u5230 boot/app \u4f53\u7cfb)\"]\n    AN[\".an AOT file\uff08\u53ef\u9009\uff09\\n(enable-an / aot-files)\\n(runtime/file_manager.cpp + runtime/runtime.cpp)\"] --&gt; AM[\"AotManager\\n(class context/snapshot)\"]\n  end\n\n  subgraph ENTRY[\"\u5165\u53e3\uff1a\u6309 descriptor \u627e Class\"]\n    GC[\"ClassLinker::GetClass(descriptor, ctx)\"] --&gt; HIT{\"ctx \u7f13\u5b58\u547d\u4e2d\uff1f\\nFindLoadedClass\"}\n    HIT --&gt;|\u662f| R0[\"\u8fd4\u56de Class*\"]\n    HIT --&gt;|\u5426| SPEC{\"Union/Array \u7279\u5224\uff1f\"}\n    SPEC --&gt;|\u662f| UA[\"LoadUnionClass/LoadArrayClass\\n(\u63d2\u5165/\u53bb\u91cd)\"] --&gt; R0\n    SPEC --&gt;|\u5426| BOOT{\"IsBootContext?\"}\n    BOOT --&gt;|\u662f| BF[\"Boot BloomFilter\\nPossiblyContains?\"] --&gt;|\u5426| NF0[\"CLASS_NOT_FOUND\"]\n    BF --&gt;|\u662f| FIND[\"FindClassInBootPandaFiles\\n(classId)\"] --&gt;|\u672a\u627e\u5230| NF0\n    FIND --&gt;|\u627e\u5230| LC[\"LoadClass(pf, classId, descriptor, ctx)\"]\n    BOOT --&gt;|\u5426| CTXLC[\"ctx-&gt;LoadClass(descriptor)\\n(ETS \u7279\u5316\u5728\u8fd9\u91cc)\"] --&gt; LC\n  end\n\n  subgraph LOAD[\"\u4e3b\u7ba1\u7ebf\uff1aLoadClass\uff08\u521b\u5efa/\u586b\u5145/\u94fe\u63a5/\u5e03\u5c40/\u53bb\u91cd\uff09\"]\n    LC --&gt; INFO[\"SetupClassInfo\\n\u521b\u5efa builders + \u8ba1\u7b97 size \u8f93\u5165\"]\n    INFO --&gt; CREATE[\"ext-&gt;CreateClass\\n(ETS: NonMovable EtsClass + \u7ed1\u5b9a runtime Class)\"]\n    CREATE --&gt; METH[\"LoadMethods\\n(entrypoint: C2I/native/AOT/stub\\ncopied methods)\"]\n    METH --&gt; FLD[\"LoadFields\\n(type/attrs/\u5bb9\u5668)\"]\n    FLD --&gt; LINKM[\"LinkMethods\\nvtable/itable/imtable UpdateClass\"]\n    LINKM --&gt; LINKF[\"LinkFields\\nLayoutFields(static/instance)\\n\u5199 offset/objectSize/refFields*\"]\n    LINKF --&gt; INS[\"InsertClass\\n\u5e76\u53d1\u53bb\u91cd\uff08\u51b2\u7a81\u5219\u56de\u6536\u65b0\u5bf9\u8c61\uff09\"]\n    INS --&gt; R1[\"\u8fd4\u56de Class*\"]\n  end\n\n  subgraph INIT[\"\u521d\u59cb\u5316\uff08\u8de8\u7ae0\uff1a04 \u6267\u884c\u5f15\u64ce\uff09\"]\n    R1 --&gt; INITC[\"InitializeClass\\n(&lt;clinit&gt;/\u8bed\u8a00\u4fa7 init)\"] --&gt; OUT[\"\u53ef\u7528\u7684\u5df2\u521d\u59cb\u5316 Class*\"]\n  end</code></pre>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#3","title":"3) \u201c\u6309\u6846\u4e0b\u6f5c\u201d\u5bfc\u822a\uff08\u6bcf\u4e2a\u6846\u90fd\u80fd\u7ee7\u7eed\u770b\u7ec6\u8282\uff09","text":""},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#31-classlinkerabcan","title":"3.1 \u6587\u4ef6\u5982\u4f55\u8fdb\u5165 ClassLinker\uff08.abc/.an\uff09","text":"<ul> <li>Flow\uff1aFileManager_ABC_AN</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_file_manager.cpp\uff08FileNotes\uff09\u3001runtime_include_file_manager.h\uff08FileNotes\uff09</li> <li>\u76f8\u5173\u63d0\u9192\uff08\u8de8\u7ae0\uff09\uff1aAOT class context/\u88c5\u8f7d\u5165\u53e3\u89c1 04 \u7ae0 FileNotes\uff1a</li> <li>compiler_aot_aot_manager.cpp\uff08FileNotes\uff09</li> <li>compiler_aot_aot_file.cpp\uff08FileNotes\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#32-getclassboot-vs-app","title":"3.2 GetClass\uff08boot vs app \u7684\u51b3\u7b56\u6811\uff09","text":"<ul> <li>Flow\uff1aGetClass_and_LoadClass</li> <li>\u5361\u7247\uff1aClassLinkerContext\uff08DataStructure\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_class_linker.cpp\uff08FileNotes\uff09\uff08GetClass/boot filter \u6bb5\uff09\u3001runtime_class_linker_extension.cpp\uff08FileNotes\uff09\uff08AppContext LoadClass\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#33-loadclassbuilderslayoutlink","title":"3.3 LoadClass\uff08\u4e3b\u7ba1\u7ebf\uff1abuilders/layout/link\uff09","text":"<ul> <li>Flow\uff1aGetClass_and_LoadClass\uff08\u7b2c 3 \u8282\uff09</li> <li>Flow\uff1aBuilders_and_LinkMethods\u3001LayoutFields_and_LinkFields</li> <li>\u5361\u7247\uff1aClass\uff08DataStructure\uff09\u3001Method\uff08DataStructure\uff09\u3001Field\uff08DataStructure\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_class_linker.cpp\uff08FileNotes\uff09\uff08SetupClassInfo/LoadMethods/LoadFields/Link*\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#34-class_circularity","title":"3.4 \u5e76\u53d1\u4e0e\u9012\u5f52\uff1a\u4e3a\u4ec0\u4e48\u53ef\u80fd\u201c\u91cd\u590d\u6784\u5efa\u201d\uff0c\u4ee5\u53ca CLASS_CIRCULARITY \u600e\u4e48\u6765\u7684","text":"<ul> <li>Flow\uff1aConcurrency_and_ClassLock</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_class_linker.cpp\uff08FileNotes\uff09\uff08InsertClass \u51b2\u7a81\u56de\u6536 + ClassLoadingSet\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ClassLoading_EndToEnd/#35-etscontext-nativemanaged","title":"3.5 ETS\uff1acontext \u7684 native\u2192managed \u4e24\u6bb5\u5f0f\u52a0\u8f7d","text":"<ul> <li>Flow\uff1aETS_Context_Native_vs_Managed_Load</li> <li>\u5361\u7247\uff1aETS_Plugin_Summary\uff08DataStructure\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1aplugins_ets_runtime_ets_class_linker_context.cpp\uff08FileNotes\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/","title":"Flow\uff1a\u5e76\u53d1\u7c7b\u52a0\u8f7d\uff08InsertClass \u53bb\u91cd\uff09\u4e0e ClassLock\uff08per-class condvar\uff09","text":""},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08Flow\uff09\uff08\u201cInsertClass \u5e76\u53d1\u53bb\u91cd\u201d\u6846 + \u201cContext \u5e76\u53d1\u534f\u8c03\u201d\u89c4\u5219\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#1","title":"1) \u5148\u7ed9\u7ed3\u8bba\uff08\u65b0\u4eba\u5fc5\u987b\u5148\u8bb0\u4f4f\u7684\u73b0\u5b9e\uff09","text":"<p>03 \u7ae0\u91cc\u6700\u5bb9\u6613\u88ab\u201c\u6982\u5ff5\u56fe\u201d\u8bef\u5bfc\u7684\u4e00\u70b9\u662f\uff1a\u540c\u4e00\u4e2a descriptor \u7684\u7c7b\uff0c\u5728\u5e76\u53d1\u573a\u666f\u4e0b\u5e76\u4e0d\u662f\u201c\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f1a\u8fdb\u5165 LoadClass\u201d\u3002</p> <p>\u5728\u5f53\u524d\u5b9e\u73b0\u91cc\uff08<code>runtime/class_linker.cpp::LoadClass(pf,id,descriptor,context,...)</code>\uff09\uff1a</p> <ul> <li>\u5e76\u53d1\u7b56\u7565\u66f4\u63a5\u8fd1\u201c\u4e50\u89c2\u5e76\u884c + InsertClass \u53bb\u91cd\u201d\uff1a</li> <li>\u591a\u4e2a\u7ebf\u7a0b\u90fd\u53ef\u80fd\u628a\u540c\u4e00\u4e2a\u7c7b\u5b8c\u6574\u8d70\u5b8c <code>SetupClassInfo \u2192 CreateClass \u2192 LoadMethods/Fields \u2192 LinkMethods/Fields</code></li> <li>\u6700\u540e\u7531 <code>context-&gt;InsertClass(klass)</code> \u51b3\u5b9a\u201c\u8c01\u8d62\u201d\uff0c\u540e\u6765\u7684\u4f1a <code>FreeClass(klass)</code> \u5e76\u8fd4\u56de\u5df2\u6709\u5bf9\u8c61</li> <li>\u540c\u7ebf\u7a0b\u9012\u5f52\u52a0\u8f7d\u7684\u5faa\u73af\u4f9d\u8d56\u4e0d\u662f\u9760\u201c\u9501\u201d\u89e3\u51b3\uff0c\u800c\u662f\u9760 <code>ClassLoadingSet</code>\uff08thread_local set\uff09\u68c0\u6d4b\uff1a</li> <li>\u5f53\u67d0\u4e2a\u7c7b\u5728\u52a0\u8f7d\u8fc7\u7a0b\u4e2d\u518d\u6b21\u5c1d\u8bd5\u52a0\u8f7d\u201c\u81ea\u5df1\u4f5c\u4e3a\u81ea\u5df1\u7684\u7236\u7c7b/\u63a5\u53e3\u201d\u65f6\uff0c\u76f4\u63a5\u62a5 <code>CLASS_CIRCULARITY</code></li> </ul> <p>\u5982\u679c\u4f60\u5728\u6392\u969c\u65f6\u770b\u5230\u201c\u5076\u73b0\u91cd\u590d\u521b\u5efa/\u5076\u73b0\u91ca\u653e/\u5076\u73b0 prepare event \u987a\u5e8f\u201d\uff0c\u5148\u9ed8\u8ba4\u5b83\u662f\u8fd9\u4e2a\u7b56\u7565\u5e26\u6765\u7684\u526f\u4f5c\u7528\uff0c\u800c\u4e0d\u662f\u4e00\u5b9a\u6709\u9501 bug\u3002</p>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#2-insertclass","title":"2) \u5e76\u53d1\u53bb\u91cd\uff1aInsertClass \u7684\u771f\u5b9e\u8bed\u4e49","text":"<p><code>runtime/class_linker_context.h::ClassLinkerContext::InsertClass</code>\uff08\u4f2a\u4ee3\u7801\uff09\uff1a</p> <ul> <li><code>classesLock_</code> \u52a0\u9501</li> <li>\u518d\u67e5\u4e00\u6b21 <code>FindClass(descriptor)</code>\uff1a</li> <li>\u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff1a\u8fd4\u56de <code>otherKlass</code>\uff08\u8c03\u7528\u8005\u5e94\u56de\u6536\u81ea\u5df1\u65b0\u5efa\u7684 klass\uff09</li> <li>\u5426\u5219\u63d2\u5165 <code>loadedClasses_[descriptor]=klass</code>\uff0c\u5e76\u5728 <code>mutexTable_</code> \u4e2d\u4e3a\u8be5 Class \u521b\u5efa\u4e00\u4e2a <code>ClassMutexHandler</code></li> </ul> <p>Mermaid\uff08\u4e24\u7ebf\u7a0b\u5e76\u53d1\u52a0\u8f7d\u540c\u4e00\u7c7b\u7684\u201c\u771f\u5b9e\u65f6\u5e8f\u201d\uff09\uff1a</p> <pre><code>sequenceDiagram\n  participant T1 as Thread-1\n  participant T2 as Thread-2\n  participant CL as ClassLinker\n  participant Ctx as ClassLinkerContext\n\n  T1-&gt;&gt;CL: GetClass(descriptor, ctx)\n  CL-&gt;&gt;Ctx: FindClass(descriptor)\n  Ctx--&gt;&gt;CL: nullptr\n  T2-&gt;&gt;CL: GetClass(descriptor, ctx)\n  CL-&gt;&gt;Ctx: FindClass(descriptor)\n  Ctx--&gt;&gt;CL: nullptr\n\n  Note over T1,T2: \u4e24\u4e2a\u7ebf\u7a0b\u90fd\u53ef\u80fd\u8fdb\u5165 LoadClass \u5e76\u5b8c\u6574\u6784\u5efa Class\n  T1-&gt;&gt;CL: LoadClass(...)\\nSetupClassInfo/CreateClass/Load*/Link*\n  T2-&gt;&gt;CL: LoadClass(...)\\nSetupClassInfo/CreateClass/Load*/Link*\n\n  T1-&gt;&gt;Ctx: InsertClass(klass1)\n  Ctx--&gt;&gt;T1: nullptr\uff08\u63d2\u5165\u6210\u529f\uff09\n  T2-&gt;&gt;Ctx: InsertClass(klass2)\n  Ctx--&gt;&gt;T2: otherKlass=klass1\uff08\u53d1\u73b0\u51b2\u7a81\uff09\n  T2-&gt;&gt;CL: FreeClass(klass2)\\nreturn klass1</code></pre> <p>\u7ed3\u8bba\uff1aInsertClass \u662f\u201c\u6700\u540e\u4e00\u9053\u95e8\u201d\uff0c\u4e0d\u662f\u201c\u552f\u4e00\u5165\u53e3\u95e8\u201d\u3002\u5b83\u4fdd\u8bc1\u6700\u7ec8 context \u5185\u53ea\u6709\u4e00\u4e2a descriptor \u5bf9\u5e94\u4e00\u4e2a Class*\uff0c\u4f46\u4e0d\u4fdd\u8bc1\u201c\u4e0d\u4f1a\u91cd\u590d\u6784\u5efa\u201d\u3002</p>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#3-classloadingsetclass_circularity","title":"3) \u540c\u7ebf\u7a0b\u9012\u5f52\u52a0\u8f7d\u9632\u62a4\uff1aClassLoadingSet\uff08CLASS_CIRCULARITY\uff09","text":"<p><code>runtime/class_linker.cpp</code> \u5728 <code>LoadClass(pf,id,...)</code> \u5185\u7ef4\u62a4\u4e00\u4e2a <code>thread_local ClassLoadingSet*</code>\uff1a</p> <ul> <li>key \u662f <code>(pfHash&lt;&lt;32)|classId</code>\uff08<code>GetClassUniqueHash</code>\uff09</li> <li>\u5728\u52a0\u8f7d base class \u524d\u8c03\u7528 <code>TryInsertClassLoading(...)</code></li> <li>\u5982\u679c\u540c\u4e00\u4e2a key \u518d\u6b21\u51fa\u73b0\uff0c\u76f4\u63a5\u4e0a\u62a5 <code>CLASS_CIRCULARITY</code></li> </ul> <p>Mermaid\uff08\u9012\u5f52\u81ea\u6307/\u5faa\u73af\u4f9d\u8d56\u7684\u6700\u5c0f\u5224\u5b9a\uff09\uff1a</p> <pre><code>flowchart TD\n  A[\"LoadClass(pf,id,descriptor)\"] --&gt; B{\"threadLocalSet \u5df2\u5b58\u5728?\"}\n  B --&gt;|\u5426| C[\"\u521b\u5efa local set + \u7ed1\u5b9a thread_local \u6307\u9488\\n(\u81ea\u52a8\u6e05\u7406\u5668\u786e\u4fdd return \u65f6 clear)\"]\n  B --&gt;|\u662f| D[\"\u590d\u7528 threadLocalSet\uff08\u540c\u7ebf\u7a0b\u9012\u5f52\u8def\u5f84\uff09\"]\n  C --&gt; E\n  D --&gt; E[\"TryInsertClassLoading(key=(pfHash&lt;&lt;32)|id)\"]\n  E --&gt;|\u5df2\u5b58\u5728| ERR[\"OnError: CLASS_CIRCULARITY\\n\\\"is its own superclass/superinterface\\\"\"]\n  E --&gt;|\u9996\u6b21\u51fa\u73b0| OK[\"\u7ee7\u7eed LoadBaseClass/LoadInterfaces/Build\"]</code></pre>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#4-classlockper-class-recursivemutex-condvar-loadclass","title":"4) ClassLock\uff1aper-class RecursiveMutex + CondVar\uff08\u201c\u5b58\u5728\u4f46\u672a\u5728 LoadClass \u4e3b\u7ebf\u4e0a\u4f7f\u7528\u201d\uff09","text":"<p>\u8fd9\u91cc\u662f\u7b2c\u4e8c\u4e2a\u5bb9\u6613\u8bef\u5224\u7684\u70b9\uff1a<code>ClassLinkerContext</code> \u786e\u5b9e\u7ef4\u62a4\u4e86 <code>mutexTable_[Class*]</code>\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86 <code>ClassLock</code> RAII\uff08<code>runtime/class_lock.{h,cpp}</code>\uff09\uff1a</p> <ul> <li><code>ClassLock(obj)</code>\uff1a</li> <li><code>cls = Class::FromClassObject(obj)</code></li> <li><code>clsMtx = cls-&gt;GetLoadContext()-&gt;GetClassMutexHandler(cls)</code></li> <li>\u5207\u7ebf\u7a0b\u72b6\u6001\u4e3a <code>IS_BLOCKED</code> \u5e76 <code>Lock()</code></li> <li><code>Wait()</code>\uff1a\u5207\u7ebf\u7a0b\u72b6\u6001 <code>IS_WAITING</code> \u5e76 <code>CondVar.Wait()</code></li> <li><code>Notify/NotifyAll()</code>\uff1aSignal/SignalAll</li> <li>\u6790\u6784\uff1aUnlock</li> </ul> <p>\u4f46\u9700\u8981\u5f3a\u8c03\uff1a\u5f53\u524d <code>runtime/class_linker.cpp</code> \u7684\u7c7b\u52a0\u8f7d/\u53bb\u91cd\u4e3b\u7ebf\u5e76\u6ca1\u6709\u8c03\u7528 <code>ClassLock</code>\uff08\u4e5f\u6ca1\u6709\u76f4\u63a5\u8c03\u7528 <code>GetClassMutexHandler</code>\uff09\u3002 \u6240\u4ee5\u4f60\u5728\u6392\u67e5\u201c\u7c7b\u52a0\u8f7d\u5e76\u53d1\u201d\u95ee\u9898\u65f6\uff0c\u5e94\u5148\u6309 InsertClass \u53bb\u91cd + \u91cd\u590d\u6784\u5efa \u7684\u6a21\u578b\u7406\u89e3\uff0c\u800c\u4e0d\u662f\u5148\u5047\u8bbe\u8fd9\u91cc\u6709\u4e00\u5957\u201c\u6309 Class \u7c92\u5ea6\u6392\u961f\u52a0\u8f7d\u201d\u7684\u9501\u673a\u5236\u3002</p>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#5","title":"5) \u65b0\u4eba\u6392\u969c\u901f\u67e5\uff08\u5e76\u53d1\u76f8\u5173\u75c7\u72b6\u2192\u843d\u70b9\uff09","text":"\u75c7\u72b6 \u7b2c\u4e00\u843d\u70b9 \u7b2c\u4e8c\u843d\u70b9 \u540c\u4e00\u7c7b\u65e5\u5fd7\u91cc\u51fa\u73b0\u201c\u91cd\u590d\u521b\u5efa/\u91cd\u590d FreeClass/prepare \u987a\u5e8f\u5076\u73b0\u201d <code>runtime/class_linker.cpp::LoadClass(... addToRuntime)</code>\uff08InsertClass \u51b2\u7a81\u56de\u6536\uff09 runtime_class_linker.cpp\uff08FileNotes\uff09\uff08InsertClass \u6bb5\uff09 \u62a5 <code>CLASS_CIRCULARITY</code>\uff08\u81ea\u5df1\u7684\u7236\u7c7b/\u7236\u63a5\u53e3\uff09 <code>runtime/class_linker.cpp::TryInsertClassLoading</code> runtime_class_linker.cpp\uff08FileNotes\uff09\uff08ClassLoadingSet \u6bb5\uff09 \u4f60\u6000\u7591\u67d0\u5904\u5728\u7b49\u5f85 class init\uff08IS_WAITING/condvar\uff09 <code>runtime/class_lock.cpp</code>\uff08ClassLock Wait/NotifyAll\uff09 runtime_class_lock.cpp\uff08FileNotes\uff09\uff08\u82e5\u540e\u7eed\u63a5\u5165\u5230\u521d\u59cb\u5316/\u53cd\u5c04\u8def\u5f84\uff09"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#_1","title":"\u8bc1\u636e\u94fe","text":"<ul> <li><code>runtime/class_linker.cpp</code>\uff08InsertClass \u51b2\u7a81\u56de\u6536\uff1bClassLoadingSet/CLASS_CIRCULARITY\uff1bLoadClass \u5185 ext-&gt;InitializeClass hook\uff09</li> <li><code>runtime/class_linker_context.h</code>\uff08InsertClass/loadedClasses_/mutexTable_/ClassMutexHandler\uff09</li> <li><code>runtime/class_lock.h</code> + <code>runtime/class_lock.cpp</code>\uff08ClassLock RAII/Wait/NotifyAll\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Concurrency_and_ClassLock/#_2","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u628a\u201c\u5e76\u53d1\u53bb\u91cd\u201d\u653e\u56de GetClass/LoadClass \u4e3b\u7ebf\u5bf9\u9f50 \u2192 GetClass_and_LoadClass\uff08Flow\uff09</li> <li>\u60f3\u770b copied methods/default method \u7684\u771f\u5b9e\u843d\u5730\u6548\u679c \u2192 Builders_and_LinkMethods\uff08Flow\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/","title":"Flow\uff1aETS Context \u7684 native \u94fe\u5f0f\u52a0\u8f7d vs managed \u56de\u9000","text":""},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08\u201cETS\uff1acontext \u7684 native\u2192managed \u4e24\u6bb5\u5f0f\u52a0\u8f7d\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/#1-ets","title":"1) \u4e3a\u4ec0\u4e48 ETS \u8981\u8fd9\u4e48\u505a","text":"<p>ETS \u7684\u975e boot \u7c7b\u52a0\u8f7d\u7531 managed <code>RuntimeLinker</code> \u9a71\u52a8\uff08\u7c7b\u4f3c class loader\uff09\uff0c\u4f46 VM \u5185\u90e8\u7ebf\u7a0b\uff08JIT/AOT \u7b49\uff09\u4e0d\u80fd\u968f\u610f re-enter managed\u3002 \u56e0\u6b64 <code>EtsClassLinkerContext::LoadClass</code> \u91c7\u7528\u201c\u4e24\u6bb5\u5f0f\u201d\uff1a - native \u4f18\u5148\uff1a\u4ec5\u5bf9\u767d\u540d\u5355 linker\uff08coreAbcRuntimeLinker/coreMemoryRuntimeLinker\uff09\u590d\u523b\u94fe\u5f0f\u67e5\u627e\u903b\u8f91 - \u5fc5\u8981\u65f6 managed \u56de\u9000\uff1a\u53ea\u5141\u8bb8\u5728 managed \u7ebf\u7a0b/\u534f\u7a0b\u4e2d\u8c03\u7528 <code>RuntimeLinker.loadClass(final)</code></p>"},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/#2-mermaid","title":"2) Mermaid\uff1a\u4e24\u6bb5\u5f0f\u52a0\u8f7d","text":"<pre><code>sequenceDiagram\n  participant Ctx as EtsClassLinkerContext\n  participant Chain as RuntimeLinker\u94fe(parent+shared libs)\n  participant CL as ClassLinker(core)\n  participant Managed as managed RuntimeLinker.loadClass\n\n  Ctx-&gt;&gt;Ctx: FindClass(descriptor)\n  alt \u547d\u4e2d\u7f13\u5b58\n    Ctx--&gt;&gt;Ctx: return Class*\n  else \u672a\u547d\u4e2d\n    Ctx-&gt;&gt;Chain: TryLoadingClassFromNative\n    alt \u94fe\u904d\u5386\u6210\u529f\u4e14\u627e\u5230/\u6216\u6709\u9519\u8bef\n      Chain-&gt;&gt;CL: GetClass/LoadClass\uff08boot \u8d70 filter+bootPandaFiles\uff09\n      CL--&gt;&gt;Ctx: Class* \u6216 error\n    else \u94fe\u904d\u5386\u5931\u8d25\uff08\u975e\u767d\u540d\u5355linker\uff09\n      Ctx-&gt;&gt;Ctx: \u4ec5 managed \u7ebf\u7a0b\u5141\u8bb8\u56de\u9000\n      alt \u975e managed \u7ebf\u7a0b\n        Ctx--&gt;&gt;Ctx: CLASS_NOT_FOUND / nullptr\n      else managed \u7ebf\u7a0b\n        Ctx-&gt;&gt;Managed: loadClass(runtimeLinker, className, nullptr)\n        Managed--&gt;&gt;Ctx: class object / exception\n        Ctx--&gt;&gt;Ctx: Class* / nullptr\n      end\n    end\n  end</code></pre>"},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/#3","title":"3) \u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/plugins_ets_runtime_ets_class_linker_context.cpp</li> <li>FileNotes/plugins_ets_runtime_ets_class_linker_extension.cpp\uff08CreateApplicationRuntimeLinker\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/ETS_Context_Native_vs_Managed_Load/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u4e3a\u4ec0\u4e48\u975e managed \u7ebf\u7a0b\u7981\u6b62\u56de\u9000\u201d\u7684\u51b3\u7b56\u6811\u7248\u672c \u2192 ../Newbie_MinDebug_Playbook\uff08\u5b9e\u9a8c 2\uff09</li> <li>\u60f3\u628a \u201cGetClass/LoadClass \u4e3b\u7ebf\u201d \u4e0e ETS \u7279\u5316\u5bf9\u9f50 \u2192 GetClass_and_LoadClass</li> </ul>"},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/","title":"Flow\uff1aFileManager \u52a0\u8f7d <code>.abc</code> / <code>.an</code> \u2192 ClassLinker/AotManager","text":""},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08Flow\uff09\uff08\u201c\u8f93\u5165\uff08\u6587\u4ef6/\u4e0a\u4e0b\u6587\uff09\u201d\u6846\uff1a.abc/.an \u5982\u4f55\u8fdb\u5165 runtime\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/#1-abcpanda-file","title":"1) <code>.abc</code>\uff08panda file\uff09\u52a0\u8f7d","text":"<p><code>FileManager::LoadAbcFile(location, openMode)</code>\uff1a - <code>OpenPandaFile(location, \"\", openMode)</code> \u6253\u5f00 <code>.abc</code> - \u82e5\u542f\u7528 <code>.an</code> \u4e14\u975e ArkAot\uff1a   - \u5148\u5c1d\u8bd5\u52a0\u8f7d\u5bf9\u5e94 <code>.an</code>\uff08AOT \u6587\u4ef6\uff09   - \u82e5\u627e\u5230 AOT panda file\uff0c\u5219\u628a <code>class hash table</code> \u56de\u586b\u7ed9 panda file\uff08\u52a0\u901f\u67e5\u627e\uff09 - <code>Runtime::GetCurrent()-&gt;GetClassLinker()-&gt;AddPandaFile(std::move(pf))</code>   - \u89e6\u53d1\uff1apandaFiles \u6ce8\u518c\u3001bootPandaFiles\u3001boot bloom filter\u3001notification/debug \u6ce8\u518c</p>"},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/#2-anaot","title":"2) <code>.an</code>\uff08AOT\uff09\u52a0\u8f7d","text":"<p><code>FileManager::LoadAnFile(anLocation, force)</code>\uff1a - \u8ba1\u7b97\u7edd\u5bf9\u8def\u5f84\u4f5c\u4e3a key - \u6839\u636e runtime options + runtime type \u63a8\u5bfc <code>gcType</code> - <code>AotManager::AddFile(path, runtimeIface, gcType, force)</code> \u8fd4\u56de Expected\uff08\u542b\u9519\u8bef\u5b57\u7b26\u4e32\uff09</p>"},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/#3","title":"3) \u8bc1\u636e\u94fe","text":"<ul> <li>runtime_include_file_manager.h\uff08FileNotes\uff09</li> <li>runtime_file_manager.cpp\uff08FileNotes\uff09</li> <li>runtime_class_linker.cpp\uff08FileNotes\uff09\uff08AddPandaFile\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/FileManager_ABC_AN/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cboot/app \u53ef\u89c1\u57df\u662f\u600e\u4e48\u5206\u7684\uff08boot bloom filter \u4ec0\u4e48\u65f6\u5019\u751f\u6548\uff09\u201d \u2192 GetClass_and_LoadClass\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cAOT class context/\u88c5\u8f7d\u5165\u53e3\uff08\u8de8\u7ae0\uff09\u201d \u2192 compiler_aot_aot_manager.cpp\uff08FileNotes\uff09 \u4e0e compiler_aot_aot_file.cpp\uff08FileNotes\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/","title":"Flow\uff1aGetClass \u2192 LoadClass\uff08boot vs app \u603b\u94fe\u8def\uff09","text":""},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08Flow\uff09\uff08\u201c\u5165\u53e3\uff1a\u6309 descriptor \u627e Class\u201d\u4e0e\u201c\u4e3b\u7ba1\u7ebf\uff1aLoadClass\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#1-getclass-loadclass","title":"1) \u80cc\u666f\uff1aGetClass \u662f\u201c\u5165\u53e3\u201d\uff0cLoadClass \u662f\u201c\u4e3b\u7ba1\u7ebf\u201d","text":"<p>\u4f60\u53ef\u4ee5\u628a <code>ClassLinker::GetClass</code> \u770b\u4f5c\u201c\u6309 descriptor/pf,id \u627e\u5230\u4e00\u4e2a\u53ef\u7528\u7684 Class*\u201d\uff0c\u5b83\u8d1f\u8d23\uff1a - \u7f13\u5b58\u547d\u4e2d\u76f4\u63a5\u8fd4\u56de - union/array descriptor \u7279\u5224 - boot context\uff1a\u7528 bloom filter + boot panda files \u67e5\u627e\u5e76\u52a0\u8f7d - app context\uff1a\u59d4\u6258 <code>context-&gt;LoadClass</code>\uff08ETS \u6709\u7279\u5316\uff09</p> <p>\u8865\u5145\u4e00\u4e2a\u975e\u5e38\u5b9e\u7528\u4f46\u5bb9\u6613\u6f0f\u6389\u7684\u7ec6\u8282\uff08\u5f71\u54cd\u6392\u969c\u4e0e\u6027\u80fd\u5224\u65ad\uff09\uff1a - <code>GetClass(pf, id, ...)</code> \u5148\u67e5 <code>pf.GetPandaCache()-&gt;GetClassFromCache(id)</code>\uff0c\u547d\u4e2d\u540e\u4f1a\u7ed5\u8fc7\u540e\u7eed\u7684\u5927\u90e8\u5206\u8def\u5f84\uff1b\u672a\u547d\u4e2d\u4f46\u6700\u7ec8\u52a0\u8f7d\u6210\u529f\u65f6\uff0c\u4f1a <code>SetClassCache(id, cls)</code> \u5199\u56de\u7f13\u5b58\u3002</p> <p>\u800c\u771f\u6b63\u7684\u201c\u521b\u5efa\u4e00\u4e2a\u65b0 Class \u5bf9\u8c61\u3001\u586b\u5145 methods/fields\u3001\u6784\u5efa\u6d3e\u53d1\u8868\u3001\u8ba1\u7b97 offset\u201d\u7684\u4e3b\u7ba1\u7ebf\u5728 <code>LoadClass(...)</code> \u5185\u3002</p>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#2-mermaidgetclass-readme","title":"2) Mermaid\uff1aGetClass \u51b3\u7b56\u6811\uff08\u6982\u5ff5\u540c README\uff09","text":"<pre><code>flowchart TD\n  A[\"GetClass(descriptor, context)\"] --&gt; B{\"FindLoadedClass\\n(context\u7f13\u5b58)\"}\n  B --&gt;|\u662f| R1[\"\u8fd4\u56de Class*\"]\n  B --&gt;|\u5426| C{\"Union/Array?\"}\n  C --&gt;|Union| U[\"LoadUnionClass\\n(commonContext)\"] --&gt; R2[\"\u8fd4\u56de/\u63d2\u5165/\u53bb\u91cd\"]\n  C --&gt;|Array| AR[\"LoadArrayClass\\n(componentContext)\"] --&gt; R2\n  C --&gt;|\u666e\u901a| D{\"IsBootContext?\"}\n  D --&gt;|\u662f| F{\"LookupInFilter\\n(bloom filter)\"}\n  F --&gt;|IMPOSSIBLY_HAS| R0[\"nullptr\"]\n  F --&gt;|POSSIBLY_HAS| G[\"FindClassInBootPandaFiles\"] --&gt; H{\"\u627e\u5230 classId?\"}\n  H --&gt;|\u5426| R3[\"OnError(CLASS_NOT_FOUND)\\nnullptr\"]\n  H --&gt;|\u662f| I[\"LoadClass(pf,classId,descriptor,context)\"] --&gt; J[\"InsertClass \u5e76\u53d1\u53bb\u91cd\"] --&gt; R4[\"Class*\"]\n  D --&gt;|\u5426| K[\"context-&gt;LoadClass\\n(ETS \u7279\u5316)\"] --&gt; R4</code></pre>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#3-loadclass","title":"3) LoadClass \u4e3b\u7ba1\u7ebf\uff08\u6838\u5fc3\u6b65\u9aa4\uff09","text":"<p>\u5bf9\u5e94 <code>runtime/class_linker.cpp</code>\uff1a - <code>SetupClassInfo</code>\uff1a\u521b\u5efa <code>ITableBuilder/VTableBuilder/IMTableBuilder</code>\uff0c\u5e76\u8ba1\u7b97 <code>Class::ComputeClassSize</code> \u8f93\u5165 - <code>ext-&gt;CreateClass</code>\uff1a\u521b\u5efa Class \u5bf9\u8c61\uff08ETS\uff1aNonMovable <code>EtsClass</code> + \u5185\u5d4c runtime Class \u7ed1\u5b9a\uff09 - <code>LoadMethods</code>\uff1a\u521d\u59cb\u5316 Method \u6570\u7ec4\uff08\u542b copied methods\uff09\u3001\u8bbe\u7f6e entrypoint\uff08C2I/native/AOT/stub\uff09 - <code>LoadFields</code>\uff1a\u521d\u59cb\u5316 Field \u6570\u7ec4\uff08type \u4f4d\u6bb5\u7f16\u7801\u5230 accessFlags\uff09 - <code>LinkMethods</code>\uff1avtable.UpdateClass\uff1bitable.Resolve+UpdateClass\uff1bimtable.UpdateClass - <code>LinkFields</code>\uff1a<code>LayoutFields(static/instance)</code> \u5199 offset/refFields*/objectSize - <code>InsertClass</code>\uff1a\u5e76\u53d1\u53bb\u91cd\uff08\u53e6\u7ebf\u7a0b\u5148\u63d2\u5165\u5219\u56de\u6536\u65b0\u5bf9\u8c61\u5e76\u8fd4\u56de\u5df2\u6709\u5bf9\u8c61\uff09</p>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#31","title":"3.1 \u5e76\u53d1\u4e0e\u9012\u5f52\u52a0\u8f7d\uff1a\u4f60\u5fc5\u987b\u77e5\u9053\u7684\u4e24\u6761\u201c\u771f\u5b9e\u7b56\u7565\u201d","text":""},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#311-insertclass","title":"3.1.1 \u5e76\u53d1\uff1a\u4e0d\u662f\u201c\u4e00\u4e2a\u7ebf\u7a0b\u52a0\u8f7d\u201d\uff0c\u800c\u662f\u201c\u5141\u8bb8\u91cd\u590d\u6784\u5efa\uff0c\u6700\u540e InsertClass \u53bb\u91cd\u201d","text":"<p>\u5f53\u524d\u5b9e\u73b0\u66f4\u63a5\u8fd1\u201c\u4e50\u89c2\u5e76\u884c + \u6700\u540e\u53bb\u91cd\u201d\uff0c\u800c\u4e0d\u662f\u201c\u6309 descriptor \u4e32\u884c\u6392\u961f\u201d\uff1a</p> <ul> <li>\u591a\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u540c\u65f6\u8d70\u5b8c\u6574\u4e2a <code>LoadClass</code>\uff08builders/layout/link \u90fd\u4f1a\u505a\uff09</li> <li>\u6700\u7ec8\u7531 <code>context-&gt;InsertClass(klass)</code> \u51b3\u5b9a\u201c\u8c01\u8d62\u201d</li> <li>\u8d62\u8005\uff1a\u63d2\u5165\u6210\u529f\uff08\u8fd4\u56de nullptr\uff09</li> <li>\u8f93\u8005\uff1a\u5f97\u5230 <code>otherKlass</code>\uff0c\u8c03\u7528\u65b9 <code>FreeClass(klass)</code> \u5e76\u8fd4\u56de\u5df2\u6709\u5bf9\u8c61</li> </ul> <p>\u8be6\u7ec6\u65f6\u5e8f\u56fe\u89c1\uff1aConcurrency_and_ClassLock\uff08Flow\uff09</p>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#312-class_circularity-thread_local-classloadingset","title":"3.1.2 \u9012\u5f52\uff1aCLASS_CIRCULARITY \u4e0d\u662f\u9501\u68c0\u6d4b\uff0c\u800c\u662f thread_local \u7684 ClassLoadingSet","text":"<p><code>LoadClass(pf,id,...)</code> \u5185\u7ef4\u62a4 <code>thread_local ClassLoadingSet*</code>\uff08key = <code>(pfHash&lt;&lt;32)|classId</code>\uff09\u3002 \u5728\u52a0\u8f7d base class \u524d\u4f1a\u5c1d\u8bd5\u63d2\u5165\u8be5 key\uff0c\u91cd\u590d\u5373\u4e0a\u62a5 <code>CLASS_CIRCULARITY</code>\uff08\u201c\u81ea\u5df1\u7684\u7236\u7c7b/\u7236\u63a5\u53e3\u201d\uff09\u3002</p>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#32-boot-bloomfilteraddlookup","title":"3.2 Boot BloomFilter\uff1aAdd/Lookup \u7684\u786e\u5207\u8bed\u4e49\uff08\u907f\u514d\u65b0\u624b\u8bef\u5224\uff09","text":"<ul> <li>\u4ec0\u4e48\u65f6\u5019 Add\uff1a</li> <li><code>ClassLinker::AddPandaFile</code> \u628a\u6587\u4ef6\u52a0\u5165 <code>bootPandaFiles_</code> \u65f6\uff0c\u5982\u679c <code>--use-boot-class-filter</code> \u6253\u5f00\uff0c\u4f1a\u8c03\u7528 <code>AddBootClassFilter(file)</code></li> <li><code>AddBootClassFilter</code> \u904d\u5386 <code>pf-&gt;GetClasses()</code>\uff0c\u628a\u6bcf\u4e2a className \u52a0\u5165 <code>bootClassFilter_</code></li> <li>\u4ec0\u4e48\u65f6\u5019 Lookup\uff1a</li> <li>\u5728 boot context \u7684 <code>GetClass(descriptor)</code> \u8def\u5f84\u91cc\u4f1a\u5148 <code>LookupInFilter(descriptor)</code></li> <li>\u5982\u679c <code>PossiblyContains==false</code>\uff1a<ul> <li>\u6ca1\u6709 errorHandler\uff1a\u76f4\u63a5\u8fd4\u56de <code>IMPOSSIBLY_HAS</code>\uff08\u5feb\u901f\u5931\u8d25\uff09</li> <li>\u6709 errorHandler\uff1a\u540c\u65f6\u4e0a\u62a5 <code>CLASS_NOT_FOUND</code> \u5e76\u8fd4\u56de <code>IMPOSSIBLY_HAS</code></li> </ul> </li> </ul> <p>\u76f4\u89c9\uff1afilter \u53ea\u7528\u4e8e\u201c\u5feb\u901f\u5426\u5b9a\u201d\uff0c\u4e0d\u4f1a\u4fdd\u8bc1\u201cPOSSIBLY_HAS \u4e00\u5b9a\u5b58\u5728\u201d\uff1b\u771f\u6b63\u67e5\u627e\u4ecd\u8981\u904d\u5386 boot panda files\u3002</p>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#4","title":"4) \u8bc1\u636e\u94fe\uff08\u9010\u884c\u53ef\u5ba1\u8ba1\uff09","text":"<ul> <li>runtime_class_linker.cpp\uff08FileNotes\uff09\uff08GetClass/LoadClass/SetupClassInfo/LoadMethods/LoadFields/Link*\uff09</li> <li>runtime_include_class_linker.h\uff08FileNotes\uff09\uff08\u7ba1\u7ebf\u5206\u89e3\uff09</li> <li>plugins_ets_runtime_ets_class_linker_context.cpp\uff08FileNotes\uff09\uff08\u975e boot \u7684 ETS context-&gt;LoadClass\uff09</li> <li>plugins_ets_runtime_ets_class_linker_extension.cpp\uff08FileNotes\uff09\uff08ext-&gt;CreateClass / native entrypoint\uff09</li> <li>\u5173\u952e\u6e90\u7801\u951a\u70b9\uff1a</li> <li><code>runtime/class_linker.cpp::AddPandaFile/AddBootClassFilter/LookupInFilter</code></li> <li><code>runtime/class_linker.cpp::ClassLoadingSet/TryInsertClassLoading</code>\uff08CLASS_CIRCULARITY\uff09</li> <li><code>runtime/class_linker_context.h::InsertClass</code>\uff08\u5e76\u53d1\u53bb\u91cd\u7684\u6700\u540e\u4e00\u9053\u95e8\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/GetClass_and_LoadClass/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u628a\u201c\u6587\u4ef6\u88c5\u8f7d\u2192boot/app \u53ef\u89c1\u57df\u201d\u4e32\u8d77\u6765 \u2192 FileManager_ABC_AN\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cvtable/itable/IMT \u6784\u5efa\u4e0e\u51b2\u7a81\u201d \u2192 Builders_and_LinkMethods\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u5b57\u6bb5\u5e03\u5c40/offset \u5199\u56de\u201d \u2192 LayoutFields_and_LinkFields\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u5e76\u53d1\u4e0e\u9012\u5f52\u52a0\u8f7d\uff08\u91cd\u590d\u6784\u5efa/\u53bb\u91cd/CLASS_CIRCULARITY\uff09\u201d \u2192 Concurrency_and_ClassLock\uff08Flow\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/Index/","title":"03_ClassLoading / Flows","text":"<p>\u672c\u76ee\u5f55\u4ee5\u201c\u8fd0\u884c\u65f6\u8c03\u7528\u94fe\u201d\u4e3a\u4e3b\u7ebf\u7ec4\u7ec7\u8bf4\u660e\u3002\u6bcf\u6761 flow \u90fd\u6307\u5411\u5bf9\u5e94\u7684 <code>FileNotes/</code> \u4f5c\u4e3a\u53ef\u5ba1\u8ba1\u8bc1\u636e\u3002</p>"},{"location":"03_ClassLoading/Flows/Index/#flow","title":"Flow \u6e05\u5355\uff08\u5efa\u8bae\u987a\u5e8f\uff09","text":"<ol> <li>ClassLoading_EndToEnd\uff1a\u7aef\u5230\u7aef\u4e3b\u7ebf\uff08\u65b0\u4eba\u810a\u67f1\u56fe\uff09\uff1a\u6587\u4ef6\u88c5\u8f7d\u2192GetClass\u2192LoadClass\u2192builders/layout/link\u2192\u5e76\u53d1\u53bb\u91cd\u2192\u521d\u59cb\u5316\u4ea4\u754c\uff08\u6bcf\u4e2a\u6846\u90fd\u53ef\u4e0b\u6f5c\uff09</li> <li>GetClass_and_LoadClass\uff1a\u4ece <code>GetClass</code> \u5230 <code>LoadClass</code> \u7684\u603b\u94fe\u8def\uff08boot vs app\uff09</li> <li>Builders_and_LinkMethods\uff1avtable/itable/IMT \u7684\u6784\u5efa\u4e0e\u5199\u56de\uff08LinkMethods\uff09</li> <li>LayoutFields_and_LinkFields\uff1a\u5b57\u6bb5\u5e03\u5c40\u7b97\u6cd5\u4e0e offset \u5199\u56de\uff08LinkFields\uff09</li> <li>Concurrency_and_ClassLock\uff1a\u5e76\u53d1\u7c7b\u52a0\u8f7d\uff08InsertClass \u53bb\u91cd\uff09+ \u9012\u5f52\u52a0\u8f7d\u9632\u62a4\uff08CLASS_CIRCULARITY\uff09+ ClassLock\uff08per-class condvar\uff09</li> <li>ETS_Context_Native_vs_Managed_Load\uff1aETS context \u7684 native \u4f18\u5148\u94fe\u5f0f\u52a0\u8f7d\u4e0e managed \u56de\u9000</li> <li>FileManager_ABC_AN\uff1a<code>.abc/.an</code> \u5982\u4f55\u8fdb\u5165 ClassLinker/AotManager</li> </ol> <p>\u65b0\u4eba\u8c03\u8bd5\u5165\u53e3\uff08\u4e0d\u5c5e\u4e8e flow\uff0c\u4f46\u5f3a\u70c8\u5efa\u8bae\u6536\u85cf\uff09\uff1aNewbie_MinDebug_Playbook</p>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/","title":"Flow\uff1aLayoutFields \u2192 LinkFields\uff08offset/\u5bf9\u9f50/\u57fa\u7c7b padding \u56de\u586b\uff09","text":""},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aClassLoading_EndToEnd\uff08\u201cLinkFields\uff1aLayoutFields \u5199\u56de offset/objectSize/refFields*\u201d\u6846\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#1","title":"1) \u53d1\u751f\u5728\u4ec0\u4e48\u65f6\u5019","text":"<p>\u5728 <code>runtime/class_linker.cpp</code>\uff1a - <code>LoadFields</code> \u53ea\u521b\u5efa Field \u6570\u7ec4\u5e76\u586b type/flags\uff0c\u4e0d\u586b offset - <code>LinkFields</code> \u9636\u6bb5\u8c03\u7528 <code>LayoutFields(static)</code> \u4e0e <code>LayoutFields(instance)</code> \u5199\u56de offset\uff0c\u5e76\u5199\u56de <code>Class</code> \u7684 objectSize/refFields* \u5143\u6570\u636e</p>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#2-mermaid","title":"2) Mermaid\uff1a\u5b57\u6bb5\u5e03\u5c40\u7b97\u6cd5\u6846\u67b6","text":"<pre><code>flowchart TD\n  A[\"LayoutFields(klass, fields, isStatic)\"] --&gt; B[\"\u5206\u6876\\nref/tagged/64/32/16/8\"]\n  B --&gt; C[\"LayoutFieldsInBaseClassPadding\\n(\u786e\u5b9a\u8d77\u59cboffset+\u5bf9\u9f50)\\n\u5e76\u9006\u5411\u585e\u56de 32/16/8\"]\n  C --&gt; D[\"\u82e5\u6709 refFields:\\n\u5bf9\u9f50\u5230 OBJECT_POINTER_SIZE\\n\u5199 refFieldsNum/Offset\\nvolatile ref \u4f18\u5148\u5e03\u5c40\"]\n  D --&gt; E[\"Tagged(64) + 64bit\\n\u5fc5\u8981\u65f6\u7528\u5c0f\u5b57\u6bb5\u586b\u5145\u5bf9\u9f50\u7f3a\u53e3\"]\n  E --&gt; F[\"32bit\\n\u5fc5\u8981\u65f6\u7528 16/8 \u586b\u5145\u5bf9\u9f50\u7f3a\u53e3\"]\n  F --&gt; G[\"16bit\\n\u5fc5\u8981\u65f6\u7528 8 \u586b\u5145\u5bf9\u9f50\u7f3a\u53e3\"]\n  G --&gt; H[\"8bit\"]\n  H --&gt; I[\"\u8fd4\u56de\u6700\u7ec8 size\\n(instance \u4e14\u975e\u53d8\u957f \u2192 SetObjectSize)\"]</code></pre>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#3","title":"3) \u5173\u952e\u89c4\u5219\uff08\u7b80\u8bb0\uff09","text":"<ul> <li>\u987a\u5e8f\u7ea6\u675f\uff1a\u6ce8\u91ca\u660e\u786e\u8981\u6c42\u4fdd\u6301\u201c\u8bed\u8a00\u4fa7 class \u8868\u793a\u7684\u5b57\u6bb5\u76f8\u5bf9\u987a\u5e8f\u201d\u2014\u2014\u56e0\u6b64\u4f1a\u51fa\u73b0\u201c\u4ece vector \u5934\u5220\u5143\u7d20\u201d\u7684\u5b9e\u73b0\u65b9\u5f0f\uff08\u4fdd\u8bc1\u5e8f\uff09\u3002</li> <li>ref \u5b57\u6bb5\uff1a</li> <li>\u5148\u5e03\u5c40 volatile ref \u518d\u5e03\u5c40\u975e volatile ref</li> <li>\u5199\u56de <code>SetRefFieldsNum/Offset/SetVolatileRefFieldsNum</code></li> <li>\u57fa\u7c7b padding \u56de\u586b\uff1a</li> <li>\u82e5\u5bf9\u9f50\u5bfc\u81f4\u4ea7\u751f padding\uff0c\u4f18\u5148\u628a\u5b50\u7c7b\u5c0f\u5b57\u6bb5\u9006\u5411\u585e\u5165 padding \u672b\u5c3e</li> <li>instance objectSize\uff1a</li> <li>\u975e static \u4e14\u975e variable-size \u624d\u5199 <code>klass-&gt;SetObjectSize(size)</code></li> </ul>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#4","title":"4) \u8bc1\u636e\u94fe","text":"<ul> <li>FileNotes/runtime_class_linker.cpp\uff08LayoutFieldsWithoutAlignment/LayoutReferenceFields/LayoutFieldsInBaseClassPadding/LayoutFields/LinkFields\uff09</li> <li>FileNotes/runtime_include_field.h\uff08Field::offset_ \u8bed\u4e49\uff09</li> <li>FileNotes/runtime_include_class.h\uff08ref fields \u5143\u6570\u636e\u5b57\u6bb5\u4e0e\u8bbf\u95ee\uff09</li> </ul>"},{"location":"03_ClassLoading/Flows/LayoutFields_and_LinkFields/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u5148\u628a GetClass/LoadClass \u4e3b\u7ebf\u5bf9\u9f50 \u2192 GetClass_and_LoadClass</li> <li>\u60f3\u770b\u201cbuilder \u5199\u56de\u987a\u5e8f\uff08vtable/itable/IMT\uff09\u201d \u2192 Builders_and_LinkMethods</li> <li>\u60f3\u770b\u201cClass/Field \u7684\u5173\u952e\u5b57\u6bb5\u8bed\u4e49\u201d \u2192 ../DataStructures/Class \u4e0e ../DataStructures/Field</li> </ul>"},{"location":"03_ClassLoading/Manifests/Index/","title":"03 ClassLoading / Manifests / Index","text":"<p>\u672c\u76ee\u5f55\u653e\u7684\u662f \u201c\u672c\u7ae0\u8986\u76d6\u8303\u56f4\u201d\u4e0e\u201c\u843d\u5730\u8bc1\u636e\u6e05\u5355\u201d\uff0c\u7528\u4e8e\uff1a</p> <ul> <li>\u8ba9\u65b0\u4eba\u77e5\u9053\u672c\u7ae0\u8981\u770b\u54ea\u4e9b runtime \u6587\u4ef6\uff08\u4ee5\u53ca\u4e3a\u4ec0\u4e48\uff09</li> <li>\u652f\u6491 Completion Review \u505a\u201c\u8986\u76d6\u7387/\u65ad\u8a00\u8bc1\u636e\u94fe\u201d\u9a8c\u6536</li> </ul>"},{"location":"03_ClassLoading/Manifests/Index/#_1","title":"\u6587\u4ef6\u8bf4\u660e","text":"<ul> <li><code>files.yaml</code></li> <li>\u7528\u9014\uff1a\u672c\u7ae0\u201c\u5173\u952e\u6e90\u6587\u4ef6\u6e05\u5355\u201d\uff08\u4eba\u4e3a\u7ef4\u62a4\uff09</li> <li>\u5178\u578b\u7528\u6cd5\uff1areview/\u6392\u969c\u65f6\uff0c\u7528\u5b83\u5bf9\u7167\u786e\u8ba4\u5173\u952e\u6587\u4ef6\u662f\u5426\u90fd\u88ab\u8bfb\u8fc7/\u5199\u8fc7 FileNotes</li> <li><code>tree_inventory.txt</code></li> <li>\u7528\u9014\uff1a\u76ee\u5f55\u6811\u5feb\u7167\uff08\u65b9\u4fbf\u5feb\u901f\u67e5\u627e\u6587\u4ef6\u540d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/","title":"04_ExecutionEngine\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\uff08\u76ee\u6807\uff1a\u65b0\u540c\u5b66\u4e0d\u8bfb FileNotes \u4e5f\u80fd\u5efa\u7acb\u201c\u6267\u884c\u5f15\u64ce\u600e\u4e48\u8dd1\u201d\u7684\u6574\u4f53\u6a21\u578b\uff0c\u9700\u8981\u65f6\u518d\u4e0b\u6f5c\u9010\u884c\u8bc1\u636e\uff09\u3002</p>"},{"location":"04_ExecutionEngine/#_1","title":"\u4f60\u8bfb\u5b8c\u5e94\u8be5\u80fd\u56de\u7b54\u4ec0\u4e48\uff08\u9762\u5411\u65b0\u540c\u5b66\uff09","text":"<ul> <li>\u4e00\u6bb5\u5b57\u8282\u7801\u662f\u600e\u4e48\u88ab\u6267\u884c\u7684\uff1a\u89e3\u91ca\u5668\u5165\u53e3\u5728\u54ea\u91cc\uff1fPC/Frame/VReg/Acc \u662f\u4ec0\u4e48\u5173\u7cfb\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u80fd\u4ece\u89e3\u91ca\u5668\u8df3\u5230\u7f16\u8bd1\u4ee3\u7801\uff0c\u53c8\u80fd\u4ece\u7f16\u8bd1\u4ee3\u7801\u56de\u5230\u89e3\u91ca\u5668\uff1aI2C/C2I bridge \u7684\u8fb9\u754c\u4e0e\u8fd4\u56de\u503c\u8bed\u4e49\u662f\u4ec0\u4e48\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u4f1a\u53bb\u4f18\u5316\uff08deopt\uff09/\u4e3a\u4ec0\u4e48\u8981 OSR\uff1aOSR code \u7684\u5b89\u88c5\u6761\u4ef6\u662f\u4ec0\u4e48\uff1fStackWalker \u5728\u8c03\u8bd5/\u6808\u56de\u6eaf/\u53bb\u4f18\u5316\u4e2d\u626e\u6f14\u4ec0\u4e48\u89d2\u8272\uff1f</li> <li>JIT/AOT/entrypoints \u7684\u4f4d\u7f6e\uff1a\u7f16\u8bd1\u5668\u5982\u4f55\u901a\u8fc7 RuntimeInterface \u67e5\u8be2\u4fe1\u606f\uff1f\u7f16\u8bd1\u4ee3\u7801\u8c03\u7528\u8fd0\u884c\u65f6\u6162\u8def\u5f84\u8d70\u54ea\u91cc\uff1f</li> </ul>"},{"location":"04_ExecutionEngine/#chapter-3","title":"\u524d\u7f6e\u77e5\u8bc6\uff08\u4e0e Chapter 3 \u7684\u4ea4\u754c\uff09","text":"<p>\u6267\u884c\u5f15\u64ce\u5e76\u4e0d\u201c\u51ed\u7a7a\u6267\u884c\u201d\u2014\u2014\u5b83\u6267\u884c\u7684\u662f Chapter 3 \u5df2\u7ecf\u52a0\u8f7d/\u94fe\u63a5\u597d\u7684 <code>Class/Method/Field</code> \u5143\u6570\u636e\uff1a</p> <ul> <li>03 \u7ae0 Stage2 \u5165\u53e3\uff1a03_ClassLoading/README</li> <li>03 \u7ae0\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\uff1aClassLoading_EndToEnd</li> </ul>"},{"location":"04_ExecutionEngine/#filenotes","title":"\u5feb\u901f\u4e0a\u624b\uff08\u4e0d\u8bfb FileNotes \u4e5f\u80fd\u770b\u61c2\u5927\u6982\uff09","text":""},{"location":"04_ExecutionEngine/#0","title":"0) \u5148\u770b\u201c\u7aef\u5230\u7aef\u810a\u67f1\u56fe\u201d\uff08\u65b0\u4eba\u6700\u63a8\u8350\u7684\u7b2c\u4e00\u5165\u53e3\uff09","text":"<ul> <li>Flows/ExecutionEngine_EndToEnd\uff1a\u4e00\u5f20\u56fe\u628a\u201c\u9009\u578b\u2192\u6267\u884c\u2192\u6865\u63a5\u2192entrypoints\u2192JIT/OSR\u2192deopt\u2192\u5f02\u5e38/\u6808\u904d\u5386\u201d\u4e32\u8d77\u6765\uff1b\u6bcf\u4e2a\u6846\u90fd\u80fd\u4e00\u952e\u4e0b\u6f5c\u5230\u5bf9\u5e94 Flow/\u6570\u636e\u7ed3\u6784/\u9010\u884c\u8bc1\u636e\u3002</li> </ul>"},{"location":"04_ExecutionEngine/#1","title":"1) \u4e00\u53e5\u8bdd\u4e3b\u7ebf\uff08\u672c\u7ae0\u6545\u4e8b\u7ebf\uff09","text":"<p>\u6267\u884c\u5f15\u64ce = \u201c\u89e3\u91ca\u5668\u7528 Frame+VReg \u6267\u884c bytecode\u201d + \u201c\u70ed\u70b9\u65f6\u8df3\u5230 compiled entrypoint\u201d + \u201c\u5fc5\u8981\u65f6 deopt/OSR/\u56de\u89e3\u91ca\u5668\u201d + \u201ccompiled code \u901a\u8fc7 entrypoints \u8d70\u6162\u8def\u5f84\u201d\u3002</p>"},{"location":"04_ExecutionEngine/#2","title":"2) \u4e09\u4e2a\u6700\u5e38\u89c1\u573a\u666f\uff08\u6bcf\u4e2a\u573a\u666f\u90fd\u6709\u6392\u969c\u51b3\u7b56\u6811\uff09","text":"<ul> <li>\u573a\u666f A\uff1a\u89e3\u91ca\u5668\u6267\u884c\u5f02\u5e38/\u8bed\u4e49\u4e0d\u5bf9\uff08\u5d29\u6e83\u3001\u629b\u9519\u3001\u8fd4\u56de\u503c\u4e0d\u5bf9\u3001acc/vreg \u9519\uff09</li> <li>\u573a\u666f B\uff1aI2C/C2I \u6865\u63a5\u76f8\u5173\u95ee\u9898\uff08\u8df3\u8f6c\u5230 compiled code \u540e\u5d29\u6e83\uff1b\u4ece compiled \u56de\u89e3\u91ca\u5668\u7ed3\u679c\u4e0d\u5bf9\uff09</li> <li>\u573a\u666f C\uff1adeopt/OSR/stack walking \u95ee\u9898\uff08\u8c03\u8bd5\u6808\u4e0d\u5bf9\u3001\u53bb\u4f18\u5316\u56de\u9000\u5f02\u5e38\u3001OSR \u4e0d\u751f\u6548/\u5361\u4f4f\uff09</li> </ul>"},{"location":"04_ExecutionEngine/#3","title":"3) \u672f\u8bed\u901f\u67e5\uff08\u5efa\u8bae\u4fa7\u8fb9\u6253\u5f00\uff09","text":"<ul> <li>FileNotes/_Glossary\uff1a\u672c\u7ae0\u672f\u8bed\u89e3\u91ca\uff08Frame/VReg/Acc\u3001FrameKind\u3001entrypoint\u3001I2C/C2I\u3001OSR\u3001deopt\u3001StackWalker\u2026\uff09</li> </ul>"},{"location":"04_ExecutionEngine/#4","title":"4) \u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff08\u72ec\u7acb\u6587\u6863\uff09","text":"<ul> <li>Newbie_MinDebug_Playbook\uff1a\u65b0\u4eba 5 \u5206\u949f\u786e\u8ba4 interpreter-type / fast interpreter / dispatch table / bridge boundary / OSR / \u5f02\u5e38\u4e24\u6bb5\u5f0f \u7684\u6700\u77ed\u8def\u5f84</li> </ul>"},{"location":"04_ExecutionEngine/#5-irtoc","title":"5) IRTOC\uff08\u6700\u6838\u5fc3\u4e5f\u6700\u96be\u7684\u65b0\u4eba\u6210\u957f\u70b9\uff09","text":"<p>\u5982\u679c\u4f60\u9700\u8981\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\u4fee\u6539 fast interpreter\uff08<code>.irt</code> / handler / dispatch / OSR / \u5f02\u5e38\u7b49\uff09\uff0c\u5efa\u8bae\u6309\u201c\u7531\u6d45\u5165\u6df1\u201d\uff1a</p> <ul> <li>Flows/IRTOC_FastInterpreter\uff1a\u8fd0\u884c\u65f6\u9009\u578b\u2192dispatch table\u2192<code>ExecuteImplFast*</code> \u7684\u6267\u884c\u94fe\u4e0e build \u751f\u6210\u94fe</li> <li>Flows/IRTOC_DSL_Primer\uff1a<code>.irt \u2192 Graph \u2192 \u673a\u5668\u7801</code> \u7684\u5168\u94fe\u8def\u5206\u5de5 + \u65b0\u4eba\u53ef\u843d\u5730\u7684\u201c\u600e\u4e48\u8bfb/\u600e\u4e48\u6539/\u600e\u4e48\u9a8c\u8bc1\u201d</li> <li>Flows/IRTOC_DSL_Reference\uff1a\u66f4\u201c\u6559\u79d1\u4e66\u5f0f\u201d\u7684 DSL \u53c2\u8003\uff08\u8bed\u6cd5/\u8bed\u4e49/\u5e38\u89c1\u5751/\u67e5\u624b\u518c\uff09</li> </ul>"},{"location":"04_ExecutionEngine/#_2","title":"\u672c\u7ae0\u4ea7\u7269\u5bfc\u822a\uff08\u5148\u770b\u201c\u603b\u89c8\u578b\u201d\uff09","text":"<ul> <li>\u5b66\u4e60\u8def\u7ebf\u56fe\uff1aIndex\uff0830min/2h/1d\uff09</li> <li>\u6c89\u6dc0\u6587\u6863\uff1a</li> <li>DataStructures/Index\uff1a\u5173\u952e\u7ed3\u6784\u5361\u7247\uff08Frame/VReg/Acc/entrypoints/bridges/OSR/Deopt/StackWalker\uff09</li> <li>Flows/ExecutionEngine_EndToEnd\uff1a\u7aef\u5230\u7aef\u4e3b\u7ebf\uff08\u65b0\u4eba\u201c\u810a\u67f1\u56fe\u201d\u5165\u53e3\uff09</li> <li>Flows/Index\uff1a\u4e3b\u8c03\u7528\u94fe\uff08\u89e3\u91ca\u5668\u6267\u884c\u3001\u8c03\u7528\u3001\u6865\u63a5\u3001\u5f02\u5e38\u3001deopt/OSR\uff09</li> <li>opcode \u5165\u95e8\uff08\u65b0\u4eba\u5f3a\u70c8\u5efa\u8bae\u4ece\u8fd9\u91cc\u5f00\u59cb\uff09\uff1a</li> <li>DataStructures/ISA_and_OpcodeModel\uff1aISA\uff08core + ETS\uff09\u5982\u4f55\u5b9a\u4e49 opcode\uff0c\u4ee5\u53ca\u5982\u4f55\u9a71\u52a8 IRTOC \u751f\u6210 handler</li> <li>Flows/Opcode_DeepDives_IRTOC\uff1a\u6311\u9009\u5e38\u7528 opcode \u6df1\u5165\u5206\u6790\uff08call/return/jmp+OSR/throw/ETS name-based \u6307\u4ee4\uff09</li> <li>\u9010\u884c\u8bc1\u636e\u94fe\uff1aFileNotes/Index\uff08\u9700\u8981\u201c\u4e3a\u4ec0\u4e48\u4e00\u5b9a\u662f\u8fd9\u6837\u201d\u65f6\u518d\u4e0b\u6f5c\uff09</li> <li>\u9010\u884c\u6e05\u5355\uff1aManifests/files.yaml\uff08\u672c\u7ae0\u8bed\u4e49\u5f52\u5c5e\u6587\u4ef6\uff09</li> <li>Manifests \u8bf4\u660e\uff1aManifests/Index</li> <li>\u9636\u6bb5\u4e00\u6821\u6b63\uff1aErrata_to_Stage1</li> <li>\u7ae0\u8282\u5b8c\u5de5\u5ba1\u67e5\uff08\u4ea4\u4ed8\u9a8c\u6536\uff09\uff1aCompletion_Review\uff08\u9010\u6587\u6863\u6b63\u786e\u6027\u6838\u9a8c + \u8bc1\u636e\u70b9 + \u53ef\u6267\u884c\u4f18\u5316\u9879\uff09</li> </ul>"},{"location":"04_ExecutionEngine/#_3","title":"\u6267\u884c\u5f15\u64ce\u603b\u89c8\uff1a\u7ec4\u4ef6\u8fb9\u754c\u4e0e\u6570\u636e\u6d41\uff08\u4f60\u5148\u628a\u8fd9\u5f20\u56fe\u8bb0\u4f4f\uff09","text":"<pre><code>flowchart TD\n  subgraph Bytecode[\"Bytecode / PandaFile\"]\n    PF[\".abc / panda_file::File\"]\n    BC[\"Bytecode instructions\\n(opcode + operands)\"]\n  end\n\n  subgraph Runtime[\"Runtime\uff08\u6267\u884c\u5f15\u64ce\uff09\"]\n    INT[\"Interpreter\\n(runtime/interpreter)\"]\n    FAST[\"Fast Interpreter (IRTOC/LLVM)\\n(irtoc/scripts + build outputs)\"]\n    FR[\"Frame + VReg + Acc\\n(frame.h/vregister.h/acc_vregister.h)\"]\n    BR[\"Bridge I2C/C2I\\n(runtime/bridge)\"]\n    EP[\"Entrypoints\uff08\u6162\u8def\u5f84\uff09\\n(runtime/entrypoints)\"]\n    SW[\"StackWalker\\n(runtime/include/stack_walker.h + stack_walker.cpp)\"]\n    DO[\"Deoptimization\\n(runtime/deoptimization.*)\"]\n    OSR[\"OSR\\n(runtime/osr.*)\"]\n  end\n\n  subgraph CompilerSide[\"Compiler/JIT/AOT\uff08\u63a5\u53e3\u89c6\u89d2\uff09\"]\n    RI[\"PandaRuntimeInterface\\n(runtime/compiler.*)\"]\n    CI[\"CompilerInterface\\n(runtime/include/compiler_interface.h)\"]\n  end\n\n  PF --&gt; BC --&gt; INT\n  INT --&gt; FR\n  INT --&gt; FAST\n  FAST --&gt; INT\n  INT --&gt;|\"invoke/dispatch\"| BR\n  BR --&gt;|\"compiled code\"| EP\n  EP --&gt;|\"\u8fd4\u56de/\u5f02\u5e38/\u5206\u914d\u7b49\"| BR\n  BR --&gt;|\"\u56de\u89e3\u91ca\u5668\"| INT\n\n  BR --&gt; DO\n  DO --&gt; INT\n  INT --&gt; OSR\n  OSR --&gt; BR\n\n  SW --&gt; INT\n  SW --&gt; BR\n\n  RI &lt;--&gt; INT\n  RI &lt;--&gt; FAST\n  RI &lt;--&gt; CI\n  RI &lt;--&gt; EP</code></pre>"},{"location":"04_ExecutionEngine/#c-irtocllvm-fast-interpreter","title":"\u89e3\u91ca\u5668\u5b9e\u73b0\u4e0d\u6b62 C++\uff1a\u771f\u5b9e\u9ed8\u8ba4\u662f IRTOC/LLVM fast interpreter","text":"<p>\u4f60\u5728 <code>runtime/interpreter/*</code> \u91cc\u8bfb\u5230\u7684\u5f88\u591a C++ handler\uff0c\u66f4\u591a\u662f \u8bed\u4e49\u5bf9\u7167/\u8c03\u8bd5\u5165\u53e3\uff1b\u4f46\u771f\u5b9e\u8fd0\u884c\u65f6\u9ed8\u8ba4\u4f1a\u9009\u62e9 fast interpreter\uff1a</p> <ul> <li>\u8fd0\u884c\u65f6 option\uff1a<code>--interpreter-type</code>\uff0c\u9ed8\u8ba4 <code>llvm</code>\uff08<code>runtime/options.yaml</code>\uff09</li> <li>\u8fd0\u884c\u65f6\u9009\u62e9\u5165\u53e3\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>fast interpreter \u8bed\u4e49\u811a\u672c\uff1a<code>irtoc/scripts/interpreter.irt</code></li> <li>build \u751f\u6210\u4ea7\u7269\uff08\u672c\u673a\u8bc1\u636e\uff09\uff1a</li> <li><code>build/runtime/include/irtoc_interpreter_utils.h</code>\uff1a392 \u9879 dispatch table\uff08\u542b IRTOC \u4e0e LLVM \u4e24\u5957\uff09</li> <li><code>build/irtoc/irtoc_interpreter/*</code>\uff1a<code>interpreter.irt.fixed</code>\u3001<code>irtoc_code.cpp</code>\u3001<code>irtoc_interpreter.o</code></li> </ul> <p>\u5173\u952e\u73b0\u5b9e\u5dee\u5f02\uff08\u65b0\u4eba\u5fc5\u8bfb\uff09\uff1a - \u9ed8\u8ba4\u503c vs \u5b9e\u9645\u9009\u578b\uff1a<code>runtime/options.yaml</code> \u91cc <code>interpreter-type</code> \u7684 \u9ed8\u8ba4\u503c\u662f <code>llvm</code>\uff0c\u4f46\u8fd0\u884c\u65f6\u4f1a\u5728 <code>runtime/interpreter/interpreter_impl.cpp</code> \u91cc\u57fa\u4e8e frame \u662f\u5426 dynamic / \u662f\u5426\u663e\u5f0f\u8bbe\u7f6e / \u7f16\u8bd1\u5b8f\u80fd\u529b / \u8fd0\u884c\u65f6\u786c\u9650\u5236 \u505a\u6700\u7ec8\u9009\u578b\u3002 - \u9759\u6001\u8bed\u8a00\uff08\u975e dynamic frame\uff09\uff1a\u5982\u679c\u4f60\u6ca1\u6709\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code>\uff0c\u5219\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u503c <code>llvm</code>\uff1b\u5f53\u8be5\u6784\u5efa\u5f00\u542f <code>PANDA_LLVM_INTERPRETER</code> \u65f6\uff0c\u786e\u5b9e\u4f1a\u9ed8\u8ba4\u8d70 LLVM fast interpreter\uff0c\u5426\u5219\u4f1a\u6309\u6e90\u7801\u81ea\u52a8\u964d\u7ea7\uff08LLVM\u2192IRTOC\u2192CPP\uff09\u3002 - \u52a8\u6001\u8bed\u8a00\uff08dynamic frame\uff09\uff1a\u5982\u679c\u4f60\u6ca1\u6709\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code>\uff0c\u6e90\u7801\u4f1a\u5f3a\u5236 \u9ed8\u8ba4\u8d70 cpp\uff08\u8fd9\u662f <code>frame-&gt;IsDynamic()</code> \u7684\u7279\u4f8b\uff1b\u663e\u5f0f\u8bbe\u7f6e\u65f6\u624d\u4f1a\u5c1d\u8bd5 irtoc/llvm\uff09\u3002 - debug-mode\uff1a<code>--debug-mode=true</code> \u53ea\u80fd\u914d <code>--interpreter-type=cpp</code>\uff08\u5426\u5219\u76f4\u63a5 FATAL\uff09\u3002 - arm32\uff1a\u6784\u5efa\u4e0a irtoc \u4e0d\u53ef\u7528\uff0c\u7b49\u4ef7\u4e8e arm32 \u6c38\u8fdc\u8d70 cpp\u3002 - GC \u7ec4\u5408\u7ea6\u675f\uff08\u975e ARK_HYBRID\uff09\uff1a\u4ec5\u5bf9 \u52a8\u6001\u8bed\u8a00 + \u9009\u62e9 fast interpreter\uff08irtoc/llvm\uff09 \u751f\u6548\uff1a\u82e5 <code>--gc-type</code> \u4e0d\u662f <code>g1-gc</code> \u4f1a FATAL\uff08\u9759\u6001\u8bed\u8a00\u4e0d\u53d7\u8be5\u9650\u5236\uff09\u3002 - ARK_HYBRID \u7ec4\u5408\u7ea6\u675f\uff08\u4ec5\u5f53\u7f16\u8bd1\u5b8f <code>ARK_HYBRID</code> \u6253\u5f00\u65f6\uff09\uff1a   - \u53ea\u8981 interpreter-type &gt; cpp\uff0c\u5c31\u8981\u6c42 GC \u5fc5\u987b\u662f <code>cmc-gc</code>\uff08\u5426\u5219 FATAL\uff09   - \u4e14 <code>--interpreter-type=llvm</code> \u4f1a\u76f4\u63a5 FATAL\uff08\u53ea\u5141\u8bb8 cpp/irtoc\uff09   - \u201c\u81ea\u52a8\u964d\u7ea7\u201d\u53ea\u5bf9 \u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u7684\u573a\u666f\u751f\u6548\uff1b\u663e\u5f0f\u6307\u5b9a\u4e0d\u652f\u6301\u7684\u540e\u7aef\u4f1a\u76f4\u63a5 FATAL - \u5173\u4e8e build/ \u76ee\u5f55\u7684\u63d0\u9192\uff1a\u672c\u4ed3\u5e93\u7684 <code>build/</code> \u4ea7\u7269\u662f\u201c\u5f53\u524d\u8fd9\u6b21\u7f16\u8bd1\u201d\u7684\u8f93\u51fa\uff1b\u4f60\u672c\u673a linux/amd64 \u7684 <code>build/</code> \u4e0d\u80fd\u76f4\u63a5\u63a8\u65ad\u624b\u673a android/arm64 \u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u9a8c\u8bc1 fast interpreter/dispatch table \u65f6\u8bf7\u4ee5 \u5bf9\u5e94\u76ee\u6807\u5e73\u53f0\u7684\u6784\u5efa\u4ea7\u7269\u4e3a\u51c6\u3002</p> <p>\u5982\u679c\u4f60\u8981\u201c\u4ece\u73b0\u5b9e\u89d2\u5ea6\u7406\u89e3\u89e3\u91ca\u5668\u201d\uff0c\u5efa\u8bae\u5148\u8bfb\uff1a</p> <ul> <li>Flows/IRTOC_FastInterpreter</li> <li>DataStructures/IRTOC_FastInterpreter</li> </ul>"},{"location":"04_ExecutionEngine/#_4","title":"\u5173\u952e\u4e3b\u6d41\u7a0b\uff08\u5148\u770b\u56fe\u5efa\u7acb\u76f4\u89c9\uff09","text":""},{"location":"04_ExecutionEngine/#1_1","title":"1) \u89e3\u91ca\u5668\u6267\u884c\u4e3b\u5faa\u73af\uff08\u6982\u5ff5\u56fe\uff09","text":"<pre><code>flowchart TD\n  A[\"interpreter::Execute(thread, pc, frame)\"] --&gt; B[\"ExecuteImpl(...)\"]\n  B --&gt; C[\"\u53d6 opcode/\u64cd\u4f5c\u6570\"]\n  C --&gt; D{\"\u662f\u5426\u8d70 fast path\uff1f\\n(\u5185\u8054 handler/\u6a21\u677f)\"}\n  D --&gt;|\u662f| E[\"\u76f4\u63a5\u5728 Frame/VReg/Acc \u4e0a\u8bfb\u5199\\n\u66f4\u65b0 pc\"]\n  D --&gt;|\u5426| F[\"\u8c03\u7528 runtime slow path\\n\u6216\u8d70 Bridge/Entrypoints\"]\n  E --&gt; C\n  F --&gt; C\n  C --&gt; G{\"\u9047\u5230 return/throw/suspend\uff1f\"}\n  G --&gt;|\u662f| R[\"\u8fd4\u56de\u7ed3\u679c\u6216\u4f20\u64ad\u5f02\u5e38\"]\n  G --&gt;|\u5426| C</code></pre>"},{"location":"04_ExecutionEngine/#11","title":"1.1 \u65b0\u4eba\u6700\u5bb9\u6613\u8bef\u89e3\u7684\u70b9\uff1a\u4e3b\u5faa\u73af\u4ee3\u7801\u5230\u5e95\u5728\u54ea\uff1f","text":"<p>\u5728\u6e90\u7801\u6811\u91cc\u4f60\u4f1a\u540c\u65f6\u770b\u5230\uff1a</p> <ul> <li><code>runtime/interpreter/interpreter-inl.h</code>\uff1a\u5927\u91cf opcode \u7684 <code>InstructionHandler::HandleXxx</code> \u8bed\u4e49\u5b9e\u73b0\uff08\u4ee5\u53ca stackless \u8c03\u7528/\u8fd4\u56de/\u627e catch \u7b49 helper\uff09</li> <li><code>runtime/interpreter/interpreter_impl.cpp</code>\uff1a\u89e3\u91ca\u5668\u7c7b\u578b\u9009\u62e9\uff08CPP/IRTOC/LLVM\uff09\u4e0e\u6267\u884c\u5165\u53e3</li> </ul> <p>\u4f46 \u771f\u6b63\u7684\u201cdispatch loop\uff08computed-goto \u8df3\u8868\uff09+ EXCEPTION_HANDLER label\u201d\u662f\u5728\u6784\u5efa\u671f\u751f\u6210\u7684\u5934\u91cc\uff1a</p> <ul> <li>\u751f\u6210\u5934\uff1a<code>interpreter-inl_gen.h</code>\uff08\u7531 <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u751f\u6210\uff09</li> <li>dispatch \u539f\u8bed\uff1a<code>runtime/interpreter/arch/macros.h</code> \u7684 <code>DISPATCH(table, opcode)</code></li> </ul> <p>\u4f60\u5982\u679c\u60f3\u201c\u6700\u5feb\u7406\u89e3\u89e3\u91ca\u5668\u5faa\u73af\u7ed3\u6784\u201d\uff0c\u76f4\u63a5\u5148\u8bfb\u6a21\u677f <code>interpreter-inl_gen.h.erb</code>\uff0c\u518d\u56de\u5934\u8bfb <code>interpreter-inl.h</code> \u7684\u5177\u4f53 handler\u3002</p>"},{"location":"04_ExecutionEngine/#2-i2cc2i","title":"2) I2C/C2I \u6865\u63a5\uff08\u89e3\u91ca\u5668\u2194\u7f16\u8bd1\u4ee3\u7801\u7684\u53cc\u5411\u8df3\u8f6c\uff09","text":"<pre><code>sequenceDiagram\n  participant INT as Interpreter\n  participant M as Method(\u542b entrypoint)\n  participant I2C as I2C Bridge\n  participant CC as Compiled Code\n  participant C2I as C2I Bridge\n\n  INT-&gt;&gt;M: \u8bfb\u53d6 compiled entrypoint\n  alt \u6709 compiled entrypoint\n    INT-&gt;&gt;I2C: InterpreterToCompiledCodeBridge(...)\n    I2C-&gt;&gt;CC: \u8df3\u8f6c\u6267\u884c\n    alt \u53d1\u751f deopt/\u5f02\u5e38/\u56de\u9000\n      CC-&gt;&gt;C2I: CompiledCodeToInterpreterBridge(...)\n      C2I-&gt;&gt;INT: InvokeInterpreter(pc, frame)\n      INT--&gt;&gt;C2I: acc/\u8fd4\u56de\u503c\n      C2I--&gt;&gt;CC: \u8fd4\u56de\u5230 compiled \u8c03\u7528\u70b9\uff08\u6216\u7ee7\u7eed unwind\uff09\n    else \u6b63\u5e38\u8fd4\u56de\n      CC--&gt;&gt;I2C: \u8fd4\u56de\u503c\n      I2C--&gt;&gt;INT: \u5199\u56de acc/\u8fd4\u56de\n    end\n  else \u65e0 compiled entrypoint\n    INT-&gt;&gt;INT: \u7ee7\u7eed\u89e3\u91ca\u6267\u884c\uff08\u6216\u89e6\u53d1\u7f16\u8bd1\uff09\n  end</code></pre>"},{"location":"04_ExecutionEngine/#3-deoptosrstack-walking","title":"3) deopt/OSR/stack walking \u4e09\u8005\u5173\u7cfb\uff08\u6982\u5ff5\u56fe\uff09","text":"<pre><code>flowchart TD\n  A[\"\u8fd0\u884c\u4e2d\uff08\u89e3\u91ca\u5668\u6216 compiled\uff09\"] --&gt; B{\"\u9700\u8981\u6808\u904d\u5386\uff1f\\n(\u8c03\u8bd5/\u5f02\u5e38/Profiler/GC root \u7b49)\"}\n  B --&gt;|\u662f| SW[\"StackWalker\\n\u7edf\u4e00\u904d\u5386 frame\"]\n  B --&gt;|\u5426| C{\"\u9700\u8981\u53bb\u4f18\u5316\uff1f\\n(\u5047\u8bbe\u5931\u6548/\u4fdd\u62a4\u68c0\u67e5/\u5f02\u5e38\u8fb9\u754c)\"}\n  C --&gt;|\u662f| DO[\"Deopt\\n\u6784\u9020\u89e3\u91ca\u5668 frame/\u6062\u590d vregs\"]\n  DO --&gt; INT[\"\u56de\u5230 Interpreter \u6267\u884c\"]\n  C --&gt;|\u5426| D{\"OSR \u89e6\u53d1\uff1f\\n(\u70ed\u5faa\u73af/\u56de\u8fb9)\"}\n  D --&gt;|\u662f| OSR[\"Install/Enter OSR code\"]\n  OSR --&gt; CC[\"\u8fdb\u5165 compiled (OSR)\"]\n  D --&gt;|\u5426| A</code></pre>"},{"location":"04_ExecutionEngine/#_5","title":"\u4e09\u4e2a\u573a\u666f\u7684\u6392\u969c\u51b3\u7b56\u6811\uff08\u4ece\u65e5\u5fd7/\u75c7\u72b6\u5230\u5b9a\u4f4d\u70b9\uff09","text":""},{"location":"04_ExecutionEngine/#a","title":"\u573a\u666f A\uff1a\u89e3\u91ca\u5668\u6267\u884c\u5f02\u5e38/\u8bed\u4e49\u4e0d\u5bf9\uff08\u51b3\u7b56\u6811\uff09","text":"<pre><code>flowchart TD\n  S[\"\u75c7\u72b6\uff1a\u89e3\u91ca\u5668\u6267\u884c\u5931\u8d25/\u8bed\u4e49\u4e0d\u5bf9\\n- \u5d29\u6e83/ASSERT\\n- \u8fd4\u56de\u503c\u4e0d\u5bf9\\n- acc/vreg \u503c\u5f02\u5e38\\n- \u67d0 opcode \u884c\u4e3a\u5f02\u5e38\"] --&gt; A{\"\u95ee\u9898\u53d1\u751f\u5728\u89e3\u91ca\u5668\u5185\u8fd8\u662f\u8c03\u7528\u8fb9\u754c\uff1f\"}\n  A --&gt;|\u5355\u6761 opcode/fastpath| B1[\"\u4f18\u5148\u5b9a\u4f4d opcode handler\\n(\u5927\u591a\u5728 interpreter-inl.h/\u6a21\u677f\u751f\u6210)\"]\n  B1 --&gt; B2[\"\u68c0\u67e5\uff1aFrame/VReg/Acc \u7684\u8bfb\u5199\u662f\u5426\u4e00\u81f4\\n(\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u5206\u652f)\"]\n  B2 --&gt; T1[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/interpreter/*\\n\u63a8\u8350\uff1aFileNotes/interpreter-inl.h\uff08\u6309 opcode \u8ffd\uff09+ DataStructures/Frame_VReg_Acc\"]\n  A --&gt;|\u8c03\u7528/\u8fd4\u56de\u8fb9\u754c| C1[\"\u68c0\u67e5\uff1aInvoke/Return \u7684 acc \u8bed\u4e49\\n\u4ee5\u53ca\u6865\u63a5\u8fd4\u56de\u503c\u5199\u56de\"]\n  C1 --&gt; T2[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/bridge/bridge.cpp\\n\u63a8\u8350\uff1aFlows/Bridge_I2C_C2I.md\"]\n  S --&gt; D{\"\u6d89\u53ca\u5f02\u5e38\uff08throw/catch\uff09\uff1f\"}\n  D --&gt;|\u662f| D1[\"\u68c0\u67e5\uff1a\u5f02\u5e38\u4f20\u64ad\u8def\u5f84\u4e0e frame/unwind\\n\u4ee5\u53ca entrypoints \u662f\u5426\u88ab\u8c03\u7528\"]\n  D1 --&gt; T3[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/entrypoints/entrypoints.cpp\\n+ stack_walker/deopt \u4ea4\u754c\"]</code></pre>"},{"location":"04_ExecutionEngine/#4_1","title":"\u989d\u5916\u8d60\u9001\uff1a\u6267\u884c\u5f15\u64ce\u201c4 \u4e2a\u4e0d\u53d8\u91cf\u201d\uff08\u65b0\u4eba\u6392\u969c\u6700\u7701\u65f6\u95f4\uff09","text":"<ul> <li>acc \u5fc5\u987b\u53ef\u88ab GC \u770b\u89c1\uff1a\u5728\u8c03\u7528 runtime/\u901a\u77e5/safepoint \u524d\uff0c\u5f88\u591a\u8def\u5f84\u4f1a\u5148\u628a acc \u5199\u56de frame\uff08\u5426\u5219 hook/GC \u53ef\u80fd\u628a acc \u5f53\u4f5c\u4e22\u5931 root\uff09\u3002</li> <li>FrameKind/\u8fb9\u754c\u5e27\u5fc5\u987b\u4e00\u81f4\uff1a\u6865\u63a5/StackWalker/deopt/\u5f02\u5e38\u90fd\u4f9d\u8d56\u5b83\uff0c\u9519\u4e86\u5c31\u662f\u201c\u7f3a\u5e27/\u5d29\u6e83/\u8fd4\u56de\u503c\u9519\u201d\u7684\u5927\u6982\u7387\u6839\u56e0\u3002</li> <li>stackless frame \u4f1a\u5728\u89e3\u91ca\u5668\u5185\u81ea\u5df1\u5f39\u6808\uff1a<code>HandleReturnStackless/FindCatchBlockStackless</code> \u4f1a <code>FreeFrame</code> \u5e76\u628a state \u66f4\u65b0\u56de caller\u3002</li> <li>\u5f02\u5e38\u662f\u201c\u4e24\u6bb5\u5f0f\u201d\uff1a\u5148\u5728 stackless IFrames \u91cc\u627e catch\uff0c\u627e\u4e0d\u5230\u518d\u8fdb\u5165 CFrames \u641c\u7d22\u5e76 deopt \u56de\u89e3\u91ca\u5668 catch pc\u3002</li> </ul>"},{"location":"04_ExecutionEngine/#bi2cc2i","title":"\u573a\u666f B\uff1aI2C/C2I \u6865\u63a5\u76f8\u5173\u95ee\u9898\uff08\u51b3\u7b56\u6811\uff09","text":"<p>\u9700\u8981\u5bf9\u7167\u201c\u771f\u5b9e\u6808/ABI/\u5bc4\u5b58\u5668\u4fdd\u5b58/TLS \u66f4\u65b0\u70b9\u201d\u65f6\uff0c\u76f4\u63a5\u8df3\uff1aFlows/Bridge_I2C_C2I \u2192 4.1 arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff08aarch64/amd64\uff0c\u542b dyn\uff09\u3002</p> <pre><code>flowchart TD\n  S[\"\u75c7\u72b6\uff1a\u6865\u63a5\u5931\u8d25\\n- \u8df3\u5230 compiled \u5d29\u6e83\\n- \u4ece compiled \u56de\u89e3\u91ca\u5668\u7ed3\u679c\u4e0d\u5bf9\\n- \u6808/\u8fd4\u56de\u503c/acc \u4e0d\u4e00\u81f4\"] --&gt; A{\"\u95ee\u9898\u70b9\u5728 i2c \u8fd8\u662f c2i\uff1f\"}\n  A --&gt;|\u89e3\u91ca\u5668\u8c03\u7528 compiled\uff08i2c\uff09| B1[\"\u68c0\u67e5\uff1a\u4f20\u53c2 ABI\u3001frame-&gt;SetCurrentFrame\u3001entrypoint \u9009\u62e9\"]\n  B1 --&gt; L1[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/bridge/bridge.h/.cpp\\n(arch/* \u6c47\u7f16\u4e3a\u5b9e\u73b0\u7ec6\u8282)\"]\n  A --&gt;|compiled \u56de\u89e3\u91ca\u5668\uff08c2i\uff09| C1[\"\u68c0\u67e5\uff1aInvokeInterpreter(pc, frame)\\nframe kind \u5207\u6362\u3001acc \u53d6\u56de\u3001FreeFrame\"]\n  C1 --&gt; L2[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/bridge/bridge.cpp::InvokeInterpreter\\n+ runtime/interpreter::Execute\"]\n  S --&gt; D{\"\u662f\u5426\u4e0e deopt/OSR \u540c\u65f6\u51fa\u73b0\uff1f\"}\n  D --&gt;|\u662f| D1[\"\u6865\u63a5\u5e38\u4e0e deopt/osr frame \u91cd\u5efa\u8026\u5408\\n\u68c0\u67e5 deoptimization/osr \u7684 frame \u8fd8\u539f\u89c4\u5219\"]\n  D1 --&gt; L3[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/deoptimization.* + runtime/osr.*\"]</code></pre>"},{"location":"04_ExecutionEngine/#cdeoptosrstack-walking","title":"\u573a\u666f C\uff1adeopt/OSR/stack walking \u95ee\u9898\uff08\u51b3\u7b56\u6811\uff09","text":"<p>\u9047\u5230 \u201cdeopt-after/\u7f3a\u5e27/\u8fb9\u754c\u5e27\u4e0d\u89c1\u4e86\u201d \u65f6\uff0c\u4f18\u5148\u628a <code>thread.currentFrame* / currentFrameIsCompiled / boundary marker</code> \u5bf9\u9f50\uff0c\u518d\u770b <code>runtime/bridge/arch/*/deoptimization_*.S</code>\uff08\u5bf9\u5e94 FileNotes \u5df2\u6302\u5728 Flows/Bridge_I2C_C2I\uff09\u3002</p> <pre><code>flowchart TD\n  S[\"\u75c7\u72b6\uff1adeopt/OSR/\u6808\u904d\u5386\u5f02\u5e38\\n- \u6808\u56de\u6eaf\u4e0d\u5bf9/\u7f3a\u5e27\\n- deopt \u56de\u9000\u540e\u8bed\u4e49\u9519\\n- OSR \u4e0d\u751f\u6548/\u65e0\u6cd5\u5b89\u88c5\\n- \u8c03\u8bd5/Profiler \u770b\u5230\u7684\u5e27\u4e0d\u4e00\u81f4\"] --&gt; A{\"\u4f60\u4e3b\u8981\u770b\u5230\u7684\u75c7\u72b6\u662f\u54ea\u4e00\u7c7b\uff1f\"}\n  A --&gt;|\u6808\u56de\u6eaf/\u7f3a\u5e27| B1[\"\u4f18\u5148\u770b StackWalker \u7684\u904d\u5386\u89c4\u5219\\n(\u89e3\u91ca\u5668\u5e27/\u7f16\u8bd1\u5e27/\u8fb9\u754c\u8bc6\u522b)\"]\n  B1 --&gt; L1[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/include/stack_walker.h + runtime/stack_walker.cpp\"]\n  A --&gt;|deopt \u56de\u9000\u95ee\u9898| C1[\"\u68c0\u67e5\uff1adeoptimization \u6784\u9020\u89e3\u91ca\u5668 frame \u7684\u89c4\u5219\\nvreg/acc/pc \u8fd8\u539f\u4e0e frame kind \u5207\u6362\"]\n  C1 --&gt; L2[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/deoptimization.h/.cpp\\n+ bridge deopt \u5165\u53e3\uff08arch/*.S \u4ec5\u4f5c\u53c2\u8003\uff09\"]\n  A --&gt;|OSR \u4e0d\u751f\u6548| D1[\"\u68c0\u67e5\uff1aTrySetOsrCode/\u5b89\u88c5\u6761\u4ef6\\n\u662f\u5426\u88ab deopt \u6807\u8bb0/entrypoint \u72b6\u6001\u4e0d\u5141\u8bb8\"]\n  D1 --&gt; L3[\"\u7b2c\u4e00\u843d\u70b9\uff1aruntime/osr.h/.cpp + runtime/compiler.*\uff08TrySetOsrCode\uff09\"]</code></pre>"},{"location":"04_ExecutionEngine/#stage2","title":"\u672c\u7ae0\u7684\u201c\u6700\u5c0f\u95ed\u73af\u6587\u4ef6\u96c6\u201d\uff08\u5bf9\u5e94 Stage2 \u9010\u884c\uff09","text":"<p>\u8fd9\u4e9b\u6587\u4ef6\u8bfb\u5b8c\uff0c\u4f60\u5c31\u80fd\u628a\u89e3\u91ca\u5668/\u6865\u63a5/entrypoints/deopt-osr/stackwalker/JIT \u63a5\u53e3\u4e32\u6210\u95ed\u73af\uff1a - \u89e3\u91ca\u5668\uff1a<code>runtime/interpreter/{interpreter.*,interpreter_impl.*,interpreter-inl.h,frame.h,vregister.h,acc_vregister.*}</code> - \u6865\u63a5\uff1a<code>runtime/bridge/{bridge.h,bridge.cpp}</code> - \u8fd0\u884c\u65f6\u5165\u53e3\uff1a<code>runtime/entrypoints/{entrypoints.h,entrypoints.cpp}</code> - JIT \u63a5\u53e3\uff08\u8fd0\u884c\u65f6\u4fa7\uff09\uff1a<code>runtime/{compiler.h,compiler.cpp}</code> + <code>runtime/include/compiler_interface.h</code> - \u53bb\u4f18\u5316/OSR\uff1a<code>runtime/{deoptimization.h,deoptimization.cpp,osr.h,osr.cpp}</code> - \u6808\u904d\u5386\uff1a<code>runtime/include/stack_walker.h</code> + <code>runtime/stack_walker.cpp</code></p>"},{"location":"04_ExecutionEngine/Completion_Review/","title":"04_ExecutionEngine \u7ae0\u8282\u5b8c\u5de5\u5ba1\u67e5\uff08VM \u67b6\u6784\u5e08\u9a8c\u6536\uff09","text":"<p>\u5ba1\u67e5\u76ee\u6807\uff1a\u628a 04 \u7ae0\u4ea4\u4ed8\u4e3a\u201c\u65b0\u4eba\u53ef\u76f4\u63a5\u4e0a\u624b\u6392\u969c + \u67b6\u6784\u65ad\u8a00\u53ef\u8ffd\u6eaf\u5230\u6e90\u7801\u201d\u7684\u7a33\u5b9a\u6587\u6863\u96c6\u3002 \u5ba1\u67e5\u65b9\u6cd5\uff1a\u9010\u6587\u6863\u62bd\u53d6\u5173\u952e\u65ad\u8a00 \u2192 \u56de\u5230\u6e90\u7801/\u6784\u5efa\u89c4\u5219\u6838\u9a8c \u2192 \u53d1\u73b0\u4e0d\u4e00\u81f4\u5219\u5f53\u573a\u4fee\u8865 \u2192 \u7ed9\u51fa\u540e\u7eed\u53ef\u6267\u884c\u4f18\u5316\u9879\u3002</p>"},{"location":"04_ExecutionEngine/Completion_Review/#0-stage1-stage2","title":"0) \u5ba1\u67e5\u8303\u56f4\uff08Stage1 + Stage2\uff09","text":"<ul> <li>Stage1\uff08\u603b\u89c8\uff09\uff1a04_Execution_Engine_Interpreter_JIT_AOT</li> <li>Stage2\uff08\u5165\u53e3/\u5b66\u4e60\u8def\u5f84\uff09\uff1aREADME\u3001Index\u3001Flows/Index\u3001DataStructures/Index</li> <li>Stage2\uff08Flows\uff09\uff1a</li> <li>Flows/ExecutionEngine_EndToEnd</li> <li>Flows/Interpreter_Execute</li> <li>Flows/Bridge_I2C_C2I</li> <li>Flows/Entrypoints_and_RuntimeInterface</li> <li>Flows/Deopt_and_OSR</li> <li>Flows/StackWalking</li> <li>Flows/IRTOC_FastInterpreter</li> <li>Flows/IRTOC_DSL_Primer\u3001Flows/IRTOC_DSL_Reference</li> <li>Stage2\uff08DataStructures\uff09\uff1aDataStructures/Index\uff08Frame/Acc/VReg\u3001Bridge/FrameKind\u3001StackWalker\u3001OSR/Deopt\u3001Entrypoints\u3001IRTOC\u3001ISA\u2026\uff09</li> <li>\u65b0\u4eba\u6392\u969c\u5165\u53e3\uff1aNewbie_MinDebug_Playbook</li> <li>\u9010\u884c\u8bc1\u636e\u94fe\uff1aFileNotes/Index\uff08\u6309 Manifests/files.yaml\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#1","title":"1) \u7ed3\u8bba\u6982\u89c8\uff08\u9a8c\u6536\u7ed3\u8bba\uff09","text":"<ul> <li>\u6b63\u786e\u6027\uff08P0 \u65ad\u8a00\uff09\uff1a\u5df2\u5bf9\u4ee5\u4e0b\u9ad8\u98ce\u9669\u65ad\u8a00\u5b8c\u6210\u6e90\u7801\u6838\u9a8c\uff0c\u7ed3\u8bba \u4e0e\u5f53\u524d\u6587\u6863\u4e00\u81f4\uff1a</li> <li>\u89e3\u91ca\u5668\u9009\u578b/\u964d\u7ea7/\u786c\u9650\u5236\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>\u4e3b\u5faa\u73af/\u5f02\u5e38\u4e24\u6bb5\u5f0f\uff08EXCEPTION_HANDLER\uff09\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code></li> <li>OSR \u89e6\u53d1\u70b9\uff08\u56de\u8fb9/fast interpreter slowpath\uff09\uff1a<code>runtime/interpreter/instruction_handler_base.h</code>\u3001<code>runtime/entrypoints/entrypoints.cpp</code></li> <li>OSR \u67b6\u6784\u5dee\u5f02\uff08\u975e arm64 \u4e3a UNREACHABLE stub\uff09\uff1a<code>runtime/arch/asm_support.cpp</code></li> <li>AOT \u4e24\u6761\u52a0\u8f7d\u5165\u53e3\uff08HandleAotOptions + enable-an/LoadAbcFile\uff09\uff1a<code>runtime/runtime.cpp</code>\u3001<code>runtime/file_manager.cpp</code></li> <li>C2I \u8fb9\u754c\u5e27\uff1acallee-saved \u4fdd\u5b58 + TLS \u5199\u5165\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code></li> <li> <p>IRTOC \u7ba1\u7ebf\uff08.irt\u2192irtoc_code.cpp\u2192Graph\u2192.o/disasm\uff09\uff1a<code>irtoc/lang/irtoc.rb</code>\u3001<code>irtoc/backend/CMakeLists.txt</code>\u3001<code>irtoc/backend/function.cpp</code></p> </li> <li> <p>\u4e00\u81f4\u6027/\u53ef\u8bfb\u6027\uff08\u5df2\u4fee\u8865\uff09\uff1a</p> </li> <li>\u7edf\u4e00\u4e86 \u201c392 dispatch table\u201d \u7684\u89e3\u91ca\u53e3\u5f84\uff08fast interpreter \u7684\u771f\u5b9e\u751f\u6210\u89c4\u5219 vs C++ label table \u7684\u540c\u957f\u5ea6\u5173\u7cfb\uff09\u3002</li> <li> <p>\u79fb\u9664\u4e86\u4e00\u5904\u201c\u82e5\u5df2\u5b58\u5728/\u5426\u5219\u2026\u201d\u7684\u4e0d\u786e\u5b9a\u8868\u8ff0\uff0c\u6539\u4e3a\u76f4\u63a5\u6307\u5411\u5df2\u5b58\u5728\u7684\u8bc1\u636e\u5165\u53e3\u3002</p> </li> <li> <p>\u4ecd\u53ef\u4f18\u5316\uff08\u4e0d\u5f71\u54cd\u6b63\u786e\u6027\uff0c\u4f46\u80fd\u63d0\u5347\u201c\u65b0\u4eba\u53ef\u7528\u6027/\u6392\u969c\u6548\u7387\u201d\uff09\uff1a</p> </li> <li>\u628a\u6587\u6863\u4e2d\u5c11\u91cf\u201c\u53ef\u80fd\u89e6\u53d1/\u53ef\u80fd\u662f\u201d\u7684\u8868\u8ff0\u8fdb\u4e00\u6b65\u6536\u655b\u4e3a \u6761\u4ef6\u77e9\u9635\uff08\u89e6\u53d1\u6761\u4ef6\u2192\u7b2c\u4e00\u843d\u70b9\u2192\u7b2c\u4e8c\u843d\u70b9\u2192\u5fc5\u770b\u65e5\u5fd7\uff09\u3002</li> <li>\u628a Newbie_MinDebug_Playbook \u7684\u5b9e\u9a8c\u6b65\u9aa4\u4e0e\u5404 Flow/Primer \u7684\u951a\u70b9\u505a\u66f4\u7ec6\u7684\u4e92\u94fe\uff08\u201c\u6392\u969c\u2192\u5b66\u4e60\u201d\u95ed\u73af\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#2-p0","title":"2) P0 \u65ad\u8a00\u6838\u9a8c\u6e05\u5355\uff08\u5e26\u6e90\u7801\u8bc1\u636e\u70b9\uff09","text":""},{"location":"04_ExecutionEngine/Completion_Review/#21-cppirtocllvm","title":"2.1 \u89e3\u91ca\u5668\u9009\u578b\uff08cpp/irtoc/llvm\uff09\u4e0e\u964d\u7ea7/\u786c\u9650\u5236","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li>\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4 cpp\uff08\u9664\u975e\u663e\u5f0f\u8bbe\u7f6e\uff09\uff1a<code>GetInterpreterTypeFromRuntimeOptions</code> \u7684 <code>if (!frame-&gt;IsDynamic() || wasSet)</code> \u5206\u652f</li> <li>\u9ed8\u8ba4\u503c\u8bfb\u53d6\u4e0e\u201c\u4ec5\u672a\u663e\u5f0f\u8bbe\u7f6e\u65f6\u964d\u7ea7\u201d\uff1a<code>!wasSet</code> \u4e0b\u7684 <code>#ifndef PANDA_LLVM_INTERPRETER</code> / <code>#ifndef PANDA_WITH_IRTOC</code> / <code>#ifdef ARK_HYBRID</code> \u964d\u7ea7\u903b\u8f91</li> <li><code>--debug-mode=true</code> \u5f3a\u5236 cpp\uff1a<code>ExecuteImpl</code> \u4e2d <code>Runtime::GetCurrent()-&gt;IsDebugMode()</code> \u7684 <code>LOG(FATAL)</code></li> <li>\u975e ARK_HYBRID \u4e0b\u52a8\u6001\u8bed\u8a00 + fast interpreter \u7684 GC \u9650\u5236\uff08\u8981\u6c42 G1_GC\uff09\uff1a<code>ExecuteImpl</code> \u4e2d <code>frame-&gt;IsDynamic()</code> \u5206\u652f</li> <li>ARK_HYBRID \u4e0b\u7ec4\u5408\u9650\u5236\uff08cmc-gc + \u7981\u6b62 llvm\uff09\uff1a<code>ExecuteImpl</code> \u4e2d <code>#ifdef ARK_HYBRID</code> \u4e24\u6bb5\u7ea6\u675f</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#22-dispatch-table-392","title":"2.2 dispatch table \u7684 392\uff08\u6765\u6e90\u4e0e\u540c\u4e00\u6027\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a</li> <li>fast interpreter\uff1a<code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code> \u2192 <code>build/runtime/include/irtoc_interpreter_utils.h</code></li> <li>C++ interpreter\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\u3001<code>runtime/interpreter/templates/isa_constants_gen.h.erb</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li>fast interpreter \u8868\u5927\u5c0f\u6765\u81ea <code>Panda::dispatch_table.handler_names.size() + 1</code>\uff08<code>+1</code> \u5f02\u5e38\u69fd\u4f4d\uff09</li> <li>C++ interpreter \u7684 label table \u957f\u5ea6\u4e3a <code>256 + NUM_PREFIXED + 1</code>\uff08\u540c ISA \u7a7a\u95f4\uff0c\u540c\u957f\u5ea6\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#23-stackless-iframes-cframes-deopt-catch-pc","title":"2.3 \u5f02\u5e38\u201c\u4e24\u6bb5\u5f0f\u201d\uff08stackless IFrames \u2192 CFrames \u2192 deopt \u56de catch pc\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a</li> <li>\u7b2c\u4e00\u6bb5\u5165\u53e3\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u7684 <code>EXCEPTION_HANDLER</code></li> <li>\u7b2c\u4e8c\u6bb5\uff1a<code>runtime/exceptions.cpp::FindCatchBlockInCallStack/FindCatchBlockInCFrames</code>\uff08\u5e76\u5728\u547d\u4e2d\u540e <code>Deoptimize(...)</code>\uff09</li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>EXCEPTION_HANDLER</code> \u5148 <code>handler.FindCatchBlockStackless()</code>\uff0c\u5931\u8d25\u540e\uff08\u7279\u5b9a arch\uff09\u8fdb\u5165 <code>FindCatchBlockInCallStack(thread)</code></li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#24-osrslowpath","title":"2.4 OSR\uff1a\u89e6\u53d1\u70b9\u3001slowpath\u3001\u4ee5\u53ca\u201c\u6700\u540e\u4e00\u5c42\u201d\u7684\u67b6\u6784\u73b0\u5b9e","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a</li> <li>\u89e3\u91ca\u5668\u56de\u8fb9\u89e6\u53d1\uff1a<code>runtime/interpreter/instruction_handler_base.h::InstrumentBranches/UpdateHotnessOSR</code></li> <li>fast interpreter slowpath\uff1a<code>runtime/entrypoints/entrypoints.cpp::CallCompilerSlowPathOSR</code></li> <li>OSR \u8fdb\u5165\uff1a<code>runtime/osr.cpp::OsrEntry/PrepareOsrEntry/SetOsrResult</code></li> <li>\u67b6\u6784\u5dee\u5f02\uff1a<code>runtime/arch/asm_support.cpp</code>\uff08\u975e arm64 \u7684 <code>OsrEntryAfter*</code> \u4e3a <code>UNREACHABLE()</code>\uff09</li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li>\u4ec5\u56de\u8fb9\u89e6\u53d1\uff1a<code>InstrumentBranches</code> \u7684 <code>if (offset &gt; 0) return false</code></li> <li>gating\uff1a<code>frame-&gt;IsDeoptimized()</code> \u6216 <code>!compiler-enable-osr</code> \u4e0d\u5c1d\u8bd5 OSR</li> <li>fake-return\uff1a\u89e6\u53d1 OSR \u540e\u628a inst \u66ff\u6362\u6210 <code>RETURN_VOID</code>\uff08fake buffer\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#25-bridgec2i-callee-saved-tls","title":"2.5 Bridge\uff1aC2I \u8fb9\u754c\u5e27\u7684\u201c\u7269\u7406\u843d\u5730\u201d\uff08callee-saved + TLS\uff09","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code></li> <li>\u6838\u9a8c\u70b9\uff1a</li> <li><code>PUSH_CALLEE_REGS</code> \u4fdd\u5b58 callee-saved\uff08\u5e76\u7ed9\u51fa CFI\uff09</li> <li>\u5728\u53ef\u80fd\u8fdb\u5165 safepoint \u524d\u5199 TLS\uff1a<code>str fp, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code></li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#26-aot-class-context","title":"2.6 AOT\uff1a\u4e24\u6761\u52a0\u8f7d\u5165\u53e3\u4e0e class context \u8bbe\u7f6e","text":"<ul> <li>\u8bc1\u636e\u6e90\uff1a</li> <li>\u542f\u52a8\u671f\uff1a<code>runtime/runtime.cpp::HandleAotOptions</code>\uff08LoadAnFile\uff09</li> <li><code>enable-an</code>\uff1a<code>runtime/file_manager.cpp::LoadAbcFile</code>\uff08TryLoadAnFileForLocation\uff09</li> <li>class context\uff1a<code>runtime/runtime.cpp</code> \u4e2d\u5bf9 <code>AotManager::SetBootClassContext/SetAppClassContext</code> \u7684\u8bbe\u7f6e</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#3","title":"3) \u9010\u6587\u6863\u9a8c\u6536\uff08\u6458\u8981\uff09","text":"<p>\u8bf4\u660e\uff1a\u8fd9\u91cc\u662f\u201c\u4ea4\u4ed8\u9a8c\u6536\u89c6\u89d2\u201d\u7684\u6458\u8981\uff1b\u66f4\u7ec6\u7684\u9010\u884c\u8bc1\u636e\u5728 <code>FileNotes/*</code>\u3002</p>"},{"location":"04_ExecutionEngine/Completion_Review/#31-stage104_execution_engine_interpreter_jit_aot","title":"3.1 Stage1\uff1a04_Execution_Engine_Interpreter_JIT_AOT","text":"<ul> <li>\u6b63\u786e\u6027\uff1aP0 \u65ad\u8a00\uff08\u9009\u578b/\u5f02\u5e38\u4e24\u6bb5\u5f0f/OSR \u67b6\u6784\u5dee\u5f02/AOT \u4e24\u5165\u53e3/\u6865\u63a5 ABI\uff09\u5df2\u80fd\u56de\u5230\u6e90\u7801\u6838\u9a8c\uff1b\u8868\u8ff0\u603b\u4f53\u51c6\u786e\u3002</li> <li>\u5efa\u8bae\u4f18\u5316\uff1a</li> <li>AOT \u6bb5\u5efa\u8bae\u8865\u4e00\u53e5\uff1a<code>HandleAotOptions</code> \u5728 OHOS \u4e0e\u975e OHOS \u7684\u5931\u8d25\u5904\u7406\uff08ERROR vs FATAL\uff09\u4e0d\u540c\uff08\u907f\u514d\u65b0\u4eba\u8bef\u5224\u201c\u4e3a\u4f55\u540c\u914d\u7f6e\u4e0d\u540c\u5e73\u53f0\u884c\u4e3a\u4e0d\u4e00\u81f4\u201d\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#32-stage2-readme-index-flowsindex-datastructuresindex","title":"3.2 Stage2 \u5165\u53e3\uff1aREADME / Index / Flows/Index / DataStructures/Index","text":"<ul> <li>\u6b63\u786e\u6027\uff1a\u5b66\u4e60\u8def\u5f84\u4e0e\u201c\u73b0\u5b9e\u5dee\u5f02\u201d\u53e3\u5f84\u4e0e\u6e90\u7801\u4e00\u81f4\u3002</li> <li>\u5df2\u4f18\u5316\uff1aIRTOC \u7684 primer/reference \u5df2\u5728\u5165\u53e3\u5c42\u663e\u6027\u6302\u51fa\uff0c\u907f\u514d\u65b0\u4eba\u53ea\u8bfb C++ handler\u3002</li> <li>\u5efa\u8bae\u4f18\u5316\uff1a\u5728 Index \u7684 2h/1d \u8def\u7ebf\u4e2d\u589e\u52a0\u201c\u6700\u5c0f\u8dd1\u901a\u5b9e\u9a8c\u201d\uff08\u76f4\u63a5\u590d\u7528 playbook \u7684 3 \u4e2a\u5b9e\u9a8c\u94fe\u63a5\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#33-flows","title":"3.3 Flows\uff08\u8c03\u7528\u94fe\uff09","text":"<ul> <li>ExecutionEngine_EndToEnd\uff1a\u4e3b\u7ebf\u56fe\u4e0e\u5404\u4e0b\u6f5c\u94fe\u63a5\u4e00\u81f4\uff1b\u4f5c\u4e3a\u201c\u552f\u4e00\u810a\u67f1\u5165\u53e3\u201d\u5408\u683c\u3002</li> <li>Interpreter_Execute\uff1a\u6b63\u786e\uff1b\u660e\u786e\u4e3b\u5faa\u73af\u6765\u81ea\u751f\u6210\u6a21\u677f\uff08\u907f\u514d\u9519\u8bfb\uff09\u3002</li> <li>Bridge_I2C_C2I\uff1a\u6b63\u786e\uff1b\u5e76\u63d0\u4f9b arch \u6c47\u7f16\u8bc1\u636e\u94fe\u5165\u53e3\uff08\u5bf9\u6392\u969c\u6781\u6709\u4ef7\u503c\uff09\u3002</li> <li>Entrypoints_and_RuntimeInterface\uff1a\u6b63\u786e\uff1b\u5efa\u8bae\u540e\u7eed\u8865\u4e00\u4e2a\u201centrypoints \u5206\u7c7b\u2192\u5e38\u89c1\u5d29\u6e83 first-contact\u201d\u8868\u683c\uff08\u63d0\u5347\u6392\u969c\u6548\u7387\uff09\u3002</li> <li>Deopt_and_OSR\uff1a\u4e0e\u6e90\u7801\u4e00\u81f4\uff1b\u5bf9\u201c\u975e arm64 stub/UNREACHABLE\u201d\u63d0\u9192\u975e\u5e38\u5173\u952e\uff0c\u5efa\u8bae\u4fdd\u7559\u5728\u6240\u6709 OSR \u5b9e\u9a8c\u5165\u53e3\u5904\uff08\u5df2\u57fa\u672c\u505a\u5230\uff09\u3002</li> <li>StackWalking\uff1a\u6b63\u786e\uff1b\u7a81\u51fa\u5f02\u5e38\u4e24\u6bb5\u5f0f\u4ea4\u754c\uff0c\u65b9\u5411\u5bf9\u3002</li> <li>IRTOC_FastInterpreter / IRTOC_DSL_Primer / IRTOC_DSL_Reference\uff1a\u7ba1\u7ebf\u89e3\u91ca\u4e0e\u8bc1\u636e\u94fe\u9f50\u5168\uff1b\u5c5e\u4e8e\u672c\u7ae0\u6700\u6838\u5fc3\u5185\u5bb9\u4e4b\u4e00\uff0c\u73b0\u5df2\u5177\u5907\u201c\u65b0\u4eba\u53ef\u6539\u53ef\u9a8c\u201d\u7684\u95ed\u73af\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#34-datastructures","title":"3.4 DataStructures\uff08\u7ed3\u6784\u5361\u7247\uff09","text":"<ul> <li>\u603b\u4f53\u8bc4\u4ef7\uff1a\u5361\u7247\u7684\u201c\u4e0d\u53d8\u91cf/\u8c01\u5199\u8c01\u8bfb/\u5e38\u89c1\u5751\u201d\u7ed3\u6784\u6b63\u786e\uff0c\u80fd\u652f\u6491 code review \u4e0e\u65b0\u4eba\u6392\u969c\u3002</li> <li>\u5efa\u8bae\u4f18\u5316\uff1a\u5bf9 Entrypoint_and_MethodDispatch \u5efa\u8bae\u8865\u4e00\u4e2a\u201centrypoint \u72b6\u6001\u673a\uff08interp/compiled/osr\uff09\u201d\u56fe\uff08\u5982\u679c\u8be5\u5361\u7247\u91cc\u8fd8\u672a\u8986\u76d6\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#35-newbie_mindebug_playbook","title":"3.5 \u65b0\u4eba\u6700\u5c0f\u6392\u969c\uff1aNewbie_MinDebug_Playbook","text":"<ul> <li>\u6b63\u786e\u6027\uff1a\u5173\u952e\u65e5\u5fd7/\u9009\u9879/\u5165\u53e3\u4e0e\u6e90\u7801\u4e00\u81f4\u3002</li> <li>\u5df2\u4f18\u5316\uff1a\u7edf\u4e00\u4e86 392 \u7684\u89e3\u91ca\u53e3\u5f84\uff0c\u907f\u514d\u8bef\u5bfc\u3002</li> <li>\u5efa\u8bae\u4f18\u5316\uff1a\u628a\u6bcf\u4e2a\u5b9e\u9a8c\u6b65\u9aa4\u7684\u201c\u9884\u671f\u89c2\u6d4b\u70b9\u201d\u518d\u52a0\u4e00\u5217\u201c\u5931\u8d25\u65f6\u7684\u7b2c\u4e8c\u843d\u70b9\u201d\uff08\u6bd4\u5982\u76f4\u63a5\u6307\u5411 <code>interpreter_impl.cpp</code> \u7684\u5177\u4f53 <code>LOG(FATAL)</code> \u8bed\u53e5\u7c7b\u522b\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Completion_Review/#4","title":"4) \u540e\u7eed\u53ef\u6267\u884c\u4f18\u5316\u6e05\u5355\uff08\u4e0d\u6539\u53d8\u4e8b\u5b9e\uff0c\u53ea\u63d0\u5347\u4ea4\u4ed8\u8d28\u91cf\uff09","text":"<ul> <li>\u628a\u201c\u53ef\u80fd\u89e6\u53d1\u201d\u6536\u655b\u4e3a\u6761\u4ef6\u77e9\u9635\uff1a\u4f18\u5148\u6539\u4ee5\u4e0b\u51e0\u5904\u7684\u8868\u8ff0\u98ce\u683c\uff1a</li> <li>entrypoints \u5f02\u5e38\u8fb9\u754c\u3001deopt-after\u3001stackwalking \u7684\u4ea4\u754c\u63cf\u8ff0</li> <li>\u8865 1 \u5f20 entrypoint/dispatch \u72b6\u6001\u673a\u56fe\uff1a\u5e2e\u52a9\u65b0\u4eba\u7406\u89e3\u201cMethod \u7684\u5165\u53e3\u4e3a\u4ec0\u4e48\u4f1a\u53d8\u201d</li> <li>\u628a playbook \u7684\u5b9e\u9a8c\u4e0e Flow/Primer \u505a\u951a\u70b9\u4e92\u94fe\uff1a\u5f62\u6210\u201c\u6392\u969c\u2192\u7406\u89e3\u2192\u6539\u52a8\u2192\u9a8c\u8bc1\u201d\u7684\u95ed\u73af\u5bfc\u822a</li> </ul>"},{"location":"04_ExecutionEngine/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"04_ExecutionEngine/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>[EE-04-001] <code>ExecuteImpl</code> \u7684\u771f\u5b9e\u5b9e\u73b0\u6765\u81ea\u751f\u6210\u5934 <code>interpreter-inl_gen.h</code>\uff0c\u800c\u4e0d\u662f\u5199\u5728 <code>interpreter-inl.h</code> \u4e2d</li> <li>\u539f Stage1 \u8868\u8ff0\u95ee\u9898\uff1a\u53ea\u63d0\u5230 \u201cdispatch \u5927\u91cf\u5728 <code>interpreter-inl.h</code>\u201d\uff0c\u5bb9\u6613\u8ba9\u8bfb\u8005\u8bef\u4ee5\u4e3a <code>ExecuteImpl/ExecuteImplDebug</code> \u4e3b\u5faa\u73af\u4e5f\u5728\u8be5\u6587\u4ef6\u5185\u3002</li> <li>\u4e8b\u5b9e/\u4f9d\u636e\uff1a<ul> <li><code>runtime/interpreter/interpreter_impl.cpp</code> \u660e\u786e <code>#include \"interpreter-inl_gen.h\"</code>\uff08\u89c1\u6587\u4ef6\u9876\u90e8 include \u6bb5\uff09\u3002</li> <li>\u6e90\u7801\u6811\u4e2d\u5bf9\u5e94\u6a21\u677f\u4e3a <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\uff1a\u751f\u6210 <code>ExecuteImpl/ExecuteImplDebug</code>\u3001dispatch table\u3001<code>EXCEPTION_HANDLER</code> \u7b49 label\u3002</li> <li><code>runtime/interpreter/arch/macros.h</code> \u63d0\u4f9b <code>DISPATCH(table, opcode)</code> computed-goto \u5b8f\uff08<code>goto*</code>\uff09\uff0c\u751f\u6210\u7684\u4e3b\u5faa\u73af\u56f4\u7ed5\u8be5\u5b8f\u7ec4\u7ec7\u3002</li> </ul> </li> <li> <p>\u56de\u5199\u52a8\u4f5c\uff1a\u5728 Stage1 \u7684 \u201c2.1 \u6700\u5c0f\u8c03\u7528\u94fe\u201d \u589e\u8865 \u201c\u751f\u6210\u6587\u4ef6/\u6a21\u677f\u94fe\u201d \u7684\u5b9a\u4f4d\u8bf4\u660e\uff0c\u5e76\u628a <code>interpreter-inl.h</code> \u7684\u89d2\u8272\u6539\u5199\u4e3a\u201chandlers \u5b9e\u73b0\u201d\u3002</p> </li> <li> <p>[EE-04-002] \u5f02\u5e38\u5904\u7406\u5728\u89e3\u91ca\u5668\u4fa7\u662f\u201c\u4e24\u6bb5\u5f0f\u201d\uff1astackless IFrames \u2192\uff08\u5fc5\u8981\u65f6\uff09CFrames</p> </li> <li>\u4e8b\u5b9e/\u4f9d\u636e\uff1a<ul> <li><code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u7684 <code>EXCEPTION_HANDLER</code> \u5148\u8c03\u7528 <code>handler.FindCatchBlockStackless()</code>\u3002</li> <li>\u82e5\u8fd4\u56de <code>INVALID_OFFSET</code>\uff0c\u5219\u5728 AARCH64/AARCH32/X86_64 \u4e0a <code>return FindCatchBlockInCallStack(thread)</code>\u3002</li> <li><code>runtime/exceptions.cpp</code> \u5b9e\u73b0 <code>FindCatchBlockInCallStack/FindCatchBlockInCFrames</code>\uff0c\u5e76\u5728 CFrames \u627e\u5230 catch \u540e\u8c03\u7528 <code>Deoptimize(stack, method-&gt;GetInstructions()+pcOffset)</code> \u56de\u5230\u89e3\u91ca\u5668 catch pc\u3002</li> </ul> </li> <li>\u56de\u5199\u52a8\u4f5c\uff1a\u5728 Stage1 \u7684\u5f02\u5e38/throw \u76f8\u5173\u6bb5\u843d\u8865\u5145\u8fd9\u6761\u94fe\u8def\u4e0e\u5173\u952e\u951a\u70b9\u6587\u4ef6\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Index/","title":"04_ExecutionEngine - Index","text":""},{"location":"04_ExecutionEngine/Index/#index","title":"\u8fd9\u4efd Index \u7684\u7528\u6cd5\uff08\u9762\u5411\u65b0\u540c\u5b66\uff09","text":"<p>\u628a\u5b83\u5f53\u201c\u5b66\u4e60\u8def\u7ebf\u56fe\u201d\u7528\uff1a - 30 \u5206\u949f\uff1a\u5efa\u7acb\u6267\u884c\u5f15\u64ce\u6574\u4f53\u6a21\u578b\uff08\u770b\u56fe\u4e3a\u4e3b\uff09 - 2 \u5c0f\u65f6\uff1a\u80fd\u5b9a\u4f4d\u5e38\u89c1\u95ee\u9898\uff08\u6309\u573a\u666f\u9009\u8bfb\uff09 - 1 \u5929\uff1a\u80fd\u8bfb\u61c2\u5b9e\u73b0\u5e76\u6539\u4ee3\u7801\uff08\u4e0b\u6f5c\u9010\u884c\uff09</p> <p>\u5efa\u8bae\u540c\u65f6\u6253\u5f00\uff1a - README\uff08\u4e3b\u7ebf\u56fe + 3 \u573a\u666f\u6392\u969c\u6811\uff09 - FileNotes/_Glossary\uff08\u672f\u8bed\u901f\u67e5\uff09 - Newbie_MinDebug_Playbook\uff08\u65b0\u4eba\u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff1a\u786e\u8ba4 interpreter-type/fast interpreter/bridge/OSR\uff09</p>"},{"location":"04_ExecutionEngine/Index/#30min","title":"30min \u8def\u7ebf\uff1a\u5efa\u7acb\u6574\u4f53\u6a21\u578b\uff08\u4e0d\u8bfb\u9010\u884c\uff09","text":"<ol> <li>Flows/ExecutionEngine_EndToEnd\uff08\u7aef\u5230\u7aef\u810a\u67f1\u56fe\uff1a\u5148\u628a\u6574\u6761\u94fe\u8def\u4e32\u8d77\u6765\uff09</li> <li>README\uff083 \u573a\u666f\u6392\u969c\u6811 + \u5173\u952e\u73b0\u5b9e\u5dee\u5f02\uff09</li> <li>Flows/Index\uff08\u77e5\u9053\u6709\u54ea\u4e9b\u4e3b\u8c03\u7528\u94fe\uff0c\u6bcf\u6761\u94fe\u8def\u7684\u5165\u53e3/\u51fa\u53e3\uff09</li> <li>DataStructures/Index\uff08Frame/VReg/Acc/Entrypoint/StackWalker/Deopt/OSR \u7684\u5361\u7247\uff09</li> <li>\uff08\u771f\u5b9e\u573a\u666f\u8865\u5145\uff09Flows/IRTOC_FastInterpreter + DataStructures/IRTOC_FastInterpreter\uff08\u7406\u89e3\u9ed8\u8ba4\u7684 llvm/irtoc fast interpreter\uff09</li> <li>\u5982\u679c\u4f60\u9700\u8981\u201c\u771f\u6b63\u6539 <code>.irt</code>\u201d\uff1aFlows/IRTOC_DSL_Primer\uff08\u5168\u94fe\u8def\u5206\u5de5 + \u600e\u4e48\u6539/\u600e\u4e48\u9a8c\uff09</li> <li>\u60f3\u66f4\u7cfb\u7edf\u5b66 DSL\uff1aFlows/IRTOC_DSL_Reference\uff08\u67e5\u624b\u518c\u5f0f\u53c2\u8003\uff09</li> <li>\uff08\u65b0\u4eba\u5f3a\u70c8\u5efa\u8bae\uff09Flows/Opcode_DeepDives_IRTOC + DataStructures/ISA_and_OpcodeModel\uff08\u4ece\u5e38\u7528 opcode \u5efa\u7acb\u76f4\u89c9\uff09</li> </ol>"},{"location":"04_ExecutionEngine/Index/#2h","title":"2h \u8def\u7ebf\uff1a\u6309\u4f60\u9047\u5230\u7684\u95ee\u9898\u9009\u8bfb","text":""},{"location":"04_ExecutionEngine/Index/#a","title":"\u573a\u666f A\uff1a\u89e3\u91ca\u5668\u6267\u884c\u5f02\u5e38/\u8bed\u4e49\u4e0d\u5bf9","text":"<ul> <li>Flows/Interpreter_Execute\uff08\u89e3\u91ca\u5668\u6267\u884c\u4e3b\u94fe\u8def\uff1aPC/Frame/Acc/VReg \u8bfb\u5199\u70b9\uff09</li> <li>DataStructures/Frame_VReg_Acc\uff08Frame/VReg/Acc \u7684\u8bed\u4e49\u4e0e\u4e0d\u53d8\u91cf\uff09</li> <li>\u82e5\u4f60\u8dd1\u7684\u662f\u9ed8\u8ba4\u914d\u7f6e\uff08llvm\uff09\uff1aFlows/IRTOC_FastInterpreter\uff08\u786e\u8ba4\u5b9e\u9645\u6267\u884c\u8def\u5f84/dispatch table/handler \u6765\u6e90\uff09</li> <li>\u9010\u884c\u8bc1\u636e\u5165\u53e3\uff1aFileNotes/Index\uff08\u9700\u8981\u65f6\u518d\u4e0b\u6f5c\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Index/#bi2cc2i","title":"\u573a\u666f B\uff1aI2C/C2I \u6865\u63a5\u76f8\u5173\u95ee\u9898","text":"<ul> <li>Flows/Bridge_I2C_C2I\uff08\u6865\u63a5\u7684\u5165\u53e3\u3001frame kind \u5207\u6362\u3001\u8fd4\u56de\u503c\u8bed\u4e49\uff09</li> <li>FileNotes/runtime_bridge_bridge.cpp\uff08InvokeInterpreter \u4e0e\u6865\u63a5\u9aa8\u67b6\uff09</li> <li>\uff08\u9700\u8981\u201c\u843d\u5230\u6808/ABI/\u5bc4\u5b58\u5668\u201d\u7684\u8bc1\u636e\u65f6\uff09\u89c1 Flows/Bridge_I2C_C2I \u7684 4.1 arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff1a</li> <li>aarch64/amd64\uff1aI2C/C2I/proxy/deopt\uff08\u542b dyn \u7248\u672c\u5165\u53e3\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Index/#cdeoptosrstack-walking","title":"\u573a\u666f C\uff1adeopt/OSR/stack walking","text":"<ul> <li>Flows/Deopt_and_OSR\uff08deopt/OSR \u4e0e\u6865\u63a5/\u89e3\u91ca\u5668\u7684\u5173\u7cfb\uff09</li> <li>FileNotes/runtime_deoptimization.cpp\u3001FileNotes/runtime_osr.cpp</li> <li>FileNotes/runtime_include_stack_walker.h\u3001FileNotes/runtime_stack_walker.cpp</li> <li>\uff08deopt-after \u7684\u6700\u7ec8\u843d\u5730\uff09<code>runtime/bridge/arch/*/deoptimization_*.S</code>\uff08\u5bf9\u5e94 FileNotes \u5df2\u6302\u5728 Flows/Bridge_I2C_C2I \u7684 4.1\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Index/#dentrypointscompiled-code","title":"\u573a\u666f D\uff1a\u7f16\u8bd1\u5668\u63a5\u53e3/entrypoints\uff08compiled code \u7684\u6162\u8def\u5f84\uff09","text":"<ul> <li>Flows/Entrypoints_and_RuntimeInterface</li> <li>FileNotes/runtime_entrypoints_entrypoints.cpp</li> <li>FileNotes/runtime_compiler.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Index/#_1","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 Manifests/files.yaml\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 Manifests/tree_inventory.txt\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/","title":"04_ExecutionEngine\uff1a\u65b0\u4eba\u6700\u5c0f\u8c03\u8bd5\u624b\u518c\uff085 \u5206\u949f\u786e\u8ba4\u201c\u4f60\u5230\u5e95\u8dd1\u7684\u662f\u4ec0\u4e48\u201d\uff09","text":"<p>\u76ee\u6807\uff1a\u65b0\u540c\u5b66\u4e0d\u9700\u8981\u8bfb\u5b8c\u5b9e\u73b0\uff0c\u5c31\u80fd\u5feb\u901f\u786e\u8ba4 \u89e3\u91ca\u5668\u7c7b\u578b/fast interpreter \u662f\u5426\u751f\u6548/\u6865\u63a5\u4e0e\u8fb9\u754c\u5e27\u662f\u5426\u4e00\u81f4\uff0c\u5e76\u77e5\u9053\u9047\u5230\u95ee\u9898\u7b2c\u4e00\u843d\u70b9\u5728\u54ea\u3002</p>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#0","title":"0) \u4f60\u53ef\u4ee5\u5148\u8df3\u5230\u8fd9\u91cc","text":"<ul> <li>\u53ea\u60f3\u786e\u8ba4 interpreter-type\uff1a\u770b 1)</li> <li>\u53ea\u60f3\u786e\u8ba4 fast interpreter \u662f\u5426\u751f\u6548\uff08\u6700\u7701\u65f6\u95f4\uff09\uff1a\u770b 2)</li> <li>\u53ea\u60f3\u786e\u8ba4 dispatch table/392\uff1a\u770b 3)</li> <li>\u5d29\u5728\u6865\u63a5/\u7f3a\u5e27/\u5f02\u5e38\u8de8\u8fb9\u754c\uff1a\u770b 4)</li> <li>OSR/deopt-after \u5f02\u5e38\u6216\u4e0d\u89e6\u53d1\uff1a\u770b 5)</li> <li>\u770b\u61c2\u5f02\u5e38\u201c\u4e24\u6bb5\u5f0f\u201d\u5230\u5e95\u54ea\u4e24\u6bb5\uff1a\u770b 6)</li> <li>\u60f3\u8981\u53ef\u590d\u73b0\u5b9e\u9a8c\uff08\u628a\u73b0\u8c61\u201c\u505a\u51fa\u6765\u201d\uff09\uff1a\u770b 7)</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#1-cpp-irtoc-llvm","title":"1) \u5148\u786e\u8ba4\uff1a\u6211\u73b0\u5728\u5230\u5e95\u8dd1\u7684\u662f cpp / irtoc / llvm\uff1f","text":"<ul> <li>\u770b\u542f\u52a8\u53c2\u6570\uff1a\u662f\u5426\u663e\u5f0f\u4f20\u4e86 <code>--interpreter-type={cpp|irtoc|llvm}</code></li> <li>\u9ed8\u8ba4\u503c\u5728 <code>runtime/options.yaml</code>\uff1a<code>interpreter-type</code> \u9ed8\u8ba4 <code>llvm</code></li> <li>\u4f46 \u52a8\u6001\u8bed\u8a00\u6709\u7279\u4f8b\uff1a\u5982\u679c\u4f60\u6ca1\u6709\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code>\uff0cdynamic frame \u4f1a\u5f3a\u5236\u8d70 cpp\uff08\u6e90\u7801\u786c\u7f16\u7801\uff09</li> <li>\u770b\u6700\u7ec8\u771f\u76f8\uff08\u6e90\u7801\u5165\u53e3\uff09\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li><code>GetInterpreterTypeFromRuntimeOptions(Frame *frame)</code></li> <li><code>ExecuteImpl(...)</code>\uff08\u4f1a\u505a debug-mode/GC/hybrid \u7684\u786c\u9650\u5236\uff09</li> </ul> <p>\u63a8\u8350\u5165\u53e3\u6587\u6863\uff1aFlows/IRTOC_FastInterpreter \u7684 4.1 \u89e3\u91ca\u5668\u9009\u578b\u7cbe\u786e\u89c4\u5219\uff08\u5df2\u6309\u6e90\u7801\u53ef\u590d\u6838\uff09\u3002</p>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#11-6","title":"1.1 \u5224\u5b9a\u77e9\u9635\uff08\u6700\u5e38\u89c1\u7684 6 \u4e2a\u7ed3\u8bba\uff09","text":"<ul> <li>\u52a8\u6001\u8bed\u8a00 + \u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u2192 \u5f3a\u5236 cpp\uff08\u5373\u4f7f options \u9ed8\u8ba4\u503c\u662f llvm\uff09</li> <li>\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type=llvm</code> \u4f46\u6784\u5efa\u672a\u542f\u7528 LLVM interpreter \u2192 \u76f4\u63a5 FATAL\uff08\u4e0d\u662f\u964d\u7ea7\uff09</li> <li>\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type=irtoc</code> \u4f46\u6784\u5efa\u672a\u542f\u7528 IRTOC \u2192 \u76f4\u63a5 FATAL\uff08\u4e0d\u662f\u964d\u7ea7\uff09</li> <li>\u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u4e14\u6784\u5efa\u4e0d\u652f\u6301 LLVM \u2192 \u9ed8\u8ba4 <code>llvm</code> \u4f1a \u964d\u7ea7\u5230 irtoc</li> <li>\u672a\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u4e14\u6784\u5efa\u4e0d\u652f\u6301 IRTOC \u2192 \u4f1a\u7ee7\u7eed \u964d\u7ea7\u5230 cpp</li> <li><code>--debug-mode=true</code> \u4e14\u9009\u62e9 irtoc/llvm \u2192 \u76f4\u63a5 FATAL\uff08debug-mode \u53ea\u652f\u6301 cpp\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#2-fast-interpreter","title":"2) \u7528\u65e5\u5fd7\u786e\u8ba4 fast interpreter \u662f\u5426\u771f\u7684\u542f\u7528\u4e86\uff08\u6700\u5feb\u7684\u65b9\u6cd5\uff09","text":"<p>\u5f53\u9009\u578b\u4e3a <code>irtoc/llvm</code> \u65f6\uff0c<code>runtime/interpreter/interpreter_impl.cpp::ExecuteImplType</code> \u4f1a\u6253\u51fa\uff1a</p> <ul> <li><code>Setting up Irtoc dispatch table</code></li> <li><code>Setting up LLVM Irtoc dispatch table</code></li> </ul> <p>\u8981\u770b\u5230\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u4f60\u9700\u8981\u6253\u5f00 logger\uff08\u6ce8\u610f\uff1aruntime/options.yaml \u91cc\u7684 log \u9009\u9879\u5df2 deprecated\uff09\uff1a</p> <ul> <li>logger \u9009\u9879\u5b9a\u4e49\uff1a<code>libarkbase/utils/logger_options.yaml</code></li> <li>\u5e38\u7528\u7ec4\u5408\uff1a</li> <li><code>--log-level=debug</code></li> <li><code>--log-components=runtime:interpreter</code></li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#21","title":"2.1 \u5e38\u7528\u201c\u6392\u969c\u65e5\u5fd7\u7ec4\u5408\u201d\uff08\u5efa\u8bae\u6536\u85cf\uff09","text":"<ul> <li>\u53ea\u770b\u89e3\u91ca\u5668/\u6865\u63a5\uff1a<code>--log-level=debug --log-components=runtime:interpreter:interop</code></li> <li>\u518d\u52a0\u4e0a\u7f16\u8bd1\u5668\uff08JIT/OSR\uff09\uff1a<code>--log-level=debug --log-components=runtime:interpreter:compiler:interop</code></li> <li>\u60f3\u770b LLVM \u4fa7\u7ec4\u4ef6\uff08\u5982\u679c\u542f\u7528\uff09\uff1a<code>--log-level=debug --log-components=runtime:interpreter:llvm</code></li> </ul> <p>\u5c0f\u6280\u5de7\uff1a\u5982\u679c\u4f60\u6000\u7591\u201c\u65e5\u5fd7\u5f00\u4e86\u4f46\u6ca1\u6253\u5370\u201d\uff0c\u5148\u786e\u8ba4\u4f60\u7528\u7684\u662f <code>logger::Options</code>\uff08<code>libarkbase/utils/logger_options.yaml</code>\uff09\uff0c\u800c\u4e0d\u662f runtime/options \u91cc\u5df2 deprecated \u7684\u9879\u3002</p>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#3-dispatch-table-392","title":"3) dispatch table \u4ece\u54ea\u91cc\u6765\uff1f\u4e3a\u4ec0\u4e48\u662f 392\uff1f","text":"<ul> <li>dispatch table \u7684\u5b9a\u4e49\u4e0e\u521d\u59cb\u5316\uff08build \u4ea7\u7269\uff0c\u672c\u673a\u8bc1\u636e\uff09\uff1a<code>build/runtime/include/irtoc_interpreter_utils.h</code></li> <li><code>SetupDispatchTableImpl()</code>\uff08IRTOC\uff09</li> <li><code>SetupLLVMDispatchTableImpl()</code>\uff08LLVM\uff09</li> <li><code>std::array&lt;void (*)(), 392&gt;</code>\uff1a392 \u7684\u201c\u771f\u5b9e\u751f\u6210\u89c4\u5219\u201d\u6765\u81ea\u6a21\u677f <code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code>\uff1a<ul> <li><code>392 = Panda::dispatch_table.handler_names.size() + 1</code>\uff08<code>+1</code> \u662f <code>HANDLE_FAST_EXCEPTION(_LLVM)</code> \u69fd\u4f4d\uff09</li> </ul> </li> <li>\u540c\u65f6\u5b83\u4e0e C++ interpreter \u7684 label dispatch table \u540c\u957f\u5ea6\u3001\u540c ISA \u7a7a\u95f4\uff08\u4fbf\u4e8e\u4f60\u5fc3\u91cc\u5bf9\u9f50 opcode \u7a7a\u95f4\uff09\uff1a<ul> <li><code>392 = 256 + NUM_PREFIXED + 1</code>\uff08\u89c1 <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u4e0e <code>isa_constants_gen.h.erb</code>\uff0c<code>+1</code> \u4e3a <code>EXCEPTION_HANDLER</code> \u69fd\uff09</li> </ul> </li> <li>\u751f\u6210\u94fe\u603b\u89c8\uff08\u811a\u672c\u2192\u673a\u5668\u7801\uff09\uff1aFlows/IRTOC_FastInterpreter</li> <li><code>irtoc/scripts/interpreter.irt \u2192 build/irtoc/.../interpreter.irt.fixed \u2192 irtoc_code.cpp \u2192 disasm.txt</code></li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#31","title":"3.1 \u4f60\u5e94\u8be5\u5982\u4f55\u201c\u8bc1\u660e\u81ea\u5df1\u770b\u7684\u662f\u751f\u4ea7\u8def\u5f84\u201d","text":"<p>\u65b0\u540c\u5b66\u6700\u5e38\u72af\u7684\u9519\u662f\uff1a\u201c\u6211\u6539\u4e86 C++ handler\uff0c\u4f46\u8fd0\u884c\u6ca1\u53d8\u5316\u201d\u3002\u6700\u77ed\u81ea\u68c0\uff1a</p> <ul> <li>\u5982\u679c\u4f60\u770b\u5230 <code>Setting up * dispatch table</code>\uff1a\u8bf4\u660e\u4f60\u5927\u6982\u7387\u8d70\u7684\u662f fast interpreter\uff08irtoc/llvm\uff09</li> <li>\u5982\u679c\u4f60\u6ca1\u770b\u5230\uff0c\u4f46\u4f60\u4ee5\u4e3a\u81ea\u5df1\u8d70 fast interpreter\uff1a</li> <li>\u68c0\u67e5\u662f\u5426\u5176\u5b9e\u5728\u8dd1 \u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4 cpp\uff08\u89c1 1.1 \u7b2c\u4e00\u6761\uff09</li> <li>\u6216\u8005\u6784\u5efa\u4e0d\u652f\u6301 fast interpreter \u5bfc\u81f4\u4f60\u88ab\u8feb\u8d70 cpp\uff08\u89c1 1.1 \u7684 FATAL/\u964d\u7ea7\u89c4\u5219\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#4","title":"4) \u6865\u63a5/\u7f3a\u5e27/\u5f02\u5e38\u8de8\u8fb9\u754c\uff1a\u6700\u5c0f\u6392\u969c\u6cd5","text":""},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#41","title":"4.1 \u5148\u5bf9\u9f50\u201c\u4e09\u4ef6\u4e8b\u201d\uff08\u5426\u5219\u5fc5\u5b9a\u7f3a\u5e27/\u9519\u5e27\uff09","text":"<ul> <li><code>thread.currentFrame*</code></li> <li><code>thread.currentFrameIsCompiled</code></li> <li>\u673a\u5668\u6808\u4e0a\u7684 boundary marker\uff08<code>*_BRIDGE</code> \u5e38\u91cf\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#42","title":"4.2 \u4e00\u952e\u4e0b\u6f5c\u5230\u201c\u6c47\u7f16\u8bc1\u636e\u94fe\u201d","text":"<p>\u76f4\u63a5\u8df3\uff1aFlows/Bridge_I2C_C2I \u2192 4.1 arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff08aarch64/amd64\uff0c\u542b dyn\uff09 \u91cc\u9762\u628a I2C/C2I/proxy/deopt \u7684\u6e90\u7801\u8def\u5f84\u548c\u5bf9\u5e94 FileNotes \u90fd\u5217\u597d\u4e86\u3002</p>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#43","title":"4.3 \u75c7\u72b6 \u2192 \u7b2c\u4e00\u843d\u70b9 \u2192 \u7b2c\u4e8c\u843d\u70b9\uff08\u65b0\u4eba\u6700\u5feb\u8def\u7ebf\uff09","text":"\u4f60\u770b\u5230\u7684\u73b0\u8c61 \u7b2c\u4e00\u843d\u70b9\uff08\u4f18\u5148\u770b\uff09 \u7b2c\u4e8c\u843d\u70b9\uff08\u9700\u8981\u786c\u8bc1\u636e\u65f6\uff09 \u8df3\u5230 compiled \u5c31\u5d29 <code>runtime/bridge/bridge.cpp</code>\uff08Invoke/Return \u8bed\u4e49\u3001frame \u5207\u6362\uff09 Flows/Bridge_I2C_C2I \u7684 arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff08I2C/proxy\uff09 \u4ece compiled \u56de\u89e3\u91ca\u5668\u540e\u8fd4\u56de\u503c/acc \u4e0d\u5bf9 <code>runtime/bridge/bridge.cpp</code> + <code>runtime/interpreter/*</code>\uff08acc \u5199\u56de\u70b9\uff09 <code>runtime/bridge/arch/*/compiled_code_to_interpreter_bridge_*.S</code>\uff08C2I \u5199\u56de/FreeFrame\uff09 \u7f3a\u5e27/\u6808\u904d\u5386\u5d29 <code>runtime/stack_walker.cpp</code>\uff08boundary frame \u8bc6\u522b\uff09 Bridge_ABI_and_FrameKind\uff08DataStructure\uff09 + arch \u6c47\u7f16\uff08TLS/callee-saved\uff09 native \u5f02\u5e38\u65e0\u6cd5\u6b63\u786e\u629b\u51fa/\u88ab\u541e <code>runtime/exceptions.cpp</code>\uff08HandlePendingException/FindCatchBlockInCFrames\uff09 <code>runtime/bridge/arch/*/proxy_entrypoint_*.S</code>\uff08ThrowNativeExceptionBridge \u8df3\u8f6c\uff09"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#5-osr-deopt-after","title":"5) OSR \u4e0d\u751f\u6548 / deopt-after \u5f02\u5e38\uff1a\u7b2c\u4e00\u843d\u70b9","text":"<ul> <li>\u89e3\u91ca\u5668\u56de\u8fb9\u89e6\u53d1\u70b9\uff1a<code>runtime/interpreter/instruction_handler_base.h</code></li> <li><code>InstrumentBranches(int32_t offset)</code>\uff1a\u53ea\u5bf9 back-edge\uff08<code>offset &lt;= 0</code>\uff09\u89e6\u53d1 safepoint/OSR</li> <li><code>UpdateHotnessOSR(...)</code>\uff1a<code>frame-&gt;IsDeoptimized()</code> / <code>compiler-enable-osr</code> gating</li> <li>\u89e6\u53d1\u6210\u529f\u540e\u7684 fake-return\uff1a\u4f2a\u9020 <code>RETURN_VOID</code> \u8ba9\u4e3b\u5faa\u73af\u5b89\u5168\u9000\u51fa\u5e76\u8fdb\u5165 OSR \u5165\u53e3\u8def\u5f84</li> <li>fast interpreter \u7684 OSR entrypoint\uff1a<code>runtime/entrypoints/entrypoints.cpp::CallCompilerSlowPathOSR</code></li> <li>\u6587\u6863\u5165\u53e3\uff1aFlows/Deopt_and_OSR</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#51-osr","title":"5.1 \u8ba9 OSR \u66f4\u201c\u5bb9\u6613\u53d1\u751f\u201d\u7684\u4e09\u4e2a\u53c2\u6570\uff08\u8c03\u8bd5\u4e13\u7528\uff09","text":"<p>\u76ee\u7684\uff1a\u8ba9\u4f60\u5728\u672c\u5730\u66f4\u5bb9\u6613\u628a OSR \u8def\u5f84\u8dd1\u51fa\u6765\uff08\u4e0d\u662f\u6027\u80fd\u5efa\u8bae\uff09\u3002</p> <ul> <li> <p>\u26a0\ufe0f \u5148\u786e\u8ba4\u67b6\u6784\u662f\u5426\u652f\u6301\uff1a\u5f53\u524d\u6e90\u7801\u91cc OSR \u7684 <code>OsrEntryAfter*</code> \u771f\u5b9e\u843d\u5730\u4e3b\u8981\u5728 arm64\uff08\u89c1 Flows/Deopt_and_OSR \u7684 4.3 \u67b6\u6784\u7ea6\u675f\uff09\uff1b\u5728\u975e arm64 \u4e0a\u8fd9\u4e9b\u5165\u53e3\u53ef\u80fd\u662f <code>UNREACHABLE()</code> stub\uff0c\u4f60\u4f1a\u201c\u600e\u4e48\u8c03\u90fd\u8dd1\u4e0d\u51fa\u6765\u201d\u3002</p> </li> <li> <p><code>--compiler-enable-jit=true</code></p> </li> <li><code>--compiler-hotness-threshold=1</code>\uff08\u66f4\u5feb\u89e6\u53d1\u7f16\u8bd1\u8bf7\u6c42\uff09</li> <li><code>--compiler-enable-osr=true</code></li> </ul> <p>\u5982\u679c\u4f60\u5e0c\u671b\u201c\u66f4\u53ef\u91cd\u590d\u201d\uff08\u964d\u4f4e\u5f02\u6b65\u7f16\u8bd1\u5e26\u6765\u7684\u4e0d\u786e\u5b9a\u6027\uff09\uff0c\u53ef\u52a0\uff1a</p> <ul> <li><code>--no-async-jit=true</code>\uff08\u8ba9\u7f16\u8bd1\u66f4\u540c\u6b65\u3001\u66f4\u5bb9\u6613\u89c2\u5bdf\u8c03\u7528\u70b9\u884c\u4e3a\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#6-catch","title":"6) \u5f02\u5e38\u201c\u4e24\u6bb5\u5f0f\u201d\u4e0e catch \u641c\u7d22\uff08\u65b0\u540c\u5b66\u6700\u5bb9\u6613\u8bef\u8bfb\uff09","text":"<ul> <li>\u7b2c\u4e00\u6bb5\uff08\u89e3\u91ca\u5668 stackless\uff09\uff1a<code>EXCEPTION_HANDLER</code> \u2192 <code>FindCatchBlockStackless()</code></li> <li>\u6e90\u7801\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code></li> <li>\u7b2c\u4e8c\u6bb5\uff08\u8fdb\u5165 CFrames \u641c\u7d22\uff09\uff1a<code>FindCatchBlockInCallStack(thread)</code> \u2192 <code>FindCatchBlockInCFrames</code> \u2192 \u547d\u4e2d\u540e <code>Deoptimize(...)</code></li> <li>\u6e90\u7801\uff1a<code>runtime/exceptions.cpp</code></li> <li>\u6587\u6863\u5165\u53e3\uff1aFlows/StackWalking</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#7","title":"7) \u4e09\u4e2a\u6700\u5c0f\u5b9e\u9a8c\uff08\u628a\u73b0\u8c61\u201c\u505a\u51fa\u6765\u201d\uff0c\u4f60\u5c31\u4e0d\u518d\u9760\u731c\uff09","text":""},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#1-cpp-c-handler","title":"\u5b9e\u9a8c 1\uff1a\u5f3a\u5236\u8d70 cpp\uff08\u9a8c\u8bc1\u4f60\u6539 C++ handler \u662f\u5426\u80fd\u751f\u6548\uff09","text":"<ul> <li>\u8fd0\u884c\u65f6\u663e\u5f0f\u8bbe\u7f6e\uff1a<code>--interpreter-type=cpp</code></li> <li>\u4f60\u5e94\u8be5\u89c2\u5bdf\u5230\uff1a</li> <li>\u4e0d\u4f1a\u51fa\u73b0 \u201cSetting up * dispatch table\u201d \u65e5\u5fd7</li> <li>opcode \u884c\u4e3a\u66f4\u5bb9\u6613\u88ab\u4f60\u5728 <code>runtime/interpreter/interpreter-inl.h</code> \u7684 handler \u5f71\u54cd</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#2-llvmirtoc-fast-interpreter","title":"\u5b9e\u9a8c 2\uff1a\u5f3a\u5236\u8d70 llvm/irtoc\uff08\u9a8c\u8bc1 fast interpreter \u751f\u6548\uff09","text":"<ul> <li>\u8fd0\u884c\u65f6\u663e\u5f0f\u8bbe\u7f6e\uff1a<code>--interpreter-type=llvm</code>\uff08\u6216 <code>irtoc</code>\uff09</li> <li>\u4f60\u5e94\u8be5\u89c2\u5bdf\u5230\uff1a</li> <li>\u51fa\u73b0 <code>Setting up LLVM Irtoc dispatch table</code>\uff08\u6216 <code>Setting up Irtoc dispatch table</code>\uff09</li> <li>\u5982\u679c\u6784\u5efa\u4e0d\u652f\u6301\u8be5\u540e\u7aef\uff0c\u4f1a\u76f4\u63a5 FATAL\uff08\u8fd9\u4e5f\u662f\u5224\u65ad\u6784\u5efa\u80fd\u529b\u7684\u6700\u5feb\u65b9\u6cd5\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Newbie_MinDebug_Playbook/#3-osr-fake-return","title":"\u5b9e\u9a8c 3\uff1a\u8ba9 OSR \u66f4\u5bb9\u6613\u89e6\u53d1\u5e76\u89c2\u5bdf\u201cfake-return\u201d","text":"<ul> <li>\u8fd0\u884c\u65f6\u5efa\u8bae\u8bbe\u7f6e\uff1a</li> <li><code>--compiler-hotness-threshold=1 --compiler-enable-osr=true --no-async-jit=true</code></li> <li>\u4f60\u5e94\u8be5\u89c2\u5bdf\u5230\uff08\u6e90\u7801\u5c42\u9762\uff09\uff1a</li> <li>\u56de\u8fb9\u5904\u8d70\u5230 <code>InstrumentBranches(offset&lt;=0)</code>\uff0c\u5e76\u8fdb\u5165 <code>UpdateHotnessOSR(...)</code></li> <li>OSR \u53d1\u751f\u65f6\u4f1a\u5199\u5165 fake <code>RETURN_VOID</code>\uff08<code>GetFakeInstBuf/SetInst</code>\uff09\uff0c\u8ba9\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u8d70\u5411 OSR \u5165\u53e3</li> </ul> <p>\u5907\u6ce8\uff1a\u8fd9\u4e2a\u5b9e\u9a8c\u5728 arm64 \u4e0a\u6700\u5bb9\u6613\u95ed\u73af\uff08\u6709 <code>runtime/arch/aarch64/osr_aarch64.S</code> \u7684\u771f\u5b9e OSR \u5165\u53e3\uff09\uff1b\u5728\u975e arm64 \u4e0a\u8bf7\u5148\u786e\u8ba4\u67b6\u6784\u5b9e\u73b0\u662f\u5426\u5b58\u5728\uff0c\u5426\u5219\u53ef\u80fd\u76f4\u63a5\u843d\u5165 stub/UNREACHABLE\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/","title":"Bridge\uff08I2C/C2I\uff09\u4e0e FrameKind\uff08\u8fb9\u754c\u8bed\u4e49\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u8c03\u7528/\u6865\u63a5\uff08\u89e3\u91ca\u5668 \u2194 compiled\uff09\u201d\u6846\uff1b\u4ee5\u53ca\u201c\u5f02\u5e38/\u6808\u904d\u5386/Deopt\u201d\u90fd\u4f1a\u4f9d\u8d56 FrameKind \u4e0e boundary frame\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p>Bridge \u662f\u89e3\u91ca\u5668\u4e0e\u7f16\u8bd1\u4ee3\u7801\u7684\u201c\u8fb9\u754c\u534f\u8bae\u201d\uff0c\u6838\u5fc3\u76ee\u6807\u662f\uff1a - \u8ba9\u89e3\u91ca\u5668\u80fd\u6309 ABI \u628a\u53c2\u6570\u4f20\u7ed9 compiled code\uff08I2C\uff09 - \u8ba9 compiled code \u80fd\u5728\u9700\u8981\u65f6\u56de\u5230\u89e3\u91ca\u5668\u5e76\u7ee7\u7eed\u6267\u884c\uff08C2I/InvokeInterpreter\uff09 - \u8ba9\u6808\u904d\u5386/\u5f02\u5e38/unwind \u80fd\u8bc6\u522b\u5f53\u524d\u5e27\u5c5e\u4e8e\u54ea\u4e00\u4fa7\uff08FrameKind\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#framekind","title":"FrameKind \u4e3a\u4ec0\u4e48\u91cd\u8981","text":"<p>StackWalker\u3001deopt\u3001\u5f02\u5e38 unwind \u90fd\u9700\u8981\u201c\u5224\u65ad\u4e00\u4e2a\u5e27\u662f\u89e3\u91ca\u5668\u5e27\u8fd8\u662f\u7f16\u8bd1\u5e27\u201d\u3002 FrameKind \u4e0d\u4e00\u81f4\u901a\u5e38\u4f1a\u8868\u73b0\u4e3a\uff1a - \u6808\u56de\u6eaf\u7f3a\u5e27/\u987a\u5e8f\u9519 - \u4ece compiled \u56de\u89e3\u91ca\u5668\u540e acc/\u8fd4\u56de\u503c\u9519 - deopt \u91cd\u5efa frame \u65f6\u8bfb\u53d6\u9519\u8bef\u7684\u6570\u636e\u6e90</p>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#_2","title":"\u5173\u952e\u4e0d\u53d8\u91cf\uff08\u65b0\u4eba\u6392\u969c\u5fc5\u8bb0\uff09","text":"<ul> <li>Thread \u540c\u65f6\u7ef4\u62a4\u201c\u5f53\u524d\u5e27\u6307\u9488 + \u5f53\u524d\u5e27\u662f\u5426 compiled\u201d\u4e24\u4e2a\u7ef4\u5ea6\uff1a</li> <li>\u6865\u63a5/InvokeInterpreter/deopt \u9700\u8981\u628a\u5b83\u4eec\u5207\u5230\u4e00\u81f4\u72b6\u6001\uff08\u4f8b\u5982\u56de\u89e3\u91ca\u5668\u524d <code>SetCurrentFrame(frame)</code> \u4e14 <code>SetCurrentFrameIsCompiled(false)</code>\uff09\u3002</li> <li>FrameKind/\u8fb9\u754c\u5e27\u662f StackWalker \u7684\u201c\u5206\u5c94\u70b9\u201d\uff1a</li> <li>\u4e00\u65e6\u8fb9\u754c\u5e27\u8bc6\u522b\u9519\uff0cStackWalker \u53ef\u80fd\u628a IFrame \u5f53 CFrame \u89e3\u6790\uff08\u6216\u53cd\u8fc7\u6765\uff09\uff0c\u8f7b\u5219\u7f3a\u5e27\uff0c\u91cd\u5219\u5d29\u6e83\u3002</li> <li>acc \u5199\u56de\u662f\u8fb9\u754c\u534f\u8bae\u7684\u4e00\u90e8\u5206\uff1a</li> <li>\u89e3\u91ca\u5668\u2192compiled\uff1a\u8c03\u7528\u524d\u4f1a\u628a acc \u5199\u56de frame\uff1b\u8fd4\u56de\u540e\u518d\u4ece frame \u6062\u590d\uff08\u5426\u5219 GC/hook/\u8fd4\u56de\u503c\u8bed\u4e49\u53ef\u80fd\u4e0d\u4e00\u81f4\uff09\u3002</li> <li>compiled\u2192\u89e3\u91ca\u5668\uff1a<code>InvokeInterpreter</code> \u8fd4\u56de\u524d\u5fc5\u987b\u4ece <code>frame-&gt;GetAcc()</code> \u53d6\u56de\u7ed3\u679c\u5e76\u6062\u590d thread \u7684\u524d\u4e00\u5e27\u72b6\u6001\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#abi-debug","title":"ABI/\u6808\u5e27\u5f62\u6001\uff08\u628a\u201c\u8fb9\u754c\u534f\u8bae\u201d\u8bb2\u5230\u53ef\u753b\u56fe\u53ef debug\uff09","text":"<p>\u8fd9\u4e00\u8282\u7684\u76ee\u6807\uff1a\u5f53\u4f60\u770b\u5230\u201c\u6808\u4e0d\u5bf9/\u7f3a\u5e27/\u8fd4\u56de\u503c\u9519\u201d\uff0c\u80fd\u7acb\u523b\u77e5\u9053\uff1a - \u54ea\u4e9b\u5e27\u662f \u8bed\u4e49\u5e27\uff08IFrame/CFrame\uff09 - \u54ea\u4e9b\u5e27\u662f \u8fb9\u754c\u5e27\uff08I2C/C2I boundary\uff09 - Thread \u7684\u72b6\u6001\u4f4d\u5e94\u5f53\u5982\u4f55\u5207\u6362\uff08currentFrame \u6307\u9488 + currentFrameIsCompiled\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#1-i2c-c2i","title":"1) \u903b\u8f91\u6808\u5f62\u6001\uff08I2C / C2I\uff09","text":"<pre><code>flowchart TB\n  subgraph S[\"Call Stack\uff08Top \u2192 Bottom\uff09\"]\n    A[\"CFrame (compiled callee)\\n- CodeInfo/StackMap\\n- may inline multiple methods\"] --&gt; B[\"Boundary: I2C\\nINTERPRETER_TO_COMPILED_CODE\"]\n    B --&gt; C[\"IFrame (interpreter caller)\\nFrame* chain: prev_/method_/bcOffset_/acc/vregs\"]\n    C --&gt; D[\"...\"]\n  end</code></pre> <pre><code>flowchart TB\n  subgraph S2[\"Call Stack\uff08Top \u2192 Bottom\uff09\"]\n    I[\"IFrame (interpreter callee / resumed)\\n- pc points into bytecode\\n- acc/vregs restored\"] --&gt; J[\"Boundary: C2I\\nCOMPILED_CODE_TO_INTERPRETER\"]\n    J --&gt; K[\"CFrame (compiled caller)\"]\n    K --&gt; L[\"...\"]\n  end</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#2-framekind-checklist","title":"2) \u201c\u53cc\u72b6\u6001\u5f00\u5173\u201d\u4e0e FrameKind \u7684\u5173\u7cfb\uff08\u6392\u969c checklist\uff09","text":"<pre><code>flowchart LR\n  T[\"ManagedThread\"] --&gt; CF[\"currentFrame*\"]\n  T --&gt; IC[\"currentFrameIsCompiled\"]\n  T --&gt; FK[\"FrameKind / boundary markers\"]\n\n  IC --&gt;|true| P1[\"StackWalker: CFrame decode\\n(CodeInfo/StackMap)\"]\n  IC --&gt;|false| P2[\"StackWalker: IFrame decode\\n(Frame* chain)\"]\n\n  FK --&gt;|I2C boundary| B1[\"INTERPRETER_TO_COMPILED_CODE\"]\n  FK --&gt;|C2I boundary| B2[\"COMPILED_CODE_TO_INTERPRETER\"]</code></pre> <ul> <li>\u4f60 debug \u65f6\u540c\u65f6\u770b\u4e09\u4ef6\u4e8b\uff1a</li> <li><code>currentFrame*</code> \u662f\u5426\u6307\u5411\u4f60\u8ba4\u4e3a\u7684\u201c\u5f53\u524d\u8bed\u4e49\u5e27\u201d\uff08Frame* \u8fd8\u662f CFrame\uff09</li> <li><code>currentFrameIsCompiled</code> \u662f\u5426\u4e0e\u5f53\u524d\u6267\u884c\u4fa7\u4e00\u81f4\uff08compiled vs interpreter\uff09</li> <li>boundary frame \u662f\u5426\u80fd\u88ab StackWalker \u8bc6\u522b\uff08\u5426\u5219\u4e0a\u4e00\u5e27\u8df3\u9519\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#3-deopt-stackwalker","title":"3) deopt/\u5f02\u5e38\u4e0e StackWalker \u7684\u4ea4\u754c\uff08\u4e3a\u4ec0\u4e48\u8fb9\u754c\u5e27\u5fc5\u987b\u53ef\u8bc6\u522b\uff09","text":"<ul> <li>\u5f02\u5e38\u4e24\u6bb5\u5f0f\uff1astackless IFrames \u91cc\u627e\u4e0d\u5230 catch \u2192 \u8fdb\u5165 CFrames \u641c\u7d22 \u2192 \u627e\u5230\u540e\u53ef\u80fd <code>Deoptimize</code> \u56de\u89e3\u91ca\u5668 catch pc\u3002</li> <li>deopt \u7684\u5173\u952e\u52a8\u4f5c\uff1a<code>StackWalker::ConvertToIFrame</code> \u4f1a\u628a CFrame \u91cd\u5efa\u6210\u4e00\u4e32 IFrame\uff08\u5305\u542b inlined \u5c55\u5f00\uff09\uff0c\u5e76\u9700\u8981\u6b63\u786e\u8de8\u8fc7 boundary frame\u3002</li> </ul> <p>\u6240\u4ee5\uff1a\u53ea\u8981\u4f60\u770b\u5230 \u201cFindCatchBlockInCallStack/Deoptimize/ConvertToIFrame\u201d \u51fa\u73b0\uff0c\u4f18\u5148\u6000\u7591 FrameKind/boundary \u4e0e thread \u72b6\u6001\u4f4d\u662f\u5426\u4e00\u81f4\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#mermaidthread","title":"Mermaid\uff1aThread \u7684\u201c\u5f53\u524d\u5e27\u8bed\u4e49\u201d\u5f00\u5173\uff08\u4f60\u6392\u969c\u65f6\u8981\u540c\u65f6\u770b\u8fd9\u4e24\u4e2a\u72b6\u6001\uff09","text":"<pre><code>flowchart TD\n  T[\"ManagedThread\"] --&gt; CF[\"currentFrame*\"]\n  T --&gt; CFlag[\"currentFrameIsCompiled (bool)\"]\n  CF --&gt;|\"\u6307\u5411\"| F[\"Frame / CFrame (by kind)\"]\n  CFlag --&gt;|true| K1[\"StackWalker \u8d70 CFrame \u89e3\u7801\u8def\u5f84\"]\n  CFlag --&gt;|false| K2[\"StackWalker \u8d70 IFrame/Frame \u94fe\u8def\u5f84\"]</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#mermaid-framekind","title":"Mermaid\uff1a\u6865\u63a5\u4e0e FrameKind \u5207\u6362\uff08\u6982\u5ff5\u65f6\u5e8f\uff09","text":"<pre><code>sequenceDiagram\n  participant T as Thread\n  participant INT as Interpreter\n  participant BR as Bridge\n  participant CC as Compiled Code\n\n  INT-&gt;&gt;T: SetCurrentFrame(frame)\\nFrameKind=INTERPRETER\n  INT-&gt;&gt;BR: I2C(...)\n  BR-&gt;&gt;CC: \u8df3\u8f6c\u6267\u884c\\nFrameKind=COMPILED(\u8fb9\u754c\u53ef\u89c1)\n  alt deopt/\u9700\u8981\u56de\u89e3\u91ca\u5668\n    CC-&gt;&gt;BR: C2I(...)\n    BR-&gt;&gt;T: SetCurrentFrame(frame)\\n\u5207\u56de INTERPRETER\n    BR-&gt;&gt;INT: Execute(pc, frame)\n    INT--&gt;&gt;BR: acc/\u8fd4\u56de\u503c\n    BR--&gt;&gt;CC: \u8fd4\u56de\u6216\u7ee7\u7eed unwind\n  else \u6b63\u5e38\u8fd4\u56de\n    CC--&gt;&gt;BR: \u8fd4\u56de\u503c\n    BR--&gt;&gt;INT: \u5199\u56de acc/\u8fd4\u56de\n  end</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#_3","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/bridge/bridge.h</code>\uff08\u5bf9\u5916 ABI \u4e0e\u6865\u63a5\u7b26\u53f7\uff09</li> <li><code>runtime/bridge/bridge.cpp</code>\uff08InvokeInterpreter\u3001frame kind \u5207\u6362\u3001acc \u5199\u56de\uff09</li> <li><code>runtime/include/stack_walker.h</code> + <code>runtime/stack_walker.cpp</code>\uff08FrameKind \u9a71\u52a8\u7684\u6808\u904d\u5386\uff09</li> <li>\u89e3\u91ca\u5668\u4fa7 i2c \u8c03\u7528\u70b9\uff1a<code>runtime/interpreter/interpreter-inl.h::CallCompiledCode</code></li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#arch-i2cc2iproxydeopt","title":"arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff08I2C/C2I/proxy/deopt \u7684\u7269\u7406\u843d\u5730\uff09","text":"<p>\u8fd9\u7ec4\u94fe\u63a5\u628a \u201cFrameKind/\u8fb9\u754c\u8bed\u4e49\u201d \u4ece\u6982\u5ff5\u76f4\u63a5\u843d\u5230 \u6808\u5e03\u5c40/\u5bc4\u5b58\u5668\u4fdd\u5b58/TLS \u66f4\u65b0\u70b9\u3002 \u5f53\u4f60\u9700\u8981\u8bc1\u660e\u67d0\u6761\u65ad\u8a00\uff08VM \u67b6\u6784\u5ba1\u8ba1\uff09\u6216\u6392\u67e5\u7f3a\u5e27/\u9519\u5e27/\u5f02\u5e38\u8de8\u8fb9\u754c\u95ee\u9898\uff08\u5de5\u7a0b\u843d\u5730\uff09\uff0c\u4f18\u5148\u770b\u8fd9\u91cc\u3002</p> <ul> <li>I2C\uff08aarch64\uff09\uff1aFileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S.md</li> <li>C2I\uff08aarch64\uff09\uff1aFileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S.md</li> <li>proxy\uff08aarch64\uff09\uff1aFileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S.md</li> <li> <p>deopt-after\uff08aarch64\uff09\uff1aFileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S.md</p> </li> <li> <p>I2C\uff08amd64\uff09\uff1aFileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S.md</p> </li> <li>C2I\uff08amd64\uff09\uff1aFileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S.md</li> <li>proxy\uff08amd64\uff09\uff1aFileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S.md</li> <li> <p>deopt-after\uff08amd64\uff09\uff1aFileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S.md</p> </li> <li> <p>dyn \u7248\u672c\uff08TaggedValue calling convention\uff09\uff1a</p> </li> <li>aarch64\uff1aI2C/C2I\uff08dyn\uff09I2C / C2I</li> <li>amd64\uff1aI2C/C2I\uff08dyn\uff09I2C / C2I</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Bridge_ABI_and_FrameKind/#_4","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u6865\u63a5\u4e3b\u8c03\u7528\u94fe + arch \u8bc1\u636e\u94fe\u5165\u53e3\uff08\u66f4\u96c6\u4e2d\uff09\u201d \u2192 Bridge_I2C_C2I\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u7f3a\u5e27/\u9519\u5e27/\u5f02\u5e38\u4e24\u6bb5\u5f0f\u5982\u4f55\u4f9d\u8d56\u8fb9\u754c\u5e27\u201d \u2192 StackWalking\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cdeopt-after/OSR \u4e3a\u4ec0\u4e48\u7ecf\u5e38\u4e0e\u8fb9\u754c\u5e27\u8026\u5408\u201d \u2192 Deopt_and_OSR\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/","title":"Deopt \u4e0e OSR\uff08\u72b6\u6001\u91cd\u5efa\u4e0e\u4e2d\u9014\u5207\u6362\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201cJIT/OSR\uff08\u70ed\u70b9\u89e6\u53d1\uff09\u201d\u4e0e\u201cDeopt\uff08compiled\u2192\u89e3\u91ca\u5668\u6062\u590d\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<ul> <li>Deopt\uff08\u53bb\u4f18\u5316\uff09\uff1a\u628a\u7f16\u8bd1\u6001\u7684\u6267\u884c\u6062\u590d\u4e3a\u89e3\u91ca\u5668\u53ef\u7ee7\u7eed\u6267\u884c\u7684\u72b6\u6001\uff08Frame/VRegs/PC/Acc\uff09\u3002</li> <li>OSR\uff08On-Stack Replacement\uff09\uff1a\u5728\u89e3\u91ca\u5668\u6267\u884c\u4e2d\u9014\uff08\u5e38\u89c1\u662f\u5faa\u73af\u56de\u8fb9\uff09\u5207\u5230\u7f16\u8bd1\u7248\u672c\u7ee7\u7eed\u6267\u884c\u3002</li> </ul> <p>\u4e8c\u8005\u5171\u540c\u70b9\uff1a\u90fd\u5728\u201c\u89e3\u91ca\u5668\u2194\u7f16\u8bd1\u4ee3\u7801\u8fb9\u754c\u201d\u53d1\u751f\uff0c\u90fd\u8981\u6c42\u5bf9\u6267\u884c\u72b6\u6001\u6709\u660e\u786e\u7684\u7f16\u7801/\u6062\u590d\u89c4\u5219\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#_2","title":"\u6838\u5fc3\u4e0d\u53d8\u91cf\uff08\u6392\u969c\u5fc5\u8bb0\uff09","text":"<ul> <li>deopt \u7684\u8f93\u51fa\u5fc5\u987b\u662f\u201c\u53ef\u6267\u884c\u7684\u89e3\u91ca\u5668\u5e27\u201d\uff1aPC \u5fc5\u987b\u843d\u5728\u6b63\u786e\u5b57\u8282\u7801\u8fb9\u754c\uff0cVRegs/Acc \u5fc5\u987b\u6ee1\u8db3\u8be5 PC \u7684\u8bed\u4e49\u524d\u7f6e\u6761\u4ef6\u3002</li> <li>OSR \u7684\u8fdb\u5165\u70b9\u5fc5\u987b\u4e0e\u89e3\u91ca\u5668\u72b6\u6001\u5bf9\u9f50\uff1aOSR code \u7ea6\u5b9a\u7684\u8f93\u5165\uff08vregs/acc/locals\uff09\u8981\u4e0e\u89e3\u91ca\u5668\u5f53\u524d\u503c\u4e00\u81f4\u3002</li> <li>\u201c\u65b9\u6cd5\u88ab deopt \u6807\u8bb0\u201d\u4f1a\u5f71\u54cd OSR \u5b89\u88c5\uff1a\u5e38\u89c1\u73b0\u8c61\u662f\u201c\u70ed\u4e86\u4f46\u5c31\u662f\u4e0d OSR\u201d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#osr","title":"\u65b0\u4eba\u6700\u5bb9\u6613\u6f0f\u6389\u7684\u70b9\uff1aOSR \u7684\u89e6\u53d1\u70b9\u901a\u5e38\u5728\u201c\u56de\u8fb9/\u5206\u652f\u63d2\u6869\u201d","text":"<p>\u5728\u672c\u5de5\u7a0b\u91cc\uff0c\u89e3\u91ca\u5668\u4f1a\u5728 \u56de\u8fb9\uff08loop backedge\uff09 \u5904\u505a\uff1a</p> <ul> <li>safepoint \u68c0\u67e5\uff08<code>TestAllFlags()</code> \u2192 <code>RuntimeIfaceT::Safepoint()</code>\uff09</li> <li>hotness/OSR \u8ba1\u6570\u9012\u51cf\uff08<code>UpdateHotnessOSR</code>\uff09</li> <li>\u82e5 OSR \u6ee1\u8db3\u6761\u4ef6\uff0c\u4f1a\u201c\u4f2a\u9020\u4e00\u6761 RETURN \u6307\u4ee4\u201d\u8ba9\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u9000\u51fa\uff0c\u4ece\u800c\u8fdb\u5165 OSR \u5165\u53e3</li> </ul> <p>\u5bf9\u5e94\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\uff09\uff1a</p> <ul> <li><code>runtime/interpreter/instruction_handler_base.h::InstrumentBranches/UpdateHotnessOSR</code>\uff08OSR \u89e6\u53d1\u70b9\u4e0e fakeInst\uff09</li> <li><code>runtime/osr.*</code>\uff08PrepareOsrEntry/OsrEntry\uff09</li> <li><code>runtime/compiler.*</code>\uff08TrySetOsrCode\uff1aOSR code \u5b89\u88c5\u6761\u4ef6\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#_3","title":"\u5e38\u89c1\u73b0\u8c61 \u2192 \u53ef\u80fd\u539f\u56e0\uff08\u7ed9\u65b0\u540c\u5b66\u7684\u6392\u969c\u6620\u5c04\uff09","text":"<ul> <li>\u201c\u5faa\u73af\u5f88\u70ed\u4f46 OSR \u4e0d\u89e6\u53d1\u201d\uff1a</li> <li>OSR \u88ab runtime option \u5173\u95ed</li> <li>frame \u88ab\u6807\u8bb0\u4e3a deoptimized / method \u4e0d\u5141\u8bb8\u5b89\u88c5 OSR code</li> <li>\u67d0\u4e9b\u7279\u6b8a frame\uff08\u4f8b\u5982 INITOBJ \u5728\u7279\u5b9a\u8bed\u8a00\u8def\u5f84\uff09\u4f1a\u663e\u5f0f DisableOsr</li> <li>\u201cdeopt \u56de\u9000\u540e\u8bed\u4e49\u9519/\u8fd4\u56de\u503c\u9519\u201d\uff1a</li> <li>vreg/acc/pc \u8fd8\u539f\u4e0d\u4e00\u81f4\uff08\u5c24\u5176\u662f\u8fb9\u754c\u5e27/\u5185\u8054\u5e27\uff09</li> <li>thread \u7684 currentFrameIsCompiled \u4e0e frame kind \u6ca1\u5207\u56de\u4e00\u81f4\u72b6\u6001</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#mermaiddeopt-osr","title":"Mermaid\uff1adeopt \u4e0e OSR \u7684\u4f4d\u7f6e","text":"<pre><code>flowchart TD\n  A[\"Interpreter \u4e3b\u5faa\u73af\"] --&gt; B{\"\u70ed\u70b9/\u56de\u8fb9\u89e6\u53d1\uff1f\"}\n  B --&gt;|\u662f| C[\"\u5c1d\u8bd5 OSR\\nTrySetOsrCode/EnterOsr\"]\n  C --&gt;|\u6210\u529f| D[\"\u8fdb\u5165 OSR compiled code\"]\n  C --&gt;|\u5931\u8d25| A\n  D --&gt; E{\"\u8fd0\u884c\u4e2d\u9700\u8981\u56de\u9000\uff1f\"}\n  E --&gt;|\u662f| F[\"deopt\\n\u91cd\u5efa Frame/VRegs/PC/Acc\"]\n  F --&gt; A\n  E --&gt;|\u5426| D</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#_4","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li>OSR\uff1a<code>runtime/osr.h</code>\u3001<code>runtime/osr.cpp</code></li> <li>deopt\uff1a<code>runtime/deoptimization.h</code>\u3001<code>runtime/deoptimization.cpp</code></li> <li>OSR code \u5199\u5165\u6761\u4ef6\uff1a<code>runtime/compiler.h/.cpp</code>\uff08TrySetOsrCode \u76f8\u5173\uff09</li> <li>\u6865\u63a5\u8fb9\u754c\uff1a<code>runtime/bridge/bridge.cpp</code></li> <li>\u89e6\u53d1\u70b9\uff08\u89e3\u91ca\u5668\u56de\u8fb9\uff09\uff1a<code>runtime/interpreter/instruction_handler_base.h</code></li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Deopt_and_OSR/#_5","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cdeopt/OSR \u7684\u7aef\u5230\u7aef flow\uff08\u542b\u67b6\u6784\u7ea6\u675f\uff09\u201d \u2192 Deopt_and_OSR\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cOSR \u89e6\u53d1\u70b9\u5982\u4f55\u7ed1\u5728\u89e3\u91ca\u5668\u56de\u8fb9/\u5206\u652f\u63d2\u6869\u201d \u2192 Interpreter_Execute\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cdeopt-after \u56de\u89e3\u91ca\u5668\u65f6\u8de8\u8fb9\u754c/\u7f3a\u5e27\u201d \u2192 Bridge_I2C_C2I\uff08Flow\uff09 \u4e0e StackWalking\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/","title":"Method Entrypoint \u4e0e\u6d3e\u53d1\u51b3\u7b56\uff08\u89e3\u91ca\u5668/\u7f16\u8bd1/OSR/native\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u8c03\u7528/\u6865\u63a5\uff08\u89e3\u91ca\u5668 \u2194 compiled\uff09\u201d\u4e0e\u201cJIT/OSR\uff08\u70ed\u70b9\u89e6\u53d1\uff09\u201d\u6846\uff1a\u672c\u5361\u7247\u89e3\u91ca Method \u7684 entrypoint/OSR code \u5982\u4f55\u9a71\u52a8\u6d3e\u53d1\u51b3\u7b56\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p>\u201c\u65b9\u6cd5\u600e\u4e48\u88ab\u8c03\u7528\u201d\u672c\u8d28\u4e0a\u662f\u4e00\u4e2aentrypoint \u9009\u62e9\u95ee\u9898\uff1a\u540c\u4e00\u4e2a <code>Method</code> \u5728\u4e0d\u540c\u9636\u6bb5\u53ef\u80fd\u6307\u5411\u4e0d\u540c\u5165\u53e3\uff1a - \u89e3\u91ca\u5668\u5165\u53e3\uff08\u6216 C2I bridge\uff09\uff1a\u672a\u7f16\u8bd1/\u9700\u8981\u56de\u9000\u65f6 - \u5df2\u7f16\u8bd1\u5165\u53e3\uff08JIT/AOT\uff09\uff1a\u70ed\u70b9\u65b9\u6cd5\u8d70\u5feb\u8def\u5f84 - OSR \u5165\u53e3\uff1a\u5faa\u73af\u4e2d\u9014\u5207\u6362\u5230\u7f16\u8bd1\u7248\u672c - native \u5165\u53e3\uff1aJNI/ANI\uff08\u8de8\u7ae0 05\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#entrypoint","title":"entrypoint \u7684\u5b58\u653e\u4f4d\u7f6e\uff08\u8de8\u7ae0\u63d0\u793a\uff09","text":"<p><code>Method</code> \u7684\u5b57\u6bb5\u4e0e\u72b6\u6001\u4f4d\u6bb5\u5728 03 \u7ae0\u5df2\u7ecf\u9010\u884c\u95ed\u73af\uff08\u907f\u514d\u5728 04 \u7ae0\u91cd\u590d\u9010\u884c\uff09\uff1a - \u89c1 03\uff1aruntime_include_method.h\uff08FileNotes\uff09</p> <p>04 \u7ae0\u4e3b\u8981\u5173\u6ce8\uff1a\u8c01\u5728\u4ec0\u4e48\u65f6\u5019\u5199\u5165\u8fd9\u4e9b entrypoints\uff0c\u4ee5\u53ca\u8c03\u7528\u65b9\u5982\u4f55\u4f7f\u7528\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#mermaid","title":"Mermaid\uff1a\u4e00\u6b21\u8c03\u7528\u7684\u6d3e\u53d1\u51b3\u7b56\uff08\u6982\u5ff5\u56fe\uff09","text":"<pre><code>flowchart TD\n  A[\"\u8c03\u7528\u70b9\uff1ainvoke/call\"] --&gt; B[\"\u8bfb\u53d6 Method \u7684 entrypoint \u72b6\u6001\"]\n  B --&gt; C{\"\u662f\u5426\u6709 compiled entrypoint\uff1f\"}\n  C --&gt;|\u65e0| I[\"\u8d70\u89e3\u91ca\u5668\uff08\u6216\u89e6\u53d1\u7f16\u8bd1\uff09\"]\n  C --&gt;|\u6709| D[\"\u8d70 I2C bridge\\nInterpreterToCompiledCodeBridge\"]\n  D --&gt; E{\"\u6267\u884c\u4e2d\u662f\u5426\u89e6\u53d1 deopt/\u5f02\u5e38\uff1f\"}\n  E --&gt;|\u5426| R1[\"\u6b63\u5e38\u8fd4\u56de\\n\u5199\u56de acc/\u8fd4\u56de\u5bc4\u5b58\u5668\"]\n  E --&gt;|\u662f| F[\"\u8d70 C2I bridge\\nCompiledCodeToInterpreterBridge\"]\n  F --&gt; G[\"InvokeInterpreter(pc, frame)\\n\u56de\u89e3\u91ca\u5668\u7ee7\u7eed/\u5b8c\u6210\"]\n  G --&gt; R2[\"\u8fd4\u56de\u5230\u7f16\u8bd1\u6001\u8c03\u7528\u70b9\\n\u6216\u7ee7\u7eed unwind\"]</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#osr-osr","title":"OSR \u7684\u4e0d\u53d8\u91cf\uff08\u4e3a\u4ec0\u4e48 OSR \u5e38\u201c\u770b\u8d77\u6765\u6ca1\u751f\u6548\u201d\uff09","text":"<ul> <li>OSR \u4e0d\u662f\u201c\u6709\u5faa\u73af\u5c31\u4e00\u5b9a OSR\u201d\uff0c\u5b83\u901a\u5e38\u9700\u8981\uff1a</li> <li>\u65b9\u6cd5\u5904\u4e8e\u53ef\u7f16\u8bd1\u72b6\u6001\uff08\u672a\u88ab deopt \u7981\u7528\uff09</li> <li>runtime/\u7f16\u8bd1\u5668\u80fd\u6210\u529f\u5b89\u88c5 OSR code\uff08TrySetOsrCode \u901a\u8fc7\uff09</li> <li>\u89e6\u53d1\u70b9\u547d\u4e2d\uff08\u56de\u8fb9\u8ba1\u6570/\u70ed\u5ea6\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#_2","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li>bridge\uff1a<code>runtime/bridge/bridge.h</code>\u3001<code>runtime/bridge/bridge.cpp</code></li> <li>OSR\uff1a<code>runtime/osr.h</code>\u3001<code>runtime/osr.cpp</code></li> <li>JIT runtime interface\uff1a<code>runtime/compiler.h</code>\u3001<code>runtime/compiler.cpp</code>\uff08TrySetOsrCode/SetCompiledEntryPoint\uff09</li> <li>03\uff08Method \u5b57\u6bb5\u5b9a\u4e49\uff09\uff1aruntime_include_method.h\uff08FileNotes\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoint_and_MethodDispatch/#_3","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u6d3e\u53d1\u51b3\u7b56\u5982\u4f55\u843d\u5230 I2C/C2I \u8fb9\u754c\u201d \u2192 Bridge_I2C_C2I\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cOSR \u5b89\u88c5\u6761\u4ef6/\u89e6\u53d1\u70b9/\u56de\u9000\u8def\u5f84\u201d \u2192 Deopt_and_OSR\uff08Flow\uff09</li> <li>\u60f3\u770b\u201ccompiled code \u8c03 runtime \u6162\u8def\u5f84 + \u7f16\u8bd1\u671f\u5199\u56de\u5165\u53e3\u201d \u2192 Entrypoints_and_RuntimeInterface\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/","title":"Entrypoints\uff08\u8fd0\u884c\u65f6\u6162\u8def\u5f84\u5165\u53e3\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201cEntrypoints\uff08runtime slow paths\uff09\u201d\u6846\uff1acompiled code \u901a\u8fc7 entrypoints \u8fdb\u5165 runtime \u6162\u8def\u5f84\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>entrypoints</code> \u662f\u201c\u7f16\u8bd1\u4ee3\u7801\u8c03\u7528 runtime \u7684\u6162\u8def\u5f84\u51fd\u6570\u96c6\u5408\u201d\u3002\u5178\u578b\u5305\u62ec\uff1a - \u5bf9\u8c61/\u6570\u7ec4/\u5b57\u7b26\u4e32\u5206\u914d - \u7c7b\u578b\u68c0\u67e5\u3001\u8fb9\u754c\u68c0\u67e5\u3001null check - \u5f02\u5e38\u521b\u5efa\u4e0e\u629b\u51fa/\u91cd\u629b - \u5199\u5c4f\u969c/\u8bfb\u5c4f\u969c\u76f8\u5173\u6162\u8def\u5f84\uff08\u8de8\u7ae0 02\uff09</p> <p>\u5728\u6267\u884c\u5f15\u64ce\u89c6\u89d2\uff0c\u5b83\u4eec\u662f\uff1a 1) \u7f16\u8bd1\u4ee3\u7801\u9047\u5230\u201c\u4e0d\u80fd\u5185\u8054/\u4e0d\u80fd\u5feb\u8def\u5f84\u5904\u7406\u201d\u7684\u60c5\u51b5\u65f6\u7684\u843d\u70b9 2) \u89e3\u91ca\u5668/\u6865\u63a5\u5728\u8fb9\u754c\u4e0a\u8c03\u7528 runtime helper \u7684\u7edf\u4e00\u4f4d\u7f6e\u4e4b\u4e00</p>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/#mermaidcompiled-code-entrypoints","title":"Mermaid\uff1acompiled code \u2192 entrypoints \u2192 \u8fd4\u56de","text":"<pre><code>sequenceDiagram\n  participant CC as Compiled Code\n  participant EP as Entrypoints\n  participant RT as Runtime/VM\n\n  CC-&gt;&gt;EP: Call RuntimeEntrypoint(args)\n  EP-&gt;&gt;RT: \u6267\u884c\u6162\u8def\u5f84\uff08\u5206\u914d/\u5f02\u5e38/\u68c0\u67e5\u7b49\uff09\n  alt \u6b63\u5e38\n    RT--&gt;&gt;EP: \u8fd4\u56de\u7ed3\u679c\n    EP--&gt;&gt;CC: \u8fd4\u56de\u5230 compiled\n  else \u629b\u5f02\u5e38\n    RT--&gt;&gt;EP: \u8bbe\u7f6e pending exception\n    EP--&gt;&gt;CC: \u8d70\u5f02\u5e38\u8fb9\u754c/\u56de\u9000\u8def\u5f84\uff08\u53ef\u80fd\u89e6\u53d1 C2I/deopt\uff09\n  end</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/#_2","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/entrypoints/entrypoints.h</code></li> <li><code>runtime/entrypoints/entrypoints.cpp</code></li> <li>\u4ea4\u754c\u9762\uff1a<code>runtime/bridge/bridge.cpp</code>\u3001<code>runtime/compiler.*</code>\uff08\u7f16\u8bd1\u5668\u751f\u6210\u4ee3\u7801\u4f1a\u5f15\u7528 entrypoints\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Entrypoints/#_3","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201centrypoints \u4e0e RuntimeInterface \u7684\u5b8c\u6574 flow\uff08\u8fd0\u884c\u671f+\u7f16\u8bd1\u671f\u4e24\u6761\u7ebf\uff09\u201d \u2192 Entrypoints_and_RuntimeInterface\uff08Flow\uff09</li> <li>\u60f3\u770b\u201centrypoints \u5f02\u5e38\u5982\u4f55\u8de8\u8fb9\u754c/\u5bfc\u81f4\u56de\u89e3\u91ca\u5668\u201d \u2192 Bridge_I2C_C2I\uff08Flow\uff09 \u4e0e StackWalking\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/","title":"Frame / VRegister / Acc\uff08\u89e3\u91ca\u5668\u6267\u884c\u72b6\u6001\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\u201d\u6846\uff1b\u4ee5\u53ca\u6865\u63a5/\u5f02\u5e38/\u6808\u904d\u5386\u4f1a\u53cd\u590d\u8bfb\u5199 Frame/Acc\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p>\u89e3\u91ca\u5668\u6267\u884c bytecode \u65f6\uff0c\u9700\u8981\u4e00\u4e2a\u201c\u53ef\u6062\u590d\u3001\u53ef\u904d\u5386\u3001\u53ef\u6865\u63a5\u201d\u7684\u6267\u884c\u72b6\u6001\u5bb9\u5668\u3002\u672c\u5de5\u7a0b\u5c06\u5176\u62c6\u6210\u4e09\u5c42\uff1a - Frame\uff1a\u65b9\u6cd5\u7ea7\u6267\u884c\u4e0a\u4e0b\u6587\uff08\u5f53\u524d method\u3001pc\u3001\u4e0a\u4e00\u5e27\u94fe\u63a5\u3001frame kind \u7b49\uff09 - VRegister\uff08vreg\uff09\uff1a\u865a\u62df\u5bc4\u5b58\u5668\u6570\u7ec4\uff08\u627f\u8f7d\u5c40\u90e8\u53d8\u91cf\u4e0e\u4e34\u65f6\u503c\uff09 - Acc\uff08accumulator\uff09\uff1a\u7d2f\u52a0\u5668\u5bc4\u5b58\u5668\uff08\u5927\u91cf\u6307\u4ee4\u7684\u9690\u5f0f\u8f93\u5165/\u8f93\u51fa\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#vreg-based-stack-based","title":"\u4e3a\u4ec0\u4e48\u662f vreg-based\uff08\u4e0d\u662f stack-based\uff09","text":"<p>\u4ece <code>frame.h</code>/<code>vregister.h</code> \u7684\u8bbe\u8ba1\u53ef\u4ee5\u76f4\u63a5\u770b\u51fa\uff1a\u503c\u4e3b\u8981\u843d\u5728 vreg \u69fd\u4f4d\u91cc\uff0cacc \u4f5c\u4e3a\u201c\u9690\u5f0f\u5bc4\u5b58\u5668\u201d\uff0c\u800c\u4e0d\u662f\u201c\u64cd\u4f5c\u6570\u6808 push/pop\u201d\u3002 \u8fd9\u4f7f\u5f97\uff1a - \u7f16\u8bd1\u5668\u66f4\u5bb9\u6613\u505a SSA/\u5bc4\u5b58\u5668\u5206\u914d\u6620\u5c04\uff08vreg index \u660e\u786e\uff09 - OSR/deopt \u66f4\u5bb9\u6613\u6062\u590d\u201c\u67d0\u4e2a vreg \u7684\u503c\u201d</p>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_2","title":"\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u5dee\u5f02\uff08\u5173\u952e\u70b9\uff09","text":"<p>\u5e38\u89c1\u4e24\u79cd vreg \u8868\u8fbe\uff1a - \u9759\u6001\u8bed\u8a00\uff1apayload vregs + mirror/tag\uff08mirror \u7528\u4e8e\u6807\u6ce8\u5bf9\u8c61/\u539f\u59cb\u503c\u7b49\uff09 - \u52a8\u6001\u8bed\u8a00\uff1apayload \u5185\u90e8\u81ea\u5e26 tag\uff08\u4f8b\u5982 TaggedValue\uff09\uff0cmirror \u53ef\u80fd\u4e0d\u9700\u8981</p> <p>\u8fd9\u4f1a\u76f4\u63a5\u5f71\u54cd\uff1aacc/vreg \u7684\u8bfb\u53d6 API\u3001GC root \u8bc6\u522b\u3001\u4ee5\u53ca\u6865\u63a5\u8fd4\u56de\u503c\u5982\u4f55\u5199\u56de\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_3","title":"\u5173\u952e\u4e0d\u53d8\u91cf\uff08\u65b0\u540c\u5b66\u5f3a\u70c8\u5efa\u8bae\u80cc\u4e0b\u6765\uff09","text":"<ul> <li>acc \u5fc5\u987b\u53ef\u88ab GC \u770b\u89c1\uff1a\u5f88\u591a\u8def\u5f84\u5728\u89e6\u53d1 runtime hook/safepoint/\u89e3\u6790\u524d\uff0c\u4f1a\u5148\u628a acc \u5199\u56de <code>Frame::acc</code>\uff0c\u56de\u6765\u518d\u6062\u590d\u5230\u5bc4\u5b58\u5668/\u72b6\u6001\uff08\u89c1 <code>InstructionHandlerBase::InstrumentInstruction</code>\u3001<code>ResolveMethod/ResolveField/ResolveType</code> \u7684\u5199\u56de\u903b\u8f91\uff09\u3002</li> <li>\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u7684 vreg \u8bbf\u95ee\u4e0d\u662f\u540c\u4e00\u79cd\u4e1c\u897f\uff1a\u9759\u6001\u8bed\u8a00\u662f payload+mirror/tag\uff08<code>StaticVRegisterRef</code>\uff09\uff0c\u52a8\u6001\u8bed\u8a00\u901a\u5e38\u662f <code>TaggedValue</code>\uff08<code>DynamicVRegisterRef</code>\uff09\uff0c\u6df7\u7528\u4f1a\u5bfc\u81f4\u201c\u5bf9\u8c61\u8bc6\u522b/tag \u9519\u201d\u3002</li> <li>stackless frame \u4f1a\u5728\u89e3\u91ca\u5668\u5185\u90e8\u5f39\u6808\uff1astackless \u8c03\u7528\u8fd4\u56de\u4e0d\u662f\u201c\u76f4\u63a5 return \u51fa\u89e3\u91ca\u5668\u201d\uff0c\u800c\u662f <code>HandleReturnStackless()</code> \u66f4\u65b0 state \u5230 caller \u5e76 <code>FreeFrame</code>\uff08\u8fd9\u5bf9\u5f02\u5e38/\u627e catch \u540c\u6837\u6210\u7acb\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#mermaid","title":"Mermaid\uff1a\u89e3\u91ca\u5668\u72b6\u6001\u5982\u4f55\u6d41\u52a8","text":"<pre><code>flowchart TD\n  A[\"Frame\\n(\u65b9\u6cd5/pc/\u4e0a\u4e00\u5e27)\"] --&gt; B[\"VRegs[]\\n\u5c40\u90e8\u53d8\u91cf/\u4e34\u65f6\u503c\"]\n  A --&gt; C[\"Acc\\n\u9690\u5f0f\u5bc4\u5b58\u5668\"]\n  D[\"opcode handler\"] --&gt;|\"\u8bfb/\u5199\"| B\n  D --&gt;|\"\u8bfb/\u5199\"| C\n  D --&gt; E[\"\u66f4\u65b0 pc / \u5206\u652f\u8df3\u8f6c\"]\n  E --&gt; A</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#mermaidstackless","title":"Mermaid\uff1astackless \u8c03\u7528/\u8fd4\u56de\uff08\u6700\u5bb9\u6613\u88ab\u8bef\u89e3\u7684\u6267\u884c\u6d41\uff09","text":"<pre><code>sequenceDiagram\n  participant INT as Interpreter\n  participant F1 as Caller Frame\n  participant F2 as Callee Frame (stackless)\n  participant RT as RuntimeIface/Notification\n\n  INT-&gt;&gt;RT: MethodEntryEvent(...)\n  INT-&gt;&gt;F2: CreateFrame + CopyArgs\\nSetStackless()\n  loop execute bytecode\n    INT-&gt;&gt;F2: HandleXxx (read/write vregs+acc)\n  end\n  alt return.*\n    INT-&gt;&gt;RT: MethodExitEvent(...)\n    INT-&gt;&gt;INT: UpdateInstructionHandlerState(prevPc, prevFrame)\n    INT-&gt;&gt;F1: Restore inst/acc (or exception path)\\nSetCurrentFrame(prev)\n    INT-&gt;&gt;INT: FreeFrame(F2)\n  else throw / no catch in F2\n    INT-&gt;&gt;INT: FindCatchBlockStackless()\\n(may FreeFrame and walk up)\n  end</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_4","title":"\u5e38\u89c1\u5751\uff08\u6392\u969c\u7528\uff09","text":"<ul> <li>acc \u5199\u56de\u9057\u6f0f\uff1a\u67d0\u4e9b opcode \u4ee5 acc \u4e3a\u8f93\u51fa\uff0c\u5982\u679c handler \u5fd8\u8bb0\u66f4\u65b0\uff0c\u4f1a\u9020\u6210\u201c\u8fd4\u56de\u503c/\u5206\u652f\u6761\u4ef6\u9519\u201d</li> <li>\u9759\u6001/\u52a8\u6001\u5206\u652f\u6df7\u7528\uff1a\u540c\u4e00\u6761\u903b\u8f91\u5728\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u4e0b\u8d70\u4e0d\u540c\u8bbf\u95ee\u8def\u5f84\uff0c\u5199\u9519\u4f1a\u5bfc\u81f4 tag/\u5bf9\u8c61\u8bc6\u522b\u9519</li> <li>FrameKind \u5207\u6362\u4e0d\u4e00\u81f4\uff1a\u6865\u63a5/stack walker/deopt \u4f9d\u8d56 FrameKind\uff1b\u4e00\u65e6\u4e0d\u4e00\u81f4\u4f1a\u51fa\u73b0\u201c\u6808\u904d\u5386\u7f3a\u5e27/\u5d29\u6e83\u201d</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_5","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/interpreter/frame.h</code>\uff08Frame layout \u4e0e\u6ce8\u91ca\u56fe\uff09</li> <li><code>runtime/interpreter/vregister.h</code>\uff08VRegister/StaticVRegisterRef/DynamicVRegisterRef\uff09</li> <li><code>runtime/interpreter/acc_vregister.h</code>\uff08AccVRegister\uff09</li> <li>\u5173\u952e\u6267\u884c\u539f\u8bed\uff1a<code>runtime/interpreter/instruction_handler_base.h</code>\uff08acc \u5199\u56de/\u5f02\u5e38\u8df3\u8f6c/OSR \u89e6\u53d1\u70b9\uff09</li> <li>stackless \u8def\u5f84\uff1a<code>runtime/interpreter/interpreter-inl.h</code>\uff08HandleReturnStackless/FindCatchBlockStackless\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Frame_VReg_Acc/#_6","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u89e3\u91ca\u5668\u4e3b\u5faa\u73af/handler \u8bfb\u5199\u70b9\u201d \u2192 Interpreter_Execute\uff08Flow\uff09</li> <li>\u60f3\u770b\u201ccall \u6307\u4ee4\u5982\u4f55\u8de8\u5230 compiled\u3001\u4ee5\u53ca acc/\u8fd4\u56de\u503c\u534f\u8bae\u201d \u2192 Bridge_I2C_C2I\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u5f02\u5e38\u4e24\u6bb5\u5f0f/\u7f3a\u5e27/StackWalker \u8bfb\u5e27\u89c4\u5219\u201d \u2192 StackWalking\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/","title":"IRTOC/LLVM Fast Interpreter\uff08\u771f\u5b9e\u573a\u666f\u9ed8\u8ba4\u8def\u5f84\uff09","text":"<p>\u672c\u5361\u7247\u56de\u7b54\uff1a\u201c\u771f\u5b9e\u8dd1\u5728\u751f\u4ea7\u4e0a\u7684\u89e3\u91ca\u5668\u5230\u5e95\u662f\u8c01\uff1f\u201d \u7ed3\u8bba\uff1a\u5728\u5f53\u524d\u5de5\u7a0b\u914d\u7f6e\u91cc\uff0c<code>--interpreter-type</code> \u9ed8\u8ba4\u662f <code>llvm</code>\uff08\u89c1 <code>runtime/options.yaml</code>\uff09\uff0c\u4e5f\u5c31\u662f IRTOC \u89e3\u91ca\u5668\u8bed\u4e49 + LLVM backend\u3002 CPP \u89e3\u91ca\u5668\u4e3b\u8981\u7528\u4e8e debug / \u517c\u5bb9\u7279\u5b9a\u6a21\u5f0f\uff08\u4f8b\u5982 <code>--debug-mode=true</code> \u9650\u5236\u53ea\u80fd\u7528 cpp\uff09\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u89e3\u91ca\u5668\u9009\u578b\uff08\u8fd0\u884c\u65f6\u771f\u5b9e\u5165\u53e3\uff09\u201d\u4e0e\u201c\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\u201d\u6846\uff1afast interpreter \u662f\u9ed8\u8ba4\u6267\u884c\u8def\u5f84\u4e4b\u4e00\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#1-cpp-irtoc-llvm","title":"1) \u4e09\u79cd\u89e3\u91ca\u5668\u5b9e\u73b0\uff1acpp / irtoc / llvm","text":"<ul> <li>cpp\uff1a<code>runtime/interpreter/*</code> \u7684 C++ handler\uff08\u4fbf\u4e8e\u8c03\u8bd5\u3001\u65ad\u70b9\u3001\u65e5\u5fd7\uff1b\u4f46\u4e0d\u4e00\u5b9a\u662f\u6027\u80fd\u8def\u5f84\uff09\u3002</li> <li>irtoc\uff1aIRTOC \u811a\u672c\u63cf\u8ff0\u7684\u89e3\u91ca\u5668\u8bed\u4e49\uff08<code>irtoc/scripts/interpreter.irt</code>\uff09\uff0c\u7531\u81ea\u7814 backend \u7f16\u8bd1\u751f\u6210\u673a\u5668\u7801\u3002</li> <li>llvm\uff1a\u540c\u4e00\u4efd IRTOC \u89e3\u91ca\u5668\u8bed\u4e49\uff0c\u4f46 \u4f7f\u7528 LLVM backend \u751f\u6210\uff08\u8986\u76d6\u8def\u5f84\u66f4\u5e7f\u3001\u4f18\u5316\u66f4\u5b8c\u6574\uff09\u3002</li> </ul> <p>\u8fd0\u884c\u65f6\u9009\u62e9\u903b\u8f91\u89c1\uff1a<code>runtime/interpreter/interpreter_impl.cpp::GetInterpreterTypeFromRuntimeOptions/ExecuteImplType</code>\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#2-fast-interpreter-abi","title":"2) Fast interpreter \u7684\u201c\u5185\u90e8 ABI\u201d\uff08\u4e3a\u4ec0\u4e48\u5b83\u5feb\uff09","text":"<p>IRTOC/LLVM fast interpreter \u5e76\u4e0d\u662f\u201c\u6bcf\u6b21 dispatch \u90fd\u56de C++\u201d\uff0c\u800c\u662f\u9760\u4e00\u5957\u5185\u90e8 calling convention\uff1a</p> <ul> <li><code>ExecuteImplFast(tr, pc, frame, dispatch_table)</code> \u8fdb\u5165 fast interpreter</li> <li>\u89e3\u91ca\u5668\u628a\u6838\u5fc3\u72b6\u6001\u957f\u671f\u653e\u5728 \u56fa\u5b9a\u5bc4\u5b58\u5668\uff08per-arch regmap\uff09\uff0c\u51cf\u5c11\u5185\u5b58 load/store</li> </ul> <p>\u5728 <code>irtoc/scripts/interpreter.irt</code> \u91cc\u53ef\u4ee5\u770b\u5230\u56fa\u5b9a\u5bc4\u5b58\u5668\u5206\u914d\uff08\u793a\u4f8b\uff09\uff1a - <code>x86_64</code>: <code>dispatch=8, pc=4, frame=5, acc=11, acc_tag=3</code> - <code>arm64</code>: <code>dispatch=24, pc=20, frame=23, acc=21, acc_tag=22, moffset=25, method_ptr=26</code></p> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 CPP interpreter \u7684\u201cFrame/VReg/Acc \u6a21\u578b\u201d\u4ecd\u7136\u91cd\u8981\uff1afast interpreter \u53ea\u662f\u628a\u72b6\u6001\u201c\u7f13\u5b58\u5230\u5bc4\u5b58\u5668\u201d\uff0c\u8bed\u4e49\u4ecd\u56f4\u7ed5 Frame/VReg/Acc\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#3-dispatch-table392-handler","title":"3) dispatch table\uff1a392 \u4e2a handler \u7684\u51fd\u6570\u6307\u9488\u6570\u7ec4","text":"<p>build \u9636\u6bb5\u751f\u6210\u7684 <code>build/runtime/include/irtoc_interpreter_utils.h</code> \u63d0\u4f9b\u4e24\u5957\u8868\uff1a</p> <ul> <li><code>SetupDispatchTableImpl()</code>\uff1aIRTOC backend \u7684 <code>HANDLE_FAST_*</code></li> <li><code>SetupLLVMDispatchTableImpl()</code>\uff1aLLVM backend \u7684 <code>HANDLE_FAST_*_LLVM</code></li> </ul> <p>\u5b83\u4eec\u90fd\u8fd4\u56de <code>dispatch_table.data()</code>\uff0c\u7c7b\u578b\u662f <code>void (*)()</code> \u7684\u6570\u7ec4\u6307\u9488\uff0c\u89c4\u6a21\u4e3a 392\u3002</p> <p>\u66f4\u7cbe\u786e\u5730\u8bf4\uff1a</p> <ul> <li>fast interpreter \u7684\u8868\u957f\u5ea6\u6765\u81ea\u751f\u6210\u6a21\u677f <code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code>\uff1a</li> <li><code>392 = Panda::dispatch_table.handler_names.size() + 1</code>\uff08<code>+1</code> \u4e3a <code>HANDLE_FAST_EXCEPTION(_LLVM)</code> \u69fd\u4f4d\uff09</li> <li>\u540c\u65f6\u5b83\u4e0e C++ interpreter \u7684 label dispatch table \u540c\u957f\u5ea6\u3001\u540c ISA \u7a7a\u95f4\uff08\u56e0\u6b64\u4f60\u4f1a\u770b\u5230\u201c\u540c\u4e00\u6279 opcode+prefix\u201d\uff09\uff1a</li> <li><code>392 = 256 + NUM_PREFIXED + 1</code>\uff08\u89c1 <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u4e0e <code>isa_constants_gen.h.erb</code> \u7684 <code>EXCEPTION_HANDLER</code> \u69fd\u4f4d\u89e3\u91ca\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#4-build-build","title":"4) build \u751f\u6210\u94fe\uff08\u4f60\u5728 build/ \u91cc\u8be5\u770b\u4ec0\u4e48\uff09","text":"<p>\u4e0b\u9762\u8fd9\u6761\u94fe\u8def\u628a\u201c\u811a\u672c\u201d\u53d8\u6210\u201c\u53ef\u6267\u884c\u7684 fast interpreter\u201d\uff1a</p> <pre><code>flowchart TD\n  A[\"irtoc/scripts/interpreter.irt\\n(\u89e3\u91ca\u5668\u8bed\u4e49 + handler \u751f\u6210\u5668)\"] --&gt; B[\"build/irtoc/irtoc_interpreter/interpreter.irt.fixed\\n(\u89c4\u8303\u5316\u540e\u7684\u811a\u672c)\"]\n  B --&gt; C[\"build/irtoc/irtoc_interpreter/irtoc_code.cpp\\n(COMPILE(HANDLE_FAST_*) \u7684 Graph \u6784\u9020)\"]\n  C --&gt; D[\"build/irtoc/irtoc_interpreter/irtoc_interpreter.o\\n(\u76ee\u6807\u6587\u4ef6/\u673a\u5668\u7801)\"]\n  A --&gt; E[\"build/runtime/include/irtoc_interpreter_utils.h\\n(392 \u9879 dispatch table \u7ec4\u88c5)\\n(\u542b _LLVM \u7248\u672c)\"]\n  E --&gt; F[\"runtime/interpreter/interpreter_impl.cpp\\nSetup*DispatchTableImpl + ExecuteImplFast*\"]\n  D --&gt; F</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#41-graph-ir","title":"4.1 \u201c\u811a\u672c\u884c\u53f7 \u2192 Graph IR \u2192 \u673a\u5668\u7801\u201d\u4e09\u6bb5\u5f0f\u8ffd\u6eaf\uff08\u5ba1\u8ba1\u65b9\u6cd5\uff09","text":"<p>\u8fd9\u662f\u4f60\u505a\u6027\u80fd/\u6b63\u786e\u6027\u95ee\u9898\u65f6\u6700\u53ef\u9760\u7684\u4e00\u6761\u8bc1\u636e\u94fe\uff1a</p> <ol> <li>\u811a\u672c\u884c\u53f7\uff08\u6700\u7ec8\u4ee5 fixed \u7248\u4e3a\u51c6\uff09    \u770b <code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code> \u91cc\u7684\u884c\u53f7\uff08\u5b83\u662f <code>Loc(..., line)</code> \u7684\u6765\u6e90\uff09\u3002</li> <li>Graph IR \u8282\u70b9    \u5728 <code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code> \u91cc\u67e5 <code>Loc(DIR_0, FILE_0, &lt;line&gt;)</code>\uff0c\u5f97\u5230\u5bf9\u5e94 <code>INST(id, Opcode::Xxx)</code>\u3002</li> <li>\u6700\u7ec8\u6c47\u7f16    \u5728 <code>build/irtoc/irtoc_interpreter/disasm.txt</code> \u91cc\u627e\u5230\u540c\u540d method \u7684 <code># [inst] &lt;id&gt;</code>\uff0c\u770b\u5b83\u4e0b\u65b9\u7684\u771f\u5b9e\u673a\u5668\u7801\u3002</li> </ol> <p>\u4e00\u4e2a\u6700\u5178\u578b\u7684\u4f8b\u5b50\u662f dispatch\uff1a</p> <ul> <li><code>interpreter.irt</code> \u7684 <code>dispatch(table, pc)</code> \u5728 <code>disasm.txt</code> \u4e2d\u4f1a\u843d\u6210\uff1a <code>mov (%rcx,%rax,8), %rax</code> + <code>jmp %rax</code>\uff08computed-goto \u7684\u673a\u5668\u7801\u8bc1\u636e\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#5-4","title":"5) \u65b0\u4eba\u6392\u969c\u6293\u624b\uff08\u6700\u5e38\u89c1\u7684 4 \u4e2a\u95ee\u9898\uff09","text":"<ul> <li>\u201c\u4e3a\u4ec0\u4e48\u6211\u770b C++ handler \u6539\u4e86\u6ca1\u751f\u6548\uff1f\u201d\uff1a\u4f60\u53ef\u80fd\u8fd0\u884c\u7684\u662f <code>--interpreter-type=llvm/irtoc</code>\uff0c\u5b9e\u9645\u8d70\u7684\u662f fast interpreter \u7684 <code>HANDLE_FAST_*</code>\uff08\u6765\u81ea IRTOC \u751f\u6210\uff09\u3002</li> <li>\u201c\u4e3a\u4ec0\u4e48\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4\u4e0d\u662f llvm\uff1f\u201d\uff1a<code>GetInterpreterTypeFromRuntimeOptions</code> \u660e\u786e\uff1a\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4\u7528 cpp\uff08\u9664\u975e\u663e\u5f0f\u8bbe\u7f6e option\uff09\u3002</li> <li>\u201cdebug-mode \u4e3a\u4ec0\u4e48\u5fc5\u987b cpp\uff1f\u201d\uff1a<code>ExecuteImpl</code> \u4f1a\u76f4\u63a5 <code>LOG(FATAL)</code> \u9650\u5236 <code>--debug-mode=true</code> \u53ea\u80fd\u914d <code>--interpreter-type=cpp</code>\u3002</li> <li>\u201cllvm/irtoc \u4e3a\u5565\u88ab\u964d\u7ea7\uff1f\u201d\uff1a\u6839\u636e\u7f16\u8bd1\u5f00\u5173\uff08<code>PANDA_LLVM_INTERPRETER</code> / <code>PANDA_WITH_IRTOC</code>\uff09\u4e0e GC \u7c7b\u578b\uff0c\u4f1a\u628a\u9ed8\u8ba4\u503c\u964d\u7ea7\u5230\u53ef\u7528\u5b9e\u73b0\uff08\u89c1 <code>interpreter_impl.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#6-vm-irt","title":"6) VM \u67b6\u6784\u5e08\u89c6\u89d2\uff1a<code>.irt</code> \u662f\u4ec0\u4e48\uff1f\u4f60\u9700\u8981\u638c\u63e1\u5230\u4ec0\u4e48\u7a0b\u5ea6\u624d\u7b97\u201c\u4f1a\u6539\u201d","text":"<p>\u65b0\u4eba\u7406\u89e3 IRTOC \u7684\u95e8\u69db\u901a\u5e38\u4e0d\u662f\u201c\u770b\u61c2 dispatch table\u201d\uff0c\u800c\u662f\uff1a</p> <ul> <li>\u4e0d\u77e5\u9053 <code>.irt</code> \u662f Ruby DSL\uff08\u4ee5\u811a\u672c\u5f62\u5f0f\u6784\u9020 IR Graph\uff09</li> <li>\u4e0d\u77e5\u9053\u54ea\u4e9b\u8bed\u6cd5\u662f Ruby\uff0c\u54ea\u4e9b\u8bed\u6cd5\u662f IR \u8282\u70b9\u6784\u9020\u5668\uff08<code>LoadI/AddI/If/Phi/Intrinsic...</code>\uff09</li> <li>\u4e0d\u77e5\u9053\u5e94\u8be5\u6539\u54ea\u91cc\uff08dispatch\uff1fdecode\uff1fcall\uff1fOSR\uff1f\u5f02\u5e38\uff1f\uff09</li> <li>\u4e0d\u77e5\u9053\u5982\u4f55\u9a8c\u8bc1\u201c\u6539\u52a8\u771f\u7684\u8fdb\u5165\u673a\u5668\u7801\u201d\uff08\u53ea\u770b\u8fd0\u884c\u7ed3\u679c\u5bb9\u6613\u8bef\u5224\uff09</li> </ul> <p>\u56e0\u6b64\u5efa\u8bae\u628a\u5b66\u4e60\u62c6\u6210\u4e09\u6b65\uff1a</p> <p>1) \u80fd\u8bc6\u522b\u7ed3\u6784\uff1a<code>macro</code>/<code>handler</code>/<code>Panda.instructions.each</code> \u751f\u6210\u6bb5\u5404\u8d1f\u8d23\u4ec0\u4e48 2) \u80fd\u505a\u5c0f\u6539\u52a8\uff1a\u6539\u4e00\u4e2a\u5b8f\u6216\u4e00\u4e2a handler \u7684\u4e00\u5c0f\u6bb5\u903b\u8f91 3) \u80fd\u505a\u95ed\u73af\u9a8c\u8bc1\uff1a<code>.irt.fixed \u2192 irtoc_code.cpp \u2192 disasm.txt</code> \u4e09\u6bb5\u5f0f\u8bc1\u636e\u94fe</p> <p>\u5bf9\u5e94\u5de5\u5177\u4e66\uff1a</p> <ul> <li>IRTOC_DSL_Primer\uff08Flow\uff09\uff08\u65b0\u4eba\u5de5\u5177\u4e66\uff1a\u6700\u5c0f\u8bed\u6cd5\u96c6 + \u6539\u52a8\u843d\u70b9\u8868 + \u9a8c\u8bc1\u95ed\u73af\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1airtoc_scripts_common.irt\u3001irtoc_scripts_interpreter.irt</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#7-3","title":"7) \u5178\u578b\u201c\u6539\u52a8\u6a21\u5f0f\u201d\u901f\u67e5\uff08\u65b0\u4eba\u6700\u5bb9\u6613\u4e0a\u624b\u7684 3 \u7c7b\uff09","text":"<p>\u8fd9\u4e0d\u662f\u8ba9\u4f60\u7b2c\u4e00\u6b21\u5c31\u6539\u590d\u6742 opcode\uff1b\u800c\u662f\u8ba9\u4f60\u77e5\u9053\u201c\u6539\u52a8\u843d\u70b9\u201d\u957f\u4ec0\u4e48\u6837\u3002</p> <ul> <li>\u6539 decode/operand \u8bfb\u53d6\uff08\u5f71\u54cd\u9762\u5927\uff0c\u4f46\u6a21\u5f0f\u7a33\u5b9a\uff09</li> <li>\u843d\u70b9\uff1a<code>macro(:readbyte)</code>\u3001<code>macro(:as_vreg_idx)</code>\u3001<code>macro(:as_id)</code></li> <li>\u4f55\u65f6\u6539\uff1a\u4f60\u65b0\u589e/\u53d8\u66f4\u4e86 operand \u7f16\u7801\u3001\u6216\u53d1\u73b0\u67d0\u7c7b operand \u5728\u67d0 arch \u4e0b\u8bfb\u9519</li> <li>\u6539\u8fb9\u754c\u4e0d\u53d8\u91cf\uff08acc/pc/thread state\uff09</li> <li>\u843d\u70b9\uff1a<code>save_acc/restore_acc</code>\u3001<code>update_bytecode_offset</code>\u3001<code>safepoint</code></li> <li>\u4f55\u65f6\u6539\uff1a\u4f60\u9047\u5230 GC/safepoint/\u5f02\u5e38\u8fb9\u754c\u76f8\u5173\u7684\u5076\u73b0\u9519\uff08\u5148\u786e\u4fdd\u4f60\u7406\u89e3\u4e0d\u53d8\u91cf\uff0c\u518d\u52a8\u5b83\uff09</li> <li>\u6539\u9ad8\u5c42\u63a7\u5236\u6d41\uff08call/return/OSR/exception\uff09</li> <li>\u843d\u70b9\uff1a<code>generic_call</code>/<code>generic_return</code>\u3001<code>instrument_branches</code>/<code>handle_fake_return</code>\u3001<code>move_to_exception</code>/<code>find_catch_block</code></li> <li>\u4f55\u65f6\u6539\uff1a\u4f60\u5728\u201c\u89e3\u91ca\u5668\u2194compiled \u8fb9\u754c\u201d\u770b\u5230\u8bed\u4e49\u4e0d\u4e00\u81f4\u6216\u96be\u590d\u73b0\u7684\u63a7\u5236\u6d41\u9519\u8bef</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#_1","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\uff09","text":"<ul> <li>\u8fd0\u884c\u65f6\u9009\u62e9\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>IRTOC \u89e3\u91ca\u5668\u8bed\u4e49\uff1a<code>irtoc/scripts/interpreter.irt</code></li> <li>build \u4ea7\u7269\uff08\u672c\u673a\u8bc1\u636e\uff09\uff1a<code>build/runtime/include/irtoc_interpreter_utils.h</code>\u3001<code>build/irtoc/irtoc_interpreter/*</code></li> <li>\u673a\u5668\u7801\u8bc1\u636e\uff1a<code>build/irtoc/irtoc_interpreter/disasm.txt</code>\uff08\u53ef\u7528\u6765\u9a8c\u8bc1 tail-call dispatch/exception slot \u7b49\u5173\u952e\u7ea6\u5b9a\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/IRTOC_FastInterpreter/#_2","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201c\u9009\u578b\u89c4\u5219 + dispatch table + build \u751f\u6210\u94fe\uff08Flow \u7248\uff09\u201d \u2192 IRTOC_FastInterpreter\uff08Flow\uff09</li> <li>\u60f3\u4ece\u201copcode\u2192handler\u2192runtime \u4ea4\u754c\u9762\u201d\u5efa\u7acb\u76f4\u89c9 \u2192 Opcode_DeepDives_IRTOC\uff08Flow\uff09</li> <li>\u60f3\u641e\u6e05\u201copcode \u5b9a\u4e49\u5982\u4f55\u9a71\u52a8\u751f\u6210\u201d \u2192 ISA_and_OpcodeModel</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/","title":"ISA \u4e0e Opcode Model\uff08<code>isa/isa.yaml</code> + <code>plugins/ets/isa/isa.yaml</code>\uff09","text":"<p>\u672c\u5361\u7247\u56de\u7b54\uff1a\u201copcode \u7684\u5b9a\u4e49\u5728\u54ea\u91cc\uff1f\u5b83\u5982\u4f55\u9a71\u52a8\u89e3\u91ca\u5668/JIT/IRTOC \u751f\u6210\uff1f\u201d \u7ed3\u8bba\uff1a<code>isa/isa.yaml</code> \u662f core bytecode \u7684\u89c4\u8303\u6e90\uff1b\u8bed\u8a00\u63d2\u4ef6\uff08\u5982 ETS\uff09\u901a\u8fc7 <code>plugins/ets/isa/isa.yaml</code> \u589e\u52a0 prefix/\u6307\u4ee4\u6269\u5c55\u3002 IRTOC \u7684 <code>interpreter.irt</code> \u4f7f\u7528 <code>Panda.instructions</code> \u904d\u5386 ISA\uff0c\u81ea\u52a8\u751f\u6210 <code>HANDLE_FAST_*</code>\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\u201d\u4e0e\u201cfast interpreter\uff08IRTOC/LLVM\uff09\u201d\u76f8\u5173\u6846\uff1aISA \u662f opcode/handler \u7684\u89c4\u8303\u6e90\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#1-isa-yaml","title":"1) ISA YAML \u7684\u7ed3\u6784\uff08\u4f60\u9700\u8981\u638c\u63e1\u7684\u5b57\u6bb5\uff09","text":"<ul> <li>chapters\uff1a\u9ad8\u5c42\u6982\u5ff5\uff08register-based + accumulator calling sequence \u7b49\uff09\uff0c\u8fd9\u90e8\u5206\u5c31\u662f\u201c\u89c4\u8303\u6587\u5b57\u201d\u3002</li> <li>properties\uff1a\u6307\u4ee4\u7684\u8bed\u4e49\u6807\u7b7e\uff08\u5982 <code>method_id/field_id/call/return/jump/init_obj</code>\uff09\uff0c\u7528\u4e8e\u751f\u6210\u5668/\u9a8c\u8bc1\u5668/\u7f16\u8bd1\u5668\u505a\u5206\u7ec4\u4e0e\u7b56\u7565\u3002</li> <li>exceptions\uff1a\u8be5\u6307\u4ee4\u53ef\u80fd\u629b\u51fa\u7684\u5f02\u5e38\u7c7b\u522b\uff08\u5982 <code>x_null/x_call/x_oom</code>\uff09\u3002</li> <li>verification\uff1a\u9a8c\u8bc1\u5668\u5bf9\u64cd\u4f5c\u6570/acc \u7c7b\u578b\u7684\u7ea6\u675f\uff08\u5982 <code>acc_obj_or_null</code>\u3001<code>branch_target</code>\uff09\u3002</li> <li>prefixes\uff1a\u524d\u7f00 opcode\uff08core \u91cc\u6709 <code>any/f32/cast/unsigned/bit</code> \u7b49\uff09\uff0c\u7528\u4e8e\u6269\u5c55\u7f16\u7801\u7a7a\u95f4\u3002</li> <li>groups / instructions\uff1a</li> <li>group \u63d0\u4f9b\u4eba\u7c7b\u53ef\u8bfb\u7684 description + pseudo code</li> <li>instructions \u7ed9\u51fa <code>sig/acc/format/opcode_idx/(prefix)</code> \u7b49\u201c\u53ef\u751f\u6210\u201d\u7684\u7cbe\u786e\u63cf\u8ff0</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#2-ets-isa-plugin","title":"2) ETS ISA \u6269\u5c55\uff08plugin\uff09\u7684\u89d2\u8272","text":"<p><code>plugins/ets/isa/isa.yaml</code> \u505a\u4e24\u4ef6\u4e8b\uff1a</p> <ul> <li>\u58f0\u660e prefix <code>ets</code>\uff1a\u628a ETS \u6307\u4ee4\u653e\u8fdb\u4e00\u4e2a\u72ec\u7acb\u7684 opcode \u7a7a\u95f4\uff08\u901a\u8fc7 pref_op_* \u683c\u5f0f\u7f16\u7801\uff09\u3002</li> <li>\u5b9a\u4e49 ETS \u7279\u6709\u6307\u4ee4\u65cf\uff1a\u4f8b\u5982\uff1a</li> <li><code>ets.ldobj.name*</code> / <code>ets.stobj.name*</code>\uff1a\u6309\u540d\u5b57\u89e3\u6790 field/getter/setter</li> <li><code>ets.call.name*</code>\uff1a\u6309\u540d\u5b57\u89e3\u6790 method \u5e76\u8c03\u7528</li> </ul> <p>\u8fd9\u4e9b\u6269\u5c55\u4f1a\u5f71\u54cd\uff1a - fast interpreter \u7684 <code>HANDLE_FAST_ETS_*</code> \u751f\u6210 - \u7f16\u8bd1\u5668\u7684 ETS intrinsics\uff08<code>intrinsic_name</code> \u5b57\u6bb5\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#3-isa-handler-name-dispatch-table","title":"3) \u201cISA \u2192 handler name \u2192 dispatch table\u201d \u7684\u5173\u952e\u6620\u5c04","text":"<p>\u4f60\u5728 fast interpreter \u4e2d\u770b\u5230\u7684\u540d\u5b57\u94fe\u8def\u901a\u5e38\u662f\uff1a</p> <pre><code>flowchart TD\n  ISA[\"ISA YAML\\n(sig/format/prefix/opcode_idx)\"] --&gt; HN[\"handler_name\\n(\u751f\u6210\u5668\u51b3\u5b9a\u547d\u540d)\"]\n  HN --&gt; HF[\"HANDLE_FAST_&lt;handler_name&gt;\\n(IRTOC \u751f\u6210\u51fd\u6570)\"]\n  HF --&gt; DT[\"dispatch_table[opc]\\n(build/runtime/include/irtoc_interpreter_utils.h)\"]\n  DT --&gt; DISPATCH[\"tail-call dispatch\\n(jmp %reg)\"]</code></pre> <p>\u65b0\u4eba\u5e38\u89c1\u8bef\u533a\uff1a - \u201c\u6211\u6539\u4e86 C++ handler \u600e\u4e48\u6ca1\u751f\u6548\uff1f\u201d\uff1a\u56e0\u4e3a\u9ed8\u8ba4\u8dd1\u7684\u662f fast interpreter\uff0c\u800c\u5b83\u7684 handler \u6765\u81ea ISA\u2192IRTOC \u751f\u6210\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#4-04","title":"4) \u4e0e 04 \u7ae0\u5176\u4ed6\u5185\u5bb9\u7684\u8fde\u63a5","text":"<ul> <li>IRTOC fast interpreter\uff1aIRTOC_FastInterpreter\uff08DataStructure\uff09</li> <li>IRTOC \u8bed\u4e49\u5b9e\u73b0\uff1airtoc_scripts_interpreter.irt\uff08FileNotes\uff09</li> <li>dispatch table \u7ec4\u88c5\uff1abuild_runtime_include_irtoc_interpreter_utils.h\uff08FileNotes\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/ISA_and_OpcodeModel/#_1","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u628a\u201cISA\u2192handler\u2192dispatch table\u2192\u673a\u5668\u7801\u201d\u4e32\u8d77\u6765 \u2192 IRTOC_FastInterpreter\uff08DataStructure\uff09 \u4e0e IRTOC_FastInterpreter\uff08Flow\uff09</li> <li>\u60f3\u4ece\u51e0\u4e2a\u5e38\u7528 opcode \u76f4\u63a5\u4e0b\u6f5c\u5230\u751f\u6210/\u5b9e\u73b0\u7ec6\u8282 \u2192 Opcode_DeepDives_IRTOC\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/Index/","title":"04_ExecutionEngine / DataStructures","text":"<p>\u672c\u76ee\u5f55\u662f\u201c\u7ed3\u6784\u5361\u7247\u201d\uff1a\u5b83\u662f\u4ec0\u4e48\u3001\u5173\u952e\u4e0d\u53d8\u91cf\u3001\u8c01\u5199\u8c01\u8bfb\u3001\u5e38\u89c1\u5751\uff08\u53ef\u7528\u4e8e code review/\u6392\u969c\uff09\u3002</p>"},{"location":"04_ExecutionEngine/DataStructures/Index/#_1","title":"\u5361\u7247\u6e05\u5355\uff08\u5efa\u8bae\u987a\u5e8f\uff09","text":"<ol> <li>Frame_VReg_Acc\uff1aFrame/VRegister/Acc \u7684\u8bed\u4e49\u4e0e\u5e03\u5c40\uff08\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u5dee\u5f02\uff09</li> <li>Entrypoint_and_MethodDispatch\uff1aMethod \u7684 entrypoint/compiled code/OSR code \u4e0e dispatch \u51b3\u7b56</li> <li>Bridge_ABI_and_FrameKind\uff1aI2C/C2I \u6865\u63a5\u8fb9\u754c\u3001FrameKind \u5207\u6362\u3001\u8fd4\u56de\u503c/\u5f02\u5e38\u8bed\u4e49</li> <li>StackWalker\uff1a\u6808\u904d\u5386\u62bd\u8c61\uff08\u89e3\u91ca\u5668\u5e27/\u7f16\u8bd1\u5e27\u7edf\u4e00\u89c6\u56fe\uff09</li> <li>Deopt_and_OSR\uff1a\u53bb\u4f18\u5316\u4e0e OSR \u7684\u6838\u5fc3\u6982\u5ff5\u4e0e\u4e0d\u53d8\u91cf</li> <li>Entrypoints\uff1a\u8fd0\u884c\u65f6\u5165\u53e3\uff08\u6162\u8def\u5f84\uff09\u7684\u5206\u7c7b\u4e0e\u8c03\u7528\u7ea6\u5b9a\uff08\u9ad8\u5c42\u6982\u5ff5\uff09</li> <li>IRTOC_FastInterpreter\uff1a\u771f\u5b9e\u573a\u666f\u9ed8\u8ba4\u7684\u89e3\u91ca\u5668\u5b9e\u73b0\uff08IRTOC/LLVM fast interpreter\uff09\u4e0e build \u751f\u6210\u94fe</li> <li>\u65b0\u4eba\u6539 IRTOC \u5fc5\u8bfb\uff1aFlows/IRTOC_DSL_Primer\uff08<code>.irt</code> \u8bed\u6cd5/\u843d\u70b9/\u9a8c\u8bc1\u95ed\u73af\uff09</li> <li>ISA_and_OpcodeModel\uff1aISA\uff08core+ETS\uff09\u5982\u4f55\u5b9a\u4e49 opcode\uff0c\u4ee5\u53ca\u5982\u4f55\u9a71\u52a8 IRTOC/\u7f16\u8bd1\u5668\u751f\u6210</li> </ol>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/","title":"StackWalker\uff08\u7edf\u4e00\u6808\u904d\u5386\u62bd\u8c61\uff09","text":""},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08Flow\uff09\uff08\u201c\u5f02\u5e38/\u6808\u904d\u5386\uff08\u8c03\u8bd5/\u5f02\u5e38/\u53bb\u4f18\u5316\u90fd\u4f1a\u7528\uff09\u201d\u6846\uff1aStackWalker \u4e32\u8d77\u89e3\u91ca\u5668\u5e27/\u7f16\u8bd1\u5e27/\u8fb9\u754c\u5e27\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#_1","title":"\u5b83\u662f\u4ec0\u4e48","text":"<p><code>StackWalker</code> \u8d1f\u8d23\u628a\u201c\u5f53\u524d\u7ebf\u7a0b\u7684\u6267\u884c\u6808\u201d\u62bd\u8c61\u6210\u53ef\u904d\u5386\u7684\u5e8f\u5217\uff0c\u5373\u4fbf\u6808\u91cc\u540c\u65f6\u5b58\u5728\uff1a - \u89e3\u91ca\u5668\u5e27\uff08Frame/VRegs/PC\uff09 - \u7f16\u8bd1\u5e27\uff08\u4f9d\u8d56 code info/\u5bc4\u5b58\u5668\u4fdd\u5b58\u7ea6\u5b9a\uff09 - \u6865\u63a5\u5e27\uff08I2C/C2I \u8fb9\u754c\uff09</p> <p>\u5b83\u670d\u52a1\u4e8e\uff1a - \u8c03\u8bd5/\u4fe1\u53f7 dump - \u5f02\u5e38 unwind \u4e0e\u6808\u6253\u5370 - profiler/\u91c7\u6837 - deopt/OSR \u7684\u8fb9\u754c\u5224\u5b9a\uff08\u54ea\u4e9b\u5e27\u80fd\u6062\u590d/\u5982\u4f55\u6062\u590d\uff09</p>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#_2","title":"\u5173\u952e\u4e0d\u53d8\u91cf","text":"<ul> <li>FrameKind \u5fc5\u987b\u53ef\u4fe1\uff1a\u5426\u5219 StackWalker \u4f1a\u628a\u201c\u89e3\u91ca\u5668\u5e27\u5f53\u7f16\u8bd1\u5e27\u201d\u6216\u53cd\u4e4b\uff0c\u5bfc\u81f4\u5d29\u6e83\u6216\u7f3a\u5e27\u3002</li> <li>\u8fb9\u754c\u5e27\u5fc5\u987b\u53ef\u8bc6\u522b\uff1a\u6865\u63a5\u901a\u5e38\u4f1a\u7528\u7279\u5b9a layout/\u6807\u8bb0\u8ba9 walker \u80fd\u6b63\u786e\u8de8\u8d8a\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#stackwalker_1","title":"\u65b0\u4eba\u53cb\u597d\u8865\u5145\uff1aStackWalker \u201c\u770b\u5230\u7684\u6808\u201d\u4e0d\u7b49\u4e8e\u201c\u7269\u7406\u6808\u5e27\u6570\u201d","text":"<p>StackWalker \u4f1a\u628a\u4ee5\u4e0b\u4e09\u7c7b\u5dee\u5f02\u7edf\u4e00\u6210\u201c\u903b\u8f91\u5e27\u5e8f\u5217\u201d\uff1a</p> <ul> <li>inlined frames\uff1a\u4e00\u4e2a\u7f16\u8bd1\u5e27\uff08CFrame\uff09\u91cc\u53ef\u80fd\u5305\u542b\u591a\u4e2a\u5185\u8054\u65b9\u6cd5\uff1bwalker \u4f1a\u628a\u5b83\u4eec\u62c6\u6210\u591a\u4e2a\u903b\u8f91\u5e27\uff08method/pc \u4e0d\u540c\uff09\u3002</li> <li>boundary frames\uff1a\u6865\u63a5\u8fb9\u754c\uff08I2C/C2I\uff09\u662f\u201c\u7269\u7406\u4e0a\u5b58\u5728\u3001\u8bed\u4e49\u4e0a\u662f\u8fc7\u6e21\u201d\u7684\u5e27\uff1bwalker \u4f1a\u6309\u89c4\u5219\u8df3\u8fc7\u6216\u8f6c\u6362\u5b83\u4eec\u3002</li> <li>deopt/\u5f02\u5e38\u8054\u52a8\uff1a\u5f02\u5e38\u5904\u7406\u53ef\u80fd\u5148\u5728\u89e3\u91ca\u5668 stackless \u5e27\u5185 unwind\uff0c\u518d\u8fdb\u5165 CFrame \u641c\u7d22\u5e76 deopt \u56de\u89e3\u91ca\u5668\uff1bwalker \u662f\u628a\u8fd9\u4e24\u6bb5\u4e32\u8d77\u6765\u7684\u7edf\u4e00\u5de5\u5177\u3002</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#checklist","title":"\u6392\u969c checklist\uff08\u7f3a\u5e27/\u9519\u5e27\u65f6\u5148\u770b\u8fd9\u4e09\u70b9\uff09","text":"<ul> <li>currentFrameIsCompiled \u4e0e currentFrame \u6307\u9488\u662f\u5426\u5339\u914d\u5f53\u524d\u6267\u884c\u4fa7\uff08\u6865\u63a5/InvokeInterpreter/deopt \u5e38\u5207\u6362\uff09</li> <li>\u662f\u5426\u8e29\u5230\u4e86 boundary frame\uff08I2C/C2I\uff09\u4f46\u672a\u6b63\u786e\u8bc6\u522b\uff08\u8868\u73b0\u4e3a\u4e0a\u4e00\u5e27\u8df3\u9519\uff09</li> <li>\u662f\u5426\u5904\u4e8e inlined method \u5c55\u5f00\uff08\u8868\u73b0\u4e3a\u201c\u4e00\u4e2a\u7269\u7406\u5e27\u5bf9\u5e94\u591a\u4e2a method\u201d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#mermaidstackwalker","title":"Mermaid\uff1aStackWalker \u7684\u9ad8\u5c42\u89c6\u56fe","text":"<pre><code>flowchart TD\n  A[\"Thread\"] --&gt; B[\"StackWalker::Create(thread)\"]\n  B --&gt; C{\"\u5f53\u524d\u5e27\u7c7b\u578b\uff1f\\n(FrameKind/\u6808\u6807\u8bb0)\"}\n  C --&gt;|Interpreter| D[\"\u8bfb\u53d6 Frame \u94fe\\n(pc/vregs/acc)\"]\n  C --&gt;|Compiled| E[\"\u8bfb\u53d6 code info\\n(\u5bc4\u5b58\u5668/\u6808\u69fd\u6620\u5c04)\"]\n  C --&gt;|Bridge/Boundary| F[\"\u6309\u8fb9\u754c\u89c4\u5219\u8df3\u8f6c\u5230\u4e0a\u4e00\u5e27\"]\n  D --&gt; G[\"Yield FrameInfo\\n(\u65b9\u6cd5/pc/\u7c7b\u578b)\"]\n  E --&gt; G\n  F --&gt; C</code></pre>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#_3","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/include/stack_walker.h</code></li> <li><code>runtime/stack_walker.cpp</code></li> <li>\u4ea4\u754c\u9762\uff1a<code>runtime/bridge/bridge.cpp</code>\u3001<code>runtime/deoptimization.*</code></li> <li>\u5f02\u5e38\u8de8\u5e27\uff1a<code>runtime/include/exceptions.h</code>\u3001<code>runtime/exceptions.cpp</code></li> </ul>"},{"location":"04_ExecutionEngine/DataStructures/StackWalker/#_4","title":"\u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u60f3\u770b\u201cStackWalking \u4e3b\u8c03\u7528\u94fe\uff08\u542b\u5f02\u5e38\u4e24\u6bb5\u5f0f\uff09\u201d \u2192 StackWalking\uff08Flow\uff09</li> <li>\u60f3\u770b\u201c\u8fb9\u754c\u5e27/FrameKind \u5bf9\u904d\u5386\u7684\u5f71\u54cd\uff08\u6700\u5e38\u89c1\u7f3a\u5e27\u6839\u56e0\uff09\u201d \u2192 Bridge_ABI_and_FrameKind\uff08DataStructure\uff09 \u6216 Bridge_I2C_C2I\uff08Flow\uff09</li> <li>\u60f3\u770b\u201cdeopt-after \u4e0e StackWalker \u7684\u4ea4\u754c\u201d \u2192 Deopt_and_OSR\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Diagrams/Index/","title":"04 ExecutionEngine / Diagrams / Index","text":"<p>\u672c\u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u672c\u7ae0\u7684 \u8865\u5145\u56fe\uff08Mermaid \u6e90\u6587\u4ef6 / \u67b6\u6784\u8349\u56fe\uff09\u3002</p> <p>\u5f53\u524d\u56fe\u4e3b\u8981\u96c6\u4e2d\u5728\uff1a - Flows/ExecutionEngine_EndToEnd - \u5404 Flow \u6587\u6863\u5185\u90e8\u7684 Mermaid \u56fe</p> <p>\u540e\u7eed\u5982\u679c\u9700\u8981\u628a\u5927\u578b\u56fe\u62bd\u79bb\u6210\u72ec\u7acb <code>.mmd</code>\uff0c\u53ef\u4ee5\u653e\u5230\u672c\u76ee\u5f55\u5e76\u5728\u8fd9\u91cc\u8865\u94fe\u63a5\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/Index/","title":"04 ExecutionEngine / FileNotes / Index","text":"<p>\u672c\u76ee\u5f55\u662f \u6e90\u7801\u8bc1\u636e\u94fe\u5361\u7247\uff1a\u6bcf\u4e2a\u6587\u4ef6\u4e00\u9875\uff0c\u8bf4\u660e\u201c\u8d1f\u8d23\u4ec0\u4e48\u3001\u5173\u952e\u5165\u53e3\u3001\u5e38\u89c1\u5751\u3001\u4e0e Flows/DataStructures \u7684\u5bf9\u5e94\u5173\u7cfb\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/Index/#_1","title":"\u5feb\u901f\u5165\u53e3","text":"<ul> <li>\u672f\u8bed\u8868\uff1a_Glossary</li> <li>\u89e3\u91ca\u5668\u9009\u578b/\u6267\u884c\u5165\u53e3\uff08\u5173\u952e\uff09\uff1aruntime_interpreter_interpreter_impl.cpp</li> <li>\u89e3\u91ca\u5668\u6a21\u677f\u751f\u6210\uff08\u4e3b\u5faa\u73af/\u5f02\u5e38\u69fd\u4f4d\u6765\u6e90\uff09\uff1aruntime_interpreter_templates_interpreter-inl_gen.h.erb</li> <li>Bridge \u9aa8\u67b6\uff08InvokeInterpreter \u7b49\uff09\uff1aruntime_bridge_bridge.cpp</li> <li>Entrypoints\uff1aruntime_entrypoints_entrypoints.cpp</li> <li>OSR\uff1aruntime_osr.cpp</li> <li>StackWalker\uff1aruntime_stack_walker.cpp</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/Index/#_2","title":"\u8bf4\u660e","text":"<ul> <li>\u672c\u7ae0\u6587\u4ef6\u5f88\u591a\uff0c\u5b8c\u6574\u5217\u8868\u8bf7\u770b\uff1aAll_Pages\uff08\u5168\u91cf\u9875\u9762\u7d22\u5f15\uff09\uff08\u53ef\u641c\u7d22 <code>04_ExecutionEngine/FileNotes/</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/_Glossary/","title":"04_ExecutionEngine / FileNotes \u672f\u8bed\u901f\u67e5\uff08Glossary\uff09","text":"<p>\u8bfb 04 \u7ae0\u65f6\u6700\u5e38\u8ff7\u8def\u7684\u662f\uff1aFrame/VReg/Acc \u4e0e entrypoint/bridge/deopt/OSR \u7684\u8fb9\u754c\u3002 \u8fd9\u91cc\u628a\u5173\u952e\u540d\u8bcd\u7edf\u4e00\u89e3\u91ca\uff0c\u5e76\u5c3d\u91cf\u7ed9\u51fa\u672c\u7ae0\u5185\u7684\u8df3\u8f6c\uff08\u4e0d\u5f3a\u5236\u8de8\u7ae0\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/_Glossary/#_1","title":"\u6267\u884c\u72b6\u6001\u4e0e\u5e27","text":"<ul> <li>PC\uff08program counter\uff09\uff1a\u5f53\u524d\u89e3\u91ca\u6267\u884c\u5230\u7684\u5b57\u8282\u7801\u4f4d\u7f6e\uff08\u6307\u4ee4\u5730\u5740/\u504f\u79fb\uff09\u3002\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u4e0d\u65ad\u201c\u53d6\u6307\u2192\u6267\u884c\u2192\u66f4\u65b0 PC\u201d\u3002</li> <li>Frame\uff08\u89e3\u91ca\u5668\u5e27\uff09\uff1a\u89e3\u91ca\u5668\u7684\u201c\u6267\u884c\u4e0a\u4e0b\u6587\u201d\uff0c\u901a\u5e38\u5305\u542b\uff1a</li> <li>\u5f53\u524d Method/Bytecode \u7684\u5f15\u7528</li> <li>vreg \u6570\u7ec4\uff08\u865a\u62df\u5bc4\u5b58\u5668\uff09</li> <li>accumulator\uff08acc\uff09</li> <li>\u4e0a\u4e00\u5e27\u94fe\u63a5\uff08\u7528\u4e8e\u8fd4\u56de/\u5f02\u5e38 unwind\uff09</li> <li>FrameKind\uff08\u89e3\u91ca\u5668/\u7f16\u8bd1\u6001\u8fb9\u754c\u8bc6\u522b\uff09</li> <li>VRegister\uff08vreg\uff09\uff1a\u865a\u62df\u5bc4\u5b58\u5668\u69fd\u4f4d\uff0c\u627f\u8f7d\u5c40\u90e8\u53d8\u91cf/\u4e34\u65f6\u503c\u3002\u5e38\u89c1\u5b9e\u73b0\u662f 64-bit payload +\uff08\u9759\u6001\u8bed\u8a00\uff09mirror/tag\u3002</li> <li>Acc\uff08accumulator\uff09\uff1a\u7d2f\u52a0\u5668\u5bc4\u5b58\u5668\uff0c\u5f88\u591a\u6307\u4ee4\u4ee5 acc \u4f5c\u4e3a\u9690\u5f0f\u8f93\u5165/\u8f93\u51fa\uff08\u7c7b\u4f3c\u201c\u6808\u9876\u4f46\u4e0d\u662f\u6808 VM\u201d\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/_Glossary/#entrypoint-bridge","title":"entrypoint / bridge","text":"<ul> <li>entrypoint\uff08\u65b9\u6cd5\u5165\u53e3\u70b9\uff09\uff1a<code>Method</code> \u4e0a\u4fdd\u5b58\u7684\u201c\u4e0b\u4e00\u6b21\u8c03\u7528\u8be5\u65b9\u6cd5\u5e94\u8be5\u8df3\u5230\u54ea\u91cc\u201d\u7684\u6307\u9488\uff1a</li> <li>\u89e3\u91ca\u5668\u5165\u53e3\uff08\u6216 C2I bridge\uff09</li> <li>\u5df2\u7f16\u8bd1\u4ee3\u7801\u5165\u53e3\uff08JIT/AOT\uff09</li> <li>native \u5165\u53e3\uff08ANI \u7b49\uff0c\u8de8\u7ae0 05\uff09</li> <li>I2C\uff08Interpreter-to-Compiled\uff09\uff1a\u89e3\u91ca\u5668\u8c03\u7528\u7f16\u8bd1\u4ee3\u7801\u7684\u6865\u63a5\u3002</li> <li>C2I\uff08Compiled-to-Interpreter\uff09\uff1a\u7f16\u8bd1\u4ee3\u7801\u56de\u9000\u89e3\u91ca\u5668\u7684\u6865\u63a5\uff08deopt/\u5f02\u5e38/\u6162\u8def\u5f84\u5e38\u89c1\uff09\u3002</li> <li>FrameKind\uff1a\u533a\u5206\u5f53\u524d\u6808\u5e27\u5c5e\u4e8e\u89e3\u91ca\u5668\u8fd8\u662f\u7f16\u8bd1\u4ee3\u7801\uff08StackWalker/Deopt \u9700\u8981\u9760\u5b83\u505a\u6b63\u786e\u904d\u5386/\u91cd\u5efa\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/_Glossary/#deopt-osr-stack-walking","title":"deopt / OSR / stack walking","text":"<ul> <li>deoptimization\uff08\u53bb\u4f18\u5316\uff09\uff1a\u5f53\u7f16\u8bd1\u4ee3\u7801\u4f9d\u8d56\u7684\u5047\u8bbe\u5931\u6548\u6216\u9700\u8981\u56de\u9000\u65f6\uff0c\u628a\u201c\u7f16\u8bd1\u6001\u6267\u884c\u72b6\u6001\u201d\u6062\u590d\u6210\u201c\u89e3\u91ca\u5668\u53ef\u7ee7\u7eed\u6267\u884c\u7684 Frame/VRegs/PC/Acc\u201d\u3002</li> <li>OSR\uff08On-Stack Replacement\uff09\uff1a\u5728\u65b9\u6cd5/\u5faa\u73af\u6267\u884c\u4e2d\u9014\uff0c\u628a\u89e3\u91ca\u5668\u5e27\u5207\u6362\u5230\u201cOSR \u7f16\u8bd1\u7248\u672c\u201d\u7ee7\u7eed\u8dd1\uff08\u5e38\u89c1\u89e6\u53d1\u70b9\uff1a\u5faa\u73af\u56de\u8fb9\uff09\u3002</li> <li>StackWalker\uff1a\u7edf\u4e00\u6808\u904d\u5386\u62bd\u8c61\uff1a\u65e2\u80fd\u904d\u5386\u89e3\u91ca\u5668\u5e27\uff0c\u4e5f\u80fd\u904d\u5386\u7f16\u8bd1\u5e27\uff1b\u670d\u52a1\u4e8e\u8c03\u8bd5\u3001\u5f02\u5e38\u3001profiling\u3001\u4ee5\u53ca deopt/OSR \u8fb9\u754c\u5224\u65ad\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/_Glossary/#_2","title":"\u7f16\u8bd1\u5668\u63a5\u53e3\uff08\u63a5\u53e3\u89c6\u89d2\uff09","text":"<ul> <li>PandaRuntimeInterface\uff08runtime/compiler.*\uff09\uff1aruntime \u4fa7\u63d0\u4f9b\u7ed9 compiler \u7684\u63a5\u53e3\uff1a\u89e3\u6790\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5\u3001\u53d6\u4ee3\u7801\u3001\u8bbe\u7f6e compiled entrypoint\u3001\u5b89\u88c5 OSR code \u7b49\u3002</li> <li>CompilerInterface\uff08runtime/include/compiler_interface.h\uff09\uff1a\u66f4\u5e95\u5c42\u7684\u201c\u7f16\u8bd1\u4ea7\u7269\u4e0e runtime \u4ea4\u4e92\u201d\u63a5\u53e3\uff08\u4f8b\u5982\u5199\u5165 entrypoint/\u67e5\u8be2\u72b6\u6001\u4f4d\u7b49\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/","title":"<code>build/irtoc/irtoc_interpreter/disasm.txt</code>\uff08\u5ba1\u8ba1\u7b14\u8bb0\uff5c\u673a\u5668\u7801\u8bc1\u636e\uff1aIR \u6307\u4ee4 id \u2192 \u6c47\u7f16\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u5c5e\u6027\uff1abuild \u751f\u6210\u7269\uff08\u672c\u673a\u8bc1\u636e\uff0c\u4f53\u91cf\u5f88\u5927\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5c55\u793a IRTOC \u540e\u7aef\u628a <code>Graph</code> \u751f\u6210\u7684 \u6700\u7ec8\u6c47\u7f16\uff0c\u5e76\u5728\u6ce8\u91ca\u91cc\u4fdd\u7559\uff1a - <code># [inst] &lt;id&gt; ...</code> \u7684 IR \u6307\u4ee4\u6458\u8981 - \u5bf9\u5e94\u673a\u5668\u7801\u5730\u5740\u4e0e\u6307\u4ee4\u6587\u672c</p> <p>\u9605\u8bfb\u7b56\u7565\uff1a\u4e0d\u8981\u9010\u884c\u8bfb\u5168\u6587\u4ef6\uff1b\u53ea\u6311\u201c\u5165\u53e3 + dispatch + \u5178\u578b handler\u201d\u9a8c\u8bc1\u5173\u952e\u7ea6\u5b9a\u5373\u53ef\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#1-executeimplfast-dispatch-l1l58","title":"1) <code>ExecuteImplFast</code>\uff1a\u5165\u53e3 + dispatch \u7684\u673a\u5668\u7801\u5f62\u6001\uff08L1\u2013L58\uff09","text":"<p><code>METHOD_INFO</code> \u663e\u793a\uff1a</p> <ul> <li>mode: <code>InterpreterEntry</code></li> <li>spills_count: 0\uff08\u5165\u53e3\u4e0d\u5e94\u4ea7\u751f spills\uff09</li> </ul> <p>\u7136\u540e\u4f60\u80fd\u770b\u5230\u4e09\u6bb5\u6700\u5173\u952e\u7684\u5bf9\u5e94\u5173\u7cfb\uff1a</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#11-liveout","title":"1.1 \u53c2\u6570\u5bc4\u5b58\u5668 \u2192 \u56fa\u5b9a\u5bc4\u5b58\u5668\uff08LiveOut\uff09","text":"<p>\u53cd\u6c47\u7f16\u91cc\u6709\uff1a</p> <ul> <li><code># [inst] 0..3 Parameter arg0..arg3 -&gt; rdi/rsi/rdx/rcx</code></li> <li><code># [inst] 22 SpillFill rdi -&gt; r15</code> <code>mov %rdi, %r15</code></li> </ul> <p>\u8fd9\u4e0e <code>irtoc_code.cpp</code> / <code>interpreter.irt.fixed</code> \u7684 <code>LiveOut(tr).DstReg(15)</code> \u5bf9\u9f50\uff1ax86_64 \u4e0a\u628a <code>tr</code> \u653e\u8fdb <code>r15</code>\uff08\u56fa\u5b9a\u5bc4\u5b58\u5668\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#12-frame-accacc_tagloadiaddiloadi","title":"1.2 \u4ece frame \u521d\u59cb\u5316 acc/acc_tag\uff08LoadI/AddI/LoadI\uff09","text":"<p>\u53cd\u6c47\u7f16\u91cc\u6709\uff1a</p> <ul> <li><code>mov 0x30(%rdx), %rbx</code>\uff08\u4ece frame \u52a0 offset \u53d6 acc \u6307\u9488\uff09</li> <li><code>lea 0x30(%rdx), %rax</code></li> <li><code>mov 0x08(%rax), %r11</code>\uff08\u53d6 acc_tag mirror\uff09</li> </ul> <p>\u5bf9\u5e94 <code>irtoc_code.cpp</code> \u7684\uff1a</p> <ul> <li><code>LoadI(frame).Imm(GetFrameAccOffset)</code></li> <li><code>AddI(frame).Imm(GetFrameAccOffset)</code></li> <li><code>LoadI(...).Imm(GetFrameAccMirrorOffset)</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#13-dispatch-tableopc-jmp-rax","title":"1.3 dispatch \u7684\u672c\u8d28\uff1a\u8bfb table[opc] \u2192 <code>jmp %rax</code>","text":"<p>\u53cd\u6c47\u7f16\u91cc\u6709\uff1a</p> <ul> <li><code>movzxb (%rsi), %eax</code>\uff1a\u8bfb opcode\uff08<code>LoadI.u8(pc, 0)</code>\uff09</li> <li><code>mov (%rcx,%rax,8), %rax</code>\uff1a\u53d6 <code>dispatch_table[opc]</code></li> <li><code>jmp %rax</code>\uff1a\u5c3e\u8df3\u8f6c\u5230 handler</li> </ul> <p>\u8fd9\u5c31\u662f <code>interpreter.irt</code> \u7684 <code>dispatch(table, pc)</code>\uff1acomputed-goto \u7684\u673a\u5668\u7801\u8bc1\u636e\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#2-executeimplfasteh-table-l62","title":"2) <code>ExecuteImplFastEH</code>\uff1a\u5f02\u5e38\u5165\u53e3\u53d6 table \u6700\u540e\u4e00\u9879\uff08L62 \u8d77\uff09","text":"<p>\u4f60\u4f1a\u770b\u5230\u5b83\u76f4\u63a5\u6784\u9020\u5e38\u91cf\u504f\u79fb\uff08\u4f8b\u5982 <code>mov $0xC38, %rax</code>\uff09\uff0c\u518d\uff1a</p> <ul> <li><code>mov (%rcx,%rax,1), %rax</code></li> <li><code>jmp %rax</code></li> </ul> <p>\u5176\u4e2d <code>0xC38</code> = <code>392 * 8</code> = <code>handler_names.size * WordSize()</code>\uff0c\u5373 dispatch table \u7684\u6700\u540e\u4e00\u4e2a slot\u3002 \u8fd9\u4e0e <code>interpreter.irt</code> \u7684 <code>move_to_exception</code>\uff08load last slot + tail_call\uff09\u4e25\u683c\u5bf9\u9f50\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_disasm.txt/#3-ir","title":"3) \u4f60\u5982\u4f55\u628a\u201c\u811a\u672c\u884c\u53f7 \u2192 IR \u2192 \u6c47\u7f16\u201d\u4e32\u8d77\u6765\uff08\u5efa\u8bae\u505a\u4e00\u6b21\uff09","text":"<p>\u4ee5 <code>ExecuteImplFast</code> \u4e3a\u4f8b\uff1a</p> <ul> <li>\u5728 <code>interpreter.irt.fixed</code> \u627e <code>function(:ExecuteImplFast</code>\uff08\u4f8b\u5982\u884c\u53f7 2751/2761/2764\uff09</li> <li>\u5728 <code>irtoc_code.cpp</code> \u627e <code>Loc(..., 2751)</code>\uff0c\u62ff\u5230 <code>INST id</code></li> <li>\u5728\u672c\u6587\u4ef6\u627e\u5230\u540c\u4e00 method \u7684 <code># [inst] &lt;id&gt;</code>\uff0c\u770b\u5176\u4e0b\u65b9\u6c47\u7f16</li> </ul> <p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4ece DSL \u5230\u673a\u5668\u7801\u7684\u201c\u95ed\u73af\u5ba1\u8ba1\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_interpreter.irt.fixed/","title":"<code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u201c\u5c55\u5f00\u540e\u7684\u6700\u7ec8\u811a\u672c\u201d\uff0c\u7528\u4e8e Loc/\u8c03\u8bd5/\u5bf9\u9f50\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u5c5e\u6027\uff1abuild \u751f\u6210\u7269\uff08\u672c\u673a\u8bc1\u636e\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b83\u662f <code>irtoc/scripts/interpreter.irt</code> \u5728 build \u8fc7\u7a0b\u4e2d \u89c4\u8303\u5316/\u5c55\u5f00 \u540e\u7684\u6700\u7ec8\u7248\u672c\uff1a</p> <ul> <li>\u628a <code>include_relative</code> \u7684\u4f9d\u8d56\u5c55\u5f00\uff08\u6216\u6309\u987a\u5e8f\u62fc\u63a5\uff09</li> <li>\u628a <code>include_plugin</code> \u7684 handlers \u5408\u5165</li> <li>\u5bf9\u5b8f/DSL \u7ed3\u6784\u505a\u201c\u66f4\u7a33\u5b9a\u7684\u8f93\u51fa\u201d\uff08\u4fbf\u4e8e\u540e\u7eed\u751f\u6210 <code>irtoc_code.cpp</code>\uff09</li> </ul> <p>\u4f60\u5728 <code>irtoc_code.cpp</code> / <code>disasm.txt</code> \u91cc\u770b\u5230\u7684 <code>Loc(DIR_0, FILE_0, &lt;line&gt;)</code> \u7684 <code>&lt;line&gt;</code>\uff0c\u6307\u7684\u5c31\u662f \u672c\u6587\u4ef6\u7684\u884c\u53f7\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_interpreter.irt.fixed/#1","title":"1) \u4e3a\u4ec0\u4e48\u8fd9\u4e2a\u6587\u4ef6\u662f\u201c\u53ef\u5ba1\u8ba1\u67a2\u7ebd\u201d","text":"<p>IRTOC \u7684 3 \u4e2a\u5c42\u6b21\u5206\u522b\u627f\u62c5\u4e0d\u540c\u8d23\u4efb\uff1a</p> <ul> <li><code>irtoc/scripts/interpreter.irt</code>\uff1a\u4eba\u7c7b\u53ef\u8bfb\u7684\u89e3\u91ca\u5668\u8bed\u4e49\uff08\u5b8f/\u751f\u6210\u5668/\u6ce8\u91ca\u5bc6\u96c6\uff09</li> <li><code>interpreter.irt.fixed</code>\uff1a\u7ed9\u201c\u4ee3\u7801\u751f\u6210\u5668\u201d\u5582\u7684\u7a33\u5b9a\u8f93\u5165\uff08\u884c\u53f7\u7a33\u5b9a\u3001\u5df2\u5c55\u5f00\uff09</li> <li><code>irtoc_code.cpp</code>\uff1a\u628a <code>*.irt.fixed</code> \u7684 DSL \u8bed\u4e49\u53d8\u6210 <code>Graph</code> \u7684 C++ \u6784\u9020\uff08\u9010\u6761 <code>INST(...)</code>\uff09</li> </ul> <p>\u6240\u4ee5\u4f60\u8981\u505a\u201c\u9010\u884c\u8bc1\u636e\u94fe\u201d\u7684\u65f6\u5019\uff0c\u56fa\u5b9a\u4ee5 <code>*.irt.fixed</code> \u884c\u53f7\u4f5c\u4e3a\u951a\u70b9\u6700\u7a33\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_interpreter.irt.fixed/#2-executeimplfastexecuteimplfasteh-fixed-l2740","title":"2) <code>ExecuteImplFast/ExecuteImplFastEH</code> \u5728 fixed \u811a\u672c\u91cc\u7684\u771f\u5b9e\u6837\u5b50\uff08\u7ea6 L2740 \u8d77\uff09","text":"<p>\u5728\u672c\u673a build \u8f93\u51fa\u91cc\uff0c\u53ef\u4ee5\u76f4\u63a5\u770b\u5230\uff08\u5173\u952e\u70b9\uff09\uff1a</p> <ul> <li><code>function(:ExecuteImplFast, params: { tr/pc/frame/dispatch_table }, mode: [:InterpreterEntry])</code></li> <li><code>LiveOut(tr).DstReg(regmap[:tr])</code>\u3001<code>LiveOut(frame).DstReg(regmap[:frame])</code></li> <li>\u521d\u59cb\u5316 acc/acc_tag\uff08\u4ece frame \u7684 acc slot load\uff09</li> <li><code>dispatch(dispatch_table, pc)</code>\uff08\u8fdb\u5165 computed-goto/tail-call \u7684 dispatch\uff09</li> </ul> <p>\u540c\u4e00\u6bb5\u4f1a\u88ab <code>irtoc_code.cpp::COMPILE(ExecuteImplFast)</code> \u9010\u6761\u7ffb\u8bd1\u6210 <code>Opcode::LiveOut/LoadI/AddI/Intrinsic(TAIL_CALL)</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_interpreter.irt.fixed/#3-handler-pandainstructionseach","title":"3) handler \u751f\u6210\u5668\uff1a<code>Panda.instructions.each</code> \u4f1a\u201c\u843d\u5730\u6210\u4e00\u6279\u51fd\u6570\u6587\u672c\u201d","text":"<p><code>interpreter.irt</code> \u672b\u5c3e\u7684 <code>Panda.instructions.each</code> \u5728 fixed \u6587\u4ef6\u91cc\u4f1a\u8868\u73b0\u4e3a\uff1a</p> <ul> <li>\u5927\u91cf <code>function(\"HANDLE_FAST_#{handler_name}\", ...) do ... end</code></li> <li>case \u5206\u53d1 + \u8c03\u7528\u5bf9\u5e94 <code>handle_xxx</code> \u5b8f</li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u4f1a\u5728 <code>irtoc_code.cpp</code> \u91cc\u5bf9\u5e94 \u5927\u91cf\u7684 <code>COMPILE(HANDLE_FAST_XXX)</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_interpreter.irt.fixed/#4-ir","title":"4) \u4f60\u5982\u4f55\u7528\u5b83\u505a\u201c\u884c\u53f7 \u2192 IR \u2192 \u673a\u5668\u7801\u201d\u7684\u8ffd\u6eaf","text":"<p>\u63a8\u8350\u6700\u77ed\u8def\u5f84\uff08\u4ee5 <code>ExecuteImplFast</code> \u4e3a\u4f8b\uff09\uff1a</p> <ol> <li>\u5728\u672c\u6587\u4ef6\u627e <code>function(:ExecuteImplFast</code> \u7684\u884c\u53f7\uff08\u4f8b\u5982 2751/2761/2764 \u7b49\uff09</li> <li>\u53bb <code>irtoc_code.cpp</code> \u641c <code>interpreter.irt.fixed:2751</code>\uff0c\u770b\u5bf9\u5e94 <code>INST(...).Loc(..., 2751)</code></li> <li>\u53bb <code>disasm.txt</code> \u770b\u540c\u4e00\u4e2a method \u7684 <code>[inst] &lt;id&gt; ...</code> \u5bf9\u5e94\u673a\u5668\u7801\uff08\u4f8b\u5982 <code>jmp %rax</code>\uff09</li> </ol> <p>\u8fd9\u6837\u4f60\u53ef\u4ee5\u628a\u4e00\u6bb5\u201c\u811a\u672c\u8bed\u4e49\u201d\u4e25\u683c\u5bf9\u9f50\u5230\u201cIR \u8282\u70b9\u5e8f\u5217\u201d\u548c\u201c\u6700\u7ec8\u6c47\u7f16\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/","title":"<code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cGraph \u6784\u9020\u5c42\uff1a\u4ece *.irt.fixed \u5230 IR \u8282\u70b9\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u5c5e\u6027\uff1abuild \u751f\u6210\u7269\uff08\u672c\u673a\u8bc1\u636e\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u628a <code>interpreter.irt.fixed</code> \u7684 DSL \u8bed\u4e49\u7ffb\u8bd1\u4e3a compiler optimizer \u7684 IR Graph \u6784\u9020\u4ee3\u7801\u3002 \u4f60\u53ef\u4ee5\u628a\u5b83\u7406\u89e3\u4e3a\uff1aIRTOC \u540e\u7aef\u7684\u201c\u524d\u7aef\u8f93\u51fa\u201d\u2014\u2014\u6bcf\u4e2a <code>COMPILE(X)</code> \u90fd\u6784\u9020\u4e00\u4e2a <code>Graph</code>\uff0c\u968f\u540e\u8fdb\u5165\u540e\u7aef\u751f\u6210\u76ee\u6807\u4ee3\u7801\uff08\u6700\u7ec8\u843d\u5230 <code>irtoc_interpreter.o</code>\uff0c\u5e76\u5728 <code>disasm.txt</code> \u53ef\u89c1\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#1-arch","title":"1) \u6587\u4ef6\u5934\u90e8\uff1a\u8bf4\u660e\u8fd9\u662f\u201c\u4e3a\u67d0\u4e2a arch \u751f\u6210\u7684\u4ee3\u7801\u201d","text":"<ul> <li>L2\uff1a<code>// THIS FILE WAS GENERATED FOR X86_64</code></li> <li>include\uff1a\u5f15\u5165 IR \u6784\u9020\u5668\u3001relocation\u3001cross_values\u3001runtime \u7c7b\u578b\u7b49\uff08\u56e0\u4e3a Graph \u6784\u9020\u4f1a\u7528\u5230 offset/\u5e38\u91cf\uff09\u3002</li> </ul> <p>\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u540c\u4e00\u4efd <code>interpreter.irt</code> \u5728\u4e0d\u540c arch build \u4e0b\u4f1a\u4ea7\u51fa\u4e0d\u540c <code>irtoc_code.cpp</code>\uff1a\u56fa\u5b9a\u5bc4\u5b58\u5668\u4e0e offset \u90fd\u4e0e <code>GetArch()</code> \u7ed1\u5b9a\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#2-compileexecuteimplfast-graph-l22l96","title":"2) <code>COMPILE(ExecuteImplFast)</code>\uff1a\u89e3\u91ca\u5668\u5165\u53e3\u7684 Graph \u5f62\u6001\uff08L22\u2013L96\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#21-graph-interpreterentry","title":"2.1 Graph \u914d\u7f6e\uff08\u201c\u8fd9\u662f InterpreterEntry\u201d\uff09","text":"<p>\u5728 <code>COMPILE(ExecuteImplFast)</code> \u7684\u5f00\u5934\u4f60\u4f1a\u770b\u5230\u5178\u578b\u914d\u7f6e\uff1a</p> <ul> <li><code>SetArgsCount(4)</code>\uff1a\u5bf9\u5e94 runtime \u8c03\u7528 <code>ExecuteImplFast(thread, pc, frame, dispatch_table)</code></li> <li><code>GetGraph()-&gt;SetMode(... | GraphMode::InterpreterEntry(true))</code></li> <li><code>GetGraph()-&gt;SetArchUsedRegs(~0x9ff)</code>\uff1a\u9650\u5236\u53ef\u7528\u5bc4\u5b58\u5668\u96c6\u5408\uff08\u4e0e fixed regmap/ABI \u5bf9\u9f50\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#22-parameter","title":"2.2 \u53c2\u6570\u6620\u5c04\uff08Parameter\uff09","text":"<p>Graph \u91cc\u660e\u786e\u58f0\u660e\u4e86 4 \u4e2a\u53c2\u6570\uff1a</p> <ul> <li><code>PARAMETER(0,0).ptr()</code> \u2026 <code>PARAMETER(3,3).ptr()</code></li> </ul> <p>\u5728 <code>disasm.txt</code> \u91cc\u80fd\u770b\u5230\u5b83\u4eec\u5982\u4f55\u6620\u5c04\u5230\u786c\u4ef6\u5bc4\u5b58\u5668\uff08x86_64: rdi/rsi/rdx/rcx\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#23-loc","title":"2.3 Loc\uff1a\u811a\u672c\u884c\u53f7\u662f\u5982\u4f55\u4e32\u8d77\u6765\u7684","text":"<p>\u5173\u952e\u8bc1\u636e\u662f\u6bcf\u4e2a <code>INST(...).Loc(DIR_0, FILE_0, &lt;line&gt;)</code>\uff1a</p> <ul> <li><code>DIR_0</code> \u6307\u5411 <code>build/irtoc/irtoc_interpreter</code></li> <li><code>FILE_0</code> \u662f <code>\"interpreter.irt.fixed\"</code></li> <li><code>&lt;line&gt;</code> \u662f interpreter.irt.fixed \u7684\u884c\u53f7\uff08\u4f8b\u5982 2751/2761/2764 \u7b49\uff09</li> </ul> <p>\u8fd9\u5c31\u662f\u201c\u811a\u672c \u2192 IR\u201d\u6700\u91cd\u8981\u7684\u5ba1\u8ba1\u951a\u70b9\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#24-tail_callcomputed-goto-ir","title":"2.4 TAIL_CALL\uff1acomputed-goto \u7684 IR \u5f62\u5f0f","text":"<p>\u5728 <code>ExecuteImplFast</code> \u7684\u672b\u5c3e\u53ef\u4ee5\u770b\u5230\uff1a</p> <ul> <li><code>Load(dispatch_table, offset)</code> \u53d6\u51fa handler \u5730\u5740</li> <li><code>IntrinsicId::INTRINSIC_TAIL_CALL</code> \u5e76 <code>Terminator()</code></li> </ul> <p>\u5bf9\u5e94 <code>interpreter.irt</code> \u7684 <code>dispatch(table, pc)</code> / <code>tail_call(addr)</code> \u5b8f\u3002</p> <p>\u5728 <code>disasm.txt</code> \u91cc\u6700\u7ec8\u843d\u6210\uff1a</p> <ul> <li><code>jmp %rax</code></li> </ul> <p>\u8fd9\u5c31\u662f fast interpreter \u7684\u201cdispatch loop\u201d\uff1a\u4e0d\u662f\u5faa\u73af\u8fd4\u56de\uff0c\u800c\u662f\u5c3e\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a handler\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#3-compileexecuteimplfasteh-graph-l97l162","title":"3) <code>COMPILE(ExecuteImplFastEH)</code>\uff1a\u5f02\u5e38\u5165\u53e3\u7684 Graph \u5f62\u6001\uff08L97\u2013L162\uff09","text":"<p>\u5b83\u4e0e <code>ExecuteImplFast</code> \u76f8\u4f3c\uff0c\u4f46\u6838\u5fc3\u5dee\u5f02\u662f\uff1a</p> <ul> <li>\u4e0d\u662f\u7528 opcode \u7d22\u5f15 table\uff0c\u800c\u662f\u76f4\u63a5\u53d6 <code>handler_names.size * 8</code> \u7684 slot\uff08\u5373 dispatch_table \u7684\u6700\u540e\u4e00\u9879\uff09</li> <li>\u7136\u540e tail-call \u5230\u5f02\u5e38 handler</li> </ul> <p>\u8fd9\u4e0e <code>interpreter.irt.fixed</code> \u4e2d <code>ExecuteImplFastEH</code> \u7684 <code>tail_call(addr)</code> \u5bf9\u9f50\uff0c\u4e5f\u4e0e <code>irtoc_interpreter_utils.h</code> \u628a\u6700\u540e\u4e00\u9879\u8bbe\u4e3a <code>HANDLE_FAST_EXCEPTION</code> \u5bf9\u9f50\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#4-compilehandle_fast_xxx-bytecode-handler-graph","title":"4) <code>COMPILE(HANDLE_FAST_XXX)</code>\uff1a\u6bcf\u6761 bytecode \u7684 handler \u90fd\u53d8\u6210\u4e00\u4e2a Graph","text":"<p>\u4ece <code>COMPILE(HANDLE_FAST_NOP)</code> \u5f00\u59cb\uff0c\u4f60\u4f1a\u770b\u5230\u6a21\u5f0f\u975e\u5e38\u7a33\u5b9a\uff1a</p> <ul> <li><code>SetArgsCount(0)</code>\uff1ahandler \u672c\u8eab\u4e0d\u8d70 C ABI \u53c2\u6570\u4f20\u9012\uff0c\u800c\u662f\u901a\u8fc7 fixed regmap \u7684 LiveIn/LiveOut \u8bfb\u5199\u72b6\u6001\u5bc4\u5b58\u5668</li> <li>\u4e00\u4e32 <code>Opcode::LiveIn</code>\uff1a\u628a <code>acc/acc_tag/pc/frame/tr/dispatch</code> \u7b49\u8bfb\u8fdb\u6765</li> <li>\u8fdb\u884c decode\uff08<code>LoadI</code> \u4ece <code>%pc</code> \u8bfb operand\uff0c<code>AndI/ShrI</code> \u505a\u4f4d\u64cd\u4f5c\uff09</li> <li>\u8fdb\u884c vreg/acc \u64cd\u4f5c\uff08<code>Load/Store</code> + offset\uff09</li> <li>\u6700\u7ec8\u8fd8\u662f\u4ee5 <code>Intrinsic(TAIL_CALL)</code> \u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a handler\uff08\u5e38\u89c1\u662f\u518d\u6b21\u8d70 <code>dispatch</code>\uff09</li> </ul> <p>\u8fd9\u4e5f\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 <code>validation.yaml</code> \u91cc\u8981\u5bf9\u6bcf\u4e2a <code>HANDLE_FAST_*</code> \u505a spills \u9650\u5236\uff1ahandler \u6570\u91cf\u6781\u591a\uff0c\u5bc4\u5b58\u5668\u538b\u529b\u9ad8\u65f6\u5fc5\u987b\u628a spills \u63a7\u5236\u5728\u4e0a\u9650\u5185\uff0c\u5426\u5219\u6027\u80fd/\u6b63\u786e\u6027\u98ce\u9669\u4e0a\u5347\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_irtoc_code.cpp/#5","title":"5) \u600e\u4e48\u628a\u5b83\u548c\u201c\u673a\u5668\u7801\u201d\u5bf9\u9f50\uff08\u6700\u5b9e\u7528\u7684\u5ba1\u8ba1\u65b9\u6cd5\uff09","text":"<p>\u4ee5 <code>ExecuteImplFast</code> \u4e3a\u4f8b\uff1a</p> <ol> <li>\u5728 <code>irtoc_code.cpp</code> \u627e <code>COMPILE(ExecuteImplFast)</code>\uff08\u4f60\u4f1a\u770b\u5230 <code>INST(...).Loc(..., line)</code>\uff09</li> <li>\u53d6\u67d0\u4e2a <code>INST id</code>\uff08\u4f8b\u5982 disasm \u91cc\u7684 <code># [inst] 18 Intrinsic.TailCall</code>\uff09</li> <li>\u5230 <code>disasm.txt</code> \u627e\u540c\u4e00 method \u7684 <code># [inst] 18</code> \u4ee5\u53ca\u5b83\u4e0b\u9762\u7684\u6c47\u7f16\uff08\u4f8b\u5982 <code>jmp %rax</code>\uff09</li> </ol> <p>\u8fd9\u6837\u4f60\u5c31\u80fd\u628a \u201c\u811a\u672c\u884c\u53f7\u201d \u2194 \u201cIR \u6307\u4ee4 id\u201d \u2194 \u201c\u6700\u7ec8\u6c47\u7f16\u201d \u4e25\u683c\u4e32\u8d77\u6765\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_validation.yaml/","title":"<code>build/irtoc/irtoc_interpreter/validation.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u751f\u6210\u7269\u7684\u201c\u7ea6\u675f\u4e0e\u95e8\u7981\u201d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u5c5e\u6027\uff1abuild \u751f\u6210\u7269\uff08\u672c\u673a\u8bc1\u636e\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1aIRTOC \u89e3\u91ca\u5668\u751f\u6210\u8fc7\u7a0b\u4e2d\u7684 \u9a8c\u8bc1\u914d\u7f6e\uff08validation gate\uff09\uff0c\u7528\u4e8e\u9650\u5236\u6bcf\u4e2a\u751f\u6210\u51fd\u6570\u7684\u8d44\u6e90\u4f7f\u7528\uff08\u5c24\u5176\u662f spills\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_validation.yaml/#1-key-l1","title":"1) \u7ed3\u6784\uff1a\u4ee5\u51fd\u6570\u540d\u4e3a key \u7684\u7ea6\u675f\u8868\uff08L1 \u8d77\uff09","text":"<p>YAML \u9876\u5c42\u662f\u4e00\u4e2a map\uff0ckey \u662f\uff1a</p> <ul> <li><code>:ExecuteImplFast</code></li> <li><code>:ExecuteImplFastEH</code></li> <li><code>HANDLE_FAST_NOP</code></li> <li><code>HANDLE_FAST_MOV_V4_V4</code></li> <li>...</li> </ul> <p>value \u662f\u8be5\u51fd\u6570\u7684\u9a8c\u8bc1\u53c2\u6570\uff0c\u4f8b\u5982\uff1a</p> <ul> <li><code>:spills_count_max: 32</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_validation.yaml/#2-spills","title":"2) spills \u4e0a\u9650\u4e3a\u4ec0\u4e48\u91cd\u8981","text":"<p>fast interpreter \u7684 handler \u6570\u91cf\u5de8\u5927\uff08392 \u4e2a slot \u5bf9\u5e94\u5927\u91cf <code>HANDLE_FAST_*</code>\uff09\uff0c\u540c\u65f6\u5b83\u5f3a\u4f9d\u8d56\u56fa\u5b9a\u5bc4\u5b58\u5668\u4fdd\u5b58\u89e3\u91ca\u5668\u72b6\u6001\u3002 \u4e00\u65e6\u67d0\u4e2a handler \u7684\u5bc4\u5b58\u5668\u538b\u529b\u8fc7\u5927\u5bfc\u81f4 spills \u7206\u70b8\uff0c\u4f1a\u5e26\u6765\uff1a</p> <ul> <li>\u6027\u80fd\u663e\u8457\u9000\u5316\uff08handler \u53d8\u6162\u76f4\u63a5\u653e\u5927\u5230\u6574\u4f53\u89e3\u91ca\u5668\uff09</li> <li>\u66f4\u590d\u6742\u7684\u6808\u5e03\u5c40\u4e0e\u66f4\u96be\u7684\u8c03\u8bd5</li> <li>\u5728\u6781\u7aef\u60c5\u51b5\u4e0b\u53ef\u80fd\u89e6\u53d1\u540e\u7aef\u7684\u7ea6\u675f\u5931\u8d25</li> </ul> <p>\u56e0\u6b64 build \u91cc\u7528 <code>validation.yaml</code> \u7ed9\u6bcf\u4e2a handler \u4e0a\u201c\u786c\u95e8\u7981\u201d\u662f\u5408\u7406\u7684\u5de5\u7a0b\u624b\u6bb5\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_irtoc_irtoc_interpreter_validation.yaml/#3-interpretervalidation","title":"3) \u5b83\u4e0e\u6e90\u811a\u672c\u4e2d\u7684 <code>InterpreterValidation</code> \u7684\u5173\u7cfb","text":"<p>\u5728 <code>irtoc/scripts/interpreter.irt</code> \u9876\u90e8\u6709\uff1a</p> <ul> <li><code>InterpreterValidation = { spills_count_max: 32 }</code></li> </ul> <p>\u5e76\u5728 <code>function(..., validate: InterpreterValidation)</code> \u91cc\u4f20\u5165\u3002 build \u65f6\u4f1a\u628a\u5b83\u201c\u7269\u5316\u201d\u6210\u6bcf\u4e2a\u751f\u6210\u51fd\u6570\u7684\u6821\u9a8c\u9879\uff08\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684 <code>validation.yaml</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/","title":"<code>build/runtime/include/irtoc_interpreter_utils.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u751f\u6210\u7684 dispatch table\uff08IRTOC vs LLVM\uff09\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u5c5e\u6027\uff1abuild \u751f\u6210\u7269\uff08\u7531 <code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code> \u7b49\u6a21\u677f\u751f\u6210\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a - \u58f0\u660e\u6240\u6709 <code>HANDLE_FAST_*</code> \u4e0e <code>HANDLE_FAST_*_LLVM</code> \u7b26\u53f7\uff08<code>extern \"C\"</code>\uff09 - \u63d0\u4f9b\u4e24\u4e2a\u6784\u9020\u51fd\u6570\uff1a   - <code>SetupDispatchTableImpl()</code>\uff1aIRTOC backend \u8868   - <code>SetupLLVMDispatchTableImpl()</code>\uff1aLLVM backend \u8868 - \u4e24\u5f20\u8868\u7684\u89c4\u6a21\u56fa\u5b9a\u4e3a 392\uff0c\u5e76\u8fd4\u56de <code>dispatch_table.data()</code>\uff08\u7ed9 <code>ExecuteImplFast*</code> \u4f7f\u7528\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/#1-handle_fast_","title":"1. <code>HANDLE_FAST_*</code> \u58f0\u660e\uff08\u5927\u91cf\uff09","text":"<p>\u6587\u4ef6\u4e0a\u534a\u90e8\u5206\u57fa\u672c\u662f\uff1a</p> <ul> <li><code>extern \"C\" void HANDLE_FAST_&lt;OPNAME&gt;();</code></li> <li><code>extern \"C\" void HANDLE_FAST_&lt;OPNAME&gt;_LLVM();</code></li> </ul> <p>\u4e0d\u540c\u5e73\u53f0\u4f1a\u6709 <code>#if defined(PANDA_TARGET_AMD64) &amp;&amp; !defined(PANDA_COMPILER_TARGET_X86_64)</code> \u7b49 guard\uff1b\u5728\u67d0\u4e9b\u7ec4\u5408\u4e0b\u4f1a\u628a handler \u5b9a\u4e49\u4e3a <code>static constexpr ... = nullptr;</code>\uff08\u7528\u4e8e\u201c\u6784\u5efa\u4e86\u5934\uff0c\u4f46\u672c\u914d\u7f6e\u4e0d\u63d0\u4f9b\u5b9e\u73b0\u201d\u7684\u5360\u4f4d\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/#2-setupdispatchtableimplirtoc-backend-dispatch-table-l1387","title":"2. <code>SetupDispatchTableImpl()</code>\uff1aIRTOC backend dispatch table\uff08\u7ea6 L1387 \u8d77\uff09","text":"<p>\u6838\u5fc3\u7ed3\u6784\uff1a</p> <ul> <li><code>static const std::array&lt;void (*)(), 392&gt; dispatch_table { ... };</code></li> <li>\u6309 opcode \u987a\u5e8f\u4f9d\u6b21\u586b\u5165 <code>HANDLE_FAST_*</code></li> <li>\u6700\u540e\u8fd4\u56de\uff1a<code>(void*)dispatch_table.data()</code></li> </ul> <p>\u8fd9\u610f\u5473\u7740 fast interpreter \u7684 dispatch \u53ea\u9700\u8981 <code>opc</code> \u505a\u7d22\u5f15\uff0c\u5c31\u80fd\u83b7\u5f97 <code>HANDLE_FAST_*</code> \u7684\u5165\u53e3\u5730\u5740\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/#21-slot","title":"2.1 \u91cd\u8981\u7ec6\u8282\uff1a\u6700\u540e\u4e00\u4e2a slot \u662f\u5f02\u5e38\u5165\u53e3","text":"<p>\u8868\u5c3e\u90e8\u53ef\u4ee5\u770b\u5230\uff1a</p> <ul> <li><code>..., &amp;HANDLE_FAST_EXCEPTION</code></li> </ul> <p>\u8fd9\u4e0e <code>interpreter.irt</code> \u7684 <code>move_to_exception</code> \u5b8c\u5168\u5bf9\u9f50\uff1a\u5b83\u7528 <code>Load(table, handler_names.size * 8)</code> \u53d6\u201c\u6700\u540e\u4e00\u9879\u201d\uff0c\u518d tail-call \u5230\u5f02\u5e38 handler\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/#3-setupllvmdispatchtableimplllvm-backend-dispatch-table-l2181","title":"3. <code>SetupLLVMDispatchTableImpl()</code>\uff1aLLVM backend dispatch table\uff08\u7ea6 L2181 \u8d77\uff09","text":"<p>\u7ed3\u6784\u4e0e IRTOC backend \u76f8\u540c\uff0c\u4f46\u6bcf\u4e2a\u7b26\u53f7\u90fd\u5e26 <code>_LLVM</code> \u540e\u7f00\uff1a</p> <ul> <li><code>HANDLE_FAST_MOV_V4_V4_LLVM</code></li> <li>...</li> <li>\u8868\u5c3e\u90e8\u540c\u6837\u662f <code>HANDLE_FAST_EXCEPTION_LLVM</code></li> </ul> <p>\u8fd0\u884c\u65f6\u9009\u578b\u89c1\uff1a<code>runtime/interpreter/interpreter_impl.cpp::ExecuteImplType</code>\uff1a</p> <ul> <li><code>--interpreter-type=irtoc</code> \u2192 <code>SetupDispatchTableImpl()</code></li> <li><code>--interpreter-type=llvm</code> \u2192 <code>SetupLLVMDispatchTableImpl()</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/build_runtime_include_irtoc_interpreter_utils.h/#4-buildirtoc","title":"4. \u8fd9\u4efd\u751f\u6210\u7269\u4e0e build/irtoc \u4ea7\u7269\u5982\u4f55\u5bf9\u9f50","text":"<ul> <li>\u672c\u6587\u4ef6\u8d1f\u8d23\u201cdispatch table \u7ec4\u88c5\u201d\uff08\u51fd\u6570\u6307\u9488\u6570\u7ec4\uff09\u3002</li> <li><code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code> \u8d1f\u8d23\u628a <code>interpreter.irt.fixed</code> \u91cc\u7684 <code>HANDLE_FAST_*</code> \u53d8\u6210\u201c\u53ef\u7f16\u8bd1/\u53ef\u94fe\u63a5\u201d\u7684\u673a\u5668\u7801\uff08<code>COMPILE(HANDLE_FAST_*)</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/","title":"<code>bytecode_optimizer/optimize_bytecode.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u529f\u80fd\u5757\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1abytecode optimizer \u7684\u6838\u5fc3\u9a71\u52a8\uff1a\u628a bytecode \u6620\u5c04\u4e3a compiler IR Graph\uff0c\u8dd1\u4e00\u7ec4\u4f18\u5316 pass\uff0c\u7136\u540e\u518d\u751f\u6210/\u56de\u5199 bytecode\uff08\u5e76\u7ef4\u62a4\u8c03\u8bd5\u4fe1\u606f\u6620\u5c04\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#0","title":"0) \u65b0\u4eba\u5148\u5efa\u7acb\u201c\u5b83\u5728\u94fe\u8def\u4e0a\u7684\u4f4d\u7f6e\u201d","text":"<p>\u5b83\u4e0d\u662f\u8fd0\u884c\u65f6\u89e3\u91ca\u5668/JIT \u7684\u4e3b\u5faa\u73af\uff0c\u800c\u662f\u201c\u6267\u884c\u524d/\u79bb\u7ebf\u53d8\u6362\u5c42\u201d\uff1a</p> <ul> <li>\u8f93\u5165\uff1a<code>.abc</code> bytecode\uff08panda file\uff09+ debug info</li> <li>\u4e2d\u95f4\uff1a<code>compiler::Graph</code>\uff08\u4e0e JIT \u4fa7\u590d\u7528\u540c\u4e00\u5957 IR/Pass \u57fa\u7840\u8bbe\u65bd\uff09</li> <li>\u8f93\u51fa\uff1a\u4f18\u5316\u540e\u7684 bytecode\uff08\u5e76\u5c3d\u91cf\u4fdd\u6301/\u4fee\u590d line/column \u7b49 debug \u4fe1\u606f\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#1-optionsg_optionsl59","title":"1) \u5168\u5c40 options\uff1a<code>g_options</code>\uff08L59\uff09","text":"<ul> <li><code>ark::bytecodeopt::Options g_options(\\\"\\\");</code></li> <li>\u8fd9\u662f bytecode optimizer \u7684\u5168\u5c40\u914d\u7f6e\u5165\u53e3\uff08opt level\u3001regex\u3001\u662f\u5426\u8df3\u8fc7 EH \u7b49\uff09\uff0c\u5927\u91cf\u5206\u652f\u4ece\u8fd9\u91cc\u8bfb\u53d6\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#2-pass-pipeline-runopts-l61l89","title":"2) Pass pipeline \u7684\u7ec4\u7ec7\u65b9\u5f0f\uff1a<code>RunOpts</code> \u6a21\u677f\uff08L61\u2013L89\uff09","text":"<ul> <li><code>RunOpts&lt;T&gt;</code>\uff1a\u5bf9\u5355\u4e2a pass \u505a\u7edf\u4e00\u5305\u88c5\uff08\u901a\u5e38\u5148\u8dd1 <code>Cleanup</code>\uff0c\u67d0\u4e9b pass \u9700\u8981\u989d\u5916\u51c6\u5907/\u5f00\u5173\uff09\u3002</li> <li><code>RunOpts&lt;First, Second, ...&gt;</code>\uff1a\u7528\u6a21\u677f\u9012\u5f52\u8868\u8fbe\u201c\u56fa\u5b9a\u987a\u5e8f\u7684 pass pipeline\u201d\u3002</li> </ul> <p>\u67b6\u6784\u610f\u4e49\uff1abytecode optimizer \u4e0e JIT \u7f16\u8bd1\u5668\u5171\u4eab pass \u57fa\u7840\u8bbe\u65bd\uff0c\u8fd9\u91cc\u53ea\u662f\u628a\u5b83\u7ec4\u7ec7\u4e3a\u201c\u79bb\u7ebf/\u6267\u884c\u524d\u201d\u7684\u56fa\u5b9a\u6d41\u6c34\u7ebf\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#3-runoptimizationsgraph-ifacel91l138","title":"3) \u6838\u5fc3\u51b3\u7b56\uff1a<code>RunOptimizations(graph, iface)</code>\uff08L91\u2013L138\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#31-opt-level-l93l120","title":"3.1 opt level \u5206\u5c42\uff08L93\u2013L120\uff09","text":"<ul> <li><code>OPT_LEVEL_0</code>\uff1a\u76f4\u63a5\u8fd4\u56de false\uff08\u76f8\u5f53\u4e8e\u7981\u7528\u4f18\u5316\uff09</li> <li><code>OPT_LEVEL_1/2</code>\uff1a\u6309\u4e0d\u540c\u7ec4\u5408\u8dd1 pass</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#32-special-casel107l109","title":"3.2 \u52a8\u6001\u65b9\u6cd5 special-case\uff08L107\u2013L109\uff09","text":"<ul> <li><code>graph-&gt;IsDynamicMethod()</code> \u4e0b\u53ea\u8dd1\u8f83\u4fdd\u5b88\u7684\u4e00\u7ec4\uff1a<code>ValNum + Lowering + MoveConstants</code></li> <li>\u8fd9\u4e0e 04 \u7ae0\u6267\u884c\u5f15\u64ce\u7684\u603b\u4f53\u7b56\u7565\u4e00\u81f4\uff1a\u52a8\u6001\u8bed\u8a00\u8def\u5f84\u901a\u5e38\u7ea6\u675f\u66f4\u591a/\u7b56\u7565\u66f4\u4fdd\u5b88\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#33-regacc-l122l137","title":"3.3 Reg/Acc \u5206\u914d\u4e0e\u7f16\u7801\uff08L122\u2013L137\uff09","text":"<ul> <li><code>RegAccAlloc</code>\uff1a\u51b3\u5b9a\u54ea\u4e9b\u503c\u8fdb\u5bc4\u5b58\u5668/acc\uff08\u4e3a bytecode \u751f\u6210\u505a\u51c6\u5907\uff09</li> <li><code>RegAlloc(graph)</code>\uff1a\u5bc4\u5b58\u5668\u5206\u914d</li> <li><code>RegEncoder</code>\uff1a\u628a\u5206\u914d\u7ed3\u679c\u7f16\u7801\u56de bytecode \u5f62\u5f0f</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#4-debug-infopc-linecolumn","title":"4) Debug info\uff1aPC\u2192\u6307\u4ee4\u6620\u5c04\u4e0e line/column \u4fee\u590d","text":""},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#41-buildmapfrompctoinsl140l156","title":"4.1 <code>BuildMapFromPcToIns</code>\uff08L140\u2013L156\uff09","text":"<ul> <li>\u7528 <code>compiler::BytecodeInstructions</code> \u8fed\u4ee3\u539f\u59cb\u6307\u4ee4\u6d41</li> <li>\u5efa\u7acb pc \u2192 <code>pandasm::Ins</code> \u7684\u6620\u5c04\uff08\u4f9b <code>BytecodeGen</code> \u56de\u5199\u65f6\u91cd\u5efa debug info\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#42-linenumberpropagatecolumnnumberpropagatel158l214","title":"4.2 <code>LineNumberPropagate/ColumnNumberPropagate</code>\uff08L158\u2013L214\uff09","text":"<ul> <li>\u76ee\u6807\uff1a\u4fee\u590d\u201c\u67d0\u4e9b\u6307\u4ee4\u7f3a\u5931 line/column\u201d\u7684\u60c5\u51b5</li> <li>\u52a8\u6001\u65b9\u6cd5\u989d\u5916\u4f20\u64ad column\uff08L220\u2013L222\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#5-optimizefunction-l262l333","title":"5) \u5355\u51fd\u6570\u95ed\u73af\uff1a<code>OptimizeFunction</code>\uff08\u7ea6 L262\u2013L333\uff09","text":"<p>\u8fd9\u662f\u201cbytecode \u2192 Graph \u2192 pass \u2192 bytecode\u201d\u95ed\u73af\u7684\u6838\u5fc3\uff1a</p> <ul> <li>Graph \u6784\u5efa\uff1a</li> <li><code>CreateBytecodeOptimizerRuntimeAdapter(...)</code></li> <li><code>graph-&gt;RunPass&lt;IrBuilder&gt;()</code>\uff1a\u628a bytecode \u5efa IR</li> <li>\u53ef\u4f18\u5316\u6027\u8fc7\u6ee4\uff1a<code>SkipFunction</code>\uff08regex/EH/\u5e27\u5927\u5c0f\u4e0a\u9650\u7b49\uff09</li> <li>\u4f18\u5316\u6d41\u6c34\u7ebf\uff1a<code>RunOptimizations(graph, &amp;irInterface)</code></li> <li>\u56de\u5199 bytecode\uff1a<code>graph-&gt;RunPass&lt;BytecodeGen&gt;(&amp;function, &amp;irInterface)</code></li> <li>\u4fee\u590d debug info\uff1a<code>DebugInfoPropagate(function, graph, irInterface)</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#6-optimizepandafile-optimizebytecode-l335l382","title":"6) \u6587\u4ef6\u7ea7\u5165\u53e3\uff1a<code>OptimizePandaFile</code> / <code>OptimizeBytecode</code>\uff08\u7ea6 L335\u2013L382\uff09","text":"<ul> <li>\u904d\u5386 panda file \u7684 class/method</li> <li>\u8df3\u8fc7 external/abstract/native</li> <li>\u4e3a\u6bcf\u4e2a\u65b9\u6cd5\u8c03\u7528 <code>OptimizeFunction</code></li> <li><code>OptimizeBytecode</code> \u8d1f\u8d23 PoolManager \u521d\u59cb\u5316/\u6536\u5c3e\uff08\u5982\u679c\u8c03\u7528\u65b9\u6ca1\u6709 memory pool\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#7","title":"7) \u6392\u969c\u6293\u624b\uff08\u65b0\u4eba\u6700\u5e38\u95ee\uff09","text":"<ul> <li>\u4e3a\u4ec0\u4e48\u67d0\u4e2a\u51fd\u6570\u6ca1\u88ab\u4f18\u5316\uff1f\uff1a\u770b <code>SkipFunction</code> \u7684\u4e09\u4e2a\u6761\u4ef6\uff1aregex / EH / frame size</li> <li>\u4e3a\u4ec0\u4e48\u4f18\u5316\u5931\u8d25\uff1f\uff1a\u770b <code>IrBuilder</code> \u662f\u5426\u5931\u8d25\u3001<code>RegAlloc</code>/<code>RegEncoder</code> \u662f\u5426\u5931\u8d25</li> <li>\u4e3a\u4ec0\u4e48\u884c\u53f7\u4e71\u4e86\uff1f\uff1a\u770b <code>BuildMapFromPcToIns</code> + <code>LineNumberPropagate/ColumnNumberPropagate</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.cpp/#8-04","title":"8) \u4e0e 04 \u7ae0\u6267\u884c\u5f15\u64ce\u7684\u8fb9\u754c\u8bf4\u660e","text":"<ul> <li>runtime \u6267\u884c\uff1a\u89e3\u91ca\u5668 / fast interpreter / JIT / AOT</li> <li>\u672c\u6587\u4ef6\uff1a\u6267\u884c\u524d/\u79bb\u7ebf\u5de5\u5177\u5bf9 bytecode \u505a\u201c\u89c4\u6574\u4e0e\u4f18\u5316\u201d</li> </ul> <p>\u5efa\u8bae\u65b0\u4eba\u628a\u5b83\u5f53\u4f5c\u201c\u89e3\u91ca\u5668\u66f4\u5feb\u8dd1\u201d\u7684\u4e0a\u6e38\u5de5\u7a0b\uff0c\u800c\u4e0d\u662f\u8fd0\u884c\u65f6\u63a7\u5236\u6d41\u7684\u4e00\u90e8\u5206\u3002</p> <p>{   \"cells\": [],   \"metadata\": {     \"language_info\": {       \"name\": \"python\"     }   },   \"nbformat\": 4,   \"nbformat_minor\": 2 }</p>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.h/","title":"<code>bytecode_optimizer/optimize_bytecode.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5bf9\u5916\u63a5\u53e3\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1abytecode optimizer \u5bf9\u5916\u66b4\u9732\u7684\u6700\u5c0f API\uff1a<code>OptimizeBytecode(...)</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/bytecode_optimizer_optimize_bytecode.h/#1","title":"1) \u4f60\u4ece\u8fd9\u4e2a\u5934\u6587\u4ef6\u5e94\u5f97\u5230\u7684\u7ed3\u8bba","text":"<p>\u8fd9\u4e2a\u5934\u6587\u4ef6\u523b\u610f\u4fdd\u6301\u201c\u8584\u63a5\u53e3\u201d\uff1a</p> <ul> <li>\u5bf9\u5916\u53ea\u66b4\u9732\u4e00\u4e2a\u6838\u5fc3\u5165\u53e3\uff1a<code>OptimizeBytecode(...)</code></li> <li>\u8c03\u7528\u65b9\u628a <code>pandasm::Program</code>\u3001panda\u2194pandasm maps\u3001\u76ee\u6807\u6587\u4ef6\u540d\u3001\u662f\u5426 dynamic\u3001\u4ee5\u53ca memory pool \u72b6\u6001\u4f20\u8fdb\u6765</li> </ul> <p>{   \"cells\": [],   \"metadata\": {     \"language_info\": {       \"name\": \"python\"     }   },   \"nbformat\": 4,   \"nbformat_minor\": 2 }</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/","title":"<code>compiler/aot/aot_file.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u52a0\u8f7d/\u6821\u9a8c/patch/GOT\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a<code>.an</code> \u7684 loader\uff1a\u628a AOT ELF \u52a8\u6001\u5e93\u52a0\u8f7d\u5230\u8fdb\u7a0b\uff0c\u6821\u9a8c\u73af\u5883/GC/\u7248\u672c\uff0c\u5e76\u5b8c\u6210 GOT/patch table \u521d\u59cb\u5316\uff0c\u4f7f AOT \u673a\u5668\u7801\u80fd\u5728\u8fd0\u884c\u65f6\u6b63\u786e\u8c03\u7528 runtime entrypoints/intrinsics\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#0-an-elf","title":"0) \u4e00\u4e2a\u5173\u952e\u4e8b\u5b9e\uff1a<code>.an</code> \u662f\u201c\u5e26\u7b26\u53f7\u8868\u7684 ELF \u52a8\u6001\u5e93\u201d","text":"<p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 <code>AotFile::Open</code> \u4f1a\uff1a</p> <ul> <li><code>Load(fileName)</code> \u5f97\u5230 <code>LibraryHandle</code></li> <li><code>ResolveSymbol(handle, \"aot\"/\"aot_end\"/\"code\"/\"code_end\")</code> \u5f97\u5230\u4e24\u6bb5\u5185\u5b58\u533a\u95f4</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#1-aotfileopen","title":"1) <code>AotFile::Open</code>\uff1a\u52a0\u8f7d\u4e0e\u4e00\u81f4\u6027\u6821\u9a8c\uff08\u6700\u5173\u952e\u7684\u5165\u53e3\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#11-section","title":"1.1 \u8f7d\u5165\u5e76\u89e3\u6790\u4e24\u4e2a section \u533a\u95f4","text":"<ul> <li><code>aot..aot_end</code>\uff1a\u5143\u6570\u636e\uff08headers/strtab/bitmap \u7b49\uff09</li> <li><code>code..code_end</code>\uff1a\u673a\u5668\u7801\u4e0e CodeInfo</li> </ul> <p>\u5982\u679c\u533a\u95f4\u975e\u6cd5\uff08<code>code_end &lt; code</code> \u6216 <code>aot_end &lt;= aot</code>\uff09\uff0c\u76f4\u63a5\u62a5\u9519\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#12-gc","title":"1.2 \u5934\u90e8\u6821\u9a8c\uff1a\u907f\u514d\u201c\u9519\u67b6\u6784/\u9519 GC/\u9519\u7248\u672c\u201d\u5bfc\u81f4\u707e\u96be","text":"<p>\u6309\u987a\u5e8f\u6821\u9a8c\uff1a</p> <ul> <li><code>magic</code> \u5fc5\u987b\u7b49\u4e8e <code>.an\\\\0</code></li> <li><code>version</code> \u5fc5\u987b\u7b49\u4e8e <code>AotFile::VERSION</code></li> <li><code>environmentChecksum</code>\uff08\u9664\u975e <code>forDump</code>\uff09\u5fc5\u987b\u7b49\u4e8e <code>RuntimeInterface::GetEnvironmentChecksum(RUNTIME_ARCH)</code></li> <li><code>gcType</code>\uff08\u9664\u975e <code>forDump</code>\uff09\u5fc5\u987b\u7b49\u4e8e\u8fd0\u884c\u65f6\u4f20\u5165\u7684 <code>gcType</code></li> </ul> <p>VM \u67b6\u6784\u610f\u4e49\uff1aAOT code \u5bf9\u5bf9\u8c61\u5e03\u5c40\u3001barrier\u3001\u8c03\u7528\u7ea6\u5b9a\u90fd\u6709\u786c\u5047\u8bbe\uff1b\u8fd9\u51e0\u6761\u4e0d\u6ee1\u8db3\u5fc5\u987b\u62d2\u7edd\u52a0\u8f7d\uff0c\u800c\u4e0d\u662f\u201c\u52c9\u5f3a\u8fd0\u884c\u201d\u3002  </p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#2-initializegotruntimeinterface-aot-code-runtime","title":"2) <code>InitializeGot(RuntimeInterface*)</code>\uff1a\u8ba9 AOT code \u80fd\u201c\u627e\u5f97\u5230 runtime\u201d","text":"<p>\u6838\u5fc3\u601d\u8def\uff1a</p> <ul> <li>GOT/patch table \u88ab\u653e\u5728 <code>code_</code> \u524d\u65b9\u7684\u56fa\u5b9a\u533a\u57df\uff08\u6309 intrinsic id \u4e0e slot \u7f16\u7801\u7ec4\u7ec7\uff09\u3002</li> <li>\u8be5\u51fd\u6570\u626b\u63cf table\uff0c\u6839\u636e slot type \u505a\u521d\u59cb\u5316\uff1a</li> <li><code>PLT_SLOT</code>\uff1a\u586b <code>CallStaticPltResolver</code>\uff08\u5f31\u7b26\u53f7\u515c\u5e95\uff09\uff0c\u5e76\u628a resolver \u7684\u201cself \u6307\u9488\u201d\u5199\u8fdb\u53bb\uff08\u7528\u4e8e\u5b9a\u4f4d\u56de table\uff09</li> <li><code>CLASS_SLOT/STRING_SLOT/VTABLE_INDEX</code> \u7b49\uff1a\u521d\u59cb\u5316\u4e3a 0\uff08\u8fd0\u884c\u65f6\u518d\u61d2\u89e3\u6790/patch\uff09</li> <li><code>COMMON_SLOT</code>\uff1a\u6e05\u96f6</li> </ul> <p>\u4f60\u628a\u5b83\u7406\u89e3\u4e3a\uff1aAOT code \u7684\u5916\u90e8\u5f15\u7528\u4e0d\u662f\u76f4\u63a5\u5199\u6b7b\u5730\u5740\uff0c\u800c\u662f\u7ecf\u7531 GOT/slot\uff0c\u5728\u8fd0\u884c\u65f6\u5b8c\u6210\u91cd\u5b9a\u4f4d/patch\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#3-patchtableruntimeinterface-intrinsics","title":"3) <code>PatchTable(RuntimeInterface*)</code>\uff1a\u586b\u5145 intrinsics \u7684\u771f\u5b9e\u5730\u5740","text":"<ul> <li>\u4ee5 <code>RuntimeInterface::IntrinsicId::COUNT</code> \u4e3a\u957f\u5ea6\uff0c\u9010\u4e2a\u5199\u5165 <code>GetIntrinsicAddress(...)</code>\u3002</li> <li>\u8fd9\u8ba9 AOT code \u6267\u884c <code>Intrinsic</code> \u6307\u4ee4\u65f6\u80fd\u76f4\u63a5\u8df3\u5230 runtime \u63d0\u4f9b\u7684\u5b9e\u73b0\uff08\u6709\u4e9b\u662f runtime call\uff0c\u6709\u4e9b\u662f leaf/fast path\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#4-aotclassaotpandafile","title":"4) <code>AotClass/AotPandaFile</code> \u7684\u5b9e\u73b0\u8981\u70b9","text":"<ul> <li><code>AotPandaFile::GetClass(classId)</code>\uff1a\u5728 class header span \u4e0a\u4e8c\u5206\u67e5\u627e\uff0c\u786e\u4fdd class headers \u6309 classId \u6709\u5e8f\u3002</li> <li><code>AotClass::FindMethodCodeEntry/Span</code>\uff1a\u901a\u8fc7 method bitmap \u5224\u65ad\u65b9\u6cd5\u662f\u5426\u5b58\u5728\uff0c\u518d\u628a <code>codeOffset</code> \u6620\u5c04\u4e3a code span\uff0c\u5e76\u7531 <code>CodeInfo</code> \u89e3\u51fa\u771f\u6b63\u7684\u53ef\u6267\u884c\u533a\u95f4\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.cpp/#5-04","title":"5) \u4e0e 04 \u7ae0\u5176\u4ed6\u7ec4\u4ef6\u7684\u4ea4\u53c9\u70b9\uff08\u65b0\u540c\u5b66\u8981\u4f1a\u8fde\uff09","text":"<ul> <li>entrypoints\uff1aAOT code \u901a\u8fc7 GOT/patch table \u95f4\u63a5\u8c03\u7528 runtime \u7684\u6162\u8def\u5f84\u3002</li> <li>StackWalker/deopt/\u5f02\u5e38\uff1aAOT \u7684 <code>CodeInfo</code> \u4e0e stack map \u662f\u201c\u8de8 compiled frame \u8fd8\u539f\u8bed\u4e49\u5e27\u201d\u7684\u57fa\u7840\u6570\u636e\u3002</li> <li>FileManager/Runtime \u542f\u52a8\u52a0\u8f7d\uff1a<code>AotFile::Open</code> \u7684\u8c03\u7528\u65b9\u662f <code>AotManager::AddFile</code>\uff08\u89c1\u4e0b\u4e00\u4efd FileNotes\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/","title":"<code>compiler/aot/aot_file.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cAOT \u6587\u4ef6\u62bd\u8c61\u4e0e\u67e5\u8be2\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 <code>AotFile</code>\uff08\u4e00\u4e2a <code>.an</code> ELF \u5e93\u7684\u8fd0\u884c\u671f\u89c6\u56fe\uff09\u4ee5\u53ca\u5b83\u5bfc\u51fa\u7684\u201c\u6309 panda file/class/method \u67e5\u8be2\u201d\u80fd\u529b\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#1-aotfile","title":"1) <code>AotFile</code> \u662f\u4ec0\u4e48","text":"<p><code>AotFile</code> \u628a\u4e00\u4e2a <code>.an</code>\uff08\u672c\u8d28\u662f ELF \u52a8\u6001\u5e93\uff09\u62bd\u8c61\u6210\u4e09\u5757\u53ef\u67e5\u8be2\u6570\u636e\uff1a</p> <ul> <li><code>handle_</code>\uff1a\u5df2\u52a0\u8f7d\u7684\u52a8\u6001\u5e93\u53e5\u67c4\uff08\u7528\u4e8e resolve \u7b26\u53f7\uff09</li> <li><code>aotData_</code>\uff1a<code>aot..aot_end</code> \u8fd9\u4e00\u6bb5\uff08\u5305\u542b <code>AotHeader</code> \u4e0e\u5404\u7c7b header/strtab/bitmap\uff09</li> <li><code>code_</code>\uff1a<code>code..code_end</code> \u8fd9\u4e00\u6bb5\uff08\u5305\u542b\u673a\u5668\u7801 + CodeInfo \u7b49\uff09</li> </ul> <p>\u5b83\u63d0\u4f9b\u7684 API \u76ee\u6807\u662f\uff1a\u8ba9 runtime \u80fd\u628a\u201cmethod/class/panda file\u201d\u6620\u5c04\u5230 AOT \u673a\u5668\u7801\u5730\u5740\u3001\u4ee5\u53ca\u5fc5\u8981\u7684\u5143\u4fe1\u606f\uff08hash table\u3001class context \u7b49\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#2-magicversion","title":"2) \u5173\u952e\u5e38\u91cf\uff1a<code>MAGIC</code>/<code>VERSION</code>","text":"<ul> <li><code>MAGIC = {'.','a','n','\\\\0'}</code>\uff1a\u548c <code>.an</code> \u7684\u6587\u4ef6\u7c7b\u578b\u7ed1\u5b9a</li> <li><code>VERSION = {'0','0','6','\\\\0'}</code>\uff1a\u4e0e on-disk \u5e03\u5c40\u7248\u672c\u7ed1\u5b9a\uff08<code>AotFile::Open</code> \u4f1a\u6821\u9a8c\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#3-an","title":"3) <code>.an</code> \u7684\u8fd0\u884c\u671f\u67e5\u8be2\u63a5\u53e3\uff08\u9ad8\u9891\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#31-header","title":"3.1 \u8bfb header/\u5b57\u7b26\u4e32/\u6587\u4ef6\u540d","text":"<ul> <li><code>GetAotHeader()</code>\uff1a\u8fd4\u56de <code>AotHeader*</code></li> <li><code>GetString(offset)</code>\uff1a\u4ece <code>strtabOffset + offset</code> \u53d6\u5b57\u7b26\u4e32</li> <li><code>GetFileName()/GetCommandLine()/GetClassContext()</code>\uff1a\u628a header \u4e2d\u7684 <code>*Str</code> \u504f\u79fb\u7ffb\u8bd1\u6210\u5b57\u7b26\u4e32</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#32-panda-file","title":"3.2 panda file \u5c42","text":"<ul> <li><code>FileHeaders()</code>\uff1a\u8fd4\u56de <code>PandaFileHeader</code> \u7684 span\uff08\u4ece <code>filesOffset</code> \u5f00\u59cb\uff09</li> <li><code>FindPandaFile(fileName)</code>\uff1a\u6309 fileName \u67e5\u627e <code>PandaFileHeader</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#33-classmethod","title":"3.3 class/method \u5c42","text":"<ul> <li><code>GetClassHeaders(fileHeader)</code>\uff1a\u7ed9\u5b9a\u67d0\u4e2a panda file header\uff0c\u53d6\u5176 class headers span</li> <li><code>GetClassHashTable(fileHeader)</code>\uff1a\u8fd4\u56de class hash table \u7684 span\uff08\u4f9b runtime \u6ce8\u5165\u5230 <code>.abc</code>\uff09</li> <li><code>GetMethodHeader(i)</code>\uff1a\u6309 index \u53d6 method header\uff08\u6ce8\u610f\u5b83\u662f\u201c\u5168\u5c40\u65b9\u6cd5\u8868\u201d\u7684\u7d22\u5f15\uff09</li> <li><code>GetMethodCode(methodHeader)</code>\uff1a\u628a methodHeader \u7684 <code>codeOffset</code> \u6620\u5c04\u5230 <code>code_</code> \u533a\u95f4</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#4-aotclass-aotpandafile","title":"4) <code>AotClass</code> / <code>AotPandaFile</code>\uff1a\u66f4\u9762\u5411\u201c\u4f7f\u7528\u201d\u7684\u5c01\u88c5","text":""},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#41-aotclass","title":"4.1 <code>AotClass</code>","text":"<p>\u5c01\u88c5 \u201c\u67d0\u4e2a class \u5728 AOT \u6587\u4ef6\u4e2d\u7684\u89c6\u56fe\u201d\uff1a</p> <ul> <li><code>FindMethodCodeEntry(index)</code>\uff1a\u8fd4\u56de\u201c\u53ef\u6267\u884c\u5165\u53e3\u201d\uff08\u6ce8\u610f\u4f1a\u53e0\u52a0 <code>CodeInfo::GetCodeOffset(RUNTIME_ARCH)</code>\uff09</li> <li><code>FindMethodCodeSpan(index)</code>\uff1a\u8fd4\u56de\u201c\u771f\u6b63\u7684\u673a\u5668\u7801 span\u201d\uff08\u7531 <code>CodeInfo(code).GetCodeSpan()</code> \u89e3\u5305\uff09</li> <li><code>FindMethodHeader(index)</code>\uff1a\u7ed3\u5408 bitmap \u5224\u65ad\u65b9\u6cd5\u662f\u5426\u5b58\u5728</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#42-aotpandafile","title":"4.2 <code>AotPandaFile</code>","text":"<p>\u5c01\u88c5 \u201c\u67d0\u4e2a panda file \u5728 AOT \u6587\u4ef6\u4e2d\u7684\u89c6\u56fe\u201d\uff1a</p> <ul> <li>\u6784\u9020\u65f6\u4f1a <code>LoadClassHashTable()</code>\uff08\u540e\u7eed runtime \u53ef\u628a\u5b83\u704c\u5230 <code>.abc</code> \u4e0a\u52a0\u901f class lookup\uff09</li> <li><code>GetClass(classId)</code>\uff1a\u5728\u6392\u5e8f\u7684 class headers \u4e2d\u4e8c\u5206\u67e5\u627e\u76ee\u6807 class</li> <li><code>GetMethodCodeInfo(methodHeader)</code>\uff1a\u628a method \u7684 code blob \u89e3\u6210 <code>CodeInfo</code>\uff08\u4f9b StackWalker/\u53bb\u4f18\u5316/\u5f02\u5e38\u7b49\u89e3\u7801\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_file.h/#5-04","title":"5) \u4e0e 04 \u7ae0\u6267\u884c\u5f15\u64ce\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u8fd0\u884c\u65f6\u52a0\u8f7d <code>.an</code>\uff1a<code>AotManager::AddFile</code> \u4f1a\u8c03\u7528 <code>AotFile::Open</code>\uff0c\u5e76\u5728 <code>runtime != nullptr</code> \u65f6\u505a patch/GOT \u521d\u59cb\u5316\u3002</li> <li>\u7f16\u8bd1\u5668\u4fa7 snapshot index\uff1a<code>runtime/compiler.cpp</code> \u4f1a\u4ece <code>AotManager</code> \u62ff snapshot index\uff08\u628a <code>panda_file::File</code> \u6620\u5c04\u4e3a AOT \u7d22\u5f15\u7a7a\u95f4\uff09\u3002</li> <li>\u89e3\u91ca\u5668/compiled \u7684\u4ea4\u754c\uff1a\u5f53 PC \u843d\u5728 AOT code range \u5185\u65f6\uff0c<code>StackWalker</code>/\u5f02\u5e38 unwind/deopt \u4f9d\u8d56 <code>CodeInfo/StackMap</code> \u89e3\u7801\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_headers.h/","title":"<code>compiler/aot/aot_headers.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cAOT \u5143\u6570\u636e\u5e03\u5c40\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 <code>.an</code> \u6587\u4ef6\uff08AOT ELF \u5185\u7684 <code>aot</code> section\uff09\u5934\u90e8\u4e0e\u7d22\u5f15\u8868\u7684\u4e8c\u8fdb\u5236\u5e03\u5c40\uff0c\u662f AOT loader\uff08<code>AotFile::Open</code>\uff09\u4e0e\u8fd0\u884c\u671f\u7d22\u5f15/\u6821\u9a8c\u7684\u5171\u540c\u57fa\u7840\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_headers.h/#1-aotheaderan","title":"1) <code>AotHeader</code>\uff1a<code>.an</code> \u7684\u201c\u603b\u76ee\u5f55\u201d","text":"<p><code>struct AotHeader</code> \u662f <code>.an</code> \u7684\u5143\u6570\u636e\u5165\u53e3\uff0c\u5173\u952e\u5b57\u6bb5\u5206\u4e09\u7c7b\uff1a</p> <ul> <li>\u6587\u4ef6\u8bc6\u522b\u4e0e\u4e00\u81f4\u6027\uff1a</li> <li><code>magic</code>\uff1a\u56fa\u5b9a\u4e3a <code>.an\\\\0</code>\uff08\u89c1 <code>AotFile::MAGIC</code>\uff09</li> <li><code>version</code>\uff1a\u7248\u672c\u53f7\uff08\u89c1 <code>AotFile::VERSION</code>\uff09</li> <li><code>environmentChecksum</code>\uff1a\u5fc5\u987b\u5339\u914d <code>RuntimeInterface::GetEnvironmentChecksum(RUNTIME_ARCH)</code>\uff08\u9632\u6b62\u67b6\u6784/ABI \u4e0d\u4e00\u81f4\uff09</li> <li><code>gcType</code>\uff1a\u5fc5\u987b\u5339\u914d\u8fd0\u884c\u65f6 GC\uff08\u9632\u6b62 barrier/\u5bf9\u8c61\u5e03\u5c40\u5047\u8bbe\u4e0d\u4e00\u81f4\uff09</li> <li>\u7d22\u5f15\u8868\u504f\u79fb\uff1a</li> <li><code>filesOffset/classesOffset/methodsOffset/bitmapOffset/strtabOffset</code> \u7b49\uff1a\u628a <code>.an</code> \u7684\u5404\u6bb5\u7ec4\u7ec7\u6210\u201c\u53ef\u968f\u673a\u8bbf\u95ee\u7684\u8868\u201d</li> <li>\u53ef\u89c2\u6d4b\u4fe1\u606f\uff1a</li> <li><code>fileNameStr/cmdlineStr/classCtxStr</code>\uff1a\u6307\u5411 strtab \u7684\u504f\u79fb\uff0c\u65b9\u4fbf\u8bca\u65ad\uff08\u4f60\u80fd\u6253\u5370\u201c\u7f16\u8bd1\u65f6\u547d\u4ee4\u884c/\u7c7b\u4e0a\u4e0b\u6587\u201d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_headers.h/#2-pandafileheader-classheader-methodheader","title":"2) <code>PandaFileHeader</code> / <code>ClassHeader</code> / <code>MethodHeader</code>\uff1a\u5206\u5c42\u7d22\u5f15","text":"<p>\u8fd9\u4e09\u5c42\u628a <code>.an</code> \u7684\u5185\u5bb9\u6309 <code>panda file -&gt; class -&gt; method</code> \u5206\u7ec4\uff1a</p> <ul> <li><code>PandaFileHeader</code>\uff1a</li> <li><code>fileNameStr</code> + <code>fileChecksum</code>\uff1a\u7528\u4e8e\u628a <code>.abc</code> \u4e0e <code>.an</code> \u4e2d\u7684\u6761\u76ee\u5bf9\u5e94\u8d77\u6765</li> <li><code>classesCount/classesOffset/methodsCount/methodsOffset</code>\uff1a\u4e8c\u7ea7\u7d22\u5f15\u5165\u53e3</li> <li><code>classHashTableSize/classHashTableOffset</code>\uff1a\u8ba9 runtime \u4fa7\u7ed9 <code>.abc</code> \u6ce8\u5165 class hash table\uff08\u89c1 <code>FileManager::LoadAbcFile</code>\uff09</li> <li><code>ClassHeader</code>\uff1a</li> <li><code>classId</code>\uff1apanda file \u4e2d\u7684 class id</li> <li><code>methodsCount/methodsOffset</code>\uff1a\u6307\u5411 method \u5217\u8868</li> <li><code>methodsBitmapOffset/methodsBitmapSize</code>\uff1a\u7528 bitmap \u8868\u793a\u201c\u54ea\u4e9b\u65b9\u6cd5\u88ab\u7f16\u8fdb AOT\u201d\uff08\u8282\u7701\u7a7a\u95f4 + \u5feb\u901f\u5224\u65ad\uff09</li> <li><code>MethodHeader</code>\uff1a</li> <li><code>methodId</code></li> <li><code>codeOffset/codeSize</code>\uff1a\u6307\u5411 <code>code</code> section \u91cc\u7684\u673a\u5668\u7801\u7247\u6bb5\uff08\u8fdb\u4e00\u6b65\u7531 <code>CodeInfo</code> \u89e3\u5305\u51fa\u771f\u6b63\u53ef\u6267\u884c span\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_headers.h/#3","title":"3) \u9759\u6001\u65ad\u8a00\uff1a\u4fdd\u8bc1\u5e03\u5c40\u53ef\u79fb\u690d/\u53ef\u89e3\u6790","text":"<p><code>static_assert</code> \u5f3a\u8c03\uff1a</p> <ul> <li><code>AotHeader</code> \u6309 <code>uint32_t</code> \u5bf9\u9f50\uff0c\u4e14 size \u662f <code>uint32_t</code> \u7684\u6574\u6570\u500d   \u2192 \u8fd9\u4f7f\u5f97\u4e0d\u540c\u7f16\u8bd1\u5668/\u5e73\u53f0\u89e3\u6790\u65f6\u66f4\u7a33\u5b9a\uff0c\u907f\u514d padding \u9020\u6210\u504f\u79fb\u9519\u4e71\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/","title":"<code>compiler/aot/aot_manager.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u52a0\u8f7d\u4e0e\u4e00\u81f4\u6027\u6821\u9a8c\u5b9e\u73b0\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>AotManager</code>\uff1a\u52a0\u8f7d <code>.an</code>\u3001\u6784\u5efa panda file \u6620\u5c04\u3001\u7ef4\u62a4 snapshot\uff0c\u5e76\u5728 CHA \u5f00\u542f\u65f6\u6821\u9a8c class context\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/#1-addfile-an-panda-files","title":"1) <code>AddFile</code>\uff1a\u52a0\u8f7d <code>.an</code> \u5e76\u6ce8\u518c\u5176\u4e2d\u7684 panda files","text":"<p>\u5173\u952e\u6b65\u9aa4\uff1a</p> <ul> <li>\u53bb\u91cd\uff1a\u5df2\u5b58\u5728\u5219\u76f4\u63a5\u8fd4\u56de</li> <li>\u6253\u5f00 <code>.an</code>\uff1a<code>AotFile::Open(fileName, gcType)</code></li> <li>patch/GOT \u521d\u59cb\u5316\uff1a\u82e5 <code>runtime != nullptr</code>\uff1a</li> <li><code>PatchTable(runtime)</code></li> <li><code>InitializeGot(runtime)</code></li> <li>\u6ce8\u518c\u6587\u4ef6\uff1a</li> <li>\u628a <code>AotFile</code> \u653e\u5165 <code>aotFiles_</code></li> <li>\u904d\u5386 <code>FileHeaders()</code>\uff0c\u628a\u6bcf\u4e2a <code>pfName</code> \u6ce8\u518c\u5230 <code>filesMap_</code>\uff08<code>pfName -&gt; AotPandaFile</code>\uff09</li> <li><code>force</code> \u4e3a true \u65f6\u5141\u8bb8\u8986\u76d6\uff08\u7528\u4e8e\u201c\u5f3a\u5236\u5fc5\u987b\u6709 .an\u201d\u7684\u573a\u666f\uff09</li> </ul> <p>\u8fd9\u7ed9\u65b0\u540c\u5b66\u4e00\u4e2a\u660e\u786e\u7ed3\u8bba\uff1aruntime \u52a0\u8f7d <code>.an</code> \u7684\u672c\u8d28\uff0c\u5c31\u662f\u628a <code>.an</code> \u5f53\u4f5c\u52a8\u6001\u5e93\u52a0\u8f7d\uff0c\u7136\u540e\u5b8c\u6210\u201cintrinsic/entrypoints patch + panda file \u6620\u5c04\u6ce8\u518c\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/#2-updatepandafilessnapshotpf-ctx-isarkaot-snapshot","title":"2) <code>UpdatePandaFilesSnapshot(pf, ctx, isArkAot)</code>\uff1a\u628a\u5df2\u52a0\u8f7d\u6587\u4ef6\u7eb3\u5165 snapshot","text":"<ul> <li>ArkAot \u6a21\u5f0f\uff1a\u628a <code>&lt;fileName, (pf,ctx)&gt;</code> \u76f4\u63a5 push \u8fdb <code>pandaFilesSnapshot_</code></li> <li>\u975e ArkAot\uff1a\u5148\u8bb0\u5165 <code>pandaFilesLoaded_</code>\uff0c\u518d\u8c03\u7528 <code>UpdatePandaFilesSnapshot(isArkAot, true, true)</code> \u7528 class context \u751f\u6210 snapshot</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/#3-updatepandafilessnapshotisarkaot-class-context-snapshot","title":"3) <code>UpdatePandaFilesSnapshot(isArkAot, ...)</code>\uff1a\u4ece class context \u751f\u6210 snapshot","text":"<p>\u5b9e\u73b0\u63d0\u4f9b\u4e86\u4e00\u4e2a\u91cd\u8981\u7ec6\u8282\uff1aclass context \u662f\u4e00\u4e2a\u201c\u7528 delimiter \u5206\u9694\u7684\u5b57\u7b26\u4e32\u201d\uff0c\u540c\u65f6\u8fd8\u5305\u542b <code>HASH_DELIMETER</code>\uff1a</p> <ul> <li><code>parseClassContext</code> \u4f1a\u5728\u6bcf\u4e2a\u6761\u76ee\u91cc\u627e\u5230 <code>HASH_DELIMETER</code>\uff0c\u53d6\u5176\u524d\u534a\u6bb5\u4f5c\u4e3a\u6587\u4ef6\u540d key</li> <li>snapshot \u4e2d\u6bcf\u4e2a\u6761\u76ee\u4f1a\u7ed1\u5b9a\u5230 loadedFiles \u4e2d\u5df2\u5b58\u5728\u7684 <code>(pf, ctx)</code>\uff0c\u5426\u5219\u7ed1\u5b9a <code>(nullptr, nullptr)</code></li> </ul> <p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 class context \u9519\u4e86\u4f1a\u5bfc\u81f4 AOT \u65e0\u6cd5\u542f\u7528\uff1asnapshot index \u7a7a\u95f4\u5efa\u7acb\u5728\u8fd9\u4e2a\u5b57\u7b26\u4e32\u7684\u89e3\u6790\u4e4b\u4e0a\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/#4-getpandafilesnapshotindex-getpandafilebysnapshotindex","title":"4) <code>GetPandaFileSnapshotIndex</code> / <code>GetPandaFileBySnapshotIndex</code>","text":"<p>\u8fd9\u4fe9\u51fd\u6570\u63d0\u4f9b\u4e86\u201cstring -&gt; index -&gt; pf\u201d\u7684\u53cc\u5411\u6620\u5c04\uff0c\u4f9b compiler/runtime \u5171\u7528\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.cpp/#5-verifyclasshierarchyaot-context","title":"5) <code>VerifyClassHierarchy</code>\uff1aAOT context \u6821\u9a8c\uff08\u5931\u8d25\u76f4\u63a5\u7ec8\u6b62\uff09","text":"<ul> <li>\u5408\u5e76 boot/app context\uff0c\u5f62\u6210 runtime \u7684\u201ccomplete context\u201d</li> <li>\u5bf9\u6bcf\u4e2a <code>.an</code>\uff1a</li> <li>\u82e5 <code>withCha</code>\uff1a\u8981\u6c42 <code>aotFile-&gt;GetClassContext()</code> \u662f runtime context \u7684\u524d\u7f00</li> <li>\u5426\u5219\uff1a\u8981\u6c42 AOT context \u88ab runtime context \u5305\u542b</li> <li>\u5931\u8d25\u4f1a\u6253\u5370 runtime context \u4e0e aot context \u5e76 <code>LOG(FATAL)</code> \u7ec8\u6b62</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/","title":"<code>compiler/aot/aot_manager.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cAOT \u6587\u4ef6\u96c6\u5408\u4e0e snapshot/index\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a<code>AotManager</code> \u7ba1\u7406\u4e00\u7ec4\u5df2\u52a0\u8f7d\u7684 <code>.an</code> \u6587\u4ef6\uff0c\u5e76\u63d0\u4f9b\uff1a\u6309\u6587\u4ef6\u540d\u67e5\u627e\u3001\u6309 class context \u6821\u9a8c\u3001\u7ef4\u62a4 panda files snapshot\uff08\u4f9b compiler/runtime \u5171\u4eab\u7d22\u5f15\u7a7a\u95f4\uff09\u3001\u4ee5\u53ca AOT string roots \u7684 GC \u8bbf\u95ee\u63a5\u53e3\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#1-aotmanager","title":"1) <code>AotManager</code> \u7684\u804c\u8d23\u8fb9\u754c","text":"<p>\u53ef\u4ee5\u628a\u5b83\u7406\u89e3\u4e3a\u4e09\u4ef6\u4e8b\uff1a</p> <ul> <li>\u6587\u4ef6\u7ea7\uff1a\u52a0\u8f7d/\u4fdd\u5b58\u591a\u4e2a <code>AotFile</code></li> <li>\u6620\u5c04\u7ea7\uff1a\u628a <code>panda file name -&gt; AotPandaFile</code> \u505a\u6210\u5feb\u901f map</li> <li>\u4e00\u81f4\u6027\u7ea7\uff1a\u7ef4\u62a4 class context \u4e0e snapshot index\uff0c\u4fdd\u8bc1 runtime \u4e0e compiler \u5bf9\u201c\u6587\u4ef6\u96c6\u5408\u201d\u7684\u8ba4\u77e5\u4e00\u81f4</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#2-an-addfilegetfilefindpandafile","title":"2) <code>.an</code> \u6587\u4ef6\u7ba1\u7406\uff1a<code>AddFile/GetFile/FindPandaFile</code>","text":"<ul> <li><code>AddFile(fileName, runtime, gcType, force)</code>\uff1a\u52a0\u8f7d <code>.an</code> \u5e76\u628a\u5176\u5305\u542b\u7684 panda files \u6ce8\u518c\u8fdb map</li> <li><code>GetFile(fileName)</code>\uff1a\u6309 <code>.an</code> \u6587\u4ef6\u540d\u67e5\u627e\u5df2\u52a0\u8f7d\u6587\u4ef6</li> <li><code>FindPandaFile(fileName)</code>\uff1a\u6309 <code>.abc</code> \u6587\u4ef6\u540d\u67e5\u627e\u5b83\u5728 AOT \u4e2d\u5bf9\u5e94\u7684 <code>AotPandaFile</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#3-class-context-aot","title":"3) class context\uff1a\u4e3a\u4ec0\u4e48\u5b83\u662f AOT \u80fd\u5426\u542f\u7528\u7684\u201c\u5730\u57fa\u201d","text":""},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#31-setbootclasscontextsetappclasscontext","title":"3.1 <code>SetBootClassContext/SetAppClassContext</code>","text":"<p>\u4e24\u8005\u90fd\u4f1a\uff1a</p> <ul> <li>\u5b58\u4e0b\u5b57\u7b26\u4e32\uff08<code>bootClassContext_</code> / <code>appClassContext_</code>\uff09</li> <li>\u89e3\u6790 context \u5230\u5185\u90e8\u96c6\u5408\uff08<code>ParseClassContextToFile</code>\uff09</li> <li>\u8c03 <code>UpdatePandaFilesSnapshot(isArkAot, ...)</code> \u8ba9 snapshot \u4e0e\u5f53\u524d context \u5bf9\u9f50</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#32-verifyclasshierarchy","title":"3.2 <code>VerifyClassHierarchy()</code>","text":"<p>\u7528\u4e8e\u6821\u9a8c AOT \u6587\u4ef6\u7684 class context \u4e0e\u8fd0\u884c\u65f6\u5f53\u524d context \u662f\u5426\u5339\u914d\uff1a</p> <ul> <li>\u82e5 AOT \u662f <code>withCha</code>\uff1a\u8981\u6c42 AOT context \u5fc5\u987b\u662f runtime context \u7684\u524d\u7f00\uff08\u66f4\u4e25\u683c\uff09</li> <li>\u5426\u5219\uff1a\u8981\u6c42 AOT context \u88ab runtime context \u5305\u542b\uff08\u8f83\u5bbd\u677e\uff09</li> </ul> <p>\u5931\u8d25\u65f6\u4f1a\u6253\u5370\u4e24\u8fb9 context \u5e76 <code>LOG(FATAL)</code> \u7ec8\u6b62\uff08\u8fd9\u662f\u6b63\u786e\u7684\uff1a\u9519 context \u4f1a\u5bfc\u81f4\u7c7b\u578b\u89e3\u6790/\u865a\u65b9\u6cd5\u5206\u6d3e\u5047\u8bbe\u5931\u6548\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#4-snapshotindexcompiler-runtime","title":"4) snapshot/index\uff1acompiler \u4e0e runtime \u7684\u201c\u5171\u540c\u8bed\u8a00\u201d","text":""},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#41-updatepandafilessnapshotpf-ctx-isarkaot","title":"4.1 <code>UpdatePandaFilesSnapshot(pf, ctx, isArkAot)</code>","text":"<ul> <li>\u7528\u4e8e\u540c\u6b65\u201c\u5df2\u52a0\u8f7d panda files\u201d\u7684\u53ef\u89c1\u96c6\u5408\uff08<code>pandaFilesLoaded_</code> / <code>pandaFilesSnapshot_</code>\uff09\uff1b</li> <li>\u5728\u975e ArkAot \u6a21\u5f0f\u4e0b\uff0c\u4f1a\u628a loaded \u6587\u4ef6\u96c6\u5408\u4e0e boot/app class context \u5408\u5e76\u751f\u6210 snapshot\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#42-getpandafilesnapshotindexfilename-getpandafilebysnapshotindexindex","title":"4.2 <code>GetPandaFileSnapshotIndex(fileName)</code> / <code>GetPandaFileBySnapshotIndex(index)</code>","text":"<p>\u8fd9\u662f\u628a\u201c\u6587\u4ef6\u540d\u201d\u6620\u5c04\u5230\u4e00\u4e2a\u7a33\u5b9a\u6574\u6570 index \u7684\u5173\u952e API\uff0c\u4f9b <code>runtime/compiler.cpp</code> \u66b4\u9732\u7ed9 compiler \u4f7f\u7528\u3002</p> <p>\u91cd\u8981\uff1a\u8fd9\u4e5f\u662f 03\u219204 \u7684\u5178\u578b\u4ea4\u754c\u2014\u2014class loading \u51b3\u5b9a\u201c\u6709\u54ea\u4e9b panda files \u5728\u5f53\u524d context\u201d\uff0cAOT/\u7f16\u8bd1\u5668\u9700\u8981\u628a\u5b83\u4eec\u7f16\u53f7\u6210\u53ef\u7f13\u5b58\u7684\u7d22\u5f15\u7a7a\u95f4\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_aot_manager.h/#5-aot-string-roots-gc-aot","title":"5) AOT string roots\uff1a\u8ba9 GC \u80fd\u8bbf\u95ee AOT \u91cc\u7684\u5b57\u7b26\u4e32\u5f15\u7528","text":"<ul> <li><code>RegisterAotStringRoot(ObjectHeader **slot, bool isYoung)</code></li> <li><code>VisitAotStringRoots(cb, visitOnlyYoung)</code></li> <li><code>UpdateAotStringRoots(cb, predicate)</code></li> </ul> <p>\u8fd9\u91cc\u7528 bitset\uff08<code>aotStringYoungSet_</code>\uff09\u8bb0\u5f55\u201cyoung roots\u201d\uff0c\u5e76\u7528 atomic counter\uff08<code>aotStringGcRootsCount_</code>\uff09\u51cf\u5c11\u9501\u7ade\u4e89\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_compiled_method.h/","title":"<code>compiler/aot/compiled_method.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cAOT \u4ea7\u7269\u5bb9\u5668\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a<code>CompiledMethod</code> \u662f AOT \u7f16\u8bd1\u9636\u6bb5\u751f\u6210\u7684\u201c\u65b9\u6cd5\u7ea7\u4ea7\u7269\u5bb9\u5668\u201d\uff1a\u4fdd\u5b58\u673a\u5668\u7801\u4e0e CodeInfo\uff08\u4ee5\u53ca\u53ef\u9009\u7684 CFI debug info\uff09\uff0c\u5e76\u63d0\u4f9b\u5bf9\u9f50\u540e\u7684 overall size \u8ba1\u7b97\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_compiled_method.h/#1-compiledmethod","title":"1) <code>CompiledMethod</code> \u4fdd\u5b58\u4ec0\u4e48","text":"<ul> <li><code>code_</code>\uff1a\u673a\u5668\u7801 bytes</li> <li><code>codeInfo_</code>\uff1a\u5bf9\u5e94\u7684 <code>CodeInfo</code> bytes\uff08stack map / vreg info / inline info \u7b49\uff09</li> <li>\uff08\u53ef\u9009\uff09<code>CfiInfo</code>\uff1a\u5f53 <code>PANDA_COMPILER_DEBUG_INFO</code> \u5f00\u542f\u65f6\uff0c\u7528\u4e8e\u751f\u6210\u66f4\u51c6\u786e\u7684 unwind/debug \u4fe1\u606f</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/compiler_aot_compiled_method.h/#2-getoverallsize","title":"2) \u4e3a\u4ec0\u4e48\u6709 <code>GetOverallSize()</code>","text":"<p>\u5b83\u6309\u67b6\u6784\u5bf9\u9f50\u7ea6\u675f\u7ec4\u5408\u4e09\u6bb5\u5927\u5c0f\uff1a</p> <ul> <li><code>CodePrefix</code>\uff08\u6309 code alignment\uff09</li> <li><code>code_</code>\uff08round-up \u5230 <code>CodeInfo::ALIGNMENT</code>\uff09</li> <li><code>codeInfo_</code>\uff08round-up \u5230 <code>CodeInfo::SIZE_ALIGNMENT</code>\uff09</li> </ul> <p>\u6267\u884c\u5f15\u64ce\u610f\u4e49\uff1aStackWalker/deopt/\u5f02\u5e38 unwind \u4f9d\u8d56 <code>CodeInfo</code> \u4e0e code \u7684\u76f8\u5bf9\u4f4d\u7f6e\uff1b\u7edf\u4e00\u7684\u5e03\u5c40\u4e0e\u5bf9\u9f50\u662f\u201c\u53ef\u88ab\u53ef\u9760\u89e3\u7801\u201d\u7684\u57fa\u7840\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/","title":"<code>irtoc/scripts/common.irt</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cIRTOC \u811a\u672c\u7684\u201cABI/\u5e38\u91cf/offset \u5e95\u5ea7\u201d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine\uff08Execution Engine\uff09 \u73b0\u5b9e\u610f\u4e49\uff1a<code>interpreter.irt</code> \u7684\u7edd\u5927\u591a\u6570\u5173\u952e\u8bed\u4e49\uff08Frame/Thread/Method/Acc/VReg \u7684 offset\u3001tag\u3001\u4ee5\u53ca entrypoint id\uff09\u90fd\u6765\u81ea\u8fd9\u91cc\u7684 <code>Constants</code> \u4e0e regmap\u3002 \u4f60\u53ea\u8981\u628a\u8fd9\u91cc\u770b\u61c2\uff0c\u540e\u7eed\u8bfb <code>interpreter.irt</code> \u624d\u4e0d\u4f1a\u5728\u201cImm(cross_values::GetXXXOffset)\u201d\u91cc\u8ff7\u8def\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#0-l16l58","title":"0. \u6587\u4ef6\u5b9a\u4f4d\uff08L16\u2013L58\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#01-regmap","title":"0.1 regmap\uff1a\u628a\u201c\u8bed\u4e49\u5bc4\u5b58\u5668\u540d\u5b57\u201d\u7ed1\u5b9a\u5230\u201c\u7269\u7406\u5bc4\u5b58\u5668\u7f16\u53f7\u201d","text":"<ul> <li>L16\u2013L20\uff1a<code>$panda_regmap</code>\uff1a\u5b9a\u4e49 thread register\uff08<code>tr</code>\uff09\u5728\u54ea\u4e2a\u7269\u7406\u5bc4\u5b58\u5668\uff1a</li> <li>arm64: 28</li> <li>arm32: 10</li> <li>x86_64: 15</li> <li>L22\u2013L26\uff1a<code>$arch_regmap</code>\uff1afp/sp/lr/pc\uff08\u67b6\u6784\u7279\u5b9a\uff09\u3002</li> <li>L28\u2013L32\uff1a<code>$args_regmap</code>\uff1aABI \u53c2\u6570\u5bc4\u5b58\u5668\u4e0e\u8fd4\u56de\u5bc4\u5b58\u5668\uff08<code>arg0..argN</code>, <code>ret</code>\uff09\u3002</li> <li>L34\u2013L48\uff1atemps/callees/callers regmap\uff1a\u7528\u4e8e regalloc/\u4e34\u65f6\u5bc4\u5b58\u5668\u89c4\u5212\u3002</li> <li>L50\u2013L58\uff1a\u7ec4\u5408\u6210 <code>$full_regmap</code>\uff0c\u5e76\u6d3e\u751f\u51fa <code>$default_mask/$panda_mask</code> \u7b49 regmask\u3002</li> </ul> <p>\u91cd\u8981\uff1aIRTOC \u811a\u672c\u91cc\u51fa\u73b0\u7684 <code>%tr/%pc/%frame/%acc</code> \u7b49\u201c\u8bed\u4e49\u5bc4\u5b58\u5668\u201d\uff0c\u6700\u7ec8\u4f1a\u901a\u8fc7 regmap/LiveIn/LiveOut \u56fa\u5316\u5230\u786c\u4ef6\u5bc4\u5b58\u5668\uff1b\u8fd9\u4e5f\u662f fast interpreter \u7684\u6838\u5fc3\u6027\u80fd\u6765\u6e90\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#02-mask-l53l77","title":"0.2 mask \u7ea6\u675f\uff08L53\u2013L77\uff09","text":"<ul> <li>L53\u2013L57\uff1a<code>$default_mask</code> \u9ed8\u8ba4\u6392\u9664 temp regs \u4e0e\u7279\u6b8a arch regs\uff08\u4f8b\u5982 lr\uff09\u3002</li> <li>L56\u2013L57\uff1a<code>$panda_mask</code> \u4ece\u9ed8\u8ba4 mask \u91cc\u518d\u53bb\u6389 <code>:tr</code>\uff08thread reg\uff09\u3002</li> <li>L71\u2013L77\uff1aarm32 \u7684\u201c\u5076\u6570\u5bc4\u5b58\u5668\u5bf9\u9f50\u201d\u5904\u7406\uff08\u7f16\u8bd1\u5668\u4fdd\u5b88\u5730\u7528\u4e24\u4e2a\u7269\u7406\u5bc4\u5b58\u5668\u8868\u793a\u4e00\u4e2a\u865a\u62df\u5bc4\u5b58\u5668\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#1-module-constantsoffset-irtoc-imml79","title":"1. <code>module Constants</code>\uff1a\u628a\u8fd0\u884c\u65f6\u5e03\u5c40/offset \u6620\u5c04\u4e3a IRTOC \u53ef\u7528\u7684 Imm\uff08L79\u2013...\uff09","text":"<p>\u8fd9\u4e00\u6bb5\u662f <code>interpreter.irt</code> \u7684\u201c\u5730\u5740\u8ba1\u7b97\u5b57\u5178\u201d\uff0c\u6838\u5fc3\u6a21\u5f0f\u662f\uff1a</p> <ul> <li><code>cross_values::GetXxxOffset(GetArch())</code></li> <li><code>cross_values::GetEntrypointOffset(GetArch(), EntrypointId::YYY)</code></li> <li><code>sizeof(...)</code> / <code>static_cast&lt;uint64_t&gt;(...)</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#11-offset","title":"1.1 \u4e0e\u89e3\u91ca\u5668\u5e27\u76f4\u63a5\u76f8\u5173\u7684 offset\uff08\u9ad8\u9891\uff09","text":"<ul> <li>Frame / VReg / Acc</li> <li><code>VREGISTERS_OFFSET</code> / <code>VREGISTER_SIZE</code> / <code>VREGISTER_VALUE_OFFSET</code></li> <li><code>OBJECT_TAG</code> / <code>PRIMITIVE_TAG</code></li> <li><code>GET_ACC_OFFSET</code> / <code>GET_ACC_MIRROR_OFFSET</code></li> <li><code>FRAME_METHOD_OFFSET</code> / <code>FRAME_PREV_FRAME_OFFSET</code> / <code>FRAME_NEXT_INSTRUCTION_OFFSET</code></li> <li><code>FRAME_INSTRUCTIONS_OFFSET</code> / <code>FRAME_BYTECODE_OFFSET</code> / <code>FRAME_FLAGS_OFFSET</code></li> <li>Thread</li> <li><code>THREAD_FRAME_OFFSET</code>\uff08\u5f53\u524d\u89e3\u91ca\u5668\u5e27\uff09</li> <li><code>THREAD_EXCEPTION_OFFSET</code>\uff08pending exception\uff09</li> <li><code>THREAD_FLAG_OFFSET</code>\uff08safepoint/suspend \u7b49 flag\uff09</li> <li><code>THREAD_INTERPRETER_CACHE_OFFSET</code>\uff08\u89e3\u91ca\u5668 cache\uff09</li> <li>Method</li> <li><code>METHOD_INSTRUCTIONS_OFFSET</code> / <code>METHOD_NUM_VREGS_OFFSET</code> / <code>METHOD_NUM_ARGS_OFFSET</code></li> <li><code>METHOD_COMPILED_ENTRY_POINT_OFFSET</code></li> <li><code>METHOD_NATIVE_POINTER_OFFSET</code>\uff08profiling \u6570\u636e\u7b49\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#12-bridgeentrypoints","title":"1.2 \u89e3\u91ca\u5668/\u7f16\u8bd1\u5668\u4ea4\u754c\uff08bridge/entrypoints\uff09","text":"<p>\u5178\u578b\u5982\uff1a - <code>GET_CALLEE_METHOD</code> / <code>INITIALIZE_CLASS_BY_ID</code> / <code>RESOLVE_CLASS</code>\uff08direct entrypoints\uff09 - <code>ANNOTATE_SANITIZERS_*</code>\uff08sanitizer hook\uff09</p> <p>\u8fd9\u89e3\u91ca\u4e86 <code>interpreter.irt</code> \u91cc\u5927\u91cf <code>call_runtime(\"XxxEntrypoint\", ...)</code>\uff1a\u5b83\u4eec\u4e0d\u662f\u968f\u4fbf\u5b57\u7b26\u4e32\u62fc\u63a5\uff0c\u800c\u662f\u6620\u5c04\u5230 runtime \u7684 entrypoints \u4e0e helper\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_common.irt/#2-irtoc-handler","title":"2. \u65b0\u4eba\u6392\u969c\u5efa\u8bae\uff08\u8bfb IRTOC handler \u4e4b\u524d\u5148\u770b\u8fd9\u91cc\uff09","text":"<ul> <li>\u770b\u5230 <code>Imm(cross_values::GetFrameAccOffset(GetArch()))</code>\uff1a\u56de\u5230\u672c\u6587\u4ef6\u7684 <code>Constants::GET_ACC_OFFSET</code>\uff0c\u786e\u8ba4\u201c\u5b83\u6307\u5411 Frame \u5185\u54ea\u4e2a\u5b57\u6bb5\u201d\u3002</li> <li>\u770b\u5230 tag \u76f8\u5173 bug\uff08\u5bf9\u8c61/\u539f\u59cb\u503c\u6df7\u4e71\uff09\uff1a\u5148\u786e\u8ba4 <code>OBJECT_TAG/PRIMITIVE_TAG</code> \u662f\u4ece <code>cross_values</code> \u83b7\u53d6\uff0c\u4e14\u4e0e <code>Frame/VRegister</code> \u7684\u9759\u6001\u8bed\u8a00 mirror \u5e03\u5c40\u4e00\u81f4\u3002</li> <li>\u770b\u5230\u4e0d\u540c arch \u884c\u4e3a\u4e0d\u540c\uff1a\u4f18\u5148\u68c0\u67e5 regmap\uff08\u54ea\u4e9b\u72b6\u6001\u88ab\u653e\u5230\u56fa\u5b9a\u5bc4\u5b58\u5668\uff09\u4e0e mask\uff08\u54ea\u4e9b\u5bc4\u5b58\u5668\u53ef\u80fd\u88ab regalloc \u590d\u7528\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/","title":"<code>irtoc/scripts/interpreter.irt</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cIRTOC/LLVM Fast Interpreter \u7684\u201c\u771f\u5b9e\u89e3\u91ca\u5668\u8bed\u4e49\u201d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine\uff08Execution Engine\uff09 \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 3.3k \u884c\uff08Ruby DSL\uff0c\u751f\u6210 IRTOC graph / handler\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 fast interpreter \u7684\u5b8c\u6574\u8bed\u4e49\uff1a - \u5185\u90e8 calling convention\uff1a\u56fa\u5b9a\u5bc4\u5b58\u5668\u4fdd\u5b58 <code>tr/pc/frame/acc/dispatch</code>\uff08\u4e0d\u540c arch \u4e0d\u540c\uff09 - dispatch\uff1acomputed-goto \u98ce\u683c\uff08<code>tail_call(addr)</code>\uff09\u5230 <code>HANDLE_FAST_*</code> - \u5f02\u5e38/OSR/stackless call-return\uff1a\u5168\u90e8\u5728\u811a\u672c\u91cc\u4ee5\u5b8f\u7684\u5f62\u5f0f\u7f16\u7801 - \u4e3a\u6bcf\u4e2a bytecode opcode \u751f\u6210\u4e00\u4e2a <code>HANDLE_FAST_&lt;handler_name&gt;</code> \u51fd\u6570</p> <p>\u5f3a\u4f9d\u8d56\uff1a - <code>include_relative 'common.irt'</code>\uff1aregmap/Constants\uff08Frame/Thread/Method \u7684 offset \u4e0e tag\uff09 - build \u4ea7\u7269\u8bc1\u636e\uff1a<code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code>\uff08\u89c4\u8303\u5316\u811a\u672c\uff09\u3001<code>irtoc_code.cpp</code>\uff08Graph \u6784\u9020\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#0-l18l40","title":"0. \u56fa\u5b9a\u5bc4\u5b58\u5668\u4e0e\u6821\u9a8c\uff08L18\u2013L40\uff09","text":"<ul> <li>L18\u2013L23\uff1a<code>fixed_regmap</code>\uff1a\u4e3a fast interpreter \u9009\u62e9\u201c\u6c38\u9a7b\u5bc4\u5b58\u5668\u201d\uff1a</li> <li>x86_64\uff1a<code>dispatch/pc/frame/acc/acc_tag</code></li> <li>arm64\uff1a\u989d\u5916\u6709 <code>moffset/method_ptr</code>\uff08\u907f\u514d\u9891\u7e41\u4ece frame \u8ba1\u7b97 mirror \u504f\u79fb/\u65b9\u6cd5\u6307\u9488\uff09</li> <li>L23\uff1a<code>handler_regmap = $full_regmap + fixed_regmap</code>\uff1ahandler \u4f7f\u7528\u201c\u5168\u5bc4\u5b58\u5668 + \u56fa\u5b9a\u5bc4\u5b58\u5668\u201d\u3002</li> <li>L25\u2013L36\uff1asanity checks\uff08arm64 \u624d\u505a\uff09\uff1a\u786e\u4fdd fixed regs \u4e0d\u4e0e panda/arch/args/caller regs \u51b2\u7a81\u3002</li> <li>L38\u2013L40\uff1a<code>InterpreterValidation.spills_count_max=32</code>\uff1a\u4e0e\u540e\u7eed <code>validation.yaml</code> \u5bf9\u9f50\uff0c\u9650\u5236 spills \u6570\u3002</li> </ul> <p>\u7ed3\u8bba\uff1afast interpreter \u7684\u6838\u5fc3\u662f\u201c\u628a\u89e3\u91ca\u5668\u72b6\u6001\uff08pc/frame/acc\uff09\u653e\u5230\u56fa\u5b9a\u5bc4\u5b58\u5668\u201d\uff0c\u51cf\u5c11\u5185\u5b58\u8bbf\u5b58\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#1-decode-dispatchcomputed-goto-irtoc-l156l413","title":"1. decode + dispatch\uff1acomputed-goto \u7684 IRTOC \u7248\u672c\uff08L156\u2013L413\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#11-decode","title":"1.1 decode","text":"<ul> <li>L158\u2013L206\uff1a<code>readbyte/as_vreg_idx/as_id</code> \u7b49\u5b8f\uff1a\u6309 operand width \u4ece <code>pc</code> \u8bfb\u53d6\u7acb\u5373\u6570/vreg index\u3002</li> <li><code>as_vreg_idx</code> \u76f4\u63a5\u628a\u201c\u7f16\u7801\u5728\u6307\u4ee4\u6d41\u91cc\u7684\u5bc4\u5b58\u5668\u7f16\u53f7\u201d\u8f6c\u4e3a vreg index\uff08\u7528\u4e8e frame slot address \u8ba1\u7b97\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#12-dispatch","title":"1.2 dispatch \u5b8f\uff08\u6700\u5173\u952e\uff09","text":"<p>\u6838\u5fc3\u5728 <code>macro(:dispatch)</code>\uff08L406\u2013L413\uff09\uff1a</p> <ul> <li>L407\uff1a<code>opc := readbyte(pc, 0)</code>\uff1a\u53d6 opcode</li> <li>L408\uff1a<code>offset := Mul(u8toword(opc), WordSize())</code>\uff1a\u8ba1\u7b97 <code>dispatch_table[opc]</code> \u7684\u5730\u5740\u504f\u79fb</li> <li>L409\uff1a<code>addr := Load(table, offset)</code>\uff1a\u8bfb\u51fa handler \u51fd\u6570\u6307\u9488</li> <li>L410\u2013L412\uff1a\u628a <code>pc/table</code> LiveOut \u5230\u56fa\u5b9a\u5bc4\u5b58\u5668</li> <li>L412\uff1a<code>tail_call(addr)</code>\uff1a\u4ee5 TAIL_CALL intrinsic \u8fdb\u5165 handler</li> </ul> <p>\u8fd9\u5c31\u662f computed-goto \u7684\u7b49\u4ef7\u5f62\u5f0f\uff1a\u4e0d\u662f <code>switch</code>\uff0c\u4e5f\u4e0d\u662f\u51fd\u6570\u8fd4\u56de\u518d\u5faa\u73af\uff0c\u800c\u662f\u201c\u5c3e\u8c03\u7528\u8df3\u8f6c\u5230\u4e0b\u4e00 handler\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#2-framevregacc-c-l248l389","title":"2. Frame/VReg/Acc\uff1a\u4e0e C++ \u8bed\u4e49\u4e00\u81f4\uff0c\u4f46\u66f4\u201c\u663e\u5f0f\u201d\uff08L248\u2013L389\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#21-bytecode-offsetdeopt","title":"2.1 bytecode offset\uff08deopt/\u5f02\u5e38/\u8c03\u8bd5\u4f9d\u8d56\uff09","text":"<ul> <li>L248\u2013L255\uff1a<code>ins_offset</code>/<code>update_bytecode_offset</code>\uff1a\u901a\u8fc7 <code>pc - frame-&gt;instructions</code> \u8ba1\u7b97\u5e76\u5199\u56de <code>frame-&gt;bcOffset</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#22-vreg-mirrortag","title":"2.2 vreg \u5730\u5740\u8ba1\u7b97\uff08\u9759\u6001\u8bed\u8a00 mirror/tag\uff09","text":"<ul> <li>L259\u2013L267\uff1a<code>frame_vreg_ptr</code>/<code>vreg_ptr</code>\uff1a<code>frame + VREGISTERS_OFFSET + vreg_idx * VREGISTER_SIZE</code></li> <li>L294\u2013L306\uff1a<code>get_tag/set_tag</code>\uff1atag \u5b58\u5728 mirror \u533a\uff08<code>vreg_ptr + moffset</code>\uff09</li> <li>L312\u2013L320\uff1a<code>set_primitive/set_object</code>\uff1a\u628a tag \u4e0e payload \u540c\u6b65\u5199\u5165</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#23-acc","title":"2.3 acc \u7684\u201c\u5199\u56de/\u6062\u590d\u201d\u662f\u4e0d\u53d8\u91cf","text":"<ul> <li>L331\u2013L358\uff1a<code>save_acc/save_acc_var</code>\uff1a\u628a <code>%acc/%acc_tag</code> \u5199\u56de\u5230 frame \u7684 acc slot\uff08value + mirror\uff09</li> <li>L360\u2013L366\uff1a<code>restore_acc/restore_acc_tag</code>\uff1a\u4ece frame \u8bfb\u56de</li> <li>L373\u2013L379\uff1a<code>set_acc_primitive/set_acc_object</code>\uff1aacc \u7684 tag \u8bed\u4e49\uff08primitive vs object\uff09</li> </ul> <p>\u8fd9\u76f4\u63a5\u89e3\u91ca\u4e86 fast interpreter \u4e2d\u9891\u7e41\u51fa\u73b0\u7684 \u201ccall runtime \u524d save_acc\uff0c\u56de\u6765\u518d restore_acc\u201d\uff1a\u4e3a\u4e86\u8ba9 GC/stackwalker/hook \u80fd\u770b\u5230\u4e00\u81f4\u72b6\u6001\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#3-find_catch_block-move_to_exceptionl509l536","title":"3. \u5f02\u5e38\u5904\u7406\uff1a<code>find_catch_block</code> + <code>move_to_exception</code>\uff08L509\u2013L536\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#31-stackless-iframes-catchruntime","title":"3.1 stackless IFrames \u627e catch\uff08runtime \u4fa7\uff09","text":"<ul> <li>L509\u2013L523\uff1a<code>find_catch_block</code>\uff1a</li> <li>\u8c03 <code>FindCatchBlockInIFrames(tr, frame, pc)</code> \u8fd4\u56de handler_pc</li> <li>\u82e5\u8fd4\u56de <code>pc</code>\uff08\u672a\u627e\u5230\uff09\uff1a<code>Intrinsic(:INTERPRETER_RETURN)</code> \u9000\u51fa\u5230\u4e0a\u5c42\uff08\u7531 runtime \u7ee7\u7eed\u5904\u7406 CFrames\uff09</li> <li>\u5426\u5219\u8bfb\u51fa EH frame\uff08<code>THREAD_FRAME_OFFSET</code>\uff09\u4e0e\u5176 acc\uff0c\u8fd4\u56de handler_pc</li> </ul> <p>\u8fd9\u5c31\u662f\u6211\u4eec\u5728 C++ \u89e3\u91ca\u5668\u4e2d\u603b\u7ed3\u7684\u201c\u4e24\u6bb5\u5f0f\u5f02\u5e38\u201d\uff1a\u5148 stackless IFrames\uff0c\u627e\u4e0d\u5230\u518d\u4ea4\u7ed9 call-stack/CFrames\uff08\u89c1 <code>runtime/exceptions.cpp</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#32-dispatch_table-handler","title":"3.2 \u8fdb\u5165\u5f02\u5e38\u5165\u53e3\uff08dispatch_table \u7684\u201c\u672b\u5c3e handler\u201d\uff09","text":"<ul> <li>L525\u2013L536\uff1a<code>move_to_exception</code>\uff1a</li> <li>\u628a table/frame/(moffset/method_ptr)/tr/pc \u5168\u90e8 LiveOut</li> <li>L534\uff1a<code>addr := Load(table, Panda::dispatch_table.handler_names.size * 8)</code>\uff1a\u53d6 dispatch_table \u7684\u6700\u540e\u4e00\u4e2a slot</li> <li><code>tail_call(addr)</code>\uff1a\u8df3\u5230 <code>HANDLE_FAST_EXCEPTION</code></li> </ul> <p>\u8fd9\u4e0e build \u4ea7\u7269 <code>irtoc_interpreter_utils.h</code> \u5b8c\u5168\u5bf9\u9f50\uff1adispatch_table[391]\uff08\u6700\u540e\u4e00\u4e2a\uff09\u662f <code>HANDLE_FAST_EXCEPTION</code>\uff08\u6216 <code>_LLVM</code> \u7248\u672c\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#4-safepoint-osr-fake-returnl559l644-l2152l2185","title":"4. safepoint + OSR\uff1a\u56de\u8fb9\u63d2\u6869 + fake-return\uff08L559\u2013L644, L2152\u2013L2185\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#41-safepoint-flag","title":"4.1 safepoint\uff08\u7ebf\u7a0b flag \u9a71\u52a8\uff09","text":"<ul> <li>L560\u2013L571\uff1a<code>safepoint(acc_type, is_save_acc)</code>\uff1a</li> <li>\u5982\u679c thread flag \u975e 0\uff0c\u5219\u53ef\u9009 <code>save_acc_var</code>\uff0c\u8c03\u7528 <code>SafepointEntrypointInterp(tr)</code>\uff0c\u5e76\u6062\u590d acc</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#42-osr","title":"4.2 \u56de\u8fb9\u63d2\u6869\uff1aOSR \u89e6\u53d1\u70b9\u5c31\u5728\u5206\u652f\u91cc","text":"<p>\u5178\u578b\u51fa\u73b0\u5728 <code>handle_jmp_*</code> \u7cfb\u5217\uff1a</p> <ul> <li>L610\u2013L644\uff1a<code>instrument_branches(imm, acc_type, method_ptr)</code>\uff1a</li> <li><code>imm &lt;= 0</code> \u8868\u793a\u56de\u8fb9\uff1a\u5148\u505a safepoint</li> <li>hotness&lt;=0\uff1a\u8c03\u7528 <code>CallCompilerSlowPathOSR(...)</code></li> <li>\u82e5 OSR \u6210\u529f\uff1aL620 \u8c03 <code>handle_fake_return()</code>\uff08\u5f3a\u5236\u4ece\u5f53\u524d frame \u9000\u51fa\u5230 caller\uff09</li> <li>\u901a\u8fc7\u4e00\u7ec4 Phi \u628a <code>acc/frame/pc</code> \u66f4\u65b0\u4e3a \u201c\u6b63\u5e38\u7ee7\u7eed\u6267\u884c\u201d\u6216\u201cfake-return \u540e\u7684\u72b6\u6001\u201d</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#43-fake-return-return-osr","title":"4.3 fake-return\uff1a\u8ba9\u89e3\u91ca\u5668\u5faa\u73af\u201c\u50cf return \u4e00\u6837\u9000\u51fa\u201d\u53bb\u8fdb\u5165 OSR","text":"<ul> <li>L2152\u2013L2185\uff1a<code>handle_fake_return</code>\uff1a</li> <li>\u82e5\u5f53\u524d\u4e0d\u662f stackless\uff1a\u76f4\u63a5 <code>Intrinsic(:INTERPRETER_RETURN)</code>\uff08\u9000\u51fa\u5230 runtime\uff09</li> <li>\u5426\u5219\uff1a<ul> <li>\u53d6 <code>fake_frame = prev_frame</code>\uff0c<code>fake_pc = prev_frame-&gt;nextInst</code></li> <li>\u82e5 <code>IS_INITOBJ</code>\uff1aacc \u4ece prev_frame \u7684 acc \u53d6 object\uff1b\u5426\u5219\u4ece\u5f53\u524d frame restore_acc</li> <li><code>THREAD_FRAME_OFFSET = fake_frame</code>\uff0c\u5e76 <code>FreeFrameInterp(cur_frame, tr)</code></li> <li>\u82e5\u5b58\u5728 pending exception\uff1a\u628a pc \u8bbe\u7f6e\u5230 fake_frame \u4e0a\u5e76 <code>move_to_exception</code></li> </ul> </li> </ul> <p>\u8fd9\u6bb5\u662f OSR \u7684\u5173\u952e\u96be\u70b9\uff1aOSR \u6210\u529f\u540e\u5e76\u4e0d\u662f\u201c\u76f4\u63a5\u8df3\u5230 OSR code\u201d\uff0c\u800c\u662f\u8ba9\u89e3\u91ca\u5668\u901a\u8fc7\u201c\u4f2a\u9020 return \u5f39\u6808\u201d\u56de\u5230\u67d0\u4e2a\u7a33\u5b9a\u8fb9\u754c\uff0c\u518d\u7531\u4e0a\u5c42\u8fdb\u5165 OSR\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#5-generic_callgeneric_returnl780l877","title":"5. \u8c03\u7528/\u8fd4\u56de\uff1a<code>generic_call</code>/<code>generic_return</code>\uff08L780\u2013L877\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#51-generic_call","title":"5.1 <code>generic_call</code>\uff1a\u4e24\u6761\u8def","text":"<ul> <li>L780\u2013L840\uff1a<code>generic_call(id, size, is_initobj, callee, nargs, copy_lambda)</code>\uff1a   1) callee \u5df2\u7f16\u8bd1\uff08L787\u2013L801\uff09<ul> <li>\u8bfb <code>callee-&gt;compiled_entrypoint</code></li> <li><code>IsCompiled(entrypoint)</code> \u4e3a\u771f\uff1a    -\uff08\u975e initobj\uff09\u4fdd\u5b58 acc</li> <li>\u8c03 <code>InterpreterToCompiledCodeBridge(pc, frame, callee, tr)</code>\uff08I2C\uff09</li> <li>\u6062\u590d <code>Thread</code> \u7684 <code>FrameKind</code> \u4e0e <code>THREAD_FRAME_OFFSET</code></li> <li>\u68c0\u67e5 exception\uff1b\u4ece frame restore acc\uff1bpc \u524d\u8fdb   2) callee \u672a\u7f16\u8bd1\uff08L803\u2013L839\uff09</li> <li>\u53d6 <code>pc_int = get_instructions(callee)</code>\uff0c<code>num_vregs = get_numvregs(callee)</code></li> <li>\u5206\u914d\u65b0 frame\uff1a<code>create_frame(frame_size, callee)</code> \u5e76\u6807\u8bb0 <code>Frame::IS_STACKLESS</code></li> <li><code>copy_lambda</code> \u8d1f\u8d23\u628a\u5b9e\u53c2\u62f7\u8d1d\u5230\u65b0 frame \u7684 vregs\uff08\u542b acc \u53c2\u4e0e\u7684 call_acc \u53d8\u4f53\uff09</li> <li>\u8bbe\u7f6e <code>prev_frame/next_instruction/instructions</code>\uff0c\u5e76\u628a <code>THREAD_FRAME_OFFSET</code> \u6307\u5411\u65b0 frame</li> </ul> </li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 fast interpreter \u540c\u6837\u4f9d\u8d56 \u201cstackless frame \u5f39\u6808\u201d\uff1a\u672a\u7f16\u8bd1\u8c03\u7528\u4f1a\u8d70\u89e3\u91ca\u5668\u6808\u5e27\u94fe\uff1b\u5df2\u7f16\u8bd1\u8c03\u7528\u5219\u8d70 I2C\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#52-generic_returnstackless-or-runtime","title":"5.2 <code>generic_return</code>\uff1astackless \u5f39\u6808 or \u9000\u51fa\u5230 runtime","text":"<ul> <li>L859\u2013L877\uff1a</li> <li>\u82e5 <code>IS_STACKLESS</code>\uff1a\u53d6 prev_frame/next_pc\uff0ccopy \u8fd4\u56de\u503c\u5230 prev_frame\uff0c\u66f4\u65b0 <code>THREAD_FRAME_OFFSET</code>\uff0cfree_frame\uff0c\u56de\u5230 caller \u7ee7\u7eed\u6267\u884c</li> <li>\u5426\u5219\uff1a<code>save_acc(); Intrinsic(:INTERPRETER_RETURN)</code>\uff08\u8fd4\u56de\u5230 runtime \u8fb9\u754c\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#6-method-resolutionget_calleel2000l2031","title":"6. method resolution\uff1a<code>get_callee</code>\uff08L2000\u2013L2031\uff09","text":"<ul> <li>L2001\uff1a<code>update_bytecode_offset</code>\uff1a\u786e\u4fdd frame-&gt;bcOffset \u4e0e pc \u5bf9\u9f50\uff08deopt/\u5f02\u5e38/\u8c03\u8bd5\u4f9d\u8d56\uff09</li> <li>L2003\u2013L2010\uff1a</li> <li>initobj\uff1a\u8d70 cache_entry\uff0c\u4f46\u4e0d\u8d70 slowpath\uff08nil\uff09</li> <li>\u975e initobj\uff1a<code>callee_ptr(id, need_save=true)</code>\uff0c\u9700\u8981\u65f6 restore acc\uff1bcallee \u4e3a\u7a7a\u5219 <code>move_to_exception</code></li> <li>L2012\u2013L2027\uff08\u975e initobj \u7684 receiver/\u865a\u8c03\u7528\uff09\uff1a</li> <li>\u82e5\u975e static\uff1a\u8bfb\u53d6 receiver\uff08\u53ef\u80fd\u6765\u81ea acc \u6216 vreg\uff0c\u53d6\u51b3\u4e8e imm\uff09</li> <li>receiver \u4e3a null\uff1a\u629b NPE \u5e76 <code>move_to_exception</code></li> <li>virt call\uff1a<code>ResolveVirtualMethod(callee, frame, receiver_ref, pc, method_ptr)</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#7-handler-pandainstructionseachl2407","title":"7. handler \u751f\u6210\uff1a<code>Panda.instructions.each</code>\uff08L2407\u2013...\uff09","text":"<p>\u811a\u672c\u672b\u5c3e\u4f1a\u904d\u5386 ISA \u63cf\u8ff0\uff0c\u4e3a\u6bcf\u4e2a opcode \u751f\u6210 <code>HANDLE_FAST_&lt;handler_name&gt;</code>\uff1a</p> <ul> <li>\u901a\u8fc7 <code>handler_name = i.handler_name.gsub(/_PROF\\\\d+/, '')</code> \u53bb\u6389 profile suffix</li> <li>\u6784\u9020\u51fd\u6570\u65f6\u4f1a\uff1a   -\uff08dynamic \u6307\u4ee4\uff09\u5148 <code>save_acc</code>\uff08\u6e90\u7801\u6ce8\u91ca\u6807\u6ce8\u4e3a planned removal\uff1a\u8fd9\u4e0d\u662f\u672c\u7ae0\u9057\u6f0f\uff0c\u800c\u662f\u4e0a\u6e38\u5b9e\u73b0\u7684\u5df2\u77e5\u6f14\u8fdb\u70b9\uff09</li> <li>debug \u6a21\u5f0f\u4e0b\u505a tag/assert \u6821\u9a8c\uff08\u5927\u91cf <code>assert_has_object_eq/ne</code>\uff09</li> <li><code>case handler_name</code> \u91cc\u8c03\u7528\u5bf9\u5e94\u7684 <code>handle_xxx</code> \u5b8f\uff08\u4f8b\u5982 mov/lda/call/branch \u7b49\uff09</li> </ul> <p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 <code>build/runtime/include/irtoc_interpreter_utils.h</code> \u80fd\u679a\u4e3e\u51fa 392 \u4e2a <code>HANDLE_FAST_*</code>\uff1a\u5b83\u4eec\u7531\u8fd9\u91cc\u81ea\u52a8\u751f\u6210\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/irtoc_scripts_interpreter.irt/#build","title":"\u8bc1\u636e\u94fe\uff08build/ \u5bf9\u7167\uff09","text":"<ul> <li>dispatch table\uff08392 \u9879 + EXCEPTION slot\uff09\uff1a<code>build/runtime/include/irtoc_interpreter_utils.h</code></li> <li>\u89c4\u8303\u5316\u811a\u672c\uff1a<code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code></li> <li>\u751f\u6210\u7684 Graph \u6784\u9020\uff1a<code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code></li> <li>runtime \u5165\u53e3\u8c03\u7528\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/","title":"<code>isa/isa.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cCore ISA\uff1aopcode \u7684\u201c\u89c4\u8303\u6e90\u201d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 3.4k \u884c\uff08ISA \u89c4\u8303 + \u5168\u91cf core \u6307\u4ee4\u8868\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 Panda VM \u7684 core bytecode\uff1a\u5bc4\u5b58\u5668/acc \u6a21\u578b\u3001calling sequence\u3001prefixes\u3001\u6307\u4ee4\u96c6\u5408\u3001encoding formats\u3001verification \u4e0e exceptions\u3002 \u201c\u6267\u884c\u5f15\u64ce\u201d\u7ae0\u8282\u4e3a\u4ec0\u4e48\u5fc5\u987b\u5305\u542b\u5b83\uff1a\u56e0\u4e3a IRTOC fast interpreter \u7684 <code>Panda.instructions</code> \u5c31\u662f\u7531 ISA \u9a71\u52a8\u751f\u6210\u7684\u2014\u2014\u4f60\u60f3\u7406\u89e3 <code>HANDLE_FAST_CALL_*</code>\u3001<code>HANDLE_FAST_JMP_*</code>\u3001<code>HANDLE_FAST_RETURN_*</code> \u7684\u8bed\u4e49\uff0c\u5fc5\u987b\u56de\u5230 ISA\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#0-chaptersl16l105","title":"0) \u9876\u5c42 <code>chapters</code>\uff1a\u89e3\u91ca\u5668\u6a21\u578b\u7684\u201c\u89c4\u8303\u6587\u5b57\u201d\uff08L16\u2013L105\uff09","text":"<p>\u8fd9\u4e00\u6bb5\u4e0d\u662f\u5b9e\u73b0\uff0c\u4f46\u5b83\u662f\u6240\u6709\u5b9e\u73b0\u5fc5\u987b\u6ee1\u8db3\u7684\u8bed\u4e49\u5951\u7ea6\uff0c\u5c24\u5176\u5bf9\u65b0\u540c\u5b66\u975e\u5e38\u91cd\u8981\uff1a</p> <ul> <li>VM \u662f register-based + accumulator\uff08General Design / Accumulator\uff09</li> <li>Calling Sequence\uff08\u6700\u5173\u952e\uff09\uff1a</li> <li>call \u4f1a\u521b\u5efa\u65b0 frame \u5e76\u590d\u5236\u53c2\u6570</li> <li>callee \u7684 accumulator \u89c6\u4e3a undefined\uff08verified bytecode \u4e0d\u5e94\u8bfb\u53d6\uff09</li> <li>return \u628a\u7ed3\u679c\u901a\u8fc7 accumulator \u8fd4\u7ed9 caller\uff1b<code>return.void</code> \u540e caller \u7684 accumulator \u4e5f\u89c6\u4e3a undefined</li> </ul> <p>\u8fd9\u76f4\u63a5\u89e3\u91ca\u4e86\uff1a\u4e3a\u4ec0\u4e48 IRTOC \u7684 <code>generic_call</code> \u4f1a\u521b\u5efa stackless frame + \u8bbe\u7f6e next_pc\uff0c\u4e3a\u4ec0\u4e48 <code>generic_return</code> \u5728 stackless \u60c5\u51b5\u4e0b\u628a acc copy \u56de caller frame\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#1-propertiesl110l155","title":"1) <code>properties</code>\uff1a\u6307\u4ee4\u8bed\u4e49\u6807\u7b7e\uff08L110\u2013L155\uff09","text":"<p>\u8fd9\u91cc\u7684 tag\uff08\u5982 <code>call/return/jump/init_obj/any_call</code>\uff09\u7528\u4e8e\uff1a</p> <ul> <li>\u628a\u6307\u4ee4\u5206\u7ec4\uff08\u751f\u6210\u5668/\u4f18\u5316\u5668/\u9a8c\u8bc1\u5668\uff09</li> <li>\u63a7\u5236\u67d0\u4e9b\u751f\u6210\u7b56\u7565\uff08\u4f8b\u5982 call/branch \u76f8\u5173\u63d2\u6869\uff09</li> </ul> <p>\u65b0\u4eba\u5e38\u89c1\u8bef\u533a\uff1aproperties \u4e0d\u662f runtime flag\uff0c\u4f46\u5b83\u51b3\u5b9a\u201c\u54ea\u4e9b\u6307\u4ee4\u9700\u8981\u7279\u522b\u7684\u6846\u67b6\u903b\u8f91\u201d\uff08call/return/branch\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#2-exceptions-verificationl155l251","title":"2) <code>exceptions</code> / <code>verification</code>\uff1a\u6b63\u786e\u6027\u7ea6\u675f\u7684\u201c\u89c4\u8303\u6e90\u201d\uff08L155\u2013L251\uff09","text":"<ul> <li><code>exceptions</code>\uff1a\u5982 <code>x_null/x_bounds/x_call/x_oom/x_throw</code></li> <li><code>verification</code>\uff1a\u5982 <code>branch_target/acc_obj_or_null/v1_object/method_id_non_static</code></li> </ul> <p>\u8fd9\u4e24\u90e8\u5206\u662f\uff1a - \u89e3\u91ca\u5668\u5b9e\u73b0\u5f02\u5e38\u8def\u5f84\u7684\u4f9d\u636e\uff08throw/catch/unwind\uff09 - verify \u9636\u6bb5\u4fdd\u8bc1\u201c\u54ea\u4e9b\u884c\u4e3a\u4e0d\u4f1a\u53d1\u751f\u201d\u7684\u4f9d\u636e\uff08\u4f8b\u5982 acc undefined \u4e0d\u80fd\u8bfb\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#3-prefixescore-opcodel252l268","title":"3) <code>prefixes</code>\uff1acore \u524d\u7f00 opcode\uff08L252\u2013L268\uff09","text":"<p>core \u672c\u8eab\u5c31\u4f7f\u7528\u524d\u7f00\u6269\u5c55 opcode \u7a7a\u95f4\uff1a</p> <ul> <li><code>bit/unsigned/cast/f32/any</code>\uff0c\u5e76\u5404\u81ea\u6709 <code>opcode_idx</code></li> </ul> <p>\u8fd9\u51b3\u5b9a\u4e86 encoding \u4e2d\uff1a - <code>pref_op_*</code> \u8fd9\u79cd format \u7684\u5b58\u5728 - \u89e3\u91ca\u5668 decode \u9700\u8981\u5148\u8bc6\u522b prefix\uff0c\u518d\u89e3\u91ca\u540e\u7eed operands</p>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#4-groups-instructions","title":"4) <code>groups</code> / <code>instructions</code>\uff1a\u6307\u4ee4\u8868\uff08\u6838\u5fc3\uff09","text":"<p>\u6bcf\u4e2a group \u901a\u5e38\u5305\u542b\uff1a</p> <ul> <li><code>title/description/pseudo</code></li> <li><code>exceptions/verification/properties</code></li> <li><code>instructions</code> \u5217\u8868\uff1a\u6bcf\u6761\u6307\u4ee4\u7ed9\u51fa\uff1a</li> <li><code>sig</code>\uff1a\u8bed\u6cd5\u7b7e\u540d\uff08\u5305\u542b\u64cd\u4f5c\u6570\u3001\u65b9\u5411\u3001\u7c7b\u578b\uff09</li> <li><code>acc</code>\uff1aacc \u7684 in/out/inout \u8bed\u4e49</li> <li><code>format</code>\uff1aencoding \u6a21\u677f\uff08\u51b3\u5b9a decode \u5982\u4f55\u8bfb operand\uff09</li> <li><code>opcode_idx</code>\uff1a\u5b9e\u9645 opcode \u7f16\u53f7\uff08\u6216 prefix \u4e0b\u7684\u7d22\u5f15\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#41-opcode","title":"4.1 \u5e38\u7528 opcode \u7684\u201c\u6e90\u5934\u4f4d\u7f6e\u201d\uff08\u5efa\u8bae\u65b0\u540c\u5b66\u5148\u770b\uff09","text":"<ul> <li>branch/jmp\uff1a<code>jmp</code>/<code>jeqz/jnez/...</code> \u8fd9\u7c7b\u6307\u4ee4\u7684 pseudo + <code>branch_target</code> \u9a8c\u8bc1</li> <li>call/return\uff1a<code>call.*</code> / <code>return.*</code> / <code>return.void</code></li> <li>throw\uff1a<code>throw v:in:ref</code></li> <li>ldobj/stobj\uff1afield \u8bbf\u95ee\u4e0e <code>field_id</code> \u8bed\u4e49</li> </ul> <p>\u5b83\u4eec\u5728 IRTOC \u91cc\u5206\u522b\u5bf9\u5e94\uff1a</p> <ul> <li><code>HANDLE_FAST_JMP_IMM*</code>\uff08\u5e76\u5728 backedge \u4e0a\u505a OSR \u63d2\u6869\uff09</li> <li><code>HANDLE_FAST_CALL_*</code> / <code>HANDLE_FAST_RETURN_*</code></li> <li><code>HANDLE_FAST_THROW_V8</code></li> <li><code>HANDLE_FAST_LDOBJ_*</code> / <code>HANDLE_FAST_STOBJ_*</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/isa_isa.yaml/#5-isa-irtoc","title":"5) ISA \u5982\u4f55\u8fdb\u5165 IRTOC \u7684\u751f\u6210\u94fe\uff08\u4f60\u8981\u8bb0\u4f4f\u7684\u6865\u6881\uff09","text":"<p>\u5728 <code>irtoc/scripts/interpreter.irt</code> \u672b\u5c3e\uff1a</p> <ul> <li><code>Panda.instructions.each do |i| ... function(\"HANDLE_FAST_#{handler_name}\") ... end</code></li> </ul> <p>\u800c <code>handler_name</code> \u7684\u547d\u540d\u6765\u81ea ISA \u751f\u6210\u5de5\u5177\uff08\u901a\u5e38\u628a mnemonic + operand encoding \u5f62\u6001\u7f16\u7801\u8fdb\u540d\u5b57\uff0c\u4f8b\u5982 <code>CALL_RANGE_V8_ID16</code>\uff09\u3002 \u6700\u7ec8\uff1a</p> <ul> <li><code>HANDLE_FAST_*</code> \u8fdb\u5165 <code>build/runtime/include/irtoc_interpreter_utils.h</code> \u7684 392 \u9879 dispatch table</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/","title":"<code>plugins/ets/isa/isa.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cETS ISA \u6269\u5c55\uff1aname-based field/method \u6307\u4ee4\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a349 \u884c\uff08\u76f8\u5bf9\u7cbe\u70bc\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 ETS \u7684 prefix \u6307\u4ee4\u6269\u5c55\uff08<code>ets.*</code>\uff09\uff0c\u628a\u201c\u6309\u540d\u5b57\u8bbf\u95ee field/method\u201d\u4f5c\u4e3a bytecode \u4e00\u7ea7\u8bed\u4e49\u66b4\u9732\u51fa\u6765\u3002 \u6267\u884c\u5f15\u64ce\u89d2\u5ea6\u7684\u5173\u952e\u70b9\uff1a\u8fd9\u4e9b\u6307\u4ee4\u5728 IRTOC fast interpreter \u4e2d\u6709\u4e13\u95e8\u7684 <code>HANDLE_FAST_ETS_*</code>\uff0c\u5e76\u4e14\u5927\u91cf\u8d70 runtime slowpath\uff08lookup_field_by_name / lookup_method_by_name / throw ETS \u4e13\u7528\u5f02\u5e38\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#1-prefix-namespacel14l21","title":"1) prefix \u4e0e namespace\uff08L14\u2013L21\uff09","text":"<ul> <li>L14\u2013L17\uff1a\u58f0\u660e <code>prefixes: ets</code>   \u8fd9\u610f\u5473\u7740 ETS \u6307\u4ee4\u4f7f\u7528 <code>pref_op_*</code> \u7f16\u7801\u683c\u5f0f\uff0c\u5e76\u5728 dispatch table \u4e2d\u4ee5 <code>HANDLE_FAST_ETS_*_PREF_*</code> \u547d\u540d\u3002</li> <li>L18\u2013L21\uff1a<code>namespaces: ets</code>\uff0c<code>quickening: false</code>\uff08ETS \u6307\u4ee4\u4e0d\u8d70 quickening\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#2-aetsldobjnamel26l77","title":"2) \u6307\u4ee4\u65cf A\uff1a<code>ets.ldobj.name*</code>\uff08L26\u2013L77\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#21-pseudo","title":"2.1 \u89c4\u8303\u8bed\u4e49\uff08pseudo\uff09","text":"<p>\u5173\u952e\u8bed\u4e49\uff08L38\u2013L55\uff09\uff1a</p> <ul> <li>v\uff08\u5bf9\u8c61\uff09\u4e3a null \u2192 NPE</li> <li><code>resolve_field_by_name(field_id)</code>\uff1a</li> <li>\u547d\u4e2d field \u2192 \u8bfb\u5b57\u6bb5\uff1b\u5bf9\u5c0f\u4e8e 32 \u4f4d\u7684\u5b57\u6bb5\u505a extend to i32\uff08<code>ets.ldobj.name</code> \u7279\u6709\uff09</li> <li>\u672a\u547d\u4e2d \u2192 <code>resolve_getter_by_name</code>\uff0c\u5b58\u5728\u5219\u8c03\u7528 getter\uff0c\u5426\u5219\u629b ETS \u4e13\u7528\u5f02\u5e38</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#22-sigformat","title":"2.2 \u6307\u4ee4\u5b9a\u4e49\uff08sig/format\uff09","text":"<ul> <li><code>ets.ldobj.name v:in:ref, field_id</code>\uff1a</li> <li><code>format: pref_op_v_8_id_32</code></li> <li>acc: out:b32</li> <li><code>ets.ldobj.name.64 ...</code>\uff1aacc: out:b64</li> <li><code>ets.ldobj.name.obj ...</code>\uff1aacc: out:ref</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#23-irtoc-handler","title":"2.3 \u4e0e IRTOC handler \u7684\u5bf9\u9f50\uff08\u5de5\u7a0b\u951a\u70b9\uff09","text":"<p>\u5728 <code>build/runtime/include/irtoc_interpreter_utils.h</code> \u4e2d\u53ef\u89c1\u5bf9\u5e94 handler \u540d\u79f0\uff1a</p> <ul> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_PREF_V8_ID32</code></li> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_64_PREF_V8_ID32</code></li> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_OBJ_PREF_V8_ID32</code></li> </ul> <p>\u5b83\u4eec\u7684\u8bed\u4e49\u5b9e\u73b0\u6765\u81ea <code>irtoc/scripts/interpreter.irt</code> \u4e2d\u7684 <code>handle_ets_ldobj_name_*</code> \u5b8f\uff08\u5728 build \u7684 <code>interpreter.irt.fixed</code> \u4e2d\u53ef\u76f4\u63a5\u770b\u5230\u540c\u540d\u5b8f\u5c55\u5f00\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#3-betsstobjnamel78l131","title":"3) \u6307\u4ee4\u65cf B\uff1a<code>ets.stobj.name*</code>\uff08L78\u2013L131\uff09","text":"<p>\u8bed\u4e49\u7c7b\u4f3c\uff0c\u4f46\u662f\u5199\u5b57\u6bb5\uff1a</p> <ul> <li>field \u547d\u4e2d\uff1a\u6309\u5b57\u6bb5\u4f4d\u5bbd\uff08&lt;32\uff09\u622a\u65ad\u540e\u5199\u5165</li> <li>field \u4e0d\u5b58\u5728\uff1a\u627e setter \u5e76\u8c03\u7528\uff0c\u5426\u5219\u629b ETS \u4e13\u7528\u5f02\u5e38</li> </ul> <p>acc \u662f\u8f93\u5165\uff08<code>acc: in:b32/b64/ref</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#4-cetscallnamel132l190","title":"4) \u6307\u4ee4\u65cf C\uff1a<code>ets.call.name*</code>\uff08L132\u2013L190\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#41-pseudo","title":"4.1 \u89c4\u8303\u8bed\u4e49\uff08pseudo\uff09","text":"<ul> <li>args[0]\uff08receiver\uff09\u4e3a null \u2192 NPE</li> <li><code>resolve_method_by_name(method_id)</code></li> <li>abstract \u2192 AbstractMethodError</li> <li>else \u2192 <code>acc = call(method, args)</code></li> <li>not found \u2192 ETS no_such_method_error</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#42-short-long-range","title":"4.2 \u4e09\u79cd\u5f62\u6001\uff08short / long / range\uff09","text":"<ul> <li><code>ets.call.name.short method_id, v1, v2</code>\uff1a\u6700\u591a 2 \u4e2a\u989d\u5916\u53c2\u6570\uff08\u542b receiver \u4e00\u5171 \u2264 3/4 \u7c7b\u4f3c\uff09</li> <li><code>ets.call.name method_id, v1..v4</code>\uff1a\u6700\u591a 4 \u4e2a\u5bc4\u5b58\u5668\u53c2\u6570</li> <li><code>ets.call.name.range method_id, v</code>\uff1arange \u7248\u672c</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#43-irtoc-handler","title":"4.3 \u4e0e IRTOC handler \u7684\u5bf9\u9f50","text":"<p>\u5bf9\u5e94 handler \u540d\u79f0\uff08\u5728 <code>irtoc_interpreter_utils.h</code> \u53ef\u89c1\uff09\uff1a</p> <ul> <li><code>HANDLE_FAST_ETS_CALL_NAME_SHORT_PREF_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_ETS_CALL_NAME_PREF_V4_V4_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_ETS_CALL_NAME_RANGE_PREF_V8_ID16</code></li> </ul> <p>\u5176\u5b9e\u73b0\u901a\u5e38\u4f1a\u201c\u5148 name-based lookup\uff0c\u518d\u590d\u7528 <code>generic_call</code> \u8d70 I2C/stackless \u4e24\u6761\u8def\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/plugins_ets_isa_isa.yaml/#5-ets-nullvalueequalstypeofnullcheckl191l349","title":"5) ETS \u7684 nullvalue/equals/typeof/nullcheck\uff08L191\u2013L349\uff09","text":"<p>\u8fd9\u4e9b\u6307\u4ee4\u4e3a ETS \u8bed\u4e49\u63d0\u4f9b\u989d\u5916\u539f\u8bed\uff1a</p> <ul> <li><code>ets.ldnullvalue / ets.movnullvalue / ets.isnullvalue</code></li> <li><code>ets.equals / ets.strictequals</code></li> <li><code>ets.typeof / ets.istrue / ets.nullcheck</code></li> </ul> <p>\u6267\u884c\u5f15\u64ce\u89c6\u89d2\uff1a - \u5f88\u591a\u4f1a\u8d70 runtime entrypoint\uff08\u4f8b\u5982 <code>EtsGetTypeofEntrypoint</code>\u3001<code>EtsIstrueEntrypoint</code>\u3001<code>EtsNullcheck</code> \u7b49\uff09\uff0c\u5e76\u9700\u8981\u6b63\u786e\u7684\u5f02\u5e38\u8def\u5f84\u5904\u7406\uff08<code>move_to_exception</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/","title":"<code>quickener/quick.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5de5\u5177\u5165\u53e3\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a<code>arkquicker</code> \u5de5\u5177\u7684 CLI \u5165\u53e3\uff1a\u8bfb\u53d6 panda \u6587\u4ef6\u5bb9\u5668\uff0c\u8c03\u7528 <code>ark::quick::Quickener</code> \u6267\u884c quickening\uff0c\u7136\u540e\u5199\u56de\u8f93\u51fa\u6587\u4ef6\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/#1","title":"1) \u8fd9\u6587\u4ef6\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u672c\u6587\u4ef6\u4e0d\u5b9e\u73b0 quickening \u7684\u201c\u7b97\u6cd5\u89c4\u5219\u201d\uff0c\u800c\u662f\u628a\u5de5\u5177\u8dd1\u8d77\u6765\uff0c\u8ba9 quickening \u80fd\u4f5c\u4e3a\u201c\u6267\u884c\u524d\u53d8\u6362\u5c42\u201d\u843d\u5230\u5de5\u7a0b\u91cc\uff1a</p> <ul> <li>\u8f93\u5165\uff1a<code>INPUT_FILE</code>\uff08panda file container\uff09</li> <li>\u5904\u7406\uff1a<code>Quickener::QuickContainer()</code></li> <li>\u8f93\u51fa\uff1a<code>OUTPUT_FILE</code>\uff08\u5199\u56de\u540e\u7684 panda file\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/#2-cli-help-parse-process","title":"2) CLI \u7ed3\u6784\uff1aHelp / Parse / Process","text":"<ul> <li><code>PrintHelp(pa_parser)</code>\uff1a\u6253\u5370\u7528\u6cd5\u4e0e\u53c2\u6570\u5e2e\u52a9\uff08<code>pa_parser.GetHelpString()</code>\uff09\u3002</li> <li><code>ParseArgs(pa_parser, argc, argv)</code>\uff1a\u8c03\u7528 <code>PandArgParser::Parse</code>\uff1b\u5931\u8d25\u5219\u6253\u5370 help \u5e76\u8fd4\u56de false\u3002</li> <li><code>ProcessArgs(...)</code>\uff1a</li> <li>\u68c0\u67e5 <code>INPUT/OUTPUT</code> \u662f\u5426\u4e3a\u7a7a\uff0c\u6216 <code>--help</code> \u662f\u5426\u6253\u5f00\uff1b</li> <li>\u521d\u59cb\u5316 logger\uff1a\u53ea\u5f00 <code>ERROR</code> \u7b49\u7ea7\uff0c\u5e76\u542f\u7528 <code>QUICKENER</code> \u4e0e <code>PANDAFILE</code> \u7ec4\u4ef6\uff0c\u907f\u514d\u5de5\u5177\u8f93\u51fa\u8fc7\u591a\u566a\u97f3\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/#3-main","title":"3) \u4e3b\u6d41\u7a0b\uff1a<code>main</code>\uff08\u5de5\u5177\u95ed\u73af\uff09","text":"<p><code>main</code> \u7684\u804c\u8d23\u662f\u201c\u8bfb \u2192 quicken \u2192 \u5199\u201d\uff1a</p> <ul> <li>\u53c2\u6570\u5b9a\u4e49\uff1a</li> <li><code>help</code>\uff1a<code>--help</code></li> <li><code>input/output</code>\uff1a\u4e24\u4e2a tail \u53c2\u6570\uff08\u4f4d\u7f6e\u53c2\u6570\uff09</li> <li>\u8bfb\u8f93\u5165\uff1a</li> <li><code>ark::panda_file::File::Open(input)</code></li> <li><code>ark::panda_file::FileReader reader(std::move(input_file))</code></li> <li><code>reader.ReadContainer()</code>\uff1a\u8bfb container\uff08\u5931\u8d25\u76f4\u63a5\u8fd4\u56de\uff09</li> <li><code>ark::panda_file::ItemContainer *container = reader.GetContainerPtr()</code></li> <li>\u6267\u884c quickening\uff1a</li> <li>\u6784\u9020 <code>ark::quick::Quickener</code>\uff1a\u4f20\u5165 <code>container</code>\u3001<code>File*</code>\u3001<code>items</code></li> <li>\u8c03 <code>quickener.QuickContainer()</code></li> <li>\u5199\u8f93\u51fa\uff1a</li> <li><code>ark::panda_file::FileWriter(output)</code></li> <li><code>container-&gt;Write(&amp;writer, false)</code>\uff08\u5931\u8d25\u76f4\u63a5\u8fd4\u56de\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/#4","title":"4) \u6392\u969c\u6293\u624b\uff08\u65b0\u4eba\u6700\u5e38\u89c1\u95ee\u9898\uff09","text":"<ul> <li>\u6253\u4e0d\u5f00\u8f93\u5165\u6587\u4ef6\uff1a\u770b <code>File::Open</code> \u8fd4\u56de\u503c\u4e0e <code>LOG(ERROR, QUICKENER)</code>\u3002</li> <li>container \u8bfb\u5931\u8d25\uff1a\u770b <code>ReadContainer()</code> \u662f\u5426\u8fd4\u56de false\u3002</li> <li>\u5199\u8f93\u51fa\u5931\u8d25\uff1a\u770b <code>FileWriter</code> \u6784\u9020\u3001\u4ee5\u53ca <code>container-&gt;Write(...)</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/quickener_quick.cpp/#5-04","title":"5) \u4e0e 04 \u7ae0\u6267\u884c\u5f15\u64ce\u7684\u8fb9\u754c","text":"<ul> <li>\u89e3\u91ca\u5668/JIT/AOT \u662f \u8fd0\u884c\u65f6\u6267\u884c\u5f15\u64ce\uff1b</li> <li>quickener \u662f \u6267\u884c\u524d/\u79bb\u7ebf\u5de5\u5177\u94fe\uff0c\u5b83\u6539\u53d8\u7684\u662f\u201c\u8fd0\u884c\u65f6\u8f93\u5165\u7684 bytecode/\u5e38\u91cf\u6c60\u5f62\u6001\u201d\uff0c\u4e0d\u662f\u8fd0\u884c\u65f6\u63a7\u5236\u6d41\u672c\u8eab\u3002</li> </ul> <p>\u5982\u679c\u4f60\u9700\u8981\u628a quickening \u7684\u201c\u5b9e\u9645\u53d8\u6362\u89c4\u5219/\u8868\u9a71\u52a8\u201d\u4e5f\u7eb3\u5165\u8bc1\u636e\u94fe\uff0c\u8bf7\u76f4\u63a5\u987a\u7740\u8fd9\u4e9b\u6e90\u7801\u5165\u53e3\u4e0b\u6f5c\uff08\u672c\u7ae0\u5df2\u7ecf\u628a\u8def\u5f84\u5217\u5168\uff09\uff1a</p> <ul> <li>\u6838\u5fc3\u5b9e\u73b0\uff1a<code>quickener/quickener.h</code> + \u751f\u6210\u7684 <code>quickener_gen.cpp</code>\uff08\u7531 <code>quickener/templates/quickener_gen.cpp.erb</code> \u751f\u6210\uff09</li> <li>opcode \u7ffb\u8bd1\u8868\uff1a<code>translation_table_gen.h</code>\uff08\u7531 <code>quickener/templates/translation_table_gen.h.erb</code> \u751f\u6210\uff0c\u5e76\u901a\u8fc7 <code>#include &lt;translation_table_gen.h&gt;</code> \u6ce8\u5165\uff09</li> <li>\u6784\u5efa\u5165\u53e3\uff1a<code>quickener/CMakeLists.txt</code>\uff08\u6a21\u677f\u751f\u6210\u4e0e\u7f16\u8bd1 target\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/","title":"<code>runtime/arch/aarch64/osr_aarch64.S</code>\uff08\u8bc1\u636e\u94fe\uff1aOSR \u7684\u6700\u7ec8\u843d\u5730\u5165\u53e3\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aarm64 \u4e0a OSR\uff08On-Stack Replacement\uff09\u7684\u201c\u6700\u7ec8\u771f\u76f8\u5c42\u201d\u2014\u2014\u5b9e\u73b0 <code>OsrEntryAfterIFrame/OsrEntryAfterCFrame/OsrEntryTopFrame</code> \u4e09\u4e2a\u5165\u53e3\uff0c\u628a\u89e3\u91ca\u5668\u5e27/\u8fb9\u754c\u5e27\u6539\u9020\u4e3a\u53ef\u8df3\u5165 OSR code \u7684 CFrame\uff0c\u5e76\u5728\u9700\u8981\u65f6\u628a\u8fd4\u56de\u503c\u5199\u56de\u89e3\u91ca\u5668 accumulator\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#0","title":"0) \u4f60\u8bfb\u8fd9\u4e2a\u6587\u4ef6\u8981\u5e26\u7740\u7684\u95ee\u9898","text":"<ul> <li>OSR \u5230\u5e95\u662f\u201c\u600e\u4e48\u4ece\u89e3\u91ca\u5668\u5207\u5230 compiled code\u201d\u7684\uff1f\u6700\u540e\u4e00\u8df3\u5728\u54ea\u91cc\uff1f</li> <li>\u4e3a\u4ec0\u4e48 OSR \u9700\u8981 <code>PrepareOsrEntry</code> \u7684\u5bc4\u5b58\u5668 buffer\uff1f\u54ea\u4e9b\u5bc4\u5b58\u5668\u4f1a\u88ab\u6062\u590d\uff1f</li> <li><code>AfterIFrame/AfterCFrame/TopFrame</code> \u4e09\u4e2a\u5165\u53e3\u5206\u522b\u5bf9\u5e94\u4ec0\u4e48\u6808\u5f62\u6001\uff1f\u5dee\u5f02\u5728\u54ea\uff1f</li> </ul> <p>\u5bf9\u5e94 C++ \u5165\u53e3\u4e0e\u534f\u8bae\uff08\u5148\u770b\u8fd9\u4e2a\u518d\u56de\u6765\u770b\u6c47\u7f16\u4f1a\u66f4\u6e05\u6670\uff09\uff1a</p> <ul> <li><code>runtime/osr.cpp::OsrEntry(...)</code>\uff1a\u51b3\u5b9a\u8d70 <code>AfterIFrame/AfterCFrame/TopFrame</code></li> <li><code>runtime/osr.cpp::PrepareOsrEntry(...)</code>\uff1a\u628a live vregs/acc/\u7279\u6b8a\u5bc4\u5b58\u5668\u73af\u5883\u5199\u5165 CFrame slot \u6216 register buffer\uff0c\u5e76\u8fd4\u56de\u201cOSR code \u7684\u771f\u5b9e entry PC\u201d</li> <li><code>runtime/osr.cpp::SetOsrResult(...)</code>\uff1a\u628a OSR code \u8fd4\u56de\u503c\u6309 shorty \u5199\u56de\u5230\u89e3\u91ca\u5668 frame \u7684 accumulator</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#1-osr_entry","title":"1) \u5173\u952e\u7ed3\u6784\uff1a<code>OSR_ENTRY</code> \u5b8f\u505a\u4e86\u4ec0\u4e48","text":"<p><code>OSR_ENTRY</code> \u662f\u4e09\u4e2a\u5165\u53e3\u90fd\u8981\u590d\u7528\u7684\u6838\u5fc3\u7247\u6bb5\uff0c\u804c\u8d23\u53ef\u4ee5\u62c6\u6210 4 \u6b65\uff1a</p> <p>1) \u5728\u6808\u4e0a\u51c6\u5907\u4e24\u4e2a buffer    - scalar \u5bc4\u5b58\u5668 buffer\uff1a<code>REGS_BUFFER_SIZE</code>    - vector \u5bc4\u5b58\u5668 buffer\uff1a<code>FP_REGS_BUFFER_SIZE</code></p> <p>2) \u8c03\u7528 <code>PrepareOsrEntry</code>\uff08C++\uff09    - \u5165\u53c2\u7ea6\u5b9a\uff08\u6ce8\u91ca\u5199\u5f97\u5f88\u6e05\u695a\uff09\uff1a <code>x0=iframe, x1=bytecode offset, x2=osr code ptr, x3=cframe ptr, x4=scalar buf, x5=vector buf</code>    - \u8fd4\u56de\u503c\uff1a<code>x0</code> \u662f\u201cOSR code \u7684\u771f\u5b9e entrypoint\uff08\u542b native pc \u504f\u79fb\uff09\u201d\uff0c\u6c47\u7f16\u91cc\u4f1a\u6682\u5b58\u5230 <code>x17</code>\uff0c\u540e\u7eed\u7528 <code>blr x17</code> \u8df3\u5165\u3002</p> <p>3) \u6062\u590d <code>THREAD_REG</code>    - \u5b8f\u91cc\u4f1a\u8c03\u7528 <code>GetCurrentManagedThread</code>\uff0c\u5e76\u628a\u7ed3\u679c\u5199\u5165 <code>THREAD_REG</code>\uff08\u5bf9\u540e\u7eed\u6808\u904d\u5386/\u5f02\u5e38/GC \u8bed\u4e49\u5f88\u5173\u952e\uff09\u3002</p> <p>4) \u4ece buffer \u6062\u590d\u5bc4\u5b58\u5668\uff0c\u518d\u8df3\u5165 OSR code    - \u6062\u590d\u4e00\u5927\u6bb5 <code>d0-d31</code>\uff08vector regs\uff09\u548c <code>x0-x27</code>\uff08\u6ce8\u610f\u8df3\u8fc7 <code>x28</code>\uff0c\u56e0\u4e3a\u5b83\u662f <code>THREAD_REG</code>\uff09\u3002    - \u6700\u540e <code>blr x17</code> \u8fdb\u5165 OSR compiled code\u3002</p> <p>\u7ed3\u8bba\uff1aOSR \u4e0d\u662f\u201c\u89e3\u91ca\u5668\u76f4\u63a5\u8df3\u5230 compiled \u5165\u53e3\u201d\u90a3\u4e48\u7b80\u5355\uff0c\u5b83\u5fc5\u987b\u628a\u201c\u89e3\u91ca\u5668\u89c6\u89d2\u7684 live \u503c\u201d\u6309 <code>CodeInfo::FindOsrStackMap</code> \u7684\u63cf\u8ff0\u6620\u5c04\u5230 CFrame \u7684 slot/\u5bc4\u5b58\u5668\u72b6\u6001\u91cc\uff0c<code>PrepareOsrEntry</code> + <code>OSR_ENTRY</code> \u5c31\u662f\u8fd9\u4e2a\u6620\u5c04\u7684\u843d\u5730\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#2","title":"2) \u4e09\u4e2a\u5165\u53e3\u5206\u522b\u89e3\u51b3\u4ec0\u4e48\u6808\u5f62\u6001","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#21-osrentryafteriframe-osr","title":"2.1 <code>OsrEntryAfterIFrame</code>\uff1a\u4ece\u89e3\u91ca\u5668\u5e27\u8fdb\u5165 OSR","text":"<p>\u5178\u578b\u573a\u666f\uff1a\u89e3\u91ca\u5668\u5728\u56de\u8fb9/\u70ed\u5ea6\u89e6\u53d1\u5904\u51b3\u5b9a OSR\uff08\u89c1 <code>instruction_handler_base.h::InstrumentBranches</code> \u4e0e <code>runtime/osr.cpp::OsrEntry</code>\uff09\u3002</p> <p>\u8fd9\u4e2a\u5165\u53e3\u4f1a\u505a\u51e0\u4ef6\u5173\u952e\u4e8b\uff1a</p> <ul> <li>\u5728\u8fdb\u5165 OSR \u524d\u6784\u9020 I2C bridge marker\uff08<code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code>\uff09   \u8fd9\u8ba9 StackWalker/unwind \u80fd\u8bc6\u522b\u201c\u89e3\u91ca\u5668\u2192\u7f16\u8bd1\u201d\u7684\u8fb9\u754c\u3002</li> <li>\u4e3a stack parameters \u9884\u7559\u7a7a\u95f4\uff08<code>stackParams</code> \u7531 <code>runtime/osr.cpp::GetStackParamsSize</code> \u8ba1\u7b97\u5e76\u4f20\u5165\uff09</li> <li>\u6784\u9020 CFrame header + callee-saved \u533a\uff08<code>PUSH_CALLEE_REGS</code>\uff09\uff0c\u5e76\u628a <code>fp</code> \u5207\u6362\u5230\u65b0 cframe</li> <li>\u7136\u540e\u8fdb\u5165 <code>OSR_ENTRY</code>\uff0c\u6700\u7ec8\u8df3\u5165 OSR compiled code</li> <li>\u8fd4\u56de\u503c\u5199\u56de\uff1a\u8c03\u7528 <code>SetOsrResult(frame, result)</code>\uff0c\u628a OSR code \u7684\u8fd4\u56de\u503c\u5199\u56de\u89e3\u91ca\u5668 frame \u7684 acc\uff08\u6309 shorty \u51b3\u5b9a tag/\u7c7b\u578b\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#22-osrentryaftercframecompiled-osr","title":"2.2 <code>OsrEntryAfterCFrame</code>\uff1a\u4ece\u201ccompiled \u540e\u9762\u201d\u8fdb\u5165 OSR\uff08\u66f4\u590d\u6742\uff09","text":"<p>\u5728 <code>runtime/osr.cpp::OsrEntry</code> \u91cc\uff0c\u5f53 <code>StackWalker::GetPreviousFrameKind()==FrameKind::COMPILER</code> \u65f6\u4f1a\u8d70\u8fd9\u91cc\u3002</p> <p>\u8fd9\u4e2a\u5165\u53e3\u7684\u91cd\u70b9\u662f\uff1a</p> <ul> <li>\u201c\u66ff\u6362 C2I frame \u4e3a\u65b0 cframe\u201d\uff1a\u5b83\u4f1a\u4ece\u8fb9\u754c\u5e27\u91cc\u53d6\u56de caller \u7684 <code>fp/lr</code>\uff0c\u5e76\u628a boundary frame \u4e0a\u4fdd\u5b58\u7684 callee-saved \u590d\u5236\u5230\u65b0 cframe \u7684\u5bf9\u5e94\u533a\u57df\uff08\u8fd9\u80fd\u4fdd\u8bc1 unwind/\u6808\u56de\u6eaf\u8bed\u4e49\u6b63\u786e\uff09\u3002</li> <li>\u6784\u9020\u5b8c\u65b0 cframe \u540e\u8fdb\u5165 <code>OSR_ENTRY</code></li> <li>\u5165\u53e3\u5c3e\u90e8\u6709\u4e00\u6bb5\u4e13\u95e8\u7684 <code>THREAD_REG</code> \u6062\u590d\u4e0e <code>lr/fp</code> \u4fdd\u62a4\u903b\u8f91\uff08\u6ce8\u91ca\u89e3\u91ca\u4e86 <code>GetCurrentManagedThread</code> \u53ef\u80fd\u4fee\u6539\u6808\u5185\u5b58\uff0c\u9700\u8981\u5148\u4fdd\u62a4 cframe \u91cc\u5b58\u7684 <code>lr/fp</code>\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#23-osrentrytopframeframekindnone","title":"2.3 <code>OsrEntryTopFrame</code>\uff1a\u524d\u4e00\u5e27\u4e0d\u5b58\u5728\uff08FrameKind::NONE\uff09","text":"<p>\u5bf9\u5e94 <code>runtime/osr.cpp::OsrEntry</code> \u7684 <code>FrameKind::NONE</code> \u5206\u652f\uff1a\u6808\u9876\u5c31\u662f\u5f53\u524d\u89e3\u91ca\u5668\u5e27\uff0c\u6ca1\u6709\u201c\u524d\u4e00\u5e27 kind\u201d\u53ef\u53c2\u8003\u3002</p> <p>\u6574\u4f53\u7ed3\u6784\u4e0e <code>AfterIFrame</code> \u7c7b\u4f3c\uff1a\u6784\u9020\u5fc5\u8981\u8fb9\u754c/\u6808\u7a7a\u95f4 \u2192 <code>OSR_ENTRY</code> \u2192 <code>SetOsrResult</code> \u5199\u56de\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_aarch64_osr_aarch64.S/#3","title":"3) \u6392\u969c\u8981\u70b9\uff08\u975e\u5e38\u5b9e\u7528\uff09","text":"<ul> <li>OSR \u53ea\u5728\u201c\u5177\u5907\u5bf9\u5e94 arch \u6c47\u7f16\u5165\u53e3\u201d\u7684\u5e73\u53f0\u4e0a\u624d\u53ef\u80fd\u95ed\u73af\uff1a\u5982\u679c\u4f60\u5728\u975e arm64 \u5e73\u53f0\u505a OSR \u5b9e\u9a8c\uff0c\u53ef\u80fd\u76f4\u63a5\u843d\u5165 stub\uff08\u89c1 <code>runtime/arch/asm_support.cpp</code> \u7684 <code>UNREACHABLE()</code>\uff09\u3002</li> <li>thread/currentFrame \u4e0e frame kind \u4e00\u81f4\u6027\uff1a<code>PrepareOsrEntry</code> \u4f1a <code>thread-&gt;SetCurrentFrame(cframePtr)</code> \u5e76\u6807\u8bb0 compiled\uff0c\u8fd9\u4e0e StackWalker/\u5f02\u5e38/GC \u8bed\u4e49\u5f3a\u7ed1\u5b9a\u3002</li> <li>\u8fd4\u56de\u503c\u5199\u56de\u4e00\u5b9a\u8981\u5bf9\u7167 <code>SetOsrResult</code>\uff1a\u5982\u679c\u4f60\u770b\u5230 OSR \u540e acc/tag \u5f02\u5e38\uff0c\u7b2c\u4e00\u843d\u70b9\u5e94\u662f <code>runtime/osr.cpp::SetOsrResult</code> \u4e0e\u672c\u6587\u4ef6\u91cc\u8c03\u7528\u5b83\u7684\u4f4d\u7f6e\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_amd64_osr_amd64.S/","title":"<code>runtime/arch/amd64/osr_amd64.S</code>\uff08\u73b0\u72b6\u8bf4\u660e\uff1a\u6682\u65e0\u5b9e\u73b0/\u4ec5\u6587\u4ef6\u5934\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0b\u7684 OSR \u6c47\u7f16\u5165\u53e3\u6587\u4ef6\uff0c\u4f46\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u4ec5\u5305\u542b\u6587\u4ef6\u5934\u90e8\u7248\u6743\u58f0\u660e\uff0c\u6ca1\u6709\u4efb\u4f55\u53ef\u6267\u884c\u903b\u8f91\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_amd64_osr_amd64.S/#_1","title":"\u7ed3\u8bba\uff08\u907f\u514d\u8bef\u6392\u969c\uff09","text":"<ul> <li>\u8fd9\u610f\u5473\u7740\u4f60\u4e0d\u80fd\u6307\u671b\u5728 amd64 \u4e0a\u901a\u8fc7\u8be5\u6587\u4ef6\u8fdb\u5165 OSR compiled code\u3002</li> <li>\u5bf9\u6bd4\uff1aarm64 \u6709\u5b8c\u6574 OSR \u5165\u53e3\u5b9e\u73b0\uff08<code>runtime/arch/aarch64/osr_aarch64.S</code>\uff09\u3002</li> <li>\u540c\u65f6\uff0c<code>runtime/arch/asm_support.cpp</code> \u5728\u975e arm64 \u5e73\u53f0\u63d0\u4f9b\u7684 <code>OsrEntryAfter*</code> \u662f <code>UNREACHABLE()</code> stub\u3002</li> </ul> <p>\u56e0\u6b64\u5728 amd64 \u73af\u5883\u4e2d\uff0c\u201cOSR \u4e0d\u89e6\u53d1/\u8dd1\u4e0d\u51fa\u6765\u201d\u9996\u5148\u8981\u6392\u9664\u5e73\u53f0\u5165\u53e3\u7f3a\u5931\u8fd9\u4e00\u4e8b\u5b9e\uff0c\u518d\u53bb\u770b hotness/\u9009\u9879/\u7f16\u8bd1\u5668\u72b6\u6001\u4f4d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_arm_osr_arm.S/","title":"<code>runtime/arch/arm/osr_arm.S</code>\uff08\u73b0\u72b6\u8bf4\u660e\uff1a\u6682\u65e0\u5b9e\u73b0/\u4ec5\u6587\u4ef6\u5934\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aarm32 \u4e0b\u7684 OSR \u6c47\u7f16\u5165\u53e3\u6587\u4ef6\uff0c\u4f46\u5f53\u524d\u4ed3\u5e93\u7248\u672c\u4ec5\u5305\u542b\u6587\u4ef6\u5934\u90e8\u7248\u6743\u58f0\u660e\uff0c\u6ca1\u6709\u4efb\u4f55\u53ef\u6267\u884c\u903b\u8f91\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_arm_osr_arm.S/#_1","title":"\u7ed3\u8bba\uff08\u907f\u514d\u8bef\u6392\u969c\uff09","text":"<ul> <li>\u8fd9\u610f\u5473\u7740\u5728 arm32 \u5e73\u53f0\u4e0a\uff0cOSR \u7684\u201c\u6700\u7ec8\u8fdb\u5165\u70b9\u201d\u5e76\u4e0d\u5728\u6b64\u6587\u4ef6\u4e2d\u5b9e\u73b0\u3002</li> <li>\u540c\u65f6\uff0c<code>runtime/arch/asm_support.cpp</code> \u5728\u975e arm64 \u5e73\u53f0\u63d0\u4f9b\u7684 <code>OsrEntryAfter*</code> \u662f <code>UNREACHABLE()</code> stub\u3002</li> </ul> <p>\u5b9e\u6218\u5efa\u8bae\uff1a\u5728 arm32 \u73af\u5883\u4e2d\u6392\u67e5 OSR \u76f8\u5173\u95ee\u9898\u65f6\uff0c\u5e94\u9996\u5148\u5224\u65ad\u201c\u662f\u5426\u5b58\u5728\u53ef\u7528\u7684 OSR \u5165\u53e3\u5b9e\u73b0\u201d\uff0c\u5426\u5219\u8c03\u6574 hotness/\u9009\u9879\u4e0d\u4f1a\u4ea7\u751f\u9884\u671f\u6548\u679c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_asm_support.cpp/","title":"<code>runtime/arch/asm_support.cpp</code>\uff08\u6c47\u7f16/\u67b6\u6784 glue\uff1a\u5e38\u91cf\u6821\u9a8c + OSR stub\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u4e3a\u6c47\u7f16\u63d0\u4f9b\u201c\u53ef\u88ab\u7f16\u8bd1\u5668\u6821\u9a8c\u7684\u5e38\u91cf/offset\u201d\uff08\u901a\u8fc7 <code>static_assert</code>\uff09\uff0c\u5e76\u63d0\u4f9b\u5c11\u91cf <code>extern \"C\"</code> glue\uff08\u5982 <code>GetCurrentManagedThread</code>\uff09\u3002\u5bf9 OSR \u6765\u8bf4\uff0c\u5b83\u8fd8\u5b9a\u4e49\u4e86\u975e arm64 \u5e73\u53f0\u7684 <code>OsrEntryAfter*</code> stub \u884c\u4e3a\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_asm_support.cpp/#1","title":"1) \u8fd9\u4e2a\u6587\u4ef6\u4e3a\u4ec0\u4e48\u91cd\u8981","text":"<p>\u5f88\u591a\u6267\u884c\u5f15\u64ce\u7684\u5173\u952e\u8def\u5f84\u6700\u7ec8\u4f1a\u843d\u5230\u6c47\u7f16\uff08bridge/deopt/osr\uff09\u3002\u4e00\u65e6 C++ \u7684\u7ed3\u6784\u4f53 layout / \u5e38\u91cf\u503c \u4e0e\u6c47\u7f16\u5047\u8bbe\u4e0d\u4e00\u81f4\uff0c\u540e\u679c\u901a\u5e38\u662f\uff1a</p> <ul> <li>\u8fb9\u754c\u5e27\u8bc6\u522b\u5931\u8d25\uff08StackWalker \u7f3a\u5e27/\u9519\u5e27\uff09</li> <li>TLS/thread \u5bc4\u5b58\u5668\u6062\u590d\u9519\u4f4d</li> <li>deopt/OSR \u5199\u56de\u9519\u8bef\uff08acc/vreg/pc \u6062\u590d\u9519\uff09</li> </ul> <p>\u8fd9\u4e2a\u6587\u4ef6\u7528 <code>static_assert</code> \u628a\u201cC++ \u7684\u771f\u5b9e layout\u201d\u9489\u6b7b\uff0c\u786e\u4fdd\u6c47\u7f16\u91cc\u4f7f\u7528\u7684 offset/\u5e38\u91cf\u662f\u53ef\u5ba1\u8ba1\u4e14\u53ef\u9a8c\u8bc1\u7684\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_asm_support.cpp/#2-frame-offset","title":"2) \u5173\u952e\u70b9\uff1aFrame offset \u7684\u786c\u6821\u9a8c","text":"<p>\u6587\u4ef6\u91cc\u5bf9 <code>Frame</code> \u7684\u5b57\u6bb5 offset \u505a\u4e86\u4eba\u5de5\u6821\u9a8c\uff08<code>FRAME_METHOD_OFFSET/FRAME_PREV_FRAME_OFFSET/FRAME_SLOT_OFFSET</code>\uff09\uff0c\u7406\u7531\u4e5f\u5199\u5f97\u5f88\u76f4\u767d\uff1aFrame \u672c\u8eab\u4e0d\u662f\u5929\u7136 aligned storage\uff0c\u6240\u4ee5\u8981\u663e\u5f0f\u68c0\u67e5\u3002</p> <p>\u8fd9\u7c7b assert \u4e00\u65e6\u89e6\u53d1\uff0c\u901a\u5e38\u610f\u5473\u7740\u4f60\u6539\u4e86 <code>Frame</code> \u7684\u7ed3\u6784\u4f53\u5e03\u5c40\uff0c\u5374\u6ca1\u540c\u6b65\u66f4\u65b0\u6c47\u7f16\u4fa7\u7684 offset\uff08\u6216\u751f\u6210\u7684 asm_defines\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_asm_support.cpp/#3-gluegetcurrentmanagedthread","title":"3) \u5173\u952e glue\uff1a<code>GetCurrentManagedThread</code>","text":"<p><code>extern \"C\" ManagedThread *GetCurrentManagedThread()</code> \u53ea\u662f\u4e00\u4e2a\u8584\u5c01\u88c5\uff1a\u8fd4\u56de <code>ManagedThread::GetCurrent()</code>\u3002</p> <p>\u5b83\u7684\u610f\u4e49\u5728\u4e8e\uff1a</p> <ul> <li>\u6c47\u7f16\u4fa7\uff08bridge/osr/deopt\uff09\u53ef\u4ee5\u5728\u4e0d\u5f15\u5165\u590d\u6742 C++ ABI \u7684\u524d\u63d0\u4e0b\u62ff\u5230 <code>ManagedThread*</code></li> <li>aarch64 OSR \u5165\u53e3\u4f1a\u7528\u5b83\u6062\u590d <code>THREAD_REG</code>\uff08\u89c1 <code>runtime/arch/aarch64/osr_aarch64.S</code>\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_asm_support.cpp/#4-arm64-osr-unreachable","title":"4) \u975e arm64 \u7684 OSR \u5165\u53e3\uff1a\u660e\u786e\u662f <code>UNREACHABLE()</code>","text":"<p>\u6587\u4ef6\u672b\u5c3e\u6709\u975e\u5e38\u5173\u952e\u7684\u4e00\u6bb5\uff1a</p> <ul> <li>\u5728 <code>#if !defined(PANDA_TARGET_ARM64)</code> \u4e0b\uff0c\u63d0\u4f9b</li> <li><code>OsrEntryAfterCFrame(...)</code></li> <li><code>OsrEntryAfterIFrame(...)</code></li> <li><code>OsrEntryTopFrame(...)</code></li> <li>\u4e09\u4e2a\u51fd\u6570\u4f53\u90fd\u662f <code>UNREACHABLE()</code>\uff08\u4e0d\u662f\u8fd4\u56de false\uff0c\u4e5f\u4e0d\u662f\u964d\u7ea7\uff09</li> </ul> <p>\u7ed3\u8bba\uff1a\u5f53\u4f60\u5728\u975e arm64 \u5e73\u53f0\u6392\u67e5\u201cOSR \u4e0d\u89e6\u53d1\u201d\u65f6\uff0c\u5fc5\u987b\u5148\u786e\u8ba4\u4f60\u8d70\u5230\u7684\u662f\u4e0d\u662f\u8fd9\u7ec4 stub\u3002\u5426\u5219\u4f60\u53ef\u80fd\u4f1a\u628a\u65f6\u95f4\u6d6a\u8d39\u5728 hotness/\u9009\u9879/\u7f16\u8bd1\u5668\u4e0a\uff0c\u4f46\u6839\u56e0\u5176\u5b9e\u662f\u201c\u5e73\u53f0\u6839\u672c\u6ca1\u6709 OSR \u5165\u53e3\u5b9e\u73b0\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_x86_osr_x86.S/","title":"<code>runtime/arch/x86/osr_x86.S</code>\uff08\u73b0\u72b6\u8bf4\u660e\uff1a\u5360\u4f4d\u5b9e\u73b0\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1ax86 \u4e0b\u7684 OSR \u6c47\u7f16\u5165\u53e3\u6587\u4ef6\uff0c\u4f46\u5f53\u524d\u5b9e\u73b0\u4ecd\u662f stub/\u5360\u4f4d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_x86_osr_x86.S/#1","title":"1) \u4f60\u9700\u8981\u77e5\u9053\u7684\u7ed3\u8bba\uff08\u907f\u514d\u8bef\u6392\u969c\uff09","text":"<p>\u672c\u6587\u4ef6\u5f53\u524d\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>OsrEntry</code> \u7b26\u53f7\uff0c\u5e76\u4e14\u903b\u8f91\u662f\u201c\u76f4\u63a5\u8fd4\u56de 0/false\u201d\uff1a</p> <ul> <li>\u6ce8\u91ca\u8bf4\u660e\u53c2\u6570\uff1a<code>x0=Frame*</code>\u3001<code>x1=bytecode offset</code>\u3001<code>x2=osr code ptr</code></li> <li>\u5b9e\u73b0\uff1a\u6e05\u96f6\u8fd4\u56de\u5bc4\u5b58\u5668\u540e <code>ret</code></li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff1a\u4ec5\u51ed\u8fd9\u4e2a\u6587\u4ef6\u65e0\u6cd5\u5b8c\u6210 OSR \u7684\u201c\u8fdb\u5165 compiled code \u5e76\u5199\u56de\u7ed3\u679c\u201d\u7684\u95ed\u73af\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_arch_x86_osr_x86.S/#2","title":"2) \u4e0e\u4e3b\u7ebf\u4ee3\u7801\u7684\u5173\u7cfb\uff08\u8bc1\u636e\u94fe\uff09","text":"<ul> <li>OSR \u7684 C++ \u5165\u53e3\u5728 <code>runtime/osr.cpp::OsrEntry</code></li> <li>\u771f\u6b63\u7528\u4e8e\u8fdb\u5165 OSR code \u7684\u67b6\u6784\u5165\u53e3\u5728 <code>OsrEntryAfterIFrame/AfterCFrame/TopFrame</code>\uff08\u58f0\u660e\u4e8e <code>runtime/osr.h</code>\uff09</li> <li>\u5bf9\u975e arm64 \u5e73\u53f0\uff0c\u8fd9\u4e09\u4e2a\u5165\u53e3\u5728 <code>runtime/arch/asm_support.cpp</code> \u4e2d\u88ab\u5b9a\u4e49\u4e3a <code>UNREACHABLE()</code> stub</li> </ul> <p>\u56e0\u6b64\uff0c\u5728 x86 \u5e73\u53f0\u4e0a\u505a OSR \u5b9e\u9a8c/\u6392\u969c\u524d\uff0c\u5efa\u8bae\u5148\u786e\u8ba4\u4f60\u671f\u5f85\u7684\u5165\u53e3\u7b26\u53f7\u662f\u5426\u5b58\u5728\u3001\u662f\u5426\u4e3a stub\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cC2I \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 C2I\uff08Compiled\u2192Interpreter\uff09 \u6865\u63a5\uff1a\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame\u3001\u4fdd\u5b58 callee-saved \u5e76\u628a boundary \u5199\u5165 TLS\uff08\u4fdd\u969c safepoint/StackWalker \u53ef\u89c1\uff09\uff0c\u968f\u540e\u8d70 \u201c\u7f16\u8bd1\u6210\u529f\u76f4\u8df3 / \u672a\u7f16\u8bd1\u521b\u5efa IFrame + \u8fdb\u5165 InterpreterEntryPoint\u201d \u4e24\u5206\u652f\uff0c\u6700\u540e\u4ece <code>acc/acc_mirror</code> \u8fd8\u539f\u8fd4\u56de\u5bc4\u5b58\u5668\u5e76\u8fd4\u56de\u7ed9 compiled caller\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#1-compiled_code_to_interpreter_bridge-boundary-frame","title":"1) \u5165\u53e3\uff1a\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame","text":"<p>\u6587\u4ef6\u5185\u76f4\u63a5\u7ed9\u51fa\u4e86 bridge frame \u5f62\u6001\uff1a</p> <ul> <li><code>lr</code></li> <li><code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code></li> <li><code>fp  &lt;- fp</code></li> <li><code>==  &lt;- sp</code></li> </ul> <p>\u5bf9\u5e94\u5b9e\u73b0\uff08\u53ef\u5bf9\u7167\u6e90\u6587\u4ef6\u9876\u90e8 <code>CompiledCodeToInterpreterBridge:</code>\uff09\uff1a</p> <ul> <li><code>sub sp, sp, #32</code> + <code>str lr, [sp, #24]</code></li> <li><code>mov lr, #COMPILED_CODE_TO_INTERPRETER_BRIDGE</code></li> <li><code>stp fp, lr, [sp, #8]</code>\uff0c\u5e76 <code>add fp, sp, #8</code> \u5efa\u7acb frame pointer</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#2-callee-saved-tls","title":"2) \u4fdd\u5b58 callee-saved + \u5199 TLS\uff08\u5173\u952e\u4e0d\u53d8\u91cf\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#21-callee-saved","title":"2.1 \u4fdd\u5b58 callee-saved \u7684\u539f\u56e0","text":"<p>\u6ce8\u91ca\u4e0e amd64 \u7248\u672c\u4e00\u81f4\uff1aStackWalker unwind \u4f1a\u8bfb\u53d6\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4fdd\u5b58\u533a\u3002\u672c\u6587\u4ef6\u7528 <code>PUSH_CALLEE_REGS sp</code> \u4fdd\u5b58\u4e86 x19-x28 \u4e0e d8-d15\uff0c\u5e76\u914d\u5957 CFI\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#22-decrementhotnesscounter-tls","title":"2.2 \u8c03\u7528 <code>DecrementHotnessCounter</code> \u524d\u5199 TLS","text":"<p>\u5173\u952e\u8bc1\u636e\u70b9\uff1a</p> <ul> <li><code>str fp, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code></li> </ul> <p>\u7406\u7531\uff08\u6587\u4ef6\u6ce8\u91ca\uff09\uff1a\u7f16\u8bd1\u8fc7\u7a0b\u53ef\u80fd\u8fdb\u5165 safepoint\uff1b\u5982\u679c\u8fd9\u65f6 GC/StackWalker \u9700\u8981\u904d\u5386\u6808\uff0c\u5fc5\u987b\u80fd\u770b\u5230 caller \u7684 callee-saved\uff08\u5b83\u4eec\u5df2\u88ab C2I \u4fdd\u5b58\u5230\u6808\u91cc\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#3-br-entrypoint","title":"3) \u70ed\u5ea6\u8ba1\u6570/\u89e6\u53d1\u7f16\u8bd1\uff1a\u6210\u529f\u5219\u76f4\u63a5 <code>br entrypoint</code>","text":"<p>\u5f53 <code>DecrementHotnessCounter</code> \u8fd4\u56de\u975e 0\uff1a</p> <ul> <li>\u6062\u590d TLS\uff1a<code>ldr lr, [fp] ; str lr, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code></li> <li>\u6062\u590d\u5bc4\u5b58\u5668\u4e0e\u6808\uff1a<code>POP_ARGS_VREGS/POP_CALLER_REGS</code> + \u6062\u590d <code>fp/lr</code> + <code>add sp, sp, #32</code></li> <li>\u76f4\u63a5\u8df3\u8f6c\u5230 compiled\uff1a<code>ldr x16, [x0, #METHOD_COMPILED_ENTRY_POINT_OFFSET] ; br x16</code></li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u201c\u4e3a\u4ec0\u4e48 C2I \u770b\u8d77\u6765\u50cf\u4e00\u4e2a\u51fd\u6570\uff0c\u5374\u5e38\u5e38\u4ee5 <code>br entrypoint</code> \u7684\u65b9\u5f0f\u79bb\u5f00\u201d\uff1a\u6865\u5185\u628a\u63a7\u5236\u6743\u76f4\u63a5\u4ea4\u7ed9\u6700\u65b0\u7684 compiled entrypoint\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#4-iframe-shorty","title":"4) \u672a\u7f16\u8bd1\uff1a\u521b\u5efa <code>IFrame</code> \u5e76\u6309 shorty \u642c\u8fd0\u53c2\u6570","text":"<p>\u5728 <code>.Lnot_compiled</code> \u5206\u652f\uff1a</p> <ul> <li>\u5148\u628a\u53c2\u6570\u5bc4\u5b58\u5668\uff08x0-x7 / d0-d7\uff09\u4fdd\u5b58\u5230\u6808\uff0c\u4f5c\u4e3a\u540e\u7eed\u201cABI \u53c2\u6570\u533a\u201d\u7684\u7a33\u5b9a\u6765\u6e90\u3002</li> <li>\u8c03 <code>CreateFrameForMethod(method, prev)</code> \u521b\u5efa\u89e3\u91ca\u5668 <code>Frame*</code>\uff1a</li> <li><code>prev</code> \u53d6\u5f53\u524d <code>fp</code>\uff08\u5373 C2I boundary frame\uff09</li> <li>\u521d\u59cb\u5316 shorty\uff08<code>METHOD_SHORTY_OFFSET</code> + <code>INIT_SHORTY_REG</code>\uff09\uff0c\u5e76\u6309 shorty \u9010\u4e2a\u53c2\u6570\u628a\u503c\u5199\u5165 <code>frame-&gt;vregs_</code>\uff1a</li> <li>\u53c2\u6570\u6765\u6e90\uff1aGPR/FPR/stack \u4e09\u8def\uff08\u7531\u8ba1\u6570\u5668 w6/w7 \u51b3\u5b9a\uff09</li> <li>\u5f15\u7528\u53c2\u6570\u4f1a\u5199\u5165 tag\uff08\u901a\u8fc7\u5bf9\u6bd4 <code>SHORTY_REFERENCE</code> \u4ea7\u751f tag=1\uff09</li> <li>instance \u65b9\u6cd5\u4f1a \u201chack shorty\u201d\uff1a\u628a return type nibble \u66ff\u6362\u4e3a <code>REF</code> \u6765\u5360\u4f4d <code>this</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#5-compiled-caller","title":"5) \u8fdb\u5165\u89e3\u91ca\u5668\u4e0e\u8fd4\u56de\u503c\u8fd8\u539f\uff08\u8fd4\u56de\u7ed9 compiled caller\uff09","text":"<ul> <li>\u8fdb\u5165\u89e3\u91ca\u5668\uff1a<code>InterpreterEntryPoint(method, iframe)</code></li> <li>\u8fd4\u56de\u503c\u8fd8\u539f\uff1a\u4ece <code>iframe-&gt;acc_</code>\uff08\u4ee5\u53ca mirror/tag\uff09\u8bfb\u53d6\uff0c\u5e76\u6309 <code>shorty[0] &amp; 0xF</code>\uff1a</li> <li><code>void</code>\uff1a<code>FreeFrame</code> \u540e\u76f4\u63a5\u8fd4\u56de</li> <li><code>reference</code>\uff1a\u8fd4\u56de <code>(x0=value, x1=tag)</code>\uff0832-bit managed ptr \u4e0b\u6e05\u9ad8 32 \u4f4d\uff09</li> <li><code>int/long/tagged(any)</code>\uff1a\u8fd4\u56de <code>(x0=value, x1=tag)</code></li> <li><code>float/double</code>\uff1a<code>fmov d0, x19</code>\uff08\u628a acc \u7684\u4f4d\u6a21\u5f0f\u642c\u5230\u6d6e\u70b9\u8fd4\u56de\u5bc4\u5b58\u5668\uff09</li> <li>\u6700\u540e\u6062\u590d callee-saved \u4e0e <code>fp/lr</code>\uff0c<code>ret</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u6982\u5ff5/\u903b\u8f91\u6d41\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> <li>FrameKind/\u8fb9\u754c\u8bed\u4e49\uff1aBridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> <li>amd64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_amd64.S</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_dyn_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cC2I(Dyn) \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 C2I\uff08Dynamic calling convention\uff09\uff1a\u4e3a\u52a8\u6001\u8bed\u8a00/TaggedValue \u8bed\u4e49\u63d0\u4f9b compiled\u2192\u89e3\u91ca\u5668\u56de\u9000\u8def\u5f84\u3002\u6574\u4f53\u5f62\u6001\u4e0e\u9759\u6001 <code>C2I</code> \u76f8\u540c\uff1a\u5148\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame \u5e76\u5199 TLS\uff0c\u968f\u540e\u505a hotness/\u7f16\u8bd1\u63a2\u6d4b\uff1b\u82e5\u4ecd\u672a\u7f16\u8bd1\u5219\u521b\u5efa <code>IFrame</code>\uff08\u6309\u201c\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\u201d\uff09\u5e76\u8fdb\u5165 <code>InterpreterEntryPoint</code>\uff0c\u6700\u540e\u4ece <code>acc/acc_mirror</code> \u8fd8\u539f\u8fd4\u56de\u5bc4\u5b58\u5668\u5e76\u8fd4\u56de\u7ed9 compiled caller\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/#1-tls-c2i","title":"1) \u5165\u53e3\u4e0e TLS\uff1a\u4e0e\u9759\u6001 C2I \u5b8c\u5168\u4e00\u81f4\u7684\u5173\u952e\u4e0d\u53d8\u91cf","text":"<p>\u4f60\u80fd\u5728\u6587\u4ef6\u5f00\u5934\u76f4\u63a5\u770b\u5230\u4e0e\u9759\u6001\u7248\u76f8\u540c\u7684\u4e09\u4ef6\u4e8b\uff1a</p> <ul> <li>\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame\uff08<code>lr + marker + fp</code>\uff09</li> <li><code>PUSH_CALLEE_REGS</code> \u4fdd\u5b58 callee-saved\uff08\u4f9b StackWalker/GC/unwind\uff09</li> <li><code>str fp, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code> \u5728\u8c03\u7528 <code>DecrementHotnessCounterDyn</code> \u524d\u5199 TLS\uff08\u4fdd\u969c safepoint \u53ef\u904d\u5386\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/#2-br-entrypoint","title":"2) \u7f16\u8bd1\u6210\u529f\uff1a\u76f4\u63a5 <code>br entrypoint</code>","text":"<p>\u5f53 <code>DecrementHotnessCounterDyn</code> \u8fd4\u56de\u975e 0\uff1a</p> <ul> <li>\u6062\u590d TLS\uff1a<code>ldr lr, [fp] ; str lr, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code></li> <li>\u6062\u590d <code>fp/lr/sp</code> \u540e <code>br METHOD_COMPILED_ENTRY_POINT</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/#3-iframe-rest-args","title":"3) \u672a\u7f16\u8bd1\uff1a\u6309\u201c\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\u201d\u521b\u5efa IFrame \u5e76\u521d\u59cb\u5316 rest args","text":"<p>\u4e0e\u9759\u6001 shorty \u4e0d\u540c\uff0cdyn \u7248\u4f1a\uff1a</p> <ul> <li>\u8c03 <code>CreateFrameForMethodWithActualArgsDyn(actual_num_args, method, prev)</code></li> <li>\u8ba1\u7b97 <code>num_iframe_args = max(actual_num_args, method-&gt;num_args_)</code></li> <li>\u5c06\u5b9e\u53c2\u4ece caller \u6808\u62f7\u8d1d\u5230 <code>frame-&gt;vregs_</code> \u672b\u5c3e\u5bf9\u5e94\u533a\u57df</li> <li>\u5bf9\u4e0d\u8db3\u90e8\u5206\u7528 <code>TAGGED_VALUE_UNDEFINED</code> \u521d\u59cb\u5316\uff08\u201crest args\u201d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/#4","title":"4) \u8fdb\u5165\u89e3\u91ca\u5668\u4e0e\u8fd4\u56de\u503c\u8fd8\u539f","text":"<ul> <li><code>InterpreterEntryPoint(method, iframe)</code></li> <li>\u4ece <code>FRAME_ACC_OFFSET</code> \u4e0e <code>FRAME_ACC_MIRROR_OFFSET</code> \u53d6 <code>(value, tag)</code>\uff0c<code>FreeFrame</code> \u540e\uff1a</li> <li><code>x0 = value</code></li> <li><code>x1 = tag</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S/#5","title":"5) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u9759\u6001 C2I\uff08shorty \u9a71\u52a8\uff09\u5bf9\u7167\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code></li> <li>dyn I2C \u5bf9\u7167\uff1a<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_dyn_aarch64.S</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09 + Bridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/deoptimization_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cdeopt \u4e0e boundary frame \u53d8\u5f62\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 deoptimization \u6c47\u7f16\u843d\u5730\uff1a\u628a\u201c\u4ece compiled \u56de\u5230\u89e3\u91ca\u5668\u201d\u7684\u5173\u952e\u8def\u5f84\u505a\u6210\u53ef\u6267\u884c\u7684\u6808\u53d8\u5f62\u4e0e\u5bc4\u5b58\u5668\u6062\u590d\u903b\u8f91\u3002\u6838\u5fc3\u5165\u53e3\u5305\u62ec\uff1a - <code>DeoptimizeAfterCFrame</code>\uff1a\u628a\u4e00\u4e2a CFrame \u53d8\u5f62\uff08morph\uff09\u4e3a C2I boundary frame\uff0c\u518d\u8c03\u7528 <code>InvokeInterpreter</code> - <code>DeoptimizeAfterIFrame</code>\uff1a\u5728\u5df2\u6709 IFrame \u8bed\u4e49\u7684\u573a\u666f\u4e0b\u6062\u590d\u8fd4\u56de\u5730\u5740/\u5bc4\u5b58\u5668\u5e76\u8fdb\u5165\u89e3\u91ca\u5668 - \u5176\u5b83\u8f85\u52a9\uff1a<code>DropCompiledFrameAndReturn</code> \u7b49</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#1-deoptimizeaftercframecframe-c2i-boundary-frame","title":"1) <code>DeoptimizeAfterCFrame</code>\uff1aCFrame \u2192 C2I boundary frame\uff08\u6700\u5173\u952e\u8bc1\u636e\uff09","text":"<p>\u6587\u4ef6\u6ce8\u91ca\u76f4\u63a5\u7ed9\u51fa\u201c\u53d8\u5f62\u524d\u540e\u201d\u7684\u6808\u8bed\u4e49\uff1a</p> <ul> <li>FROM\uff1a<code>lr ; fp &lt;--- ; method</code></li> <li>TO\uff1a<code>lr ; COMPILED_CODE_TO_INTERPRETER_BRIDGE ; fp &lt;---</code></li> </ul> <p>\u5b9e\u73b0\u8981\u70b9\uff1a</p> <ul> <li>\u57fa\u4e8e <code>cframe origin</code>\uff08x3\uff09\u8ba1\u7b97\u65b0\u7684 <code>sp</code> \u4f4d\u7f6e\uff08\u4e3a boundary + callee-saved \u533a\u9884\u7559\u7a7a\u95f4\uff09</li> <li>\u628a <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> \u5199\u5165\uff08<code>stp x7, x8, [x3, #-8]!</code>\uff09</li> <li>\u628a last IFrame \u7684 <code>prev_frame</code> \u6307\u5411\u8fd9\u4e2a\u65b0 boundary\uff1a<code>str x3, [x4, #FRAME_PREV_FRAME_OFFSET]</code></li> </ul> <p>\u8fd9\u4e00\u6761\u5c31\u662f\u201c\u903b\u8f91 IFrame \u94fe\u5982\u4f55\u4e0e\u7269\u7406 boundary frame \u4e32\u8d77\u6765\u201d\u7684\u786c\u8bc1\u636e\uff1a\u5b83\u89e3\u91ca\u4e86 StackWalker \u4e3a\u4ec0\u4e48\u80fd\u8de8\u8fc7 deopt \u8fb9\u754c\u7ee7\u7eed\u5de5\u4f5c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#2-boundary-slot-stackwalker-callee-saved","title":"2) boundary slot\uff1a\u4ece StackWalker \u7f13\u51b2\u533a\u62f7\u8d1d callee-saved","text":"<p><code>DeoptimizeAfterCFrame</code> \u4f20\u5165 <code>x5</code>\uff08StackWalker \u63d0\u4f9b\u7684 callee-saved regs buffer\uff09\u5e76\u628a\u5b83\u62f7\u8d1d\u8fdb boundary frame \u7684\u56fa\u5b9a slots\uff1a</p> <ul> <li>\u6587\u4ef6\u7528 <code>BOUNDARY_FRAME_SLOT</code> \u5e38\u91cf\u63cf\u8ff0\u5e03\u5c40\u4f4d\u7f6e</li> <li>\u4f9d\u6b21 <code>ldp/stp</code> \u628a x19-x28\u3001d8-d15 \u7b49\u5199\u5165 boundary frame</li> <li>\u540c\u65f6\u8bbe\u7f6e CFI\uff0c\u786e\u4fdd unwind \u5bf9\u8fd9\u4e9b\u5bc4\u5b58\u5668\u7684\u504f\u79fb\u662f\u53ef\u8ba1\u7b97\u7684</li> </ul> <p>\u8fd9\u5c31\u662f \u201cdeopt \u540e\u4e3a\u4ec0\u4e48\u8fd8\u80fd\u6b63\u786e\u6062\u590d caller \u7684\u5bc4\u5b58\u5668\u5feb\u7167/\u6808\u56de\u6eaf\u201d \u7684\u7269\u7406\u4f9d\u636e\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#3-invokeinterpreter","title":"3) \u8c03\u7528 <code>InvokeInterpreter</code>\uff1a\u7b7e\u540d\u5bf9\u9f50\u662f\u4e3a\u4e86\u5c11\u642c\u8fd0\u53c2\u6570","text":"<p>\u6587\u4ef6\u6ce8\u91ca\u70b9\u660e\uff1a</p> <ul> <li><code>DeoptimizeAfterCFrame</code> \u7684\u53c2\u6570\u7b7e\u540d\u4e0e <code>InvokeInterpreter</code> \u7c7b\u4f3c\uff0c\u6240\u4ee5\u201c\u53c2\u6570\u5df2\u7ecf\u5728\u5bc4\u5b58\u5668\u91cc\u201d\uff0c\u53ea\u9700\u8981\u628a <code>last restored IFrame</code> \u4f20\u5230\u6307\u5b9a\u5bc4\u5b58\u5668\u4f4d\u7f6e\u5373\u53ef\u3002</li> </ul> <p>\u5b9e\u73b0\u4e0a\uff1a</p> <ul> <li>\u4fdd\u5b58\u5c11\u91cf\u4e34\u65f6\u5bc4\u5b58\u5668\uff08\u5982 <code>stp x0, x1</code> / <code>stp x2, x3</code>\uff09</li> <li><code>mov x3, x4</code>\uff08\u628a last IFrame \u4f20\u7ed9 <code>InvokeInterpreter</code> \u6240\u9700\u7684\u5bc4\u5b58\u5668\u4f4d\uff09</li> <li><code>bl InvokeInterpreter</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#4-callee-saved-fplrsp","title":"4) \u8fd4\u56de\uff1a\u6062\u590d callee-saved\u3001\u6062\u590d <code>fp/lr/sp</code>\u3001\u5e76\u4fdd\u8bc1\u8fd4\u56de\u503c\u5f62\u6001","text":"<ul> <li>\u4ece boundary slots \u6062\u590d callee-saved\uff08<code>RESTORE_CALLEE_REGISTERS</code>\uff09</li> <li>\u6062\u590d <code>sp/fp/lr</code></li> <li><code>fmov d0, x0</code>\uff1a\u5c06\u89e3\u91ca\u5668\u8fd4\u56de\u7684 int64 \u4f4d\u6a21\u5f0f\u653e\u5165\u6d6e\u70b9\u8fd4\u56de\u5bc4\u5b58\u5668\uff08\u4e0e amd64 \u7684 <code>movq %rax, %xmm0</code> \u540c\u7406\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#5-deoptimizeafteriframe","title":"5) <code>DeoptimizeAfterIFrame</code>\uff08\u7b80\u8ff0\uff09","text":"<p>\u8be5\u8def\u5f84\u66f4\u504f\u5411\u201c\u5df2\u6709 IFrame \u8bed\u4e49\u201d\u573a\u666f\uff1a</p> <ul> <li>\u590d\u5236/\u6062\u590d LR\uff08OSR \u573a\u666f\u4e0b LR \u69fd\u4f4d\u4e0d\u540c\uff0c\u6587\u4ef6\u7528 <code>CFRAME_COPY_LR/CFRAME_GET_LR</code> \u5b8f\u5904\u7406\uff09</li> <li>\u6062\u590d callee-saved</li> <li>\u8c03 <code>InvokeInterpreter</code> \u5e76\u6309\u7ea6\u5b9a\u8fd4\u56de</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>amd64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/amd64/deoptimization_amd64.S</code></li> <li><code>InvokeInterpreter</code> \u8bed\u4e49\u9aa8\u67b6\uff1a<code>runtime/bridge/bridge.cpp</code>\uff08\u672c\u7ae0\u5df2\u6709 FileNotes/\u5f15\u7528\uff09</li> <li>StackWalker/ConvertToIFrame\uff1a<code>runtime/stack_walker.cpp</code> + <code>runtime/include/stack_walker.h</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aDeopt_and_OSR\uff08Flow\uff09 + Bridge_I2C_C2I\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cI2C \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 I2C\uff08Interpreter\u2192Compiled\uff09 \u6865\u63a5\uff1a\u4ece\u89e3\u91ca\u5668\u4fa7\u8f93\u5165 <code>(insn, iframe, method, thread)</code> \u51fa\u53d1\uff0c\u6784\u9020 I2C boundary frame\uff08<code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code> \u6216 <code>BYPASS_BRIDGE</code>\uff09\uff0c\u6309 shorty \u628a\u89e3\u91ca\u5668 vregs/acc \u62c6\u88c5\u5230\u771f\u5b9e ABI \u4f4d\u7f6e\uff08x0-x7 / d0-d7 / stack\uff09\uff0c\u8c03\u7528 <code>method-&gt;compiled_entrypoint</code>\uff0c\u5e76\u6309 shorty \u5c06\u8fd4\u56de\u503c\u5199\u56de <code>frame-&gt;acc</code>\uff08\u4ee5\u53ca mirror/tag\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#1-boundary-frameinterpreter_to_compiled_code_bridge-vs-bypass_bridge","title":"1) boundary frame\uff1a<code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code> vs <code>BYPASS_BRIDGE</code>","text":"<p>\u6587\u4ef6\u5728\u5165\u53e3\u5904\u660e\u786e\u6ce8\u91ca\u4e86 bridge frame \u7684\u7ed3\u6784\uff08\u5173\u952e\u5728\u201cmarker slot\u201d\uff09\uff1a</p> <ul> <li><code>lr</code></li> <li><code>iframe &lt;- fp</code></li> <li><code>INTERPRETER_TO_COMPILED_CODE_BRIDGE/BYPASS_BRIDGE</code></li> <li><code>fp</code></li> <li><code>THREAD_REG</code></li> <li><code>x19 &lt;- sp</code></li> </ul> <p>\u968f\u540e\u6839\u636e <code>MANAGED_THREAD_FRAME_KIND_OFFSET(thread)</code> \u9009\u62e9 marker\uff1a</p> <ul> <li>\u82e5 caller \u5728 compiled \u4fa7\uff1a\u5199 <code>BYPASS_BRIDGE</code></li> <li>\u5426\u5219\uff1a\u5199 <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code></li> </ul> <p>\u8fd9\u5c31\u662f StackWalker/FrameKind \u7684\u201c\u5206\u5c94\u70b9\u201d\uff1amarker \u51b3\u5b9a\u201c\u8de8\u8fb9\u754c\u201d\u7684\u89e3\u7801\u8bed\u4e49\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#2-shorty-prepareargstack-dispatch-handlers","title":"2) shorty \u9a71\u52a8\u7684\u53c2\u6570\u88c5\u914d\uff1aPrepareArgStack + dispatch handlers","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#21-shorty-instance-hack","title":"2.1 shorty \u521d\u59cb\u5316\u4e0e instance \u65b9\u6cd5 hack","text":"<ul> <li><code>method.shorty</code> \u6765\u81ea <code>METHOD_SHORTY_OFFSET</code>\uff0c\u901a\u8fc7 <code>INIT_SHORTY_REG</code> \u521d\u59cb\u5316 shorty \u72b6\u6001\u673a\u3002</li> <li>instance \u65b9\u6cd5 <code>this</code> \u4e0d\u5728 shorty \u4e2d\u7f16\u7801\uff1a\u8fd9\u91cc\u4f1a hack shorty\uff08\u628a return nibble \u66ff\u6362\u6210 <code>REF</code>\uff09\u6765\u5360\u4f4d <code>this</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#22-prepareargstack-abi","title":"2.2 <code>PrepareArgStack</code> \u9884\u7559 ABI \u4f20\u53c2\u7a7a\u95f4","text":"<p>\u8c03\u7528 <code>PrepareArgStack</code> \u540e\uff0c\u6587\u4ef6\u628a\u5bc4\u5b58\u5668\u8bbe\u7f6e\u4e3a\uff1a</p> <ul> <li>x9\uff1aarg base ptr\uff08GPR/FPR args \u7684 base\uff09</li> <li>x10\uff1aGPR arg ptr</li> <li>x4\uff1aFPR arg ptr</li> <li>x3\uff1astack arg ptr</li> </ul> <p>\u5e76\u5148\u628a <code>Method*</code> \u5199\u5165\u7b2c\u4e00\u4e2a GPR \u53c2\u6570\u69fd\uff08\u6700\u7ec8\u843d\u5230 x0\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#23-bridge_dispatch_aarch64s-call-format","title":"2.3 <code>bridge_dispatch_aarch64.S</code>\uff1a\u6309 call-format \u7ec4\u88c5\u5b9e\u53c2","text":"<p>I2C \u9700\u8981\u6839\u636e\u201c\u5f53\u524d bytecode \u7684 call \u6307\u4ee4\u683c\u5f0f\u201d\u4ece <code>iframe-&gt;vregs</code> \u53d6\u51fa\u5b9e\u9645\u5b9e\u53c2\u3002</p> <p>\u8fd9\u91cc\u7684\u5206\u53d1\u4e0d\u662f\u89e3\u91ca\u5668 dispatch\uff0c\u800c\u662f call-format dispatch\uff1a</p> <ul> <li>\u5148\u8bfb\u53d6 opcode\uff08\u542b prefix opcode\uff09</li> <li>\u8fdb\u5165 <code>.Ldispatch</code> \u5e76 <code>#include \"bridge_dispatch_aarch64.S\"</code></li> <li>\u5404 handler \u8d1f\u8d23\u628a\u201c\u4ece vregs/imm \u63d0\u53d6\u7684\u53c2\u6570\u201d\u7528 shorty/type \u89c4\u5219\u5199\u5165 GPR/FPR/stack \u4e09\u7c7b\u53c2\u6570\u533a</li> <li>\u6700\u7ec8\u8df3\u5230\u7edf\u4e00\u7684 <code>.Lload_reg_args</code></li> </ul> <p><code>bridge_dispatch_*.S</code> \u7531 <code>runtime/templates/bridge_dispatch.S.erb</code> \u751f\u6210\uff0c\u5e76\u8fdb\u4e00\u6b65\u4f9d\u8d56\u5404 <code>handle_call_&lt;format&gt;.S</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#3-lload_reg_args-args-x0-x7-d0-d7","title":"3) <code>.Lload_reg_args</code>\uff1a\u628a\u51c6\u5907\u597d\u7684 args \u88c5\u5165 x0-x7 / d0-d7","text":"<p>\u5728 <code>.Lload_reg_args</code> \u6c47\u603b\u70b9\uff1a</p> <ul> <li><code>LOAD_FPR_ARGS</code>\uff1a\u628a\u6d6e\u70b9\u53c2\u6570\u4ece\u9884\u7559\u533a\u88c5\u5165 d0-d7</li> <li><code>LOAD_GPR_ARGS</code>\uff1a\u628a\u6574\u6570/\u6307\u9488\u53c2\u6570\u4ece\u9884\u7559\u533a\u88c5\u5165 x0-x7</li> <li><code>mov sp, x9</code>\uff1a\u628a sp \u590d\u4f4d\u5230 stack args \u533a\uff0c\u6ee1\u8db3 ABI \u8c03\u7528\u7ea6\u5b9a</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#4-compiled-entrypoint","title":"4) \u8c03\u7528 compiled entrypoint","text":"<ul> <li><code>ldr lr, [lr, #METHOD_COMPILED_ENTRY_POINT_OFFSET]</code></li> <li><code>blr lr</code></li> </ul> <p>\u5176\u4e2d <code>lr</code> \u5728\u524d\u9762\u88ab\u590d\u7528\u4e3a <code>Method*</code>\uff08\u6ce8\u91ca\u4e2d\u660e\u786e\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#5-acc-tagmirror","title":"5) \u8fd4\u56de\u503c\u5199\u56de\uff1a\u5199\u56de <code>acc</code>\uff08\u542b tag/mirror\uff09","text":"<p>\u6839\u636e <code>shorty[0] &amp; 0xF</code> \u5224\u65ad\u8fd4\u56de\u7c7b\u578b\uff1a</p> <ul> <li><code>void</code>\uff1a\u4e0d\u5199\u56de</li> <li><code>float/double</code>\uff1a\u4ece d0 \u53d6\u4f4d\u6a21\u5f0f\u5e76\u5199\u56de</li> <li>\u5176\u5b83\uff08\u542b <code>reference</code> \u4e0e <code>tagged(any)</code>\uff09\uff1a\u4ece x0/x1 \u7ec4\u5408\u5199\u56de <code>acc</code> \u4e0e mirror/tag</li> </ul> <p>\u8fd9\u4fdd\u8bc1\u89e3\u91ca\u5668\u4fa7\u5728\u8fd4\u56de\u540e\u80fd\u7ee7\u7eed\u4ee5 \u201cacc \u534f\u8bae\u201d \u5de5\u4f5c\uff08\u5e76\u4e0e GC/\u5f02\u5e38\u8bed\u4e49\u4e00\u81f4\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> <li>FrameKind/\u8fb9\u754c\u8bed\u4e49\uff1aBridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> <li>amd64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_amd64.S</code>\uff08\u5bf9\u5e94 FileNote \u5df2\u6709\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_dyn_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cI2C(Dyn) \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 I2C\uff08Dynamic calling convention\uff09\uff1a\u670d\u52a1\u4e8e\u52a8\u6001\u8bed\u8a00/TaggedValue \u8bed\u4e49\u7684\u89e3\u91ca\u5668\u2192\u7f16\u8bd1\u6865\u63a5\u3002\u5b83\u4e0e\u9759\u6001\u7248\u672c\u6700\u5927\u7684\u4e0d\u540c\u70b9\u662f\uff1a\u53c2\u6570\u6765\u6e90\u4e0d\u518d\u662f shorty\uff0c\u800c\u662f\u201c\u5b9e\u9645\u53c2\u6570\u4e2a\u6570 + TaggedValue \u6570\u7ec4/\u6808\u5e03\u5c40\u201d\uff1bdispatch \u903b\u8f91\u4ecd\u7531\u6a21\u677f\u751f\u6210\uff0c\u5e76\u6700\u7ec8\u8c03\u7528 compiled entrypoint\uff0c\u518d\u628a\u7ed3\u679c\u5199\u56de <code>frame-&gt;acc</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S/#1-boundary-marker","title":"1) boundary marker \u7684\u9009\u62e9\u89c4\u5219\u4e0e\u9759\u6001\u7248\u4e00\u81f4","text":"<p>\u5165\u53e3\u5904\u540c\u6837\u6839\u636e <code>MANAGED_THREAD_FRAME_KIND_OFFSET(thread)</code> \u5728\u6808\u4e0a\u5199\u5165\uff1a</p> <ul> <li><code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code></li> <li>\u6216 <code>BYPASS_BRIDGE</code></li> </ul> <p>\u8fd9\u4fdd\u8bc1 StackWalker \u80fd\u5728 IFrame/CFrame \u4e24\u5957\u89e3\u7801\u89c4\u5219\u4e4b\u95f4\u6b63\u786e\u5207\u6362\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S/#2-dyn-dispatchbridge_dispatch_dyn_aarch64s","title":"2) dyn dispatch\uff1a<code>bridge_dispatch_dyn_aarch64.S</code>","text":"<p>\u8be5\u6587\u4ef6\u8bfb\u53d6 opcode\uff08\u542b prefix opcode\uff09\uff0c\u8fdb\u5165 <code>.Ldispatch</code>\uff1a</p> <ul> <li><code>#include \"bridge_dispatch_dyn_aarch64.S\"</code></li> <li>\u6ce8\u91ca\u660e\u786e\u6307\u51fa\uff1a\u8be5\u6587\u4ef6\u7531 <code>runtime/templates/bridge_dispatch.S.erb</code> \u751f\u6210\uff0c\u5e76\u8fdb\u4e00\u6b65\u4f9d\u8d56 <code>handle_call_&lt;format&gt;.S</code></li> </ul> <p>\u8fd9\u90e8\u5206\u7684\u201c\u8bc1\u636e\u94fe\u4ef7\u503c\u201d\u5728\u4e8e\uff1a\u5f53\u65b0\u589e call format \u65f6\uff0c\u8fd9\u91cc\u4f1a\u63d0\u793a\u7f3a\u5c11\u5bf9\u5e94 handler\uff08\u7f16\u8bd1\u62a5\u9519\u8def\u5f84\u6e05\u6670\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S/#3-compiled-entrypoint","title":"3) \u8c03\u7528 compiled entrypoint \u4e0e\u8fd4\u56de\u503c\u5199\u56de","text":"<p>\u5173\u952e\u52a8\u4f5c\uff1a</p> <ul> <li>\u8c03\u7528\uff1a<code>ldr lr, [x0, METHOD_COMPILED_ENTRY_POINT_OFFSET] ; blr lr</code>\uff08x0 \u4e3a <code>Method*</code>\uff09</li> <li>\u5199\u56de\uff1a\u628a\u8fd4\u56de\u503c\u5199\u5165 <code>FRAME_ACC_OFFSET(frame)</code>\uff08\u8be5\u6587\u4ef6\u660e\u786e <code>str x0, [frame.acc]</code>\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S/#4-i2c","title":"4) \u4e0e\u9759\u6001 I2C \u7684\u5173\u7cfb","text":"<ul> <li>\u9759\u6001 I2C\uff08shorty \u9a71\u52a8\uff09\u8be6\u89c1\uff1a<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_aarch64.S</code></li> <li>dyn I2C \u7684\u6838\u5fc3\u5dee\u5f02\u662f\u201c\u53c2\u6570\u88c5\u914d\u89c4\u5219\u201d\uff1a</li> <li>\u9759\u6001\uff1ashorty \u51b3\u5b9a GPR/FPR/stack \u7684\u5e03\u5c40\u4e0e tag(mirror)</li> <li>dyn\uff1a\u4ee5 TaggedValue/\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\u4e3a\u4e2d\u5fc3\uff0c\u6309\u52a8\u6001\u8c03\u7528\u7ea6\u5b9a\u7ec4\u7ec7\u53c2\u6570</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/","title":"<code>runtime/bridge/arch/aarch64/proxy_entrypoint_aarch64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cproxy entrypoint / \u5f02\u5e38\u6865\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aaarch64 \u4e0a\u7684 proxy entrypoint\uff1a\u7528\u4e00\u4e2a\u201c\u53ef\u88ab\u901a\u7528\u65b9\u5f0f\u8c03\u7528\u201d\u7684\u6865\u63a5\u5165\u53e3\u5305\u88f9\u771f\u5b9e\u76ee\u6807 entry\uff08<code>\\entry</code>\uff09\uff0c\u5728\u5fc5\u8981\u65f6\u5efa\u7acb C2I boundary frame \u5199 TLS\uff0c\u5e76\u5728\u8fd4\u56de\u8def\u5f84\u4e0a\u5904\u7406\u201cnative \u5f02\u5e38 \u2192 ThrowNativeExceptionBridge\u201d \u7684\u8df3\u8f6c\u4e0e\u5bc4\u5b58\u5668\u6062\u590d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#1-proxy","title":"1) proxy \u4e3a\u4ec0\u4e48\u5b58\u5728","text":"<p>proxy \u89e3\u51b3\u4e24\u4e2a\u73b0\u5b9e\u95ee\u9898\uff1a</p> <ul> <li>\u7edf\u4e00\u5165\u53e3 ABI\uff1a\u4e0a\u5c42\u53ef\u4ee5\u7a33\u5b9a\u5730\u4ee5\u201cproxy \u7ea6\u5b9a\u201d\u8c03\u7528\u5404\u79cd runtime/slowpath/entrypoint\uff0c\u800c proxy \u518d\u8f6c\u53d1\u5230\u771f\u5b9e <code>\\entry</code>\u3002</li> <li>\u5f02\u5e38\u4e0e\u6808\u904d\u5386\u6b63\u786e\u6027\uff1a\u5f53\u8c03\u7528\u94fe\u8de8\u8d8a compiled/\u89e3\u91ca\u5668\u8fb9\u754c\u65f6\uff0c\u9700\u8981\u6784\u9020\u53ef\u8bc6\u522b\u7684 boundary frame\uff0c\u5e76\u5728\u8fd4\u56de\u65f6\u628a\u5bc4\u5b58\u5668\u6062\u590d\u5230\u201c\u53ef\u7ee7\u7eed unwind/\u629b\u5f02\u5e38\u201d\u7684\u5f62\u6001\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#2-c2i-boundary-frame-callee-saved","title":"2) \u6784\u9020 C2I boundary frame + \u4fdd\u5b58 callee-saved","text":"<p>\u5b8f <code>PROXY_ENTRYPOINT name, entry, skip_c2i_bridge</code> \u5728\u5165\u53e3\u5904\uff1a</p> <ul> <li>\u4fdd\u5b58 <code>lr</code> \u5e76\u628a <code>lr</code> \u7f6e\u4e3a <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code></li> <li>\u5efa\u7acb <code>fp</code></li> <li><code>PUSH_CALLEE_REGS sp</code> \u4fdd\u5b58 x19-x28 \u4e0e d8-d15\uff0c\u5e76\u914d\u5957 CFI\uff08\u4fbf\u4e8e unwind\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#3-tls-caller-compiled","title":"3) \u4f55\u65f6\u5199 TLS\uff1a\u4ec5\u5f53 caller \u662f compiled","text":"<p>\u5173\u952e\u903b\u8f91\uff1a</p> <ul> <li>\u8bfb\u53d6 <code>MANAGED_THREAD_FRAME_KIND_OFFSET</code></li> <li>\u53ea\u6709\u5f53 \u201ccaller \u4e3a compiled\u201d \u65f6\u624d <code>str fp, [THREAD_REG, #MANAGED_THREAD_FRAME_OFFSET]</code></li> </ul> <p>\u610f\u4e49\uff1a</p> <ul> <li>\u5982\u679c caller \u672c\u8eab\u5c31\u662f\u89e3\u91ca\u5668\u4fa7\uff0cTLS \u5df2\u7ecf\u6307\u5411\u89e3\u91ca\u5668 <code>Frame*</code> \u94fe\uff0c\u65e0\u9700\u8986\u76d6\u3002</li> <li>\u5982\u679c caller \u662f compiled\uff0cproxy \u5fc5\u987b\u628a boundary frame \u66b4\u9732\u7ed9 StackWalker/GC\uff08safepoint \u53ef\u89c1\u6027\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#4-entry","title":"4) \u53c2\u6570\u900f\u4f20\uff1a\u628a\u5bc4\u5b58\u5668\u53c2\u6570\u4fdd\u5b58\u4e3a\u6570\u7ec4\u4f20\u7ed9 <code>\\entry</code>","text":"<p>\u6587\u4ef6\u4f1a\u628a\u53c2\u6570\u5bc4\u5b58\u5668\uff08x0-x7 / d0-d7\uff09\u538b\u6808\uff0c\u7136\u540e\uff1a</p> <ul> <li><code>x1 = sp</code>\uff1a\u6307\u5411\u201c\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u53c2\u6570\u6570\u7ec4\u201d</li> <li><code>x2 = fp + 24</code>\uff1a\u6307\u5411 caller \u7684 stack args \u533a</li> <li><code>bl \\entry</code></li> </ul> <p>\u8fd9\u4e0e amd64 \u7248\u672c\u7684\u6ce8\u91ca\u4e00\u81f4\uff08rsi \u6307\u5411 pushed args\uff0crdx \u6307\u5411 stack args\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#5-thrownativeexceptionbridge","title":"5) \u8fd4\u56de\u8def\u5f84\uff1a\u5f02\u5e38\u68c0\u6d4b\u4e0e ThrowNativeExceptionBridge","text":"<p>\u8fd4\u56de\u524d\u4f1a\uff1a</p> <ul> <li>\u6062\u590d callee-saved\uff08\u6ce8\u610f\u6ce8\u91ca\uff1a\u201cGC may change its values while moving objects.\u201d\uff09</li> <li>\u6062\u590d <code>fp/lr/sp</code></li> <li>\u68c0\u67e5 <code>MANAGED_THREAD_EXCEPTION_OFFSET</code>\uff08thread-&gt;exception \u662f\u5426\u975e\u7a7a\uff09</li> <li>\u5982\u679c\u5b58\u5728\u5f02\u5e38\uff0c\u4e14 caller \u4e3a compiled\uff0c\u4e14 prev frame \u4e0d\u662f <code>BYPASS_BRIDGE</code>\uff0c\u5219\uff1a</li> <li>\u4ece boundary frame \u533a\u6062\u590d caller \u7684 GPR/FPR\uff08\u5305\u542b\u662f\u5426\u5b58\u5728\u6d6e\u70b9\u5bc4\u5b58\u5668\u7684 flags\uff09</li> <li><code>b ThrowNativeExceptionBridge</code></li> </ul> <p>\u8fd9\u6bb5\u662f\u201c\u5f02\u5e38\u4ece native/compiled \u56de\u5230 runtime \u629b\u51fa\u8def\u5f84\u201d\u7684\u7269\u7406\u8bc1\u636e\uff1a\u5b83\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u5f02\u5e38\u8def\u5f84\u9700\u8981\u201c\u6062\u590d caller \u5bc4\u5b58\u5668\u5feb\u7167\u201d\uff0c\u5426\u5219 unwind/\u629b\u5f02\u5e38\u65f6\u5bc4\u5b58\u5668\u72b6\u6001\u4e0d\u5b8c\u6574\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>amd64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/amd64/proxy_entrypoint_amd64.S</code></li> <li>deopt \u4e0e boundary frame\uff1a<code>runtime/bridge/arch/*/deoptimization_*.S</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09 + Bridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/","title":"<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cC2I \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 C2I\uff08Compiled\u2192Interpreter\uff09 \u6865\u63a5\uff1a\u5728 compiled \u8c03\u7528\u70b9\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> \u8fb9\u754c\u5e27\uff0c\u4fdd\u5b58 callee-saved\uff08\u4f9b StackWalker/GC/\u5f02\u5e38 unwind\uff09\uff0c\u5fc5\u8981\u65f6\u89e6\u53d1\uff08\u6216\u7b49\u5f85\uff09\u7f16\u8bd1\uff1b\u82e5\u4ecd\u672a\u7f16\u8bd1\u5219\u521b\u5efa\u89e3\u91ca\u5668 <code>IFrame</code>\u3001\u642c\u8fd0\u53c2\u6570\u5e76\u8fdb\u5165 <code>InterpreterEntryPoint</code>\uff0c\u6700\u540e\u4ece <code>acc/acc_mirror</code> \u8fd8\u539f\u8fd4\u56de\u5bc4\u5b58\u5668\u5e76\u8fd4\u56de\u7ed9 compiled caller\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#1-c2i-callee-saved-tls","title":"1) \u4e3a\u4ec0\u4e48 C2I \u4e00\u5b9a\u8981\u4fdd\u5b58 callee-saved \u5e76\u5199 TLS","text":"<p>\u672c\u6587\u4ef6\u6838\u5fc3\u6ce8\u91ca\u975e\u5e38\u5173\u952e\uff1a</p> <ul> <li>\u201cstack walker will read them during stack unwinding\u201d</li> <li>\u201ccompilation may fall into safepoint, so we need to make caller's callee registers visible for the stack walker\u201d</li> </ul> <p>\u5bf9\u5e94\u7684\u6c47\u7f16\u8bc1\u636e\u70b9\uff08\u53ef\u76f4\u63a5\u5bf9\u7167 <code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_amd64.S</code>\uff09\uff1a</p> <ul> <li>\u4fdd\u5b58 return address \u5230 TLS\uff1a<code>MANAGED_THREAD_NATIVE_PC_OFFSET(%THREAD_REG)</code>   \u8ba9 runtime \u5728 native/compiled \u4fa7\u80fd\u62ff\u5230\u201c\u5f53\u524d native PC\u201d\uff08\u4f8b\u5982\u5f02\u5e38/\u91c7\u6837/\u8bca\u65ad\uff09\u3002</li> <li>\u628a C2I frame \u6307\u9488\u5199\u5165 TLS\uff1a<code>movq %rbp, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code>   \u53d1\u751f safepoint/StackWalker unwind \u65f6\uff0c\u53ef\u4ee5\u4ece TLS \u627e\u5230\u8fd9\u6761 boundary frame\uff0c\u5e76\u8bfb\u53d6\u5176\u4fdd\u5b58\u7684 callee-saved\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#2-compiled_code_to_interpreter_bridge-boundary-frame","title":"2) \u5165\u53e3\uff1a\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame","text":"<p>\u5173\u952e\u52a8\u4f5c\uff1a</p> <ul> <li><code>pushq $COMPILED_CODE_TO_INTERPRETER_BRIDGE</code>\uff1a\u628a boundary marker \u538b\u5165\u6808\uff08StackWalker \u7684\u5206\u5c94\u70b9\uff09</li> <li><code>pushq %rbp; movq %rsp, %rbp</code>\uff1a\u5efa\u7acb frame pointer</li> <li>\u4fdd\u5b58 callee-saved\uff1a<code>r15 r14 r13 r12 rbx</code>\uff08\u5e76\u914d CFI\uff0c\u4fbf\u4e8e unwind\uff09</li> </ul> <p>\u8fd9\u4e0e\u672c\u7ae0\u4e0d\u53d8\u91cf\u4e00\u81f4\uff1a\u8fb9\u754c\u5e27 + callee-saved \u53ef\u89c1\u6027\u662f\u201c\u8de8\u89e3\u91ca\u5668/\u7f16\u8bd1\u6808\u201d\u6b63\u786e unwind \u7684\u5fc5\u8981\u6761\u4ef6\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#3-decrementhotnesscounter","title":"3) \u70ed\u5ea6\u8ba1\u6570/\u89e6\u53d1\u7f16\u8bd1\uff1a<code>DecrementHotnessCounter</code>","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#31-decrementhotnesscounter-tls","title":"3.1 \u4e3a\u4ec0\u4e48\u201c\u8c03\u7528 DecrementHotnessCounter \u524d\u5fc5\u987b\u5148\u5199 TLS\u201d","text":"<p>\u672c\u6587\u4ef6\u5728\u8c03\u7528 <code>DecrementHotnessCounter</code> \u524d\u4f1a\u5148\uff1a</p> <ul> <li><code>movq %rbp, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code></li> </ul> <p>\u7406\u7531\uff08\u6587\u4ef6\u539f\u6ce8\u91ca\uff09\uff1a\u7f16\u8bd1\u8fc7\u7a0b\u53ef\u80fd\u8fdb\u5165 safepoint\uff1b\u5982\u679c\u8fd9\u65f6 GC/StackWalker \u9700\u8981\u904d\u5386\u6808\uff0c\u5fc5\u987b\u80fd\u770b\u5230 caller \u7684 callee-saved\uff08\u5b83\u4eec\u5df2\u88ab C2I \u4fdd\u5b58\u5230\u6808\u91cc\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#32-c2i-compiled-entrypoint","title":"3.2 \u7f16\u8bd1\u6210\u529f\uff1a\u62c6\u9664 C2I \u5e76\u76f4\u63a5\u8df3\u8f6c\u5230 compiled entrypoint","text":"<p>\u5f53 <code>DecrementHotnessCounter</code> \u8fd4\u56de <code>al != 0</code>\uff1a</p> <ul> <li>\u6062\u590d TLS\uff1a<code>movq (%rbp), %r8; movq %r8, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code>   \uff08\u628a thread-&gt;frame \u6307\u56de caller \u7684\u4e0a\u4e00\u5e27\uff0cC2I \u4e0d\u518d\u662f\u201c\u5f53\u524d\u8fb9\u754c\u201d\uff09</li> <li>\u6062\u590d\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\uff08PUSH/POP \u5b8f + callee-saved\uff09</li> <li>\u4e0d\u8d70 ret\uff0c\u800c\u662f\uff1a</li> <li><code>movq METHOD_COMPILED_ENTRY_POINT_OFFSET(%rdi), %rax</code></li> <li><code>jmp *%rax</code></li> </ul> <p>\u8fd9\u4e00\u6b65\u89e3\u91ca\u4e86\u201c\u4e3a\u4ec0\u4e48 C2I \u770b\u8d77\u6765\u50cf\u4e00\u4e2a\u51fd\u6570\uff0c\u5374\u5e38\u5e38\u4ee5 <code>jmp entrypoint</code> \u7684\u65b9\u5f0f\u79bb\u5f00\u201d\uff1a\u5b83\u628a\u63a7\u5236\u6743\u76f4\u63a5\u4ea4\u7ed9\u65b0\u751f\u6210\u7684 compiled code\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#4-iframe","title":"4) \u672a\u7f16\u8bd1\uff1a\u521b\u5efa <code>IFrame</code> + \u642c\u8fd0\u53c2\u6570 + \u8fdb\u5165\u89e3\u91ca\u5668","text":"<p>\u5f53 <code>.Lnot_compiled</code> \u5206\u652f\uff1a</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#41","title":"4.1 \u521b\u5efa\u89e3\u91ca\u5668\u5e27","text":"<ul> <li>\u8c03 <code>CreateFrameForMethod(method, prev)</code>\uff1a<code>prev</code> \u53d6\u5f53\u524d <code>%rbp</code>\uff08\u4e5f\u5c31\u662f C2I boundary frame\uff09   \u8fd4\u56de\u7684 <code>Frame*</code> \u4fdd\u5b58\u5230\u5bc4\u5b58\u5668\uff08\u6e90\u7801\u4e2d\u53ef\u89c1 <code>%r13</code>\uff09\u3002</li> </ul> <p>\u8fd9\u7b49\u4ef7\u4e8e\u201c\u5728\u6808\u4e0a\u63d2\u5165\u4e00\u4e2a\u89e3\u91ca\u5668\u8bed\u4e49\u5e27 IFrame\uff0c\u5e76\u8ba9\u5b83\u7684 prev \u6307\u5411 C2I \u8fb9\u754c\u5e27\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#42-shorty-instance-hack","title":"4.2 shorty \u89c4\u5219\u4e0e instance \u65b9\u6cd5 \u201chack\u201d","text":"<ul> <li>shorty \u7528\u4e8e\u63cf\u8ff0\u53c2\u6570/\u8fd4\u56de\u7c7b\u578b\uff0c\u6307\u5bfc\u201c\u4ece ABI \u53c2\u6570\u4f4d\u7f6e \u2192 IFrame.vregs\u201d\u62f7\u8d1d\u3002</li> <li>instance \u65b9\u6cd5\u7684 <code>this</code> \u4e0d\u5728 shorty \u91cc\u7f16\u7801\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f1a hack shorty\uff1a\u628a return type nibble \u66ff\u6362\u4e3a <code>REF</code> \u6765\u5360\u4f4d\uff08\u7b49\u4ef7\u4e8e\u201c\u628a this \u5f53\u6210\u7b2c\u4e00\u4e2a\u53c2\u6570\u7c7b\u578b\u201d\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#43-abi-vregs-tagmirror","title":"4.3 \u4ece ABI \u53c2\u6570\u533a\u8bfb\u53c2\u6570\u3001\u5199\u5165 <code>vregs</code> \u4e0e tag(mirror)","text":"<p>\u4ee3\u7801\u4f1a\u6839\u636e shorty \u9010\u4e2a\u53c2\u6570\u62f7\u8d1d\uff1a</p> <ul> <li>\u6765\u6e90\uff1aGPR/FPR/stack \u4e09\u8def\uff08\u901a\u8fc7\u8ba1\u6570\u5668 <code>gpr_arg_counter</code> / <code>float_arg_counter</code> \u51b3\u5b9a\u53d6\u54ea\u4e00\u8def\uff09</li> <li>\u76ee\u7684\uff1a<code>frame-&gt;vregs_</code> \u4ee5\u53ca tag(mirror) \u533a   \u4f60\u80fd\u770b\u5230\u201c\u5148\u5199 tag \u518d\u5199 value\u201d\u7684\u6a21\u5f0f\uff08\u5f15\u7528\u7c7b\u578b tag=1\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#5-compiled-caller","title":"5) \u8fdb\u5165\u89e3\u91ca\u5668\u4e0e\u8fd4\u56de\u503c\u8fd8\u539f\uff08\u8fd4\u56de\u7ed9 compiled caller\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#51","title":"5.1 \u8fdb\u5165\u89e3\u91ca\u5668","text":"<ul> <li><code>InterpreterEntryPoint(method, iframe)</code></li> </ul> <p>\u89e3\u91ca\u5668\u6267\u884c\u7ed3\u675f\u540e\uff0c\u8fd4\u56de\u503c\u4f1a\u88ab\u5199\u5165 <code>iframe-&gt;acc_</code>\uff08\u4ee5\u53ca mirror/tag\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#52-accacc_mirror","title":"5.2 \u4ece <code>acc/acc_mirror</code> \u8fd8\u539f\u8fd4\u56de\u5bc4\u5b58\u5668","text":"<p>\u6839\u636e <code>shorty[0] &amp; 0xF</code> \u533a\u5206\u8fd4\u56de\u7c7b\u578b\uff1a</p> <ul> <li><code>void</code>\uff1a<code>FreeFrame</code> \u540e\u4e0d\u8bbe\u7f6e\u8fd4\u56de\u5bc4\u5b58\u5668</li> <li><code>reference</code>\uff1a\u4ece <code>acc</code> \u53d6 value \u653e\u5230 <code>%rax</code>\uff0ctag \u653e\u5230 <code>%rdx</code>\uff08\u5e76\u5728 32-bit managed ptr \u573a\u666f\u6e05\u9ad8 32 \u4f4d\uff09</li> <li><code>int/long/tagged(any)</code>\uff1a<code>acc</code>\u2192<code>%rax</code>\uff0cmirror\u2192<code>%rdx</code></li> <li><code>float/double</code>\uff1a<code>acc</code>\u2192<code>%xmm0</code></li> </ul> <p>\u6700\u540e\uff1a</p> <ul> <li><code>FreeFrame(iframe)</code>\uff08\u91ca\u653e\u89e3\u91ca\u5668\u5e27\uff09</li> <li>\u6062\u590d callee-saved\uff0cret \u56de compiled caller</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u6982\u5ff5/\u903b\u8f91\u6d41\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> <li>FrameKind/\u8fb9\u754c\u8bed\u4e49\uff1aBridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> <li>C++ \u9aa8\u67b6\uff08acc \u5199\u56de\u3001thread \u72b6\u6001\u4f4d\u5207\u6362\u70b9\uff09\uff1a<code>runtime/bridge/bridge.cpp</code>\uff08\u672c\u7ae0\u5df2\u6709 FileNotes/\u5f15\u7528\uff09</li> <li>aarch64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/","title":"<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_dyn_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cC2I(Dyn) \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 C2I\uff08Dynamic calling convention\uff09\uff1a\u4e3a\u52a8\u6001\u8bed\u8a00/TaggedValue \u8bed\u4e49\u63d0\u4f9b compiled\u2192\u89e3\u91ca\u5668\u56de\u9000\u8def\u5f84\u3002\u6574\u4f53\u5f62\u6001\u4e0e\u9759\u6001 C2I \u76f8\u540c\uff1a\u5148\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame\u3001\u4fdd\u5b58 callee-saved\u3001\u5199 TLS\uff08\u4fdd\u8bc1 safepoint/StackWalker \u53ef\u89c1\uff09\uff0c\u7136\u540e\u505a <code>DecrementHotnessCounterDyn</code> \u63a2\u6d4b\uff1b\u82e5\u4ecd\u672a\u7f16\u8bd1\u5219\u521b\u5efa <code>IFrame</code>\uff08\u6309\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\uff09\u5e76\u8fdb\u5165 <code>InterpreterEntryPoint</code>\uff0c\u6700\u540e\u4ece <code>acc/acc_mirror</code> \u53d6\u56de <code>(value, tag)</code> \u8fd4\u56de\u7ed9 compiled caller\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/#1-tls-callee-saved-c2i","title":"1) TLS \u4e0e callee-saved\uff1a\u4e0e\u9759\u6001 C2I \u76f8\u540c\u7684\u786c\u7ea6\u675f","text":"<p>\u6587\u4ef6\u660e\u786e\u5305\u542b\u4e09\u4ef6\u4e8b\uff1a</p> <ul> <li>\u4fdd\u5b58 return address \u5230 <code>MANAGED_THREAD_NATIVE_PC_OFFSET(%THREAD_REG)</code></li> <li><code>pushq $COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> + <code>rbp</code> \u5efa\u7acb boundary frame</li> <li>\u8c03 <code>DecrementHotnessCounterDyn</code> \u524d\uff1a<code>movq %rbp, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/#2-jmp-entrypoint","title":"2) \u7f16\u8bd1\u6210\u529f\uff1a\u76f4\u63a5 <code>jmp entrypoint</code>","text":"<p>\u5f53 <code>DecrementHotnessCounterDyn</code> \u8fd4\u56de\u975e 0\uff1a</p> <ul> <li>\u6062\u590d TLS\uff1a<code>movq (%rbp), %r8 ; movq %r8, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code></li> <li>\u62c6\u9664 C2I \u6865\uff08\u6062\u590d\u5bc4\u5b58\u5668/\u6808\uff09</li> <li><code>movq METHOD_COMPILED_ENTRY_POINT_OFFSET(%rdi), %rax ; jmp *%rax</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/#3-iframe-rest-args","title":"3) \u672a\u7f16\u8bd1\uff1a\u6309\u201c\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\u201d\u521b\u5efa IFrame + \u521d\u59cb\u5316 rest args","text":"<p>dyn \u7248\u4e0d\u4f1a\u89e3\u6790 shorty \u6765\u642c\u8fd0\u53c2\u6570\uff0c\u800c\u662f\uff1a</p> <ul> <li><code>CreateFrameForMethodWithActualArgsDyn(actual_num_args, method, prev)</code></li> <li><code>num_iframe_args = max(actual_num_args, method-&gt;num_args_)</code></li> <li>\u628a caller stack \u4e0a\u7684\u5b9e\u53c2\u62f7\u8d1d\u8fdb <code>frame-&gt;vregs_</code> \u672b\u5c3e\u533a\u57df</li> <li>\u5bf9\u4e0d\u8db3\u90e8\u5206\u7528 <code>TAGGED_VALUE_UNDEFINED</code> \u521d\u59cb\u5316</li> </ul> <p>\u5e76\u5728\u67d0\u4e9b\u914d\u7f6e\u4e0b\u521d\u59cb\u5316 EcmascriptEnvironment\uff08\u6587\u4ef6\u5185\u6709\u6761\u4ef6\u7f16\u8bd1\u5757\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/#4","title":"4) \u8fdb\u5165\u89e3\u91ca\u5668\u4e0e\u8fd4\u56de\u503c\u8fd8\u539f","text":"<ul> <li><code>InterpreterEntryPoint(method, iframe)</code></li> <li>\u4ece <code>FRAME_ACC_OFFSET</code> + <code>FRAME_ACC_MIRROR_OFFSET</code> \u53d6\u56de <code>(value, tag)</code>\uff0c<code>FreeFrame</code> \u540e\uff1a</li> <li><code>%rax = value</code></li> <li><code>%rdx = tag</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S/#5","title":"5) \u5bf9\u7167\u4e0e\u94fe\u63a5","text":"<ul> <li>\u9759\u6001 C2I\uff08shorty \u9a71\u52a8\uff09\u5bf9\u7167\uff1a<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_amd64.S</code></li> <li>dyn I2C\uff08\u914d\u5957\u5165\u53e3\uff09\uff1a<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_dyn_amd64.S</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/","title":"<code>runtime/bridge/arch/amd64/deoptimization_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cdeopt \u4e0e boundary frame \u53d8\u5f62\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 deoptimization \u6c47\u7f16\u843d\u5730\uff1a\u628a\u201c\u4ece compiled \u56de\u5230\u89e3\u91ca\u5668\u201d\u7684\u5173\u952e\u8def\u5f84\u505a\u6210\u6808\u53d8\u5f62\u4e0e\u5bc4\u5b58\u5668\u6062\u590d\u903b\u8f91\u3002\u6838\u5fc3\u5165\u53e3\u5305\u62ec\uff1a - <code>DeoptimizeAfterCFrame</code>\uff1a\u628a\u4e00\u4e2a CFrame \u53d8\u5f62\uff08morph\uff09\u4e3a C2I boundary frame\uff0c\u518d\u8c03\u7528 <code>InvokeInterpreter</code> - <code>DeoptimizeAfterIFrame</code>\uff1a\u5728\u5df2\u6709 IFrame \u8bed\u4e49\u7684\u573a\u666f\u4e0b\u6062\u590d\u5bc4\u5b58\u5668\u5e76\u8fdb\u5165\u89e3\u91ca\u5668 - <code>DropCompiledFrameAndReturn</code>\uff1a\u4e22\u5f03 compiled \u5e27\u5e76\u5b89\u5168\u8fd4\u56de\uff08\u907f\u514d StackWalker \u6821\u9a8c\u5931\u8d25\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#1-deoptimizeaftercframecframe-c2i-boundary-frame","title":"1) <code>DeoptimizeAfterCFrame</code>\uff1aCFrame \u2192 C2I boundary frame\uff08\u786c\u8bc1\u636e\uff09","text":"<p>\u6587\u4ef6\u6ce8\u91ca\u76f4\u63a5\u7ed9\u51fa\u53d8\u5f62\u76ee\u6807\uff1a</p> <ul> <li>FROM\uff1a<code>lr ; fp &lt;--- ; method</code></li> <li>TO\uff1a<code>lr ; COMPILED_CODE_TO_INTERPRETER_BRIDGE ; fp &lt;---</code></li> </ul> <p>\u5173\u952e\u5b9e\u73b0\u70b9\uff1a</p> <ul> <li>\u4ee5 <code>%rcx</code>\uff08cframe origin\uff09\u4e3a CFA\uff0c\u91cd\u7b97 <code>%rsp</code> \u5230 boundary \u9884\u7559\u533a\uff1a <code>leaq -(((CFRAME_HEADER_SIZE - 2) * 8) + CALLEE_SAVED_SIZE)(%rcx), %rsp</code></li> <li>\u5c06 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> \u5199\u5165\u56fa\u5b9a\u69fd\u4f4d\uff1a <code>movq $COMPILED_CODE_TO_INTERPRETER_BRIDGE, (INT_METHOD_OFFSET * 8)(%rcx)</code></li> <li>\u628a last IFrame \u7684 <code>prev_frame</code> \u6307\u5411\u8be5 boundary\uff1a <code>movq %rcx, FRAME_PREV_FRAME_OFFSET(%r8)</code></li> </ul> <p>\u8fd9\u6761\u662f\u201c\u903b\u8f91 IFrame \u94fe\u201d\u4e0e\u201c\u7269\u7406 boundary frame\u201d\u5728 deopt \u65f6\u5982\u4f55\u63a5\u8d77\u6765\u7684\u6839\u8bc1\u636e\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#2-boundary-slots-cframe-callee-saved-boundary-frame","title":"2) boundary slots\uff1a\u4ece CFrame \u62f7\u8d1d callee-saved \u5230 boundary frame","text":"<p>\u8be5\u51fd\u6570\u8ba1\u7b97 <code>BOUNDARY_FRAME_SLOT</code>\uff0c\u7136\u540e\uff1a</p> <ul> <li>\u4ece cframe \u7684 callee-saved \u533a\u53d6\u503c</li> <li>\u5199\u5165 boundary frame \u56fa\u5b9a slots\uff08\u5e76\u8bbe\u7f6e CFI \u504f\u79fb\uff09</li> </ul> <p>\u8fd9\u4fdd\u8bc1 deopt \u540e StackWalker \u80fd\u5728 boundary \u4e0a\u6b63\u786e\u8bfb\u53d6 caller \u7684 callee-saved \u5feb\u7167\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#3-invokeinterpreter","title":"3) \u8c03\u7528 <code>InvokeInterpreter</code>\uff1a\u7b7e\u540d\u5bf9\u9f50\u51cf\u5c11\u53c2\u6570\u642c\u8fd0","text":"<p>\u6587\u4ef6\u6ce8\u91ca\u6307\u51fa\uff1a</p> <ul> <li><code>DeoptimizeAfterCFrame</code> \u7684\u53c2\u6570\u7b7e\u540d\u4e0e <code>InvokeInterpreter</code> \u76f8\u4f3c\uff0c\u56e0\u6b64\u53c2\u6570\u57fa\u672c\u5df2\u5c31\u4f4d\u3002</li> </ul> <p>\u5b9e\u73b0\u4e0a\uff1a</p> <ul> <li>\u4fdd\u5b58\u5c11\u91cf\u4e34\u65f6\u5bc4\u5b58\u5668</li> <li><code>movq %r8, %rcx</code>\uff08\u628a last restored IFrame \u653e\u5230 <code>InvokeInterpreter</code> \u9700\u8981\u7684\u4f4d\u7f6e\uff09</li> <li><code>callq InvokeInterpreter</code></li> <li><code>movq %rax, %xmm0</code>\uff08\u89e3\u91ca\u5668\u8fd4\u56de int64\uff0c\u4f46\u53ef\u80fd\u662f double\uff1a\u7528\u4f4d\u6a21\u5f0f\u8f6c\u79fb\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#4-deoptimizeafteriframe","title":"4) <code>DeoptimizeAfterIFrame</code>\uff08\u7b80\u8ff0\uff09","text":"<p>\u8be5\u8def\u5f84\u4e0d\u505a\u201cCFrame\u2192boundary \u53d8\u5f62\u201d\uff0c\u800c\u662f\uff1a</p> <ul> <li>\u6062\u590d <code>%rsp</code> \u5230 cframe \u7684 <code>%rbp</code></li> <li>\u6062\u590d callee-saved</li> <li><code>callq InvokeInterpreter</code></li> <li>\u8fd4\u56de\u524d\u540c\u6837 <code>movq %rax, %xmm0</code> \u517c\u5bb9\u6d6e\u70b9\u8fd4\u56de</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#5-dropcompiledframeandreturn-stackwalker","title":"5) <code>DropCompiledFrameAndReturn</code>\uff1a\u907f\u514d StackWalker \u6821\u9a8c\u5931\u8d25","text":"<p>\u8be5\u51fd\u6570\u4f1a\uff1a</p> <ul> <li>\u4ece\u88ab\u4e22\u5f03\u7684 CFrame \u6062\u590d callee-saved</li> <li>\u6e05\u7a7a <code>%rax</code>\uff08\u6ce8\u91ca\u89e3\u91ca\uff1a\u5426\u5219\u5783\u573e\u4f1a\u5199\u5230 IFrame.acc\uff0c\u5bfc\u81f4 StackWalker verification \u5931\u8d25\uff09</li> <li>\u8fd4\u56de\u5230\u4e0a\u5c42</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S/#6","title":"6) \u5bf9\u7167\u4e0e\u94fe\u63a5","text":"<ul> <li>aarch64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/aarch64/deoptimization_aarch64.S</code></li> <li><code>InvokeInterpreter</code> \u8bed\u4e49\u9aa8\u67b6\uff1a<code>runtime/bridge/bridge.cpp</code></li> <li>StackWalker/ConvertToIFrame\uff1a<code>runtime/stack_walker.cpp</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aDeopt_and_OSR\uff08Flow\uff09 + Bridge_I2C_C2I\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/","title":"<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cI2C \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 I2C\uff08Interpreter\u2192Compiled\uff09 \u6865\u63a5\uff1a\u628a\u89e3\u91ca\u5668\u4fa7\u7684 <code>(insn, Frame*, Method*, thread)</code> \u8f6c\u6210 \u771f\u5b9e SysV ABI \u7684\u53c2\u6570\u5e03\u5c40\u5e76\u8c03\u7528 compiled entrypoint\uff0c\u540c\u65f6\u6784\u9020 I2C boundary frame \u4f9b StackWalker/\u5f02\u5e38/\u53bb\u4f18\u5316\u8de8\u8fb9\u754c\u8bc6\u522b\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#1","title":"1) \u4f60\u8981\u5148\u8bb0\u4f4f\u7684\u201c\u6865\u63a5\u8f93\u5165/\u8f93\u51fa\u201d","text":"<p>\u51fd\u6570\u7b7e\u540d\uff08\u6ce8\u91ca\uff09\uff1a</p> <ul> <li><code>InterpreterToCompiledCodeBridge(insn, iframe, method, thread)</code></li> </ul> <p>\u6865\u63a5\u7684\u804c\u8d23\uff1a</p> <ul> <li>\u6784\u9020 I2C boundary frame\uff08\u538b\u5165 <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code> \u6216 <code>BYPASS_BRIDGE</code>\uff09   \u8ba9\u201c\u89e3\u91ca\u5668\u6808 \u2192 \u7f16\u8bd1\u6808\u201d\u7684\u8fb9\u754c\u5728 unwind \u65f6\u53ef\u89c1\u3002</li> <li>\u6309 shorty \u628a\u53c2\u6570\u642c\u8fd0\u5230 ABI \u7ea6\u5b9a\u4f4d\u7f6e\uff1aGPR\uff08<code>rdi..r9</code>\uff09\u3001FPR\uff08<code>xmm0..xmm7</code>\uff09\u3001\u4ee5\u53ca stack args\u3002</li> <li>\u8c03\u7528 <code>method-&gt;compiled_entrypoint</code>\uff0c\u5e76\u628a\u8fd4\u56de\u503c\u6309 shorty \u5199\u56de\u5230\u89e3\u91ca\u5668\u5e27\u7684 <code>acc</code>\uff08\u542b tagged \u7684 tag\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#2-boundary-frame-interpreter_to_compiled_code_bridgebypass_bridge","title":"2) boundary frame\uff1a\u4e3a\u4ec0\u4e48\u8981 <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE/BYPASS_BRIDGE</code>","text":"<p>\u5165\u53e3\u5904\u903b\u8f91\uff1a</p> <ul> <li>\u5148\u628a <code>iframe*</code> \u538b\u6808</li> <li>\u6839\u636e <code>MANAGED_THREAD_FRAME_KIND_OFFSET(thread)</code> \u5224\u65ad\u5f53\u524d\u662f\u5426\u5728 compiled \u4fa7\uff0c\u51b3\u5b9a\u538b\u5165\uff1a</li> <li><code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code></li> <li>\u6216 <code>BYPASS_BRIDGE</code>\uff08\u8868\u793a\u201c\u4e0d\u662f\u4f20\u7edf\u8de8\u8fb9\u754c\u201d\u7684\u8bed\u4e49\uff0cStackWalker \u9700\u8981\u7279\u6b8a\u5904\u7406\uff09</li> </ul> <p>\u8fd9\u5bf9\u5e94 Stage2 \u6587\u6863\u91cc\u7684\u6838\u5fc3\u4e0d\u53d8\u91cf\uff1aFrameKind/boundary marker \u5fc5\u987b\u53ef\u8bc6\u522b\uff0c\u5426\u5219 StackWalker \u4f1a\u8d70\u9519\u89e3\u7801\u8def\u5f84\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#3-shorty-abi","title":"3) shorty \u2192 ABI\uff1a\u53c2\u6570\u642c\u8fd0\u7684\u6838\u5fc3\u5957\u8def","text":"<p>\u672c\u6587\u4ef6\u63d0\u4f9b\u4e09\u7c7b\u5173\u952e\u5b8f\uff1a</p> <ul> <li><code>PREPARE_ARG_STACK</code>\uff1a\u626b\u63cf shorty\uff0c\u9884\u7559 stack/gpr/fpr \u4e09\u6bb5\u7a7a\u95f4\uff0c\u5e76\u4fdd\u8bc1 16-byte \u5bf9\u9f50   \u76ee\u6807\u662f\u5f97\u5230 <code>%r8</code> \u4f5c\u4e3a \u201creg args base\u201d\uff0c\u4ee5\u53ca <code>%rsp</code> \u6307\u5411 stack args \u533a\u57df\u3002</li> <li><code>PUSH_ARG</code>\uff1a\u5bf9\u5355\u4e2a\u53c2\u6570\uff0c\u6839\u636e shorty \u7c7b\u578b\u5199\u5165 gpr/fpr/stack\uff0c\u5e76\u5904\u7406 <code>any(tagged)</code> \u7684\u201cvalue+tag \u53cc\u69fd\u201d\u3002</li> <li><code>LOAD_GPR_ARGS/LOAD_FPR_ARGS</code>\uff1a\u5728 <code>.Lload_reg_args</code> \u6c47\u603b\u70b9\uff0c\u628a\u51c6\u5907\u597d\u7684 args \u771f\u6b63\u88c5\u5165\u5bc4\u5b58\u5668\uff08GPR+XMM\uff09\u3002</li> </ul> <p>\u91cd\u8981\u7ec6\u8282\uff1a</p> <ul> <li><code>Method*</code> \u88ab\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\u56fa\u5b9a\u5199\u8fdb gpr args \u533a\uff08\u6700\u7ec8\u843d\u5230 <code>%rdi</code>\uff09\u3002</li> <li>instance \u65b9\u6cd5\u7684 <code>this</code> \u4e0d\u5728 shorty \u4e2d\u7f16\u7801\uff0c\u672c\u6587\u4ef6\u4f1a\u201chack shorty\u201d\uff1a\u628a\u8fd4\u56de\u7c7b\u578b\u4f4d\u66ff\u6362\u6210 <code>REF</code> \u6765\u5360\u4f4d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#4-dispatch-include-bridge_dispatch_amd64s","title":"4) dispatch\uff1a\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4f1a <code>#include bridge_dispatch_amd64.S</code>","text":"<p>\u6865\u63a5\u9700\u8981\u77e5\u9053\u201c\u4ece\u89e3\u91ca\u5668\u5e27\u91cc\u8bfb\u54ea\u4e9b vreg/imm/id16\u201d\u6765\u7ec4\u88c5\u5b9e\u53c2\uff0c\u8fd9\u4e0e opcode format \u5f3a\u76f8\u5173\u3002</p> <ul> <li>\u8fd9\u91cc\u7684 dispatch \u4e0d\u662f\u89e3\u91ca\u5668 dispatch\uff0c\u800c\u662f call \u6307\u4ee4/\u8c03\u7528\u683c\u5f0f\u7684 dispatch\u3002</li> <li><code>#include \"bridge_dispatch_amd64.S\"</code> \u6765\u81ea\u6a21\u677f <code>runtime/templates/bridge_dispatch.S.erb</code>\uff0c\u5e76\u8fdb\u4e00\u6b65\u8df3\u5230   <code>handle_call_&lt;format&gt;.S</code> \u8fd9\u4e9b\u5b9e\u73b0\u6587\u4ef6\uff08\u672c\u76ee\u5f55\u4e0b\u53ef\u89c1\uff09\u3002</li> </ul> <p>\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u65b0\u5f15\u5165 call format \u65f6\u53ef\u80fd\u7f16\u8bd1\u5931\u8d25\uff1a\u63d0\u793a\u4f60\u7f3a\u5c11\u5bf9\u5e94 <code>handle_call_*</code> \u5904\u7406\u5668\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#5-invoke","title":"5) invoke + \u8fd4\u56de\u503c\u5199\u56de","text":"<p>\u5173\u952e\u70b9\uff1a</p> <ul> <li>\u8c03\u7528\uff1a<code>mov METHOD_COMPILED_ENTRY_POINT_OFFSET(%rdi), %rax; callq *%rax</code></li> <li>\u8fd4\u56de\u503c\uff1a</li> <li>\u4f9d\u636e <code>shorty[0] &amp; 0xF</code> \u5224\u65ad\u8fd4\u56de\u7c7b\u578b</li> <li><code>void</code>\uff1a\u4e0d\u5199\u56de</li> <li><code>float/double</code>\uff1a\u4ece <code>%xmm0</code> \u83b7\u53d6</li> <li><code>tagged(any)</code>\uff1avalue \u5728 <code>%rax</code>\uff0ctag \u5728 <code>%rdx</code>\uff08\u6216\u6309\u5206\u652f\u6784\u9020\uff09\uff0c\u5199\u56de <code>frame-&gt;acc</code>\uff08\u4ee5\u53ca mirror/tag\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S/#6","title":"6) \u4e0e\u672c\u7ae0\u5176\u4ed6\u8bc1\u636e\u7684\u8fde\u63a5\u70b9","text":"<ul> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> <li>FrameKind/\u8fb9\u754c\u8bed\u4e49\uff1aBridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> <li>C++ \u9aa8\u67b6\u4e0e acc \u5199\u56de\u8bed\u4e49\uff1aruntime_bridge_bridge.cpp\uff08FileNotes\uff09</li> <li>\u76f8\u5173\u751f\u6210\u6587\u4ef6\uff08call-format dispatch\uff09\uff1a</li> <li>\u6a21\u677f\uff1a<code>runtime/templates/bridge_dispatch.S.erb</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_templates_bridge_dispatch.S.erb.md</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S/","title":"<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_dyn_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cI2C(Dyn) \u7269\u7406\u843d\u5730\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 I2C\uff08Dynamic calling convention\uff09\uff1a\u4e3a\u52a8\u6001\u8bed\u8a00/TaggedValue \u8bed\u4e49\u63d0\u4f9b\u89e3\u91ca\u5668\u2192\u7f16\u8bd1\u6865\u63a5\u3002\u5165\u53e3\u4ecd\u662f <code>(insn, iframe, method, thread)</code>\uff0c\u4f1a\u5199\u5165 <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE/BYPASS_BRIDGE</code> marker\uff0c\u5e76\u901a\u8fc7 <code>bridge_dispatch_dyn_amd64.S</code>\uff08\u6a21\u677f\u751f\u6210\uff09\u6309 opcode format \u7ec4\u88c5\u53c2\u6570\uff0c\u8c03\u7528 <code>method-&gt;compiled_entrypoint</code>\uff0c\u6700\u540e\u628a\u8fd4\u56de\u503c\u5199\u56de <code>frame-&gt;acc</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S/#1-boundary-marker","title":"1) boundary marker \u89c4\u5219\u4e0e\u9759\u6001\u7248\u4e00\u81f4","text":"<p>\u5165\u53e3\u6839\u636e <code>MANAGED_THREAD_FRAME_KIND_OFFSET(thread)</code>\uff1a</p> <ul> <li>\u9ed8\u8ba4\u5199 <code>INTERPRETER_TO_COMPILED_CODE_BRIDGE</code></li> <li>\u82e5 caller \u5728 compiled \u4fa7\u5219\u5199 <code>BYPASS_BRIDGE</code></li> </ul> <p>\u76ee\u7684\uff1a\u8ba9 StackWalker \u80fd\u5728 IFrame/CFrame \u4e24\u5957\u89e3\u7801\u89c4\u5219\u4e4b\u95f4\u6b63\u786e\u5207\u6362\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S/#2-dyn-dispatchbridge_dispatch_dyn_amd64s","title":"2) dyn dispatch\uff1a<code>bridge_dispatch_dyn_amd64.S</code>","text":"<p>\u8be5\u6587\u4ef6\u8bfb\u53d6 opcode\uff08\u542b prefix opcode\uff09\u5e76\uff1a</p> <ul> <li><code>#include \"bridge_dispatch_dyn_amd64.S\"</code></li> <li>\u6ce8\u91ca\u660e\u786e\uff1a\u7531 <code>runtime/templates/bridge_dispatch.S.erb</code> \u751f\u6210\uff0c\u5e76\u4f9d\u8d56 <code>handle_call_&lt;format&gt;.S</code></li> </ul> <p>\u8fd9\u6761\u8bc1\u636e\u94fe\u5f88\u5b9e\u7528\uff1a\u65b0\u589e call format \u65f6\uff0c\u7f3a handler \u4f1a\u5728\u8fd9\u91cc\u66b4\u9732\u4e3a\u7f16\u8bd1\u9519\u8bef\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S/#3-compiled-entrypoint-acc","title":"3) \u8c03\u7528 compiled entrypoint \u4e0e\u5199\u56de acc","text":"<ul> <li>\u8c03\u7528\uff1a<code>movq METHOD_COMPILED_ENTRY_POINT_OFFSET(%rdi), %rax ; callq *%rax</code></li> <li>\u5199\u56de\uff1a<code>movq %rax, (frame-&gt;acc)</code>\uff08\u6587\u4ef6\u4e2d <code>movq %rax, (%r12)</code>\uff09</li> </ul> <p>dyn \u7248\u4e0d\u4ee5 shorty \u51b3\u5b9a\u8fd4\u56de\u7c7b\u578b\u5bc4\u5b58\u5668\uff08\u7edf\u4e00\u8d70 TaggedValue \u8bed\u4e49\uff1avalue+tag\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S/#4","title":"4) \u5bf9\u7167\u4e0e\u94fe\u63a5","text":"<ul> <li>\u9759\u6001 I2C\uff08shorty \u9a71\u52a8\uff09\u5bf9\u7167\uff1a<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_amd64.S</code></li> <li>dyn C2I\uff08\u914d\u5957\u56de\u9000\u8def\u5f84\uff09\uff1a<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_dyn_amd64.S</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/","title":"<code>runtime/bridge/arch/amd64/proxy_entrypoint_amd64.S</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cproxy entrypoint / \u5f02\u5e38\u6865\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1aamd64 \u4e0a\u7684 proxy entrypoint\uff1a\u4ee5\u7edf\u4e00 ABI \u5305\u88f9\u771f\u5b9e <code>\\entry</code>\uff0c\u5fc5\u8981\u65f6\u6784\u9020 <code>COMPILED_CODE_TO_INTERPRETER_BRIDGE</code> boundary frame \u5e76\u5199 TLS\uff1b\u8fd4\u56de\u8def\u5f84\u8d1f\u8d23\u201cnative \u5f02\u5e38 \u2192 ThrowNativeExceptionBridge\u201d\u7684\u5bc4\u5b58\u5668\u6062\u590d\u4e0e\u8df3\u8f6c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#1-proxy","title":"1) proxy \u7684\u6838\u5fc3\u4ef7\u503c","text":"<ul> <li>\u7edf\u4e00\u5165\u53e3 ABI\uff1a\u4e0a\u5c42\u53ef\u7a33\u5b9a\u8c03\u7528 proxy\uff0cproxy \u518d\u8c03\u7528\u771f\u5b9e <code>\\entry</code>\uff08\u7b2c\u4e8c\u9636\u6bb5/slowpath \u5165\u53e3\u70b9\u5e38\u89c1\uff09</li> <li>\u5f02\u5e38/\u6808\u904d\u5386\u6b63\u786e\u6027\uff1a\u8de8\u8fb9\u754c\u65f6\u9700\u8981 boundary frame + callee-saved \u53ef\u89c1\uff0c\u4e14\u5f02\u5e38\u8def\u5f84\u5fc5\u987b\u6062\u590d caller \u7684\u5bc4\u5b58\u5668\u5feb\u7167</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#2-boundary-frame-callee-saved","title":"2) \u6784\u9020 boundary frame + \u4fdd\u5b58 callee-saved","text":"<p>\u5b8f <code>PROXY_ENTRYPOINT name, entry</code> \u505a\u4e86\u5178\u578b C2I frame \u5f62\u6001\uff1a</p> <ul> <li><code>pushq $COMPILED_CODE_TO_INTERPRETER_BRIDGE</code></li> <li><code>pushq %rbp ; movq %rsp, %rbp</code></li> <li>\u4fdd\u5b58 callee-saved\uff1a<code>r15 r14 r13 r12 rbx</code>\uff08\u914d CFI\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#3-caller-compiled-tls","title":"3) \u4ec5\u5f53 caller \u4e3a compiled \u65f6\u5199 TLS","text":"<p>\u5173\u952e\u903b\u8f91\uff1a</p> <ul> <li>\u8bfb <code>MANAGED_THREAD_FRAME_KIND_OFFSET(%THREAD_REG)</code> \u5230 <code>%r12b</code></li> <li>\u82e5\u4e3a compiled\uff08\u975e 0\uff09\uff0c\u624d <code>movq %rbp, MANAGED_THREAD_FRAME_OFFSET(%THREAD_REG)</code></li> </ul> <p>\u610f\u4e49\uff1a\u907f\u514d\u5728\u89e3\u91ca\u5668\u8c03\u7528 proxy \u65f6\u7834\u574f \u201cthread-&gt;currentFrame \u6307\u5411 Frame* \u94fe\u201d \u7684\u8bed\u4e49\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#4-entry","title":"4) \u53c2\u6570\u900f\u4f20\uff1a\u628a\u5bc4\u5b58\u5668\u53c2\u6570\u53d8\u6210\u6570\u7ec4\u4f20\u7ed9 <code>\\entry</code>","text":"<p>\u8be5\u6587\u4ef6\u5148\u6267\u884c\uff1a</p> <ul> <li><code>PUSH_FP_REGS</code>\u3001<code>PUSH_GENERAL_REGS</code></li> </ul> <p>\u968f\u540e\u7ea6\u5b9a\uff1a</p> <ul> <li><code>%rsi = %rsp</code>\uff1a\u6307\u5411\u201c\u5df2\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u53c2\u6570\u6570\u7ec4\u201d</li> <li><code>%rdx = rbp + 24</code>\uff1a\u6307\u5411 stack args \u533a\uff08\u7531 i2c \u5148\u538b\u6808\u7684 stack args\uff09</li> <li><code>callq \\entry</code></li> </ul> <p>\u8fd9\u5141\u8bb8 <code>\\entry</code> \u4ee5\u7edf\u4e00\u65b9\u5f0f\u8bfb\u53d6\u201c\u5bc4\u5b58\u5668\u53c2\u6570 + \u6808\u53c2\u6570\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#5-thrownativeexceptionbridge","title":"5) \u8fd4\u56de\u8def\u5f84\uff1a\u5f02\u5e38\u68c0\u6d4b\u4e0e ThrowNativeExceptionBridge","text":"<p>\u8fd4\u56de\u524d\u4f1a\u6062\u590d callee-saved\uff08\u6ce8\u91ca\u5f3a\u8c03\uff1aGC \u53ef\u80fd\u79fb\u52a8\u5bf9\u8c61\u5bfc\u81f4\u5bc4\u5b58\u5668\u5185\u5bb9\u53d8\u5316\uff0c\u6240\u4ee5\u8981\u4ece\u6808\u6062\u590d\uff09\u3002</p> <p>\u968f\u540e\u6267\u884c\u5f02\u5e38\u5206\u652f\u5224\u65ad\uff1a</p> <ul> <li><code>thread-&gt;exception != 0</code>\uff08<code>MANAGED_THREAD_EXCEPTION_OFFSET</code>\uff09</li> <li><code>caller is compiled</code>\uff08<code>%r10b</code>\uff09</li> <li><code>prev frame \u4e0d\u662f BYPASS</code>\uff08\u68c0\u67e5 <code>COMP_METHOD_OFFSET</code> \u69fd\uff09</li> </ul> <p>\u5982\u679c\u6ee1\u8db3\uff1a</p> <ul> <li>\u4ece boundary frame \u533a\u6062\u590d caller \u7684 GPR\uff08\u4ee5\u53ca\u5728 flags \u6307\u793a\u4e0b\u6062\u590d caller \u7684 XMM0-XMM15\uff09</li> <li><code>jmp ThrowNativeExceptionBridge</code></li> </ul> <p>\u8fd9\u662f\u201cnative \u5f02\u5e38\u5411\u4e0a\u629b\u51fa\u201d\u8def\u5f84\u7684\u786c\u8bc1\u636e\uff1a\u6ca1\u6709\u8fd9\u4e00\u6bb5\uff0c\u5f02\u5e38 unwind \u4f1a\u56e0\u5bc4\u5b58\u5668/\u6808\u72b6\u6001\u4e0d\u5b8c\u6574\u800c\u5931\u8d25\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S/#6","title":"6) \u5bf9\u7167\u4e0e\u94fe\u63a5","text":"<ul> <li>aarch64 \u5bf9\u7167\u5b9e\u73b0\uff1a<code>runtime/bridge/arch/aarch64/proxy_entrypoint_aarch64.S</code></li> <li>deopt \u53d8\u5f62\u4e0e boundary slots\uff1a<code>runtime/bridge/arch/*/deoptimization_*.S</code></li> <li>\u6982\u5ff5/\u903b\u8f91\uff1aBridge_I2C_C2I\uff08Flow\uff09 + Bridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/","title":"<code>runtime/bridge/bridge.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a154 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u63d0\u4f9b C++ \u5c42\u7684\u6865\u63a5\u201c\u8bed\u4e49\u9aa8\u67b6\u201d\uff1a\u9009\u62e9 C2I stub\u3001\u4ee5\u53ca <code>InvokeInterpreter</code>\uff08\u901a\u5e38\u7531 deopt \u8def\u5f84\u8c03\u7528\uff09\u5982\u4f55\u56de\u5230\u89e3\u91ca\u5668\u5e76\u53d6\u56de\u7ed3\u679c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#invokeinterpreter","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aInvokeInterpreter \u7684\u8bed\u4e49\u9aa8\u67b6","text":"<pre><code>sequenceDiagram\n  participant DO as Deopt/Runtime\n  participant BR as bridge.cpp\n  participant TH as ManagedThread\n  participant INT as interpreter::Execute\n  participant FR as Frame\n\n  DO-&gt;&gt;BR: InvokeInterpreter(thread, pc, frame, lastFrame)\n  BR-&gt;&gt;TH: SetCurrentFrame(frame)\\nSetCurrentFrameIsCompiled(false)\n  BR-&gt;&gt;INT: Execute(thread, pc, frame, pendingException?)\n  INT--&gt;&gt;BR: \u89e3\u91ca\u6267\u884c\u7ed3\u675f\uff08return/throw\uff09\n  BR-&gt;&gt;FR: \u8bfb acc\uff08\u9759\u6001/\u52a8\u6001\u5206\u652f\uff09\\n\u5f97\u5230 res\n  BR-&gt;&gt;TH: SetCurrentFrame(prevFrame)\\n\u6062\u590d\u7f16\u8bd1/\u89e3\u91ca\u6807\u8bb0\n  BR-&gt;&gt;BR: FreeFrame(frame)\\n\u5fc5\u8981\u65f6\u5faa\u73af\u6267\u884c inlined frames\n  BR--&gt;&gt;DO: return res</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#0-includes-l16l27","title":"0. includes \u4e0e\u4f9d\u8d56\uff08L16\u2013L27\uff09","text":"<ul> <li>L20\uff1a<code>interpreter/acc_vregister.h</code>\uff1a\u7528\u4e8e\u8bfb\u53d6 <code>Frame::GetAcc()</code> \u5e76\u62ff\u5230 vreg-ref\uff08\u9759\u6001/\u52a8\u6001\u4e0d\u540c\uff09\u3002</li> <li>L21\uff1a<code>runtime/entrypoints/entrypoints.h</code>\uff1a\u6865\u63a5\u8fb9\u754c\u7ecf\u5e38\u4e0e\u8fd0\u884c\u65f6\u5165\u53e3\u4ea4\u7ec7\uff08\u672c\u6587\u4ef6\u53ea\u5f15\u5165\uff0c\u4f46\u5728\u5176\u4ed6\u6865\u63a5\u5b9e\u73b0/\u6162\u8def\u5f84\u91cc\u4e5f\u7ecf\u5e38\u4f1a\u7528\u5230\uff09\u3002</li> <li>L24\uff1a<code>runtime/interpreter/interpreter.h</code>\uff1a<code>InvokeInterpreter</code> \u8c03\u7528 <code>interpreter::Execute</code>\u3002</li> <li>L25\u2013L26\uff1abytecode instruction\uff1a\u4e3a INITOBJ \u7279\u5224\u63d0\u4f9b opcode \u5224\u5b9a\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#1-c2i-stubgetcompiledcodetointerpreterbridgel30l45","title":"1. \u9009\u62e9 C2I stub\uff1a<code>GetCompiledCodeToInterpreterBridge</code>\uff08L30\u2013L45\uff09","text":"<ul> <li>L35\u2013L43\uff1a\u6309\u201c\u662f\u5426\u52a8\u6001\u8bed\u8a00\u201d\u9009\u62e9 <code>CompiledCodeToInterpreterBridge</code> vs <code>...Dyn</code>\uff1a</li> <li>\u82e5 <code>method-&gt;GetClass()==nullptr</code>\uff0c\u76f4\u63a5\u8ba4\u4e3a dynamic\uff08\u52a8\u6001\u65b9\u6cd5\u53ef\u65e0 class\uff09\u3002</li> <li>\u5426\u5219\u68c0\u67e5 <code>method-&gt;GetClass()-&gt;GetSourceLang()</code> \u662f\u5426 dynamic language\u3002</li> </ul> <p>\u8fd9\u6761\u903b\u8f91\u4e0e <code>StackWalker::IsDynamicMethod()</code>\uff08\u89c1 <code>runtime/stack_walker.cpp</code>\uff09\u5728\u8bed\u4e49\u4e0a\u5e94\u4fdd\u6301\u4e00\u81f4\uff1a\u52a8\u6001\u8bed\u8a00\u8def\u5f84\u7684\u6808\u5e03\u5c40/\u8fd4\u56de\u503c/\u5bc4\u5b58\u5668\u8bed\u4e49\u53ef\u80fd\u4e0d\u540c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#2-accvreg-getvregvaluel57l61","title":"2. acc/vreg \u7edf\u4e00\u53d6\u503c\uff1a<code>GetVRegValue</code>\uff08L57\u2013L61\uff09","text":"<ul> <li>L60\uff1a\u82e5 vreg \u6709\u5bf9\u8c61\uff08<code>HasObject()</code>\uff09\u5219\u628a\u5f15\u7528\u5730\u5740\u8f6c\u6210\u6574\u6570\uff1b\u5426\u5219\u53d6 long \u503c\u3002   \u7528\u9014\uff1a\u628a\u201cacc \u7684\u503c\u201d\u5f52\u4e00\u5230 <code>int64_t</code> \u4f5c\u4e3a <code>InvokeInterpreter</code> \u7684\u8fd4\u56de\u503c\uff08\u4fbf\u4e8e C ABI \u8fd4\u56de\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#3-deopt-invokeinterpretercheckparamsl68l96","title":"3. deopt \u5165\u53e3\u9aa8\u67b6\uff1a<code>InvokeInterpreterCheckParams</code>\uff08L68\u2013L96\uff09","text":"<p>\u6ce8\u91ca L63\u2013L66 \u660e\u786e\u6307\u51fa\uff1a\u8be5\u51fd\u6570\u201csupposed to be called from the deoptimization code\u201d\uff0c\u5e76\u4e14\u4f1a\u5728\u9000\u51fa\u65f6\u91ca\u653e\u8f93\u5165 frame\u3002</p> <p>\u9010\u884c\u8981\u70b9\uff1a - L76\u2013L78\uff1a\u4fdd\u5b58\u5e76\u5207\u6362\u5f53\u524d\u7ebf\u7a0b\u7684\u201c\u5e27\u7c7b\u578b\u201d\uff1a   - <code>prevFrameKind = thread-&gt;IsCurrentFrameCompiled()</code>   - <code>thread-&gt;SetCurrentFrame(frame)</code>   - <code>thread-&gt;SetCurrentFrameIsCompiled(false)</code>\uff1a\u663e\u5f0f\u5207\u5230\u89e3\u91ca\u5668\u5e27\u8bed\u4e49 - L81\uff1a\u8c03\u7528 <code>interpreter::Execute(thread, pc, frame, thread-&gt;HasPendingException())</code>   \u7b2c\u56db\u53c2\u628a\u201c\u662f\u5426\u5df2\u6709 pending exception\u201d\u4f20\u5165\u89e3\u91ca\u5668\uff0c\u5f71\u54cd\u89e3\u91ca\u5668\u5982\u4f55\u8fdb\u5165\u5f02\u5e38\u8def\u5f84\u3002 - L84\u2013L89\uff1a\u4ece <code>frame-&gt;GetAcc()</code> \u8bfb\u53d6\u7ed3\u679c\u5e76\u5f52\u4e00\u5316\uff1a   - dynamic\uff1a<code>acc.AsVRegRef&lt;true&gt;()</code>   - static\uff1a<code>acc.AsVRegRef()</code> - L91\u2013L94\uff1a\u6062\u590d thread \u5f53\u524d\u5e27\u5230 <code>prevFrame</code>\uff0c\u91ca\u653e\u672c\u6b21\u6267\u884c\u7684 <code>frame</code>\u3002 - L95\uff1a\u8fd4\u56de <code>(prevFrameKind, res, prevFrame, acc)</code>\uff0c\u7ed9\u5916\u5c42\u5faa\u73af\u7ee7\u7eed\u7528\uff08\u5c24\u5176\u662f <code>acc</code> \u9700\u8981\u5728\u201c\u627e catch/\u5185\u8054\u5e27\u201d\u65f6\u4f20\u64ad\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#4-invokeinterpreter-catchfreeframe-l98l143","title":"4. <code>InvokeInterpreter</code> \u4e3b\u4f53\uff1a\u5904\u7406\u201c\u5185\u8054\u5e27/\u627e catch/FreeFrame \u987a\u5e8f\u201d\uff08L98\u2013L143\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#41-framel100","title":"4.1 \u7b2c\u4e00\u6bb5\uff1a\u6267\u884c\u76ee\u6807 frame\uff08L100\uff09","text":"<ul> <li>L100\uff1a\u5148\u6267\u884c <code>InvokeInterpreterCheckParams</code>\uff0c\u5f97\u5230\u9996\u6b21\u6267\u884c\u7684 <code>res/acc/prevFrame</code> \u7b49\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#42-inlined-framesl102l139","title":"4.2 \u7b2c\u4e8c\u6bb5\uff1a\u5faa\u73af\u6267\u884c inlined frames\uff08L102\u2013L139\uff09","text":"<p>\u6ce8\u91ca\uff08L102\u2013L104\uff09\u7ed9\u51fa\u5173\u952e\u52a8\u673a\uff1a - \u4e3a\u4e86\u201cfind catch block\u201d\uff0c\u9700\u8981\u5728\u6240\u6709 inlined methods \u4e0a\u6267\u884c\u3002 - \u5426\u5219\u4f1a\u6267\u884c\u5230\u66f4\u65e9\u7684 interpreter frames\uff0c\u5bfc\u81f4 <code>FreeFrame</code> \u987a\u5e8f\u4e0d\u6b63\u786e\u3002</p> <p>\u5faa\u73af\u6761\u4ef6\uff08L104\uff09\uff1a - <code>prevFrame != nullptr &amp;&amp; lastFrame != frame</code>   \u5176\u4e2d <code>lastFrame</code> \u7528\u4e8e\u63a7\u5236\u201c\u6700\u591a unwind \u5230\u54ea\u91cc\u201d\uff08\u8c03\u7528\u65b9\u63d0\u4f9b\u7684\u8fb9\u754c\uff09\u3002</p> <p>\u5faa\u73af\u4f53\u5173\u952e\u70b9\uff1a - L105\uff1a\u65ad\u8a00 <code>prevFrame</code> \u4e0d\u662f\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\uff08\u907f\u514d\u628a boundary \u5f53\u666e\u901a iframe \u6267\u884c\uff09\u3002 - L110\uff1a\u4ece <code>frame-&gt;GetMethod()-&gt;GetInstructions() + frame-&gt;GetBytecodeOffset()</code> \u6062\u590d pc\u3002 - L112\u2013L127\uff1a\u82e5\u65e0 pending exception\uff0c\u5219 decode \u5f53\u524d bytecode\uff1a   - L115\u2013L120\uff1aINITOBJ \u7279\u5224\uff08\u5173\u952e\uff01\uff09     - \u6ce8\u91ca\u89e3\u91ca\uff1a\u7f16\u8bd1\u5668\u53ef\u80fd\u628a <code>InitObj</code> \u62c6\u4e3a <code>NewObject + CallStatic</code>\u3002     - \u82e5 deopt \u53d1\u751f\u5728 <code>CallStatic</code>\uff0cacc \u91cc\u53ef\u80fd\u4ecd\u4fdd\u7559 <code>NewObject</code> \u7684\u7ed3\u679c\uff1b\u6b64\u65f6\u4e0d\u80fd\u88ab <code>CallStatic</code> \u7684 acc \u8986\u76d6\u3002   - L123\uff1a\u628a pc \u66f4\u65b0\u5230 <code>next</code> \u6307\u4ee4\u5730\u5740\uff0c\u4ee5\u4fbf\u7ee7\u7eed\u6267\u884c\u3002   - \u82e5\u6709 pending exception\uff08L125\u2013L127\uff09\uff0c\u5219\u76f4\u63a5\u5199\u56de <code>acc</code>\u3002 - L128\uff1a\u518d\u6b21\u6267\u884c <code>interpreter::Execute(...)</code>\u3002 - L130\u2013L135\uff1a\u66f4\u65b0 <code>acc/res</code>\uff08\u9759\u6001/\u52a8\u6001\u5206\u652f\u540c\u524d\uff09\u3002 - L137\u2013L139\uff1a<code>thread-&gt;SetCurrentFrame(prevFrame)</code> \u5e76 <code>FreeFrame(frame)</code>\uff0c\u4fdd\u8bc1\u91ca\u653e\u987a\u5e8f\u4e0e\u201c\u9010\u5e27 unwind\u201d\u4e00\u81f4\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#43-l140l142","title":"4.3 \u6536\u5c3e\uff1a\u6062\u590d\u5e27\u7c7b\u578b\u5e76\u8fd4\u56de\uff08L140\u2013L142\uff09","text":"<ul> <li>L140\uff1a<code>thread-&gt;SetCurrentFrameIsCompiled(prevFrameKind)</code>\uff1a\u6062\u590d deopt \u8fdb\u5165\u524d\u7684\u201c\u5f53\u524d\u5e27\u662f\u7f16\u8bd1/\u89e3\u91ca\u5668\u201d\u7684\u6807\u8bb0\u3002</li> <li>L142\uff1a\u8fd4\u56de <code>res</code>\uff08\u6765\u81ea\u6700\u540e\u4e00\u6b21\u89e3\u91ca\u6267\u884c\u540e\u7684 acc\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#5-stub-l145l153","title":"5. \u4e24\u4e2a stub \u5730\u5740\u63a5\u53e3\uff08L145\u2013L153\uff09","text":"<ul> <li><code>GetAbstractMethodStub()</code> / <code>GetDefaultConflictMethodStub()</code>\uff1a\u8fd4\u56de\u5bf9\u5e94 stub \u7684\u51fd\u6570\u5730\u5740\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.cpp/#_1","title":"\u672c\u6587\u4ef6\u5bf9\u6392\u969c\u6700\u6709\u4ef7\u503c\u7684\u201c\u65ad\u8a00\u4e0e\u4fe1\u53f7\u201d","text":"<ul> <li>FrameKind \u5207\u6362\uff1a<code>SetCurrentFrameIsCompiled(false/prev)</code> \u5fc5\u987b\u6210\u5bf9\u51fa\u73b0\uff0c\u5426\u5219 StackWalker/\u5f02\u5e38 unwind \u4f1a\u5931\u771f\u3002</li> <li>INITOBJ \u7279\u5224\uff1a\u82e5\u770b\u5230\u201c\u6784\u9020\u5bf9\u8c61 + \u8c03\u7528\u6784\u9020\u51fd\u6570\u201d\u76f8\u5173 deopt \u8bed\u4e49\u9519\u8bef\uff0c\u4f18\u5148\u770b\u8fd9\u6bb5\u903b\u8f91\u3002</li> <li>FreeFrame \u987a\u5e8f\uff1a\u672c\u6587\u4ef6\u660e\u786e\u5f3a\u8c03\u201c\u91ca\u653e\u987a\u5e8f\u9519\u8bef\u4f1a\u51fa\u5927\u95ee\u9898\u201d\uff0c\u56e0\u6b64\u4efb\u4f55\u4fee\u6539\u90fd\u8981\u8c28\u614e\u9a8c\u8bc1 unwind \u8def\u5f84\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/","title":"<code>runtime/bridge/bridge.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a52 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e\u89e3\u91ca\u5668\u2194\u7f16\u8bd1\u4ee3\u7801\u4e92\u8c03\u7684 ABI\uff08I2C/C2I\uff09\uff0c\u5e76\u63d0\u4f9b\u82e5\u5e72\u201c\u6865\u63a5/\u6869\u51fd\u6570\u201d\u6307\u9488\u83b7\u53d6\u63a5\u53e3\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/#0-l16l27","title":"0. \u5934\u6587\u4ef6\u7ed3\u6784\uff08L16\u2013L27\uff09","text":"<ul> <li>L16\u2013L17\uff1ainclude guard\u3002</li> <li>L19\u2013L20\uff1a\u53ea\u5f15\u5165\u57fa\u7840\u7c7b\u578b\u4e0e\u5bfc\u51fa\u5b8f\uff08<code>PANDA_PUBLIC_API</code>\uff09\uff0c\u8fd9\u662f\u5178\u578b\u7684\u201cABI \u58f0\u660e\u5934\u201d\u98ce\u683c\uff1a\u4e0d\u628a\u91cd\u4f9d\u8d56\u5f15\u5165\u5230\u6240\u6709\u8c03\u7528\u70b9\u3002</li> <li>L24\u2013L26\uff1a\u524d\u7f6e\u58f0\u660e <code>Method</code>/<code>Frame</code>/<code>ManagedThread</code>\uff0c\u5f3a\u8c03\uff1a\u6865\u63a5\u51fd\u6570\u7b7e\u540d\u8de8\u6a21\u5757\u4f7f\u7528\uff0c\u9700\u8981\u4fdd\u6301\u7a33\u5b9a\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/#1-i2cinterpreter-compiledl28l33","title":"1. I2C\uff1aInterpreter \u2192 Compiled\uff08L28\u2013L33\uff09","text":"<ul> <li>L28\u2013L29\uff1a<code>InterpreterToCompiledCodeBridge</code> / <code>InterpreterToCompiledCodeBridgeDyn</code> </li> <li><code>extern \"C\"</code>\uff1a\u907f\u514d C++ name mangling\uff0c\u4f7f\u6c47\u7f16/\u4ee3\u7801\u751f\u6210\u80fd\u7528\u56fa\u5b9a\u7b26\u53f7\u540d\u94fe\u63a5\u3002</li> <li><code>Dyn</code> \u7248\u672c\u7528\u4e8e\u52a8\u6001\u8bed\u8a00\uff08\u6216 method/class \u4fe1\u606f\u4e0d\u5b8c\u5907\u7684\u573a\u666f\uff09\uff0c\u5176\u8fd4\u56de\u503c/\u53c2\u6570\u7ea6\u5b9a\u53ef\u80fd\u4e0d\u540c\uff08\u8be6\u89c1 <code>bridge.cpp</code> \u4e2d\u5bf9 dynamic \u7684\u5206\u652f\uff0c\u4ee5\u53ca <code>StackWalker::IsDynamicMethod</code> \u7684\u5224\u5b9a\uff09\u3002</li> <li>L30\u2013L32\uff1a<code>InvokeCompiledCodeWithArgArray*</code> </li> <li>\u8fd9\u7ec4\u66f4\u50cf\u201c\u901a\u7528\u8c03\u7528\u5165\u53e3\u201d\uff1a\u7528\u53c2\u6570\u6570\u7ec4\u8c03\u7528 compiled code\uff08\u9759\u6001\u7248\u7528 <code>int64_t*</code>\uff0c\u52a8\u6001\u7248\u7528 <code>uint64_t*</code> + <code>argc</code>\uff09\u3002</li> <li>\u5178\u578b\u7528\u9014\uff1a\u4ece\u89e3\u91ca\u5668/\u8fd0\u884c\u65f6\u8f85\u52a9\u8def\u5f84\uff08\u6216\u67d0\u4e9b stub\uff09\u4ee5\u7edf\u4e00\u65b9\u5f0f\u8c03\u7528\u5df2\u7f16\u8bd1\u5165\u53e3\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/#2-c2icompiled-interpreterl34l37","title":"2. C2I\uff1aCompiled \u2192 Interpreter\uff08L34\u2013L37\uff09","text":"<ul> <li>L34\uff1a<code>InvokeInterpreter(thread, pc, frame, lastFrame)</code> </li> <li>\u8fd9\u662f\u201c\u4ece\u7f16\u8bd1\u6001\u56de\u89e3\u91ca\u5668\u7ee7\u7eed\u6267\u884c\u201d\u7684 C++ \u9aa8\u67b6\u5165\u53e3\uff0c<code>bridge.cpp</code> \u91cc\u4f1a\u8d1f\u8d23\uff1a<ul> <li>\u5207\u6362 <code>thread</code> \u5f53\u524d\u5e27 &amp; FrameKind\uff08<code>IsCurrentFrameCompiled=false</code>\uff09</li> <li>\u8c03 <code>interpreter::Execute(...)</code></li> <li>\u4ece <code>acc</code> \u53d6\u56de\u8fd4\u56de\u503c\uff08\u9759\u6001/\u52a8\u6001\u5206\u652f\u4e0d\u540c\uff09</li> <li><code>FreeFrame(frame)</code>\uff0c\u5e76\u5904\u7406\u201c\u5185\u8054\u5e27/\u627e catch\u201d\u76f8\u5173\u5faa\u73af</li> </ul> </li> <li>L36\u2013L37\uff1a<code>CompiledCodeToInterpreterBridge*</code> </li> <li>\u8fd9\u4e24\u4e2a\u662f \u6c47\u7f16\u5c42\u9762\u7684\u201c\u8fb9\u754c\u5e27 stub\u201d\uff08\u771f\u6b63\u7684\u5165\u53e3\u7b26\u53f7\uff09\uff0c<code>GetCompiledCodeToInterpreterBridge*</code> \u4f1a\u8fd4\u56de\u5b83\u4eec\u7684\u5730\u5740\uff0c\u7528\u4e8e\u5199\u5165 method \u7684 entrypoint \u6216\u5728\u6808\u904d\u5386\u65f6\u8bc6\u522b\u8fb9\u754c\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/#3-l38l40","title":"3. \u5176\u5b83\u6869\u51fd\u6570\uff08L38\u2013L40\uff09","text":"<ul> <li>L38\uff1a<code>AbstractMethodStub()</code>\uff1a\u62bd\u8c61\u65b9\u6cd5\u8c03\u7528\u65f6\u7684\u7edf\u4e00\u5931\u8d25\u8def\u5f84\uff08\u901a\u5e38\u629b\u5f02\u5e38/\u89e6\u53d1 abort\uff09\u3002</li> <li>L39\uff1a<code>DefaultConflictMethodStub()</code>\uff1a\u9ed8\u8ba4\u63a5\u53e3\u65b9\u6cd5\u51b2\u7a81\uff0803 \u7ae0 IMT/ITable \u51b2\u7a81\u8bed\u4e49\u7684\u6267\u884c\u4fa7\u843d\u70b9\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_bridge_bridge.h/#4-l41l49","title":"4. \u201c\u53d6\u5730\u5740\u201d\u63a5\u53e3\uff08L41\u2013L49\uff09","text":"<ul> <li>L41\uff1a<code>GetCompiledCodeToInterpreterBridge(const Method *method)</code> </li> <li>\u4f9d\u636e <code>method</code> \u662f\u5426\u52a8\u6001\u8bed\u8a00\u8fd4\u56de <code>CompiledCodeToInterpreterBridge</code> \u6216 <code>...Dyn</code>\u3002</li> <li>L43\u2013L46\uff1a\u65e0\u53c2\u7248\u672c\u76f4\u63a5\u8fd4\u56de\u9759\u6001/\u52a8\u6001\u7684 stub \u5730\u5740\u3002</li> <li>L47\u2013L49\uff1a\u8fd4\u56de\u62bd\u8c61\u65b9\u6cd5/\u51b2\u7a81\u65b9\u6cd5 stub \u5730\u5740\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a<code>bridge.h</code> \u7684\u8bbe\u8ba1\u6838\u5fc3\u662f\u201c\u7a33\u5b9a ABI + \u53ef\u6309\u8bed\u8a00/\u6a21\u5f0f\u9009\u62e9\u4e0d\u540c\u8fb9\u754c stub\u201d\uff0c\u4ee5\u652f\u6491\u89e3\u91ca\u5668/\u7f16\u8bd1\u5668/\u6c47\u7f16\u6865/\u6808\u904d\u5386\u5bf9\u540c\u4e00\u8fb9\u754c\u7684\u5171\u8bc6\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/","title":"<code>runtime/compiler.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a1183 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>PandaRuntimeInterface</code> \u7684\u5927\u91cf\u67e5\u8be2\u903b\u8f91\uff0c\u4ee5\u53ca <code>Compiler</code> \u7684\u7f16\u8bd1\u8c03\u5ea6/\u72b6\u6001\u673a\uff1b\u628a OSR/deopt/CHA/inline-cache \u7b49\u6267\u884c\u5f15\u64ce\u5173\u952e\u4fe1\u53f7\u4e32\u8d77\u6765\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#1-pandaruntimeinterface","title":"1. <code>PandaRuntimeInterface</code> \u7684\u5173\u952e\u5b9e\u73b0\u7c07","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#11-fast-path-gc-fast-pathisgcvalidforfastpathl56l66","title":"1.1 fast path \u4e0e GC fast path\uff1a<code>IsGcValidForFastPath</code>\uff08L56\u2013L66\uff09","text":"<ul> <li>Intrinsics fast path \u53ea\u5728 G1 GC \u4e0b\u542f\u7528\uff1a\u901a\u8fc7 <code>Runtime::GetGCType(..., lang)</code> \u5224\u65ad\u662f\u5426 <code>G1_GC</code>\u3002</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u67d0\u4e9b intrinsic/\u5feb\u8def\u5f84\u5728\u4e0d\u540c GC \u4e0b\u4f1a\u88ab\u7981\u7528\uff1aruntime interface \u76f4\u63a5\u5361\u4e86\u5f00\u5173\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#12-aot-snapshot-indexgetaotbinaryfilesnapshotindexl68l89","title":"1.2 AOT snapshot index\uff1a<code>GetAOTBinaryFileSnapshotIndex*</code>\uff08L68\u2013L89\uff09","text":"<ul> <li>\u628a <code>panda_file::File</code> \u6620\u5c04\u5230 AOT manager \u7684 snapshot index\uff0c\u5e76\u52a0\u4e0a <code>FILE_INDEX_BASE_OFFSET</code> \u5f62\u6210\u201c\u5bf9 compiler \u66b4\u9732\u7684 index \u7a7a\u95f4\u201d\u3002</li> <li>\u53cd\u5411\uff1a\u4ece snapshot index \u53d6\u56de <code>PandaFile*</code>\uff08<code>GetPandaFileBySnapshotIndex</code>\uff09\u3002</li> </ul> <p>\u8fd9\u4e0e 03 \u7ae0\u7684 <code>.an/AotManager</code> \u95ed\u73af\u4e00\u81f4\uff1a\u7f16\u8bd1\u5668\u4fa7\u9700\u8981\u7a33\u5b9a\u5730\u628a method\u2192panda file\u2192aot snapshot index \u7ed1\u5b9a\u8d77\u6765\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#13-pandaruntimeinterfacegetclassmethod-idl159l171","title":"1.3 \u7c7b\u89e3\u6790\uff1a<code>PandaRuntimeInterface::GetClass(method, id)</code>\uff08L159\u2013L171\uff09","text":"<p>\u5b9e\u73b0\u7ed9\u51fa\u4e86\u201c\u7f16\u8bd1\u671f\u89e3\u6790\u7c7b\u201d\u7684\u5178\u578b\u7b56\u7565\uff1a - L162\u2013L166\uff1a\u5148\u8d70 <code>ClassLinker::GetLoadedClass(...)</code>\uff08\u65e0\u9501 fast path\uff09 - miss \u540e\uff1a   - \u521b\u5efa <code>ErrorHandler</code>   - <code>ScopedMutatorLock</code>\uff08\u8bfb\u9501\uff09   - \u8c03 <code>ClassLinker::GetClass(..., handler)</code> \u89e6\u53d1\u52a0\u8f7d</p> <p>\u8fd9\u76f4\u63a5\u8fde\u63a5\u5230 03 \u7ae0\u7684 class loading\uff1a\u7f16\u8bd1\u5668\u89e3\u6790\u7c7b\u578b\u65f6\u65e2\u80fd\u201c\u4e0d\u610f\u5916\u89e6\u53d1\u52a0\u8f7d\u201d\uff0c\u53c8\u80fd\u5728\u786e\u5b9e\u9700\u8981\u65f6\u5b89\u5168\u52a0\u8f7d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#14","title":"1.4 \u8bed\u8a00/\u5f02\u5e38/\u7ebf\u7a0b\u72b6\u6001\u51b3\u7b56\u4e0b\u6c89\uff08\u672c\u6587\u4ef6\u4e2d\u591a\u5904\uff09","text":"<p>\u4f8b\u5982 <code>IsMethodNativeApi/CanThrowException/IsNecessarySwitchThreadState/CanNativeMethodUseObjects</code>\uff08\u672c\u6587\u4ef6\u4e2d\u5bf9\u5e94\u5b9e\u73b0\u7247\u6bb5\uff09\uff1a - \u83b7\u53d6 <code>LanguageContext</code> - \u8c03 <code>ClassLinkerExtension</code> \u7684\u5bf9\u5e94 virtual \u65b9\u6cd5</p> <p>\u8fd9\u662f 03\u219204 \u7684\u91cd\u8981\u8fb9\u754c\uff1a\u7f16\u8bd1\u5668\u9700\u8981\u7684\u201c\u8bed\u8a00\u7279\u6027\u201d\u7531 extension \u7edf\u4e00\u56de\u7b54\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#15-cha-inline-cache3-wrapper-l878l960","title":"1.5 CHA \u4e0e inline cache\uff1a3 \u4e2a wrapper \u7684\u5b9e\u73b0\uff08\u7ea6 L878\u2013L960\uff09","text":"<ul> <li>CHA\uff1a<code>ClassHierarchyAnalysisWrapper::AddDependency</code>\uff08L878\u2013L882\uff09   \u628a (callee,caller) \u4f9d\u8d56\u5199\u5165 <code>Runtime::GetCurrent()-&gt;GetCha()</code>\u3002</li> <li>Inline cache\uff1a<code>InlineCachesWrapper::GetClasses</code>\uff08L911\u2013L937\uff09   \u4ece <code>Method::GetProfilingData()</code> \u67e5 callsite inline cache\uff0c\u5e76\u628a class \u5217\u8868\u8fd4\u56de\u7ed9 compiler\uff1b\u6309\u6570\u91cf\u7ed9\u51fa MONO/POLY/MEGA \u5206\u7c7b\u3002</li> <li>Unresolved types\uff1a<code>UnresolvedTypesWrapper::{AddTableSlot,GetTableSlot}</code>\uff08L939\u2013L960\uff09   \u4e3a method+typeId+kind \u4fdd\u7559\u4e00\u4e2a\u53ef\u5199 slot\uff0c\u5e76\u628a\u8be5 slot \u7684\u5730\u5740\u8fd4\u7ed9 compiler\uff08\u7528\u4e8e\u751f\u6210 lazy resolve/patchpoint\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#2-compiler-l962l1183","title":"2. <code>Compiler</code>\uff1a\u7f16\u8bd1\u8c03\u5ea6\u4e0e\u72b6\u6001\u673a\uff08\u7ea6 L962\u2013L1183\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#21-compilercompilemethodl962l1004","title":"2.1 <code>Compiler::CompileMethod</code>\uff1a\u4e09\u6bb5\u5f0f\u51b3\u7b56\uff08L962\u2013L1004\uff09","text":"<p>1) \u8fc7\u6ee4\uff1a - \u62bd\u8c61\u65b9\u6cd5\u76f4\u63a5\u62d2\u7edd\uff08L964\u2013L966\uff09\u3002</p> <p>2) OSR \u5feb\u8def\u5f84\uff1a - L968\u2013L972\uff1a\u82e5 <code>osr==true</code> \u4e14 OSR code \u5df2\u5b58\u5728\uff1a\u76f4\u63a5 <code>OsrEntry(bytecodeOffset, GetOsrCode(method))</code>\u3002   \u5e76\u65ad\u8a00\uff1a\u5f53\u524d\u5e27 method \u5c31\u662f\u5b83\u3001\u4e14 method \u5df2\u6709 compiled code\uff08OSR \u4f9d\u8d56\u666e\u901a compiled code \u7684\u5b58\u5728\uff09\u3002</p> <p>3) \u89e6\u53d1\u7f16\u8bd1\uff1a - L974\u2013L982\uff1a   - \u82e5\u975e OSR \u4e14\u5df2\u7ecf compiled\uff0c\u5219\u9000\u51fa\uff08\u907f\u514d\u91cd\u590d\u7f16\u8bd1\uff09\u3002   - \u6839\u636e\u5f53\u524d compiled \u72b6\u6001\u51b3\u5b9a <code>ctxOsr</code>\u3002   - <code>AtomicSetCompilationStatus(..., WAITING)</code> \u6210\u529f\u540e\u5165\u961f <code>CompilerTask(method, ctxOsr, vm)</code>\uff08<code>AddTask</code>\uff09\u3002</p> <p>4) no-async-jit \u540c\u6b65\u7b49\u5f85\uff1a - L983\u2013L1002\uff1a   - \u7528 <code>ScopedChangeThreadStatus</code> \u91ca\u653e mutator lock\uff08\u907f\u514d\u963b\u585e JIT \u7ebf\u7a0b\u7684 invalidation/GC\uff09\u3002   - \u8f6e\u8be2 compilation status\uff08WAITING/COMPILATION\uff09\uff0c\u82e5 worker \u5df2\u88ab join \u5219\u9000\u51fa\u3002   - \u901a\u8fc7 <code>TimedWait</code> \u505a\u8f7b\u91cf\u7b49\u5f85\uff0810ms\uff09\u3002</p> <p>\u8fd9\u89e3\u91ca\u4e86\u4e00\u4e2a\u5e38\u89c1\u73b0\u8c61\uff1a\u5f00\u542f <code>no-async-jit</code> \u65f6\uff0c\u201c\u5728\u8c03\u7528\u70b9\u89e6\u53d1\u7f16\u8bd1\u5e76\u7b49\u5f85\u201d\u53ef\u80fd\u5bfc\u81f4 safepoint/GC \u884c\u4e3a\u53d8\u5316\uff08\u4e0e <code>HasSafepointDuringCall</code> \u7684\u6ce8\u91ca\u4e00\u81f4\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#22-startcompilemethod-finalize-l1014l1061","title":"2.2 <code>StartCompileMethod</code>\uff1a\u5206\u914d\u5668\u4e0e finalize \u89c4\u5219\uff08L1014\u2013L1061\uff09","text":"<p>\u5173\u952e\u70b9\uff1a - L1020\uff1a\u91cd\u7f6e hotness counter\uff08\u907f\u514d\u91cd\u590d\u89e6\u53d1\uff09\u3002 - L1022\u2013L1026\uff1a\u82e5\u7f16\u8bd1\u5df2\u201c\u8fc7\u671f\u201d\uff08OSR code \u5df2\u5b58\u5728\u6216 method \u5df2 compiled\uff09\uff0c\u63d0\u524d\u7ed3\u675f\u4efb\u52a1\u3002 - L1030\u2013L1039\uff1a\u4e3a compiler \u521b\u5efa arena allocator\uff08\u53ef\u80fd background/inplace \u6a21\u5f0f\u4e0d\u540c\u5f52\u5c5e\uff09\u3002 - L1041\u2013L1057\uff1aFinalize \u56de\u8c03\u8d1f\u8d23\u66f4\u65b0 <code>Method</code> \u7f16\u8bd1\u72b6\u6001\uff1a   - \u6210\u529f\uff1a<code>COMPILATION -&gt; COMPILED</code>\uff08\u5e76\u5f3a\u8c03\u201c\u68c0\u67e5\u672a\u88ab deopt\u201d\uff09   - OSR \u7f16\u8bd1\u5931\u8d25\u4e14\u53ef\u80fd\u88ab deopt\uff1a\u56de\u5230 <code>NOT_COMPILED</code>   - \u5176\u5b83\u5931\u8d25\uff1a<code>FAILED</code> - L1059\u2013L1060\uff1a\u771f\u6b63\u8fdb\u5165\u7f16\u8bd1\uff1a<code>compiler::JITCompileMethod(...)</code></p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#23-joinworker-debug-code-l1063l1073","title":"2.3 <code>JoinWorker</code> \u4e0e debug code \u6e05\u7406\uff08L1063\u2013L1073\uff09","text":"<ul> <li>join worker \u540e\uff0c\u5728\u7279\u5b9a\u7f16\u8bd1 debug \u914d\u7f6e\u4e0b\u6e05\u7406 jit debug code\uff08\u975e AOT \u4e14 emit debug info\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.cpp/#24-compilemethodimpll1101l1171-product-build","title":"2.4 \u6d4b\u8bd5\u8f85\u52a9\uff1a<code>CompileMethodImpl</code>\uff08L1101\u2013L1171\uff0c\u975e product build\uff09","text":"<ul> <li>\u901a\u8fc7\u5b57\u7b26\u4e32\u5f62\u5f0f\u7684 full method name \u5b9a\u4f4d class/method\uff0c\u5e76\u89e6\u53d1\u7f16\u8bd1\u6216\u7b49\u5f85\u7f16\u8bd1\u5b8c\u6210\u3002   \u8fd9\u6bb5\u540c\u65f6\u5c55\u793a\u4e86\u201c\u5982\u4f55\u9009\u62e9 class linker context\u201d\uff1a\u4f18\u5148\u4ece\u5f53\u524d\u6808\u9876\u65b9\u6cd5\u7684 class \u83b7\u53d6 load context\uff0c\u5426\u5219\u9000\u56de boot context\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/","title":"<code>runtime/compiler.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u201c\u63a5\u53e3\u9762\u201d\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a859 \u884c\uff08\u504f\u5927\uff1b\u4ee5\u201c\u63a5\u53e3\u9762\u4e0e\u5173\u952e\u4e0d\u53d8\u91cf\u201d\u4e3a\u4e3b\u505a\u5206\u6bb5\u8bb0\u5f55\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u8fd0\u884c\u65f6\u4fa7\u7684 JIT/AOT \u5165\u53e3\u4e0e <code>PandaRuntimeInterface</code>\uff08compiler::RuntimeInterface \u7684\u5b9e\u73b0\uff09\uff1a\u7f16\u8bd1\u5668\u9700\u8981\u7684\u4fe1\u606f\u67e5\u8be2\u3001\u4ee5\u53ca\u7f16\u8bd1\u4ea7\u7269\uff08compiled entrypoint / OSR code\uff09\u7684\u5199\u56de\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#0304","title":"\u4e00\u56fe\u8bfb\u61c2\uff1a\u7f16\u8bd1\u671f\u63a5\u53e3\u5982\u4f55\u6d88\u8d39 03/04 \u7ae0\u80fd\u529b","text":"<pre><code>flowchart TD\n  C[\"compiler/*\\n(\u7f16\u8bd1\u5668)\"] --&gt; RI[\"PandaRuntimeInterface\\n(runtime/compiler.h/.cpp)\"]\n  RI --&gt; CL[\"ClassLinker\\n(03 \u7ae0)\"]\n  RI --&gt; M[\"Method/Field/Class \u5143\u6570\u636e\\n(03 \u7ae0)\"]\n  RI --&gt; EP[\"entrypoints\\n(runtime/entrypoints)\"]\n  RI --&gt; CI[\"CompilerInterface\\n(runtime/include/compiler_interface.h)\\n(OSR code \u7ba1\u7406)\"]</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#0-l18l55","title":"0. \u9876\u90e8\u4f9d\u8d56\u4e0e\u201c\u5c0f\u5de5\u5177\u201d\uff08L18\u2013L55\uff09","text":"<ul> <li>L18\u2013L20\uff1a\u5f15\u5165 compiler \u7684 runtime_interface/compile_method/task_runner\uff1a\u8bf4\u660e\u672c\u6587\u4ef6\u662f runtime \u4e0e compiler \u7684\u63a5\u53e3\u8fb9\u754c\u3002</li> <li>L23\uff1a\u5f15\u5165 <code>entrypoints.h</code>\uff1a\u7f16\u8bd1\u5668 codegen \u9700\u8981\u77e5\u9053 runtime slowpath \u5165\u53e3\u7b26\u53f7\u3002</li> <li>L39\uff1a\u5f15\u5165 <code>osr.h</code>\uff1aOSR code \u7684\u5199\u56de/\u67e5\u8be2\u4f1a\u8d70 <code>CompilerInterface</code> \u4e0e <code>osr.*</code> \u95ed\u73af\u3002</li> <li>L47\u2013L50\uff1a<code>MethodCast</code>\uff1a\u628a <code>RuntimeInterface::MethodPtr</code> \u8fd8\u539f\u6210 <code>ark::Method*</code>\uff08\u7f16\u8bd1\u5668\u63a5\u53e3\u5927\u91cf\u4f7f\u7528 opaque \u6307\u9488\uff09\u3002</li> <li>L52\u2013L54\uff1a<code>ScopedMutatorLock</code>\uff1a\u5bf9 mutator lock \u7684\u8bfb\u9501\u5c01\u88c5\uff08\u4fdd\u8bc1\u8bfb runtime \u5143\u6570\u636e/\u5bf9\u8c61\u5b89\u5168\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#1-wrapperl56l82","title":"1. \u4e09\u4e2a\u201c\u9644\u52a0\u63a5\u53e3\u201dwrapper\uff08L56\u2013L82\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#11-classhierarchyanalysiswrapperl56l67","title":"1.1 <code>ClassHierarchyAnalysisWrapper</code>\uff08L56\u2013L67\uff09","text":"<ul> <li><code>GetSingleImplementation/IsSingleImplementation</code>\uff1a\u76f4\u63a5\u8bbf\u95ee <code>Method</code> \u7684 CHA \u4fe1\u606f\uff0803/04 \u7ae0\u90fd\u5728\u6d88\u8d39 CHA\uff09\u3002</li> <li><code>AddDependency(callee, caller)</code>\uff1a\u628a\u7f16\u8bd1\u671f\u4f9d\u8d56\u56de\u5199\u5230 runtime \u7684 CHA \u7ba1\u7406\u5668\uff08\u5b9e\u73b0\u89c1 <code>compiler.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#12-inlinecacheswrapperl69l73","title":"1.2 <code>InlineCachesWrapper</code>\uff08L69\u2013L73\uff09","text":"<ul> <li>\u4ece profiling data/inline cache \u63d0\u53d6 callsite \u7684 classes\uff08\u7528\u4e8e inline/virtual call \u53bb\u865a\u5316\u51b3\u7b56\uff1b\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#13-unresolvedtypeswrapperl75l82","title":"1.3 <code>UnresolvedTypesWrapper</code>\uff08L75\u2013L82\uff09","text":"<ul> <li>\u4e3a\u201c\u672a\u89e3\u6790\u7c7b\u578b\u201d\u7ef4\u62a4\u4e00\u4e2a method\u2192(typeId,slotKind)\u2192slot \u7684\u8868\uff0c\u4f9b\u7f16\u8bd1\u5668\u751f\u6210 lazy resolve \u4ee3\u7801\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#2-pandaruntimeinterfacel84-l702","title":"2. <code>PandaRuntimeInterface</code>\uff1a\u6700\u5173\u952e\u7684\u8fd0\u884c\u65f6\u63a5\u53e3\u5b9e\u73b0\uff08L84\u2013\u7ea6 L702+\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#21-ret_ok-ret_deoptimizationl106l113","title":"2.1 \u8fd4\u56de\u7406\u7531\uff1aRET_OK / RET_DEOPTIMIZATION\uff08L106\u2013L113\uff09","text":"<ul> <li>\u663e\u5f0f\u628a <code>CompilerInterface::ReturnReason</code> \u6620\u5c04\u4e3a compiler \u4fa7\u7684\u6570\u503c\u5e38\u91cf\uff1a</li> <li><code>GetReturnReasonOk()</code> \u2192 RET_OK</li> <li><code>GetReturnReasonDeopt()</code> \u2192 RET_DEOPTIMIZATION</li> </ul> <p>\u4e0e 04 \u7684 <code>entrypoints.cpp::DeoptimizeEntrypoint</code>\u3001<code>deoptimization.cpp::Deoptimize</code> \u5f62\u6210\u95ed\u73af\uff1a\u7f16\u8bd1\u4ee3\u7801\u53ef\u7528\u8fd4\u56de\u7406\u7531\u89e6\u53d1\u56de\u9000\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#22-compiled-entrypoint-osr-codel202l225","title":"2.2 \u7f16\u8bd1\u4ea7\u7269\u5199\u56de\uff1acompiled entrypoint / OSR code\uff08L202\u2013L225\uff09","text":"<ul> <li>L202\u2013L205\uff1a<code>SetCompiledEntryPoint(method, ep)</code>\uff1a\u5199\u5165 method \u7684 compiled entrypoint\u3002</li> <li>L206\u2013L217\uff1a<code>TrySetOsrCode(method, ep)</code>\uff1aOSR code \u7684\u201c\u6709\u6761\u4ef6\u5199\u5165\u201d</li> <li>\u5148\u62ff <code>ScopedMutatorLock</code>\uff08\u8bfb\u9501\uff09</li> <li>L209\u2013L212\uff1a\u82e5 method \u5df2\u88ab deopt/\u6ca1\u6709 compiled code\uff0c\u5219\u62d2\u7edd\u5199\u5165\uff08\u907f\u514d\u201cOSR \u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u88ab\u5931\u6548\u201d\u7684\u7ade\u6001\uff09</li> <li>L213\u2013L216\uff1a\u901a\u8fc7 <code>CompilerInterface</code> \u5199\u5165 OSR code\uff0c\u5e76\u65ad\u8a00\u4e4b\u524d\u6ca1\u6709 OSR code</li> <li>L218\u2013L225\uff1a<code>GetOsrCode/HasCompiledCode</code>\uff1a\u4ece VM compiler \u8bfb\u53d6 OSR code \u6216\u5224\u65ad compiled \u72b6\u6001\u3002</li> </ul> <p>\u8fd9\u4e0e 04 \u7684 <code>osr.cpp::OsrEntry/PrepareOsrEntry</code>\u3001<code>deoptimization.cpp::InvalidateCompiledEntryPoint(RemoveOsrCode)</code> \u662f\u540c\u4e00\u4e2a\u95ed\u73af\u7684\u4e09\u89d2\u5f62\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#23-classmethodfield-fast-path-l125-cpp","title":"2.3 Class/Method/Field \u67e5\u8be2\uff1a\u5178\u578b fast path\uff08\u58f0\u660e\u89c1 L125+\uff0c\u5b9e\u73b0\u4e3b\u8981\u5728 <code>.cpp</code>\uff09","text":"<p>\u5178\u578b\u6a21\u5f0f\uff08\u4ee5 <code>GetClass(method, id)</code> \u4e3a\u4f8b\uff0c\u89c1 <code>.cpp</code>\uff09\uff1a - \u5148\u5c1d\u8bd5 <code>ClassLinker::GetLoadedClass</code>\uff08\u65e0\u9501 fast path\uff09 - miss \u65f6\uff1a\u521b\u5efa error handler + <code>ScopedMutatorLock</code>\uff0c\u8d70 <code>ClassLinker::GetClass(...)</code> \u52a0\u8f7d</p> <p>\u8fd9\u4f7f\u5f97\u7f16\u8bd1\u671f\u89e3\u6790\u4e0d\u4f1a\u201c\u65e0\u8c13\u89e6\u53d1\u52a0\u8f7d\u201d\uff0c\u4e5f\u80fd\u5728\u9700\u8981\u65f6\u5b89\u5168\u52a0\u8f7d\uff08\u4e0e 03 \u7ae0 class loading pipeline \u5bf9\u9f50\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#24-inlineverifier-l311l321","title":"2.4 \u662f\u5426\u5141\u8bb8 inline\uff1aVerifier \u7ea6\u675f\uff08L311\u2013L321\uff09","text":"<ul> <li>\u82e5 verification mode \u662f ON_THE_FLY \u4e14 method \u8fd8\u6ca1 VERIFIED_OK \u2192 \u7981\u6b62 inline   \u539f\u56e0\uff1a\u672a\u9a8c\u8bc1\u65b9\u6cd5\u7684\u8bed\u4e49/\u7c7b\u578b\u4fe1\u606f\u4e0d\u53ef\u9760\uff0cinline \u4f1a\u653e\u5927\u98ce\u9669\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#25-api","title":"2.5 \u4e0e\u8bed\u8a00\u6269\u5c55\u7684\u8fde\u63a5\u70b9\uff08\u591a\u4e2a API\uff09","text":"<p>\u672c\u63a5\u53e3\u5728\u591a\u4e2a\u5730\u65b9\u628a\u8bed\u8a00\u76f8\u5173\u51b3\u7b56\u4e0b\u6c89\u5230 <code>ClassLinkerExtension</code> / <code>LanguageContext</code>\uff1a - <code>IsMethodNativeApi</code> / <code>CanThrowException</code> / <code>IsNecessarySwitchThreadState</code> / <code>CanNativeMethodUseObjects</code></p> <p>\u8fd9\u548c 03 \u7ae0\u7684 <code>ClassLinkerExtension</code> \u5408\u7ea6\u4e00\u81f4\uff1a\u8bed\u8a00\u5dee\u5f02\u7531 extension \u515c\u5e95\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_compiler.h/#3-compiler-l703","title":"3. <code>Compiler</code>\uff08\u7c7b\u58f0\u660e\u5728 L703 \u4e4b\u540e\uff09","text":"<p>\u672c\u6587\u4ef6\u540e\u534a\u6bb5\u8fd8\u58f0\u660e <code>Compiler : CompilerInterface</code>\uff08\u5b9e\u73b0\u89c1 <code>runtime/compiler.cpp</code>\uff09\uff0c\u8d1f\u8d23\uff1a - \u6536\u4efb\u52a1\uff08method \u70ed\u5ea6\u89e6\u53d1\uff09 - \u540c\u6b65/\u5f02\u6b65\u7f16\u8bd1\u8c03\u5ea6 - OSR entry \u4e0e\u7f16\u8bd1\u72b6\u6001\u673a</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/","title":"<code>runtime/deoptimization.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a255 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0\u53bb\u4f18\u5316\uff08deopt\uff09\u4e0e entrypoint \u5931\u6548\uff1a 1) InvalidateCompiledEntryPoint\uff1a\u8de8\u7ebf\u7a0b\u626b\u63cf\u6808\u5e76\u6807\u8bb0\u9700\u8981 deopt \u7684 CFrame 2) Deoptimize\uff1a\u628a\u76ee\u6807 CFrame \u8f6c\u6210\u89e3\u91ca\u5668 Frame\uff0c\u5e76\u901a\u8fc7\u6c47\u7f16\u6865\u8df3\u56de\u89e3\u91ca\u5668\u6267\u884c 3) DropCompiledFrame\uff1a\u4e22\u5f03 CFrame \u5e76 return</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#deoptimize","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aDeoptimize \u7684\u201c\u4e0d\u53ef\u8fd4\u56de\u201d\u8df3\u8f6c","text":"<pre><code>flowchart TD\n  A[\"Deoptimize(stack, pc?, hasException)\"] --&gt; B[\"\uff08\u5fc5\u8981\u65f6\uff09\u8ba1\u7b97 pc\\nmethod-&gt;inst + bytecodePc\"]\n  B --&gt; C[\"CleanupCompiledFrameResources\"]\n  C --&gt; D[\"InvalidateCompiledEntryPoint\\n(\u53ef\u9009 destroyMethod)\"]\n  D --&gt; E[\"iframe = stack-&gt;ConvertToIFrame(...)\\n\u91cd\u5efa\u89e3\u91ca\u5668\u5e27\"]\n  E --&gt; F[\"\uff08\u53ef\u9009\uff09\u628a pending exception \u5199\u5165 iframe-&gt;acc\"]\n  F --&gt; G{\"prevFrameKind\uff1f\\nstack-&gt;ConvertToIFrame \u7ed9\u51fa\"}\n  G --&gt;|prev=COMPILER| H[\"DeoptimizeAfterCFrame(...)\\n\u6c47\u7f16\u6865\u8df3\u8f6c\"]\n  G --&gt;|prev=IFRAME/NONE| I[\"DeoptimizeAfterIFrame(...)\\n\u6c47\u7f16\u6865\u8df3\u8f6c\"]</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#0-deoptimizeafterframe-dropcompiledframeandreturnl32l67","title":"0. \u6c47\u7f16\u6865\u58f0\u660e\uff1a<code>DeoptimizeAfter*Frame</code> / <code>DropCompiledFrameAndReturn</code>\uff08L32\u2013L67\uff09","text":"<ul> <li>L44\u2013L45\uff1a<code>DeoptimizeAfterCFrame(...)</code>\uff1a\u5f53\u76ee\u6807 CFrame \u7684\u201c\u4e0b\u65b9\uff08callee\uff09\u201d\u4e5f\u662f CFrame \u65f6\u4f7f\u7528\u3002</li> <li>L58\u2013L59\uff1a<code>DeoptimizeAfterIFrame(...)</code>\uff1a\u5f53\u76ee\u6807 CFrame \u4e0b\u65b9\u662f\u89e3\u91ca\u5668\u5e27\uff08\u6216\u9876\u90e8\uff09\u65f6\u4f7f\u7528\u3002</li> <li>L67\uff1a<code>DropCompiledFrameAndReturn(...)</code>\uff1a\u76f4\u63a5\u4e22\u5f03 CFrame \u5e76 return\u3002</li> </ul> <p>\u5171\u540c\u70b9\uff1a - \u90fd\u662f <code>extern \"C\" [[noreturn]]</code>\uff1a\u7531\u6c47\u7f16\u5b9e\u73b0\uff0c\u5b8c\u6210\u6808\u6307\u9488/\u8fd4\u56de\u5730\u5740/\u5bc4\u5b58\u5668\u6062\u590d\uff0c\u5e76\u8df3\u8f6c\u5230\u89e3\u91ca\u5668\u5165\u53e3\u6216 return\u3002 - \u90fd\u9700\u8981 <code>calleeRegs</code>\uff1a\u7531 <code>StackWalker::GetCalleeRegsForDeoptimize()</code> \u63d0\u4f9b\u7684 callee-saved regs \u5feb\u7167/\u6307\u9488\uff08\u89c1 04 \u7684 stack_walker FileNotes\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#1-invalidatecompiledentrypointl77l133","title":"1. \u5931\u6548\u8def\u5f84\uff1a<code>InvalidateCompiledEntryPoint</code>\uff08L77\u2013L133\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#11-cframel83l104","title":"1.1 \u626b\u63cf\u6bcf\u4e2a\u7ebf\u7a0b\u6808\u5e76\u6807\u8bb0 CFrame\uff08L83\u2013L104\uff09","text":"<ul> <li>L86\uff1a\u5bf9\u6bcf\u4e2a\u7ebf\u7a0b\u521b\u5efa <code>StackWalker</code>\uff0c\u904d\u5386\u6240\u6709\u5e27\u3002</li> <li>L87\u2013L90\uff1a\u547d\u4e2d\u76ee\u6807\u65b9\u6cd5\u7684 CFrame\uff1a</li> <li><code>cframe.SetShouldDeoptimize(true)</code>\uff1a\u544a\u8bc9\u6267\u884c\u4fa7\u201c\u4e0b\u6b21\u8d70\u5230\u8fd9\u91cc\u8981\u56de\u9000\u201d</li> <li><code>cframe.SetDeoptCodeEntry(stack.GetCompiledCodeEntry())</code>\uff1a\u4fdd\u5b58\u201c\u539f code entry\u201d\uff0c\u56e0\u4e3a\u5e38\u89c4 entrypoint \u53ef\u80fd\u968f\u5931\u6548\u6539\u53d8\uff08\u5bf9\u5e94 <code>stack_walker.cpp::CreateCFrame</code> \u7684 codeEntry \u4e09\u6001\u9009\u62e9\uff09</li> <li>L91\u2013L97\uff1a\u533a\u5206 CHA \u4e0e IC\uff08\u65e5\u5fd7\u6807\u8bb0\u4e0d\u540c\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#12-l109l132","title":"1.2 \u5168\u5c40\u505c\u4e16\u754c + \u679a\u4e3e\u7ebf\u7a0b\uff08L109\u2013L132\uff09","text":"<ul> <li>L110\uff1a<code>ScopedSuspendAllThreadsRunning</code>\uff1a\u6682\u505c\u6240\u6709\u7ebf\u7a0b\uff0c\u4fdd\u8bc1\u904d\u5386\u6808\u4e0e\u4fee\u6539\u72b6\u6001\u5b89\u5168\u3002</li> <li>L112\u2013L121\uff1a\u5bf9\u6bcf\u4e2a method\uff0c\u904d\u5386\u6240\u6709\u7ebf\u7a0b\u8c03\u7528 <code>InvalidateCompiledMethod</code>\u3002</li> <li>L126\uff1a<code>method-&gt;SetInterpreterEntryPoint()</code>\uff1a\u5f3a\u5236\u628a entrypoint \u5207\u56de\u89e3\u91ca\u5668\u3002</li> <li>L127\uff1a<code>RemoveOsrCode(method)</code>\uff1a\u79fb\u9664 OSR code\uff08\u907f\u514d\u7ee7\u7eed\u8fdb\u5165\u5df2\u5931\u6548\u7684 OSR\uff09\u3002</li> <li>L128\u2013L131\uff1a\u4fee\u6b63 compilation status\uff08\u5982\u679c\u4e0d\u662f COMPILATION \u8fdb\u884c\u4e2d\uff0c\u5219\u7f6e\u4e3a NOT_COMPILED\uff09\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aInvalidate \u4e0d\u53ea\u662f\u201c\u6539 entrypoint\u201d\uff0c\u8fd8\u8981\u517c\u987e\u201c\u5df2\u7ecf\u5728\u6808\u4e0a\u7684\u7f16\u8bd1\u5e27\u201d\uff08\u901a\u8fc7 ShouldDeoptimize + DeoptCodeEntry\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#2-prevframedeoptl135l170","title":"2. \u9009\u62e9\u6c47\u7f16\u6865\uff1a<code>PrevFrameDeopt</code>\uff08L135\u2013L170\uff09","text":"<ul> <li>\u6839\u636e <code>prevFrameKind</code> \u5206\u6d41\uff1a</li> <li>prev=COMPILER\uff08L139\u2013L159\uff09\uff1a<ul> <li>\u5148 <code>thread-&gt;SetCurrentFrameIsCompiled(true)</code>\uff08\u91cd\u8981\u6ce8\u91ca\uff1a\u53ef\u80fd\u4ece\u53e6\u4e00\u6b21 Deoptimize \u7684\u89e3\u91ca\u5668\u6267\u884c\u8def\u5f84\u56de\u5230\u8fd9\u91cc\uff0c\u5e27\u7c7b\u578b\u6807\u8bb0\u5df2\u53d8\uff09</li> <li>\u8c03 <code>DeoptimizeAfterCFrame(...)</code></li> </ul> </li> <li>prev=NONE/INTERPRETER\uff08L160\u2013L168\uff09\uff1a<ul> <li>\u8c03 <code>DeoptimizeAfterIFrame(...)</code></li> </ul> </li> </ul> <p><code>EVENT_DEOPTIMIZATION</code> \u5728\u4e24\u652f\u90fd\u4f1a\u8bb0\u5f55\uff08\u533a\u5206 after cframe/iframe/top\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#3-deoptimize-l181l242","title":"3. <code>Deoptimize</code> \u4e3b\u4f53\uff1a\u5148\u5931\u6548\uff0c\u518d\u8f6c\u6362\uff0c\u518d\u8df3\u8f6c\uff08L181\u2013L242\uff09","text":"<p>\u5173\u952e\u987a\u5e8f\uff1a</p> <p>1) \u8f93\u5165\u4e0e pc \u8ba1\u7b97\uff08L184\u2013L195\uff09 - \u5fc5\u987b <code>stack-&gt;IsCFrame()</code>\u3002 - \u82e5 <code>pc==nullptr</code>\uff1a\u4f7f\u7528 <code>method-&gt;GetInstructions() + stack-&gt;GetBytecodePc()</code>\u3002</p> <p>2) \u6e05\u7406\u7f16\u8bd1\u5e27\u8d44\u6e90\uff08L200\u2013L202\uff09 - <code>CleanupCompiledFrameResources(thread-&gt;GetCurrentFrame())</code>\uff1a\u4e3a\u56de\u9000\u505a\u8d44\u6e90\u56de\u6536/\u89e3\u7ed1\uff08\u8bed\u8a00/VM \u76f8\u5173\uff09\u3002</p> <p>3) \u5148 Invalidate\uff0c\u518d Convert\uff08L204\u2013L215\uff09 - L204\u2013L205 \u7684\u6ce8\u91ca\u975e\u5e38\u5173\u952e\uff1a   \u201c\u5fc5\u987b\u5728 Convert \u4e4b\u524d\u8fd0\u884c InvalidateCompiledEntryPoint\uff0c\u56e0\u4e3a GC \u53ef\u80fd\u5df2\u7ecf\u5728\u6536\u96c6\u9636\u6bb5\u5e76\u79fb\u52a8 deoptimized frame \u4e2d\u7684\u5bf9\u8c61\u3002\u201d   \u8fd9\u8bf4\u660e ConvertToIFrame \u8fc7\u7a0b\u4e2d\u4f1a\u8bfb\u53d6\u5bf9\u8c61\u5f15\u7528\uff1b\u82e5\u5bf9\u8c61\u79fb\u52a8\u4e14\u6808\u4e0a\u5f15\u7528\u672a\u6309 GC \u89c4\u5219\u66f4\u65b0\uff0c\u5c31\u4f1a\u6062\u590d\u9519\u8bef\u751a\u81f3\u5d29\u6e83\u3002</p> <p>4) ConvertToIFrame + \u5904\u7406 inlined \u65b9\u6cd5\u6570\uff08L210\u2013L223\uff09 - L214\u2013L215\uff1a<code>iframe = stack-&gt;ConvertToIFrame(&amp;prevFrameKind, &amp;numInlinedMethods)</code>   \u8fd9\u4e00\u6b65\u628a cframe \u7684 vregs/acc/env \u7b49\u6309 codeinfo/stackmap \u6620\u5c04\u56de\u89e3\u91ca\u5668 frame\uff08\u8be6\u89c1 <code>stack_walker.cpp</code> \u7684 FileNotes\uff09\u3002 - L217\u2013L223\uff1a\u6cbf prevFrame \u94fe\u56de\u9000 <code>numInlinedMethods</code> \u6b21\uff0c\u5f97\u5230 <code>lastIframe</code>\uff0c\u5e76\u65ad\u8a00\u4e0d\u4f1a\u8e29\u5230\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\uff08L222\uff09\u3002</p> <p>5) pending exception \u5904\u7406\uff08L228\u2013L238\uff09 - \u82e5\u7ebf\u7a0b\u5df2\u6709\u5f02\u5e38\uff1a\u628a\u5f02\u5e38\u5bf9\u8c61\u653e\u5165 <code>iframe-&gt;GetAcc()</code>\uff08\u901a\u8fc7 <code>LanguageContext::SetExceptionToVReg</code>\uff09\u2014\u2014\u4fdd\u8bc1\u89e3\u91ca\u5668\u80fd\u5728\u6b63\u786e\u8bed\u4e49\u4e0b\u7ee7\u7eed\u4f20\u64ad\u5f02\u5e38\u3002 - \u82e5 <code>hasException==false</code>\uff1a\u6e05\u7406\u5f02\u5e38\uff1b\u5426\u5219\u5fc5\u987b\u4ecd\u6709 pending exception\u3002</p> <p>6) \u6700\u7ec8\u8df3\u8f6c\uff08L240\u2013L241\uff09 - \u8c03 <code>PrevFrameDeopt(...)</code>\uff0c\u4e0d\u4f1a\u8fd4\u56de\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.cpp/#4-dropcompiledframel244l252","title":"4. <code>DropCompiledFrame</code>\uff08L244\u2013L252\uff09","text":"<ul> <li>\u83b7\u53d6 cframe fp\uff0c\u8bb0\u5f55\u4e8b\u4ef6\uff0cASAN unpoison\uff0c\u7136\u540e <code>DropCompiledFrameAndReturn(fp, calleeRegsEnd)</code>\u3002</li> <li>\u540c\u6837 <code>[[noreturn]]</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.h/","title":"<code>runtime/deoptimization.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a42 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49\u53bb\u4f18\u5316\uff08deopt\uff09\u5bf9\u5916 API\uff1a\u628a\u7f16\u8bd1\u5e27\uff08CFrame\uff09\u56de\u9000\u4e3a\u89e3\u91ca\u5668\u6267\u884c\uff0c\u4ee5\u53ca\u6279\u91cf\u5931\u6548 compiled entrypoint\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.h/#0-l18l19","title":"0. \u4f9d\u8d56\uff08L18\u2013L19\uff09","text":"<ul> <li><code>exceptions.h</code>\uff1adeopt \u5e38\u4e0e\u5f02\u5e38\u8def\u5f84\u7ed1\u5b9a\uff08pending exception/\u627e catch\uff09\u3002</li> <li><code>stack_walker.h</code>\uff1adeopt \u7684\u6838\u5fc3\u8f93\u5165\u662f <code>StackWalker*</code>\uff0c\u5373\u201c\u5728\u6808\u4e0a\u5b9a\u4f4d\u5230\u9700\u8981\u56de\u9000\u7684 CFrame \u5e76\u80fd\u8bfb\u53d6\u5176 state\u201d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.h/#1-deoptimize-cframe-l23l30","title":"1. <code>Deoptimize</code>\uff1a\u4ece CFrame \u56de\u5230\u89e3\u91ca\u5668\uff08L23\u2013L30\uff09","text":"<p>\u7b7e\u540d\uff08L29\u2013L30\uff09\uff1a - <code>stack</code>\uff1a\u5fc5\u987b\u6307\u5411 CFrame\uff08\u7f16\u8bd1\u5e27\uff09\u3002 - <code>pc</code>\uff1a   - \u975e\u7a7a\uff1a\u89e3\u91ca\u5668\u4ece\u8be5 pc \u5f00\u59cb\u6267\u884c\uff08\u8c03\u7528\u65b9\u63d0\u4f9b\uff09\u3002   - \u4e3a\u7a7a\uff1a\u7531 deopt \u4ece CFrame/stackmap \u8ba1\u7b97\u5f97\u5230 pc\uff08\u5b9e\u73b0\u89c1 <code>deoptimization.cpp</code>\uff09\u3002 - <code>hasException</code>\uff1a   - true\uff1a\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u5df2\u6709\u5f02\u5e38\u9700\u8981\u5728\u89e3\u91ca\u5668\u4fa7\u7ee7\u7eed\u4f20\u64ad\u3002   - false\uff1adeopt \u8fc7\u7a0b\u4e2d\u4f1a\u6e05\u7406\u5f02\u5e38\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002 - <code>destroyMethod</code>\uff1a\u53ef\u9009\uff1a\u5728 deopt \u524d\u4e3b\u52a8\u628a\u67d0\u4e2a method \u6807\u8bb0 destroyed \u5e76\u5931\u6548\u5176 entrypoint\uff08\u7528\u4e8e\u67d0\u4e9b\u6781\u7aef invalidation \u573a\u666f\uff09\u3002</p> <p>\u6ce8\u610f\uff1a\u8fd4\u56de\u7c7b\u578b\u662f <code>[[noreturn]]</code>\uff0c\u610f\u5473\u7740\u5b83\u4e0d\u4f1a\u201c\u6b63\u5e38 return\u201d\uff0c\u800c\u662f\u901a\u8fc7\u6c47\u7f16\u6865/\u6808\u8c03\u6574\u8df3\u8d70\uff08\u89c1 <code>.cpp</code> \u7684 <code>DeoptimizeAfter*Frame</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.h/#2-dropcompiledframe-cframe-return-l32l36","title":"2. <code>DropCompiledFrame</code>\uff1a\u4e22\u5f03 CFrame \u5e76 return \u7ed9\u8c03\u7528\u8005\uff08L32\u2013L36\uff09","text":"<ul> <li>\u4e0e <code>Deoptimize</code> \u4e0d\u540c\uff1adrop \u4e0d\u91cd\u5efa\u89e3\u91ca\u5668\u72b6\u6001\uff0c\u800c\u662f\u201c\u628a\u8be5 cframe \u4ece\u6808\u4e0a\u5f39\u6389\u201d\uff0c\u6062\u590d\u8fd4\u56de\u5730\u5740\u5e76\u6267\u884c return\uff08\u6c47\u7f16\u6865\u5b9e\u73b0\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_deoptimization.h/#3-invalidatecompiledentrypointl38","title":"3. <code>InvalidateCompiledEntryPoint</code>\uff1a\u6279\u91cf\u5931\u6548\uff08L38\uff09","text":"<p>\u628a\u4e00\u7ec4 <code>Method*</code> \u7684 compiled entrypoint \u5931\u6548\uff08\u7528\u4e8e CHA/IC \u7b49\u5047\u8bbe\u5931\u6548\u540e\u5f3a\u5236\u56de\u9000\uff09\u3002</p> <p>\u5bf9\u5e94\u5b9e\u73b0\uff08<code>deoptimization.cpp</code>\uff09\u8fd8\u4f1a\uff1a - \u5728\u6240\u6709\u7ebf\u7a0b\u6808\u4e0a\u626b\u63cf\u5e76\u6807\u8bb0 <code>cframe.ShouldDeoptimize=true</code> - \u628a method entrypoint \u5207\u56de\u89e3\u91ca\u5668 - \u79fb\u9664 OSR code - \u4fee\u6b63 compilation status</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/","title":"<code>runtime/entrypoints/entrypoints.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6267\u884c\u5f15\u64ce\u76f8\u5173\u51fd\u6570\u7c07\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a2160 \u884c\uff08\u5de8\u5927\u6587\u4ef6\uff1b\u672c\u7b14\u8bb0\u6309\u201c\u4e0e\u6267\u884c\u5f15\u64ce\u76f4\u63a5\u95ed\u73af\u201d\u7684\u51fd\u6570\u7c07\u5206\u6bb5\u8bb0\u5f55\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1aentrypoints \u7684\u96c6\u5408\u5b9e\u73b0\uff1acompiled code \u7684\u6162\u8def\u5f84\u3001\u89e3\u91ca\u5668\u5165\u53e3\u6869\u3001\u5f02\u5e38/\u627e catch\u3001\u4ee5\u53ca deopt \u5165\u53e3\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#0-entrypoint-check_stack_walker-begin_entrypointl86l100","title":"0. entrypoint \u7684\u7edf\u4e00\u201c\u62a4\u680f\u201d\uff1aCHECK_STACK_WALKER / BEGIN_ENTRYPOINT\uff08L86\u2013L100\uff09","text":"<ul> <li>L86\u2013L95\uff1a<code>CHECK_STACK_WALKER</code> </li> <li>Debug \u4e0b\u53ef\u542f\u7528 <code>Runtime::GetOptions().IsVerifyEntrypoints()</code>\uff0c\u5bf9\u6bcf\u4e2a entrypoint \u505a\u4e00\u6b21 <code>StackWalker::Verify()</code>\uff08\u63d0\u524d\u66b4\u9732\u6808/\u8fb9\u754c\u5e27\u95ee\u9898\uff09\u3002</li> <li>L97\u2013L100\uff1a<code>BEGIN_ENTRYPOINT()</code> = <code>CHECK_STACK_WALKER</code> +\uff08\u53ef\u9009\uff09log  </li> <li>\u8bbe\u8ba1\u610f\u56fe\uff1aentrypoint \u662f\u201c\u8de8\u8fb9\u754c\u51fd\u6570\u201d\uff0c\u8d8a\u65e9\u53d1\u73b0 stack walker/\u8fb9\u754c\u5e27\u7834\u574f\u8d8a\u597d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#1-interpreterentrypointcompiled-l102l136","title":"1. <code>InterpreterEntryPoint</code>\uff1acompiled \u2192 \u89e3\u91ca\u5668\u6267\u884c\uff08L102\u2013L136\uff09","text":"<p>\u6838\u5fc3\u8bed\u4e49\uff1a - L106\u2013L115\uff1a\u62bd\u8c61\u65b9\u6cd5\u8c03\u7528\u68c0\u67e5\uff1a\u82e5 <code>callee-&gt;IsAbstract()</code>\uff0c\u629b <code>AbstractMethodError</code> \u5e76\u5904\u7406 pending exception\u3002 - L117\u2013L122\uff1a\u6808\u6ea2\u51fa\u68c0\u67e5\u5931\u8d25\u5219 <code>HandlePendingException(UnwindPolicy::SKIP_INLINED)</code>\uff08\u8bf4\u660e\u8fd9\u91cc\u4f1a\u89e6\u53d1 unwind/\u627e catch\uff09\u3002 - L124\u2013L130\uff1a\u5207\u6362\u7ebf\u7a0b\u5f53\u524d\u5e27\uff1a   - \u4fdd\u5b58 <code>prevFrame = thread-&gt;GetCurrentFrame()</code>   - <code>thread-&gt;SetCurrentFrame(frame)</code>   - \u4fdd\u5b58\u5e76\u5207\u6362 <code>IsCurrentFrameCompiled=false</code>\uff0c\u518d\u8c03\u7528 <code>interpreter::Execute(thread, pc, frame)</code>   - \u6267\u884c\u7ed3\u675f\u540e\u6062\u590d <code>isCompiledCode</code> - L131\u2013L135\uff1a\u6062\u590d current frame \u7684\u7279\u6b8a\u5904\u7406\uff1a   \u5982\u679c <code>prevFrame-&gt;GetMethod()</code> \u7684\u503c\u7b49\u4e8e <code>COMPILED_CODE_TO_INTERPRETER</code>\uff08\u8fd9\u662f \u89e3\u91ca\u5668\u8fb9\u754c\u5e27 \u7684\u6807\u8bb0\u503c\uff09\uff0c\u5219 current frame \u8981\u8df3\u8fc7\u8fb9\u754c\u5e27\uff0c\u8bbe\u7f6e\u4e3a <code>prevFrame-&gt;GetPrevFrame()</code>\uff1b\u5426\u5219\u6062\u590d\u5230 <code>prevFrame</code>\u3002</p> <p>\u8fd9\u4e0e 04 \u7684 <code>stack_walker.h</code> \u4e2d <code>IsBoundaryFrame&lt;FrameKind::INTERPRETER&gt;</code> \u7684\u5224\u5b9a\u662f\u4e00\u81f4\u7684\uff1a\u8fb9\u754c\u5e27\u7684 method slot \u5b58\u7684\u662f\u7279\u6b8a\u5e38\u91cf\u800c\u975e\u771f\u5b9e Method*\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#2-frame-createframe-freeframel673l772","title":"2. Frame \u5206\u914d/\u91ca\u653e\uff1aCreateFrame* / FreeFrame\uff08L673\u2013L772\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#21-createframewithsizeext-frame-language-ext-sizel673l685","title":"2.1 <code>CreateFrameWithSize</code>\uff1aext frame + language ext size\uff08L673\u2013L685\uff09","text":"<ul> <li>L675\u2013L678\uff1aext frame data size\uff08<code>extSz</code>\uff09\uff1a</li> <li>\u82e5 method \u5b58\u5728\uff1a\u901a\u8fc7 <code>LanguageContext(*method).GetFrameExtSize()</code> \u83b7\u53d6\u8bed\u8a00\u76f8\u5173\u6269\u5c55\u5927\u5c0f</li> <li>\u5426\u5219\u4f7f\u7528\u9ed8\u8ba4\u503c</li> <li>L679\u2013L684\uff1a\u5206\u914d\u4e0e placement-new\uff1a</li> <li><code>allocSz = Frame::GetAllocSize(size, extSz)</code></li> <li>\u901a\u8fc7 VM HeapManager <code>AllocateExtFrame(allocSz, extSz)</code></li> <li>\u5728\u5206\u914d\u5230\u7684\u5185\u5b58\u4e0a placement-new <code>Frame(...)</code></li> </ul> <p>\u5173\u952e\u70b9\uff1a\u8fd9\u6761\u8def\u5f84\u4f7f\u7528\u7684\u662f heap manager \u7684 ext frame \u5206\u914d\uff08\u4e0e thread \u7684 stack frame allocator \u4e0d\u540c\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#22-createframewithactualargsandsize-createnativeframewithactualargsandsizel687l713","title":"2.2 <code>CreateFrameWithActualArgsAndSize</code> / <code>CreateNativeFrameWithActualArgsAndSize</code>\uff08L687\u2013L713\uff09","text":"<ul> <li>L690\u2013L699\uff1a<code>CreateFrameWithActualArgsAndSize</code> </li> <li>\u4f7f\u7528 <code>ManagedThread::GetCurrent()-&gt;GetStackFrameAllocator()-&gt;Alloc(allocSz)</code> \u5206\u914d</li> <li>\u7528 <code>Frame::FromExt/FromExt</code> \u505a ext/\u4e3b\u4f53\u6307\u9488\u6362\u7b97\u5e76 placement-new</li> <li>L701\u2013L713\uff1anative \u7248\u672c\u7c7b\u4f3c\uff0c\u4e5f\u7528 stack frame allocator\uff08\u540c\u6837 placement-new\uff09</li> </ul> <p>\u8fd9\u91cc\u4f53\u73b0\u4e86\u4e00\u4e2a\u5de5\u7a0b\u7ea6\u5b9a\uff1a\u67d0\u4e9b frame \u8d70\u201c\u6808\u5e27\u5206\u914d\u5668\u201d\uff08\u66f4\u50cf\u7ebf\u7a0b\u6808\u4e0a\u5206\u914d\uff09\uff0c\u67d0\u4e9b\u8d70 heap manager \u7684 ext frame\uff08\u66f4\u50cf VM \u7ba1\u7406\u7684\u7279\u6b8a\u533a\u57df\uff09\u3002\u8fd9\u4f1a\u5f71\u54cd FreeFrame \u7684\u91ca\u653e\u7b56\u7565\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#23-vreg-createframewithactualargs-l721l738","title":"2.3 \u52a8\u6001\u8bed\u8a00 vreg \u521d\u59cb\u5316\uff1a<code>CreateFrameWithActualArgs</code> \u6a21\u677f\uff08L721\u2013L738\uff09","text":"<ul> <li>L729\u2013L736\uff1a\u5f53 <code>IS_DYNAMIC==true</code>\uff1a</li> <li>\u4ece <code>LanguageContext</code> \u83b7\u53d6 <code>initial tagged value</code></li> <li>\u628a\u6240\u6709 vregs \u521d\u59cb\u5316\u4e3a\u8be5 tagged \u503c</li> <li><code>frame-&gt;SetDynamic()</code></li> </ul> <p>\u8fd9\u662f\u52a8\u6001\u8bed\u8a00\u201cvregs \u81ea\u5e26 tag/\u521d\u59cb\u503c\u201d\u8bed\u4e49\u7684\u4e00\u4e2a\u76f4\u63a5\u8bc1\u636e\u70b9\uff08\u5bf9\u5e94 04 \u7684 Frame_VReg_Acc\uff08DataStructure\uff09\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#24-createframeformethodl740l764","title":"2.4 \u4fbf\u6377\u5165\u53e3\uff1aCreateFrameForMethod*\uff08L740\u2013L764\uff09","text":"<ul> <li>\u8ba1\u7b97 <code>nregs = numArgs + numVregs</code>\uff08\u52a8\u6001\u7248\u76f8\u540c\uff09</li> <li>\u201c\u5e26 actual args\u201d\u7248\u672c\u4f1a\u7528 <code>max(numActualArgs, method-&gt;GetNumArgs())</code> \u6269\u5c55\u53c2\u6570\u533a\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#25-freeframel766l772","title":"2.5 <code>FreeFrame</code>\uff1a\u91ca\u653e\u7b56\u7565\uff08L766\u2013L772\uff09","text":"<ul> <li>L768\u2013L772\uff1a\u901a\u8fc7 <code>ManagedThread::GetCurrent()-&gt;GetStackFrameAllocator()-&gt;Free(frame-&gt;GetExt())</code> \u91ca\u653e\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u8fd9\u610f\u5473\u7740 \u8c03\u7528\u8005\u5fc5\u987b\u4fdd\u8bc1\u8be5 frame \u662f\u4ece stack frame allocator \u5206\u914d\u5f97\u5230\u7684\u3002 \u672c\u6587\u4ef6\u4e2d <code>CreateFrameWithSize</code> \u8d70 heap manager \u7684 ext frame \u5206\u914d\uff0c\u8fd9\u7c7b frame \u7684\u91ca\u653e\u901a\u5e38\u8d70\u53e6\u4e00\u6761\u8def\u5f84\uff08\u4f8b\u5982\u89e3\u91ca\u5668 runtime interface \u5185\u90e8\u91ca\u653e\u6216\u4e13\u7528\u91ca\u653e\u5165\u53e3\uff09\u3002\u56e0\u6b64\u5728\u6392\u969c\u65f6\uff0c\u201c\u8c01\u5206\u914d\u8c01\u91ca\u653e\u201d\u662f\u7b2c\u4e00\u4f18\u5148\u7ea7\u68c0\u67e5\u70b9\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#3-entrypoints-catch-unwindl1088l1274-l1761l1827","title":"3. \u5f02\u5e38 entrypoints \u4e0e\u201c\u627e catch / unwind\u201d\u9aa8\u67b6\uff08L1088\u2013L1274, L1761\u2013L1827\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#31-throwentrypointl1088l1178","title":"3.1 \u5178\u578b\u5f02\u5e38\u5165\u53e3\uff1aThrow*Entrypoint\uff08L1088\u2013L1178\uff09","text":"<p>\u5171\u540c\u6a21\u5f0f\uff1a - <code>BEGIN_ENTRYPOINT()</code> - \u65ad\u8a00\u5f53\u524d\u65e0 pending exception - \u6784\u9020/\u8bbe\u7f6e\u5f02\u5e38\u5bf9\u8c61\uff08<code>ThrowXxxException()</code> \u6216 <code>thread-&gt;SetException(...)</code>\uff09 - <code>HandlePendingException(UnwindPolicy::SKIP_INLINED)</code></p> <p><code>SKIP_INLINED</code> \u4f53\u73b0\u7b56\u7565\uff1a\u5f02\u5e38 unwind \u65f6\u901a\u5e38\u9700\u8981\u6309\u201c\u7269\u7406\u5e27\u201d\u9000\u6808\uff0c\u4e0d\u5728\u8fd9\u91cc\u5c55\u5f00\u5185\u8054\u5e27\uff08\u5185\u8054\u7ec6\u8282\u7531 StackWalker/\u7f16\u8bd1\u5668\u4fe1\u606f\u5904\u7406\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#32-abstractmethoderrorentrypoint-method-conflict-cframe-catchl1125l1137-l1260l1274","title":"3.2 <code>AbstractMethodErrorEntrypoint</code> / method conflict\uff1a\u9700\u8981\u5904\u7406 CFrame catch\uff08L1125\u2013L1137, L1260\u2013L1274\uff09","text":"<ul> <li>\u5148\u521b\u5efa <code>StackWalker(thread, SKIP_INLINED)</code>\uff0c\u629b\u5f02\u5e38\u540e\u5982\u679c\u5f53\u524d\u5728 CFrame\uff08<code>stack.IsCFrame()</code>\uff09\uff0c\u8c03\u7528 <code>FindCatchBlockInCFrames(thread, &amp;stack, nullptr)</code>\u3002</li> </ul> <p>\u8fd9\u8bf4\u660e\uff1a\u5bf9\u4e8e\u201c\u4ece\u7f16\u8bd1\u6001\u629b\u51fa\u201d\u7684\u5f02\u5e38\uff0ccatch \u67e5\u627e\u53ef\u80fd\u5148\u5728\u7f16\u8bd1\u5e27\u4fa7\u5904\u7406\uff08CFrames\uff09\uff0c\u518d\u5fc5\u8981\u65f6\u56de\u5230\u89e3\u91ca\u5668\u4fa7\uff08IFrames\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#33-iframe-catchfindcatchblockiniframesstacklessl1761l1802","title":"3.3 IFrame \u4fa7\u627e catch\uff1a<code>FindCatchBlockInIFramesStackless</code>\uff08L1761\u2013L1802\uff09","text":"<p>\u8fd9\u662f\u201c\u89e3\u91ca\u5668\u5e27\u6808\u4e0a\u626b\u63cf\u201d\u7684\u6838\u5fc3\u9aa8\u67b6\uff1a - \u7528 <code>interpreter::RuntimeInterface::FindCatchBlock(*method, exception, inst)</code> \u67e5\u5f53\u524d method \u662f\u5426\u6709 catch\u3002 - \u82e5\u6ca1\u627e\u5230\uff1a   - \u5982\u679c\u5f53\u524d frame \u4e0d\u662f stackless \u6216\u8005 prev \u4e3a\u7a7a\u6216 prev \u662f\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\uff0c\u5219\u505c\u6b62\u5e76\u8fd4\u56de <code>pcOffset</code>\uff08\u901a\u5e38\u662f INVALID_OFFSET\uff09\u3002   - \u5426\u5219\u6267\u884c\u201c\u65b9\u6cd5\u9000\u51fa\u201d\u4e8b\u4ef6\u3001\u901a\u77e5\u3001<code>HandleReturnFrame</code>\u3001\u8bbe\u7f6e current frame\u3001\u91ca\u653e\u5f53\u524d frame\uff08<code>RuntimeInterface::FreeFrame</code>\uff09\uff0c\u7136\u540e\u7ee7\u7eed\u626b\u63cf\u4e0a\u4e00\u5e27\u3002</p> <p>\u5173\u952e\u70b9\uff1a\u8fd9\u91cc\u4f1a \u8fb9\u626b\u63cf\u8fb9\u91ca\u653e stackless frames\uff0c\u6240\u4ee5\u201cFreeFrame \u987a\u5e8f\u201d\u4e0e\u201c\u8fb9\u754c\u5e27\u8bc6\u522b\u201d\u5fc5\u987b\u6b63\u786e\uff08\u5426\u5219\u4f1a\u91ca\u653e\u9519\u3001\u6216\u8de8\u8d8a\u8fb9\u754c\u91ca\u653e\u5230\u7f16\u8bd1\u5e27\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#34-iframe-catchfindcatchblockiniframesl1804l1827","title":"3.4 IFrame \u4fa7\u627e catch\uff08\u5c01\u88c5\u7248\uff09\uff1a<code>FindCatchBlockInIFrames</code>\uff08L1804\u2013L1827\uff09","text":"<ul> <li>\u5148 <code>CHECK_STACK_WALKER</code>\uff08\u518d\u6b21\u5f3a\u8c03 entrypoints \u7684\u6808\u4e00\u81f4\u6027\u8981\u6c42\uff09\u3002</li> <li>\u8c03 <code>FindCatchBlockInIFramesStackless(...)</code> \u5f97\u5230 <code>pcOffset</code>\uff1a</li> <li>\u82e5 INVALID\uff1a\u7279\u5b9a\u67b6\u6784\u4e0b\u8c03\u7528 <code>ark::FindCatchBlockInCallStack(currThread)</code>\uff0c\u5e76\u8fd4\u56de\u539f pc\u3002</li> <li>\u5426\u5219\uff1a<ul> <li>\u628a\u5f02\u5e38\u5bf9\u8c61\u5199\u5165 <code>currFrame-&gt;GetAcc()</code>\uff08\u901a\u8fc7 LanguageContext\uff09</li> <li><code>currThread-&gt;ClearException()</code></li> <li>\u8fd4\u56de <code>instructions + pcOffset</code>\uff08\u4f5c\u4e3a\u65b0\u7684 pc\uff09</li> </ul> </li> </ul> <p>\u8fd9\u63d0\u4f9b\u4e86\u201c\u5f02\u5e38\u5bf9\u8c61\u5982\u4f55\u8fdb\u5165\u89e3\u91ca\u5668 acc \u5e76\u4ece catch \u5757\u7ee7\u7eed\u6267\u884c\u201d\u7684\u76f4\u63a5\u8bc1\u636e\u94fe\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.cpp/#4-deoptimizeentrypointcompiled-deoptl1180l1201","title":"4. <code>DeoptimizeEntrypoint</code>\uff1acompiled \u2192 deopt\uff08L1180\u2013L1201\uff09","text":"<ul> <li>L1184\u2013L1188\uff1a\u628a <code>deoptimizeType</code> \u89e3\u7801\u4e3a <code>compiler::DeoptimizeType type</code> + <code>instId</code>\uff08\u539f\u56e0\u4e0e\u6307\u4ee4 ID\uff09\u3002</li> <li>L1190\u2013L1192\uff1a\u8bb0\u5f55 deopt reason \u4e8b\u4ef6\uff08\u7528 StackWalker \u53d6\u5f53\u524d\u65b9\u6cd5\u540d\uff09\u3002</li> <li>L1194\u2013L1200\uff1a</li> <li><code>stack = StackWalker::Create(thread)</code>\uff08\u5fc5\u987b\u80fd\u5b9a\u4f4d CFrame\uff09</li> <li>\u82e5 <code>type &gt;= CAUSE_METHOD_DESTRUCTION</code>\uff1a\u53d6 top method \u4f5c\u4e3a <code>destroyMethod</code></li> <li>\u8c03 <code>Deoptimize(&amp;stack, nullptr, false, destroyMethod)</code>\uff1a\u4e0d\u4f1a\u8fd4\u56de\uff08\u8be6\u89c1 04 \u7684 <code>deoptimization.cpp</code> FileNotes\uff09\u3002</li> </ul> <p>\u8fd9\u6761\u8def\u5f84\u628a\u201c\u7f16\u8bd1\u5668\u4ea7\u751f\u7684\u53bb\u4f18\u5316\u7406\u7531\u201d\u63a5\u5165 runtime \u7684 Deoptimize \u6838\u5fc3\u5b9e\u73b0\uff0c\u662f 04 \u7ae0 deopt \u95ed\u73af\u7684\u5173\u952e\u5165\u53e3\u4e4b\u4e00\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.h/","title":"<code>runtime/entrypoints/entrypoints.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a50 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e \u201ccompiled code/\u8fd0\u884c\u65f6\u8f85\u52a9\u8def\u5f84\u53ef\u8c03\u7528\u7684\u5165\u53e3\u70b9\uff08entrypoints\uff09\u201d\uff0c\u5c24\u5176\u662f Frame \u521b\u5efa/\u91ca\u653e \u4e0e\u5c11\u91cf\u5f02\u5e38\u5165\u53e3\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.h/#0-l18l20","title":"0. \u4f9d\u8d56\uff08L18\u2013L20\uff09","text":"<ul> <li>L18\uff1a<code>entrypoints_gen.h</code>\uff1a\u7531 YAML/\u6a21\u677f\u751f\u6210\u7684 entrypoints \u5217\u8868\uff08\u5927\u91cf\u6162\u8def\u5f84\u51fd\u6570\u58f0\u660e\u5728\u751f\u6210\u6587\u4ef6\u91cc\uff09\u3002</li> <li>L19\uff1a<code>runtime/include/thread.h</code>\uff1a\u9700\u8981 <code>ManagedThread</code> \u7c7b\u578b\uff08FreeFrameInterp \u7b49\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.h/#1-frame-l25l41","title":"1. Frame \u521b\u5efa\u65cf\uff08L25\u2013L41\uff09","text":"<p>\u8fd9\u4e00\u7ec4\u662f\u201c\u89e3\u91ca\u5668\u5e27/\u6808\u5e27\u5206\u914d\u201d\u6700\u6838\u5fc3\u7684 ABI\uff1a</p> <ul> <li>L25\uff1a<code>CreateFrameWithSize(size, nregs, method, prev)</code> </li> <li>\u5178\u578b\uff1a\u521b\u5efa\u4e00\u4e2a <code>Frame</code>\uff0c\u663e\u5f0f\u6307\u5b9a\u5206\u914d size \u4e0e vreg \u6570\u91cf\u3002</li> <li>L27\u2013L28\uff1a<code>CreateFrameWithActualArgsAndSize(size, nregs, numActualArgs, method, prev)</code> </li> <li>\u5178\u578b\uff1a\u52a8\u6001\u8bed\u8a00/\u53d8\u53c2\u573a\u666f\uff08\u5b9e\u9645\u53c2\u6570\u4e2a\u6570\u53ef\u80fd\u5927\u4e8e method \u58f0\u660e\u53c2\u6570\uff09\u3002</li> <li>L30\u2013L32\uff1a<code>CreateNativeFrameWithActualArgsAndSize(...)</code>\uff08PANDA_PUBLIC_API\uff09  </li> <li>\u4e3a native \u8c03\u7528\u8def\u5f84\u51c6\u5907\u7684 frame \u521b\u5efa\uff08\u7ec6\u8282\u89c1 <code>entrypoints.cpp</code> \u7684\u5b9e\u73b0\u5206\u914d\u5668\u9009\u62e9\uff09\u3002</li> <li>L34\u2013L40\uff1a\u6309 method \u76f4\u63a5\u521b\u5efa\uff08\u9759\u6001/\u52a8\u6001\uff09\u4ee5\u53ca \u201c\u5e26 actual args\u201d \u7684\u4fbf\u6377\u5165\u53e3\uff1a</li> <li><code>CreateFrameForMethod</code> / <code>CreateFrameForMethodDyn</code></li> <li><code>CreateFrameForMethodWithActualArgs</code> / <code>...Dyn</code></li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u7684\u771f\u5b9e\u5206\u914d\u7b56\u7565\u3001ext frame \u6570\u636e\u3001\u4ee5\u53ca\u52a8\u6001\u8bed\u8a00 vreg \u521d\u59cb\u5316\uff0c\u5168\u90e8\u5728 <code>entrypoints.cpp</code> \u7ed9\u51fa\u8bc1\u636e\uff08\u89c1\u5bf9\u5e94 FileNotes\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.h/#2-frame-l42l45","title":"2. Frame \u91ca\u653e\u65cf\uff08L42\u2013L45\uff09","text":"<ul> <li>L42\uff1a<code>FreeFrame(frame)</code>\uff08PANDA_PUBLIC_API\uff09  </li> <li>\u89e3\u91ca\u5668\u6267\u884c/\u5f02\u5e38 unwind/deopt \u7b49\u5927\u91cf\u8def\u5f84\u90fd\u4f1a\u7528\u5230\uff0804 \u7ae0 bridge/deopt/FindCatchBlock \u90fd\u4f9d\u8d56\u5b83\uff09\u3002</li> <li>L44\uff1a<code>FreeFrameInterp(frame, current)</code> </li> <li>\u4e13\u95e8\u7528\u4e8e\u89e3\u91ca\u5668\u8def\u5f84\u7684\u91ca\u653e\u8f85\u52a9\uff08\u5728 <code>entrypoints.cpp</code> \u4e2d\u53ef\u770b\u5230\u4e0e <code>RuntimeInterface::FreeFrame</code> \u7684\u5173\u7cfb\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_entrypoints_entrypoints.h/#3-l46","title":"3. \u5f02\u5e38\u5165\u53e3\uff08L46\uff09","text":"<ul> <li>L46\uff1a<code>ThrowInstantiationErrorEntrypoint(Class *klass)</code> </li> <li>\u4e00\u4e2a\u201c\u4ece compiled code \u89e6\u53d1\u5f02\u5e38\u201d\u7684\u4ee3\u8868\u5165\u53e3\uff1a\u521b\u5efa\u5e76\u629b\u51fa <code>InstantiationError</code>\uff0c\u5e76\u8d70 <code>HandlePendingException</code> unwind\uff08\u5b9e\u73b0\u89c1 <code>entrypoints.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/","title":"<code>runtime/exceptions.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5f02\u5e38\u629b\u51fa + \u8de8 IFrame/CFrame \u627e catch\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a - \u5b9e\u73b0\u5404\u79cd <code>Throw*</code> \u8f85\u52a9\u51fd\u6570\uff08\u628a\u5f02\u5e38\u5bf9\u8c61\u8bbe\u7f6e\u5230 <code>thread-&gt;Exception</code>\uff0c\u5e76\u6253\u4e8b\u4ef6\uff09 - \u5b9e\u73b0 \u5f02\u5e38 unwind \u7684\u201c\u8de8\u7f16\u8bd1\u5e27\u201d\u90e8\u5206\uff1a<code>FindCatchBlockInCallStack/FindCatchBlockInCFrames/HandlePendingException</code></p> <p>\u4e0e\u89e3\u91ca\u5668\u751f\u6210\u7684 <code>EXCEPTION_HANDLER</code>\uff08<code>interpreter-inl_gen.h</code>\uff09\u5173\u7cfb\uff1a <code>EXCEPTION_HANDLER</code> \u5148\u5728 stackless IFrames \u4e2d\u627e catch\uff1b\u82e5\u627e\u4e0d\u5230\u5219 <code>return FindCatchBlockInCallStack(thread)</code>\uff0c\u628a\u8d23\u4efb\u79fb\u4ea4\u5230\u672c\u6587\u4ef6\u7684 CFrame \u904d\u5386\u903b\u8f91\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#0-l16l35","title":"0. \u5173\u952e\u4f9d\u8d56\uff08L16\u2013L35\uff09","text":"<ul> <li>L20\uff1a<code>runtime/bridge/bridge.h</code>\uff1a\u5f02\u5e38\u56de\u9000\u53ef\u80fd\u8de8\u8d8a c2i/i2c \u8fb9\u754c\u3002</li> <li>L21\uff1a<code>runtime/deoptimization.h</code>\uff1a\u5728 CFrames \u91cc\u627e\u5230 catch block \u540e\uff0c\u901a\u8fc7 <code>Deoptimize</code> \u56de\u5230\u89e3\u91ca\u5668 catch pc\u3002</li> <li>L22\uff1a<code>runtime/entrypoints/entrypoints.h</code>\uff1a\u91ca\u653e/\u521b\u5efa frame \u7b49\u5de5\u5177\u51fd\u6570\uff08\u4f8b\u5982 <code>FreeFrame</code>\uff09\u3002</li> <li>L26\uff1a<code>runtime/include/stack_walker.h</code>\uff1a\u904d\u5386 call stack\uff08IFrame/CFrame/inline\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#1-throw-l38l210","title":"1. Throw \u7cfb\u5217\uff1a\u8bed\u8a00\u4e0a\u4e0b\u6587\u9a71\u52a8\uff08L38\u2013L210\uff09","text":"<p>\u603b\u4f53\u6a21\u5f0f\uff1a</p> <ul> <li>\u83b7\u53d6 <code>thread</code> \u4e0e <code>LanguageContext</code>\uff08L44\u2013L48\uff09</li> <li><code>ThrowException(ctx, thread, descriptor, msg)</code>\uff08L38\u2013L42\uff09</li> <li>\u5bf9\u90e8\u5206\u5f02\u5e38\u6253 <code>SetExceptionEvent(type, thread)</code>\uff08\u4f8b\u5982 NPE/\u8d8a\u754c/\u7b97\u672f\u7b49\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#11-nullpointerexceptionl50l61","title":"1.1 NullPointerException\uff08L50\u2013L61\uff09","text":"<ul> <li>L50\u2013L55\uff1a\u65e0\u53c2\u7248\u672c\u4f7f\u7528\u5f53\u524d\u7ebf\u7a0b\u4e0e\u5176\u8bed\u8a00\u4e0a\u4e0b\u6587\u3002</li> <li>L57\u2013L61\uff1a\u5b9e\u9645 throw + \u4e8b\u4ef6\uff08NULL_CHECK\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#12-arrayindexoutofbounds-negativearraysize-arithmeticl69l132","title":"1.2 ArrayIndexOutOfBounds / NegativeArraySize / Arithmetic\uff08L69\u2013L132\uff09","text":"<ul> <li>\u7edf\u4e00\u7528 <code>PandaString msg</code> \u62fc\u63a5\u4e0a\u4e0b\u6587\u4fe1\u606f\uff08idx/length/size\uff09\uff0c\u4f5c\u4e3a\u5f02\u5e38 message\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#2-dropcframeifnecessaryl211l241","title":"2. <code>DropCFrameIfNecessary</code>\uff1a\u628a\u201c\u4e0d\u80fd\u7ee7\u7eed\u6267\u884c\u7684\u7f16\u8bd1\u5e27\u201d\u4e22\u6389\uff08L211\u2013L241\uff09","text":"<p>\u8be5\u51fd\u6570\u7528\u4e8e <code>FindCatchBlockInCFrames</code> \u7684\u5faa\u73af\u4e2d\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u5f3a\u5236\u9000\u51fa compiled frame\uff1a</p> <ul> <li>Next frame \u4e0d\u662f CFrame\uff08L214\u2013L222\uff09</li> <li>Next frame \u662f native cframe\uff08L224\u2013L231\uff09</li> <li>method \u662f static constructor\uff08L233\u2013L239\uff09</li> </ul> <p>\u4e09\u79cd\u60c5\u51b5\u90fd\u4f1a\uff1a</p> <ul> <li>\u91ca\u653e <code>origFrame</code>\uff08\u5982\u679c\u5b58\u5728\uff09</li> <li><code>DropCompiledFrame(stack)</code>\uff08\u6700\u7ec8\u901a\u8fc7\u6865\u63a5/\u6c47\u7f16\u628a\u5f53\u524d compiled frame \u5f39\u6389\u5e76\u8fd4\u56de\u5230 caller\uff09</li> </ul> <p>\u76f4\u89c9\uff1a\u8fd9\u4e9b frame \u7c7b\u578b\u8981\u4e48\u4e0d\u80fd\u5728\u8fd9\u91cc\u505a\u201cdeopt \u56de\u89e3\u91ca\u5668 catch\u201d\uff0c\u8981\u4e48\u9700\u8981\u6309 ABI \u6b63\u5e38\u9000\u51fa compiled \u51fd\u6570\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#3-findcatchblockincframes-compiled-catchl250l303","title":"3. <code>FindCatchBlockInCFrames</code>\uff1a\u5728 compiled \u6808\u4e0a\u641c\u7d22 catch\uff08L250\u2013L303\uff09","text":"<p>\u6838\u5fc3\u5faa\u73af\uff08L252\u2013L293\uff09\uff1a</p> <ul> <li>\u53d6 <code>pc = stack-&gt;GetBytecodePc()</code>\uff0c\u4ee5\u53ca <code>method = stack-&gt;GetMethod()</code>\u3002</li> <li>\u901a\u8fc7 <code>method-&gt;FindCatchBlock(exceptionClass, pc)</code> \u67e5\u8be2 catch offset\uff08L259\u2013L260\uff09\u3002</li> <li>\u82e5\u627e\u5230\uff1a</li> <li>\u91ca\u653e <code>origFrame</code></li> <li>\u8c03\u7528 <code>Deoptimize(stack, method-&gt;GetInstructions() + pcOffset)</code>\uff08L267\uff09\u5e76 <code>UNREACHABLE()</code>     \u8bed\u4e49\uff1a\u901a\u8fc7 deopt \u628a\u5f53\u524d compiled frame\uff08\u4ee5\u53ca\u53ef\u80fd\u7684\u5185\u8054\u4fe1\u606f\uff09\u8f6c\u6362\u4e3a\u89e3\u91ca\u5668\u5e27\uff0c\u5e76\u628a pc \u8bbe\u5230 catch block\u3002</li> <li>\u82e5\u6ca1\u627e\u5230\uff1a</li> <li><code>thread-&gt;GetVM()-&gt;HandleReturnFrame()</code>\uff1a\u901a\u77e5 VM \u6808\u56de\u9000\uff08L271\uff09</li> <li><code>DropCFrameIfNecessary(...)</code>\uff1a\u5904\u7406 \u201cnative/static ctor/\u8fb9\u754c\u201d \u7b49\u60c5\u51b5\uff08L273\uff09</li> <li>\u82e5 <code>stack-&gt;IsInlined()</code>\uff1a\u7ee7\u7eed\u5728\u540c\u4e00\u7269\u7406 frame \u7684\u4e0b\u4e00\u4e2a inline method \u4e2d\u627e\uff08L275\u2013L277\uff09</li> <li>\u5904\u7406 bypass bridge\uff08L279\u2013L292\uff09\uff1a\u5f53 boundary frame \u6307\u793a\u662f BYPASS\uff0c\u8bf4\u660e\u52a8\u6001\u8bed\u8a00\u53ef\u80fd\u505a\u4e86 c2c call\uff0c\u9700\u8981\u6b63\u786e return \u624d\u80fd\u9000\u51fa active compiled function\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#4-findcatchblockincallstack-iframe-cframe-l311l330","title":"4. <code>FindCatchBlockInCallStack</code>\uff1a\u4ece IFrame \u8fdb\u5165 CFrame \u641c\u7d22\uff08L311\u2013L330\uff09","text":"<ul> <li>L313\u2013L316\uff1a<code>stack = StackWalker::Create(thread)</code>\uff0c\u5e76\u8bfb\u53d6 <code>origFrame = stack.GetIFrame()</code>\uff1b\u65ad\u8a00\u5f53\u524d\u4e0d\u662f CFrame\u3002</li> <li>L318\u2013L320\uff1a\u82e5 <code>origFrame-&gt;IsInvoke()</code>\uff0c\u76f4\u63a5 return\uff1a   \u6ce8\u91ca\u5199\u660e\u201cException will be handled in the Method::Invoke's caller\u201d\u2014\u2014\u5373 invoke \u8fb9\u754c\u6709\u81ea\u5df1\u7684\u5f02\u5e38\u8f6c\u4ea4\u7ea6\u5b9a\u3002</li> <li>L322\u2013L327\uff1a<code>stack.NextFrame()</code> \u540e\uff0c\u82e5\u6ca1\u6709 frame / \u4e0d\u662f cframe / cframe \u662f native\uff0c\u5219 return\uff08\u4ea4\u7ed9\u66f4\u5916\u5c42\u5904\u7406\u6216 native \u6846\u67b6\u5904\u7406\uff09\u3002</li> <li>L328\u2013L329\uff1a\u901a\u77e5 VM \u56de\u9000\uff0c\u5e76\u8c03\u7528 <code>FindCatchBlockInCFrames(thread, &amp;stack, origFrame)</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_exceptions.cpp/#5-handlependingexception-compiled-pending-exceptionl449l463","title":"5. <code>HandlePendingException</code>\uff1a\u4ece compiled \u9876\u90e8\u5904\u7406 pending exception\uff08L449\u2013L463\uff09","text":"<ul> <li>L451\u2013L454\uff1a\u8981\u6c42\u5f53\u524d\u7ebf\u7a0b\u5b58\u5728 pending exception\u3002</li> <li>L457\uff1a<code>CleanupCompiledFrameResources(thread-&gt;GetCurrentFrame())</code>\uff1a\u5148\u6e05\u7406 compiled frame \u8d44\u6e90\uff08deopt/\u5f02\u5e38\u90fd\u53ef\u80fd\u9700\u8981\uff09\u3002</li> <li>L459\u2013L462\uff1a\u521b\u5efa <code>StackWalker(policy)</code>\uff0c\u65ad\u8a00\u5f53\u524d\u662f CFrame\uff0c\u7136\u540e\u76f4\u63a5 <code>FindCatchBlockInCFrames(thread, &amp;stack, nullptr)</code>\u3002</li> </ul> <p>\u8fd9\u6761\u8def\u5f84\u5e38\u51fa\u73b0\u5728\uff1a - deopt \u4e4b\u540e\u9700\u8981\u5904\u7406\u5f02\u5e38\uff08<code>runtime/deoptimization.cpp</code> \u8c03\u7528 <code>HandlePendingException()</code>\uff09 - compiled code \u629b\u5f02\u5e38\u540e\u56de\u5230 runtime \u7684 slow path</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/","title":"<code>runtime/include/compiler_interface.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a241 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 runtime \u2194 compiler \u7684\u5173\u952e ABI\uff1a 1) CompilerTask\uff1a\u7ebf\u7a0b\u6c60\u4efb\u52a1\u8f7d\u4f53\uff08method + OSR \u6807\u8bb0 + VM\uff09 2) CompilerInterface\uff1a\u7f16\u8bd1\u5668\u4fa7\u53ef\u66ff\u6362\u63a5\u53e3\uff08compile/OSR code \u7ba1\u7406\uff09 3) ExecState\uff1a\u7f16\u8bd1\u4ee3\u7801\u8c03\u7528\u65f6\u7684\u201c\u6267\u884c\u72b6\u6001\u7ed3\u6784\u4f53\u201d\uff08\u7ed9 JIT stub/\u6865\u63a5/\u8fd4\u56de\u7406\u7531\u4f7f\u7528\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#0-compilertaskl35l86","title":"0. <code>CompilerTask</code>\uff1a\u8c03\u5ea6\u5355\u5143\uff08L35\u2013L86\uff09","text":"<ul> <li>\u4fdd\u5b58 <code>Method* method_</code>\u3001<code>bool isOsr_</code>\u3001<code>PandaVM* vm_</code>\u3002</li> <li>\u53ef\u79fb\u52a8\uff08move ctor / move assign\uff09\uff0c\u4e0d\u53ef\u62f7\u8d1d\uff08NO_COPY_SEMANTIC\uff09\u3002   \u8fd9\u7b26\u5408\u201c\u4efb\u52a1\u5728\u961f\u5217\u4e2d\u79fb\u52a8\u4f46\u907f\u514d\u62f7\u8d1d\u201d\u7684\u5178\u578b\u7ebf\u7a0b\u6c60\u6a21\u578b\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#1-compilerinterfacereturnreasonl91","title":"1. <code>CompilerInterface::ReturnReason</code>\uff08L91\uff09","text":"<ul> <li><code>RET_OK</code>\uff1a\u7f16\u8bd1\u4ee3\u7801\u6b63\u5e38\u8fd4\u56de</li> <li><code>RET_DEOPTIMIZATION</code>\uff1a\u7f16\u8bd1\u4ee3\u7801\u8bf7\u6c42\u53bb\u4f18\u5316\uff08\u8fd4\u56de\u5230\u89e3\u91ca\u5668/DeoptEntrypoint\uff09</li> </ul> <p>\u8fd9\u4e0e 04 \u7684 <code>DeoptimizeEntrypoint</code> / <code>Deoptimize</code> \u95ed\u73af\u5bf9\u9f50\uff1a\u7f16\u8bd1\u4ee3\u7801\u53ef\u901a\u8fc7\u8fd4\u56de\u7406\u7531\u9a71\u52a8\u56de\u9000\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#2-execstatel93l208","title":"2. <code>ExecState</code>\uff1a\u7f16\u8bd1\u4ee3\u7801\u6267\u884c\u72b6\u6001\uff08L93\u2013L208\uff09","text":"<p><code>ExecState</code> \u662f\u4e00\u4e2a\u201c\u53ef\u88ab\u6c47\u7f16/IRTOC/JIT stub \u76f4\u63a5\u6309 offset \u8bbf\u95ee\u201d\u7684 POD-ish \u7ed3\u6784\u4f53\uff1a - L95\u2013L98\uff1a\u6784\u9020\uff1a<code>pc</code>\u3001<code>frame</code>\u3001<code>calleeMethod</code>\u3001<code>numArgs</code>\u3001<code>spFlag</code>\u3002 - L125\u2013L148\uff1a\u643a\u5e26 <code>acc_</code> \u4e0e\u53ef\u53d8\u957f <code>args_[]</code>\uff08flexible array\uff09\uff1a   - L207\uff1a<code>args_[0]</code> \u662f GNU extension \u7684 flexible array member\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#21-offsetl170l198","title":"2.1 \u4e3a\u4ec0\u4e48\u9700\u8981\u9759\u6001 offset\uff08L170\u2013L198\uff09","text":"<p>\u8fd9\u4e9b <code>GetExecState*Offset()</code> \u7528 <code>MEMBER_OFFSET</code> \u8f93\u51fa\u5b57\u6bb5\u504f\u79fb\uff1a - <code>acc_</code> offset - <code>args_</code> offset - <code>pc_</code> offset - <code>frame_</code> offset - <code>spFlag_</code> offset - <code>calleeMethod_</code> offset</p> <p>\u7528\u9014\uff1a - \u6c47\u7f16\u6865/compiled stub \u80fd\u5728\u4e0d\u7406\u89e3 C++ \u5e03\u5c40\u7ec6\u8282\u7684\u60c5\u51b5\u4e0b\u53d6\u5b57\u6bb5\uff08ABI \u7a33\u5b9a\u6027\u4f9d\u8d56\u8fd9\u4e9b offset\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#22-getsizenargsl165l168","title":"2.2 <code>GetSize(nargs)</code>\uff08L165\u2013L168\uff09","text":"<p>\u6309 <code>sizeof(ExecState) + sizeof(VRegister)*nargs</code> \u8ba1\u7b97\u5b9e\u9645\u5927\u5c0f\u3002 \u8fd9\u4e5f\u662f\u201cargs_ \u53ef\u53d8\u957f\u201d\u7684\u914d\u5957\u673a\u5236\uff1a\u8c03\u7528\u65b9\u5148\u7b97 size\uff0c\u518d\u5206\u914d ExecState buffer\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#3-compilerinterface-l214l233","title":"3. <code>CompilerInterface</code> \u7684\u6838\u5fc3\u865a\u63a5\u53e3\uff08L214\u2013L233\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#31-l214","title":"3.1 \u7f16\u8bd1\u5165\u53e3\uff08L214\uff09","text":"<ul> <li><code>CompileMethod(method, bytecodeOffset, osr, func)</code>\uff1a\u7f16\u8bd1\u666e\u901a/OSR \u65b9\u6cd5\u3002   OSR \u5728 04 \u7684 <code>osr.*</code> \u4e2d\u4f1a\u6d88\u8017 <code>CompilerInterface::GetOsrCode/SetOsrCode</code> \u7684\u7ed3\u679c\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#32-worker-l216l223","title":"3.2 Worker \u751f\u547d\u5468\u671f\uff08L216\u2013L223\uff09","text":"<ul> <li><code>JoinWorker/FinalizeWorker/PreZygoteFork/PostZygoteFork</code>\uff1a\u8fd0\u884c\u65f6\u751f\u547d\u5468\u671f\u94a9\u5b50\uff08\u591a VM/zygote \u573a\u666f\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#33-osr-code-l224l229","title":"3.3 OSR code \u7ba1\u7406\uff08L224\u2013L229\uff09","text":"<ul> <li><code>GetOsrCode</code> / <code>SetOsrCode</code> / <code>RemoveOsrCode</code>   \u4e0e 04 \u7684\uff1a</li> <li><code>PandaRuntimeInterface::TrySetOsrCode</code>\uff08\u5199\u5165 OSR code\uff09</li> <li><code>deoptimization.cpp::InvalidateCompiledEntryPoint</code>\uff08\u79fb\u9664 OSR code\uff09</li> <li><code>osr.cpp</code>\uff08OSR entry \u65f6\u8bfb\u53d6 OSR code \u5e76\u6784\u9020 CodeInfo\uff09   \u5f62\u6210\u95ed\u73af\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_compiler_interface.h/#34-jit-l230l231","title":"3.4 \u5f02\u6b65 JIT \u5f00\u5173\uff08L230\u2013L231\uff09","text":"<ul> <li><code>SetNoAsyncJit/IsNoAsyncJit</code>\uff1a\u63a7\u5236\u662f\u5426\u7981\u6b62\u5f02\u6b65 JIT\uff08\u5f71\u54cd\u7f16\u8bd1\u8c03\u5ea6\u4e0e\u53ef\u9884\u6d4b\u6027\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_exceptions.h/","title":"<code>runtime/include/exceptions.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5f02\u5e38 API \u4e0e\u8de8\u5e27\u67e5\u627e\u5165\u53e3\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49\u8fd0\u884c\u65f6\u629b\u5f02\u5e38/\u5904\u7406\u5f02\u5e38\u7684\u6838\u5fc3 API\uff0c\u5e76\u66b4\u9732\u201c\u5728 call stack \u4e2d\u5bfb\u627e catch block\u201d\u7684\u5165\u53e3\uff1a - <code>FindCatchBlockInCallStack(ManagedThread*)</code> - <code>FindCatchBlockInCFrames(...)</code> - <code>HandlePendingException(UnwindPolicy)</code></p> <p>\u8fd9\u4e9b\u51fd\u6570\u4e0e\u89e3\u91ca\u5668\u751f\u6210\u7684 <code>EXCEPTION_HANDLER</code>\uff08<code>interpreter-inl_gen.h</code>\uff09\u6784\u6210\u5f02\u5e38\u8def\u5f84\u95ed\u73af\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_exceptions.h/#0-l18l22","title":"0. \u4f9d\u8d56\uff08L18\u2013L22\uff09","text":"<ul> <li>L22\uff1a\u4f9d\u8d56 <code>runtime/include/stack_walker.h</code>\uff1a\u5f02\u5e38\u8def\u5f84\u9700\u8981\u904d\u5386 IFrame/CFrame\uff0c\u5e76\u5728\u9700\u8981\u65f6 deopt \u56de\u89e3\u91ca\u5668\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_exceptions.h/#1-l26l78","title":"1. \u629b\u5f02\u5e38\uff1a\u7edf\u4e00\u5165\u53e3\uff08L26\u2013L78\uff09","text":"<ul> <li>L26\u2013L27\uff1a<code>ThrowException(ctx, thread, name, msg)</code>\uff1a\u628a\u201c\u5f02\u5e38\u7c7b\u522b/\u6d88\u606f\u201d\u4ea4\u7ed9 <code>LanguageContext</code> \u751f\u6210\u5f02\u5e38\u5bf9\u8c61\u5e76\u8bbe\u7f6e\u5230 thread \u4e0a\u3002</li> <li>L29\u2013L36\uff1a<code>ThrowNullPointerException</code> / <code>ThrowStackOverflowException</code>\uff1a\u5e38\u89c1\u8fd0\u884c\u65f6\u9519\u8bef\u3002</li> <li>L38\u2013L49\uff1a\u8d8a\u754c\u7c7b\u5f02\u5e38\uff1a\u6570\u7ec4/\u5b57\u7b26\u4e32\u7b49\u3002</li> <li>L76\u2013L79\uff1aOOM\uff1a\u65e2\u652f\u6301\u6307\u5b9a thread\uff0c\u4e5f\u652f\u6301\u4f7f\u7528\u5f53\u524d\u7ebf\u7a0b\u3002</li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u901a\u5e38\u88ab\uff1a - \u89e3\u91ca\u5668 handler \u8c03\u7528\uff08\u4f8b\u5982 <code>interpreter-inl.h::HandleNewarr</code> \u5bf9\u8d1f size\uff09 - entrypoints\uff08\u7f16\u8bd1\u4ee3\u7801 slow path\uff09\u8c03\u7528</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_exceptions.h/#2-catch-blockl80l86","title":"2. \u201c\u627e catch block\u201d\u7684\u8de8\u5e27\u5165\u53e3\uff08L80\u2013L86\uff09","text":"<ul> <li>L80\uff1a<code>FindCatchBlockInCallStack(thread)</code>\uff1a\u5f53\u89e3\u91ca\u5668 stackless frame \u4e2d\u627e\u4e0d\u5230 catch \u65f6\uff0c\u56de\u9000\u5230\u8fd9\u4e2a\u51fd\u6570\u7ee7\u7eed\u5904\u7406\uff08\u5178\u578b\uff1a\u9700\u8981\u5728 CFrames/\u7f16\u8bd1\u5e27\u4e2d\u627e\uff09\u3002</li> <li>L82\u2013L86\uff1a<code>DropCFrameIfNecessary</code> / <code>FindCatchBlockInCFrames</code>\uff1a\u670d\u52a1\u4e8e CFrame \u904d\u5386\u4e0e\u5fc5\u8981\u7684 deopt/\u9000\u6808\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_exceptions.h/#3-pending-exception-cframe-unwindl107l108","title":"3. \u5904\u7406 pending exception\uff1a\u4ece CFrame \u5f00\u59cb unwind\uff08L107\u2013L108\uff09","text":"<ul> <li>L107\uff1a<code>HandlePendingException(UnwindPolicy policy = UnwindPolicy::ALL)</code>\uff1a\u5f53 thread \u5df2\u6709 pending exception\uff0c\u4e14\u5f53\u524d\u4f4d\u4e8e compiled \u4fa7\u65f6\uff0c\u4f7f\u7528 <code>StackWalker</code> \u4ece CFrame \u5f00\u59cb\u67e5\u627e catch\uff0c\u5e76\u5728\u627e\u5230\u65f6 deopt \u56de\u89e3\u91ca\u5668 catch pc\uff08\u5b9e\u73b0\u89c1 <code>runtime/exceptions.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/","title":"<code>runtime/include/stack_walker.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a421 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 <code>StackWalker</code> \u62bd\u8c61\uff1a\u628a\u89e3\u91ca\u5668\u5e27\uff08Frame*\uff09\u4e0e\u7f16\u8bd1\u5e27\uff08CFrame\uff09\u7edf\u4e00\u6210\u53ef\u904d\u5386\u5e8f\u5217\uff0c\u5e76\u63d0\u4f9b\u5bf9\u8c61/vreg \u904d\u5386\u80fd\u529b\uff08\u7528\u4e8e\u8c03\u8bd5/\u5f02\u5e38/GC roots/\u53bb\u4f18\u5316\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#stackwalker","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aStackWalker \u7684\u4e09\u7c7b\u5e27\u4e0e\u8fb9\u754c\u8bc6\u522b","text":"<pre><code>flowchart TD\n  A[\"StackWalker(frame_)\"] --&gt; B{\"frame_ \u662f\u4ec0\u4e48\uff1f\\nvariant&lt;Frame*, CFrame&gt;\"}\n  B --&gt;|Frame*| I[\"IFrame\uff08\u89e3\u91ca\u5668\u5e27\uff09\\nframe.h\"]\n  B --&gt;|CFrame| C[\"CFrame\uff08\u7f16\u8bd1\u5e27\uff09\\ncframe.h + code_info\"]\n  I --&gt; X{\"prev \u662f\u8fb9\u754c\u5e27\uff1f\\nIsBoundaryFrame&lt;INTERPRETER&gt;(prev)\"}\n  C --&gt; Y{\"prev \u662f\u8fb9\u754c\u5e27\uff1f\\nGetBoundaryFrameMethod&lt;COMPILER&gt;(prev)\"}\n  X --&gt;|\u662f| Z[\"\u8de8\u5230\u7f16\u8bd1\u4fa7\\nCreateCFrameForC2IBridge / CreateCFrame\"]\n  X --&gt;|\u5426| I\n  Y --&gt;|\u662f| I\n  Y --&gt;|\u5426| C</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#0-unwindpolicyl28l32","title":"0. \u5173\u952e\u7c7b\u578b\uff1a<code>UnwindPolicy</code>\uff08L28\u2013L32\uff09","text":"<ul> <li>ALL\uff1a\u904d\u5386\u5168\u90e8\u5e27\uff08\u5305\u542b\u5185\u8054\u5e27\uff09\u3002</li> <li>SKIP_INLINED\uff1a\u8df3\u8fc7\u5185\u8054\u5e27\uff08\u53ea\u770b\u201c\u7269\u7406\u5e27\u201d\uff09\u3002</li> <li>ONLY_INLINED\uff1a\u4ec5\u904d\u5386\u5355\u4e2a cframe \u5185\u7684\u5185\u8054\u5e27\uff08\u7528\u4e8e\u67d0\u4e9b\u8bca\u65ad/\u6062\u590d\u573a\u666f\uff09\u3002</li> </ul> <p>\u8fd9\u4e09\u79cd\u7b56\u7565\u5728 <code>stack_walker.cpp::NextFromCFrame()</code> \u7684\u5185\u8054\u6df1\u5ea6\u5904\u7406\u4e0a\u6709\u76f4\u63a5\u4f53\u73b0\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#1-frameaccessor-framecframe-l34l75","title":"1. <code>FrameAccessor</code>\uff1a\u7edf\u4e00 Frame*/CFrame \u7684\u8f7b\u91cf\u8bbf\u95ee\u5668\uff08L34\u2013L75\uff09","text":"<ul> <li>L37\uff1a<code>FrameVariant = variant&lt;Frame*, CFrame&gt;</code>\uff0cStackWalker \u7684 <code>frame_</code> \u5c31\u662f\u8fd9\u79cd variant\u3002</li> <li>L41\u2013L44\uff1a<code>IsValid()</code> \u7684\u5b9a\u4e49\uff1aCFrame \u4e00\u5b9a valid\uff1bIFrame \u9700\u975e\u7a7a\u3002</li> </ul> <p>\u8fd9\u4f7f\u5f97 \u201cGetNextFrame() \u8fd4\u56de\u7684\u4e0d\u662f\u88f8\u6307\u9488\u201d\u2014\u2014\u8c03\u7528\u65b9\u53ef\u6309 variant \u5904\u7406\u4e0d\u540c\u5e27\u7c7b\u578b\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#2-stackwalker-api-l78l207","title":"2. <code>StackWalker</code> \u7684\u6838\u5fc3 API \u9762\uff08L78\u2013L207\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#21-l90l103","title":"2.1 \u6784\u9020\u4e0e\u91cd\u7f6e\uff08L90\u2013L103\uff09","text":"<ul> <li>L90\u2013L92\uff1a\u5f3a\u8c03\u5fc5\u987b\u5728\u6784\u9020\u524d\u786e\u8ba4 <code>thread-&gt;IsRuntimeCallEnabled()</code>\uff0c\u5426\u5219 ctor \u91cc\u53d6 top frame \u53ef\u80fd\u5d29\u3002</li> <li>L92\uff1a<code>Create(thread, policy)</code> \u4e3a\u63a8\u8350\u5165\u53e3\uff08\u4fbf\u4e8e\u505a assert/verify\uff09\u3002</li> <li>L95\uff1a\u53ef\u7528 <code>(fp, isFrameCompiled, npc)</code> \u76f4\u63a5\u6784\u9020\uff08\u5e38\u89c1\u4e8e\u4fe1\u53f7/\u91c7\u6837\u8def\u5f84\uff09\u3002</li> <li>L102\uff1a<code>Reset(thread)</code> \u590d\u7528 walker\uff0c\u66f4\u65b0\u8d77\u70b9\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#22-l106l135","title":"2.2 \u904d\u5386\uff08L106\u2013L135\uff09","text":"<ul> <li>L106\uff1a<code>NextFrame()</code>\uff1a\u8d70\u5230\u4e0a\u4e00\u5e27\uff08\u5185\u90e8\u6309 cframe/iframe \u5206\u6d41\uff09\u3002</li> <li>L108\uff1a<code>GetMethod()</code>\uff1a\u7edf\u4e00\u83b7\u53d6\u5f53\u524d\u5e27\u7684\u65b9\u6cd5\uff1b\u5bf9 cframe \u53ef\u80fd\u9700\u8981 stackmap/inline \u4fe1\u606f\u3002</li> <li>L115\u2013L123\uff1a<code>GetBytecodePc()</code> / <code>GetNativePc()</code>\uff1a\u7edf\u4e00\u62ff bytecode PC / native PC\u3002</li> <li>L125\u2013L129\uff1a<code>GetFp()</code>\uff1a\u5bf9 cframe \u8fd4\u56de frame origin\uff1b\u5bf9 iframe \u8fd4\u56de <code>Frame*</code> \u81ea\u8eab\u5730\u5740\uff08\u4f5c\u4e3a fp\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#23-l136l152","title":"2.3 \u201c\u904d\u5386\u5bc4\u5b58\u5668/\u5bf9\u8c61\u201d\u80fd\u529b\uff08L136\u2013L152\uff09","text":"<ul> <li><code>IterateObjects</code>\uff1a\u53ea\u904d\u5386\u5bf9\u8c61\uff08GC roots/\u9a8c\u8bc1/\u8c03\u8bd5\u5e38\u7528\uff09\u3002</li> <li><code>IterateObjectsWithInfo</code> / <code>IterateVRegsWithInfo</code>\uff1a\u5e26 <code>VRegInfo</code> \u5143\u4fe1\u606f\uff08\u6765\u81ea <code>compiler::CodeInfo</code>\uff09\u3002</li> </ul> <p>\u8fd9\u5bf9\u5e94 <code>stack_walker.cpp</code> \u4e2d\uff1a - cframe\uff1a\u4ece <code>codeInfo_</code> \u53d6 vreg list + stackmap\uff0c\u7136\u540e\u8bfb\u5bc4\u5b58\u5668/\u6808\u69fd - iframe\uff1a\u4ece <code>Frame</code> \u76f4\u63a5\u62ff vregs/acc</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#3-l209l233-l318l344","title":"3. \u8fb9\u754c\u5e27\uff1a\u8de8\u89e3\u91ca\u5668/\u7f16\u8bd1\u7684\u5173\u952e\u7ea6\u5b9a\uff08L209\u2013L233, L318\u2013L344\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#31-l209l233","title":"3.1 \u5982\u4f55\u5224\u5b9a\u201c\u8fd9\u662f\u8fb9\u754c\u5e27\u201d\uff08L209\u2013L233\uff09","text":"<ul> <li>L226\u2013L233\uff1a<code>IsBoundaryFrame&lt;KIND&gt;(ptr)</code> \u7684\u5224\u5b9a\u57fa\u4e8e\u201c\u8fb9\u754c\u5e27\u7684 METHOD_SLOT \u503c\u201d\uff1a</li> <li>\u82e5 <code>KIND==INTERPRETER</code>\uff1amethod slot == <code>COMPILED_CODE_TO_INTERPRETER</code></li> <li>\u82e5 <code>KIND==COMPILER</code>\uff1amethod slot == <code>INTERPRETER_TO_COMPILED_CODE</code></li> </ul> <p>\u5173\u952e\u7406\u89e3\uff1a\u8fb9\u754c\u5e27\u5e76\u4e0d\u662f\u771f\u6b63\u7684 <code>Method*</code>\uff0c\u800c\u662f\u4e00\u4e2a\u201c\u7279\u6b8a\u6807\u8bb0\u503c\u201d\u3002 \u8fd9\u8ba9 StackWalker \u53ef\u4ee5\u4e0d\u4f9d\u8d56\u7b26\u53f7\u8868/\u8c03\u8bd5\u4fe1\u606f\uff0c\u4ec5\u901a\u8fc7\u6808\u5e03\u5c40\u5feb\u901f\u8bc6\u522b\u8fb9\u754c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#32-prevfpreturn-addressl209l216-l318l344","title":"3.2 \u4ece\u8fb9\u754c\u5e27\u63d0\u53d6 prev/fp/return address\uff08L209\u2013L216, L318\u2013L344\uff09","text":"<ul> <li>L209\u2013L216\uff1a<code>GetPrevFromBoundary&lt;KIND&gt;(ptr)</code>\uff1a\u4f9d\u8d56 <code>BoundaryFrame&lt;KIND&gt;::FP_OFFSET == 0</code> \u7684\u7ea6\u5b9a\uff08static_assert \u4fdd\u8bc1\uff09\u3002</li> <li>L318\u2013L344\uff1a<code>GetMethodFromBoundary</code> / <code>GetReturnAddressFromBoundary</code> / <code>GetCalleeStackFromBoundary</code>\uff1a\u6309\u56fa\u5b9a offset \u4ece\u8fb9\u754c\u5e27\u8bfb\u5143\u4fe1\u606f\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_include_stack_walker.h/#4-callee-saved-regs-deoptl80l88-l274l286","title":"4. callee-saved regs \u4e0e deopt\uff08L80\u2013L88, L274\u2013L286\uff09","text":"<p>StackWalker \u9700\u8981\u77e5\u9053\u201ccallee-saved regs \u5728\u6808\u4e0a\u54ea\u91cc\u201d\uff0c\u4ee5\u4fbf\uff1a - \u8bfb\u53d6/\u4fee\u6539\u7f16\u8bd1\u5e27\u7684 vregs\uff08\u7531 code info \u63cf\u8ff0\uff09 - \u751f\u6210 deopt \u9700\u8981\u7684\u5bc4\u5b58\u5668\u5feb\u7167\uff08<code>GetCalleeRegsForDeoptimize</code> \u5728 <code>.cpp</code>\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister-inl.h/","title":"<code>runtime/interpreter/acc_vregister-inl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a210 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5728\u5f00\u542f <code>PANDA_ENABLE_GLOBAL_REGISTER_VARIABLES</code> \u65f6\uff0c\u628a acc \u6620\u5c04\u5230\u201c\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u201d\uff0c\u5e76\u63d0\u4f9b\u5bf9\u5e94\u7684 <code>AccVRegisterTRef</code> \u8bed\u4e49\u64cd\u4f5c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister-inl.h/#0-acc-l23l27-l203l207","title":"0. \u4e24\u79cd acc \u5b9e\u73b0\uff08L23\u2013L27, L203\u2013L207\uff09","text":"<ul> <li>\u82e5\u542f\u7528\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\uff1a</li> <li><code>AccVRegisterT</code> \u4e0d\u662f\u5185\u5b58\u91cc\u7684 <code>AccVRegister</code>\uff0c\u800c\u662f <code>arch::regs::{GetAccValue/GetAccTag}</code> \u7684\u89c6\u56fe</li> <li>\u5426\u5219\uff1a</li> <li><code>using AccVRegisterT = AccVRegister</code>\uff08\u76f4\u63a5\u7528\u5185\u5b58\u91cc\u7684 payload+mirror\uff09</li> </ul> <p>\u8fd9\u6b63\u662f <code>interpreter.cpp</code> \u91cc\u5f3a\u8c03\u201c\u4e0d\u80fd\u968f\u610f\u5305\u542b global_reg.h\u3001\u5e76\u4e14\u8981 RESTORE_GLOBAL_REGS\u201d\u7684\u539f\u56e0\uff1aacc \u53ef\u80fd\u4e0d\u5728\u5185\u5b58\u91cc\uff0c\u800c\u5728\u5bc4\u5b58\u5668\u91cc\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister-inl.h/#1-accvregistert-valuetagl30l69","title":"1. <code>AccVRegisterT</code>\uff1a\u4ece\u5bc4\u5b58\u5668\u8bfb\u5199 value/tag\uff08L30\u2013L69\uff09","text":"<ul> <li>L45\u2013L63\uff1a<code>GetValue/SetValue/GetTag/SetTag</code> \u5168\u90e8\u59d4\u6258 <code>arch::regs::*</code>\u3002</li> <li>L33\u2013L43\uff1a\u5141\u8bb8\u4ece\u666e\u901a <code>AccVRegister</code> \u6784\u9020\uff08\u62f7\u8d1d value/tag \u5230\u5bc4\u5b58\u5668\uff09\uff0c\u5e76\u53ef\u9690\u5f0f\u8f6c\u56de <code>AccVRegister</code>\uff08\u628a\u5bc4\u5b58\u5668\u5feb\u7167\u6210\u5185\u5b58\u5bf9\u8c61\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister-inl.h/#2-accvregistertrefis_dynamicl71l201","title":"2. <code>AccVRegisterTRef&lt;IS_DYNAMIC&gt;</code>\uff1a\u7edf\u4e00\u201c\u5bf9\u8c61/\u539f\u59cb\u503c\u201d\u8bed\u4e49\uff08L71\u2013L201\uff09","text":"<p>\u8fd9\u662f\u5bf9 <code>VRegisterRef</code> \u7684\u6269\u5c55\uff0c\u6700\u91cd\u8981\u7684\u662f <code>HasObject()</code>\uff1a - \u52a8\u6001\uff08L114\u2013L117\uff09\uff1a\u628a payload \u5f53 <code>TaggedValue</code>\uff0c\u7528 <code>IsHeapObject()</code> \u5224\u65ad - \u9759\u6001\uff08L118\u2013L119\uff09\uff1a\u7528 tag==GC_OBJECT_TYPE \u5224\u65ad</p> <p>\u540c\u65f6\u63d0\u4f9b\uff1a - <code>MovePrimitive/MoveReference/Move</code>\uff1a\u5e26\u65ad\u8a00\u4fdd\u8bc1\u7c7b\u578b\u4e00\u81f4\uff08L121\u2013L145\uff09 - <code>SetPrimitive</code> \u591a\u91cd\u91cd\u8f7d\uff08L147\u2013L185\uff09 - <code>SetReference(ObjectHeader*)</code>\uff08L187\u2013L193\uff09\uff1a\u9759\u6001\u8bed\u8a00\u4f1a\u8bbe\u7f6e tag=GC_OBJECT_TYPE\uff1b\u52a8\u6001\u8bed\u8a00\u76f4\u63a5\u5199\u5165 TaggedValue raw data</p> <p>\u8fd9\u6bb5\u662f\u89e3\u91ca\u5668/\u6865\u63a5/OSR/deopt \u5bf9 acc \u64cd\u4f5c\u7684\u5171\u540c\u8bed\u4e49\u57fa\u7840\uff1a\u65e0\u8bba acc \u5728\u5185\u5b58\u8fd8\u662f\u5bc4\u5b58\u5668\uff0c\u90fd\u80fd\u7528\u540c\u4e00\u5957 API \u505a\u201c\u503c/\u5f15\u7528\u201d\u4e00\u81f4\u6027\u64cd\u4f5c\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister.h/","title":"<code>runtime/interpreter/acc_vregister.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a80 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 accumulator\uff08acc\uff09\u5bc4\u5b58\u5668\uff1apayload + tag\uff08mirror\uff09\uff0c\u5e76\u63d0\u4f9b\u9759\u6001/\u52a8\u6001\u8bed\u8a00\u4e24\u79cd <code>VRegRef</code> \u89c6\u56fe\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister.h/#1-accvregister-l25l76","title":"1. <code>AccVRegister</code> \u7684\u7ed3\u6784\uff08L25\u2013L76\uff09","text":"<ul> <li>L29\uff1aacc \u662f\u4e24\u6bb5 <code>VRegister</code>\uff1a</li> <li><code>payload_</code>\uff1a\u503c\uff08int/float/double/object pointer/raw tagged \u7b49\uff09</li> <li><code>mirror_</code>\uff1atag\uff08\u9759\u6001\u8bed\u8a00\u4f7f\u7528\uff1b\u52a8\u6001\u8bed\u8a00\u53ef\u4e0d\u4f7f\u7528\uff09</li> <li>L31\u2013L49\uff1a<code>GetValue/SetValue</code> \u53ea\u64cd\u4f5c payload\uff1b<code>GetTag/SetTag</code> \u53ea\u64cd\u4f5c mirror\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister.h/#2-asvregrefl51l61","title":"2. <code>AsVRegRef</code>\uff1a\u7edf\u4e00\u66b4\u9732\u201c\u662f\u5426\u6709\u5bf9\u8c61\u201d\u7684\u8bed\u4e49\uff08L51\u2013L61\uff09","text":"<ul> <li>\u52a8\u6001\uff08L51\u2013L55\uff09\uff1a<code>AsVRegRef&lt;true&gt;()</code> \u2192 <code>DynamicVRegisterRef(&amp;payload_)</code></li> <li>\u9759\u6001\uff08L57\u2013L61\uff09\uff1a<code>AsVRegRef&lt;false&gt;()</code> \u2192 <code>StaticVRegisterRef(&amp;payload_, &amp;mirror_)</code></li> </ul> <p>\u8fd9\u4e0e 04 \u7684 bridge/deopt/OSR \u91cc\u201c\u8bfb\u53d6 acc \u7684\u8fd4\u56de\u503c\u201d\u5206\u652f\u5b8c\u5168\u4e00\u81f4\uff1a - dynamic\uff1a\u770b TaggedValue \u662f\u5426 heap object - static\uff1a\u770b mirror \u7684 GC_OBJECT_TYPE</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_acc_vregister.h/#3-getmirroroffsetl63l66","title":"3. \u504f\u79fb\uff1a<code>GetMirrorOffset</code>\uff08L63\u2013L66\uff09","text":"<p>\u7ed9\u6c47\u7f16/IRTOC/\u8c03\u8bd5\u5de5\u5177\u63d0\u4f9b\u7a33\u5b9a offset\uff08ABI \u53cb\u597d\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_arch_macros.h/","title":"<code>runtime/interpreter/arch/macros.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cdispatch \u539f\u8bed\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u4e3a\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u63d0\u4f9b\u4e24\u7c7b\u201c\u67b6\u6784\u76f8\u5173\u5b8f\u201d\uff1a - <code>DISPATCH(table, opcode)</code>\uff1acomputed-goto \u8df3\u8f6c\u5230 handler label - <code>RESTORE_GLOBAL_REGS()</code>\uff1a\u5728\u652f\u6301\u5168\u5c40\u5bc4\u5b58\u5668\u7684\u67b6\u6784\u4e0a\u6062\u590d\u5bc4\u5b58\u5668\uff08\u4e0e <code>PANDA_ENABLE_GLOBAL_REGISTER_VARIABLES</code> \u914d\u5957\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_arch_macros.h/#1-arm64l18l21","title":"1. ARM64\uff1a\u8f6c\u53d1\u5230\u67b6\u6784\u5b9e\u73b0\uff08L18\u2013L21\uff09","text":"<ul> <li>L18\u2013L21\uff1a<code>PANDA_TARGET_ARM64</code> \u65f6\u5305\u542b <code>aarch64/macros.h</code>\u3002   \u542b\u4e49\uff1aARM64 \u7684 dispatch/\u5bc4\u5b58\u5668\u6062\u590d\u53ef\u80fd\u5305\u542b\u66f4\u5f3a\u7684\u7ea6\u675f\u6216\u6c47\u7f16\u8f85\u52a9\uff0c\u56e0\u6b64\u4e0d\u5728\u901a\u7528\u5934\u4e2d\u5c55\u5f00\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_arch_macros.h/#2-arm64l24l33","title":"2. \u975e ARM64\uff1a\u7ed9\u51fa\u901a\u7528\u5b9e\u73b0\uff08L24\u2013L33\uff09","text":"<ul> <li>L25\uff1a\u9ed8\u8ba4 <code>RESTORE_GLOBAL_REGS()</code> \u4e3a\u7a7a\uff1a\u591a\u6570\u67b6\u6784\u6ca1\u6709\u5168\u5c40\u5bc4\u5b58\u5668\u6062\u590d\u7684\u7279\u6b8a\u9700\u6c42\u3002</li> <li>L28\u2013L32\uff1a<code>DISPATCH</code> \u7684\u6838\u5fc3\uff1a</li> <li>\u4ece <code>DISPATCH_TABLE[OPCODE]</code> \u53d6\u51fa label \u5730\u5740</li> <li><code>goto *_label</code> \u76f4\u63a5\u8df3\u8f6c</li> </ul> <p>\u8fd9\u662f\u4e00\u79cd\u7ecf\u5178\u7684\u201cdirect threaded code / computed goto\u201d\u89e3\u91ca\u5668\u5b9e\u73b0\u65b9\u5f0f\uff1a \u4e3b\u5faa\u73af\u4e0d\u662f <code>switch(opcode)</code>\uff0c\u800c\u662f\u4e00\u4e2a <code>goto*</code> \u7684\u8df3\u8868\u8df3\u8f6c\u3002 \u751f\u6210\u7684 <code>ExecuteImpl</code>\uff08\u6765\u81ea <code>interpreter-inl_gen.h</code>\uff09\u6b63\u662f\u56f4\u7ed5\u8be5\u5b8f\u7ec4\u7ec7\u7684\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/","title":"<code>runtime/interpreter/frame.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cFrame layout \u4e0e FrameHandler\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a789 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49\u89e3\u91ca\u5668\u5e27 <code>Frame</code>\u3001\u4ee5\u53ca\u8bbf\u95ee vregs/acc \u7684 <code>FrameHandler</code>\uff1a - \u7ed9\u51fa \u9759\u6001/\u52a8\u6001\u8bed\u8a00\u7684\u517c\u5bb9\u5e03\u5c40\uff08payload + mirror\uff09 - \u5b9a\u4e49 deopt/OSR/stackless \u7b49\u5173\u952e flags - \u63d0\u4f9b StaticFrameHandler/DynamicFrameHandler \u7528\u7edf\u4e00 API \u8fd4\u56de <code>StaticVRegisterRef/DynamicVRegisterRef</code></p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#0-l31l66","title":"0. \u6700\u91cd\u8981\u7684\u5e03\u5c40\u6ce8\u91ca\uff08L31\u2013L66\uff09","text":"<p>\u6587\u4ef6\u5f00\u5934\u628a frame layout \u753b\u5f97\u975e\u5e38\u6e05\u695a\uff1a - \u9759\u6001\u8bed\u8a00\uff1aFrame + payload vregs[n] + mirror vregs[n]   mirror \u7684\u8d77\u70b9\u504f\u79fb = <code>nregs * sizeof(VRegister)</code>\uff08L61\u2013L63\uff09 - \u52a8\u6001\u8bed\u8a00\uff1aFrame + payload vregs[n]\uff08\u65e0 mirror\uff09</p> <p>\u5173\u952e\u7ed3\u8bba\uff08L64\u2013L66\uff09\uff1a - \u7528 <code>FrameHandler</code> \u8bbf\u95ee vregs\uff0c<code>GetVReg</code> \u8fd4\u56de <code>VRegisterRef</code>\uff08\u9759\u6001/\u52a8\u6001\u4e0d\u540c\uff09 - <code>AccVRegister</code> \u4ecd\u7136\u662f \u201cvalue+tag\u201d\uff08\u4e0e vreg \u7684 tagless \u76f8\u5bf9\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#1-flagsl74l94-l228l326","title":"1. flags\uff1a\u6267\u884c\u5f15\u64ce\u6700\u5e38\u7528\u7684\u4e0d\u53d8\u91cf\uff08L74\u2013L94, L228\u2013L326\uff09","text":"<p>\u6700\u5173\u952e\u7684\u51e0\u4e2a\uff1a - IS_DEOPTIMIZED\uff08L80\u2013L83\uff09\uff1adeopt \u540e\u7684 frame\uff0c\u7981\u6b62 OSR\uff08\u5426\u5219 deopt \u540e\u6808\u7a7a\u95f4\u672a\u91ca\u653e\u53ef\u80fd\u89e6\u53d1\u6808\u6ea2\u51fa\uff09   - <code>DisableOsr()</code> \u76f4\u63a5 <code>SetDeoptimized()</code>\uff08L283\u2013L286\uff09 - IS_STACKLESS / IS_INITOBJ / IS_INVOKE\uff1a\u7528\u4e8e stackless interpreter \u7684 unwind/\u8bed\u4e49\u4fee\u590d - IS_DYNAMIC\uff1a\u51b3\u5b9a\u662f\u5426\u5b58\u5728 mirror vregs\uff08\u5f71\u54cd <code>GetActualSize</code> \u4e0e handler \u884c\u4e3a\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#2-vreg-getallocsize-getactualsizel222l348","title":"2. \u5206\u914d\u5927\u5c0f\u4e0e\u771f\u5b9e vreg \u6570\uff1a<code>GetAllocSize</code> / <code>GetActualSize</code>\uff08L222\u2013L348\uff09","text":"<ul> <li>GetAllocSize(size, extSz)\uff08L222\u2013L226\uff09\uff1a</li> <li>\u5206\u914d <code>sizeof(Frame) + sizeof(VRegister)*size + extSz</code> \u5e76\u6309\u9ed8\u8ba4\u5e27\u5bf9\u9f50\u5bf9\u9f50</li> <li>\u6ce8\u610f\u8fd9\u91cc\u7684 <code>size</code> \u901a\u5e38\u4f20 \u201cactual vreg slots\u201d \u800c\u4e0d\u662f <code>nregs</code>\uff08\u89c1 entrypoints/runtime_interface \u7684\u8c03\u7528\uff09</li> <li>GetActualSize(nregs)\uff08L340\u2013L348\uff09\uff1a <li>dynamic\uff1aactual size = nregs</li> <li>static\uff1aactual size = nregs * 2\uff08payload + mirror\uff09</li> <p>\u8fd9\u5c31\u662f \u201c\u4e3a\u4ec0\u4e48\u9759\u6001\u8bed\u8a00 frame \u7684 nregs \u903b\u8f91\u6570\u91cf\u4e0d\u53d8\uff0c\u4f46\u5b9e\u9645\u5206\u914d\u8981\u7ffb\u500d\u201d \u7684\u6700\u76f4\u63a5\u8bc1\u636e\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#3-abi-offsetl350l405","title":"3. ABI/\u5de5\u5177\u94fe\u53cb\u597d\uff1a\u4e00\u7ec4\u7a33\u5b9a offset\uff08L350\u2013L405\uff09","text":"<p><code>GetMethodOffset/GetPrevFrameOffset/GetNumVregsOffset/GetVregsOffset/GetAccOffset/...</code> \u63d0\u4f9b stable offsets\u3002 \u8fd9\u4e9b offset \u4f1a\u88ab\uff1a - StackWalker\uff08\u8fb9\u754c\u5e27/\u6808\u904d\u5386\uff09 - \u6c47\u7f16\u6865\uff08C2I/I2C\u3001deopt/osr\uff09 - debug/\u5de5\u5177 \u76f4\u63a5\u6d88\u8d39\uff0c\u5c5e\u4e8e\u201c\u4e0d\u80fd\u8f7b\u6613\u6539\u201d\u7684 ABI \u8868\u9762\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#4-framehandlerl428l631","title":"4. <code>FrameHandler</code>\uff1a\u7edf\u4e00\u8bbf\u95ee\u63a5\u53e3\uff08L428\u2013L631\uff09","text":"<p><code>FrameHandler</code> \u662f\u5bf9 <code>Frame*</code> \u7684\u8584\u5c01\u88c5\uff0c\u63d0\u4f9b\u540c\u540d\u65b9\u6cd5\u8f6c\u53d1\uff08GetAcc/GetMethod/GetPrevFrame/flags \u7b49\uff09\uff0c\u5e76\u66b4\u9732 <code>GetVRegisters()</code>\uff1a - L623\u2013L627\uff1a<code>GetVRegisters()</code> \u901a\u8fc7 <code>frame + Frame::GetVregsOffset()</code> \u53d6 vregs \u8d77\u70b9\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#5-staticframehandler-vs-dynamicframehandlerl632l681","title":"5. <code>StaticFrameHandler</code> vs <code>DynamicFrameHandler</code>\uff08L632\u2013L681\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#51-staticpayload-mirrorl632l653","title":"5.1 Static\uff1apayload + mirror\uff08L632\u2013L653\uff09","text":"<ul> <li><code>GetVReg(i)</code> \u8fd4\u56de <code>StaticVRegisterRef(&amp;payload[i], &amp;mirror[i])</code>\uff08L636\u2013L640\uff09</li> <li>mirror \u8d77\u70b9\u5c31\u662f <code>&amp;payload[frame-&gt;GetSize()]</code>\uff08L648\u2013L652\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#52-dynamic-payloadl655l669","title":"5.2 Dynamic\uff1a\u53ea\u6709 payload\uff08L655\u2013L669\uff09","text":"<ul> <li><code>GetVReg(i)</code> \u8fd4\u56de <code>DynamicVRegisterRef(&amp;payload[i])</code></li> <li><code>GetAccAsVReg()</code> \u8fd4\u56de <code>acc.AsVRegRef&lt;true&gt;()</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#53-getframehandleris_dynamicl671l681","title":"5.3 <code>GetFrameHandler&lt;IS_DYNAMIC&gt;</code>\uff08L671\u2013L681\uff09","text":"<p>\u7f16\u8bd1\u671f\u5206\u6d3e\u5230\u9759\u6001/\u52a8\u6001 handler\uff1a\u8fd9\u4f7f\u5f97\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u53ef\u4ee5\u7528\u6a21\u677f\u53c2\u6570\u6d88\u9664\u5206\u652f\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_frame.h/#6-extframeextdatal683l702","title":"6. <code>ExtFrame&lt;ExtData&gt;</code>\uff1a\u8bed\u8a00\u6269\u5c55\u6570\u636e\u7684\u201c\u524d\u7f6e\u5e03\u5c40\u201d\uff08L683\u2013L702\uff09","text":"<p>\u6ce8\u91ca\u753b\u51fa ExtFrame \u7684\u771f\u5b9e\u5185\u5b58\u5e03\u5c40\uff1a - ExtData \u5728\u524d - Frame \u5728\u540e\uff08\u7d27\u8d34 ExtData + padding\uff09 - vregs VLA \u5728 Frame \u4e4b\u540e</p> <p>\u5e76\u7ed9\u51fa\u4ece <code>Frame*</code> \u627e\u56de\u6269\u5c55\u6570\u636e\u7684\u65b9\u6cd5\uff1a<code>ExtFrame&lt;LangSpecData&gt;::FromFrame(base_frame)-&gt;GetExtData()</code>\u3002</p> <p>\u8fd9\u4e0e 04 \u7684 <code>entrypoints.cpp::CreateFrameWithSize</code> \u4e2d \u201cextSz \u7531 LanguageContext \u63d0\u4f9b\u201d \u7684\u5b9e\u73b0\u5f62\u6210\u95ed\u73af\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/","title":"<code>runtime/interpreter/instruction_handler_base.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u89e3\u91ca\u5668\u201c\u901a\u7528\u5e95\u5ea7\u201d\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u63d0\u4f9b <code>InstructionHandlerBase&lt;RuntimeIfaceT, IS_DYNAMIC&gt;</code> \u2014\u2014 \u6240\u6709 opcode handler \u7684\u5171\u540c\u57fa\u7c7b\u3002 \u5b83\u628a <code>InstructionHandlerState</code>\uff08state/acc/inst/frame/thread/dispatchTable\uff09\u63d0\u5347\u6210\u4e00\u7ec4\u53ef\u5185\u8054\u7684\u9ad8\u9891\u64cd\u4f5c\uff1a - \u53d6/\u5199 <code>acc</code>\u3001\u8bbf\u95ee <code>FrameHandler</code> - pc \u524d\u8fdb/\u8df3\u8f6c/\u5f02\u5e38\u8df3\u8f6c\uff08\u901a\u8fc7 <code>opcodeExtension_</code>\uff09 - \u901a\u77e5/\u6253\u70b9\uff08BytecodePcChangedEvent\u3001branch/throw profiling\uff09 - safepoint \u68c0\u67e5 - hotness \u9012\u51cf\u4e0e OSR \u89e6\u53d1\uff08\u901a\u8fc7 fakeInst\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#0-includes-isa_constants_genhl19l24","title":"0. includes\uff1a\u4e3a\u4f55\u8fd9\u91cc\u8981\u5305\u542b\u751f\u6210\u7684 <code>isa_constants_gen.h</code>\uff08L19\u2013L24\uff09","text":"<ul> <li>L19\uff1a<code>&lt;isa_constants_gen.h&gt;</code>\uff1a\u7531 <code>runtime/interpreter/templates/isa_constants_gen.h.erb</code> \u751f\u6210\uff0c\u63d0\u4f9b <code>NUM_PREFIXED</code> \u7b49\u5e38\u91cf\u3002   \u8fd9\u4e9b\u5e38\u91cf\u4f1a\u5f71\u54cd dispatch table \u7684\u5e03\u5c40\u4e0e\u201c\u5f02\u5e38 handler slot\u201d\u7684\u7f16\u7801\u65b9\u5f0f\uff08\u89c1 <code>MoveToExceptionHandler</code>\uff09\u3002</li> <li>L23\uff1a<code>instruction_handler_state.h</code>\uff1a\u57fa\u7c7b\u7684\u5168\u90e8\u72b6\u6001\u6765\u6e90\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#1-log_instpc-l27l31","title":"1. <code>LOG_INST()</code>\uff1a\u7edf\u4e00\u6253\u5370\u201cpc \u5730\u5740 + \u6307\u4ee4\u540d\u201d\u524d\u7f00\uff08L27\u2013L31\uff09","text":"<ul> <li>L28\u2013L31\uff1a\u628a <code>inst.GetAddress()</code> \u6253\u5370\u6210\u5b9a\u5bbd\u5341\u516d\u8fdb\u5236\uff0c\u4f5c\u4e3a\u6240\u6709 handler <code>LOG_INST()</code> \u7684\u901a\u7528\u524d\u7f00\u3002   \u8fd9\u4e5f\u662f <code>interpreter-inl.h</code> \u4e2d\u5927\u91cf <code>LOG_INST() &lt;&lt; \"xxx\"</code> \u7684\u57fa\u7840\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#2-framehandlertl32l67","title":"2. \u5168\u5c40\u5bc4\u5b58\u5668\u4f18\u5316\u5206\u652f\uff1aFrameHandlerT\uff08L32\u2013L67\uff09","text":"<ul> <li>\u5f53\u5b9a\u4e49 <code>PANDA_ENABLE_GLOBAL_REGISTER_VARIABLES</code> \u65f6\uff1a</li> <li>L35\u2013L49\uff1a<code>StaticFrameHandlerT</code> \u4ece <code>arch::regs::GetFp()/GetMirrorFp()</code> \u76f4\u63a5\u53d6\u5bc4\u5b58\u5668\u6570\u7ec4\u6307\u9488\u3002</li> <li>L51\u2013L60\uff1a<code>DynamicFrameHandlerT</code> \u76f4\u63a5\u4ece <code>arch::regs::GetFp()</code> \u53d6 vregs\uff08\u52a8\u6001\u8bed\u8a00\u6ca1\u6709 mirror\uff09\u3002</li> <li>\u5426\u5219\uff1a</li> <li>L64\u2013L65\uff1a<code>StaticFrameHandlerT</code>/<code>DynamicFrameHandlerT</code> \u9000\u5316\u4e3a\u666e\u901a <code>StaticFrameHandler</code>/<code>DynamicFrameHandler</code>\uff08\u89c1 <code>frame.h</code>\uff09\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u201cframe layout \u662f\u6570\u636e\u7ed3\u6784\uff0c\u800c\u5bc4\u5b58\u5668\u8bbf\u95ee\u65b9\u5f0f\u53ef\u4ee5\u662f compile-time policy\u201d\u7684\u5178\u578b\u5b9e\u73b0\uff1a\u540c\u4e00\u5957 handler \u4ee3\u7801\u901a\u8fc7\u6a21\u677f\u4e0e alias \u9002\u914d\u4e0d\u540c\u6784\u5efa\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#3-instructionhandlerbase-state-apil69l220","title":"3. <code>InstructionHandlerBase</code>\uff1a\u628a state \u63d0\u5347\u4e3a\u53ef\u5185\u8054 API\uff08L69\u2013L220\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#31-opcode-l74l93","title":"3.1 opcode \u76f8\u5173\uff08L74\u2013L93\uff09","text":"<ul> <li>L74\u2013L78\uff1a<code>GetExceptionOpcode()</code>   \u8fd4\u56de\uff1a<code>primaryOpcode + opcodeExtension</code>\u3002\u6ce8\u91ca\u5f3a\u8c03\u201c\u4e5f\u8981\u8c03\u7528 GetPrimaryOpcode\uff0c\u5426\u5219\u7f16\u8bd1\u5668\u53ef\u80fd\u751f\u6210\u975e\u6700\u4f18\u4ee3\u7801\u201d\u3002   \u8fd9\u662f\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u9009\u62e9 <code>DISPATCH(table, handler.GetExceptionOpcode())</code> \u7684\u5173\u952e\u5165\u53e3\uff1a\u6b63\u5e38\u60c5\u51b5\u4e0b extension=0\uff0c\u5f02\u5e38\u60c5\u51b5\u4e0b extension \u88ab\u6539\u6210\u201c\u6307\u5411 EXCEPTION_HANDLER\u201d\u3002</li> <li>L80\u2013L93\uff1aPrimary/Secondary opcode \u4e0e validity \u6821\u9a8c\uff1a\u5168\u90fd\u4ece <code>BytecodeInstruction</code> \u6765\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#32-vreg-dumpl95l112","title":"3.2 vreg dump\uff08L95\u2013L112\uff09","text":"<ul> <li>\u4ec5\u5728 <code>PANDA_ENABLE_SLOW_DEBUG</code> \u4e14 logger \u5f00\u542f\u65f6\u6267\u884c\u3002</li> <li>L104\u2013L110\uff1a\u6253\u5370 acc \u4e0e\u6bcf\u4e2a vreg \u7684 <code>DumpVReg()</code>\uff08\u4f9d\u8d56 <code>VRegisterRef</code> \u7684\u8c03\u8bd5\u6253\u5370\u5b9e\u73b0\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#33-pc-bytecodepcchangedeventl114l131","title":"3.3 \u201cpc \u53ef\u89c2\u6d4b\u6027\u201d\uff1aBytecodePcChangedEvent\uff08L114\u2013L131\uff09","text":"<ul> <li>L114\u2013L118\uff1a<code>UpdateBytecodeOffset()</code>\uff1a\u628a\u5f53\u524d pc offset \u5199\u5165 frame\uff08<code>frame-&gt;SetBytecodeOffset(pc)</code>\uff09\u3002</li> <li>L121\u2013L131\uff1a<code>InstrumentInstruction()</code> \u7684\u5173\u952e\u8bed\u4e49\uff1a</li> <li>L123\u2013L125\uff1a\u5148\u628a acc \u5199\u56de frame\uff0c\u786e\u4fdd acc \u6210\u4e3a GC root\uff08\u5f88\u591a runtime hook \u53ef\u80fd\u89e6\u53d1 GC\uff09\u3002</li> <li>L126\u2013L127\uff1a\u89e6\u53d1 <code>BytecodePcChangedEvent(thread, method, pc)</code>\u3002</li> <li>L129\u2013L130\uff1ahook \u53ef\u80fd GC\uff0c\u56e0\u6b64\u56de\u6765\u540e\u5fc5\u987b\u628a acc \u4ece frame \u8bfb\u56de\u5230\u5bc4\u5b58\u5668\uff08\u6216 state\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#34-debugl133l138","title":"3.4 \u5f3a\u5236\u8fd4\u56de\uff08debug/\u5de5\u5177\u8def\u5f84\uff09\uff08L133\u2013L138\uff09","text":"<ul> <li>L133\u2013L138\uff1a<code>InstrumentForceReturn()</code> \u7528\u201c\u7a7a acc\u201d\u8986\u76d6 acc \u4e0e frame.acc\u3002   \u8fd9\u662f\u751f\u6210\u7684 debug \u4e3b\u5faa\u73af\u91cc\u5904\u7406 <code>ForcePop</code> \u65f6\u7684\u7b56\u7565\uff08\u89c1 <code>interpreter-inl_gen.h.erb::INSTRUMENT_FRAME_HANDLER</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#35-accvreg-l140l168","title":"3.5 acc/vreg \u89c6\u56fe\uff08L140\u2013L168\uff09","text":"<ul> <li><code>GetAcc()</code> \u76f4\u63a5\u5f15\u7528 <code>state_-&gt;GetAcc()</code>\u3002</li> <li><code>GetAccAsVReg()</code>\uff1a</li> <li>global-regs \u5f00\u542f\uff1a\u8fd4\u56de <code>AccVRegisterTRef</code>\uff0c\u672c\u8d28\u662f\u5bf9\u5168\u5c40\u5bc4\u5b58\u5668\u7684\u5f15\u7528\u5305\u88c5\u3002</li> <li>\u5426\u5219\uff1a\u9759\u6001\u8bed\u8a00\u8fd4\u56de <code>StaticVRegisterRef</code>\uff0c\u52a8\u6001\u8bed\u8a00\u8fd4\u56de <code>DynamicVRegisterRef</code>\uff08\u89c1 <code>acc_vregister.h</code>/<code>vregister.h</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#36-framehandler-l177l199","title":"3.6 FrameHandler \u89c6\u56fe\uff08L177\u2013L199\uff09","text":"<ul> <li>L177\u2013L187\uff1a<code>GetFrameHandler()</code>\uff1a\u6309 IS_DYNAMIC \u9009\u62e9 dynamic/static handler\uff08\u4ee5\u53ca global-regs \u4f18\u5316\u540e\u7684 T \u7248\u672c\uff09\u3002</li> <li>L189\u2013L199\uff1a\u540c\u540d\u91cd\u8f7d <code>GetFrameHandler(Frame*)</code>\uff1a\u7528\u4e8e\u201c\u4e3a\u65b0 frame \u5199\u5165\u53c2\u6570\u201d\u7b49\u573a\u666f\uff08\u89c1 <code>interpreter-inl.h::CopyArguments/CreateAndSetFrame</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#4-pc-l221l291","title":"4. \u63a7\u5236\u6d41\u539f\u8bed\uff1apc \u524d\u8fdb/\u8df3\u8f6c/\u5f02\u5e38\u8df3\u8f6c\uff08L221\u2013L291\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#41-l222l230","title":"4.1 \u524d\u8fdb\uff08L222\u2013L230\uff09","text":"<ul> <li><code>MoveToNextInst&lt;FORMAT, CAN_THROW&gt;()</code>\uff1a<code>inst = inst.GetNext&lt;FORMAT&gt;()</code>\u3002   \u82e5 <code>CAN_THROW==true</code>\uff0c\u5219\u628a <code>opcodeExtension</code> \u6e05\u96f6\uff1a\u4fdd\u8bc1\u201c\u5f02\u5e38\u8def\u5f84\u4e0d\u6c61\u67d3\u540e\u7eed\u6b63\u5e38 dispatch\u201d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#42-l232l250","title":"4.2 \u8df3\u8f6c\uff08L232\u2013L250\uff09","text":"<ul> <li><code>JumpToInst&lt;CAN_THROW&gt;(offset)</code>\uff1a<code>inst = inst.JumpTo(offset)</code>\u3002</li> <li><code>JumpTo&lt;CAN_THROW&gt;(pc)</code>\uff1a\u76f4\u63a5\u7528 pc \u6784\u9020 <code>BytecodeInstruction</code>\u3002</li> <li>\u540c\u6837\uff0c<code>CAN_THROW==true</code> \u4f1a\u6e05\u96f6 opcodeExtension\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#43-handlermovetoexceptionhandlerl252l256","title":"4.3 \u8fdb\u5165\u5f02\u5e38 handler\uff1a<code>MoveToExceptionHandler()</code>\uff08L252\u2013L256\uff09","text":"<ul> <li>\u6838\u5fc3\u673a\u5236\uff1a</li> <li>\u5148\u628a extension \u8bbe\u6210 <code>UINT8_MAX + NUM_PREFIXED + 1</code>\uff08\u4e00\u4e2a\u201c\u5927\u503c\u201d\uff0c\u4ee3\u8868 EXCEPTION_HANDLER \u7684\u7d22\u5f15\u57fa\u51c6\uff09\u3002</li> <li>\u518d\u51cf\u53bb primary opcode\uff1a\u4f7f\u5f97 <code>primary + extension == UINT8_MAX + NUM_PREFIXED + 1</code> \u6052\u6210\u7acb\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u201c\u5f02\u5e38\u7edf\u4e00\u5165\u53e3\u201d\u7684\u5b9e\u73b0\uff1ahandler \u4e0d\u9700\u8981\u77e5\u9053 EXCEPTION_HANDLER \u7684\u5177\u4f53 index\uff0c\u53ea\u8981\u8c03\u7528 <code>MoveToExceptionHandler()</code>\uff0c\u540e\u7eed <code>DISPATCH(table, handler.GetExceptionOpcode())</code> \u5c31\u4f1a\u843d\u5230\u5f02\u5e38 label\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#5-profiling-safepoint-hotnessosrl298l371","title":"5. profiling + safepoint + hotness/OSR\uff08L298\u2013L371\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#51-hotness-l298l303","title":"5.1 hotness \u9012\u51cf\uff08L298\u2013L303\uff09","text":"<ul> <li><code>UpdateHotness&lt;IS_CALL&gt;(method)</code>\uff1a<code>method-&gt;DecrementHotnessCounter&lt;IS_CALL&gt;(0, nullptr)</code>   \u88ab <code>interpreter-inl.h::HandleCallPrologue</code> \u8c03\u7528\uff1a\u5f53 method \u6ca1\u6709 compiled code \u65f6\uff0c\u628a\u89e3\u91ca\u5668\u6267\u884c\u6b21\u6570\u4f5c\u4e3a JIT \u89e6\u53d1\u4fe1\u53f7\u4e4b\u4e00\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#52-branchthrow-profilingl314l335","title":"5.2 branch/throw profiling\uff08L314\u2013L335\uff09","text":"<ul> <li>L314\u2013L326\uff1a<code>UpdateBranchStatistics&lt;TAKEN&gt;()</code>\uff1a\u6309 taken/not taken \u66f4\u65b0 profiling \u6570\u636e\u3002</li> <li>L328\u2013L335\uff1a<code>UpdateThrowStatistics()</code>\uff1a\u8bb0\u5f55 throw taken\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#53-osrupdatehotnessosrl337l345","title":"5.3 OSR\uff1a<code>UpdateHotnessOSR</code>\uff08L337\u2013L345\uff09","text":"<ul> <li>\u82e5 frame \u5df2 deoptimized \u6216 OSR \u88ab runtime options \u5173\u95ed\uff1a\u53ea\u505a\u666e\u901a hotness \u9012\u51cf\u5e76\u8fd4\u56de false\u3002</li> <li>\u5426\u5219\uff1a\u8c03\u7528 <code>method-&gt;DecrementHotnessCounter&lt;false&gt;(pc+offset, &amp;acc, true)</code>\uff0c\u628a\u201c\u76ee\u6807 OSR pc + \u5f53\u524d acc\u201d\u4f20\u7ed9\u8fd0\u884c\u65f6/\u7f16\u8bd1\u5668\u4fa7 OSR \u7ba1\u7ebf\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_base.h/#54-safepoint-osr-instrumentbranchesl347l371","title":"5.4 \u5206\u652f\u63d2\u6869 + safepoint + OSR \u89e6\u53d1\uff1a<code>InstrumentBranches</code>\uff08L347\u2013L371\uff09","text":"<ul> <li>L349\u2013L352\uff1a\u53ea\u6709 <code>offset &lt;= 0</code>\uff08\u5012\u8df3/\u56de\u8fb9\uff09\u624d\u8fdb\u884c\u63d2\u6869\u3002   \u8fd9\u628a\u201c\u5faa\u73af\u56de\u8fb9\u201d\u4f5c\u4e3a OSR \u89e6\u53d1\u70b9\u3002</li> <li>L353\u2013L358\uff1a<code>TestAllFlags()</code> \u2192 <code>RuntimeIfaceT::Safepoint()</code>\uff1a\u5728\u56de\u8fb9\u5904\u505a safepoint \u68c0\u67e5\uff08\u5e76\u4ee5 frame.acc \u4fdd\u62a4 GC root\uff09\u3002</li> <li>L359\u2013L366\uff1a\u5982\u679c\u67b6\u6784\u652f\u6301 OSR\uff0c\u4e14 <code>UpdateHotnessOSR(...)</code> \u8fd4\u56de true\uff1a</li> <li>L363\u2013L365\uff1a\u628a <code>fakeInstBuf_[0]</code> \u5199\u6210 <code>RETURN_VOID</code> opcode\uff0c\u5e76\u628a inst \u6307\u5230 fake buffer\u3002  </li> <li>\u8bed\u4e49\uff1a\u5f3a\u5236\u8d70\u201creturn handler\u201d\u7684\u8def\u5f84\uff0c\u4f7f\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u9000\u51fa\uff0c\u7136\u540e\u8f6c\u5165 OSR \u5165\u53e3\uff08OSR \u5165\u53e3\u901a\u5e38\u5728 compiled code/\u6865\u63a5\u5c42\u5b8c\u6210\uff09\u3002</li> <li>L367\u2013L370\uff1a\u82e5\u4e0d\u652f\u6301 OSR\uff0c\u5219\u9000\u5316\u4e3a\u666e\u901a hotness \u66f4\u65b0\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/","title":"<code>runtime/interpreter/instruction_handler_state.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u628a <code>State</code>\uff08<code>runtime/interpreter/state.h</code>\uff09\u5c01\u88c5\u6210 InstructionHandler \u53cb\u597d \u7684\u201c\u5c0f\u72b6\u6001\u673a\u5bf9\u8c61\u201d\uff0c\u5e76\u8865\u5145\uff1a - <code>opcodeExtension_</code>\uff1a\u7528\u4e8e prefix/\u5f02\u5e38\u8def\u5f84\u7684\u4e8c\u7ea7\u7d22\u5f15 - <code>fakeInstBuf_</code>\uff1a\u7528\u4e8e\u201c\u4f2a\u9020\u6307\u4ee4\u201d\uff08OSR/\u7279\u6b8a\u63a7\u5236\u6d41\uff09\u7684\u5c0f\u7f13\u51b2</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#0-l19l21","title":"0. \u4f9d\u8d56\u4e0e\u8fb9\u754c\uff08L19\u2013L21\uff09","text":"<ul> <li>L19\uff1a\u4f9d\u8d56 <code>runtime/interpreter/state.h</code>\uff1a\u771f\u5b9e\u4fdd\u5b58 <code>thread/frame/inst/dispatchTable</code> \u4e0e\uff08\u53ef\u9009\uff09\u5168\u5c40\u5bc4\u5b58\u5668\u4fdd\u5b58/\u6062\u590d\u3002</li> <li>L20\uff1a\u4f9d\u8d56 <code>runtime/jit/profiling_data.h</code>\uff1a\u5e76\u975e\u76f4\u63a5\u4f7f\u7528\uff0c\u800c\u662f\u8868\u660e state \u4f1a\u88ab profiling/OSR \u76f8\u5173\u903b\u8f91\u6d88\u8d39\uff08\u89c1 <code>instruction_handler_base.h</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#1-l27l31","title":"1. \u6784\u9020\uff1a\u628a\u56db\u5143\u7ec4\u5c01\u88c5\u6210\u53ef\u4f20\u9012\u72b6\u6001\uff08L27\u2013L31\uff09","text":"<ul> <li>L27\u2013L29\uff1a<code>InstructionHandlerState(thread, pc, frame, dispatchTable)</code> \u76f4\u63a5\u6784\u9020\u5185\u90e8 <code>State state_</code>\u3002   \u8fd9\u4e5f\u662f\u751f\u6210\u7684\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\uff08<code>interpreter-inl_gen.h</code>\uff09\u521b\u5efa handler \u65f6\u4f20\u5165\u7684\u552f\u4e00\u201c\u4e0a\u4e0b\u6587\u5bf9\u8c61\u201d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#2-api-frame-pcl33l36","title":"2. \u201c\u72b6\u6001\u66f4\u65b0\u201dAPI\uff1a\u8fd4\u56de\u5230\u4e0a\u5c42 frame / \u5207\u6362 pc\uff08L33\u2013L36\uff09","text":"<ul> <li>L33\u2013L36\uff1a<code>UpdateInstructionHandlerState(pc, frame)</code> \u2192 <code>state_.UpdateState(pc, frame)</code>   \u5178\u578b\u573a\u666f\uff1a</li> <li>stackless \u8c03\u7528\u8fd4\u56de\uff1a\u56de\u5230 caller \u7684 frame + bytecode pc\uff08\u89c1 <code>interpreter-inl.h::HandleReturnStackless</code> \u4e0e <code>FindCatchBlockStackless</code>\uff09\u3002</li> <li>\u8fdb\u5165 catch block\uff1a\u628a pc \u5207\u5230 <code>method-&gt;GetInstructions() + pcOffset</code>\uff08\u89c1\u751f\u6210\u7684 <code>EXCEPTION_HANDLER</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#3-gettersetterl38l81","title":"3. \u201c\u53ea\u8f6c\u53d1\u201d\u7684\u6838\u5fc3 getter/setter\uff08L38\u2013L81\uff09","text":"<p>\u8fd9\u4e9b\u63a5\u53e3\u5168\u90e8\u76f4\u63a5\u8f6c\u53d1\u5230\u5e95\u5c42 <code>State</code>\uff1a</p> <ul> <li>L38\u2013L46\uff1athread getter/setter</li> <li>L48\u2013L51\uff1a<code>SetInst(BytecodeInstruction)</code></li> <li>L53\u2013L61\uff1aframe getter/setter</li> <li>L63\u2013L71\uff1adispatch table getter/setter</li> <li>L73\u2013L81\uff1a<code>SaveState/RestoreState</code>   \u5f53\u542f\u7528 <code>PANDA_ENABLE_GLOBAL_REGISTER_VARIABLES</code> \u65f6\uff0c<code>State</code> \u7684 save/restore \u624d\u662f\u771f\u6b63\u201c\u628a\u5168\u5c40\u5bc4\u5b58\u5668\u5f71\u5b50\u5199\u56de frame / \u4ece frame \u8bfb\u56de\u5bc4\u5b58\u5668\u201d\u7684\u5173\u952e\u70b9\uff08\u8be6\u89c1 <code>runtime/interpreter/state.h</code> \u7684 FileNotes\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#4-opcode-primarysecondary-validityl93l106","title":"4. opcode \u76f8\u5173\uff1aPrimary/Secondary + validity\uff08L93\u2013L106\uff09","text":"<ul> <li>L93\u2013L101\uff1a<code>GetPrimaryOpcode</code> / <code>GetSecondaryOpcode</code>\uff1a\u628a <code>BytecodeInstruction</code> \u5185\u90e8\u679a\u4e3e\u503c mask \u5230 8bit\uff08<code>OPCODE_MASK=0xFF</code>\uff09\u3002</li> <li>L103\u2013L106\uff1a<code>IsPrimaryOpcodeValid()</code>\uff1a\u8f6c\u53d1\u5230\u5e95\u5c42 <code>BytecodeInstruction</code> \u7684\u6821\u9a8c\u903b\u8f91\u3002   \u751f\u6210\u7684 dispatch \u4e3b\u5faa\u73af\u4f1a\u5728\u5173\u952e\u4f4d\u7f6e\u65ad\u8a00\u5b83\u6210\u7acb\uff08\u5c24\u5176\u662f quickenedFlag=false \u65f6\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#5-accpc-l108l131","title":"5. acc/pc \u504f\u79fb\uff1a\u89e3\u91ca\u5668\u7684\u4e24\u4e2a\u201c\u5168\u5c40\u89c6\u89d2\u201d\uff08L108\u2013L131\uff09","text":"<ul> <li>L108\u2013L121\uff1a<code>GetInst()</code>\u3001<code>GetAcc()</code>\uff1a\u628a\u201c\u5f53\u524d\u6307\u4ee4/accumulator\u201d\u4f5c\u4e3a handler \u7684\u4e2d\u5fc3\u89c2\u5bdf\u70b9\u66b4\u9732\u51fa\u53bb\u3002</li> <li>L128\u2013L131\uff1a<code>GetBytecodeOffset()</code>\uff1a\u4ee5 <code>inst.address - frame.instructionBase</code> \u7684\u5f62\u5f0f\u8ba1\u7b97 pc offset\u3002   \u8fd9\u662f\uff1a</li> <li>profiling\uff08branch/throw\uff09\u6253\u70b9\u7684 key</li> <li>\u89e3\u6790\u7f13\u5b58\uff08ResolveMethod/Field/Type\uff09\u4e0e\u901a\u77e5\uff08BytecodePcChangedEvent\uff09\u6240\u9700\u7684\u201c\u5f53\u524d\u6267\u884c\u70b9\u201d</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#6-fakeinstbuf_l123l140","title":"6. <code>fakeInstBuf_</code>\uff1a\u4f2a\u9020\u6307\u4ee4\u5165\u53e3\uff08L123\u2013L140\uff09","text":"<ul> <li>L123\u2013L126\uff1a\u66b4\u9732 <code>fakeInstBuf_</code> \u7684\u5f15\u7528\u3002   \u5178\u578b\u7528\u9014\uff1a<code>instruction_handler_base.h::InstrumentBranches</code> \u5728 OSR \u89e6\u53d1\u65f6\u5199\u5165 <code>RETURN_VOID</code> opcode\uff0c\u5e76\u628a\u5f53\u524d inst \u6307\u5411 fake buffer\uff0c\u4ee5\u5f3a\u5236\u201c\u9000\u51fa\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u5e76\u8df3\u5230 OSR \u5165\u53e3\u201d\uff08\u7ec6\u8282\u89c1\u5bf9\u5e94 FileNotes\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_instruction_handler_state.h/#7-opcodeextension_prefixl83l91-l139","title":"7. <code>opcodeExtension_</code>\uff1aprefix/\u5f02\u5e38\u8def\u5f84\u7684\u4e8c\u7ea7\u7d22\u5f15\uff08L83\u2013L91, L139\uff09","text":"<ul> <li>L83\u2013L91\uff1agetter/setter</li> <li>L139\uff1a\u9ed8\u8ba4 0\u3002 <code>opcodeExtension_</code> \u7684\u8bed\u4e49\u6765\u81ea <code>instruction_handler_base.h::MoveToExceptionHandler()</code>\uff1a\u5b83\u4f1a\u628a extension \u8bbe\u7f6e\u6210\u4e00\u4e2a\u201c\u4f7f <code>GetExceptionOpcode()</code> \u6307\u5411 EXCEPTION_HANDLER slot\u201d\u7684\u503c\uff0c\u4ece\u800c\u5728\u4e0b\u4e00\u6b21 <code>DISPATCH(table, handler.GetExceptionOpcode())</code> \u65f6\u7edf\u4e00\u8fdb\u5165\u5f02\u5e38\u5904\u7406 label\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/","title":"<code>runtime/interpreter/interpreter-inl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5copcode handlers \u4e0e stackless \u8c03\u7528\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u63d0\u4f9b\u89e3\u91ca\u5668 \u6307\u4ee4\u8bed\u4e49\u5b9e\u73b0\uff08handlers\uff09 \u4e0e\u82e5\u5e72\u9ad8\u9891 helper\u3002 \u6ce8\u610f\uff1a\u89e3\u91ca\u5668\u7684\u201c\u4e3b\u5faa\u73af\uff08dispatch table + computed goto\uff09\u201d\u5e76\u4e0d\u5728\u672c\u6587\u4ef6\u91cc\uff0c\u800c\u662f\u7531 <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u751f\u6210\u5230 <code>interpreter-inl_gen.h</code>\uff08\u89c1 <code>interpreter_impl.cpp</code> \u7684 <code>#include \"interpreter-inl_gen.h\"</code>\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#0-includes-bridgeruntime_interfacejit-profilingl30l62","title":"0. includes\uff1a\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4f1a\u5305\u542b bridge/runtime_interface/jit profiling\uff08L30\u2013L62\uff09","text":"<p>\u8fd9\u4e00\u7ec4 include \u76f4\u63a5\u66b4\u9732\u4e86\u672c\u6587\u4ef6\u5728\u6267\u884c\u5f15\u64ce\u4e2d\u7684\u4ea4\u53c9\u70b9\uff1a</p> <ul> <li>L39\uff1a<code>runtime/bridge/bridge.h</code>\uff1a<code>CallCompiledCode()</code> \u901a\u8fc7 i2c bridge \u8df3\u5230 compiled entrypoint\uff08\u89c1 L3571\u2013L3597\uff09\u3002</li> <li>L57\uff1a<code>runtime/interpreter/runtime_interface.h</code>\uff1a\u5927\u91cf Resolve/Throw/CreateObject/CreateArray/FindCatchBlock \u7b49\u90fd\u901a\u8fc7 <code>RuntimeIfaceT</code> \u95f4\u63a5\u8c03\u7528 runtime\u3002</li> <li>L59\uff1a<code>runtime/jit/profiling_data.h</code>\uff1a\u5206\u652f\u7edf\u8ba1/inline cache \u66f4\u65b0/OSR hotness \u7b49\u9700\u8981 profiling data\uff08\u89c1 HandleVirtualCall/UpdateBranchStatistics \u7b49\uff09\u3002</li> <li>L63\uff08\u6ce8\u91ca\uff09\uff1a\u5f3a\u8c03 handlers \u5fc5\u987b <code>ALWAYS_INLINE</code>\uff1a\u914d\u5408\u751f\u6210\u7684 dispatch \u4e3b\u5faa\u73af\uff0c\u907f\u514d handler \u8c03\u7528\u5f00\u9500\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#1-l67l73","title":"1. \u89e3\u91ca\u5668\u6a21\u677f\u5165\u53e3\u58f0\u660e\uff08L67\u2013L73\uff09","text":"<ul> <li>L67\u2013L73\uff1a\u58f0\u660e <code>ExecuteImpl/ExecuteImplDebug/ExecuteImplInner</code> \u6a21\u677f\u3002   \u771f\u6b63\u7684 <code>ExecuteImpl/ExecuteImplDebug</code> \u5b9a\u4e49\u6765\u81ea\u751f\u6210\u5934 <code>interpreter-inl_gen.h</code>\uff1b\u672c\u6587\u4ef6\u672b\u5c3e\u53ea\u5b9e\u73b0\u4e86 <code>ExecuteImplInner</code> \u7684 \u201cstub \u8c03\u7528\u5668\u201d\uff08\u89c1 L4133\u2013L4140\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#2-framehelperdefaultl75l97","title":"2. <code>FrameHelperDefault</code>\uff1a\u628a\u201c\u5efa\u5e27\u7b56\u7565\u201d\u53c2\u6570\u5316\uff08L75\u2013L97\uff09","text":"<ul> <li>L77\u2013L82\uff1a<code>GetNumberActualArgsDyn</code>\uff1a\u52a8\u6001\u8bed\u8a00 call \u6307\u4ee4\u91cc <code>imm + 1</code>\uff08+1 \u8868\u793a function object \u81ea\u8eab\uff09\u3002</li> <li>L91\u2013L96\uff1a<code>CreateFrame(...)</code>\uff1a\u7edf\u4e00\u7528 <code>RuntimeIfaceT::CreateFrameWithActualArgsAndSize(...)</code> \u521b\u5efa frame\u3002   \u8fd9\u8ba9 <code>InstructionHandler</code> \u7684 call handler \u4e0d\u9700\u8981\u5173\u5fc3\u4e0d\u540c runtime \u7684 frame \u5206\u914d\u7ec6\u8282\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a\u89e3\u91ca\u5668\u628a \u201cframe \u5206\u914d/\u62f7\u53c2\u201d \u505a\u6210\u53ef\u66ff\u6362\u7b56\u7565\uff08FrameHelper\uff09\uff0c\u800c\u4e0d\u662f\u628a runtime \u7ec6\u8282\u786c\u7f16\u7801\u5230\u6bcf\u6761 call \u6307\u4ee4\u91cc\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#3-instructionhandler-opcode-l99l4131","title":"3. <code>InstructionHandler</code>\uff1a\u6240\u6709 opcode \u7684\u8bed\u4e49\u5b9e\u73b0\u4f53\uff08L99\u2013L4131\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#31-movldastal132l377","title":"3.1 \u57fa\u672c\u6570\u636e\u642c\u8fd0\uff1amov/lda/sta\uff08\u793a\u4f8b\uff1aL132\u2013L377\uff09","text":"<p>\u5178\u578b\u6a21\u5f0f\uff08\u4ee5 <code>mov/lda/sta</code> \u4e3a\u4f8b\uff09\uff1a</p> <ul> <li>\u8bfb vreg \u7f16\u53f7\uff1a<code>inst.GetVReg&lt;FORMAT, idx&gt;()</code></li> <li>\u901a\u8fc7 <code>FrameHandler</code> \u8bfb/\u5199 vreg\uff1a<code>GetFrameHandler().GetVReg(i)</code></li> <li>\u901a\u8fc7 <code>AccVRegister</code> \u8bfb/\u5199 acc\uff1a<code>GetAcc()/GetAccAsVReg()</code></li> <li>\u5b8c\u6210\u540e <code>MoveToNextInst&lt;FORMAT, CAN_THROW&gt;()</code>\uff08CAN_THROW \u51b3\u5b9a\u662f\u5426\u6e05 <code>opcodeExtension</code>\uff09</li> </ul> <p>\u793a\u4f8b\uff1a</p> <ul> <li>L133\u2013L141\uff1a<code>HandleMov</code>\uff1aprimitive move\uff08\u9759\u6001\u8bed\u4e49\uff09\u3002</li> <li>L155\u2013L163\uff1a<code>HandleMovObj</code>\uff1areference move\u3002</li> <li>L166\u2013L174\uff1a<code>HandleMovDyn</code>\uff1a\u52a8\u6001\u8bed\u4e49 move\uff08tagged value\uff09\u3002</li> <li>L226\u2013L249\uff1a<code>HandleLda/LdaWide/LdaObj</code>\uff1a\u4ece vreg \u8bfb\u5230 acc\u3002</li> <li>L343\u2013L377\uff1a<code>HandleSta/StaWide/StaObj/StaDyn</code>\uff1a\u4ece acc \u5199\u56de vreg\uff08\u52a8\u6001\u7528 <code>Move(...)</code> \u4fdd\u7559 tag\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#32-osr-jmpcond-jmpl379l459","title":"3.2 \u5206\u652f\u4e0e OSR \u89e6\u53d1\u70b9\uff1a<code>jmp/cond jmp</code>\uff08\u793a\u4f8b\uff1aL379\u2013L459 &amp; \u66f4\u9760\u540e\u7684\u4f4d\u7f6e\uff09","text":"<ul> <li>L379\u2013L387\uff1a<code>HandleJmp</code>\uff1a\u5bf9 offset \u8c03 <code>InstrumentBranches(offset)</code>\u3002   \u82e5\u8fd4\u56de false \u2192 <code>JumpToInst(offset)</code>\uff1b\u82e5\u8fd4\u56de true \u2192 \u8bf4\u660e\u5728\u56de\u8fb9\u89e6\u53d1\u4e86 OSR\uff08\u57fa\u7c7b\u4f1a\u4f2a\u9020 <code>RETURN_VOID</code> \u6307\u4ee4\u4f7f\u4e3b\u5faa\u73af\u9000\u51fa\uff09\u3002</li> <li>\u6761\u4ef6\u8df3\u8f6c\uff08\u4f8b\u5982 L438\u2013L457\uff09\u540c\u7406\uff1a\u5728 taken \u5206\u652f\u53ef\u80fd\u8c03\u7528 <code>InstrumentBranches</code>\u3002</li> </ul> <p>\u8fd9\u628a OSR \u4e0e safepoint \u68c0\u67e5\u5929\u7136\u7ed1\u5b9a\u5230\u201c\u56de\u8fb9/\u5faa\u73af\u201d\uff0c\u662f\u89e3\u91ca\u5668\u5e38\u89c1\u7684 OSR \u89e6\u53d1\u7b56\u7565\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#33-null-check-resolve-barrierl2000l2053-l2369l2532-l3121l3203","title":"3.3 \u5bf9\u8c61/\u6570\u7ec4/\u5b57\u6bb5\uff1anull check + Resolve + barrier\uff08\u793a\u4f8b\uff1aL2000\u2013L2053, L2369\u2013L2532, L3121\u2013L3203\uff09","text":"<p>\u8fd9\u4e9b handler \u7684\u5171\u540c\u7ed3\u6784\uff1a</p> <ul> <li>\u53d6\u5bf9\u8c61/\u6570\u7ec4\u5f15\u7528\uff0c\u82e5\u4e3a null\uff1a\u8c03\u7528 <code>RuntimeIfaceT::ThrowNullPointerException()</code> \u5e76 <code>MoveToExceptionHandler()</code>\u3002</li> <li>\u89e3\u6790 <code>Field/Method/Class</code>\uff1a\u901a\u8fc7 <code>ResolveField/ResolveMethod/ResolveType</code>\uff08\u5185\u90e8\u5e26 interpreter cache\uff09\u3002</li> <li>\u6267\u884c\u8bfb/\u5199\uff1a</li> <li>\u539f\u59cb\u5b57\u6bb5\uff1a<code>GetFieldPrimitive/SetFieldPrimitive</code></li> <li>\u5f15\u7528\u5b57\u6bb5\uff1a<code>GetFieldObject/SetFieldObject&lt;NEED_{READ,WRITE}_BARRIER&gt;</code></li> <li>\u6570\u7ec4\uff1a<code>array-&gt;Get/Set&lt;..., NEED_WRITE_BARRIER&gt;</code></li> </ul> <p>\u793a\u4f8b\uff1a</p> <ul> <li>L2000\u2013L2028\uff1a<code>newarr</code>\uff1asize&lt;0 \u2192 NegativeArraySize\uff1b<code>ResolveType&lt;true&gt;</code>\uff08\u53ef\u80fd\u89e6\u53d1\u7c7b\u521d\u59cb\u5316\uff09\uff1b<code>RuntimeIfaceT::CreateArray</code>\uff1b\u5931\u8d25\u8fdb\u5165\u5f02\u5e38 handler\u3002</li> <li>L2031\u2013L2053\uff1a<code>newobj</code>\uff1a<code>ResolveType&lt;true&gt;</code>\uff1b<code>RuntimeIfaceT::CreateObject</code>\u3002</li> <li>L2369\u2013L2386\uff1a<code>stobj.v.64</code>\uff1a\u5148 NPE \u68c0\u67e5\uff0c\u518d <code>ResolveField</code>\uff0c\u518d <code>StorePrimitiveFieldReg(...)</code>\u3002</li> <li>L2418\u2013L2473\uff1a<code>ldstatic*</code>\uff1a<code>ResolveField&lt;true&gt;</code> + <code>GetClass(field)</code>\uff08\u65ad\u8a00\u7c7b\u5df2 initialized/initializing\uff09+ \u8bfb\u9759\u6001\u5b57\u6bb5\u3002</li> <li>L3121\u2013L3203\uff1a\u6570\u7ec4 load/store \u7684\u7edf\u4e00\u68c0\u67e5\uff1a</li> <li><code>CheckLoadArrayOp/CheckStoreArrayOp</code>\uff1aNPE + bounds +\uff08\u5bf9\u8c61\u6570\u7ec4\uff09ArrayStoreException</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#34-resolvemethodresolvefieldresolvetypel3210l3281","title":"3.4 \u89e3\u91ca\u5668\u89e3\u6790\u7f13\u5b58\uff1a<code>ResolveMethod/ResolveField/ResolveType</code>\uff08L3210\u2013L3281\uff09","text":"<p>\u8fd9\u7ec4\u51fd\u6570\u662f\u201c\u89e3\u91ca\u5668\u6027\u80fd\u201d\u7684\u5173\u952e\uff1a</p> <ul> <li>\u4ee5 <code>(instAddress, currentMethod)</code> \u4e3a key \u67e5\u8be2 <code>thread-&gt;GetInterpreterCache()</code>\uff08L3214\u2013L3218, L3235\u2013L3239, L3261\u2013L3266\uff09\u3002</li> <li>\u5728\u53ef\u80fd\u89e6\u53d1 runtime/GC \u7684 Resolve \u8c03\u7528\u524d\uff0c\u628a acc \u5199\u56de frame\uff08L3220, L3246, L3268\uff09\uff0c\u8c03\u7528\u540e\u518d\u4ece frame \u6062\u590d acc\uff08L3222, L3248, L3271\uff09\u3002   \u8fd9\u662f\u4e3a\u4e86\u4fdd\u8bc1 acc \u5728 GC \u65f6\u53ef\u8fbe\uff0c\u4ee5\u53ca\u4fdd\u6301\u5168\u5c40\u5bc4\u5b58\u5668/\u72b6\u6001\u4e00\u81f4\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#35-vs-i2c-l3470l3610","title":"3.5 \u8c03\u7528\u8def\u5f84\uff1a\u89e3\u91ca\u5668\u5185\u8c03\u7528 vs i2c \u8df3\u8f6c\uff08\u6838\u5fc3\uff1aL3470\u2013L3610\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#351-createandsetframel3470l3516","title":"3.5.1 \u5efa\u5e27\u4e0e\u62f7\u53c2\uff1a<code>CreateAndSetFrame</code>\uff08L3470\u2013L3516\uff09","text":"<ul> <li>\u8ba1\u7b97 <code>nregs</code> \u4e0e <code>numActualArgs</code>\uff08\u52a8\u6001\u8bed\u8a00\u4f1a\u53d6 <code>max(declaredArgs, actualArgs)</code>\uff09\u3002</li> <li>\u8c03 <code>FrameHelper::CreateFrame(...)</code> \u5206\u914d frame\uff1b\u82e5\u4e3a null \u5219 throw StackOverflow \u5e76\u8df3\u5f02\u5e38 handler\uff08L3497\u2013L3502\uff09\u3002</li> <li>\u628a caller acc \u5199\u5230\u65b0 frame\uff08L3505\uff09\uff0c\u52a8\u6001\u8bed\u8a00\u6807\u8bb0 <code>frame-&gt;SetDynamic()</code>\uff08L3506\u2013L3508\uff09\u3002</li> <li><code>CopyArguments(...)</code>\uff1a\u628a call \u6307\u4ee4\u643a\u5e26\u7684 vregs/acc \u6309\u683c\u5f0f\u642c\u5230 callee frame \u53c2\u6570\u533a\uff08L3510\u2013L3512\uff09\u3002</li> <li><code>RuntimeIfaceT::SetCurrentFrame(current, *frame)</code>\uff08L3513\uff09\uff1a\u5207\u6362\u5f53\u524d\u89e3\u91ca\u5668 frame\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#352-call-handlecallprologuel3518l3536","title":"3.5.2 Call \u524d\u7f6e\uff1a<code>HandleCallPrologue</code>\uff08L3518\u2013L3536\uff09","text":"<ul> <li>\u8bb0\u5f55 method entry \u65e5\u5fd7\u3002</li> <li>\u56de\u8fb9 safepoint \u68c0\u67e5\uff1a<code>TestAllFlags()</code> \u65f6\u628a acc \u5199\u56de frame\uff0c\u8c03\u7528 <code>RuntimeIfaceT::Safepoint()</code>\uff0c\u518d\u6062\u590d acc\uff08L3528\u2013L3532\uff09\u3002</li> <li>\u82e5 method \u6ca1\u6709 compiled code\uff1a<code>UpdateHotness&lt;true&gt;(method)</code>\uff08L3533\u2013L3535\uff09\uff0c\u4e3a JIT/OSR \u89e6\u53d1\u63d0\u4f9b\u7edf\u8ba1\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#353-stackless-callinterpreterstacklessl3538l3569","title":"3.5.3 \u89e3\u91ca\u5668 stackless \u8c03\u7528\uff1a<code>CallInterpreterStackless</code>\uff08L3538\u2013L3569\uff09","text":"<ul> <li>\u521b\u5efa\u65b0 frame \u5e76\u6807\u8bb0 <code>frame-&gt;SetStackless()</code>\uff08L3553\uff09\u3002</li> <li><code>INITOBJ</code> \u7279\u6b8a\uff1a</li> <li><code>frame-&gt;SetInitobj()</code>\uff08L3554\u2013L3556\uff09</li> <li>\u52a8\u6001\u8bed\u8a00\u4e0b\u8fd8\u4f1a <code>frame-&gt;DisableOsr()</code>\uff08L3557\u2013L3560\uff09\uff1a\u6ce8\u91ca\u8bf4\u660e <code>return.*</code> \u5bf9 INITOBJ frame \u6709\u7279\u6b8a\u903b\u8f91\uff0c\u56e0\u6b64\u7981\u7528 OSR \u907f\u514d\u72b6\u6001\u8f6c\u79fb\u590d\u6742\u5316\u3002</li> <li>\u66f4\u65b0 <code>InstructionHandlerState</code>\uff08pc=callee instructions\uff09\u5e76\u89e6\u53d1 <code>EVENT_METHOD_ENTER</code>\uff08L3566\u2013L3569\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#354-i2ccallcompiledcodel3571l3597","title":"3.5.4 i2c\uff1a<code>CallCompiledCode</code>\uff08L3571\u2013L3597\uff09","text":"<ul> <li>\u628a acc \u5199\u56de caller frame\uff08L3574\uff09\u540e\u8c03\u7528\uff1a</li> <li>\u52a8\u6001\uff1a<code>InterpreterToCompiledCodeBridgeDyn(...)</code></li> <li>\u9759\u6001\uff1a<code>InterpreterToCompiledCodeBridge(...)</code></li> <li>bridge \u8fd4\u56de\u540e\u6062\u590d thread \u72b6\u6001\uff1a</li> <li><code>SetCurrentFrameIsCompiled(false)</code></li> <li><code>SetCurrentFrame(this-&gt;GetFrame())</code>\uff08L3582\u2013L3584\uff09</li> <li>\u82e5\u6709 pending exception \u2192 <code>MoveToExceptionHandler()</code>\uff1b\u5426\u5219\u628a acc \u4ece frame \u53d6\u56de\u5e76 <code>MoveToNextInst&lt;FORMAT, true&gt;()</code>\uff08L3585\u2013L3590\uff09\u3002</li> </ul> <p>\u8fd9\u6bb5\u628a \u201c\u89e3\u91ca\u5668 \u2194 \u7f16\u8bd1\u4ee3\u7801\u201d \u7684 ABI/\u72b6\u6001\u5207\u6362\u5199\u5f97\u975e\u5e38\u6e05\u6670\uff1a\u89e3\u91ca\u5668\u5728\u8fb9\u754c\u5904\u5fc5\u987b\u628a acc/frame \u5199\u56de\u3001\u6062\u590d\uff0c\u5e76\u628a\u5f02\u5e38\u7edf\u4e00\u8f6c\u5165\u5f02\u5e38 handler label\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#36-return-return-vs-stackless-returnl2534l2606","title":"3.6 return\uff1a\u666e\u901a return vs stackless return\uff08L2534\u2013L2606\uff09","text":"<ul> <li>L2534\u2013L2559\uff1a<code>return/return.64/return.obj/return.void</code> \u53ea\u8d1f\u8d23\u628a\u8fd4\u56de\u503c\u5199\u5165 <code>frame-&gt;acc</code>\uff08\u6216\u4e0d\u5199\uff09\uff0c\u5e76\u4e0d\u8d1f\u8d23\u5f39\u6808\u3002   \u201c\u5f39\u6808/\u8fd4\u56de\u5230 caller\u201d\u7531\u751f\u6210\u7684\u4e3b\u5faa\u73af\u5728\u8bc6\u522b\u5230 return \u6307\u4ee4\u540e\u51b3\u5b9a\u662f\u5426 <code>return</code> \u6216\u7ee7\u7eed dispatch\uff08\u89c1 <code>interpreter-inl_gen.h.erb</code> \u7684 return \u5206\u652f\uff09\u3002</li> <li>L2561\u2013L2601\uff1a<code>HandleReturnStackless()</code> \u624d\u662f stackless frame \u7684\u201c\u5f39\u6808\u5b9e\u73b0\u201d\uff1a</li> <li>\u53d1 method exit event\uff08L2571\u2013L2577\uff09</li> <li><code>UpdateInstructionHandlerState(prevPc, prevFrame)</code>\uff08L2578\u2013L2580\uff09</li> <li>\u6062\u590d dispatch table\u3001<code>SetCurrentFrame(prev)</code>\uff08L2582\u2013L2584\uff09</li> <li>\u82e5\u6709\u5f02\u5e38\uff1a<code>MoveToExceptionHandler()</code>\uff1b\u5426\u5219\u628a acc \u4ece callee frame \u4f20\u56de\u5e76\u6062\u590d inst\uff08L2585\u2013L2590\uff09</li> <li>INITOBJ \u7279\u5224\uff1a\u9759\u6001\u8bed\u8a00\u4e0b\u82e5 callee \u662f initobj\uff0c\u5219 acc \u53d6 <code>prev-&gt;acc</code>\uff08L2592\u2013L2596\uff09</li> <li><code>RuntimeIfaceT::FreeFrame(thread, frame)</code>\uff08L2598\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#37-throw-catchstackless-iframe-unwindl2834l2894","title":"3.7 throw + \u627e catch\uff1astackless IFrame \u5185 unwind\uff08L2834\u2013L2894\uff09","text":"<ul> <li>L2834\u2013L2851\uff1a<code>HandleThrow</code>\uff1a\u628a\u5f02\u5e38\u5bf9\u8c61\u5199\u5165 <code>thread-&gt;SetException(exception)</code>\uff0c\u66f4\u65b0 throw profiling\uff0c\u7136\u540e <code>MoveToExceptionHandler()</code>\u3002</li> <li>L2853\u2013L2894\uff1a<code>FindCatchBlockStackless()</code>\uff1a</li> <li>\u5bf9\u5f53\u524d stackless frame \u8c03 <code>FindCatchBlock(exception, pc)</code>\uff08\u6700\u7ec8\u8d70 <code>RuntimeIfaceT::FindCatchBlock</code>\uff0c\u89c1 L2901\u2013L2905\uff09\u3002</li> <li>\u82e5\u627e\u5230\uff0c\u8fd4\u56de <code>pcOffset</code>\uff08catch block offset\uff09\u3002</li> <li>\u82e5\u6ca1\u627e\u5230\uff1a<ul> <li>\u5f53 frame \u4e0d\u662f stackless / \u6ca1\u6709 prev / prev \u662f boundary frame\uff08L2867\u2013L2869\uff09\uff0c\u76f4\u63a5\u8fd4\u56de INVALID_OFFSET\uff08\u4ea4\u7ed9\u66f4\u5916\u5c42\uff0c\u5373 <code>FindCatchBlockInCallStack</code>\uff09\u3002</li> <li>\u5426\u5219\uff1a\u53d1 method exit event\uff0c\u66f4\u65b0 state \u5230 prev frame \u7684 pc\uff0c\u5e76 <code>FreeFrame(frame)</code>\uff0c\u7ee7\u7eed\u5411\u4e0a\u627e\uff08L2872\u2013L2892\uff09\u3002</li> </ul> </li> </ul> <p>\u8fd9\u4e0e\u751f\u6210\u6587\u4ef6\u7684 <code>EXCEPTION_HANDLER</code> \u7cbe\u786e\u5bf9\u63a5\uff1a \u5148 <code>FindCatchBlockStackless()</code>\uff08\u53ea\u5904\u7406 stackless IFrames\uff09\uff0c\u82e5 INVALID \u5219 <code>return FindCatchBlockInCallStack(thread)</code> \u8fdb\u5165 <code>runtime/exceptions.cpp</code> \u7684 CFrame \u641c\u7d22\u4e0e deopt \u56de\u9000\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter-inl.h/#4-executeimplinner-stub-executeimpll4133l4140","title":"4. \u6587\u4ef6\u5c3e\u90e8\uff1a<code>ExecuteImplInner</code> \u901a\u8fc7 stub \u8c03\u7528\u751f\u6210\u7684 <code>ExecuteImpl</code>\uff08L4133\u2013L4140\uff09","text":"<ul> <li>L4133\uff1a\u58f0\u660e <code>extern \"C\" ExecuteImplStub(thread, pc, frame, jumpToEh, impl)</code>\u3002</li> <li>L4138\u2013L4139\uff1a\u628a\u6a21\u677f\u51fd\u6570\u5730\u5740 <code>&amp;ExecuteImpl&lt;...&gt;</code> \u5f53\u4f5c <code>void* impl</code> \u4f20\u5165 stub\u3002   \u542b\u4e49\uff1a<code>ExecuteImplStub</code> \u53ef\u80fd\u662f\u4e3a\u4e86 ABI/\u8c03\u7528\u7ea6\u5b9a/\u6c47\u7f16\u6865\u63a5\u800c\u5b58\u5728\uff08\u4f8b\u5982\u7edf\u4e00\u5bc4\u5b58\u5668\u4fdd\u5b58/\u6062\u590d\uff09\uff0c\u4ece\u800c\u628a\u771f\u6b63\u7684 C++ \u4e3b\u5faa\u73af\u5305\u88c5\u5728\u4e00\u4e2a\u56fa\u5b9a\u7b7e\u540d\u7684\u5165\u53e3\u4e2d\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.cpp/","title":"<code>runtime/interpreter/interpreter.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a41 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u89e3\u91ca\u5668\u5165\u53e3\u7684\u201c\u8584\u5c01\u88c5\u201d\uff1a\u8c03\u7528 <code>ExecuteImpl</code>\uff0c\u5e76\u5728\u8fd4\u56de\u524d\u6062\u590d\u5168\u5c40\u5bc4\u5b58\u5668\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.cpp/#0-abil21l23","title":"0. ABI/\u5bc4\u5b58\u5668\u7ea6\u675f\uff08L21\u2013L23\uff09","text":"<ul> <li>L21\u2013L23\uff1a\u9632\u6b62\u8bef\u5305\u542b <code>arch/global_reg.h</code>\uff1a   \u6ce8\u91ca/<code>#error</code> \u660e\u786e\u6307\u51fa\u8be5\u5934\u4f1a\u7834\u574f ABI\u3002\u8fd9\u4e2a\u7ea6\u675f\u4e0e <code>RESTORE_GLOBAL_REGS()</code> \u7684\u5b58\u5728\u662f\u540c\u4e00\u7c7b\u95ee\u9898\uff1a\u89e3\u91ca\u5668\u6267\u884c\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u4f7f\u7528\u201c\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u201d\uff0c\u5fc5\u987b\u4e25\u683c\u63a7\u5236 ABI \u53d8\u5316\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.cpp/#1-executel27l31","title":"1. <code>Execute</code>\uff1a\u8c03\u7528\u5b9e\u73b0\u5e76\u6062\u590d\u5bc4\u5b58\u5668\uff08L27\u2013L31\uff09","text":"<ul> <li>L29\uff1a<code>ExecuteImpl(thread, pc, frame, jumpToEh)</code>\uff1a\u628a\u5b9e\u9645\u903b\u8f91\u4e0b\u6c89\u5230 <code>interpreter_impl.cpp</code>\u3002</li> <li>L30\uff1a<code>RESTORE_GLOBAL_REGS()</code>\uff1a\u6062\u590d\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\uff08\u82e5\u5f00\u542f\uff09\u5230\u8c03\u7528\u65b9\u671f\u671b\u72b6\u6001\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a<code>Execute</code> \u7684\u804c\u8d23\u4e0d\u662f\u6267\u884c\u5faa\u73af\uff0c\u800c\u662f\u201c\u8df3\u5230\u771f\u6b63\u5b9e\u73b0 + \u505a ABI \u6e05\u7406\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.cpp/#2-framegetinstroffset-l35l40","title":"2. <code>Frame::GetInstrOffset</code> \u7684\u5185\u8054\u5b9e\u73b0\uff08L35\u2013L40\uff09","text":"<ul> <li>L36\u2013L39\uff1a<code>Frame::GetInstrOffset()</code> \u8fd4\u56de <code>method_-&gt;GetInstructions()</code>\u3002   \u8fd9\u5728 <code>compiler_interface.h::ExecState::GetMethodInst()</code> \u4e0e\u4e00\u4e9b\u6865\u63a5/\u8c03\u8bd5\u8def\u5f84\u91cc\u4f1a\u88ab\u6d88\u8d39\uff0c\u7528\u6765\u628a frame \u7684 bytecode \u504f\u79fb\u8f6c\u6210\u771f\u5b9e\u6307\u4ee4\u5730\u5740\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.h/","title":"<code>runtime/interpreter/interpreter.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a29 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e\u89e3\u91ca\u5668\u5165\u53e3 <code>interpreter::Execute(...)</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter.h/#_1","title":"\u5173\u952e\u70b9","text":"<ul> <li>L20\u2013L22\uff1a\u4f9d\u8d56 <code>thread.h</code> \u4e0e <code>frame.h</code>\uff1a\u89e3\u91ca\u5668\u5165\u53e3\u4ee5 <code>ManagedThread*</code> \u4e0e <code>Frame*</code> \u4e3a\u57fa\u672c\u4e0a\u4e0b\u6587\u3002</li> <li>L25\uff1a<code>Execute(thread, pc, frame, jumpToEh=false)</code>\uff1a</li> <li><code>pc</code>\uff1a\u672c\u6b21\u89e3\u91ca\u6267\u884c\u7684\u8d77\u59cb\u5b57\u8282\u7801\u5730\u5740</li> <li><code>frame</code>\uff1a\u89e3\u91ca\u5668\u5e27\uff08\u627f\u8f7d vregs/acc/prev \u94fe\uff09</li> <li><code>jumpToEh</code>\uff1a\u7528\u4e8e\u201c\u76f4\u63a5\u8df3\u5165\u5f02\u5e38\u5904\u7406\u8def\u5f84\u201d\u7684\u63a7\u5236\u4f4d\uff08\u5728 deopt/\u5f02\u5e38 unwind \u573a\u666f\u4e2d\u4f1a\u7528\u5230\uff0c\u8be6\u89c1 <code>interpreter_impl.cpp</code> \u7684\u8c03\u7528\u94fe\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/","title":"<code>runtime/interpreter/interpreter_impl.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a207 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u89e3\u91ca\u5668\u771f\u5b9e\u5165\u53e3\uff1a 1) \u6839\u636e runtime options/\u6784\u5efa\u914d\u7f6e\u9009\u62e9\u89e3\u91ca\u5668\u5b9e\u73b0\uff08CPP / IRTOC / LLVM\uff09 2) \u8fdb\u5165 <code>ExecuteImplInner&lt;RuntimeInterface,...&gt;</code> \u4e3b\u5faa\u73af\uff08\u5728 <code>interpreter-inl.h</code> / \u751f\u6210\u6587\u4ef6\u4e2d\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#1-l18l35","title":"1. \u89e3\u91ca\u5668\u201c\u591a\u5b9e\u73b0\u201d\u5165\u53e3\uff08L18\u2013L35\uff09","text":"<ul> <li>L19\uff1a\u5305\u542b <code>interpreter-inl.h</code>\uff1a\u4e3b\u5faa\u73af\u4e0e\u5927\u91cf handler \u90fd\u5728 inl \u4e2d\u3002</li> <li>L21\u2013L34\uff1a\u5728\u4e0d\u540c\u914d\u7f6e\u4e0b\u58f0\u660e fast path \u6267\u884c\u5165\u53e3\uff1a</li> <li>IRTOC\uff1a<code>ExecuteImplFast</code> / <code>ExecuteImplFastEH</code></li> <li>LLVM\uff1a<code>ExecuteImplFast_LLVM</code> / <code>...EH_LLVM</code></li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u7b7e\u540d\u662f <code>extern \"C\" void *(void*,void*,void*,void*)</code> \u98ce\u683c\uff1a\u5178\u578b \u201c\u6c47\u7f16/\u751f\u6210\u4ee3\u7801 ABI\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#2-getinterpretertypefromruntimeoptionsl42l77","title":"2. <code>GetInterpreterTypeFromRuntimeOptions</code>\uff1a\u8fd0\u884c\u65f6\u9009\u62e9\u7b56\u7565\uff08L42\u2013L77\uff09","text":"<ul> <li>\u9ed8\u8ba4\u662f <code>CPP</code>\uff08L44\uff09\u3002</li> <li>\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4\u5f3a\u5236 CPP\uff0c\u9664\u975e\u7528\u6237\u663e\u5f0f\u8bbe\u7f6e\u4e86 <code>--interpreter-type</code>\uff08L46\u2013L48\uff09\u3002   \u8fd9\u4e0e \u201c\u52a8\u6001\u8bed\u8a00 GC/Profiler \u7ea6\u675f\u66f4\u5f3a\u201d \u7684\u903b\u8f91\u5bf9\u9f50\uff08\u89c1 4.2 \u975e ARM32 \u4e0b\u7684\u9009\u578b\u4e0e\u7ea6\u675f\uff1adynamic + fast interpreter \u4f1a\u89e6\u53d1 GC/profiler \u7684\u786c\u9650\u5236\uff09\u3002</li> <li>\u82e5\u7528\u6237\u672a\u8bbe\u7f6e\u4e14\u6784\u5efa\u4e0d\u652f\u6301\u67d0\u5b9e\u73b0\uff0c\u4f1a\u505a\u964d\u7ea7\uff1a</li> <li>\u672a\u542f\u7528 LLVM\uff1aLLVM \u2192 IRTOC\uff08L57\u2013L61\uff09</li> <li>\u672a\u542f\u7528 IRTOC\uff1aIRTOC \u2192 CPP\uff08L69\u2013L73\uff09</li> <li>ARK_HYBRID \u4e0b\uff1aCMC GC \u573a\u666f\u5bf9 LLVM \u6709\u989d\u5916\u964d\u7ea7/\u9650\u5236\uff08L62\u2013L68\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#3-executeimpltypel81l118","title":"3. <code>ExecuteImplType</code>\uff1a\u6309\u7c7b\u578b\u5206\u6d41\uff08L81\u2013L118\uff09","text":"<ul> <li>LLVM \u5206\u652f\uff08L84\u2013L95\uff09\uff1a</li> <li>Setup LLVM dispatch table</li> <li>jumpToEh \u9009\u62e9 EH \u7248\u672c</li> <li>\u6784\u5efa\u672a\u542f\u7528 LLVM \u65f6\u76f4\u63a5 FATAL</li> <li>IRTOC \u5206\u652f\uff08L96\u2013L107\uff09\uff1a</li> <li>Setup IRTOC dispatch table</li> <li>jumpToEh \u9009\u62e9 EH \u7248\u672c</li> <li>\u6784\u5efa\u672a\u542f\u7528 IRTOC \u65f6 FATAL</li> <li>CPP \u5206\u652f\uff08L108\u2013L117\uff09\uff1a</li> <li>\u52a8\u6001\u8bed\u8a00\uff1a\u6839\u636e <code>IsBytecodeProfilingEnabled()</code> \u9009\u62e9\u6a21\u677f\u53c2\u6570\uff08<code>ExecuteImplInner&lt;RuntimeInterface,true,profiling&gt;</code>\uff09</li> <li>\u9759\u6001\u8bed\u8a00\uff1a<code>ExecuteImplInner&lt;RuntimeInterface,false&gt;</code></li> </ul> <p>\u7ed3\u8bba\uff1aCPP \u89e3\u91ca\u5668\u7684\u201c\u4e3b\u5faa\u73af\u6a21\u677f\u5b9e\u4f8b\u5316\u201d\u7531 <code>RuntimeInterface</code> + \u662f\u5426 dynamic + \u662f\u5426 profiling \u4e09\u5143\u7ec4\u51b3\u5b9a\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#4-executeimpll121l162","title":"4. <code>ExecuteImpl</code>\uff1a\u6267\u884c\u524d\u7f6e\u68c0\u67e5\u4e0e\u9650\u5236\uff08L121\u2013L162\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#41-frame-instructions-l123l124","title":"4.1 frame \u7684 instructions \u57fa\u5740\uff08L123\u2013L124\uff09","text":"<ul> <li><code>inst = frame-&gt;GetMethod()-&gt;GetInstructions()</code>\uff0c<code>frame-&gt;SetInstruction(inst)</code>\uff1a\u628a method \u7684 bytecode base \u7f13\u5b58\u8fdb frame\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#42-arm32-l126l160","title":"4.2 \u975e ARM32 \u4e0b\u7684\u9009\u578b\u4e0e\u7ea6\u675f\uff08L126\u2013L160\uff09","text":"<ul> <li>ARM32 \u5f3a\u5236 CPP\uff08\u6ce8\u91ca\uff1aIRTOC \u4e0d\u53ef\u7528\uff09\u3002</li> <li>\u82e5\u9009\u62e9\u4e86\u975e CPP\uff1a</li> <li>debug-mode \u53ea\u652f\u6301 CPP\uff08L129\u2013L132\uff09\u3002</li> <li>\u975e ARK_HYBRID \u4e0b\uff1a<ul> <li>\u52a8\u6001\u8bed\u8a00\u8981\u6c42 G1 GC\uff0c\u5426\u5219 fatal\uff08L141\u2013L147\uff09\u3002</li> <li>profiler enabled \u65f6\u63d0\u793a dynamic profiling \u88ab\u7981\u7528\uff08L147\u2013L149\uff09\u3002</li> </ul> </li> <li>ARK_HYBRID \u4e0b\uff1a<ul> <li>CMC GC \u4e0e LLVM/IRTOC \u7684\u652f\u6301\u77e9\u9635\u6709\u989d\u5916\u9650\u5236\uff08L134\u2013L158\uff09\u3002</li> </ul> </li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#43-l161","title":"4.3 \u771f\u6b63\u6267\u884c\uff08L161\uff09","text":"<ul> <li><code>ExecuteImplType(interpreterType, thread, pc, frame, jumpToEh)</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.cpp/#5-instructionhandlerbasedebugdumpl166l205","title":"5. \u8c03\u8bd5\u8f85\u52a9\uff1a<code>InstructionHandlerBase::DebugDump</code>\uff08L166\u2013L205\uff09","text":"<p>\u63d0\u4f9b\u5728 debug \u4e0b\u6253\u5370\uff1a - method \u57fa\u672c\u4fe1\u606f\uff08nargs/nregs/framesize\uff09 - acc \u4e0e\u6bcf\u4e2a vreg \u7684 DumpVReg - bytecode \u6307\u4ee4\u6d41\uff0c\u5e76\u6807\u51fa\u5f53\u524d inst</p> <p>\u8fd9\u6bb5\u5bf9\u6392\u969c\u5f88\u6709\u7528\uff1a\u5f53 opcode \u884c\u4e3a\u5f02\u5e38\u6216 vreg/acc \u9519\u4e71\u65f6\uff0c\u5b83\u63d0\u4f9b\u201c\u53ef\u89c1\u5316\u201d\u7684\u6700\u5c0f\u5de5\u5177\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.h/","title":"<code>runtime/interpreter/interpreter_impl.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a29 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e <code>ExecuteImpl(...)</code>\uff08\u89e3\u91ca\u5668\u771f\u5b9e\u6267\u884c\u5165\u53e3\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_interpreter_impl.h/#_1","title":"\u5173\u952e\u70b9","text":"<ul> <li>L25\uff1a<code>ExecuteImpl(thread, pc, frame, jumpToEh=false)</code>   \u4e0e <code>Execute</code> \u540c\u7b7e\u540d\uff1b\u533a\u522b\u5728\u4e8e\uff1a</li> <li><code>Execute</code> \u662f ABI/\u5bc4\u5b58\u5668\u5c01\u88c5\u5c42</li> <li><code>ExecuteImpl</code> \u624d\u8d1f\u8d23\u9009\u62e9\u89e3\u91ca\u5668\u7c7b\u578b\uff08CPP/IRTOC/LLVM\uff09\u5e76\u8fdb\u5165\u4e3b\u5faa\u73af\uff08\u89c1 <code>interpreter_impl.cpp</code>\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/","title":"<code>runtime/interpreter/runtime_interface.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6267\u884c\u5f15\u64ce\u76f8\u5173 API\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a346 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u89e3\u91ca\u5668\u4f7f\u7528\u7684\u201c\u8fd0\u884c\u65f6\u63a5\u53e3\u201d\uff08<code>RuntimeInterface</code>\uff09\uff1a\u628a\u7c7b\u52a0\u8f7d/\u89e3\u6790\u3001\u5bf9\u8c61\u5206\u914d\u3001\u5f02\u5e38\u3001\u5e27\u521b\u5efa/\u91ca\u653e\u3001safepoint \u7b49\u8fd0\u884c\u65f6\u80fd\u529b\u4ee5\u9759\u6001\u51fd\u6570\u5f62\u5f0f\u66b4\u9732\u7ed9 <code>ExecuteImplInner</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#runtimeinterface","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aRuntimeInterface \u5728\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u4e2d\u7684\u4f4d\u7f6e","text":"<pre><code>flowchart TD\n  INT[\"ExecuteImplInner&lt;RuntimeInterface,...&gt;\\n(interpreter-inl.h)\"] --&gt; RI[\"RuntimeInterface\\n(runtime_interface.h)\"]\n  RI --&gt; CL[\"ClassLinker\\n(03 \u7ae0)\"]\n  RI --&gt; EP[\"entrypoints\\n(04 \u7ae0)\"]\n  RI --&gt; VM[\"PandaVM/GC/TLAB\"]\n  RI --&gt; EX[\"exceptions + FindCatchBlock\"]\n  RI --&gt; SP[\"Safepoint/Thread suspension\"]</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#1-resolveinitialize-03-classlinkerl41l122","title":"1. Resolve/Initialize\uff1a\u65b9\u6cd5/\u5b57\u6bb5/\u7c7b\u89e3\u6790\u90fd\u8d70 03 \u7ae0 ClassLinker\uff08L41\u2013L122\uff09","text":"<p>\u5178\u578b\u6a21\u5f0f\uff08\u4ee5 ResolveMethod/ResolveField/ResolveClass \u4e3a\u4ee3\u8868\uff09\uff1a - \u5148\u628a bytecode \u7684 index\uff08BytecodeId\uff09\u901a\u8fc7 caller \u7684 class \u89e3\u6790\u6210\u771f\u5b9e EntityId\uff08<code>Resolve*Index</code>\uff09 - \u8c03 <code>ClassLinker::GetMethod/GetField/GetClass</code> - \u82e5\u9700\u8981\uff0c\u68c0\u67e5\u5e76 <code>InitializeClass(thread, klass)</code> - \u5931\u8d25\u65f6\u8fd4\u56de nullptr\uff08\u7531\u4e0a\u5c42 handler \u8d1f\u8d23\u629b\u5f02\u5e38\u6216\u8fdb\u5165\u6162\u8def\u5f84\uff09</p> <p>\u8fd9\u5c31\u662f 03\u219204 \u7684\u6700\u91cd\u8981\u6d88\u8d39\u5173\u7cfb\uff1a\u89e3\u91ca\u5668\u7684\u201c\u89e3\u6790/\u521d\u59cb\u5316\u201d\u5b8c\u5168\u59d4\u6258 ClassLinker\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#2-jit-hotness-threshold-enable-flagl129l137","title":"2. JIT \u89e6\u53d1\u4fe1\u606f\uff1ahotness threshold / enable flag\uff08L129\u2013L137\uff09","text":"<ul> <li><code>GetCompilerHotnessThreshold</code> / <code>IsCompilerEnableJit</code>\uff1a\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u5728\u70ed\u70b9\u70b9\uff08\u5e38\u89c1\u662f\u56de\u8fb9/\u8c03\u7528\u70b9\uff09\u4f1a\u7528\u8fd9\u4e9b\u5f00\u5173\u51b3\u5b9a\u662f\u5426\u89e6\u53d1\u7f16\u8bd1\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#3-tlab-fast-path-slow-pathl149l182","title":"3. \u5bf9\u8c61/\u6570\u7ec4\u5206\u914d\uff1aTLAB fast path + slow path\uff08L149\u2013L182\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#31-createarrayl149l152","title":"3.1 \u6570\u7ec4\uff1a<code>CreateArray</code>\uff08L149\u2013L152\uff09","text":"<p>\u76f4\u63a5\u59d4\u6258 <code>coretypes::Array::Create</code>\uff08\u5931\u8d25\u7531\u4e0a\u5c42\u5904\u7406 pending exception\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#32-createobjectl154l182","title":"3.2 \u666e\u901a\u5bf9\u8c61\uff1a<code>CreateObject</code>\uff08L154\u2013L182\uff09","text":"<p>\u5173\u952e\u7b56\u7565\uff1a - \u5b57\u7b26\u4e32\u7c7b\u7279\u6b8a\u5904\u7406\uff1a\u521b\u5efa empty string\uff08L158\u2013L161\uff09\u3002 - \u82e5 klass \u53ef\u5b9e\u4f8b\u5316\uff1a   - \u5c1d\u8bd5 TLAB \u5206\u914d\uff08L164\u2013L173\uff09   - \u82e5 TLAB \u7a7a\u95f4\u4e0d\u8db3\u6216\u5bf9\u8c61\u9700\u8981 finalizer\uff0c\u8d70 slow path <code>ObjectHeader::Create(thread, klass)</code>\uff08L167\u2013L170\uff09   - \u5426\u5219\u5728 TLAB \u4e0a alloc \u5e76 init object header\uff08L171\u2013L175\uff09 - \u82e5\u4e0d\u53ef\u5b9e\u4f8b\u5316\uff1a\u629b <code>InstantiationError</code>\uff08L178\u2013L181\uff09</p> <p>\u8fd9\u4e0e <code>entrypoints.cpp</code> \u4e2d\u5927\u91cf \u201cCreate*SlowPathEntrypoint\u201d \u7684\u5b58\u5728\u4e00\u81f4\uff1a\u6267\u884c\u5f15\u64ce\u4f1a\u5c3d\u91cf\u8d70 fast path\uff0c\u5fc5\u8981\u65f6\u4e0b\u6c89 slow path\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#4-catchfindcatchblockl189l192","title":"4. \u5f02\u5e38\u4e0e catch\uff1a<code>FindCatchBlock</code>\uff08L189\u2013L192\uff09","text":"<p>\u89e3\u91ca\u5668\u4fa7 catch \u67e5\u627e\u76f4\u63a5\u8c03\u7528 <code>Method::FindCatchBlock(cls,pc)</code>\uff0c\u5e76\u7531 <code>entrypoints.cpp::FindCatchBlockInIFrames*</code> \u5728 unwind \u65f6\u9a71\u52a8 frame \u626b\u63cf/\u91ca\u653e\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#5-frame-frame-layout-entrypoints-abi-l259l288","title":"5. Frame \u521b\u5efa/\u91ca\u653e\uff1a\u628a Frame layout \u4e0e entrypoints ABI \u7edf\u4e00\u8d77\u6765\uff08L259\u2013L288\uff09","text":"<p>\u5173\u952e\u70b9\uff1a - <code>CreateFrame</code> / <code>CreateFrameWithActualArgs</code> / <code>CreateNativeFrameWithActualArgs</code>\uff1a   - \u7528 <code>Frame::GetActualSize&lt;IS_DYNAMIC&gt;(nregs)</code> \u8ba1\u7b97\u771f\u5b9e vreg \u533a\u5927\u5c0f   - \u59d4\u6258\u5230 <code>ark::CreateFrameWith*AndSize</code>\uff08\u5b9a\u4e49\u5728 <code>entrypoints.h</code>\uff09 - <code>FreeFrame(thread, frame)</code>\uff1a   - \u76f4\u63a5\u91ca\u653e <code>frame-&gt;GetExt()</code>\uff08stack frame allocator\uff09</p> <p>\u8fd9\u628a 04 \u7684\u4e09\u5757\u62fc\u6210\u95ed\u73af\uff1a <code>Frame</code>\uff08layout/actual size\uff09\u2190\u2192 <code>entrypoints</code>\uff08\u5206\u914d\u5b9e\u73b0\uff09\u2190\u2192 <code>RuntimeInterface</code>\uff08\u89e3\u91ca\u5668\u8c03\u7528\u70b9\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_runtime_interface.h/#6-safepoint-debug-gcl306l341","title":"6. Safepoint\uff1a\u7ebf\u7a0b\u7ec8\u6b62/\u6302\u8d77\u4e0e\u53ef\u9009 debug GC\uff08L306\u2013L341\uff09","text":"<ul> <li>Debug \u4e0b\u53ef\u542f\u7528 \u201c\u6bcf\u6b21 safepoint \u90fd\u5c1d\u8bd5\u89e6\u53d1 GC\u201d\uff08\u8981\u6c42\u6301\u6709 mutator lock\uff09\u2014\u2014\u4ec5\u7528\u4e8e\u4e00\u81f4\u6027/\u538b\u529b\u6d4b\u8bd5\u3002</li> <li>\u5fc5\u987b\u6ee1\u8db3 <code>thread-&gt;IsRuntimeCallEnabled()</code>\u3002</li> <li>\u82e5 runtime terminated\uff1a\u6267\u884c termination \u5904\u7406\u3002</li> <li>\u82e5 thread suspended\uff1a\u8fdb\u5165 <code>WaitSuspension()</code>\u3002</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u67d0\u4e9b\u6162\u8def\u5f84/\u6865\u63a5\u5728\u542f\u7528\u7279\u5b9a\u9009\u9879\u65f6\u4f1a\u89e6\u53d1\u66f4\u9891\u7e41\u7684 thread \u72b6\u6001\u53d8\u5316\uff1a\u89e3\u91ca\u5668\u663e\u5f0f\u5728 safepoint \u505a\u4e86\u8fd9\u4e9b\u68c0\u67e5\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_state.h/","title":"<code>runtime/interpreter/state.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a249 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49\u89e3\u91ca\u5668\u6267\u884c\u7684\u201c\u5bc4\u5b58\u5668\u5316\u72b6\u6001\u201d\uff1aPC/Frame/Thread/DispatchTable/Acc \u7684\u7edf\u4e00\u8bbf\u95ee\u63a5\u53e3\uff1b\u5728\u5f00\u542f\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u65f6\uff0c\u628a\u8fd9\u4e9b\u72b6\u6001\u6620\u5c04\u5230 <code>arch::regs</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_state.h/#1-stateifacel29l86","title":"1. StateIface\uff1a\u7edf\u4e00\u63a5\u53e3\u5c42\uff08L29\u2013L86\uff09","text":"<p><code>StateIface&lt;T&gt;</code> \u6301\u6709\u4e00\u4e2a <code>AccVRegisterT acc_</code>\uff08\u6784\u9020\u65f6\u4ece <code>frame-&gt;GetAcc()</code> \u62ff\u5230\u521d\u59cb\u503c\uff09\uff0c\u5e76\u628a\u5173\u952e\u64cd\u4f5c\uff08GetInst/SetInst/GetFrame/SetFrame/GetThread/SetThread/SaveState/RestoreState\uff09\u4e0b\u53d1\u5230\u6d3e\u751f\u7c7b\u5b9e\u73b0\u3002</p> <p>\u8fd9\u662f\u4e00\u79cd CRTP \u6a21\u5f0f\uff1a\u7528\u9759\u6001\u591a\u6001\u628a\u201c\u6709\u65e0\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u201d\u7684\u5dee\u5f02\u6d88\u5316\u6389\uff0c\u8c03\u7528\u70b9\u4fdd\u6301\u4e00\u81f4\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_state.h/#2-statel88l173","title":"2. \u6709\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u7684 <code>State</code>\uff08L88\u2013L173\uff09","text":"<p>\u5173\u952e\u5dee\u5f02\uff1a - L107\u2013L115\uff1aPC\uff08inst\uff09\u5b9e\u9645\u5b58\u653e\u5728 <code>arch::regs::Pc</code> - L117\u2013L127\uff1aFrame \u6307\u9488\u5b58\u653e\u5728 <code>arch::regs::Frame</code>\uff0c\u5e76\u4e14\u4f1a\u989d\u5916\u8bbe\u7f6e <code>MirrorFp</code>\uff1a   - <code>MirrorFp = frame + Frame::GetVregsOffset() + frame-&gt;GetSize()</code>\uff08L125\u2013L127\uff09     \u8fd9\u662f\u9759\u6001\u8bed\u8a00\u201cpayload + mirror vregs\u201d\u5e03\u5c40\u7684\u5173\u952e\uff1amirror \u8d77\u70b9=payload \u8d77\u70b9+size\u3002 - L129\u2013L137\uff1adispatch table \u5b58\u653e\u5728 <code>arch::regs::DispatchTable</code>\uff08\u7528\u4e8e\u5feb\u901f opcode \u5206\u6d3e\uff09\u3002 - L149\u2013L165\uff1aSaveState/RestoreState \u4f1a\u628a inst/acc/fp/mirrorFp/thread spill \u51fa\u6765\u518d\u6062\u590d   - \u5178\u578b\u7528\u9014\uff1a\u8de8 runtime call/\u6162\u8def\u5f84\u65f6\u4fdd\u62a4\u89e3\u91ca\u5668\u5bc4\u5b58\u5668\u72b6\u6001\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_state.h/#3-statel175l243","title":"3. \u65e0\u5168\u5c40\u5bc4\u5b58\u5668\u53d8\u91cf\u7684 <code>State</code>\uff08L175\u2013L243\uff09","text":"<ul> <li>PC/Frame/Thread/DispatchTable \u90fd\u662f\u666e\u901a\u6210\u5458\u53d8\u91cf\uff0cSave/Restore \u4e3a\u7a7a\u5b9e\u73b0\u3002</li> <li>\u8fd9\u662f\u4e00\u79cd\u201c\u7eaf C++ \u72b6\u6001\u673a\u201d\u5b9e\u73b0\uff1a\u66f4\u7b80\u5355\u4f46\u53ef\u80fd\u6162\uff08\u53d6\u51b3\u4e8e\u5e73\u53f0/\u4f18\u5316\uff09\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a<code>State</code> \u662f\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u7684\u201c\u6838\u5fc3\u4e0a\u4e0b\u6587\u201d\uff0c\u5b83\u628a PC/Frame/Thread/Acc/dispatch-table \u805a\u5408\u8d77\u6765\uff0c\u5e76\u5728\u6027\u80fd\u654f\u611f\u914d\u7f6e\u4e0b\u6620\u5c04\u5230\u5bc4\u5b58\u5668\u53d8\u91cf\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/","title":"<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u751f\u6210\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>interpreter-inl_gen.h</code>\uff0c\u5b83\u5305\u542b\uff1a - <code>ExecuteImpl&lt;RuntimeIfaceT, IS_DYNAMIC, IS_PROFILE_ENABLED&gt;()</code> - <code>ExecuteImplDebug&lt;...&gt;()</code></p> <p>\u8fd9\u4e24\u4e2a\u51fd\u6570\u624d\u662f\u201c\u89e3\u91ca\u5668\u4e3b\u5faa\u73af/dispatch table/exception handler label\u201d\u7684\u771f\u6b63\u5b9a\u4e49\u5904\uff1b <code>runtime/interpreter/interpreter-inl.h</code> \u4e3b\u8981\u63d0\u4f9b <code>InstructionHandler::HandleXxx</code> \u7684\u5b9e\u73b0\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#0-includes-isa-l16l18","title":"0. \u5173\u952e includes\uff1a\u751f\u6210\u6587\u4ef6\u4e5f\u9700\u8981 ISA \u5e38\u91cf\u4e0e\u63d2\u4ef6\u6269\u5c55\u70b9\uff08L16\u2013L18\uff09","text":"<ul> <li>L16\uff1a<code>&lt;isa_constants_gen.h&gt;</code>\uff1a\u63d0\u4f9b <code>NUM_PREFIXED</code> \u7b49\u5e38\u91cf\uff0c\u7528\u4e8e <code>DISPATCH_TABLE_LEN</code> \u8ba1\u7b97\u3002</li> <li>L17\uff1a<code>plugins_interpreters-inl.h</code>\uff1a\u7531 <code>runtime/templates/plugins_interpreters-inl.h.erb</code> \u751f\u6210\uff0c\u5141\u8bb8\u63d2\u4ef6\u6ce8\u5165\u989d\u5916\u89e3\u91ca\u5668 inl\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#1-debug-vs-nodebugl23l35","title":"1. \u53cc\u6a21\u5f0f\u751f\u6210\uff1adebug vs nodebug\uff08L23\u2013L35\uff09","text":"<p>erb \u6700\u5916\u5c42\u5faa\u73af\uff08L23\uff09\u4f1a\u751f\u6210\u4e24\u5957\u5b9e\u73b0\uff1a</p> <ul> <li>nodebug\uff1a<code>ExecuteImpl(...)</code>\uff08L29\uff09  </li> <li>L30\u2013L33\uff1a\u82e5 runtime \u5904\u4e8e debug mode\uff0c\u5219\u76f4\u63a5\u8f6c\u8c03 <code>ExecuteImplDebug</code> \u5e76\u8fd4\u56de\u3002     \u8fd9\u786e\u4fdd\u201c\u975e debug \u89e3\u91ca\u5668\u201d\u4e0d\u4f1a\u5728 debug mode \u4e0b\u8fd0\u884c\u3002</li> <li>debug\uff1a<code>ExecuteImplDebug(...)</code>\uff08L27\uff09   \u8be5\u7248\u672c\u4f1a\u63d2\u5165\u66f4\u591a\u53ef\u89c2\u6d4b\u6027\u903b\u8f91\uff08instrument instruction\u3001force pop/retry \u7b49\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#2-l50l66","title":"2. \u8fdb\u5165\u4e3b\u5faa\u73af\u7684\u7edf\u4e00\u524d\u7f6e\uff08L50\u2013L66\uff09","text":"<ul> <li>L50\uff1a<code>ASSERT(!thread-&gt;IsCurrentFrameCompiled())</code>\uff1a\u89e3\u91ca\u5668\u5faa\u73af\u8981\u6c42\u5f53\u524d frame \u662f interpreter frame \u8bed\u4e49\u3002</li> <li>L52\u2013L54\uff1a<code>StackOverflowCheck</code>\uff1a\u89e3\u91ca\u5668\u5165\u53e3\u5904\u505a\u4e00\u6b21\u6808\u6ea2\u51fa\u68c0\u67e5\uff1b\u5931\u8d25\u76f4\u63a5 return\u3002</li> <li>L56\u2013L63\uff1a<code>EVENT_METHOD_ENTER</code> / <code>EVENT_METHOD_EXIT</code>\uff1a\u65b9\u6cd5\u8fdb\u5165/\u9000\u51fa\u4e8b\u4ef6\uff08\u9000\u51fa\u901a\u8fc7 RAII \u89e6\u53d1\uff09\u3002</li> <li>L65\uff1a<code>DISPATCH_TABLE_LEN = 256 + NUM_PREFIXED + 1</code>\uff1a  </li> <li>256\uff1aprimary opcode \u7a7a\u95f4\uff088bit\uff09</li> <li><code>NUM_PREFIXED</code>\uff1aprefix \u76f8\u5173\u4e8c\u7ea7 dispatch \u7684\u6269\u5c55\u7a7a\u95f4</li> <li><code>+1</code>\uff1a\u6700\u540e\u4e00\u4e2a slot \u4fdd\u7559\u7ed9 <code>EXCEPTION_HANDLER</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#3-dispatchtable-l67l154","title":"3. DispatchTable \u7684\u751f\u6210\uff08L67\u2013L154\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#31-quickener-dispatchl67l96","title":"3.1 quickener dispatch\uff08L67\u2013L96\uff09","text":"<ul> <li><code>PANDA_WITH_QUICKENER</code> \u4e0b\uff0c\u4e3a\u6bcf\u4e2a quickened plugin \u751f\u6210\uff1a</li> <li><code>quick_&lt;namespace&gt;_inst_dispatch_table</code></li> <li><code>quick_&lt;namespace&gt;_debug_dispatch_table</code>\uff08nodebug \u6a21\u5f0f\u7528\u6765\u8df3\u8f6c\u5230 <code>HANDLE_DEBUG_SWITCH</code>\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#32-dispatchl98l120-l113l119","title":"3.2 \u5e38\u89c4 dispatch\uff08L98\u2013L120, L113\u2013L119\uff09","text":"<ul> <li>nodebug\uff1a\u751f\u6210\u4e24\u5f20\u8868\uff1a</li> <li><code>instDispatchTable</code>\uff1a\u771f\u6b63\u7684 <code>&amp;&amp;HANDLE_&lt;name&gt;</code> label \u5730\u5740\u6570\u7ec4</li> <li><code>debugDispatchTable</code>\uff1a\u5168\u90e8\u6307\u5411 <code>&amp;&amp;HANDLE_DEBUG_SWITCH</code>\uff0c\u7528\u4e8e\u201c\u8fd0\u884c\u65f6\u5207\u6362\u5230 debug \u89e3\u91ca\u5668\u201d</li> <li>debug\uff1a\u751f\u6210\u4e00\u5f20\u8868 <code>instDispatchTable</code>\uff1a<code>&amp;&amp;DEBUG_HANDLE_&lt;name&gt;</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#33-quickenedflag-dispatch-table-l124l154","title":"3.3 quickenedFlag \u7684 dispatch table \u9009\u62e9\uff08L124\u2013L154\uff09","text":"<ul> <li>\u82e5 <code>method-&gt;panda_file.header.quickenedFlag</code> \u4e3a true\uff1a</li> <li>\u6309 <code>SourceLang</code> \u9009\u62e9 quickened dispatch table\uff08\u82e5\u6ca1\u6709\u5339\u914d\u5219\u7528\u9ed8\u8ba4\u8868\uff09</li> <li>\u5426\u5219\uff1a\u76f4\u63a5\u4f7f\u7528\u9ed8\u8ba4\u8868\u3002</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u89e3\u91ca\u5668\u53ef\u4ee5\u5728\u201cquickened \u4e0e\u975e quickened bytecode\u201d\u4e4b\u95f4\u5207\u6362\uff0c\u800c\u4e0d\u9700\u8981\u5728\u6bcf\u6761 handler \u91cc\u5206\u652f\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#4-instructionhandlerstate-dispatchl156l163","title":"4. <code>InstructionHandlerState</code> + \u9996\u6b21 DISPATCH\uff08L156\u2013L163\uff09","text":"<ul> <li>L156\uff1a\u521b\u5efa <code>InstructionHandlerState state(thread, pc, frame, thread-&gt;GetCurrentDispatchTable&lt;IS_DEBUG&gt;())</code></li> <li>L157\u2013L159\uff1a\u82e5 <code>jumpToEh==true</code>\uff0c\u76f4\u63a5\u8df3\u5230\u201c\u5f02\u5e38 handler slot\u201d\uff08<code>DISPATCH_TABLE_LEN-1</code>\uff09\u3002</li> <li>L162\uff1a<code>DISPATCH(state.GetDispatchTable(), state.GetPrimaryOpcode())</code>\uff1a\u5f00\u59cb\u6267\u884c\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#5-opcode-label-handler-handlexxxl164l208","title":"5. \u6bcf\u6761 opcode \u7684 label\uff1a\u6784\u9020 handler \u5e76\u8c03\u7528 <code>HandleXxx</code>\uff08L164\u2013L208\uff09","text":"<p>\u5bf9\u6bcf\u6761 ISA \u6307\u4ee4\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a <code>{ ... }</code> block label\uff1a</p> <ul> <li>L171\uff1a<code>InstructionHandler&lt;RuntimeIfaceT, IS_DYNAMIC, IS_DEBUG, IS_PROFILE_ENABLED&gt; handler(&amp;state);</code></li> <li>L182\u2013L183\uff1a<code>handler.DumpVRegs(); handler.template Handle&lt;Mnemonic&gt;&lt;Format&gt;();</code></li> <li>return \u7c7b\u6307\u4ee4\uff08L184\u2013L193\uff09\uff1a</li> <li>\u82e5\u5f53\u524d frame \u662f stackless\uff1a\u8c03\u7528 <code>HandleReturnStackless()</code>\uff0c\u7136\u540e\u7ee7\u7eed <code>DISPATCH(...)</code></li> <li>\u5426\u5219\uff1a<code>return;</code>\uff08\u9000\u51fa\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\uff09</li> <li>\u53ef\u80fd\u629b\u5f02\u5e38\u7684\u6307\u4ee4\uff1a\u7528 <code>handler.GetExceptionOpcode()</code> \u51b3\u5b9a\u662f\u5426\u8df3\u5f02\u5e38\u5165\u53e3\uff08\u8be5\u503c\u7531 <code>MoveToExceptionHandler()</code> \u63a7\u5236\uff09\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u89e3\u91ca\u5668\u201c\u5206\u5c42\u201d\u7684\u6838\u5fc3\uff1alabel/dispatch \u5728\u751f\u6210\u6587\u4ef6\uff0c\u8bed\u4e49\u5b9e\u73b0\uff08HandleXxx\uff09\u5728 <code>interpreter-inl.h</code>\uff0c\u5171\u7528 <code>InstructionHandlerBase</code> \u7684\u63a7\u5236\u6d41\u539f\u8bed\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#6-prefix-dispatchl212l223","title":"6. prefix \u4e8c\u7ea7 dispatch\uff08L212\u2013L223\uff09","text":"<ul> <li>prefix label \u8bfb\u53d6 <code>secondaryOpcode</code>\uff0c\u8ba1\u7b97\u4e8c\u7ea7\u8868\u504f\u79fb <code>dispatchIdx</code>\uff0c\u7136\u540e <code>DISPATCH(table, dispatchIdx)</code>\u3002</li> <li>\u8fd9\u89e3\u91ca\u4e86 <code>isa_constants_gen.h</code> \u7684\u9650\u5236\uff1afirst-level opcode space \u4e0d\u53ef\u80fd\u65e0\u9650\u6269\u5c55\uff0cprefix \u628a\u7a7a\u95f4\u5916\u5305\u7ed9 secondary opcode\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#7-exception_handler-unwind-cframe-l272l310","title":"7. EXCEPTION_HANDLER\uff1a\u89e3\u91ca\u5668\u5185 unwind + \u9700\u8981\u65f6\u8f6c\u5411 CFrame \u641c\u7d22\uff08L272\u2013L310\uff09","text":"<ul> <li>L277\uff1a<code>ASSERT(thread-&gt;HasPendingException())</code></li> <li>L279\u2013L286\uff1a<code>pcOffset = handler.FindCatchBlockStackless()</code>   \u8bed\u4e49\uff1a\u53ea\u5728\u201cstackless interpreter frames\u201d\u91cc\u5411\u4e0a\u5f39\u6808\u627e catch\uff1b\u5fc5\u8981\u65f6\u4f1a FreeFrame \u5e76\u56de\u5230 caller frame\u3002</li> <li>L286\u2013L292\uff1a\u82e5\u6ca1\u627e\u5230\uff08INVALID_OFFSET\uff09\uff1a</li> <li>\u5728 AARCH64/AARCH32/X86_64\uff1a<code>return FindCatchBlockInCallStack(thread);</code>     \u8fd9\u4f1a\u8fdb\u5165 <code>runtime/exceptions.cpp</code>\uff0c\u7528 <code>StackWalker</code> \u5728 CFrames \u91cc\u7ee7\u7eed\u627e catch\uff0c\u5e76\u901a\u8fc7 deopt \u8fd4\u56de\u5230\u89e3\u91ca\u5668 catch pc\u3002</li> <li>\u5176\u4ed6\u67b6\u6784\uff1a\u76f4\u63a5 return\uff08\u53ef\u80fd\u4ea4\u7ed9\u66f4\u5916\u5c42\u5904\u7406\uff09\u3002</li> <li>L296\u2013L300\uff1a\u628a\u5f02\u5e38\u5bf9\u8c61\u5199\u5165\u201c\u8bed\u8a00\u4e0a\u4e0b\u6587\u89c4\u5b9a\u7684 vreg\u201d\uff08\u8fd9\u91cc\u7528 <code>frame-&gt;GetAcc()</code> \u4f5c\u4e3a\u8f7d\u4f53\uff09\uff0c\u5e76 <code>thread-&gt;ClearException()</code>\u3002</li> <li>L305\u2013L309\uff1a\u91cd\u5efa <code>state</code>\uff08pc=catch block\uff09\u5e76 <code>goto* dispatch[opcode]</code> \u7ee7\u7eed\u6267\u884c\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#8-debug-instrument_frame_handlerl312l335","title":"8. debug \u4e13\u5c5e\uff1aINSTRUMENT_FRAME_HANDLER\uff08L312\u2013L335\uff09","text":"<p>\u5f53 frame \u88ab\u6807\u8bb0 <code>ForcePop</code> \u6216 <code>RetryInstruction</code> \u65f6\uff1a</p> <ul> <li>ForcePop\uff1a\u6e05\u6807\u5fd7 \u2192 <code>InstrumentForceReturn()</code> \u2192 stackless \u5219\u8d70 <code>HandleInstrumentForceReturn()</code> \u5426\u5219 return\u3002</li> <li>RetryInstruction\uff1a\u91cd\u5efa state\uff08pc = <code>method-&gt;GetInstructions() + frame-&gt;GetBytecodeOffset()</code>\uff09\u7ee7\u7eed\u6267\u884c\u5f53\u524d\u6307\u4ee4\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_interpreter-inl_gen.h.erb/#9-nodebug-handle_debug_switchl338l345","title":"9. nodebug \u4e13\u5c5e\uff1aHANDLE_DEBUG_SWITCH\uff08L338\u2013L345\uff09","text":"<p>\u5f53 runtime \u5207\u5165 debug mode \u65f6\uff0cnodebug \u4e3b\u5faa\u73af\u4f1a\uff1a</p> <ul> <li>\u628a acc \u5199\u56de frame</li> <li>\u8c03\u7528 <code>ExecuteImplDebug(...)</code></li> <li>return</li> </ul> <p>\u8fd9\u5b9e\u73b0\u4e86\u201c\u65e0\u9700\u91cd\u65b0\u542f\u52a8 VM \u5373\u53ef\u5207\u6362\u5230 debug \u89e3\u91ca\u5668\u201d\u7684\u80fd\u529b\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_irtoc_interpreter_utils.h.erb/","title":"<code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cIRTOC/LLVM dispatch table \u751f\u6210\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>irtoc_interpreter_utils.h</code>\uff0c\u63d0\u4f9b\uff1a - <code>SetupDispatchTableImpl()</code>\uff1aIRTOC fast interpreter \u7684 dispatch table - <code>SetupLLVMDispatchTableImpl()</code>\uff1aLLVM interpreter \u7684 dispatch table</p> <p>\u5b83\u88ab <code>runtime/interpreter/interpreter_impl.cpp</code> \u5728 <code>PANDA_WITH_IRTOC</code> \u4e0b\u5305\u542b\uff0c\u7528\u4e8e\u628a\u201cfast handler \u5730\u5740\u6570\u7ec4\u201d\u4f20\u7ed9 IRTOC/LLVM \u7684\u6267\u884c\u5165\u53e3\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_irtoc_interpreter_utils.h.erb/#1-fast-handler-l23l61","title":"1. fast handler \u7b26\u53f7\u58f0\u660e\uff08L23\u2013L61\uff09","text":"<ul> <li>L24\u2013L42\uff1a\u7279\u6b8a\u7684 GN build/amd64 \u914d\u7f6e\u4e0b\uff08<code>PANDA_TARGET_AMD64 &amp;&amp; !PANDA_COMPILER_TARGET_X86_64</code>\uff09\uff0c\u628a\u6240\u6709 <code>HANDLE_FAST_*</code> \u5b9a\u4e49\u6210 <code>nullptr</code>\u3002   \u542b\u4e49\uff1a\u5728\u67d0\u4e9b\u6784\u5efa\u77e9\u9635\u91cc fast interpreter \u53ef\u80fd\u88ab\u7981\u7528\u6216\u4e0d\u53ef\u7528\uff0c\u4ecd\u9700\u6ee1\u8db3\u94fe\u63a5/\u7f16\u8bd1\u901a\u8fc7\u3002</li> <li>L44\u2013L60\uff1a\u6b63\u5e38\u8def\u5f84\uff1a\u4e3a\u6bcf\u6761\u6307\u4ee4\u4e0e prefix \u751f\u6210 <code>extern \"C\" void HANDLE_FAST_&lt;name&gt;()</code>\uff08\u4ee5\u53ca <code>_LLVM</code> \u7248\u672c\uff09\u58f0\u660e\uff0c\u5e76\u8865\u4e0a <code>INVALID/EXCEPTION</code>\u3002</li> </ul> <p>\u201cFAST handler\u201d\u901a\u5e38\u7531 IRTOC/\u6c47\u7f16/\u751f\u6210\u4ee3\u7801\u63d0\u4f9b\uff0c\u800c\u975e C++ <code>InstructionHandler</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_irtoc_interpreter_utils.h.erb/#2-setupdispatchtableimpl-void-fast-l63l79","title":"2. <code>SetupDispatchTableImpl</code>\uff1a\u8fd4\u56de <code>void*</code> \u7ed9 fast \u89e3\u91ca\u5668\uff08L63\u2013L79\uff09","text":"<ul> <li>L66\u2013L77\uff1a\u751f\u6210\u4e00\u4e2a <code>static const std::array&lt;void(*)(), N&gt;</code>\uff1a</li> <li>\u5143\u7d20\u4e3a <code>&amp;HANDLE_FAST_&lt;name&gt;</code>\uff08\u6216\u67d0\u4e9b\u914d\u7f6e\u4e0b\u4e0d\u53d6\u5730\u5740\uff09</li> <li>\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u662f <code>HANDLE_FAST_EXCEPTION</code></li> <li>L78\uff1a\u8fd4\u56de <code>dispatch_table.data()</code>\uff08\u5f3a\u8f6c <code>void*</code>\uff09\uff1a\u5339\u914d fast interpreter ABI\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_irtoc_interpreter_utils.h.erb/#3-setupllvmdispatchtableimplllvm-l81l97","title":"3. <code>SetupLLVMDispatchTableImpl</code>\uff1aLLVM \u7248\u672c\uff08L81\u2013L97\uff09","text":"<ul> <li>\u4e0e\u4e0a\u540c\u7406\uff0c\u53ea\u662f\u7b26\u53f7\u540d\u4f7f\u7528 <code>_LLVM</code> \u540e\u7f00\uff0c\u5f02\u5e38\u5165\u53e3\u4e3a <code>HANDLE_FAST_EXCEPTION_LLVM</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_isa_constants_gen.h.erb/","title":"<code>runtime/interpreter/templates/isa_constants_gen.h.erb</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cISA \u5e38\u91cf\u751f\u6210\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>&lt;isa_constants_gen.h&gt;</code>\uff0c\u4e3a\u89e3\u91ca\u5668 dispatch table \u63d0\u4f9b \u7f16\u8bd1\u671f\u5e38\u91cf\uff08prefix \u6570\u91cf\u3001\u975e prefix opcode \u6570\u91cf\u3001\u8fb9\u754c\u6821\u9a8c\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_isa_constants_gen.h.erb/#1-l19l25","title":"1. \u5e38\u91cf\u5b9a\u4e49\uff08L19\u2013L25\uff09","text":"<ul> <li>L20\uff1a<code>NUM_PREFIXED</code>\uff1aISA \u4e2d\u201cprefix \u6307\u4ee4\u201d\u7684\u6570\u91cf\uff08\u6765\u81ea ISA \u63cf\u8ff0 <code>Panda::instructions.select(&amp;:prefix)</code>\uff09\u3002</li> <li>L21\uff1a<code>NUM_NON_PREFIXED_OPS</code>\uff1a\u975e prefix opcode \u6570\u91cf\uff08\u5e76 +1 \u7ed9 <code>EXCEPTION_HANDLER</code> \u9884\u7559\u4e00\u4e2a slot\uff09\u3002</li> <li>L22\uff1a<code>NUM_PREFIXES</code>\uff1aprefix \u7684\u79cd\u7c7b\u6570\uff08<code>Panda::prefixes.size</code>\uff09\u3002</li> <li>L24\uff1a<code>static_assert</code>\uff1a\u9650\u5236 first-level dispatch \u7684 opcode \u603b\u6570\uff08\u975e prefix + prefixes\uff09\u4e0d\u8d85\u8fc7 210\u3002   \u542b\u4e49\uff1a\u89e3\u91ca\u5668\u4f7f\u7528\u201c\u4e8c\u7ea7 dispatch\u201d\uff08prefix + secondary opcode\uff09\u7684\u5e03\u5c40\uff1b\u8be5\u65ad\u8a00\u4e3a\u751f\u6210/\u5e03\u5c40\u63d0\u4f9b\u4e0a\u754c\u4fdd\u8bc1\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_templates_isa_constants_gen.h.erb/#2","title":"2. \u88ab\u8c01\u6d88\u8d39\uff1f","text":"<ul> <li><code>runtime/interpreter/instruction_handler_base.h</code> \u4f7f\u7528 <code>NUM_PREFIXED</code> \u6765\u8ba1\u7b97\u5f02\u5e38 opcode \u7684 extension \u503c\u3002</li> <li><code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u4f7f\u7528 <code>NUM_PREFIXED</code> \u6765\u8ba1\u7b97 <code>DISPATCH_TABLE_LEN = 256 + NUM_PREFIXED + 1</code>\uff0c\u5e76\u628a\u6700\u540e\u4e00\u4e2a slot \u7528\u4f5c <code>EXCEPTION_HANDLER</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/","title":"<code>runtime/interpreter/vregister.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cvreg \u4e0e tag \u8bed\u4e49\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a575 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49\u89e3\u91ca\u5668\u865a\u62df\u5bc4\u5b58\u5668\uff08vreg\uff09\u7684\u6700\u5c0f\u62bd\u8c61\uff1a - <code>VRegister</code>\uff1atagless payload\uff0864-bit\uff09 - <code>StaticVRegisterRef</code>\uff1apayload + mirror(tag)\uff08\u9759\u6001\u8bed\u8a00\uff09 - <code>DynamicVRegisterRef</code>\uff1apayload \u5185\u542b TaggedValue\uff08\u52a8\u6001\u8bed\u8a00\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#0-tag-l34l49","title":"0. \u9876\u90e8\u7684\u201ctag \u517c\u5bb9\u6027\u201d\u6ce8\u91ca\uff08L34\u2013L49\uff09","text":"<p>\u6587\u4ef6\u5f00\u5934\u7528\u4f4d\u57df\u56fe\u89e3\u91ca\u4e86\u4e00\u79cd\u201c\u517c\u5bb9\u9759\u6001/\u52a8\u6001\u201d\u7684 tag \u7f16\u7801\u6a21\u578b\uff1a\u6700\u4f4e\u4f4d\u662f IsObject \u6807\u8bb0\u3002 \u4f46\u5de5\u7a0b\u5b9e\u73b0\u4e0a\u9009\u62e9\u4e86\u66f4\u660e\u786e\u7684\u65b9\u5f0f\uff1a - \u9759\u6001\u8bed\u8a00\uff1atag \u4e0d\u5728 payload\uff0c\u800c\u5728 frame \u7684 mirror vregs\uff08\u89c1 <code>frame.h</code>\uff09 - \u52a8\u6001\u8bed\u8a00\uff1apayload \u76f4\u63a5\u5b58 TaggedValue raw data\uff0c\u7528 <code>IsHeapObject()</code> \u5224\u65ad\u5bf9\u8c61</p> <p>\u8bfb\u8fd9\u4e2a\u6587\u4ef6\u8981\u8bb0\u4f4f\uff1a\u6ce8\u91ca\u63cf\u8ff0\u7684\u662f\u201c\u6982\u5ff5\u517c\u5bb9\u6027\u201d\uff0c\u771f\u5b9e\u5b9e\u73b0\u4ee5 <code>StaticVRegisterRef</code>/<code>DynamicVRegisterRef</code> \u7684 HasObject \u4e3a\u51c6\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#1-vregisteriface-setget-l72l179","title":"1. <code>VRegisterIface</code>\uff1a\u7edf\u4e00\u7684 set/get \u65cf\uff08L72\u2013L179\uff09","text":"<p>\u8fd9\u662f\u4e00\u4e2a CRTP \u63a5\u53e3\u5c42\uff0c\u63d0\u4f9b\uff1a - <code>Set(int32/uint32/int64/uint64/float/double/ObjectHeader*)</code> - <code>Get/GetLong/GetFloat/GetDouble/GetReference</code> - <code>GetAs&lt;T&gt;</code>\uff08\u5bf9\u4e0d\u540c\u7c7b\u578b\u505a bit_cast \u6216\u9759\u6001\u8f6c\u6362\uff09</p> <p>\u5173\u952e\u70b9\uff1a - Set(ObjectHeader*) \u4f1a\u505a <code>mem::ValidateObject</code>\uff08L118\u2013L123\uff09\uff1a\u89e3\u91ca\u5668\u628a\u5bf9\u8c61\u6307\u9488\u5199\u5165 vreg \u65f6\uff0c\u5fc5\u987b\u6ee1\u8db3 root/heap \u53ef\u8fbe\u6027\u57fa\u672c\u7ea6\u675f\uff08\u6392\u969c\u65f6\u5f88\u91cd\u8981\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#2-vregistertagless-payloadl187l220","title":"2. <code>VRegister</code>\uff1atagless payload\uff08L187\u2013L220\uff09","text":"<ul> <li>\u53ea\u6709 <code>int64_t v_</code>\uff0c\u5b58\u653e\u201cbit \u8868\u793a\u201d\u7684\u503c\u3002</li> <li><code>GetValueOffset()</code> \u63d0\u4f9b\u7a33\u5b9a offset\uff08\u7ed9\u6c47\u7f16/\u751f\u6210\u4ee3\u7801/\u8c03\u8bd5\u5de5\u5177\u7528\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#3-vregisterrefttag-l222l381","title":"3. <code>VRegisterRef&lt;T&gt;</code>\uff1a\u628a\u201ctag \u8bed\u4e49\u201d\u4ea4\u7ed9\u6d3e\u751f\u7c7b\uff08L222\u2013L381\uff09","text":"<p><code>VRegisterRef</code> \u5c01\u88c5 payload \u6307\u9488\uff0c\u5e76\u628a\u4ee5\u4e0b\u8bed\u4e49\u4e0b\u53d1\u7ed9\u6d3e\u751f\u7c7b\u5b9e\u73b0\uff1a - <code>HasObject()</code> - <code>MovePrimitive/MoveReference/Move</code> - <code>SetPrimitive(...)</code> / <code>SetReference(...)</code></p> <p>\u5e76\u5728 debug \u4e0b\u63d0\u4f9b <code>DumpVReg()</code>\uff1a - \u82e5 HasObject\uff1a\u6253\u5370 obj \u6307\u9488\u503c - \u5426\u5219\u6253\u5370 i64/f32/f64/hex \u591a\u89c6\u56fe\uff08\u6392\u969c\u5f88\u76f4\u89c2\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#4-staticvregisterrefmirrortag-l383l488","title":"4. <code>StaticVRegisterRef</code>\uff1amirror(tag) \u5224\u5b9a\u5bf9\u8c61\uff08L383\u2013L488\uff09","text":"<ul> <li>\u989d\u5916\u6301\u6709 <code>mirror_</code> \u6307\u9488\u3002</li> <li>HasObject()\uff1a<code>mirror_-&gt;GetValue() == GC_OBJECT_TYPE</code>\uff08L422\u2013L425\uff09</li> <li>SetPrimitive \u4f1a\u628a mirror \u7f6e\u4e3a PRIMITIVE_TYPE\uff1bSetReference \u4f1a\u628a mirror \u7f6e\u4e3a GC_OBJECT_TYPE\u3002</li> </ul> <p>\u8fd9\u662f\u9759\u6001\u8bed\u8a00\uff08\u5982 Java/ETS \u7684 core part\uff09\u201cvreg \u7c7b\u578b\u4fe1\u606f\u201d\u4fdd\u5b58\u65b9\u5f0f\u7684\u76f4\u63a5\u8bc1\u636e\uff1atag \u4e0d\u5728 payload\uff0c\u800c\u5728 mirror\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_interpreter_vregister.h/#5-dynamicvregisterrefpayload-taggedvalue-l490l571","title":"5. <code>DynamicVRegisterRef</code>\uff1apayload \u5185 TaggedValue \u5224\u5b9a\u5bf9\u8c61\uff08L490\u2013L571\uff09","text":"<ul> <li>HasObject()\uff1a<code>TaggedValue(payload_-&gt;GetAs&lt;uint64_t&gt;()).IsHeapObject()</code>\uff08L513\u2013L517\uff09</li> <li><code>SetReference(ObjectHeader*)</code>\uff1a\u6784\u9020 TaggedValue(obj) \u5e76\u5199 raw data\uff08L561\u2013L565\uff09</li> <li>primitive \u7684 set \u4e0d\u5199 mirror\uff08\u56e0\u4e3a\u6ca1\u6709 mirror\uff09\u3002</li> </ul> <p>\u8fd9\u4e0e 04 \u7684 OSR/bridge/deopt \u4e2d \u201c\u52a8\u6001\u8bed\u8a00 acc/vreg \u53d6\u503c\u8981\u7528 TaggedValue \u5224\u65ad\u5bf9\u8c61\u201d \u5b8c\u5168\u4e00\u81f4\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/","title":"<code>runtime/osr.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a298 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 OSR\uff1a 1) OsrEntry\uff1a\u5b9a\u4f4d\u5f53\u524d\u89e3\u91ca\u5668\u5e27\u4e0e previous frame kind\uff0c\u5206\u6d41\u5230\u4e0d\u540c\u6c47\u7f16\u5165\u53e3 2) PrepareOsrEntry\uff1a\u628a iframe \u7684 vregs/acc/env \u642c\u8fd0\u5230 OSR cframe\uff08\u542b\u5bc4\u5b58\u5668 buffer\uff09 3) SetOsrResult\uff1a\u628a OSR \u6267\u884c\u7ed3\u679c\u5199\u56de\u89e3\u91ca\u5668 acc\uff08\u542b tag\uff09</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#osr","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aOSR \u201c\u4ece\u89e3\u91ca\u5668\u5207\u5230\u7f16\u8bd1\u6001\u201d","text":"<pre><code>flowchart TD\n  A[\"Interpreter \u6267\u884c\u5230 loop head\"] --&gt; B[\"OsrEntry(loopHeadBc, osrCode)\"]\n  B --&gt; C[\"CodeInfo(osrCode)\\nFindOsrStackMap(loopHeadBc)\"]\n  C --&gt; D{\"previous frame kind\uff1f\\nStackWalker::GetPreviousFrameKind\"}\n  D --&gt;|AFTER_IFRAME| E[\"OsrEntryAfterIFrame(...)\"]\n  D --&gt;|AFTER_CFRAME| F[\"OsrEntryAfterCFrame(...)\"]\n  D --&gt;|TOP_FRAME| G[\"OsrEntryTopFrame(...)\"]\n  E --&gt; H[\"PrepareOsrEntry \u642c\u8fd0\u72b6\u6001\\n\u2192 \u8df3\u5230 osr native pc\"]\n  F --&gt; H\n  G --&gt; H</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#0-osrentry-afteriframeaftercframetopframel63l112","title":"0. OsrEntry\uff1a\u5206\u6d41\u5230 AfterIFrame/AfterCFrame/TopFrame\uff08L63\u2013L112\uff09","text":"<ul> <li>L65\u2013L67\uff1a<code>stack = StackWalker::Create(...)</code>\uff1b<code>frame = stack.GetIFrame()</code>   OSR \u662f\u4ece\u89e3\u91ca\u5668\u6267\u884c\u70b9\u89e6\u53d1\uff0c\u56e0\u6b64\u4e3b\u64cd\u4f5c\u5bf9\u8c61\u662f iframe\uff08\u89e3\u91ca\u5668\u5e27\uff09\u3002</li> <li>L69\u2013L71\uff1a\u7528 <code>osrCode</code> \u6784\u9020 <code>CodeInfo</code> \u5e76\u67e5 <code>FindOsrStackMap(loopHeadBc)</code>\uff1a</li> <li>stackmap \u65e0\u6548\uff08L71\u2013L76\uff09\u5219\u8fd4\u56de false\uff0c\u5e76\u53ef\u8bb0\u4e8b\u4ef6\uff08WriteOsrEventError\uff09\u3002</li> <li>L78\u2013L110\uff1a\u6309 <code>stack.GetPreviousFrameKind()</code> \u5206\u6d41\uff1a</li> <li>prev=INTERPRETER\uff08L79\u2013L84\uff09\uff1a<code>OsrEntryAfterIFrame(frame, loopHeadBc, osrCode, frameSize, stackParams)</code></li> <li>prev=COMPILER\uff08L85\u2013L101\uff09\uff1a<ul> <li>\u52a8\u6001\u65b9\u6cd5\u989d\u5916\u6821\u9a8c\uff08L86\u2013L94\uff09\uff1a<code>num_actual_args &lt; num_args</code> \u4f1a\u7981\u7528 OSR \u5e76\u5931\u8d25   \u6ce8\u91ca\u6307\u51fa\u9700\u8981\u8c03\u6574\u6765\u81ea\u4e0a\u4e00\u7f16\u8bd1\u5e27\u7684\u53c2\u6570\u533a\uff1b\u8fd9\u91cc\u9009\u62e9\u4fdd\u5b88\u5931\u8d25\u3002</li> <li>\u4e4b\u540e <code>UnpoisonAsanStack(frame-&gt;GetPrevFrame())</code>\uff08L95\uff09\uff0c\u8c03\u7528 <code>OsrEntryAfterCFrame(...)</code> \u5e76 <code>UNREACHABLE()</code>\uff08OSR \u540e\u4e0d\u8fd4\u56de\uff09\u3002</li> </ul> </li> <li>prev=NONE\uff08L102\u2013L107\uff09\uff1a<code>OsrEntryTopFrame(...)</code></li> </ul> <p>\u7ed3\u8bba\uff1aOSR \u7684\u201c\u5165\u53e3\u9009\u62e9\u201d\u5b8c\u5168\u4f9d\u8d56 StackWalker \u7684\u8fb9\u754c\u5224\u5b9a\u4e0e previous frame kind\uff1b\u8fd9\u4e0e deopt \u7684 PrevFrameDeopt \u5206\u6d41\u662f\u5bf9\u5076\u5173\u7cfb\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#1-iframe-getvaluefromvregaccl114l135","title":"1. \u4ece iframe \u8bfb\u53d6\u503c\uff1a<code>GetValueFromVregAcc</code>\uff08L114\u2013L135\uff09","text":"<p>\u7528\u4e8e\u628a\u89e3\u91ca\u5668\u7684 acc/vreg/env \u8bfb\u6210\u7edf\u4e00\u7684 <code>int64_t</code>\uff1a - accumulator\uff1a<code>iframe-&gt;GetAcc().GetValue()</code>\uff08L117\u2013L118\uff09 - \u666e\u901a vreg\uff1a<code>iframe-&gt;GetVReg(index).GetValue()</code>\uff08L119\u2013L121\uff09 - special vreg\uff08\u73af\u5883/\u5bc4\u5b58\u5668\u6620\u5c04\u5916\u6570\u636e\uff09\uff1a<code>ctx.GetOsrEnv(iframe, vreg)</code>\uff08L122\u2013L124\uff09</p> <p>\u5e76\u505a\u5e73\u53f0\u76f8\u5173\u4fee\u6b63\uff1a - 32-bit managed pointer + target 64\uff1a\u5bf9\u8c61\u503c\u622a\u65ad\u5230 32-bit\uff08L125\u2013L128\uff09 - target 64\uff1a\u5bf9 <code>INT32</code> \u505a <code>uint32</code> \u622a\u65ad\uff08L129\u2013L132\uff0c\u6e90\u7801\u662f <code>NOTE(urandon): Investigate in #26258</code>\uff09   - \u8fd9\u662f\u4e00\u4e2a\u5e26 issue \u7f16\u53f7\u7684 \u5df2\u77e5\u884c\u4e3a/\u6280\u672f\u503a\u6807\u6ce8\uff0c\u4e0d\u662f\u201c\u672c\u7ae0\u6587\u6863\u672a\u8865\u9f50\u7684 TODO\u201d\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#2-prepareosrentry-osr-cframe-vregsaccenvl137l199","title":"2. <code>PrepareOsrEntry</code>\uff1a\u6784\u9020 OSR CFrame \u5e76\u642c\u8fd0 vregs/acc/env\uff08L137\u2013L199\uff09","text":"<p>\u6838\u5fc3\u6b65\u9aa4\uff1a</p> <p>1) \u6784\u9020 CodeInfo + OSR stackmap\uff08L142\u2013L146\uff09 - <code>stackmap = FindOsrStackMap(bcOffset)</code> \u5fc5\u987b valid\u3002</p> <p>2) \u521d\u59cb\u5316 CFrame \u5143\u4fe1\u606f\uff08L149\u2013L152\uff09 - <code>cframe.SetMethod(iframe-&gt;GetMethod())</code> - <code>cframe.SetFrameKind(OSR)</code> - <code>cframe.SetHasFloatRegs(codeInfo.HasFloatRegs())</code></p> <p>3) \u521d\u59cb\u5316 OSR \u53c2\u6570\u533a\uff08L163\u2013L167\uff09 - \u8ba1\u7b97 <code>paramSlots</code>\uff1a\u6307\u5411 <code>cframe.GetStackArgsStart()</code>\uff0c\u957f\u5ea6\u7531 <code>GetStackParamsSize(iframe)</code> \u51b3\u5b9a\u3002 - <code>ctx.InitializeOsrCframeSlots(paramSlots)</code>\uff1a\u8bed\u8a00\u76f8\u5173\u7684 OSR slot \u521d\u59cb\u5316\uff08env/\u9690\u5f0f\u53c2\u6570\u7b49\uff09\u3002</p> <p>4) \u904d\u5386 vregList \u5e76\u6309 location \u642c\u8fd0\uff08L170\u2013L193\uff09 - \u53ea\u5904\u7406 <code>vreg.IsLive()</code>\uff08L171\u2013L173\uff09\u3002 - <code>value = GetValueFromVregAcc(...)</code>\uff08L174\uff09\u3002 - \u6309 location \u5206\u6d41\uff1a   - SLOT\uff1a\u76f4\u63a5 <code>cframe.SetVRegValue(vreg, value, nullptr)</code>\uff08L176\u2013L178\uff09   - REGISTER\uff1a\u5199\u5165 <code>regBuffer[vreg.GetValue()]</code>\uff08L179\u2013L182\uff09   - FP_REGISTER\uff1a\u5199\u5165 <code>fpRegBuffer[vreg.GetValue()]</code>\uff08L183\u2013L186\uff09   - CONSTANT\uff1a\u8df3\u8fc7\uff08L188\u2013L189\uff09</p> <p>5) \u5207\u6362\u7ebf\u7a0b\u5f53\u524d\u5e27\u4e3a compiled\uff08L195\u2013L197\uff09 - <code>thread-&gt;SetCurrentFrame(reinterpret_cast&lt;Frame *&gt;(cframePtr))</code> - <code>thread-&gt;SetCurrentFrameIsCompiled(true)</code></p> <p>6) \u8fd4\u56de OSR \u76ee\u6807\u5730\u5740\uff08L198\uff09 - <code>osrCode + stackmap.GetNativePcUnpacked()</code>\uff1a\u6c47\u7f16\u5165\u53e3\u4f1a\u8df3\u5230\u8fd9\u4e2a native pc\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#3-setosrresult-accl201l244","title":"3. <code>SetOsrResult</code>\uff1a\u628a\u8fd4\u56de\u503c\u5199\u56de\u89e3\u91ca\u5668 acc\uff08L201\u2013L244\uff09","text":"<ul> <li>\u4f7f\u7528 method shorty \u7684\u8fd4\u56de\u7c7b\u578b\uff08ShortyIterator\uff09\u51b3\u5b9a\u5982\u4f55\u5199\u56de\uff1a</li> <li>\u6574\u6570\u7c7b\uff1a<code>acc.SetValue(uval)</code> + tag=PRIMITIVE\uff08L209\u2013L220\uff09</li> <li>\u5f15\u7528\uff1atag=GC_OBJECT\uff08L221\u2013L224\uff09</li> <li>\u6d6e\u70b9\uff1a<code>acc.SetValue(bit_cast&lt;int64_t&gt;(fval))</code> + tag=PRIMITIVE\uff08L225\u2013L229\uff09</li> <li>VOID\uff1a\u5fc5\u987b\u628a acc \u6e05\u96f6\uff08L230\u2013L235\uff09     \u6ce8\u91ca\u89e3\u91ca\uff1a\u89e3\u91ca\u5668\u5373\u4fbf callee void \u4e5f\u4f1a\u4ece callee \u6062\u590d acc\uff1b\u5982\u679c\u4e0d\u6e05\u96f6\uff0cacc \u53ef\u80fd\u6b8b\u7559\u65e7\u5bf9\u8c61\u5e76\u5728\u540e\u7eed\u88ab\u8bef\u8ba4\u4e3a live\uff08\u6781\u6613\u5f15\u53d1 GC/\u9a8c\u8bc1\u95ee\u9898\uff09\u3002</li> <li>TAGGED\uff1a\u52a8\u6001\u8bed\u8a00 tag \u503c\u81ea\u5e26\u8bed\u4e49\uff0c\u53ea\u8bbe value\uff08L236\u2013L238\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.cpp/#4-getstackparamssizeosr-l246l295","title":"4. <code>GetStackParamsSize</code>\uff1aOSR \u5165\u53e3\u9700\u8981\u7684\u53c2\u6570\u533a\u5927\u5c0f\uff08L246\u2013L295\uff09","text":"<ul> <li>\u52a8\u6001\u65b9\u6cd5\uff1a<code>numArgs = max(numArgs, numActualArgs)</code>\uff0c\u6309 TaggedType/slot \u5927\u5c0f\u8ba1\u7b97\u5e76\u5bf9\u9f50\uff08L250\u2013L254\uff09\u3002</li> <li>\u9759\u6001\u65b9\u6cd5\uff1a\u7528 <code>arch::ArgCounter</code> \u7edf\u8ba1\u201c\u9700\u8981\u8d70\u6808\u7684\u53c2\u6570\u7a7a\u95f4\u201d\uff1a</li> <li>\u5148 count \u9690\u5f0f <code>Method*</code>\uff08L256\u2013L257\uff09</li> <li>\u82e5\u975e static \u65b9\u6cd5\uff0ccount <code>this</code>\uff08L258\u2013L260\uff09</li> <li>\u904d\u5386 shorty \u7684\u6bcf\u4e2a\u53c2\u6570\u7c7b\u578b\u5e76 count\uff08L261\u2013L294\uff09</li> <li>\u8fd4\u56de stack-only size \u5e76\u6309 <code>2 * SLOT_SIZE</code> \u5bf9\u9f50\uff08L295\uff09</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.h/","title":"<code>runtime/osr.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a74 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e OSR\uff08On-Stack Replacement\uff09\u5165\u53e3\u4e0e OSR code \u7f13\u5b58\uff1a\u5728\u89e3\u91ca\u5668\u6267\u884c\u4e2d\u9014\u8fdb\u5165\u7f16\u8bd1\u4ee3\u7801\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.h/#0-osr-l26l37","title":"0. \u5173\u952e\u58f0\u660e\uff1aOSR \u5165\u53e3\u65cf\uff08L26\u2013L37\uff09","text":"<ul> <li>L26\u2013L27\uff1a<code>PrepareOsrEntry(...)</code>\uff08extern \"C\"\uff09  </li> <li>\u8bed\u4e49\uff1a\u628a\u89e3\u91ca\u5668 <code>Frame</code> \u7684\u72b6\u6001\uff08vregs/acc/env/\u53c2\u6570\u533a\uff09\u642c\u8fd0\u8fdb\u4e00\u4e2a OSR CFrame\uff0c\u5e76\u8fd4\u56de\u201c\u8df3\u8f6c\u5230 OSR code \u7684\u76ee\u6807\u5730\u5740\u201d\uff08native pc\uff09\u3002</li> <li>\u9700\u8981 <code>regBuffer/fpRegBuffer</code>\uff1a\u7528\u4e8e\u628a\u9700\u8981\u653e\u5728\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u63d0\u524d\u5199\u597d\uff08\u6c47\u7f16\u5165\u53e3\u4f1a\u628a buffer \u586b\u56de\u771f\u5b9e\u5bc4\u5b58\u5668\uff09\u3002</li> <li>L29\uff1a<code>OsrEntry(loopHeadBc, osrCode)</code> </li> <li>\u8bed\u4e49\uff1aOSR \u603b\u5165\u53e3\uff08C++\uff09\uff0c\u8d1f\u8d23\u5b9a\u4f4d\u5f53\u524d\u6808\u4e0e previous frame kind\uff0c\u5e76\u5206\u6d41\u5230\u4e0d\u540c\u6c47\u7f16\u5165\u53e3\u3002</li> <li>L31\u2013L35\uff1a<code>OsrEntryAfter*CFrame/IFrame/TopFrame</code>\uff08extern \"C\"\uff09  </li> <li>\u6c47\u7f16\u5165\u53e3\uff1a\u4f9d\u636e\u201c\u4e0a\u4e00\u5e27\u7c7b\u578b\u201d\uff08\u89e3\u91ca\u5668/\u7f16\u8bd1/\u65e0\u4e0a\u4e00\u5e27\uff09\u9009\u62e9\u4e0d\u540c\u7684\u6808\u4fee\u8865\u4e0e\u8df3\u8f6c\u7b56\u7565\u3002</li> <li>L37\uff1a<code>SetOsrResult(frame, uval, fval)</code> </li> <li>\u8bed\u4e49\uff1aOSR \u8fd4\u56de\u5230\u89e3\u91ca\u5668\u65f6\uff0c\u628a\u8fd4\u56de\u503c\u5199\u56de\u89e3\u91ca\u5668 acc\uff08\u542b tag\uff09\uff0c\u5e76\u7279\u522b\u5904\u7406 void\uff08\u9632\u6b62 acc \u6b8b\u7559\u65e7\u5bf9\u8c61\u5bfc\u81f4\u8bef\u5224\u4e3a live\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_osr.h/#1-osrcodemapmethod-osr-code-l39l70","title":"1. <code>OsrCodeMap</code>\uff1amethod \u2192 OSR code \u7684\u5e76\u53d1\u7f13\u5b58\uff08L39\u2013L70\uff09","text":"<ul> <li>\u7528 <code>RWLock</code> + <code>PandaMap</code> \u5b58 <code>Method* -&gt; void* osrCode</code>\u3002</li> <li>Get\uff1a\u8bfb\u9501\uff1b\u672a\u547d\u4e2d\u8fd4\u56de nullptr\u3002</li> <li>Set\uff1a\u5199\u9501\uff1b\u82e5 <code>ptr==nullptr</code> \u89c6\u4e3a remove\u3002</li> <li>Remove\uff1a\u5199\u9501 erase\u3002</li> </ul> <p>\u8fd9\u4e0e <code>deoptimization.cpp</code> \u7684 <code>RemoveOsrCode(method)</code> \u914d\u5408\uff1a\u5931\u6548\u65f6\u5fc5\u987b\u6e05\u6389 OSR code\uff0c\u907f\u514d\u8fdb\u5165\u9648\u65e7 code\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/","title":"<code>runtime/stack_walker.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u6309\u51fd\u6570\u7c07\u5206\u6bb5\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89c4\u6a21\uff1a838 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>StackWalker</code>\uff1a\u521b\u5efa\u5f53\u524d\u9876\u5e27\uff08\u542b\u8fb9\u754c\u8bc6\u522b\uff09\u2192 \u89e3\u6790 CodeInfo/StackMap \u2192 \u9010\u5e27\u56de\u6eaf\uff0c\u5e76\u63d0\u4f9b\u201c\u628a\u7f16\u8bd1\u5e27\u6062\u590d\u6210\u89e3\u91ca\u5668\u5e27\uff08ConvertToIFrame\uff09\u201d\u7b49\u53bb\u4f18\u5316\u5173\u952e\u80fd\u529b\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#create-nextframe","title":"\u4e00\u56fe\u8bfb\u61c2\uff1aCreate \u2192 NextFrame \u7684\u6838\u5fc3\u5206\u6d41","text":"<pre><code>flowchart TD\n  A[\"StackWalker::Create(thread)\"] --&gt; B[\"GetTopFrameFromFp(fp, isCompiled, npc)\"]\n  B --&gt; C{\"frame_ \u662f CFrame \u8fd8\u662f Frame*\uff1f\"}\n  C --&gt;|CFrame| D[\"NextFromCFrame()\\n(\u5904\u7406 inlineDepth + \u8fb9\u754c\u5e27)\"]\n  C --&gt;|Frame*| E[\"NextFromIFrame()\\n(\u9047\u5230\u8fb9\u754c\u5e27\u5219\u8f6c CFrame)\"]\n  D --&gt; F[\"frame_ \u66f4\u65b0\u4e3a\u4e0a\u4e00\u5e27\"]\n  E --&gt; F</code></pre>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#0-createctorresetl29l55","title":"0. Create/ctor/reset\uff1a\u6784\u9020\u65f6\u7684\u5b89\u5168\u524d\u7f6e\u6761\u4ef6\uff08L29\u2013L55\uff09","text":"<ul> <li>L33\uff1a<code>ASSERT(thread-&gt;IsRuntimeCallEnabled())</code>\uff1a\u5f3a\u8c03\u201c\u6784\u9020 walker \u524d\u5fc5\u987b\u5141\u8bb8 runtime call\u201d\uff0c\u5426\u5219\u53d6\u6808\u9876\u5e27\u53ef\u80fd\u5d29\u3002</li> <li>L34\u2013L37\uff1a\u53ef\u9009\u7684 VerifyCallStack\uff1a\u6784\u9020\u4e34\u65f6 walker \u5e76 <code>Verify()</code>\u3002</li> <li>L39\uff1a\u8fd4\u56de walker\uff08\u503c\u8fd4\u56de\uff0c\u5185\u90e8\u4ecd\u662f\u4e0d\u53ef\u62f7\u8d1d/\u4e0d\u53ef\u79fb\u52a8\u8bed\u4e49\u5728\u5934\u91cc\u9650\u5236\uff09\u3002</li> <li>L45\uff1actor \u91cc <code>frame_ = GetTopFrameFromFp(fp, isFrameCompiled, npc)</code>\uff1a\u9876\u5e27\u83b7\u53d6\u662f\u6838\u5fc3\u3002</li> <li>L46\u2013L48\uff1a<code>SKIP_INLINED</code> \u65f6\u628a <code>inlineDepth_=-1</code>\uff08\u5f3a\u5236\u201c\u4e0d\u5728 cframe \u5185\u4e0b\u6f5c\u5185\u8054\u65b9\u6cd5\u201d\uff09\u3002</li> <li>L54\u2013L55\uff1a<code>Reset(thread)</code>\uff1a\u590d\u7528 walker\uff0c\u91cd\u65b0\u53d6\u9876\u5e27\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#1-gettopframefromfpl58l77","title":"1. \u9876\u5e27\u9009\u62e9\uff1a<code>GetTopFrameFromFp</code>\uff08L58\u2013L77\uff09","text":"<p>\u6838\u5fc3\u5206\u652f\uff1a - \u82e5\u5f53\u524d\u662f\u7f16\u8bd1\u5e27\uff08<code>isFrameCompiled==true</code>\uff09\uff1a   - L61\u2013L73\uff1a\u82e5 fp \u6307\u5411\u201c\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\u201d\uff08<code>IsBoundaryFrame&lt;INTERPRETER&gt;(ptr)</code>\uff09\uff1a     - \u53d6\u8fb9\u754c\u5e27\u7684 prev\uff08<code>GetPrevFromBoundary&lt;INTERPRETER&gt;</code>\uff09\uff0c\u5e76\u68c0\u67e5 compiler \u8fb9\u754c\u662f\u5426 BYPASS\uff08L63\uff09\u3002     - BYPASS\uff1a\u7528 compiler \u8fb9\u754c\u7684 prev/return address/callee stack \u521b\u5efa CFrame\uff08L64\u2013L66\uff09\u3002     - \u5426\u5219\uff1a\u7528\u89e3\u91ca\u5668\u8fb9\u754c\u7684 prev/return address/callee stack \u521b\u5efa CFrame\uff08L68\u2013L72\uff09\u3002   - L74\uff1a\u82e5\u4e0d\u662f\u8fb9\u754c\u5e27\uff1a\u76f4\u63a5 <code>CreateCFrame(reinterpret_cast&lt;SlotType*&gt;(ptr), npc, nullptr)</code>\u3002 - \u82e5\u5f53\u524d\u662f\u89e3\u91ca\u5668\u5e27\uff1a\u76f4\u63a5\u628a fp \u89e3\u91ca\u4e3a <code>Frame*</code>\uff08L76\uff09\u3002</p> <p>\u7ed3\u8bba\uff1a\u9876\u5e27\u83b7\u53d6\u7b2c\u4e00\u4f18\u5148\u7ea7\u662f\u201c\u8bc6\u522b\u8fb9\u754c\u5e27\u201d\uff0c\u56e0\u4e3a\u8fb9\u754c\u5e27\u672c\u8eab\u4e0d\u662f\u53ef\u76f4\u63a5\u89e3\u6790\u7684\u666e\u901a\u5e27\u7ed3\u6784\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#2-method-aot-snapshotl79l116","title":"2. Method \u83b7\u53d6\uff1a\u5904\u7406\u5185\u8054\u65b9\u6cd5\u4e0e AOT snapshot\uff08L79\u2013L116\uff09","text":"<ul> <li>L82\u2013L95\uff1a<code>GetInlinedMethod(cframe)</code>\uff1a</li> <li>\u4ece <code>codeInfo_</code> \u53d6\u51fa\u201c\u5185\u8054\u65b9\u6cd5\u6807\u8bc6\u201d\uff08\u53ef\u80fd\u662f <code>uint32_t entityId</code>\uff0c\u4e5f\u53ef\u80fd\u662f\u76f4\u63a5\u7684\u6307\u9488\uff09\u3002</li> <li>\u82e5\u662f entityId\uff1a<ul> <li>\u901a\u8fc7 <code>inlineInfo.GetFileIndex()</code> \u5224\u65ad\u662f\u5426\u6765\u81ea AOT snapshot index\uff08L87\u2013L92\uff09\u3002</li> <li>\u82e5\u662f\uff1a\u8d70 <code>AotManager::GetPandaFileBySnapshotIndex</code> \u627e\u5230 pf\uff0c\u518d\u7528 <code>classLinker-&gt;GetMethod(*pf, entityId, loadContext)</code> \u89e3\u6790\u3002</li> <li>\u5426\u5219\uff1a\u7528 <code>classLinker-&gt;GetMethod(*cframe.GetMethod(), entityId)</code> \u89e3\u6790\u3002</li> </ul> </li> <li>L98\u2013L116\uff1a<code>GetMethod()</code>\uff1a</li> <li>iframe\uff1a\u76f4\u63a5 <code>frame-&gt;GetMethod()</code>\u3002</li> <li>cframe\uff1a<ul> <li>\u975e native \u4e14 stackmap \u65e0\u6548\u65f6\u8fd4\u56de nullptr\uff08L106\u2013L110\uff1aJIT trampolines \u6682\u65f6\u653e\u5bbd\uff09\u3002</li> <li>\u82e5\u5904\u4e8e\u5185\u8054\u6df1\u5ea6\uff1a\u8fd4\u56de <code>GetInlinedMethod()</code>\u3002</li> <li>\u5426\u5219\u8fd4\u56de <code>cframe.GetMethod()</code>\u3002</li> </ul> </li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#3-cframecodeentry-l132l178","title":"3. \u521b\u5efa CFrame\uff1acodeEntry \u7684\u4e09\u6001\u9009\u62e9\uff08L132\u2013L178\uff09","text":"<p><code>CreateCFrame(ptr, npc, ...)</code> \u7684\u6700\u5173\u952e\u70b9\u662f\u9009\u7528\u54ea\u4e2a code entry \u6765\u89e3\u6790 CodeInfo\uff1a</p> <ul> <li>L144\u2013L152\uff1a\u4f18\u5148\u7ea7\uff1a   1) <code>cframe.ShouldDeoptimize()</code>\uff1a\u4f7f\u7528 <code>cframe.GetDeoptCodeEntry()</code>\uff08\u5e38\u89c4 compiled entry \u53ef\u80fd\u5df2\u5931\u6548\uff09   2) <code>cframe.IsOsr()</code>\uff1a\u4ece VM compiler \u67e5\u8be2 OSR code\uff08<code>GetOsrCode(method)</code>\uff09   3) \u5426\u5219\uff1a<code>method-&gt;GetCompiledEntryPoint()</code></li> <li>L153\uff1a<code>codeInfo_ = CodeInfo::GetCodeOriginFromEntryPoint(codeEntry)</code>\uff1a\u4ece entrypoint \u627e\u5230 code origin \u5e76\u521d\u59cb\u5316 CodeInfo\u3002</li> <li>L155\u2013L162\uff1a\u7528 npc \u627e stackmap\uff1a</li> <li>npc==0\uff1a\u76f4\u63a5\u627e 0\uff08StackOverflow stackmap \u4f8b\u5916\uff09</li> <li>\u5426\u5219 npc \u8981\u51cf\u53bb code \u8d77\u59cb\u5730\u5740\u5f97\u5230\u76f8\u5bf9 pc\uff0c\u518d\u67e5 stackmap\uff08\u5e76\u505a\u8303\u56f4\u68c0\u67e5\uff09\u3002</li> <li>L171\u2013L175\uff1a\u4fdd\u5b58 callee reg masks\u3001<code>inlineDepth_</code>\uff0c\u5e76\u521d\u59cb\u5316 callee buffer\uff08<code>InitCalleeBuffer</code>\uff09\u3002</li> </ul> <p>\u8fd9\u662f\u201c\u6808\u904d\u5386\u6b63\u786e\u6027\u201d\u7684\u6839\uff1astackmap \u627e\u9519\u4f1a\u5bfc\u81f4 vreg/\u5bf9\u8c61\u904d\u5386\u4e0e deopt \u6062\u590d\u5168\u90e8\u5931\u771f\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#4-nextframel367l448","title":"4. NextFrame\uff1a\u8de8\u8fb9\u754c\u4e0e\u5185\u8054\u7b56\u7565\uff08L367\u2013L448\uff09","text":"<ul> <li>L367\u2013L374\uff1a<code>NextFrame()</code> \u5206\u6d41\u5230 <code>NextFromCFrame</code> \u6216 <code>NextFromIFrame</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#41-nextfromcframel376l423","title":"4.1 <code>NextFromCFrame</code>\uff08L376\u2013L423\uff09","text":"<p>1) \u5185\u8054\u5904\u7406\uff1a - L378\u2013L384\uff1a\u82e5 inlined \u4e14 policy \u5141\u8bb8\uff0c<code>inlineDepth_--</code>\uff08\u53ea\u4e0b\u6f5c\u540c\u4e00 cframe \u5185\u7684\u201c\u865a\u62df\u5e27\u201d\uff09\u3002</p> <p>2) \u5230\u4e0a\u4e00\u7269\u7406\u5e27\uff1a - L389\u2013L423\uff1a\u8bfb\u53d6 <code>prev</code>\uff0c\u5e76\u67e5\u770b <code>frameMethod = GetBoundaryFrameMethod&lt;COMPILER&gt;(prev)</code>\uff1a   - <code>INTERPRETER_TO_COMPILED_CODE</code>\uff1a\u8bf4\u660e\u518d\u5f80\u4e0a\u662f\u89e3\u91ca\u5668\u4fa7\uff0c\u53d6 <code>prevFrame</code> \u5e76\u6839\u636e\u662f\u5426\u662f\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\u51b3\u5b9a\u521b\u5efa cframe or iframe\uff08L396\u2013L405\uff09\u3002   - <code>BYPASS</code>\uff1a\u6709\u4e00\u6761\u201c\u8df3\u8fc7\u6865\u63a5\u201d\u7684\u8fb9\u754c\u5e03\u5c40\uff08L406\u2013L416\uff09\uff0c\u4e5f\u4f1a\u68c0\u67e5\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\u5e76\u521b\u5efa cframe\u3002   - default\uff1a\u5e38\u89c4\u60c5\u51b5\uff0c\u6cbf\u7f16\u8bd1\u5e27\u94fe\u56de\u6eaf\uff0c\u5e76\u643a\u5e26 prev callee \u4fdd\u5b58\u4fe1\u606f\uff08L418\u2013L421\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#42-nextfromiframel425l448","title":"4.2 <code>NextFromIFrame</code>\uff08L425\u2013L448\uff09","text":"<ul> <li>\u82e5 <code>prev</code> \u662f\u89e3\u91ca\u5668\u8fb9\u754c\u5e27\uff08L436\u2013L444\uff09\uff1a</li> <li>\u67e5\u770b compiler \u8fb9\u754c\u662f\u5426 BYPASS\uff1a<ul> <li>BYPASS\uff1a\u76f4\u63a5\u521b\u5efa cframe</li> <li>\u5426\u5219\uff1a<code>CreateCFrameForC2IBridge</code>\uff08\u9488\u5bf9 C2I \u8fb9\u754c\u7684\u7279\u6b8a\u5e03\u5c40\uff09</li> </ul> </li> <li>\u5426\u5219\uff1a\u76f4\u63a5 <code>frame_ = prev</code>\uff08\u7ee7\u7eed\u5728\u89e3\u91ca\u5668\u5e27\u94fe\u56de\u6eaf\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#5-deopt-getframefromprevframe-converttoiframel537l649","title":"5. deopt \u5173\u952e\u80fd\u529b\uff1a<code>GetFrameFromPrevFrame</code> / <code>ConvertToIFrame</code>\uff08L537\u2013L649\uff09","text":""},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#51-getframefromprevframe-cframe-iframe","title":"5.1 <code>GetFrameFromPrevFrame</code>\uff1a\u4ece cframe \u6062\u590d iframe \u7684\u201c\u6570\u636e\u642c\u8fd0\u201d","text":"<ul> <li>\u52a8\u6001\u65b9\u6cd5\uff08L544\u2013L576\uff09\uff1a</li> <li>\u4f7f\u7528 <code>CreateFrameWithActualArgs&lt;true&gt;(...)</code> \u521b\u5efa frame\uff0c\u5e76 <code>frame-&gt;SetDynamic()</code>\u3002</li> <li>\u6839\u636e vregList \u7684 live \u4fe1\u606f\uff0c\u628a pack vreg \u503c\u5199\u5165 iframe\uff08\u6ce8\u610f <code>ACC_OFFSET</code> \u4e0e env \u533a\u57df\uff09\u3002</li> <li>\u6784\u9020 <code>EnvData</code> \u5e76\u8c03\u7528 <code>LanguageContext::RestoreEnv(frame, envData)</code> \u6062\u590d\u52a8\u6001\u8bed\u8a00\u7684\u73af\u5883\u6570\u636e\u3002</li> <li>\u9759\u6001\u65b9\u6cd5\uff08L577\u2013L592\uff09\uff1a</li> <li><code>CreateFrame(frameNumVregs, method, prevFrame)</code>\uff0c\u5e76\u628a vregList\uff08\u5305\u542b acc\uff09\u7684 live \u503c\u62f7\u56de\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a\u8fd9\u91cc\u5c31\u662f deopt \u201c\u72b6\u6001\u91cd\u5efa\u201d\u7684\u6838\u5fc3\u8bc1\u636e\u70b9\uff1a\u54ea\u4e9b vregs/acc \u88ab\u8ba4\u4e3a live\u3001\u5982\u4f55\u4ece cframe \u7684 stackmap/codeinfo \u6620\u5c04\u56de\u89e3\u91ca\u5668\u5e03\u5c40\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#52-converttoiframe","title":"5.2 <code>ConvertToIFrame</code>\uff1a\u5904\u7406\u5185\u8054\u3001\u8fb9\u754c\u3001\u5e76\u8bbe\u7f6e\u6807\u5fd7\u4f4d","text":"<ul> <li>L608\u2013L618\uff1a\u82e5\u5f53\u524d\u5728 inlined \u6df1\u5ea6\uff1a\u9012\u5f52\u5148\u6062\u590d\u66f4\u65e9\u7684 prevFrame\uff0c\u518d\u8bfb\u53d6\u5176 pc \u5224\u65ad\u662f\u5426 INIT_OBJ\uff08\u7528\u4e8e\u540e\u7eed\u6807\u8bb0 <code>SetInitobj()</code>\uff09\u3002</li> <li>L623\u2013L635\uff1a\u975e inlined \u65f6\uff1a</li> <li>\u82e5 <code>IsCompilerBoundFrame(prev)</code>\uff1a\u8bf4\u660e\u8de8\u8fb9\u754c\u5230\u89e3\u91ca\u5668\u4fa7\uff08\u8bbe\u7f6e <code>prevFrameKind=INTERPRETER</code>\uff0c\u5e76\u6807\u8bb0 <code>isInvoke=true</code>\uff09\u3002</li> <li>\u5426\u5219\u4ecd\u5728\u7f16\u8bd1\u4fa7\uff08<code>prevFrameKind=COMPILER</code>\uff09\u3002</li> <li>L638\u2013L648\uff1a\u6784\u9020 iframe \u5e76\u8bbe\u7f6e\uff1a</li> <li><code>SetDeoptimized()</code></li> <li><code>SetBytecodeOffset(GetBytecodePc())</code></li> <li>\u82e5 INITOBJ\uff1a<code>SetInitobj()</code>\uff1b\u82e5\u8de8\u8fb9\u754c invoke\uff1a<code>SetInvoke()</code></li> </ul> <p>\u8fd9\u4e0e <code>runtime/bridge/bridge.cpp</code> \u7684 INITOBJ \u7279\u5224\uff08\u907f\u514d acc \u8986\u76d6\uff09\u5728\u8bed\u4e49\u4e0a\u547c\u5e94\uff1a\u4e24\u5904\u90fd\u5728\u89e3\u51b3\u201c\u6784\u9020\u5bf9\u8c61\u6307\u4ee4\u62c6\u5206 + \u53bb\u4f18\u5316\u6062\u590d\u201d\u7684\u4e00\u81f4\u6027\u95ee\u9898\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_stack_walker.cpp/#6-debugverify-vregsl658l719","title":"6. Debug/Verify\uff1a\u7528\u5bf9\u8c61/\u7c7b\u578b\u4e00\u81f4\u6027\u9a8c\u8bc1\u6808\u4e0e vregs\uff08L658\u2013L719\uff09","text":"<ul> <li><code>DebugSingleFrameVerify</code> \u901a\u8fc7 <code>IterateVRegsWithInfo</code> \u6821\u9a8c\uff1a</li> <li>vreg \u7684 object/scalar \u4e0e <code>VRegInfo</code> \u7684\u7c7b\u578b\u4e00\u81f4</li> <li>\u82e5\u662f\u5bf9\u8c61\uff0c<code>object-&gt;ClassAddr&lt;Class&gt;()</code> \u5fc5\u987b\u5728 objects heap \u5185</li> <li><code>Verify()</code> \u904d\u5386\u6240\u6709\u5e27\u5e76\u9010\u5e27\u9a8c\u8bc1\uff08\u4ec5 NDEBUG \u5173\u95ed\u65f6\u542f\u7528\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/","title":"<code>runtime/templates/bridge_dispatch.S.erb</code>\uff08I2C dispatch\uff1a\u6309 call-format \u5206\u53d1\u5230 handler\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>bridge_dispatch_&lt;arch&gt;.S</code> \u7684\u6a21\u677f\u6587\u4ef6\uff0c\u7528\u4e8e I2C bridge\uff08static shorty calling convention\uff09\u5728\u6c47\u7f16\u91cc\u6309 \u201ccall \u6307\u4ee4\u7684 format/\u5206\u7c7b\u201d \u5206\u53d1\u5230\u5bf9\u5e94\u7684 <code>handle_call_&lt;format&gt;.S</code> \u7247\u6bb5\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/#1","title":"1) \u8fd9\u6a21\u677f\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>I2C bridge \u7684\u6838\u5fc3\u4efb\u52a1\u662f\uff1a\u628a\u89e3\u91ca\u5668\u4fa7\u7684\u201c\u8c03\u7528\u6307\u4ee4 + Frame/Method/Thread\u201d\u7b49\u4fe1\u606f\uff0c\u6309\u76ee\u6807\u5e73\u53f0 ABI \u7ec4\u88c5\u6210\u8c03\u7528\u53c2\u6570\uff0c\u5e76\u8c03\u7528 <code>method-&gt;compiled_entrypoint</code>\u3002</p> <p>\u4f46 call \u6307\u4ee4\u5b58\u5728\u591a\u79cd format\uff08\u4e0d\u540c\u64cd\u4f5c\u6570\u5e03\u5c40/\u4f20\u53c2\u89c4\u5219\uff09\uff0c\u56e0\u6b64\u6865\u63a5\u6c47\u7f16\u9700\u8981\u5148\u505a\u4e00\u6b21 \u6309 format \u7684\u5206\u53d1\uff1a</p> <ul> <li>\u8bc6\u522b\u5f53\u524d call opcode \u5c5e\u4e8e\u54ea\u4e2a format</li> <li>\u8df3\u8f6c\u5230\u8be5 format \u7684 handler\uff08<code>handle_call_&lt;format&gt;.S</code>\uff09\u53bb\u7ec4\u88c5\u53c2\u6570\u5e76\u53d1\u8d77\u8c03\u7528</li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/#2","title":"2) \u6a21\u677f\u7ed3\u6784\uff08\u8bfb\u61c2\u5c31\u80fd\u8bfb\u61c2\u751f\u6210\u7269\uff09","text":"<p>\u6a21\u677f\u672c\u8eab\u5f88\u77ed\uff0c\u4f46\u4fe1\u606f\u5bc6\u5ea6\u5f88\u9ad8\uff0c\u6838\u5fc3\u662f\u4e24\u6bb5\u5faa\u73af\uff1a</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/#21-opcode-lhandle_fmt","title":"2.1 \u6bd4\u8f83 opcode \u5e76\u8df3\u8f6c\u5230 <code>.Lhandle_&lt;fmt&gt;</code>","text":"<ul> <li><code>calls = get_call_insns()</code>\uff1a\u6536\u96c6\u6240\u6709 call \u7c7b\u6307\u4ee4\uff08\u6765\u81ea ISA/\u811a\u672c\u4fa7\uff09</li> <li><code>classified_calls = classify_calls(calls)</code>\uff1a\u6309 format \u5206\u7c7b</li> <li>\u5bf9\u6bcf\u4e2a format\uff0c\u751f\u6210\u4e00\u4e32\uff1a</li> <li><code>cmp_opcode(insn.opcode_idx)</code></li> <li><code>jump_eq(\".Lhandle_#{fmt}\")</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/#22-lhandle_fmt-include-handler","title":"2.2 \u5728 <code>.Lhandle_&lt;fmt&gt;</code> \u4e2d <code>#include</code> \u5bf9\u5e94 handler","text":"<p>\u5bf9\u6bcf\u4e2a format \u751f\u6210\u4e00\u4e2a label\uff1a</p> <ul> <li><code>.Lhandle_&lt;fmt&gt;:</code> \u540e\u7d27\u63a5 <code>#include \"&lt;%= handler_path(fmt) %&gt;\"</code></li> </ul> <p>\u8fd9\u4e9b\u88ab include \u7684 <code>handle_call_&lt;format&gt;.S</code> \u624d\u662f\u201c\u771f\u6b63\u7ec4\u88c5\u53c2\u6570/\u8c03\u7528 entrypoint/\u5199\u56de\u8fd4\u56de\u503c\u201d\u7684\u5b9e\u73b0\u7247\u6bb5\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch.S.erb/#3-s-i2c-include","title":"3) \u751f\u6210\u94fe\uff08\u6a21\u677f \u2192 \u751f\u6210 .S \u2192 \u88ab I2C include\uff09","text":"<p>\u8bc1\u636e\u94fe\uff08\u4ece\u6784\u5efa\u7cfb\u7edf\u5230\u6700\u7ec8\u6c47\u7f16\uff09\uff1a</p> <ul> <li>GN\uff1a<code>runtime/BUILD.gn</code></li> <li><code>bridge_dispatch_template = \"templates/bridge_dispatch.S.erb\"</code></li> <li>\u751f\u6210\u8f93\u51fa\uff1a<code>bridge_dispatch_&lt;arch&gt;.S</code></li> <li>CMake\uff1a<code>runtime/CMakeLists.txt</code></li> <li><code>BRIDGE_DISPATCH_TEMPLATE=.../templates/bridge_dispatch.S.erb</code></li> <li>\u751f\u6210\u8f93\u51fa\uff1a<code>${GEN_INCLUDE_DIR}/bridge_dispatch_${arch}.S</code></li> <li>I2C \u6c47\u7f16\u4f7f\u7528\u70b9\uff08\u793a\u4f8b\uff09\uff1a</li> <li><code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_aarch64.S</code> \u4e2d <code>#include \"bridge_dispatch_aarch64.S\"</code></li> <li><code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_amd64.S</code> \u4e2d <code>#include \"bridge_dispatch_amd64.S\"</code></li> <li><code>runtime/bridge/arch/x86/interpreter_to_compiled_code_bridge_x86.S</code> \u4e2d <code>#include \"bridge_dispatch_x86.S\"</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch_dyn.S.erb/","title":"<code>runtime/templates/bridge_dispatch_dyn.S.erb</code>\uff08I2C dyn dispatch\uff1a\u52a8\u6001\u8c03\u7528\u7ea6\u5b9a\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>bridge_dispatch_dyn_&lt;arch&gt;.S</code> \u7684\u6a21\u677f\u6587\u4ef6\uff0c\u4f9b dynamic/TaggedValue \u8bed\u4e49\u7684 I2C bridge \u4f7f\u7528\uff08\u628a\u4e0d\u540c call format \u5206\u53d1\u5230\u5404 <code>handle_call_&lt;format&gt;_dyn.S</code> \u7247\u6bb5\uff09\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch_dyn.S.erb/#1-dyn-dispatch","title":"1) \u4e3a\u4ec0\u4e48\u9700\u8981 dyn dispatch","text":"<p>\u52a8\u6001\u8bed\u8a00/TaggedValue \u8c03\u7528\u5728\u6865\u63a5\u5c42\u901a\u5e38\u9700\u8981\uff1a</p> <ul> <li>\u989d\u5916\u7684 tag/value \u5904\u7406</li> <li>\u66f4\u590d\u6742\u7684\u53c2\u6570\u5c55\u5f00/\u538b\u6808\u7b56\u7565</li> <li>\u4e0e\u9759\u6001 shorty \u8c03\u7528\u4e0d\u540c\u7684\u8fd4\u56de\u503c\u5199\u56de\u89c4\u5219</li> </ul> <p>\u56e0\u6b64 dyn I2C \u4f1a\u4f7f\u7528\u72ec\u7acb\u7684 dispatch \u751f\u6210\u7269\uff1a<code>bridge_dispatch_dyn_&lt;arch&gt;.S</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_bridge_dispatch_dyn.S.erb/#2","title":"2) \u751f\u6210\u94fe\uff08\u8bc1\u636e\u94fe\uff09","text":"<ul> <li>GN\uff1a<code>runtime/BUILD.gn</code></li> <li><code>bridge_dispatch_dyn_template = \"templates/bridge_dispatch_dyn.S.erb\"</code></li> <li>\u751f\u6210\u8f93\u51fa\uff1a<code>bridge_dispatch_dyn_&lt;arch&gt;.S</code></li> <li>CMake\uff1a<code>runtime/CMakeLists.txt</code></li> <li><code>BRIDGE_DISPATCH_DYN_TEMPLATE=.../templates/bridge_dispatch_dyn.S.erb</code></li> <li>\u751f\u6210\u8f93\u51fa\uff1a<code>${GEN_INCLUDE_DIR}/bridge_dispatch_dyn_${arch}.S</code></li> <li>dyn I2C \u6c47\u7f16\u4f7f\u7528\u70b9\uff08\u793a\u4f8b\uff09\uff1a</li> <li><code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_dyn_aarch64.S</code> \u4e2d <code>#include \"bridge_dispatch_dyn_aarch64.S\"</code></li> <li><code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_dyn_amd64.S</code> \u4e2d <code>#include \"bridge_dispatch_dyn_amd64.S\"</code></li> </ul>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_plugins_interpreters-inl.h.erb/","title":"<code>runtime/templates/plugins_interpreters-inl.h.erb</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u63d2\u4ef6\u6269\u5c55\u70b9\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 04_ExecutionEngine \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u751f\u6210 <code>plugins_interpreters-inl.h</code>\uff0c\u7528\u4e8e\u628a\u201c\u63d2\u4ef6\u63d0\u4f9b\u7684\u89e3\u91ca\u5668\u6269\u5c55 inl\u201d\u805a\u5408\u5230\u4e3b\u89e3\u91ca\u5668\u751f\u6210\u6587\u4ef6\u4e2d\u3002 \u8be5\u6587\u4ef6\u88ab <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u76f4\u63a5 <code>#include</code>\u3002</p>"},{"location":"04_ExecutionEngine/FileNotes/runtime_templates_plugins_interpreters-inl.h.erb/#1-l19l21","title":"1. \u751f\u6210\u903b\u8f91\uff08L19\u2013L21\uff09","text":"<ul> <li>L19\u2013L21\uff1a\u904d\u5386\u63d2\u4ef6\u9009\u9879 <code>\"additional_interpter_inl\"</code>\uff08\u6ce8\u610f\u62fc\u5199\u662f <code>interpter</code>\uff09\uff0c\u5bf9\u6bcf\u4e2a\u6761\u76ee\u751f\u6210\u4e00\u6761 <code>#include \"&lt;path&gt;\"</code>\u3002</li> </ul> <p>\u542b\u4e49\uff1a - \u63d2\u4ef6\u53ef\u4ee5\u901a\u8fc7\u6784\u5efa\u7cfb\u7edf\u628a\u201c\u989d\u5916\u7684 handler/\u8f85\u52a9\u903b\u8f91\u201d\u4ee5 inl \u7684\u5f62\u5f0f\u6ce8\u5165\u89e3\u91ca\u5668\u7f16\u8bd1\u5355\u5143\u3002 - \u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48 <code>interpreter-inl_gen.h</code> \u9700\u8981\u5305\u542b\u4e00\u4e2a\u201c\u63d2\u4ef6\u805a\u5408\u5934\u201d\uff1a\u4e0d\u6539 core \u4ee3\u7801\u4e5f\u80fd\u6269\u5c55 ISA/\u884c\u4e3a\uff08\u6bd4\u5982\u65b0\u589e\u8bed\u8a00/\u5b57\u8282\u7801\u6269\u5c55\uff09\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/","title":"Flow\uff1aBridge\uff08I2C/C2I\uff09\u2014\u2014\u89e3\u91ca\u5668 \u2194 \u7f16\u8bd1\u4ee3\u7801\u4e92\u8c03","text":""},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201c\u8c03\u7528/\u6865\u63a5\uff08\u89e3\u91ca\u5668 \u2194 compiled\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u6865\u63a5\u95ee\u9898\u901a\u5e38\u8868\u73b0\u4e3a\u201c\u8df3\u5230 compiled \u5c31\u5d29/\u8fd4\u56de\u503c\u9519/\u6808\u4e0d\u5bf9\u201d\u3002 \u8fd9\u6761 flow \u628a\u5173\u952e\u8fb9\u754c\u70b9\u6807\u51fa\u6765\uff0c\u8ba9\u4f60\u80fd\u5feb\u901f\u5b9a\u4f4d\uff1a - I2C\uff1a\u89e3\u91ca\u5668\u5982\u4f55\u8c03\u7528 compiled entrypoint - C2I\uff1acompiled \u4f55\u65f6/\u5982\u4f55\u56de\u89e3\u91ca\u5668\uff08InvokeInterpreter\uff09 - \u8fd4\u56de\u503c\u4e0e acc \u7684\u5199\u56de\u8bed\u4e49 - FrameKind \u5207\u6362\u70b9\uff08StackWalker/deopt \u4f9d\u8d56\uff09</p>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#2-mermaid","title":"2) Mermaid\uff1a\u53cc\u5411\u6865\u63a5\u4e3b\u7ebf\uff08\u6982\u5ff5\uff09","text":"<pre><code>sequenceDiagram\n  participant INT as Interpreter\n  participant M as Method(entrypoint)\n  participant BR as Bridge\n  participant CC as Compiled Code\n\n  INT-&gt;&gt;M: \u53d6 compiled entrypoint\n  alt entrypoint \u5b58\u5728\n    INT-&gt;&gt;BR: InterpreterToCompiledCodeBridge(...)\n    BR-&gt;&gt;CC: \u8fdb\u5165 compiled\n    alt \u9700\u8981\u56de\u9000/\u5f02\u5e38/deopt\n      CC-&gt;&gt;BR: CompiledCodeToInterpreterBridge(...)\n      BR-&gt;&gt;INT: InvokeInterpreter(pc, frame)\n      INT--&gt;&gt;BR: acc/\u8fd4\u56de\u503c\n      BR--&gt;&gt;CC: \u8fd4\u56de/\u7ee7\u7eed unwind\n    else \u6b63\u5e38\u8fd4\u56de\n      CC--&gt;&gt;BR: \u8fd4\u56de\u503c\n      BR--&gt;&gt;INT: \u5199\u56de acc/\u8fd4\u56de\n    end\n  else entrypoint \u4e0d\u5b58\u5728\n    INT-&gt;&gt;INT: \u7ee7\u7eed\u89e3\u91ca\u6267\u884c\uff08\u6216\u89e6\u53d1\u7f16\u8bd1\uff09\n  end</code></pre>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#21-mermaidi2cc2i","title":"2.1 Mermaid\uff1ai2c/c2i \u7684\u201c\u903b\u8f91\u6808\u5f62\u6001\u201d\uff08\u4f60\u8c03\u8bd5/\u6808\u56de\u6eaf\u65f6\u770b\u5230\u7684\u90a3\u79cd\uff09","text":"<p>\u8bf4\u660e\uff1a\u8fd9\u662f \u903b\u8f91\u5f62\u6001\uff0c\u771f\u5b9e\u673a\u5668\u6808\u8fd8\u5305\u542b arch/ABI \u4fdd\u5b58\u533a\u4e0e\u82e5\u5e72\u8fc7\u6e21\u5e27\u3002 \u4f60\u5b9a\u4f4d\u7f3a\u5e27/\u9519\u5e27\u65f6\uff0c\u5148\u7528\u8fd9\u5f20\u56fe\u5bf9\u9f50 FrameKind + boundary frame\uff0c\u518d\u53bb\u770b <code>runtime/bridge/arch/*</code> \u7ec6\u8282\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#a-interpreter-compiledi2c","title":"A) Interpreter \u2192 Compiled\uff08I2C\uff09\u4e4b\u540e\u7684\u5178\u578b\u6808","text":"<pre><code>flowchart TB\n  subgraph Stack[\"Call Stack\uff08Top \u2192 Bottom\uff09\"]\n    CF[\"CFrame: compiled callee\\n- pc: native return addr\\n- CodeInfo/StackMap\\n- may contain inlined frames\"]\n    B1[\"BoundaryFrame: INTERPRETER_TO_COMPILED_CODE\\n(I2C boundary)\\n- marks transition for StackWalker\"]\n    IF0[\"IFrame: interpreter caller\\nFrame* chain\\n- prev_/method_/bcOffset_/acc/vregs\"]\n    IF1[\"... older interpreter frames ...\"]\n  end\n  CF --&gt; B1 --&gt; IF0 --&gt; IF1</code></pre>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#b-compiled-interpreterc2i-invokeinterpreter","title":"B) Compiled \u2192 Interpreter\uff08C2I / InvokeInterpreter\uff09\u4e4b\u540e\u7684\u5178\u578b\u6808","text":"<pre><code>flowchart TB\n  subgraph Stack2[\"Call Stack\uff08Top \u2192 Bottom\uff09\"]\n    IFc[\"IFrame: interpreter callee (created/resumed)\\n- pc: bytecode pc\\n- acc/vregs restored/continued\"]\n    B2[\"BoundaryFrame: COMPILED_CODE_TO_INTERPRETER\\n(C2I boundary)\\n- marks transition for StackWalker\"]\n    CF0[\"CFrame: compiled caller\\n- may be deoptimized/unwinding\"]\n    CF1[\"... older compiled frames ...\"]\n    IFo[\"... older interpreter frames ...\"]\n  end\n  IFc --&gt; B2 --&gt; CF0 --&gt; CF1 --&gt; IFo</code></pre> <p>\u5173\u952e\u70b9\uff1aStackWalker \u4f9d\u8d56 boundary frame \u4e0e thread \u7684 \u201ccurrentFrameIsCompiled\u201d \u72b6\u6001\uff0c\u624d\u80fd\u5728 IFrame/CFrame \u4e24\u5957\u89e3\u7801\u89c4\u5219\u4e4b\u95f4\u6b63\u786e\u5207\u6362\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#22-mermaidthreadframekind","title":"2.2 Mermaid\uff1aThread/FrameKind \u5207\u6362\u70b9\u6e05\u5355\uff08\u6392\u969c\u7528\uff09","text":"<pre><code>sequenceDiagram\n  participant T as ManagedThread\n  participant INT as Interpreter\n  participant I2C as I2C boundary\n  participant CC as Compiled code\n  participant C2I as C2I boundary\n\n  Note over INT: \u89e3\u91ca\u5668\u6267\u884c\u4e2d\\nT.currentFrame = Frame*\\nT.currentFrameIsCompiled=false\n  INT-&gt;&gt;I2C: InterpreterToCompiledCodeBridge(pc, frame, method, thread)\n  Note over I2C,CC: \u8fdb\u5165 compiled\\n\u51fa\u73b0 INTERPRETER_TO_COMPILED_CODE \u8fb9\u754c\u5e27\n  CC-&gt;&gt;C2I: CompiledCodeToInterpreterBridge / InvokeInterpreter\n  Note over C2I,INT: \u56de\u89e3\u91ca\u5668\u524d\u5fc5\u987b\uff1a\\nT.SetCurrentFrame(frame)\\nT.currentFrameIsCompiled=false\\nFrameKind/\u8fb9\u754c\u5e27\u53ef\u8bc6\u522b\n  INT--&gt;&gt;CC: \u901a\u8fc7 acc/\u8fd4\u56de\u503c\u534f\u8bae\u8fd4\u56de</code></pre>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#3","title":"3) \u6392\u969c\u6293\u624b\uff08\u4f60\u8be5\u770b\u54ea\u4e9b\u70b9\uff09","text":"<ul> <li>InvokeInterpreter \u7684\u9aa8\u67b6\uff1aframe kind \u5207\u6362\u3001<code>thread-&gt;SetCurrentFrame(frame)</code>\u3001acc \u5199\u56de\u3001FreeFrame</li> <li>arch \u76f8\u5173\uff1a\u771f\u6b63\u7684\u5bc4\u5b58\u5668\u4fdd\u5b58/ABI \u5728 <code>runtime/bridge/arch/*</code>\uff08\u672c\u7ae0\u5df2\u5728 4.1 arch \u6c47\u7f16\u8bc1\u636e\u94fe \u63d0\u4f9b aarch64/amd64 \u7684\u4e00\u952e\u4e0b\u6f5c\u5165\u53e3\uff1b\u9700\u8981\u201c\u7269\u7406\u6808\u5e27/\u5bc4\u5b58\u5668\u4fdd\u5b58/TLS \u66f4\u65b0\u70b9\u201d\u65f6\u4ee5\u6c47\u7f16\u4e3a\u51c6\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#4","title":"4) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/bridge/bridge.h</code>\u3001<code>runtime/bridge/bridge.cpp</code></li> <li>Bridge_ABI_and_FrameKind\uff08DataStructure\uff09</li> <li>\u4ea4\u754c\u9762\uff1a<code>runtime/deoptimization.*</code>\u3001<code>runtime/include/stack_walker.h</code></li> <li>\u7279\u522b\u5173\u6ce8\uff1a<code>StackWalker</code> \u7684 boundary frame \u5224\u5b9a\u3001\u4ee5\u53ca <code>ConvertToIFrame</code>\uff08deopt \u65f6\u91cd\u5efa\u89e3\u91ca\u5668\u5e27\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#5","title":"5) \u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u4f60\u60f3\u770b\u201ccompiled \u8c03 runtime \u6162\u8def\u5f84\u201d \u2192 Entrypoints_and_RuntimeInterface</li> <li>\u4f60\u9047\u5230\u201cdeopt-after/OSR/\u56de\u9000\u89e3\u91ca\u5668\u201d \u2192 Deopt_and_OSR</li> <li>\u4f60\u9047\u5230\u201c\u5f02\u5e38\u7f3a\u5e27/\u6808\u56de\u6eaf\u4e0d\u4e00\u81f4\u201d \u2192 StackWalking</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Bridge_I2C_C2I/#41-arch-abi","title":"4.1 arch \u6c47\u7f16\u8bc1\u636e\u94fe\uff08\u5efa\u8bae\u6536\u85cf\uff1a\u4ece\u201c\u6982\u5ff5\u201d\u4e00\u952e\u4e0b\u6f5c\u5230\u201c\u6808/ABI\u201d\uff09","text":"<p>\u8bf4\u660e\uff1a\u8fd9\u7ec4\u6c47\u7f16\u662f \u201cI2C/C2I/deopt/proxy \u7684\u6700\u7ec8\u771f\u76f8\u5c42\u201d\u3002 \u65b0\u4eba\u4e0d\u9700\u8981\u9010\u884c\u80cc\uff0c\u4f46\u5f53\u4f60\u9047\u5230 \u7f3a\u5e27/\u9519\u5e27/\u5f02\u5e38\u65e0\u6cd5\u8de8\u8fb9\u754c/\u8fd4\u56de\u503c\u9519/GC safepoint \u5d29\uff0c\u8fd9\u91cc\u662f\u6700\u5feb\u7684\u5b9a\u4f4d\u5165\u53e3\u3002</p> <ul> <li>aarch64 / I2C\uff08\u9759\u6001 shorty\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_aarch64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_aarch64.S.md</li> <li>aarch64 / I2C\uff08dyn\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/interpreter_to_compiled_code_bridge_dyn_aarch64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_interpreter_to_compiled_code_bridge_dyn_aarch64.S.md</li> <li>aarch64 / C2I\uff08\u9759\u6001 shorty\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_aarch64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_aarch64.S.md</li> <li>aarch64 / C2I\uff08dyn\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/compiled_code_to_interpreter_bridge_dyn_aarch64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_compiled_code_to_interpreter_bridge_dyn_aarch64.S.md</li> <li>aarch64 / proxy entrypoint\uff08\u5f02\u5e38\u6865\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/proxy_entrypoint_aarch64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_proxy_entrypoint_aarch64.S.md</li> <li>aarch64 / deopt-after\uff08CFrame\u2192C2I \u53d8\u5f62\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/aarch64/deoptimization_aarch64.S</code></li> <li> <p>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_aarch64_deoptimization_aarch64.S.md</p> </li> <li> <p>amd64 / I2C\uff08\u9759\u6001 shorty\uff09\uff1a</p> </li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_amd64.S.md</li> <li>amd64 / I2C\uff08dyn\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/interpreter_to_compiled_code_bridge_dyn_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_interpreter_to_compiled_code_bridge_dyn_amd64.S.md</li> <li>amd64 / C2I\uff08\u9759\u6001 shorty\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_amd64.S.md</li> <li>amd64 / C2I\uff08dyn\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/compiled_code_to_interpreter_bridge_dyn_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_compiled_code_to_interpreter_bridge_dyn_amd64.S.md</li> <li>amd64 / proxy entrypoint\uff08\u5f02\u5e38\u6865\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/proxy_entrypoint_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_proxy_entrypoint_amd64.S.md</li> <li>amd64 / deopt-after\uff08CFrame\u2192C2I \u53d8\u5f62\uff09\uff1a</li> <li>\u6e90\u7801\uff1a<code>runtime/bridge/arch/amd64/deoptimization_amd64.S</code></li> <li>\u9010\u884c\u7b14\u8bb0\uff1aFileNotes/runtime_bridge_arch_amd64_deoptimization_amd64.S.md</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/","title":"Flow\uff1aDeopt \u4e0e OSR\uff08\u56de\u9000\u4e0e\u4e2d\u9014\u5207\u6362\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201cJIT/OSR\uff08\u70ed\u70b9\u89e6\u53d1\uff09\u201d\u4e0e\u201cDeopt\uff08compiled\u2192\u89e3\u91ca\u5668\u6062\u590d\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u5f53\u4f60\u9047\u5230\uff1a - \u201c\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u7a81\u7136\u56de\u9000\u89e3\u91ca\u5668/\u6027\u80fd\u6389\u5d16\u201d - \u201cOSR \u660e\u660e\u5e94\u8be5\u89e6\u53d1\u4f46\u6ca1\u89e6\u53d1\u201d - \u201cdeopt \u540e\u8bed\u4e49\u4e0d\u5bf9/\u8fd4\u56de\u503c\u9519/pc \u9519\u201d</p> <p>\u4f60\u9700\u8981\u4e00\u5f20\u201c\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u201d\u6765\u5b9a\u4f4d\uff1a\u89e6\u53d1\u70b9\u5728\u54ea\u91cc\u3001\u72b6\u6001\u5982\u4f55\u6062\u590d/\u5207\u6362\u3001\u4e0e\u6865\u63a5/\u6808\u904d\u5386\u5982\u4f55\u8026\u5408\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#2-mermaidosrosr-compiled","title":"2) Mermaid\uff1aOSR\uff08\u89e3\u91ca\u5668\u2192OSR compiled\uff09","text":"<pre><code>flowchart TD\n  A[\"Interpreter \u6267\u884c\"] --&gt; B{\"\u70ed\u70b9/\u56de\u8fb9\u89e6\u53d1\uff1f\"}\n  B --&gt;|\u662f| C[\"\u8bf7\u6c42/\u68c0\u67e5 OSR\\n(runtime/osr.*)\"]\n  C --&gt; D{\"OSR code \u53ef\u7528\u4e14\u5141\u8bb8\u5b89\u88c5\uff1f\\n(runtime/compiler.* + \u72b6\u6001\u4f4d)\"}\n  D --&gt;|\u5426| A\n  D --&gt;|\u662f| E[\"\u8fdb\u5165 OSR compiled entrypoint\\n\uff08\u901a\u8fc7 bridge/\u7ea6\u5b9a\uff09\"]\n  E --&gt; F[\"\u7ee7\u7eed\u6267\u884c\uff08compiled\uff09\"]</code></pre>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#3-mermaiddeoptcompiled","title":"3) Mermaid\uff1aDeopt\uff08compiled\u2192\u89e3\u91ca\u5668\u6062\u590d\uff09","text":"<pre><code>flowchart TD\n  A[\"Compiled \u6267\u884c\"] --&gt; B{\"\u5047\u8bbe\u5931\u6548/\u4fdd\u62a4\u68c0\u67e5/\u5f02\u5e38\u8fb9\u754c\uff1f\"}\n  B --&gt;|\u662f| C[\"\u89e6\u53d1 Deopt\\n(runtime/deoptimization.*)\"]\n  C --&gt; D[\"\u91cd\u5efa\u89e3\u91ca\u5668 Frame/VRegs/PC/Acc\"]\n  D --&gt; E[\"\u901a\u8fc7 C2I/InvokeInterpreter \u56de\u89e3\u91ca\u5668\u7ee7\u7eed\"]\n  E --&gt; F[\"Interpreter \u6267\u884c\u540e\u7eed\u5b57\u8282\u7801\"]\n  B --&gt;|\u5426| A</code></pre>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#4-stackwalkerbridge","title":"4) \u4e0e StackWalker/Bridge \u7684\u4ea4\u754c\u70b9\uff08\u4f60\u8be5\u8bb0\u4f4f\u7684\uff09","text":"<ul> <li>StackWalker\uff1adeopt/\u5f02\u5e38/\u8c03\u8bd5\u5e38\u9700\u8981\u5148\u201c\u8d70\u6808\u627e\u8fb9\u754c\u201d\uff0c\u6240\u4ee5 stack walking \u5f80\u5f80\u4e0e deopt \u540c\u65f6\u51fa\u73b0</li> <li>Bridge\uff08C2I\uff09\uff1adeopt \u540e\u4e00\u822c\u901a\u8fc7 C2I/InvokeInterpreter \u628a\u63a7\u5236\u6743\u4ea4\u56de\u89e3\u91ca\u5668</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#41-osr","title":"4.1 OSR \u89e6\u53d1\u70b9\uff08\u8865\u5145\uff1a\u89e3\u91ca\u5668\u56de\u8fb9\uff09","text":"<p>\u5728\u89e3\u91ca\u5668\u6267\u884c\u4e2d\uff0cOSR \u5f80\u5f80\u4e0d\u662f\u201c\u968f\u4fbf\u67d0\u6761\u6307\u4ee4\u89e6\u53d1\u201d\uff0c\u800c\u662f\u5728 \u56de\u8fb9/\u5206\u652f\u63d2\u6869 \u5904\u53d1\u751f\uff1a</p> <ul> <li>\u4ec5\u56de\u8fb9\uff08back-edge\uff09\u89e6\u53d1\uff1a<code>InstrumentBranches(int32_t offset)</code> \u91cc\u660e\u786e\uff1a<code>offset &gt; 0</code> \u76f4\u63a5\u8fd4\u56de\uff08\u4e0d\u662f\u56de\u8fb9\uff09\uff1b<code>offset &lt;= 0</code> \u624d\u8fdb\u5165 safepoint/OSR \u903b\u8f91\u3002</li> <li>\u56de\u8fb9\u4f1a\u505a safepoint \u68c0\u67e5\uff1a<code>TestAllFlags()</code> \u4e3a\u771f\u65f6\u4f1a\u628a acc \u5199\u56de frame\u3001\u6267\u884c <code>Safepoint()</code>\uff0c\u518d\u6062\u590d acc\u3002</li> <li>\u56de\u8fb9\u4f1a\u9012\u51cf hotness\uff0c\u5e76\u53ef\u80fd\u89e6\u53d1 OSR \u7f16\u8bd1/\u8fdb\u5165\uff1a</li> <li>gating\uff1a<code>frame-&gt;IsDeoptimized()</code> \u6216 <code>!Runtime::GetOptions().IsCompilerEnableOsr()</code> \u65f6\uff0c\u4e0d\u4f1a\u5c1d\u8bd5 OSR\uff0c\u53ea\u505a\u666e\u901a hotness \u9012\u51cf</li> <li>\u5c1d\u8bd5 OSR \u65f6\u4f1a\u8c03\u7528\uff1a<code>method-&gt;DecrementHotnessCounter&lt;false&gt;(bytecodeOffset+offset, &amp;acc, /*osr=*/true)</code></li> <li>\u89e6\u53d1\u6210\u529f\u540e\u7684\u201cfake-return\u201d\u673a\u5236\uff1a\u5982\u679c OSR \u53d1\u751f\uff0c\u89e3\u91ca\u5668\u4f1a\u628a\u5f53\u524d inst \u66ff\u6362\u4e3a\u4e00\u6761\u4f2a\u9020\u7684 <code>RETURN_VOID</code>\uff08\u5199\u5165 fake buffer \u5e76 <code>SetInst(...)</code>\uff09\uff0c\u7528\u4e8e\u628a\u63a7\u5236\u6d41\u4ece\u89e3\u91ca\u5668\u4e3b\u5faa\u73af\u5b89\u5168\u5730\u4ea4\u7ed9 OSR \u5165\u53e3\u8def\u5f84\uff08\u89c1 <code>InstrumentBranches</code> \u7684 <code>GetFakeInstBuf/RETURN_VOID</code> \u5206\u652f\uff09\u3002</li> </ul> <p>\u8bc1\u636e\u94fe\uff1a - <code>runtime/interpreter/instruction_handler_base.h::InstrumentBranches/UpdateHotnessOSR</code> - <code>runtime/osr.*</code> - <code>runtime/options.yaml</code>\uff1a<code>compiler-enable-osr</code>\uff08\u9ed8\u8ba4 true\uff09 - <code>runtime/interpreter/frame.h</code>\uff1a<code>IS_DEOPTIMIZED</code> \u6807\u5fd7\u7684\u6ce8\u91ca\u8bf4\u660e\uff08\u7528\u4e8e\u907f\u514d deopt \u540e OSR \u5bfc\u81f4\u6808\u7a7a\u95f4\u4e0d\u53ef\u56de\u6536\u800c\u6ea2\u51fa\uff09</p>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#42-fast-interpreterirtocllvm-osrentrypoint","title":"4.2 fast interpreter\uff08IRTOC/LLVM\uff09\u5982\u4f55\u89e6\u53d1 OSR\uff08entrypoint \u8bc1\u636e\uff09","text":"<p>\u5728 fast interpreter \u91cc\uff0cOSR \u70ed\u5ea6\u9012\u51cf\u901a\u5e38\u901a\u8fc7 runtime entrypoint \u5b8c\u6210\uff1a</p> <ul> <li><code>runtime/entrypoints/entrypoints.cpp::CallCompilerSlowPathOSR(thread, method, frame, acc, accTag, insOffset, offset)</code></li> <li>\u5165\u53e3\u4f1a\u628a <code>(acc, accTag)</code> \u5199\u56de\u5230 <code>frame-&gt;acc</code>\uff0c\u7136\u540e\u8c03\u7528 <code>method-&gt;DecrementHotnessCounter&lt;false&gt;(insOffset + offset, &amp;frame-&gt;GetAcc(), true)</code></li> <li>\u540c\u6837\u53d7 <code>frame-&gt;IsDeoptimized()</code> \u4e0e <code>compiler-enable-osr</code> gating</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#43-osr","title":"4.3 \u67b6\u6784\u7ea6\u675f\uff1aOSR \u7684\u201c\u6700\u540e\u4e00\u5c42\u201d\u5e76\u975e\u5168\u5e73\u53f0\u90fd\u6709\uff08\u975e\u5e38\u5173\u952e\uff09","text":"<p>\u8fd9\u4e00\u70b9\u5728\u6392\u969c/\u65b0\u4eba\u5b9e\u9a8c\u65f6\u7ecf\u5e38\u88ab\u5ffd\u7565\uff1aOSR \u7684\u6700\u7ec8\u8fdb\u5165\u70b9\u662f\u67b6\u6784\u76f8\u5173\u6c47\u7f16\uff0c\u800c\u5f53\u524d\u6e90\u7801\u5bf9\u4e0d\u540c\u67b6\u6784\u7684\u652f\u6301\u5e76\u4e0d\u5bf9\u79f0\u3002</p> <ul> <li>arm64\uff08PANDA_TARGET_ARM64\uff09\uff1a\u6709\u771f\u5b9e\u5b9e\u73b0\uff0cOSR \u5165\u53e3\u5728\uff1a</li> <li><code>runtime/arch/aarch64/osr_aarch64.S</code>\uff1a\u5b9e\u73b0 <code>OsrEntryAfterIFrame/OsrEntryAfterCFrame/OsrEntryTopFrame</code>\uff0c\u4f1a\u8c03\u7528 <code>PrepareOsrEntry</code>\u3001\u6062\u590d\u5bc4\u5b58\u5668\u3001\u8df3\u5165 OSR code\uff0c\u5e76\u5728\u9700\u8981\u65f6 <code>SetOsrResult</code> \u5199\u56de\u89e3\u91ca\u5668 accumulator\u3002</li> <li>\u975e arm64\uff1aOSR \u5165\u53e3\u5728\u8fd0\u884c\u65f6\u88ab\u5b9a\u4e49\u4e3a UNREACHABLE\uff08\u4e0d\u662f\u201c\u6162\u4e00\u70b9/\u964d\u7ea7\u201d\uff09\uff1a</li> <li><code>runtime/arch/asm_support.cpp</code>\uff1a\u5728 <code>#if !defined(PANDA_TARGET_ARM64)</code> \u4e0b\u63d0\u4f9b <code>OsrEntryAfter*</code> \u7684 stub\uff0c\u51fd\u6570\u4f53\u76f4\u63a5 <code>UNREACHABLE()</code>\u3002</li> <li>\u989d\u5916\u8bc1\u636e\uff1a<code>runtime/arch/x86/osr_x86.S</code> \u7684 <code>OsrEntry</code> \u4ecd\u662f\u5360\u4f4d\u5b9e\u73b0\uff08\u76f4\u63a5\u8fd4\u56de 0\uff09\uff1b<code>runtime/arch/amd64/osr_amd64.S</code>/<code>runtime/arch/arm/osr_arm.S</code> \u5f53\u524d\u4ec5\u6709\u6587\u4ef6\u5934\uff08\u65e0\u5b9e\u9645\u903b\u8f91\uff09\u3002</li> </ul> <p>\u5b9e\u6218\u542b\u4e49\uff1a\u5728\u975e arm64 \u73af\u5883\u4e0a\uff0c\u201c\u628a OSR \u8def\u5f84\u8dd1\u51fa\u6765\u201d\u7684\u5b9e\u9a8c/\u6392\u969c\u5e94\u4f18\u5148\u9a8c\u8bc1 \u662f\u5426\u5177\u5907\u67b6\u6784\u5b9e\u73b0\uff0c\u5426\u5219\u4f60\u770b\u5230\u7684\u73b0\u8c61\u5f80\u5f80\u53ea\u662f stub \u884c\u4e3a\uff08\u751a\u81f3\u76f4\u63a5\u5d29\u5230 UNREACHABLE\uff09\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#5","title":"5) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/osr.h/.cpp</code></li> <li><code>runtime/deoptimization.h/.cpp</code></li> <li><code>runtime/bridge/bridge.cpp</code></li> <li><code>runtime/include/stack_walker.h</code>\u3001<code>runtime/stack_walker.cpp</code></li> <li><code>runtime/compiler.h/.cpp</code>\uff08OSR code \u5b89\u88c5\u6761\u4ef6/\u5199\u56de\uff09</li> <li>\uff08OSR \u6700\u7ec8\u843d\u5730/\u67b6\u6784\u9650\u5236\uff09</li> <li><code>runtime/arch/aarch64/osr_aarch64.S</code></li> <li><code>runtime/arch/asm_support.cpp</code></li> <li>FileNotes\uff1a<ul> <li>runtime_arch_aarch64_osr_aarch64.S</li> <li>runtime_arch_asm_support.cpp</li> <li>runtime_arch_x86_osr_x86.S / runtime_arch_arm_osr_arm.S / runtime_arch_amd64_osr_amd64.S\uff08stub/\u7a7a\u5b9e\u73b0\u73b0\u72b6\u8bf4\u660e\uff09</li> </ul> </li> </ul>"},{"location":"04_ExecutionEngine/Flows/Deopt_and_OSR/#6","title":"6) \u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u4f60\u9700\u8981\u786e\u8ba4\u201c\u89e3\u91ca\u5668\u56de\u8fb9/OSR \u89e6\u53d1\u70b9\u201d \u2192 Interpreter_Execute</li> <li>\u4f60\u9700\u8981\u786e\u8ba4\u201c\u8de8\u8fb9\u754c\u56de\u89e3\u91ca\u5668/\u7f3a\u5e27/ABI\u201d \u2192 Bridge_I2C_C2I</li> <li>\u4f60\u9700\u8981\u786e\u8ba4\u201c\u5f02\u5e38\u4e24\u6bb5\u5f0f + StackWalker\u201d \u2192 StackWalking</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/","title":"Flow\uff1aEntrypoints \u4e0e RuntimeInterface\uff08compiled code \u7684\u6162\u8def\u5f84\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201cEntrypoints\uff08runtime slow paths\uff09\u201d\u4e0e\u201cRuntimeInterface/\u5199\u56de\u7f16\u8bd1\u4ea7\u7269\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u5f53\u4f60\u770b\u5230\uff1a - \u201c\u7f16\u8bd1\u4ee3\u7801\u8c03\u7528 runtime helper \u5d29\u4e86/\u629b\u5f02\u5e38\u4e86\u201d - \u201cJIT \u7f16\u8bd1\u9636\u6bb5\u9700\u8981\u89e3\u6790\u7c7b/\u65b9\u6cd5/\u5e38\u91cf\u6c60\u201d - \u201cOSR code \u5b89\u88c5\u5931\u8d25/compiled entrypoint \u6ca1\u5199\u8fdb\u53bb\u201d</p> <p>\u4f60\u9700\u8981\u628a\u4e24\u6761\u7ebf\u4e32\u8d77\u6765\uff1a - Entrypoints\uff1acompiled code \u5728\u8fd0\u884c\u65f6\u9700\u8981\u6162\u8def\u5f84\u65f6\u8c03\u7528\u54ea\u91cc - PandaRuntimeInterface\uff1acompiler \u5728\u7f16\u8bd1\u65f6\u9700\u8981\u4ece runtime \u67e5\u8be2\u54ea\u4e9b\u4fe1\u606f\u3001\u4ee5\u53ca\u5982\u4f55\u5199\u56de\u7f16\u8bd1\u4ea7\u7269</p>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#2-mermaidcompiled-code-entrypoints","title":"2) Mermaid\uff1a\u8fd0\u884c\u671f\uff08compiled code \u2192 entrypoints\uff09","text":"<pre><code>sequenceDiagram\n  participant CC as Compiled Code\n  participant EP as runtime/entrypoints\n  participant RT as Runtime/VM\n\n  CC-&gt;&gt;EP: Call RuntimeEntrypoint(args)\n  EP-&gt;&gt;RT: \u6267\u884c\u6162\u8def\u5f84\uff08\u5206\u914d/\u68c0\u67e5/\u5f02\u5e38\u7b49\uff09\n  alt \u6b63\u5e38\u8fd4\u56de\n    RT--&gt;&gt;EP: result\n    EP--&gt;&gt;CC: return result\n  else \u629b\u5f02\u5e38\n    RT--&gt;&gt;EP: pending exception\n    EP--&gt;&gt;CC: \u5f02\u5e38\u8fb9\u754c\uff08\u53ef\u80fd\u89e6\u53d1 C2I/deopt/unwind\uff09\n  end</code></pre>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#3-mermaidcompiler-pandaruntimeinterface-classlinkerruntime","title":"3) Mermaid\uff1a\u7f16\u8bd1\u671f\uff08compiler \u2194 PandaRuntimeInterface \u2194 ClassLinker/Runtime\uff09","text":"<pre><code>flowchart TD\n  C[\"compiler/*\\n(\u7f16\u8bd1\u5668)\"] &lt;--&gt; RI[\"PandaRuntimeInterface\\n(runtime/compiler.*)\"]\n  RI --&gt; CL[\"ClassLinker/Runtime\\n(\u89e3\u6790\u7c7b/\u65b9\u6cd5/\u5b57\u6bb5/\u5e38\u91cf)\"]\n  RI --&gt; CI[\"CompilerInterface\\n(runtime/include/compiler_interface.h)\\n(\u5199\u5165 entrypoint/OSR code)\"]\n  RI --&gt; EP[\"Entrypoints \u63cf\u8ff0/\u7b26\u53f7\\n(\u4f9b codegen \u5f15\u7528)\"]</code></pre>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#4","title":"4) \u6392\u969c\u6293\u624b\uff08\u4f60\u8be5\u770b\u54ea\u91cc\uff09","text":"<ul> <li>entrypoints \u7684\u5b9a\u4e49\u4e0e\u5206\u7c7b\uff1a\u5148\u4ece <code>runtime/entrypoints/entrypoints.h/.cpp</code> \u770b\u201c\u6709\u54ea\u4e9b\u5165\u53e3\u3001\u53c2\u6570\u662f\u4ec0\u4e48\u3001\u54ea\u4e9b\u4f1a\u629b\u5f02\u5e38\u201d</li> <li>compiled entrypoint / OSR code \u5199\u56de\uff1a\u770b <code>runtime/compiler.h/.cpp</code>\uff08\u4f8b\u5982 <code>SetCompiledEntryPoint</code>\u3001<code>TrySetOsrCode</code>\uff09</li> <li>\u5199\u56de\u7684\u5e95\u5c42\u63a5\u53e3\uff1a\u770b <code>runtime/include/compiler_interface.h</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#5","title":"5) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/entrypoints/entrypoints.h</code>\u3001<code>runtime/entrypoints/entrypoints.cpp</code></li> <li><code>runtime/compiler.h</code>\u3001<code>runtime/compiler.cpp</code></li> <li><code>runtime/include/compiler_interface.h</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Entrypoints_and_RuntimeInterface/#6","title":"6) \u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u4f60\u5173\u5fc3\u201c\u89e3\u91ca\u5668\u2194compiled \u8fb9\u754c\u4e0e\u8fd4\u56de\u503c\u201d \u2192 Bridge_I2C_C2I</li> <li>\u4f60\u5173\u5fc3\u201cOSR/deopt \u89e6\u53d1\u4e0e\u5b89\u88c5\u6761\u4ef6\u201d \u2192 Deopt_and_OSR</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/","title":"Flow\uff1a\u6267\u884c\u5f15\u64ce\u7aef\u5230\u7aef\u4e3b\u7ebf\uff08\u65b0\u4eba\u201c\u810a\u67f1\u56fe\u201d\uff09","text":"<p>\u76ee\u6807\uff1a\u7ed9\u65b0\u540c\u5b66\u4e00\u6761\u552f\u4e00\u4e3b\u7ebf\u2014\u2014\u5148\u7528\u4e00\u5f20\u56fe\u628a\u201c\u4ee3\u7801\u600e\u4e48\u8dd1\u8d77\u6765\u201d\u4e32\u8d77\u6765\uff0c\u7136\u540e\u6bcf\u4e2a\u6846\u90fd\u80fd\u4e00\u952e\u4e0b\u6f5c\u5230\u5bf9\u5e94 Flow / DataStructures / FileNotes\u3002</p>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#0","title":"0) \u4f60\u8be5\u600e\u4e48\u7528\u8fd9\u4efd\u6587\u6863\uff08\u65b0\u4eba\u63a8\u8350\u987a\u5e8f\uff09","text":"<p>\u5efa\u8bae\u6253\u5f00 3 \u4e2a\u9875\u7b7e\uff1a</p> <ul> <li>\u672f\u8bed\u901f\u67e5\uff1aFileNotes/_Glossary</li> <li>\u65b0\u4eba\u5feb\u901f\u81ea\u68c0\uff1aNewbie_MinDebug_Playbook</li> <li>\u672c\u6587\uff08\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\uff09</li> </ul> <p>\u7136\u540e\u6309\u201c\u7531\u7c97\u5230\u7ec6\u201d\u9605\u8bfb\uff1a</p> <ol> <li>\u5148\u770b 2) \u603b\u56fe\uff1a\u5efa\u7acb\u6267\u884c\u5f15\u64ce\u6574\u4f53 mental model</li> <li>\u518d\u6309\u4f60\u5173\u5fc3\u7684\u6846\u4e0b\u6f5c\uff1a\u6bcf\u4e2a\u6846\u4e0b\u90fd\u6709\u201c\u8fdb\u4e00\u6b65\u9605\u8bfb\u201d\u5165\u53e3\uff0c\u8fdb\u5165\u5bf9\u5e94\u7684 Flow \u56fe</li> <li>\u6700\u540e\u624d\u8bfb\u9010\u884c\u8bc1\u636e\uff1aFlow \u2192 FileNotes\uff08\u9010\u884c\uff09\u662f\u6700\u7a33\u5b9a\u7684\u8bc1\u636e\u94fe</li> </ol>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#1","title":"1) \u5148\u8bb0\u4f4f\u4e09\u6761\u73b0\u5b9e\u89c4\u5219\uff08\u65b0\u4eba\u6700\u5e38\u8bef\u5224\uff09","text":"<ul> <li>\u9ed8\u8ba4\u503c vs \u6700\u7ec8\u9009\u578b\uff1a<code>runtime/options.yaml</code> \u9ed8\u8ba4 <code>interpreter-type=llvm</code>\uff0c\u4f46\u6700\u7ec8\u9009\u578b\u7531 <code>frame-&gt;IsDynamic()</code>\u3001\u662f\u5426\u663e\u5f0f\u8bbe\u7f6e\u3001\u6784\u5efa\u5b8f\u80fd\u529b\uff08LLVM/IRTOC\uff09\u3001debug-mode/GC \u7b49\u786c\u9650\u5236\u5171\u540c\u51b3\u5b9a\uff08\u5165\u53e3\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code>\uff09\u3002</li> <li>build/ \u4ea7\u7269\u5e73\u53f0\u5dee\u5f02\uff1a\u672c\u673a linux/amd64 \u7684 <code>build/</code> \u4ea7\u7269\u4e0d\u80fd\u76f4\u63a5\u63a8\u65ad\u624b\u673a android/arm64 \u7684\u8fd0\u884c\u60c5\u51b5\uff1b\u8981\u9a8c\u8bc1 fast interpreter/dispatch table\uff0c\u8bf7\u4ee5\u5bf9\u5e94\u76ee\u6807\u5e73\u53f0\u6784\u5efa\u4ea7\u7269\u4e3a\u51c6\u3002</li> <li>OSR \u7684\u5e73\u53f0\u73b0\u5b9e\uff1aOSR \u7684\u6700\u7ec8\u8fdb\u5165\u70b9\u662f arch \u6c47\u7f16\u5165\u53e3\uff1b\u5f53\u524d\u6e90\u7801\u5bf9\u975e arm64 \u5e73\u53f0\u53ef\u80fd\u662f stub/UNREACHABLE\uff08\u89c1 Deopt_and_OSR \u7684\u67b6\u6784\u7ea6\u675f\uff09\u3002</li> <li>\u8fdb\u4e00\u6b65\u9605\u8bfb\uff1aDeopt_and_OSR</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#2-mermaid","title":"2) Mermaid\uff1a\u6267\u884c\u5f15\u64ce\u7aef\u5230\u7aef\u603b\u56fe\uff08\u4e3b\u7ebf\uff09","text":"<pre><code>flowchart TD\n  subgraph S[\"\u542f\u52a8/\u88c5\u8f7d\uff08\u8f93\u5165\uff09\"]\n    ABC[\"Load .abc (PandaFile)\"] --&gt; M[\"Resolve Method + Bytecode\"]\n  end\n\n  subgraph ISEL[\"\u89e3\u91ca\u5668\u9009\u578b\uff08\u8fd0\u884c\u65f6\u771f\u5b9e\u5165\u53e3\uff09\"]\n    OPT[\"Read options + build capabilities\"] --&gt; SEL[\"Select interpreter type\\ncpp / irtoc / llvm\"]\n  end\n\n  subgraph INT[\"\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\"]\n    EX[\"interpreter::Execute(thread, pc, frame)\"] --&gt; LOOP[\"dispatch loop\\n(decode \u2192 handler \u2192 update pc)\"]\n    LOOP --&gt; RET{\"return / throw ?\"}\n  end\n\n  subgraph CALL[\"\u8c03\u7528/\u6865\u63a5\uff08\u89e3\u91ca\u5668 \u2194 compiled\uff09\"]\n    INV{\"invoke/call \u6307\u4ee4\"} --&gt;|no compiled ep| LOOP\n    INV --&gt;|has compiled ep| I2C[\"I2C bridge\\n(Interpreter \u2192 Compiled)\"]\n    I2C --&gt; CC[\"Compiled code\"]\n    CC --&gt;|call runtime slowpath| EP[\"Entrypoints\\n(runtime slow paths)\"]\n    EP --&gt; CC\n    CC --&gt;|return| I2C\n    CC --&gt;|deopt / fallback| C2I[\"C2I bridge / InvokeInterpreter\\n(Compiled \u2192 Interpreter)\"]\n    C2I --&gt; LOOP\n  end\n\n  subgraph JIT[\"JIT/OSR\uff08\u70ed\u70b9\u89e6\u53d1\uff09\"]\n    HOT[\"hotness/back-edge\"] --&gt; REQ[\"request compile / OSR\\n(method hotness counter)\"]\n    REQ --&gt; INST[\"install compiled ep / osr code\\n(method state update)\"]\n    INST --&gt; INV\n  end\n\n  subgraph EXC[\"\u5f02\u5e38/\u6808\u904d\u5386\uff08\u8c03\u8bd5/\u5f02\u5e38/\u53bb\u4f18\u5316\u90fd\u4f1a\u7528\uff09\"]\n    RET --&gt;|throw| STACKLESS[\"FindCatchBlockStackless\\n(interpreter frames)\"]\n    STACKLESS --&gt;|found| LOOP\n    STACKLESS --&gt;|not found| WALK[\"StackWalker (call stack)\"]\n    WALK --&gt;|found catch| DEOPT[\"Deoptimize \u2192 rebuild IFrame\\n(back to interpreter catch pc)\"]\n    DEOPT --&gt; LOOP\n  end\n\n  RET --&gt;|return| OUT[\"return acc/result\"]\n\n  M --&gt; ISEL --&gt; EX\n  LOOP --&gt; INV\n  LOOP --&gt; HOT</code></pre>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#3","title":"3) \u201c\u6309\u6846\u4e0b\u6f5c\u201d\u5bfc\u822a\uff08\u6bcf\u4e2a\u6846\u90fd\u80fd\u7ee7\u7eed\u770b\u7ec6\u8282\u56fe\uff09","text":""},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#31-cppirtocllvm","title":"3.1 \u89e3\u91ca\u5668\u9009\u578b\uff08cpp/irtoc/llvm\uff09","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aIRTOC_FastInterpreter\uff08\u542b\u9009\u578b\u7cbe\u786e\u89c4\u5219 + build \u751f\u6210\u94fe\uff09</li> <li>\u770b\u4ee3\u7801\u8bc1\u636e\uff1aruntime_interpreter_interpreter_impl.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#32-dispatchhandlerexception_handler","title":"3.2 \u89e3\u91ca\u5668\u4e3b\u5faa\u73af\uff08dispatch/handler/EXCEPTION_HANDLER\uff09","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aInterpreter_Execute</li> <li>\u7ed3\u6784\u5361\u7247\uff1aFrame_VReg_Acc</li> <li>\u751f\u6210\u6a21\u677f\u4e0e\u8bc1\u636e\u5165\u53e3\uff1aruntime_interpreter_templates_interpreter-inl_gen.h.erb\uff08<code>ExecuteImpl/dispatch/EXCEPTION_HANDLER</code> \u7684\u201c\u771f\u5b9e\u6765\u6e90\u5c42\u201d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#33-invokecall-i2cc2i","title":"3.3 invoke/call \u4e0e\u6865\u63a5\uff08I2C/C2I\uff09","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aBridge_I2C_C2I\uff08\u542b arch \u6c47\u7f16\u8bc1\u636e\u94fe\u5165\u53e3\uff09</li> <li>\u7ed3\u6784\u5361\u7247\uff1aBridge_ABI_and_FrameKind</li> <li>C++ \u9aa8\u67b6\u8bc1\u636e\uff1aruntime_bridge_bridge.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#34-entrypointscompiled-code","title":"3.4 entrypoints\uff08compiled code \u7684\u6162\u8def\u5f84\uff09","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aEntrypoints_and_RuntimeInterface</li> <li>\u7ed3\u6784\u5361\u7247\uff1aEntrypoints</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_entrypoints_entrypoints.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#35-jitosr","title":"3.5 JIT/OSR \u7684\u89e6\u53d1\u3001\u5b89\u88c5\u4e0e\u8fdb\u5165","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aDeopt_and_OSR</li> <li>\u7ed3\u6784\u5361\u7247\uff1aDeopt_and_OSR\uff08DataStructure\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_osr.cpp\u3001runtime_compiler.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Flows/ExecutionEngine_EndToEnd/#36-stackwalker-deopt-catch","title":"3.6 \u5f02\u5e38\u4e0e StackWalker\uff08\u4e24\u6bb5\u5f0f + deopt \u56de catch\uff09","text":"<ul> <li>\u770b\u7ec6\u8282 Flow \u56fe\uff1aStackWalking\uff08\u5f02\u5e38\u201c\u4e24\u6bb5\u5f0f\u201d\u8def\u5f84\u56fe\uff09</li> <li>\u7ed3\u6784\u5361\u7247\uff1aStackWalker\uff08DataStructure\uff09</li> <li>\u9010\u884c\u8bc1\u636e\uff1aruntime_exceptions.cpp\u3001runtime_stack_walker.cpp</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/","title":"IRTOC <code>.irt</code> DSL \u5165\u95e8\uff08\u65b0\u4eba\u53ef\u843d\u5730\u7684\u201c\u600e\u4e48\u8bfb/\u600e\u4e48\u6539/\u600e\u4e48\u9a8c\u8bc1\u201d\uff09","text":"<p>\u76ee\u6807\uff1a\u8ba9\u5b8c\u5168\u6ca1 IRTOC \u80cc\u666f\u7684\u65b0\u540c\u5b66\uff0c\u5728 1 \u5c0f\u65f6\u5185\u5177\u5907\u4e09\u79cd\u80fd\u529b\uff1a 1) \u770b\u61c2 <code>interpreter.irt</code> \u7684\u5927\u7ed3\u6784\uff08macro/handler/dispatch\uff09 2) \u80fd\u5b9a\u4f4d\u201c\u67d0\u4e2a\u73b0\u8c61\u5bf9\u5e94 .irt \u91cc\u7684\u54ea\u4e00\u6bb5\u201d\u5e76\u505a\u5c0f\u6539\u52a8 3) \u80fd\u7528 build \u4ea7\u7269\u628a\u201cDSL \u2192 IR \u2192 \u6c47\u7f16 \u2192 \u8fd0\u884c\u65f6\u884c\u4e3a\u201d\u4e32\u6210\u8bc1\u636e\u94fe\u95ed\u73af</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#0-04","title":"0) \u5728 04 \u7ae0\u7aef\u5230\u7aef\u4e3b\u7ebf\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201cFast interpreter\uff08IRTOC/LLVM\uff09\u201d\u76f8\u5173\u6846\uff09</li> <li>\u8fd0\u884c\u65f6\u5165\u53e3\u4e0e\u9009\u578b\uff1aIRTOC_FastInterpreter</li> <li><code>.irt</code> \u9010\u884c\u8bc1\u636e\uff08\u66f4\u7ec6\uff09\uff1airtoc_scripts_interpreter.irt\u3001irtoc_scripts_common.irt</li> <li><code>.irt \u2192 Graph \u2192 \u673a\u5668\u7801</code> \u7684\u5b9e\u73b0\u6e90\u7801\u5165\u53e3\uff08\u5efa\u8bae\u6536\u85cf\uff09\uff1a</li> <li>Ruby \u4fa7\u751f\u6210\u5668\uff1a<code>irtoc/lang/irtoc.rb</code>\u3001<code>irtoc/lang/function.rb</code></li> <li>C++ \u4fa7\u7f16\u8bd1\u5668\uff1a<code>irtoc/backend/irtoc.cpp</code>\u3001<code>irtoc/backend/compilation.cpp</code>\u3001<code>irtoc/backend/function.cpp</code></li> <li>Graph \u7c7b\u578b\u4e0e IR \u6784\u9020\u5668\uff1a<code>compiler/optimizer/ir/graph.h</code>\u3001<code>compiler/optimizer/ir/ir_constructor.h</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#1-3","title":"1) \u4f60\u9996\u5148\u8981\u5f62\u6210\u7684 3 \u4e2a\u5fc3\u667a\u6a21\u578b\uff08\u975e\u5e38\u5173\u952e\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#11-irt-ir","title":"1.1 <code>.irt</code> \u4e0d\u662f\u201c\u89e3\u91ca\u5668\u6e90\u7801\u201d\uff0c\u800c\u662f\u201c\u751f\u6210\u5668 + IR \u6784\u9020\u811a\u672c\u201d","text":"<p><code>irtoc/scripts/interpreter.irt</code> \u662f\u4e00\u4e2a Ruby \u811a\u672c\uff0c\u5b83\u901a\u8fc7 DSL \u6784\u9020 IR \u56fe\uff08Graph\uff09\uff0c\u518d\u7531 IRTOC/LLVM backend \u751f\u6210 <code>ExecuteImplFast*</code> \u4e0e <code>HANDLE_FAST_*</code> \u673a\u5668\u7801\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff1a\u4f60\u6539 <code>.irt</code>\uff0c\u4e0d\u4f1a\u5f71\u54cd C++ interpreter \u7684 handler\uff1b\u5b83\u5f71\u54cd\u7684\u662f fast interpreter \u7684\u751f\u6210\u7269\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#12-irt-ruby-dsl-runtime-layout","title":"1.2 <code>.irt</code> \u7684\u4e09\u5c42\u7ed3\u6784\uff1aRuby \u63a7\u5236\u6d41 / DSL \u8282\u70b9 / Runtime layout \u5e38\u91cf","text":"<ul> <li>Ruby \u63a7\u5236\u6d41\uff1a<code>if Options.arm64?</code>\u3001<code>Panda.instructions.each</code> \u7b49\uff0c\u51b3\u5b9a\u751f\u6210\u54ea\u4e9b\u4ee3\u7801</li> <li>DSL \u8282\u70b9\u6784\u9020\uff1a<code>LoadI/AddI/StoreI/Call/Intrinsic/If/Phi/Cast...</code>\uff08\u8fd9\u662f\u201cIR \u6307\u4ee4\u201d\uff09</li> <li>\u8fd0\u884c\u65f6\u5e03\u5c40\u5e38\u91cf\uff1a\u6765\u81ea <code>include_relative 'common.irt'</code> \u7684 <code>Constants</code>\u3001regmap\uff08Frame/Thread/Method offset\u3001entrypoint id \u7b49\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#13-fast-interpreter-abi","title":"1.3 fast interpreter \u7684\u201c\u5185\u90e8 ABI\u201d\u662f\u6027\u80fd\u6838\u5fc3","text":"<p>fast interpreter \u628a\u89e3\u91ca\u5668\u6838\u5fc3\u72b6\u6001\u957f\u671f\u653e\u5728\u56fa\u5b9a\u5bc4\u5b58\u5668\uff08<code>tr/pc/frame/acc/dispatch</code>\uff09\uff0c\u901a\u8fc7 <code>dispatch_table[opc]</code> \u505a computed-goto\uff08tail-call\uff09\u3002</p> <p>\u5bf9\u5e94\u8bc1\u636e\u94fe\uff1a - <code>.irt</code> \u8bed\u4e49\uff1a<code>macro(:dispatch)</code>\uff08\u89c1 irtoc_scripts_interpreter.irt\uff09 - build \u4ea7\u7269\uff1abuild_runtime_include_irtoc_interpreter_utils.h - \u6c47\u7f16\u8bc1\u636e\uff1abuild_irtoc_irtoc_interpreter_disasm.txt</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#2-irt-dsl-80","title":"2) <code>.irt</code> DSL \u7684\u201c\u6700\u5c0f\u8bed\u6cd5\u96c6\u201d\uff08\u591f\u4f60\u6539 80% \u7684\u95ee\u9898\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#21-macro","title":"2.1 \u5b9a\u4e49 macro\uff08\u53ef\u590d\u7528\u7247\u6bb5\uff09","text":"<p>\u5f62\u6001\uff1a</p> <pre><code>macro(:readbyte) do |pc, offset|\n  LoadI(pc).Imm(offset).u8\nend\n</code></pre> <p>\u8981\u70b9\uff1a - <code>macro(:name)</code> \u5b9a\u4e49\u4e00\u4e2a\u53ef\u88ab\u5176\u4ed6\u5b8f/handler \u8c03\u7528\u7684\u201c\u6a21\u677f\u7247\u6bb5\u201d - \u91cc\u9762\u7684 <code>LoadI/AddI/...</code> \u662f IR \u8282\u70b9\u6784\u9020\u5668 - \u672b\u5c3e\u7684 <code>.u8/.i32/.ref/...</code> \u662f \u628a IR \u8282\u70b9\u6807\u6ce8\u4e3a\u67d0\u79cd DataType</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#22-x-ir-ssa","title":"2.2 <code>x := ...</code>\uff1a\u521b\u5efa\u4e00\u4e2a IR \u503c\uff08SSA \u98ce\u683c\uff09","text":"<p>\u4f60\u4f1a\u7ecf\u5e38\u770b\u5230\uff1a</p> <pre><code>opc := readbyte(pc, 0)\noffset := Mul(u8toword(opc), WordSize())\naddr := Load(table, offset)\ntail_call(addr)\n</code></pre> <p>\u76f4\u89c9\u7406\u89e3\uff1a - <code>:=</code> \u4e0d\u662f Ruby \u7684\u8d4b\u503c\u8bed\u6cd5\uff0c\u5b83\u662f DSL \u5b9a\u4e49\u7684\u201c\u521b\u5efa SSA \u503c/\u8282\u70b9\u201d\u7684\u5199\u6cd5 - \u8fd9\u4e9b\u503c\u4f1a\u6210\u4e3a\u540e\u7eed IR \u8282\u70b9\u7684\u8f93\u5165</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#23-if-phi","title":"2.3 <code>If ... Phi ...</code>\uff1a\u63a7\u5236\u6d41\u4e0e\u5408\u6d41","text":"<p>\u5178\u578b\uff1a</p> <pre><code>res0 := 0\nIf(arg, 0).NE do\n  res1 := 1\nend\nPhi(res0, res1).i32\n</code></pre> <p>\u8981\u70b9\uff1a - <code>If(x, y).NE do ... end</code> \u751f\u6210\u5206\u652f - <code>Phi(a, b)</code> \u5728\u5206\u652f\u6c47\u5408\u70b9\u9009\u62e9\u503c\uff08SSA \u5408\u6d41\uff09</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#24-intrinsic","title":"2.4 <code>Intrinsic(...)</code>\uff1a\u540e\u7aef\u4e13\u7528\u7684\u201c\u8bed\u4e49\u6307\u4ee4\u201d","text":"<p>fast interpreter \u7684\u4e24\u4e2a\u9ad8\u9891 intrinsic\uff1a - <code>Intrinsic(:TAIL_CALL)</code>\uff1a\u5b9e\u73b0 computed-goto \u7684\u5c3e\u8df3\u8f6c\uff08\u811a\u672c\u91cc\u901a\u5e38\u5c01\u88c5\u6210 <code>tail_call(addr)</code>\uff09 - <code>Intrinsic(:INTERPRETER_RETURN)</code>\uff1a\u4ece fast interpreter \u201c\u8fd4\u56de\u5230 runtime \u8fb9\u754c\u201d\uff08\u7528\u4e8e\u5f02\u5e38/\u975e stackless return \u7b49\uff09</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#25-liveinliveout","title":"2.5 <code>LiveIn/LiveOut</code>\uff1a\u628a\u8bed\u4e49\u5bc4\u5b58\u5668\u7ed1\u5230\u786c\u4ef6\u5bc4\u5b58\u5668\uff08\u522b\u5ffd\u7565\u5b83\uff09","text":"<p>\u4f60\u5728 <code>.irt</code> \u91cc\u770b\u5230\u7684 <code>%tr/%pc/%frame/%acc</code> \u7b49\u8bed\u4e49\u5bc4\u5b58\u5668\uff0c\u9700\u8981\u901a\u8fc7 LiveIn/LiveOut \u56fa\u5b9a\u5230\u786c\u4ef6\u5bc4\u5b58\u5668\uff08\u7531 regmap \u51b3\u5b9a\uff09\u3002</p> <p>\u5e38\u89c1\u5751\uff1a\u6539\u4e86\u4e00\u4e2a\u5b8f/handler \u540e\uff0c\u5982\u679c\u5fd8\u4e86\u5bf9\u5173\u952e\u72b6\u6001\u505a LiveOut\uff0c\u53ef\u80fd\u5bfc\u81f4\u540e\u7aef\u628a\u5bc4\u5b58\u5668\u5f53\u6210\u53ef\u91cd\u7528\u4e34\u65f6\u5bc4\u5b58\u5668\uff0c\u4ea7\u751f\u201c\u5076\u73b0\u9519\u8bef/\u96be\u590d\u73b0\u201d\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#3","title":"3) \u4f60\u5e94\u8be5\u4ece\u54ea\u91cc\u6539\uff08\u6309\u95ee\u9898\u7c7b\u578b\u7ed9\u201c\u7b2c\u4e00\u843d\u70b9\u201d\uff09","text":"<p>\u4e0b\u9762\u6bcf\u4e00\u6761\u90fd\u5bf9\u5e94 <code>interpreter.irt</code> \u4e2d\u4e00\u4e2a\u7a33\u5b9a\u951a\u70b9\uff0c\u5efa\u8bae\u65b0\u4eba\u5148\u4ece\u951a\u70b9\u5f00\u59cb grep\u3002</p> \u4f60\u8981\u6539\u7684\u4e1c\u897f <code>.irt</code> \u7b2c\u4e00\u843d\u70b9\uff08\u5173\u952e\u8bcd\uff09 \u4e3a\u4ec0\u4e48\u5728\u8fd9\u91cc dispatch/\u8df3\u8868 <code>macro(:dispatch)</code> \u51b3\u5b9a opcode\u2192handler \u7684 computed-goto \u8bed\u4e49 decode/\u53d6\u64cd\u4f5c\u6570 <code>macro(:readbyte)</code>\u3001<code>macro(:as_vreg_idx)</code>\u3001<code>macro(:as_id)</code> \u4e00\u5207 handler \u7684 operand \u90fd\u4ece\u8fd9\u91cc\u8bfb\u51fa\u6765 acc \u5199\u56de/\u6062\u590d <code>save_acc</code> / <code>restore_acc</code> \u76f8\u5173\u5b8f GC/safepoint/\u6865\u63a5/\u5f02\u5e38\u90fd\u4f9d\u8d56 acc \u4e00\u81f4\u6027 \u5f02\u5e38\u5165\u53e3 <code>move_to_exception</code> / <code>find_catch_block</code> exception slot \u4e0e\u201c\u4e24\u6bb5\u5f0f\u5f02\u5e38\u201d\u5728\u8fd9\u91cc\u843d\u5730 OSR \u89e6\u53d1/\u56de\u8fb9 <code>instrument_branches</code> / <code>handle_fake_return</code> OSR \u6700\u96be\u7406\u89e3\u4e5f\u6700\u5e38\u6539\u52a8\u7684\u533a\u57df call/return <code>generic_call</code> / <code>generic_return</code> \u7f16\u8bd1\u6001\u8c03\u7528\uff08I2C\uff09\u4e0e stackless \u8c03\u7528\u5728\u8fd9\u91cc\u7edf\u4e00 \u5355\u4e2a opcode \u8bed\u4e49 <code>handle_xxx</code> \u5b8f + <code>Panda.instructions.each</code> \u751f\u6210\u6bb5 \u5927\u90e8\u5206 <code>HANDLE_FAST_*</code> \u90fd\u662f\u201c\u5b8f\u5c55\u5f00+\u751f\u6210\u5668\u201d <p>\u66f4\u7ec6\u7684\u9010\u884c\u8bc1\u636e\uff1a\u76f4\u63a5\u770b irtoc_scripts_interpreter.irt\uff08\u91cc\u9762\u5df2\u7ecf\u6309\u4e0a\u8ff0\u951a\u70b9\u5206\u6bb5\uff09\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#4-vm","title":"4) \u65b0\u4eba\u201c\u600e\u4e48\u6539\u201d\u7684\u6807\u51c6\u5de5\u4f5c\u6d41\uff08VM \u67b6\u6784\u5ba1\u8ba1\u7ea7\u522b\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#41-fast-interpreter","title":"4.1 \u5b9a\u4f4d\uff1a\u5148\u4ece\u8fd0\u884c\u65f6\u73b0\u8c61\u56de\u5230\u201c\u4f60\u5230\u5e95\u8dd1\u7684\u662f fast interpreter \u5417\u201d","text":"<ul> <li>\u7528 <code>--log-level=debug --log-components=runtime:interpreter</code> \u770b\u662f\u5426\u51fa\u73b0 <code>Setting up LLVM Irtoc dispatch table</code> / <code>Setting up Irtoc dispatch table</code></li> <li>\u5982\u679c\u4f60\u8dd1\u7684\u662f cpp interpreter\uff0c\u4f60\u6539 <code>.irt</code> \u4e0d\u4f1a\u751f\u6548</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#42-irtocscriptsinterpreterirt-build","title":"4.2 \u4fee\u6539\uff1a\u6c38\u8fdc\u6539\u6e90\u7801 <code>irtoc/scripts/interpreter.irt</code>\uff08\u4e0d\u8981\u6539 build \u4ea7\u7269\uff09","text":"<p>\u4f60\u4f1a\u770b\u5230\u4e09\u4efd\u76f8\u5173\u6587\u4ef6\uff1a - \u6e90\u7801\uff1a<code>irtoc/scripts/interpreter.irt</code>\uff08\u6539\u8fd9\u91cc\uff09 - \u89c4\u8303\u5316\u4ea7\u7269\uff1a<code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code>\uff08\u53ea\u8bfb\uff0c\u7528\u4e8e\u884c\u53f7\u4e0e Loc \u5bf9\u9f50\uff09 - \u751f\u6210 C++\uff1a<code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code>\uff08\u53ea\u8bfb\uff0c\u7528\u4e8e IR \u8282\u70b9\u5b9a\u4f4d\uff09</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#43-3","title":"4.3 \u9a8c\u8bc1\uff08\u5f3a\u70c8\u5efa\u8bae\u6309\u201c3 \u6bb5\u5f0f\u8bc1\u636e\u94fe\u201d\u8d70\uff09","text":"<p>1) \u811a\u672c\u5c42\uff1a\u5728 <code>interpreter.irt.fixed</code> \u4e2d\u786e\u8ba4\u4f60\u7684\u6539\u52a8\u786e\u5b9e\u51fa\u73b0\uff08\u907f\u514d\u201c\u6ca1\u89e6\u53d1\u91cd\u65b0\u751f\u6210\u201d\uff09 2) IR \u5c42\uff1a\u5728 <code>irtoc_code.cpp</code> \u627e\u5230\u5bf9\u5e94 <code>Loc(..., &lt;line&gt;)</code> \u4e0e <code>INST(id, ...)</code> \u53d8\u5316 3) \u673a\u5668\u7801\u5c42\uff1a\u5728 <code>disasm.txt</code> \u627e\u5230\u5bf9\u5e94 method \u7684 <code># [inst] &lt;id&gt;</code>\uff0c\u786e\u8ba4\u6c47\u7f16\u771f\u7684\u53d8\u4e86</p> <p>\u53c2\u8003\u7b14\u8bb0\uff1a - build_irtoc_irtoc_interpreter_disasm.txt - build_runtime_include_irtoc_interpreter_utils.h</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#5-guardrail","title":"5) \u4e24\u4e2a\u201c\u65b0\u4eba\u5fc5\u8e29\u5751\u201d\u4e0e\u67b6\u6784\u5c42 guardrail","text":"<ul> <li> <p>\u5751 1\uff1a\u4ee5\u4e3a\u6539 C++ handler \u4f1a\u5f71\u54cd\u751f\u4ea7   \u751f\u4ea7\u9ed8\u8ba4\u5f80\u5f80\u662f <code>--interpreter-type=llvm</code>\uff08fast interpreter\uff09\uff0c\u4f60\u9700\u8981\u6539\u7684\u662f <code>.irt</code> \u6216\u751f\u6210\u94fe\uff0c\u800c\u4e0d\u662f <code>interpreter-inl.h</code>\u3002</p> </li> <li> <p>\u5751 2\uff1a\u5fd8\u8bb0 acc/pc/frame \u7684\u4e00\u81f4\u6027\u4e0d\u53d8\u91cf   fast interpreter \u91cc\u5927\u91cf <code>save_acc/restore_acc</code>\u3001<code>update_bytecode_offset</code> \u90fd\u4e0d\u662f\u201c\u591a\u4f59\u4ee3\u7801\u201d\uff0c\u5b83\u4eec\u5728 GC/safepoint/\u5f02\u5e38/\u6865\u63a5\u8fb9\u754c\u4e0a\u662f\u786c\u4e0d\u53d8\u91cf\u3002   \u6539\u52a8\u65f6\u4f18\u5148\u95ee\u81ea\u5df1\uff1a\u8fd9\u6761\u8def\u5f84\u4e0a GC/StackWalker/hook \u662f\u5426\u8fd8\u80fd\u770b\u5230\u4e00\u81f4\u7684 acc/frame/pc\uff1f</p> </li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#6-irt-ir-ir","title":"6) \u4f60\u95ee\u7684\u6838\u5fc3\uff1a\u8c01\u628a <code>.irt</code> \u53d8\u6210 IR \u56fe\uff1fIR \u56fe\u53c8\u662f\u8c01\u7f16\u8bd1\u6210\u673a\u5668\u7801\uff1f","text":"<p>\u8fd9\u4e00\u8282\u662f\u201c\u67b6\u6784\u5e08\u89c6\u89d2\u7684\u5168\u94fe\u8def\u5206\u5de5\u201d\uff0c\u7528\u6765\u6d88\u9664\u65b0\u4eba\u6700\u5e38\u89c1\u7684\u8bef\u89e3\uff1a <code>.irt</code> \u672c\u8eab\u4e0d\u4f1a\u76f4\u63a5\u53d8\u6210\u673a\u5668\u7801\uff1b\u5b83\u5148\u53d8\u6210\u201c\u751f\u6210\u7684 C++\uff08irtoc_code.cpp\uff09\u201d\uff0c\u518d\u5728\u6784\u5efa\u9636\u6bb5\u88ab\u4e00\u4e2a <code>irtoc</code> \u53ef\u6267\u884c\u7a0b\u5e8f\u8dd1\u8d77\u6765\uff0c\u628a Graph \u7f16\u8bd1\u6210 <code>.o</code>\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#61-ruby-irt-irtoc_codecpp","title":"6.1 \u7b2c\u4e00\u6b65\uff1aRuby \u751f\u6210\u5668\u6267\u884c <code>.irt</code>\uff0c\u5e76\u751f\u6210 <code>irtoc_code.cpp</code>","text":"<p>\u751f\u6210\u5668\u5165\u53e3\u5728 <code>irtoc/lang/irtoc.rb</code>\uff0c\u5b83\u505a\u4e86\u4e09\u4ef6\u5173\u952e\u4e8b\uff1a</p> <p>1) \u9884\u5904\u7406 DSL \u8bed\u6cd5\uff08\u8fd9\u662f\u4f60\u770b\u5230 <code>:=</code>\u3001<code>%tr</code> \u7b49\u201c\u975e Ruby\u201d\u8bed\u6cd5\u8fd8\u80fd\u8dd1\u7684\u6839\u56e0\uff09    - <code>(\\w+) := ...</code> \u4f1a\u88ab\u8f6c\u6210 <code>let :name, ...</code>    - <code>%tr/%pc/%frame/...</code> \u4f1a\u88ab\u8f6c\u6210 <code>LiveIn(regmap[:tr])</code> \u4e4b\u7c7b 2) <code>instance_eval</code> \u6267\u884c\u9884\u5904\u7406\u540e\u7684\u811a\u672c\uff08\u8fd9\u5c31\u662f\u201c<code>.irt \u662f Ruby \u811a\u672c\u201d\u7684\u73b0\u5b9e\u542b\u4e49\uff09 3) **\u628a\u811a\u672c\u91cc</code>function(...) { ... }<code>\u5f62\u6210\u7684\u5185\u5bb9\u201cemit \u6210 C++ \u6e90\u7801\u201d**\uff08\u5373</code>irtoc_code.cpp<code>/</code>irtoc_code_llvm.cpp`\uff09</p> <p>\u4f60\u53ef\u4ee5\u628a <code>.irt</code> \u7406\u89e3\u6210\u201c\u7528 Ruby \u5199\u7684\u4ee3\u7801\u751f\u6210\u5668\u8f93\u5165\u8bed\u8a00\u201d\uff0c\u5b83\u7684\u8f93\u51fa\u662f\u201c\u4f1a\u6784\u9020 Graph \u7684 C++ \u6e90\u7801\u201d\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#62-graph","title":"6.2 \u7b2c\u4e8c\u6b65\uff1aGraph \u5728\u54ea\u91cc\u751f\u6210\uff1f\u662f\u8c01\u751f\u6210\uff1f","text":"<p>Graph \u4e0d\u662f\u4e00\u4e2a\u9759\u6001\u6587\u4ef6\uff0c\u5b83\u5728\u6784\u5efa\u65f6\u7531 <code>irtoc</code> \u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u5728\u5185\u5b58\u91cc\u521b\u5efa\u3002</p> <p>\u5173\u952e\u94fe\u8def\u662f\uff1a</p> <ul> <li>Ruby \u751f\u6210\u7684 <code>irtoc_code.cpp</code> \u91cc\u4f1a\u4ea7\u751f\u5f88\u591a <code>COMPILE(HANDLE_FAST_xxx) { ... }</code></li> <li><code>COMPILE(name)</code>\uff08\u5b9a\u4e49\u5728 <code>irtoc/backend/compilation.h</code>\uff09\u4f1a\u628a\u6bcf\u4e2a\u51fd\u6570\u6ce8\u518c\u6210\u4e00\u4e2a <code>Function unit</code></li> <li>\u6784\u5efa\u9636\u6bb5\u8fd0\u884c <code>irtoc</code> \u53ef\u6267\u884c\u7a0b\u5e8f\uff08\u5165\u53e3 <code>irtoc/backend/irtoc.cpp</code>\uff09\uff0c\u5b83\u4f1a\u6267\u884c <code>Compilation().Run()</code></li> <li><code>Compilation::Compile()</code> \u904d\u5386\u6240\u6709 units\uff0c\u5bf9\u6bcf\u4e2a unit \u8c03 <code>Function::Compile(...)</code></li> <li><code>Function::Compile</code> \u4f1a <code>New&lt;compiler::Graph&gt;(...)</code> \u521b\u5efa Graph\uff0c\u5e76\u8c03\u7528 <code>MakeGraphImpl()</code> \u628a IR \u8282\u70b9\u585e\u8fdb Graph</li> <li><code>MakeGraphImpl()</code> \u7684\u4e3b\u4f53\u5c31\u662f Ruby \u5728 <code>irtoc/lang/function.rb</code> \u91cc <code>emit_ir</code> \u51fa\u6765\u7684\u5185\u5bb9</li> <li>IR \u8282\u70b9\u7684\u6784\u9020\u5668\u662f <code>compiler::IrConstructor</code>\uff08\u89c1 <code>compiler/optimizer/ir/ir_constructor.h</code>\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#63-graph","title":"6.3 \u7b2c\u4e09\u6b65\uff1a\u8c01\u628a Graph \u7f16\u8bd1\u6210\u673a\u5668\u7801\uff1f\u673a\u5668\u7801\u751f\u6210\u5728\u54ea\u91cc\uff1f","text":"<p>\u8fd8\u662f\u6784\u5efa\u9636\u6bb5\u7684 <code>irtoc</code> \u53ef\u6267\u884c\u7a0b\u5e8f\u8d1f\u8d23\u201cGraph \u2192 \u673a\u5668\u7801\u201d\uff1a</p> <ul> <li>\u5bf9\u6bcf\u4e2a Graph\uff1a</li> <li>\u5148\u8dd1 IRTOC \u7684\u4f18\u5316\uff08<code>RunIrtocInterpreterOptimizations/RunIrtocOptimizations</code>\uff09</li> <li>\u7136\u540e\u8fdb\u5165 codegen\uff0c\u628a\u673a\u5668\u7801\u5199\u5165 <code>graph-&gt;GetCode()</code>\uff08\u6700\u7ec8\u4f1a\u88ab <code>Function::SetCode</code> \u62f7\u8d1d\u51fa\u6765\uff09</li> <li>\u5982\u679c\u5f00\u542f\u4e86 LLVM IRTOC \u8def\u5f84\uff08<code>PANDA_LLVM_IRTOC</code> \u7b49\u5b8f\uff09\uff0c\u5219 <code>Function::CompileByLLVM()</code> \u4f1a\u8c03\u7528 <code>llvmCompiler_-&gt;TryAddGraph(graph)</code>\uff1a</li> <li>\u6ce8\u610f\uff1a\u8fd9\u662f\u201cLLVM \u7f16\u8bd1 Graph\u201d\uff0c\u4e0d\u662f\u201cclang \u7f16\u8bd1 C++ interpreter\u201d</li> </ul> <p>\u6784\u5efa\u7cfb\u7edf\u8bc1\u636e\uff08\u4ee5 CMake \u4e3a\u4f8b\uff09\uff1a</p> <ul> <li><code>irtoc/backend/CMakeLists.txt</code> \u7684 <code>irtoc_compile(...)</code> \u4f1a\uff1a</li> <li>\u5148\u8fd0\u884c Ruby \u751f\u6210\u5668\u4ea7\u51fa <code>irtoc_code.cpp</code>\uff08\u4ee5\u53ca\u53ef\u9009 <code>irtoc_code_llvm.cpp</code>\uff09</li> <li>\u7f16\u8bd1\u4e00\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f <code>${TARGET}_exec</code>\uff08\u6e90\u7801\u5305\u542b <code>irtoc_code.cpp + irtoc/backend/irtoc.cpp</code>\uff09</li> <li>\u518d\u8fd0\u884c\u8fd9\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f\u751f\u6210 <code>${TARGET}.o</code> / <code>${TARGET}_llvm.o</code>\uff0c\u5e76\u8f93\u51fa <code>disasm.txt</code>\uff08\u7528\u4e8e\u9a8c\u8bc1\u673a\u5668\u7801\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#7-ir-graph","title":"7) IR \u56fe\uff08Graph\uff09\u5230\u5e95\u662f\u4ec0\u4e48\uff1f\u600e\u4e48\u7406\u89e3\u5b83\uff1f","text":"<p>\u5728\u672c\u5de5\u7a0b\u91cc\uff0c<code>compiler::Graph</code> \u662f\u7f16\u8bd1\u5668\u5185\u90e8\u7684 SSA/\u57fa\u672c\u5757\u5f62\u5f0f\u7684\u4e2d\u95f4\u8868\u793a\uff08IR\uff09\uff1a</p> <ul> <li>Graph = BasicBlock \u56fe\uff08\u63a7\u5236\u6d41\u56fe CFG\uff09</li> <li>BasicBlock \u91cc\u662f\u4e00\u4e32 Inst\uff08IR \u6307\u4ee4\uff09\uff08\u4f8b\u5982 Load/Store/Add/If/Phi/Call/Intrinsic\uff09</li> <li>Phi \u8282\u70b9\u8868\u8fbe\u63a7\u5236\u6d41\u5408\u6d41\u65f6\u7684 SSA \u503c\u9009\u62e9</li> </ul> <p>\u4f60\u53ef\u4ee5\u628a Graph \u7406\u89e3\u4e3a\u201c\u6bd4 C++ \u8bed\u6cd5\u66f4\u63a5\u8fd1 CPU \u6267\u884c\u6a21\u578b\u3001\u4e5f\u66f4\u5229\u4e8e\u4f18\u5316/\u5bc4\u5b58\u5668\u5206\u914d\u201d\u7684\u8868\u793a\u5f62\u5f0f\uff1a \u5b83\u80fd\u8ba9\u4f18\u5316\u5668\uff08CSE/LSE/LICM/RegAlloc/Scheduler\u2026\uff09\u5728\u201c\u89e3\u91ca\u5668 handler\u201d\u4e0a\u505a\u7f16\u8bd1\u5668\u7ea7\u522b\u7684\u4f18\u5316\uff0c\u7136\u540e\u518d\u751f\u6210\u673a\u5668\u7801\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#8-fast-interpreter-c-interpreter","title":"8) fast interpreter \u4e0e C++ interpreter \u7684\u5173\u7cfb\u662f\u4ec0\u4e48\uff1f","text":"<p>\u5173\u7cfb\uff1a\u8bed\u4e49\u76ee\u6807\u76f8\u540c\uff0c\u843d\u5730\u5f62\u6001\u4e0d\u540c\u3002</p> <ul> <li>C++ interpreter\uff08<code>runtime/interpreter/interpreter-inl.h</code> \u7b49\uff09\uff1a</li> <li>\u8bed\u4e49\u5b9e\u73b0\u4ee5 C++ handler \u4e3a\u4e3b</li> <li>dispatch loop/\u5f02\u5e38\u5165\u53e3\u5f88\u591a\u5728\u751f\u6210\u7684 <code>interpreter-inl_gen.h</code>\uff08\u6a21\u677f\u751f\u6210\uff09\u91cc</li> <li> <p>\u6bcf\u6761 opcode \u7684\u6267\u884c\u503e\u5411\u4e8e\u201c\u8bfb\u5199 Frame \u5185\u5b58 + \u5206\u652f/\u51fd\u6570\u8c03\u7528\u201d</p> </li> <li> <p>IRTOC/LLVM fast interpreter\uff08<code>.irt</code>\uff09\uff1a</p> </li> <li>\u4ecd\u7136\u4ee5 Frame/VReg/Acc \u4e3a\u8bed\u4e49\u4e2d\u5fc3\uff08\u53ea\u662f\u628a\u70ed\u70b9\u72b6\u6001\u7f13\u5b58\u5230\u56fa\u5b9a\u5bc4\u5b58\u5668\uff09</li> <li>dispatch \u662f computed-goto \u7684\u201c\u5c3e\u8df3\u8f6c\u5230 handler\u201d\uff08\u66f4\u63a5\u8fd1 direct threaded code\uff09</li> <li>handler \u662f\u201c\u63d0\u524d\u751f\u6210\u7684\u673a\u5668\u7801\u201d\uff0c\u800c\u4e0d\u662f\u8fd0\u884c\u65f6\u9891\u7e41\u7ecf\u8fc7 C++ \u62bd\u8c61\u5c42</li> </ul> <p>\u540c\u4e00\u4e2a\u5de5\u7a0b\u91cc\u4e24\u6761\u8def\u5f84\u5e76\u5b58\u7684\u610f\u4e49\uff1a C++ interpreter \u66f4\u9002\u5408 debug/\u53ef\u8bfb\u6027\uff1bfast interpreter \u66f4\u9002\u5408\u6027\u80fd\u4e0e\u53ef\u63a7\u7684\u4f4e\u5c42 ABI/\u5bc4\u5b58\u5668\u7b56\u7565\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#9-fast-interpreter-clang","title":"9) \u4e3a\u4ec0\u4e48 fast interpreter \u66f4\u5feb\uff1f\uff08\u6f84\u6e05\u201cclang \u4e5f\u4f1a\u4f18\u5316\u201d\u8fd9\u4e2a\u8bef\u89e3\uff09","text":"<p>\u4f60\u8bf4\u7684\u5173\u952e\u7591\u95ee\u662f\uff1a\u201cC++ interpreter \u4e5f\u662f clang/LLVM \u7f16\u8bd1\u7684\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u4e00\u6837\u5feb\uff1f\u201d</p> <p>\u8981\u70b9\u5728\u4e8e\uff1a\u662f\u5426\u4f7f\u7528 LLVM \u5e76\u4e0d\u662f\u552f\u4e00\u53d8\u91cf\uff0c\u2018\u7a0b\u5e8f\u7ed3\u6784\u2019\u624d\u662f\u51b3\u5b9a\u89e3\u91ca\u5668\u6027\u80fd\u7684\u6838\u5fc3\u53d8\u91cf\u3002</p> <p>fast interpreter \u66f4\u5feb\u4e3b\u8981\u6765\u81ea\u8fd9\u4e9b\u7ed3\u6784\u6027\u5dee\u5f02\uff1a</p> <p>1) \u72b6\u6001\u5e38\u9a7b\u5bc4\u5b58\u5668\uff1a<code>tr/pc/frame/acc/dispatch</code> \u56fa\u5b9a\u5bc4\u5b58\u5668\u51cf\u5c11 load/store 2) direct threaded dispatch\uff1a<code>dispatch_table[opc]</code> + <code>tail_call/jmp</code>\uff0c\u51cf\u5c11 switch/\u5206\u652f\u5f00\u9500 3) \u66f4\u53ef\u63a7\u7684 ABI \u4e0e\u8fb9\u754c\uff1aacc \u5199\u56de/\u6062\u590d\u3001\u5f02\u5e38\u5165\u53e3 slot\u3001OSR fake-return \u7b49\u90fd\u662f\u201c\u5199\u6b7b\u7684\u534f\u8bae\u201d\uff0c\u4fbf\u4e8e\u5168\u94fe\u8def\u4f18\u5316 4) \u7f16\u8bd1\u5668 IR \u4f18\u5316\u9002\u914d\uff1aGraph \u7ea7\u4f18\u5316\uff08CSE/LSE/RegAlloc/Scheduler\u2026\uff09\u5bf9 handler \u8fd9\u79cd\u5c0f\u70ed\u5757\u975e\u5e38\u6709\u6548</p> <p>\u800c C++ interpreter \u5373\u4fbf\u7531 clang \u7f16\u8bd1\uff1a</p> <ul> <li>\u4e5f\u5f88\u96be\u81ea\u52a8\u628a\u5b83\u201c\u53d8\u5f62\u201d\u4e3a\u540c\u7b49\u7ed3\u6784\u7684 direct threaded code\uff08\u5c24\u5176\u662f\u4e0e Frame/GC/\u5f02\u5e38/OSR \u534f\u8bae\u8026\u5408\u7684\u90e8\u5206\uff09</li> <li>\u5927\u91cf\u8fb9\u754c\u68c0\u67e5\u3001\u62bd\u8c61\u5c42\u3001\u4ee5\u53ca\u66f4\u4fdd\u5b88\u7684\u522b\u540d\u5206\u6790\uff0c\u4f1a\u9650\u5236\u7f16\u8bd1\u5668\u80fd\u505a\u7684\u4f18\u5316</li> </ul> <p>\u7ed3\u8bba\uff1aLLVM/clang \u80fd\u628a C++ \u7f16\u8bd1\u6210\u673a\u5668\u7801\uff0c\u4f46\u4e0d\u4fdd\u8bc1\u5b83\u62e5\u6709 fast interpreter \u90a3\u79cd\u201c\u4e3a\u89e3\u91ca\u5668\u800c\u8bbe\u8ba1\u201d\u7684\u6267\u884c\u7ed3\u6784\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Primer/#10","title":"10) \u66f4\u8be6\u5c3d\u7684\u8bed\u6cd5\u53c2\u8003\uff08\u6559\u79d1\u4e66\u5f0f\uff09","text":"<p>\u5982\u679c\u4f60\u5e0c\u671b\u50cf C \u8bed\u8a00\u6559\u79d1\u4e66\u4e00\u6837\u7cfb\u7edf\u5b66\u4e60 DSL\uff08\u6bcf\u4e2a\u6784\u9020\u7684\u8bed\u4e49\u3001\u7c7b\u578b\u7cfb\u7edf\u3001\u63a7\u5236\u6d41\u3001LiveIn/LiveOut\u3001\u5e38\u7528\u8282\u70b9\uff09\uff0c\u5efa\u8bae\u7ee7\u7eed\u8bfb\uff1a</p> <ul> <li>IRTOC_DSL_Reference\uff08\u66f4\u8be6\u5c3d\u7684\u201c\u8bed\u6cd5/\u8bed\u4e49\u53c2\u8003\u201d\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/","title":"IRTOC <code>.irt</code> DSL \u53c2\u8003\uff08\u66f4\u201c\u6559\u79d1\u4e66\u5f0f\u201d\u7684\u8bed\u6cd5/\u8bed\u4e49\u8bf4\u660e\uff09","text":"<p>\u76ee\u6807\uff1a\u6bd4 IRTOC_DSL_Primer \u66f4\u7cfb\u7edf\u3002\u4f60\u53ef\u4ee5\u628a\u5b83\u5f53\u4f5c\u201c\u67e5\u624b\u518c\u201d\uff1a - \u770b\u5230\u4e00\u6bb5 <code>.irt</code> \u4e0d\u8ba4\u8bc6\u7684\u5199\u6cd5\uff0c\u6765\u8fd9\u91cc\u627e\u201c\u5b83\u662f\u4ec0\u4e48 / \u5b83\u7b49\u4ef7\u4e8e\u4ec0\u4e48 / \u5e38\u89c1\u5751\u662f\u4ec0\u4e48\u201d\u3002 - \u4ecd\u7136\u575a\u6301\u4e00\u4e2a\u539f\u5219\uff1a\u6bcf\u6761\u89c4\u5219\u90fd\u80fd\u56de\u5230\u6e90\u7801/\u751f\u6210\u7269\u9a8c\u8bc1\uff08\u8bc1\u636e\u94fe\u5728\u6bcf\u8282\u672b\u5c3e\uff09\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#0","title":"0) \u5165\u53e3\u4e0e\u8bc1\u636e\u94fe","text":"<ul> <li>\u65b0\u4eba\u5148\u8bfb\uff1aIRTOC_DSL_Primer\uff08\u7ba1\u7ebf + \u5fc3\u667a\u6a21\u578b + \u5de5\u4f5c\u6d41\uff09</li> <li>Ruby \u751f\u6210\u5668\u6e90\u7801\uff1a<code>irtoc/lang/irtoc.rb</code>\u3001<code>irtoc/lang/function.rb</code></li> <li>C++ \u7f16\u8bd1\u5668\u6e90\u7801\uff1a<code>irtoc/backend/compilation.h/.cpp</code>\u3001<code>irtoc/backend/function.cpp</code></li> <li>Graph/IR \u5b9a\u4e49\uff1a<code>compiler/optimizer/ir/graph.h</code>\u3001<code>compiler/optimizer/ir/ir_constructor.h</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#1-ruby-dsl","title":"1) \u8bed\u8a00\u5206\u5c42\uff1a\u54ea\u4e9b\u662f Ruby\uff1f\u54ea\u4e9b\u662f DSL\uff1f","text":"<p>\u5728 <code>.irt</code> \u91cc\u4f60\u4f1a\u540c\u65f6\u770b\u5230\u4e24\u7c7b\u8bed\u6cd5\uff1a</p> <ul> <li>Ruby \u63a7\u5236\u6d41/\u5143\u7f16\u7a0b\uff08\u7531 Ruby \u89e3\u91ca\u6267\u884c\uff09\uff1a</li> <li><code>if Options.arm64?</code></li> <li><code>array.each do |x|</code></li> <li><code>def helper(...) ... end</code></li> <li>IRTOC DSL\uff08\u6700\u7ec8\u6784\u9020\u6210 compiler IR Graph\uff09\uff1a</li> <li><code>macro(:name) do |...| ... end</code></li> <li><code>x := LoadI(...)...</code></li> <li><code>If(...).NE do ... end</code></li> <li><code>Phi(a, b).i32</code></li> <li><code>Intrinsic(:INTERPRETER_RETURN)</code></li> </ul> <p>\u5224\u5b9a\u65b9\u6cd5\uff08\u5b9e\u6218\uff09\uff1a \u53ea\u8981\u5b83\u6700\u540e\u4f1a\u843d\u5230 <code>LoadI/AddI/If/Phi/Intrinsic/Call/...</code> \u8fd9\u7c7b\u201c\u8282\u70b9\u6784\u9020\u5668\u201d\uff0c\u5b83\u5c31\u5728\u6784\u9020 IR\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#2-irt-ruby","title":"2) \u9884\u5904\u7406\u8bed\u6cd5\uff08\u4e3a\u4ec0\u4e48 <code>.irt</code> \u770b\u8d77\u6765\u4e0d\u50cf Ruby \u8fd8\u80fd\u8dd1\uff09","text":"<p><code>irtoc/lang/irtoc.rb</code> \u4f1a\u5bf9\u6bcf\u884c\u505a\u9884\u5904\u7406\uff08\u518d <code>instance_eval</code>\uff09\uff0c\u5e38\u89c1\u89c4\u5219\uff1a</p> <ul> <li><code>name := expr</code> \u2192 <code>let :name, expr</code>\uff08\u628a\u201cDSL \u8d4b\u503c\u201d\u53d8\u6210 Ruby \u65b9\u6cd5\u8c03\u7528\uff09</li> <li><code>%tr/%pc/%frame/...</code> \u2192 <code>LiveIn(regmap[:tr])</code>\uff08\u628a\u8bed\u4e49\u5bc4\u5b58\u5668\u5f15\u7528\u53d8\u6210 LiveIn\uff09</li> <li><code>} Else</code> \u2192 <code>}; Else</code>\uff08\u4fee\u590d Ruby \u8bed\u6cd5\u6b67\u4e49\uff0c\u4fbf\u4e8e\u751f\u6210\u5668\u89e3\u6790\uff09</li> </ul> <p>\u7ed3\u8bba\uff1a<code>.irt</code> \u4e0d\u662f\u7eaf Ruby \u8bed\u6cd5\uff0c\u800c\u662f\u201cRuby + \u9884\u5904\u7406 DSL\u201d\u7684\u6df7\u5408\u8bed\u8a00\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#3-graph-basicblock-inst","title":"3) \u6838\u5fc3\u6982\u5ff5\uff1aGraph / BasicBlock / Inst\uff08\u4f60\u8be5\u5982\u4f55\u5fc3\u667a\u5316\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#31-graph","title":"3.1 Graph \u662f\u4ec0\u4e48","text":"<p>Graph \u662f\u7f16\u8bd1\u5668\u5185\u90e8 IR\uff08SSA + CFG\uff09\u3002\u4f60\u53ef\u4ee5\u628a\u5b83\u7406\u89e3\u4e3a\uff1a</p> <ul> <li>\u4e00\u4e2a\u63a7\u5236\u6d41\u56fe\uff08BasicBlocks \u7ec4\u6210\uff09</li> <li>\u6bcf\u4e2a BasicBlock \u91cc\u662f\u4e00\u4e32 IR \u6307\u4ee4\uff08Inst\uff09</li> <li>Phi \u8282\u70b9\u662f SSA \u5408\u6d41</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#32-inst","title":"3.2 Inst \u662f\u4ec0\u4e48","text":"<p>\u6bcf\u4e2a <code>LoadI/AddI/...</code> \u90fd\u5bf9\u5e94\u4e00\u79cd IR \u6307\u4ee4\u7c7b\u578b\uff1b\u540e\u7eed\u4f18\u5316/\u5bc4\u5b58\u5668\u5206\u914d/\u6307\u4ee4\u9009\u62e9\u90fd\u4f1a\u4ee5 Inst \u4e3a\u5355\u4f4d\u5de5\u4f5c\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#33-irt-graph","title":"3.3 <code>.irt</code> \u5728\u6784\u9020 Graph \u65f6\u7684\u201c\u9690\u542b\u4e0a\u4e0b\u6587\u201d","text":"<p>\u5bf9\u89e3\u91ca\u5668 handler\uff08Interpreter/InterpreterEntry \u6a21\u5f0f\uff09\u800c\u8a00\uff0cGraph \u9690\u542b\u4e86\uff1a</p> <ul> <li>arch\uff08\u76ee\u6807\u67b6\u6784\uff09</li> <li>runtime interface\uff08<code>IrtocRuntimeInterface</code>\uff09</li> <li>\u56fa\u5b9a\u5bc4\u5b58\u5668\u4e0e LiveIn/LiveOut \u7684\u7ea6\u675f</li> <li>Frame/Thread/Method \u7b49\u5e03\u5c40 offset\uff08\u6765\u81ea <code>common.irt</code> \u7684 Constants\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#4-macro-dsl","title":"4) <code>macro</code>\uff1a\u53ef\u590d\u7528\u7247\u6bb5\uff08\u76f8\u5f53\u4e8e DSL \u7684\u201c\u5185\u8054\u51fd\u6570\u201d\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#41-macroname-do-args-end","title":"4.1 <code>macro(:name) do |args| ... end</code>","text":"<ul> <li>\u5b9a\u4e49\u4e3a <code>Function</code> \u7c7b\u7684\u65b9\u6cd5\uff08\u6240\u4ee5\u5b8f\u672c\u8d28\u662f Ruby \u7684\u65b9\u6cd5\uff09</li> <li>\u88ab\u5176\u4ed6\u5b8f/handler \u76f4\u63a5\u8c03\u7528</li> <li>\u5b8f\u91cc\u8fd4\u56de\u7684\u6700\u540e\u4e00\u4e2a IR \u503c\u901a\u5e38\u662f\u201c\u8be5\u5b8f\u7684\u7ed3\u679c\u201d</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#42-scoped_macrolabel","title":"4.2 <code>scoped_macro</code>\uff08\u5c40\u90e8\u53d8\u91cf/label \u4f5c\u7528\u57df\u66f4\u5f3a\uff09","text":"<p>\u5982\u679c\u4f60\u9700\u8981\u5728\u5b8f\u5185\u90e8\u521b\u5efa label/locals\uff0c\u5e76\u907f\u514d\u6c61\u67d3\u5916\u5c42\uff0c\u4f7f\u7528 <code>scoped_macro</code>\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#5-x-ssa","title":"5) <code>x := ...</code> \u4e0e SSA \u503c","text":"<p><code>x := expr</code> \u662f\u201c\u521b\u5efa SSA \u503c\u201d\u7684\u8bed\u6cd5\u7cd6\uff1a</p> <ul> <li>\u4e0d\u8981\u628a\u5b83\u7406\u89e3\u6210 C \u7684\u53d8\u91cf\u8d4b\u503c</li> <li>\u66f4\u50cf\u201c\u628a\u4e00\u4e2a IR \u6307\u4ee4\u7684\u7ed3\u679c\u7ed1\u5b9a\u5230\u4e00\u4e2a\u540d\u5b57\uff0c\u4f9b\u540e\u7eed IR \u6307\u4ee4\u5f15\u7528\u201d</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#6-u8i32refany","title":"6) \u7c7b\u578b\u7cfb\u7edf\uff1a<code>.u8/.i32/.ref/.any</code> \u5230\u5e95\u5728\u5e72\u4ec0\u4e48","text":"<p>\u5728 DSL \u91cc\uff0c\u5f88\u591a\u8282\u70b9\u6784\u9020\u5668\u540e\u9762\u4f1a\u63a5 <code>.u8/.i32/.i64/.ref</code>\uff1a</p> <ul> <li>\u5b83\u4eec\u7ed9 IR \u8282\u70b9\u6807\u6ce8 DataType</li> <li>\u5bf9\u4f18\u5316/\u6307\u4ee4\u9009\u62e9/\u5bc4\u5b58\u5668\u5206\u914d\u81f3\u5173\u91cd\u8981</li> </ul> <p>\u5b9e\u6218\u5efa\u8bae\uff1a \u5f53\u4f60\u770b\u5230\u201c\u5bf9\u8c61/primitive \u6df7\u4e71\u201d\u201ctag \u9519\u201d\u201c32/64 \u622a\u65ad\u9519\u201d\uff0c\u4f18\u5148\u68c0\u67e5\uff1a</p> <ul> <li><code>common.irt</code> \u91cc\u7684 <code>Constants::REF_UINT</code> \u7b49\u7c7b\u578b\u5b9a\u4e49</li> <li>\u4f60\u6539\u7684\u8282\u70b9\u662f\u5426\u8bef\u7528\u4e86 <code>.u32/.i32</code> \u5bfc\u81f4\u9690\u5f0f\u622a\u65ad</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#7-if-phi-label","title":"7) \u63a7\u5236\u6d41\uff1a<code>If</code> / <code>Phi</code> / label\uff08\u4f60\u5e94\u8be5\u600e\u4e48\u5199\u624d\u4e0d\u8e29\u5751\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#71-ifx-yne-do-end","title":"7.1 <code>If(x, y).NE do ... end</code>","text":"<p>\u4f1a\u751f\u6210\u6761\u4ef6\u5206\u652f\u4e0e\u4e24\u4e2a basic blocks\uff08\u6982\u5ff5\u4e0a\uff09\uff0c\u5e76\u628a IR \u6307\u4ee4\u653e\u5165\u5bf9\u5e94 block\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#72-phia-b","title":"7.2 <code>Phi(a, b)</code>","text":"<p>\u53ea\u6709\u5728\u201c\u63a7\u5236\u6d41\u5408\u6d41\u70b9\u201d\u624d\u5408\u6cd5\uff1b\u5426\u5219\u4f1a\u88ab\u9a8c\u8bc1\u5668/\u6784\u9020\u5668\u8ba4\u4e3a\u662f\u65e0\u610f\u4e49\u7684 SSA \u5408\u6d41\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#8-intrinsic","title":"8) <code>Intrinsic(...)</code>\uff1a\u540e\u7aef\u7ea6\u5b9a\u7684\u201c\u8bed\u4e49\u6307\u4ee4\u201d","text":"<p>fast interpreter \u6700\u5e38\u89c1\u7684 intrinsic\uff1a</p> <ul> <li><code>:TAIL_CALL</code>\uff1a\u5b9e\u73b0 computed-goto\uff08\u8df3\u5230\u4e0b\u4e00 handler\uff09</li> <li><code>:INTERPRETER_RETURN</code>\uff1a\u8fd4\u56de\u5230 runtime \u8fb9\u754c</li> </ul> <p>\u4f60\u6539 dispatch/\u5f02\u5e38/OSR \u65f6\uff0c\u901a\u5e38\u7ed5\u4e0d\u5f00 Intrinsic\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#9-liveinliveoutfast-interpreter","title":"9) LiveIn/LiveOut\uff1a\u5bc4\u5b58\u5668\u7ea6\u5b9a\uff08fast interpreter \u7684\u751f\u547d\u7ebf\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#91-liveout","title":"9.1 \u4e3a\u4ec0\u4e48\u5fc5\u987b\u663e\u5f0f LiveOut","text":"<p>fast interpreter \u7684\u6027\u80fd\u6765\u81ea\u56fa\u5b9a\u5bc4\u5b58\u5668\uff0c\u4f46\u56fa\u5b9a\u5bc4\u5b58\u5668\u540c\u65f6\u4e5f\u662f\u201c\u540e\u7aef\u53ef\u80fd\u590d\u7528\u7684\u8d44\u6e90\u201d\u3002 \u5982\u679c\u4f60\u5728\u5173\u952e\u8def\u5f84\u4e0a\u6ca1\u628a\u72b6\u6001 LiveOut\uff0c\u540e\u7aef\u53ef\u80fd\u4f1a\u628a\u5b83\u5f53\u4e34\u65f6\u5bc4\u5b58\u5668\u8986\u76d6\uff0c\u5bfc\u81f4\u9519\u8bef\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#92-liveout","title":"9.2 \u5e38\u89c1\u9700\u8981 LiveOut \u7684\u72b6\u6001","text":"<ul> <li><code>pc/table/frame/tr</code>\uff08dispatch \u9700\u8981\uff09</li> <li><code>acc/acc_tag</code>\uff08GC/safepoint/\u5f02\u5e38/\u6865\u63a5\u9700\u8981\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_DSL_Reference/#10-c-dsl","title":"10) \u5efa\u8bae\u7684\u5b66\u4e60\u8def\u5f84\uff08\u50cf\u5b66 C \u4e00\u6837\u5b66 DSL\uff09","text":"<p>\u5982\u679c\u4f60\u8981\u201c\u7cfb\u7edf\u638c\u63e1\u201d\uff1a</p> <p>1) \u5148\u628a IRTOC_DSL_Primer \u7684 6/7/8/9 \u8282\u5403\u900f\uff08\u7ba1\u7ebf + Graph + \u6027\u80fd\u539f\u56e0\uff09 1) \u5148\u628a IRTOC_DSL_Primer \u7684 6/7/8/9 \u8282\u5403\u900f\uff08\u7ba1\u7ebf + Graph + \u6027\u80fd\u539f\u56e0\uff09 2) \u518d\u6309 irtoc_scripts_common.irt \u5b66\u4f1a\u8bfb <code>Constants/regmap</code> 3) \u6700\u540e\u6309 irtoc_scripts_interpreter.irt \u7684\u951a\u70b9\uff0c\u628a dispatch/exception/OSR/call-return \u9010\u6bb5\u8bfb\u5b8c</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/","title":"Flow\uff1aIRTOC/LLVM Fast Interpreter\uff08ExecuteImpl \u2192 SetupDispatchTable \u2192 ExecuteImplFast\uff09","text":""},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201c\u89e3\u91ca\u5668\u9009\u578b\uff08\u8fd0\u884c\u65f6\u771f\u5b9e\u5165\u53e3\uff09\u201d\u4e0e\u201c\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\u201d\u6846\uff1a\u672c flow \u89e3\u91ca fast interpreter \u7684\u771f\u5b9e\u6267\u884c\u8def\u5f84\u4e0e build \u751f\u6210\u94fe\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u5f53\u4f60\u53d1\u73b0\uff1a</p> <ul> <li>\u201c\u751f\u4ea7\u73af\u5883\u9ed8\u8ba4\u8d70 llvm interpreter\uff0c\u6211\u770b C++ handler \u600e\u4e48\u5bf9\u4e0d\u4e0a\uff1f\u201d</li> <li>\u201c<code>--interpreter-type</code> \u5207\u6362\u540e\uff0c\u4ee3\u7801\u8def\u5f84\u5b8c\u5168\u53d8\u4e86\u201d</li> <li>\u201cdispatch table \u4ece\u54ea\u91cc\u6765\uff1f<code>ExecuteImplFast</code> \u662f\u8c01\u5b9e\u73b0\u7684\uff1f\u201d</li> </ul> <p>\u8fd9\u6761 flow \u628a \u8fd0\u884c\u65f6\u9009\u578b \u2192 dispatch table \u2192 fast interpreter entry \u4e32\u8d77\u6765\uff0c\u5e76\u628a build \u751f\u6210\u7269\u6307\u7ed9\u4f60\u770b\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#2-mermaid","title":"2) Mermaid\uff1a\u8fd0\u884c\u65f6\u8c03\u7528\u94fe\uff08\u771f\u5b9e\u6267\u884c\u8def\u5f84\uff09","text":"<pre><code>flowchart TD\n  A[\"interpreter::Execute(thread, pc, frame)\"] --&gt; B[\"ExecuteImpl(thread, pc, frame, jumpToEh)\\n(runtime/interpreter/interpreter_impl.cpp)\"]\n  B --&gt; C{\"GetInterpreterTypeFromRuntimeOptions(frame)\\n--interpreter-type=cpp/irtoc/llvm\"}\n  C --&gt;|cpp| CPP[\"ExecuteImplInner&lt;...&gt;()\\n(C++ interpreter)\"]\n  C --&gt;|irtoc| IRT[\"SetupDispatchTableImpl()\\n(build/runtime/include/irtoc_interpreter_utils.h)\"]\n  C --&gt;|llvm| LLVM[\"SetupLLVMDispatchTableImpl()\\n(build/runtime/include/irtoc_interpreter_utils.h)\"]\n  IRT --&gt; D[\"dispatch_table (void(*)()[392])\"]\n  LLVM --&gt; D\n  D --&gt; E{\"jumpToEh ?\"}\n  E --&gt;|false| F[\"ExecuteImplFast(..., dispatch_table)\\n(IRTOC \u751f\u6210\u7b26\u53f7)\"]\n  E --&gt;|true| G[\"ExecuteImplFastEH(..., dispatch_table)\\n(IRTOC \u751f\u6210\u7b26\u53f7)\"]</code></pre>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#3-mermaidbuild","title":"3) Mermaid\uff1abuild \u751f\u6210\u94fe\uff08\u811a\u672c \u2192 \u673a\u5668\u7801\uff09","text":"<pre><code>flowchart TD\n  S[\"irtoc/scripts/interpreter.irt\"] --&gt; FIX[\"build/irtoc/irtoc_interpreter/interpreter.irt.fixed\"]\n  FIX --&gt; CPP[\"build/irtoc/irtoc_interpreter/irtoc_code.cpp\\n(COMPILE(HANDLE_FAST_*))\"]\n  CPP --&gt; OBJ[\"build/irtoc/irtoc_interpreter/irtoc_interpreter.o\"]\n  S --&gt; DT[\"build/runtime/include/irtoc_interpreter_utils.h\\n(Setup*DispatchTableImpl)\"]\n  OBJ --&gt; R[\"runtime/interpreter/interpreter_impl.cpp\\n\u8c03\u7528 ExecuteImplFast*\"]\n  DT --&gt; R</code></pre>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#4","title":"4) \u6392\u969c\u6293\u624b\uff08\u4f60\u5e94\u8be5\u5148\u770b\u54ea\u91cc\uff09","text":"<ul> <li>\u89e3\u91ca\u5668\u9009\u578b\u662f\u5426\u7b26\u5408\u9884\u671f\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4 cpp\uff08\u9664\u975e\u663e\u5f0f\u8bbe\u7f6e\uff09</li> <li>debug-mode \u53ea\u80fd cpp</li> <li>\u90e8\u5206 GC/\u7f16\u8bd1\u5f00\u5173\u4f1a\u5bfc\u81f4\u964d\u7ea7</li> <li>dispatch table \u662f\u5426\u4e3a\u4f60\u671f\u671b\u7684\u540e\u7aef\uff1a<code>SetupDispatchTableImpl</code> vs <code>SetupLLVMDispatchTableImpl</code></li> <li>handler \u7b26\u53f7\u662f\u5426\u5b58\u5728\uff1a<code>HANDLE_FAST_*</code> / <code>HANDLE_FAST_*_LLVM</code>\uff08<code>irtoc_interpreter_utils.h</code> \u91cc\u662f\u58f0\u660e + table\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#41","title":"4.1 \u89e3\u91ca\u5668\u9009\u578b\u201c\u7cbe\u786e\u89c4\u5219\u201d\uff08\u6309\u6e90\u7801\u53ef\u590d\u6838\uff0c\u4e0d\u9760\u731c\uff09","text":"<p>\u6838\u5fc3\u5165\u53e3\uff1a<code>runtime/interpreter/interpreter_impl.cpp::GetInterpreterTypeFromRuntimeOptions/ExecuteImpl</code></p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#a-cpp","title":"A) \u9ed8\u8ba4\u503c\u4e0e\u201c\u52a8\u6001\u8bed\u8a00\u9ed8\u8ba4 cpp\u201d","text":"<ul> <li>options \u9ed8\u8ba4\u503c\uff1a<code>--interpreter-type</code> \u9ed8\u8ba4\u662f <code>llvm</code>\uff08<code>runtime/options.yaml:886-890</code>\uff09\u3002</li> <li>\u4f46\u52a8\u6001\u8bed\u8a00\u6709\u7279\u4f8b\uff1a\u6e90\u7801\u76f4\u63a5\u5199\u660e\uff1a<code>Dynamic languages default is always cpp interpreter (unless option was set)</code>\u3002   \u5373\uff1aframe \u662f dynamic \u4e14\u4f60\u6ca1\u6709\u663e\u5f0f\u8bbe\u7f6e <code>--interpreter-type</code> \u65f6\uff0c\u4f1a\u5f3a\u5236\u8d70 cpp\uff08\u5373\u4f7f options \u9ed8\u8ba4\u662f llvm\uff09\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#b-interpreter-type","title":"B) \u6784\u5efa\u5f00\u5173\u5bfc\u81f4\u7684\u201c\u81ea\u52a8\u964d\u7ea7\u201d\uff08\u53ea\u5728\u4f60\u6ca1\u6709\u663e\u5f0f\u8bbe\u7f6e interpreter-type \u65f6\u53d1\u751f\uff09","text":"<p>\u5f53 <code>--interpreter-type</code> \u672a\u663e\u5f0f\u8bbe\u7f6e\uff08<code>wasSet == false</code>\uff09\u65f6\uff1a</p> <ul> <li>\u6ca1\u7f16\u8fdb LLVM interpreter\uff08\u672a\u5b9a\u4e49 <code>PANDA_LLVM_INTERPRETER</code>\uff09\uff1a<code>llvm \u2192 irtoc</code></li> <li>\u6ca1\u7f16\u8fdb IRTOC\uff08\u672a\u5b9a\u4e49 <code>PANDA_WITH_IRTOC</code>\uff09\uff1a<code>irtoc \u2192 cpp</code></li> <li>ARK_HYBRID \u7279\u4f8b\uff1a\u82e5\u9ed8\u8ba4\u9009\u62e9\u5230 <code>llvm</code>\uff0c\u4f1a\u6253\u5370 INFO \u5e76 \u964d\u7ea7\u5230 irtoc\uff08\u6ce8\u91ca\u5199\u660e CMC GC \u7684 LLVM \u652f\u6301\u4ecd\u5728\u8865\u9f50\uff09</li> </ul> <p>\u91cd\u8981\uff1a\u5982\u679c\u4f60 \u663e\u5f0f\u8bbe\u7f6e \u4e86 <code>--interpreter-type=llvm/irtoc</code>\uff0c\u800c\u5f53\u524d\u6784\u5efa\u4e0d\u652f\u6301\uff0c\u5bf9\u5e94\u8def\u5f84\u4f1a <code>LOG(FATAL)</code>\uff0c\u4e0d\u4f1a\u964d\u7ea7\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#c-fatal","title":"C) \u8fd0\u884c\u65f6\u786c\u7ea6\u675f\uff08\u4e0d\u6ee1\u8db3\u76f4\u63a5 FATAL\uff0c\u4e0d\u662f\u201c\u964d\u7ea7\u201d\uff09","text":"<p>\u5f53\u6700\u7ec8 interpreter-type &gt; cpp\uff08\u5373 irtoc/llvm\uff09\u65f6\uff0c<code>ExecuteImpl</code> \u8fd8\u4f1a\u505a\u4e00\u7ec4\u786c\u68c0\u67e5\uff1a</p> <ul> <li>debug-mode \u9650\u5236\uff1a<code>--debug-mode=true</code> \u53ea\u80fd \u914d <code>--interpreter-type=cpp</code>\uff08\u5426\u5219 FATAL\uff09</li> <li>Arm32 \u9650\u5236\uff1a<code>PANDA_TARGET_ARM32</code> \u4e0b irtoc \u4e0d\u53ef\u7528\uff0c\u6574\u4e2a\u6587\u4ef6\u628a\u9009\u578b\u5305\u5728 <code>#if !defined(PANDA_TARGET_ARM32)</code> \u5185\uff08\u7b49\u4ef7\u4e8e arm32 \u6c38\u8fdc cpp\uff09</li> <li>GC \u9650\u5236\uff08\u975e ARK_HYBRID\uff09\uff1a</li> <li>\u5bf9 \u52a8\u6001\u8bed\u8a00\uff1a\u82e5\u4f60\u663e\u5f0f\u8981\u6c42 irtoc/llvm\uff0c\u5219 GC \u5fc5\u987b\u662f <code>G1_GC</code>\uff0c\u5426\u5219 FATAL\uff08\u63d0\u793a dynamic languages \u7684 gc-type \u4ec5 cpp \u652f\u6301\uff09</li> <li>ARK_HYBRID \u7684\u7ec4\u5408\u9650\u5236\uff1a</li> <li>\u53ea\u8981 interpreter-type &gt; cpp\uff0cGC \u5fc5\u987b\u662f <code>CMC_GC</code>\uff0c\u5426\u5219 FATAL</li> <li>\u5e76\u4e14 <code>interpreter-type == llvm</code> \u4f1a\u76f4\u63a5 FATAL\uff08\u4fe1\u606f\uff1aCMC GC \u53ea\u652f\u6301 cpp \u6216 irtoc\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#42-dispatch-table-392","title":"4.2 dispatch table \u7684 392 \u662f\u600e\u4e48\u6765\u7684\uff08\u4ece\u6a21\u677f\u53ef\u7b97\u51fa\u6765\uff09","text":"<p>\u4f60\u5728 <code>build/runtime/include/irtoc_interpreter_utils.h</code> \u770b\u5230\u7684 <code>std::array&lt;void (*)(), 392&gt;</code> \u4e0d\u662f\u968f\u624b\u5199\u7684\u5e38\u91cf\uff0c\u5b83\u6765\u81ea\u6a21\u677f\u5c55\u5f00\u540e\u7684\u201chandler \u540d\u5355\u957f\u5ea6\u201d\uff1a</p> <ul> <li>IRTOC/LLVM fast interpreter \u7684 table\uff1a\u751f\u6210\u6a21\u677f <code>runtime/interpreter/templates/irtoc_interpreter_utils.h.erb</code> \u91cc\u76f4\u63a5\u7528\uff1a</li> <li><code>std::array&lt;void (*)(), Panda::dispatch_table.handler_names.size() + 1&gt;</code></li> <li> <p>\u6700\u540e <code>+1</code> \u662f\u8865\u4e0a <code>HANDLE_FAST_EXCEPTION(_LLVM)</code> \u8fd9\u4e2a\u5f02\u5e38\u69fd\u4f4d</p> </li> <li> <p>C++ interpreter \u7684 label dispatch table\uff08\u540c\u957f\u5ea6\u3001\u540c\u4e00\u5957 ISA \u7a7a\u95f4\uff09\uff1a\u751f\u6210\u6a21\u677f <code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u91cc\u6709\uff1a</p> </li> <li><code>DISPATCH_TABLE_LEN = 256 + NUM_PREFIXED + 1</code></li> <li><code>256</code>\uff1a\u4e00\u7ea7\u8868\u8986\u76d6 0..255 \u7684 primary opcode</li> <li><code>NUM_PREFIXED</code>\uff1aprefix \u6269\u5c55\u51fa\u7684\u989d\u5916 opcode \u6570\uff08\u6765\u81ea ISA\uff09</li> <li><code>+1</code>\uff1a\u4e3a <code>EXCEPTION_HANDLER</code> \u9884\u7559\u7684\u69fd\u4f4d\uff08\u89c1 <code>isa_constants_gen.h.erb</code> \u6ce8\u91ca\uff09</li> </ul> <p>\u56e0\u6b64\uff1a\u5728\u672c\u4ed3\u5e93\u5f53\u524d ISA \u4e0b\uff0c<code>392</code> \u540c\u65f6\u6ee1\u8db3\uff1a</p> <ul> <li><code>392 = Panda::dispatch_table.handler_names.size() + 1</code>\uff08fast interpreter table \u7684\u771f\u5b9e\u751f\u6210\u89c4\u5219\uff09</li> <li><code>392 = 256 + NUM_PREFIXED + 1</code>\uff08\u540c\u4e00\u5957 ISA \u7a7a\u95f4\u4e0b\uff0cC++ interpreter \u7684 label table \u957f\u5ea6\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#5","title":"5) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\uff09","text":"<ul> <li>\u8fd0\u884c\u65f6\uff1a<code>runtime/interpreter/interpreter_impl.cpp</code></li> <li>build header\uff1a<code>build/runtime/include/irtoc_interpreter_utils.h</code></li> <li>IRTOC \u811a\u672c\uff1a<code>irtoc/scripts/interpreter.irt</code></li> <li>IRTOC \u7f16\u8bd1\u4ea7\u7269\uff1a<code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#6-vm-irtoc","title":"6) VM \u67b6\u6784\u5e08\u89c6\u89d2\uff1a\u65b0\u4eba\u5982\u4f55\u201c\u771f\u6b63\u5b66\u4f1a\u6539 IRTOC\u201d\uff08\u4ece\u73b0\u8c61\u5230\u843d\u5730\uff09","text":"<p>\u8fd9\u662f\u65b0\u4eba\u6700\u7f3a\u7684\u4e00\u6bb5\uff1a\u77e5\u9053 fast interpreter \u5b58\u5728 \u2260 \u80fd\u6539\u5f97\u52a8\u3002 \u5efa\u8bae\u628a\u5b83\u5f53\u4f5c\u4f60\u505a\u4efb\u4f55 IRTOC \u76f8\u5173\u6539\u52a8\u524d\u7684\u56fa\u5b9a checklist\u3002</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#61","title":"6.1 \u4e00\u53e5\u8bdd\u5de5\u4f5c\u6d41\uff08\u6700\u77ed\u95ed\u73af\uff09","text":"<p>\u786e\u8ba4\u4f60\u8dd1\u7684\u662f fast interpreter \u2192 \u5b9a\u4f4d <code>.irt</code> \u7684\u951a\u70b9\uff08dispatch/decode/call/OSR/exception\uff09\u2192 \u4fee\u6539 <code>irtoc/scripts/interpreter.irt</code> \u2192 \u7528 build \u4ea7\u7269\u505a\u4e09\u6bb5\u5f0f\u9a8c\u8bc1\uff08.irt.fixed \u2192 irtoc_code.cpp \u2192 disasm.txt\uff09\u3002</p> <p>\u66f4\u8be6\u7ec6\u7684\u201c\u600e\u4e48\u8bfb/\u600e\u4e48\u6539/\u600e\u4e48\u9a8c\u8bc1\u201d\u89c1\uff1a - IRTOC_DSL_Primer\uff08\u65b0\u4eba\u5de5\u5177\u4e66\uff1a\u6700\u5c0f\u8bed\u6cd5\u96c6 + \u5e38\u89c1\u6539\u52a8\u843d\u70b9\u8868 + \u9a8c\u8bc1\u95ed\u73af\uff09 - \u9010\u884c\u8bc1\u636e\uff1airtoc_scripts_interpreter.irt\u3001irtoc_scripts_common.irt - \u66f4\u7cfb\u7edf\u7684 DSL \u53c2\u8003\uff1aIRTOC_DSL_Reference\uff08\u67e5\u624b\u518c\u5f0f\uff1a\u8bed\u6cd5/\u8bed\u4e49/\u5e38\u89c1\u5751\uff09</p>"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#62-irt","title":"6.2 \u4ece\u73b0\u8c61\u5230 <code>.irt</code>\uff1a\u7b2c\u4e00\u843d\u70b9\u901f\u67e5\u8868\uff08\u65b0\u4eba\u6700\u5b9e\u7528\uff09","text":"\u4f60\u770b\u5230\u7684\u73b0\u8c61 \u5148\u786e\u8ba4 <code>.irt</code> \u7b2c\u4e00\u843d\u70b9\uff08\u5173\u952e\u8bcd\uff09 \u4e0b\u4e00\u8df3 \u6539\u4e86 C++ handler \u6ca1\u751f\u6548 \u662f\u5426\u8dd1\u7684\u662f <code>--interpreter-type=llvm/irtoc</code> <code>Panda.instructions.each</code> / <code>handle_xxx</code> IRTOC_DSL_Primer\uff082/3/4 \u8282\uff09 dispatch/\u5f02\u5e38\u5165\u53e3\u4e0d\u5bf9 dispatch table \u672b\u5c3e\u662f\u5426\u662f exception slot <code>macro(:dispatch)</code> / <code>move_to_exception</code> build_runtime_include_irtoc_interpreter_utils.h OSR \u4e0d\u89e6\u53d1/\u56de\u9000\u5947\u602a \u662f\u5426\u662f\u56de\u8fb9\u89e6\u53d1\u3001\u662f\u5426 fake-return <code>instrument_branches</code> / <code>handle_fake_return</code> irtoc_scripts_interpreter.irt\uff08OSR \u6bb5\uff09 call/return \u884c\u4e3a\u5f02\u5e38 \u662f\u5426\u8d70 I2C \u6216 stackless <code>generic_call</code> / <code>generic_return</code> Bridge_I2C_C2I\uff08Flow\uff09 GC/safepoint \u5d29\u6216\u5076\u73b0\u9519 acc \u662f\u5426\u5728\u8fb9\u754c\u524d\u5199\u56de <code>save_acc</code> / <code>restore_acc</code> / <code>safepoint</code> Frame_VReg_Acc\uff08DataStructure\uff09"},{"location":"04_ExecutionEngine/Flows/IRTOC_FastInterpreter/#63","title":"6.3 \u201c\u9a8c\u8bc1\u4f60\u6539\u52a8\u771f\u7684\u751f\u6548\u201d\u7684\u8bc1\u636e\u94fe\uff08\u5fc5\u987b\u505a\uff09","text":"<p>\u4e0d\u8981\u53ea\u9760\u201c\u8fd0\u884c\u8d77\u6765\u6ca1\u5d29\u201d\u3002\u81f3\u5c11\u505a\u4e00\u6b21\u4e09\u6bb5\u5f0f\u5bf9\u9f50\uff1a</p> <ul> <li>\u811a\u672c\u5c42\uff1a<code>build/irtoc/irtoc_interpreter/interpreter.irt.fixed</code>\uff08\u786e\u8ba4\u4f60\u7684\u6539\u52a8\u786e\u5b9e\u88ab\u89c4\u8303\u5316\u4ea7\u7269\u5438\u6536\uff09</li> <li>IR \u5c42\uff1a<code>build/irtoc/irtoc_interpreter/irtoc_code.cpp</code>\uff08\u786e\u8ba4\u5bf9\u5e94 <code>Loc(..., line)</code> \u7684 IR \u8282\u70b9\u53d1\u751f\u53d8\u5316\uff09</li> <li>\u673a\u5668\u7801\u5c42\uff1a<code>build/irtoc/irtoc_interpreter/disasm.txt</code>\uff08\u786e\u8ba4\u5bf9\u5e94 <code># [inst] id</code> \u7684\u6c47\u7f16\u53d1\u751f\u53d8\u5316\uff09</li> </ul> <p>\u53c2\u8003\u7b14\u8bb0\uff1abuild_irtoc_irtoc_interpreter_disasm.txt</p>"},{"location":"04_ExecutionEngine/Flows/Index/","title":"04_ExecutionEngine / Flows","text":"<p>\u672c\u76ee\u5f55\u7528\u201c\u8c03\u7528\u94fe\u201d\u7ec4\u7ec7\u6267\u884c\u5f15\u64ce\u77e5\u8bc6\uff1a\u5165\u53e3\u662f\u4ec0\u4e48\u3001\u5173\u952e\u5206\u652f\u662f\u4ec0\u4e48\u3001\u51fa\u53e3\u662f\u4ec0\u4e48\u3002 \u6bcf\u6761 flow \u90fd\u914d Mermaid \u56fe\uff0c\u5e76\u6307\u5411\u5bf9\u5e94 FileNotes/Index \u4f5c\u4e3a\u8bc1\u636e\u94fe\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Index/#flow","title":"Flow \u6e05\u5355\uff08\u5efa\u8bae\u987a\u5e8f\uff09","text":"<ol> <li>ExecutionEngine_EndToEnd\uff1a\u7aef\u5230\u7aef\u4e3b\u7ebf\uff08\u65b0\u4eba\u810a\u67f1\u56fe\uff09\uff1a\u89e3\u91ca\u5668\u9009\u578b\u2192\u6267\u884c\u2192\u8c03\u7528/\u6865\u63a5\u2192entrypoints\u2192JIT/OSR\u2192deopt\u2192\u5f02\u5e38/\u6808\u904d\u5386\uff08\u6bcf\u4e2a\u6846\u90fd\u53ef\u4e0b\u6f5c\uff09</li> <li>Interpreter_Execute\uff1a\u89e3\u91ca\u5668\u6267\u884c\u4e3b\u94fe\u8def\uff08PC/Frame/VReg/Acc\uff09</li> <li>Bridge_I2C_C2I\uff1a\u89e3\u91ca\u5668\u2194\u7f16\u8bd1\u4ee3\u7801\u6865\u63a5\uff08I2C/C2I/InvokeInterpreter\uff09</li> <li>Entrypoints_and_RuntimeInterface\uff1acompiled code \u6162\u8def\u5f84\u5165\u53e3\uff08entrypoints\uff09\u4e0e JIT RuntimeInterface</li> <li>Deopt_and_OSR\uff1adeopt/OSR \u7684\u89e6\u53d1\u3001\u5b89\u88c5\u6761\u4ef6\u4e0e\u56de\u9000\u8def\u5f84</li> <li>StackWalking\uff1aStackWalker \u5982\u4f55\u7edf\u4e00\u904d\u5386\u89e3\u91ca\u5668\u5e27/\u7f16\u8bd1\u5e27\uff08\u8c03\u8bd5/\u5f02\u5e38/\u53bb\u4f18\u5316\uff09</li> <li>IRTOC_FastInterpreter\uff1afast interpreter \u7684\u771f\u5b9e\u6267\u884c\u94fe\uff08\u9009\u578b\u2192dispatch table\u2192ExecuteImplFast\uff09+ build \u751f\u6210\u94fe 6.1 IRTOC_DSL_Primer\uff1a\u65b0\u4eba\u5fc5\u8bfb\uff1a<code>.irt</code> DSL \u600e\u4e48\u8bfb/\u600e\u4e48\u6539/\u600e\u4e48\u9a8c\u8bc1\u95ed\u73af\uff08\u4ece\u73b0\u8c61\u2192\u5b9a\u4f4d\u2192\u6539\u52a8\u2192\u4ea7\u7269\u8bc1\u636e\uff09 6.2 IRTOC_DSL_Reference\uff1a<code>.irt</code> DSL \u53c2\u8003\uff08\u66f4\u201c\u6559\u79d1\u4e66\u5f0f\u201d\u7684\u8bed\u6cd5/\u8bed\u4e49\u8bf4\u660e\uff0c\u6309\u7ae0\u8282\u67e5\u9605\uff09</li> <li>Opcode_DeepDives_IRTOC\uff1a\u6311\u9009\u5e38\u7528 opcode \u6df1\u5165\u5206\u6790\uff08ISA\u2192IRTOC handler\u2192runtime/\u5f02\u5e38/OSR\uff09</li> <li>\uff08\u4e0a\u6e38\u5de5\u5177\u94fe\uff09quickener_quick.cpp\u3001bytecode_optimizer_optimize_bytecode.cpp\uff1a\u6267\u884c\u524d quickening/bytecode optimization \u5982\u4f55\u5f71\u54cd\u8fd0\u884c\u671f\u8f93\u5165</li> </ol> <p>\u65b0\u4eba\u8c03\u8bd5\u5165\u53e3\uff08\u4e0d\u5c5e\u4e8e flow\uff0c\u4f46\u5f3a\u70c8\u5efa\u8bae\u6536\u85cf\uff09\uff1aNewbie_MinDebug_Playbook</p>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/","title":"Flow\uff1a\u89e3\u91ca\u5668\u6267\u884c\uff08Execute \u2192 \u4e3b\u5faa\u73af \u2192 \u8fd4\u56de/\u5f02\u5e38\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201c\u89e3\u91ca\u5668\u6267\u884c\uff08\u4e3b\u5faa\u73af\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u5f53\u4f60\u5728\u6392\u969c\u201c\u89e3\u91ca\u5668\u6267\u884c\u5f02\u5e38/\u8bed\u4e49\u4e0d\u5bf9/\u67d0 opcode \u884c\u4e3a\u602a\u5f02\u201d\u65f6\uff0c\u4f60\u9700\u8981\u8fc5\u901f\u56de\u7b54\uff1a - \u89e3\u91ca\u5668\u5165\u53e3\u5728\u54ea\u91cc\uff08\u8c01\u8c03\u7528\u5b83\uff09 - \u4e3b\u5faa\u73af\u7684\u57fa\u672c\u7ed3\u6784\uff08\u53d6\u6307/\u5206\u6d3e/\u66f4\u65b0 PC\uff09 - acc/vreg \u7684\u8bfb\u5199\u70b9\u5728\u54ea\u91cc</p>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#2-mermaid","title":"2) Mermaid\uff1a\u89e3\u91ca\u5668\u6700\u5c0f\u4e3b\u7ebf\uff08\u6982\u5ff5\uff09","text":"<pre><code>flowchart TD\n  A[\"interpreter::Execute(thread, pc, frame)\"] --&gt; B[\"ExecuteImpl(...)\"]\n  B --&gt; C[\"dispatch loop\"]\n  C --&gt; D[\"decode opcode/operands\"]\n  D --&gt; E[\"handler(opcode)\\n\u8bfb\u5199 Frame/VRegs/Acc\"]\n  E --&gt; F[\"update pc / branch\"]\n  F --&gt; C\n  C --&gt; G{\"return/throw/suspend?\"}\n  G --&gt;|yes| R[\"return acc / propagate exception\"]\n  G --&gt;|no| C</code></pre>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#3","title":"3) \u5e38\u89c1\u5206\u652f\u70b9\uff08\u9ad8\u4ef7\u503c\uff09","text":"<ul> <li>invoke \u7c7b\u6307\u4ee4\uff1a\u53ef\u80fd\u8d70 I2C\uff08\u5df2\u7f16\u8bd1\uff09\u6216\u7ee7\u7eed\u89e3\u91ca\u6267\u884c</li> <li>\u5f02\u5e38\u8def\u5f84\uff1a\u53ef\u80fd\u89e6\u53d1\u6808\u904d\u5386\uff08StackWalker\uff09\u6216\u56de\u9000\uff08C2I/deopt\uff09</li> <li>\u56de\u8fb9/\u70ed\u5ea6\uff1a\u53ef\u80fd\u89e6\u53d1 OSR</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#4","title":"4) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/interpreter/interpreter.h/.cpp</code>\uff08Execute \u5165\u53e3\uff09</li> <li><code>runtime/interpreter/interpreter_impl.h/.cpp</code>\uff08ExecuteImpl \u4e0e\u72b6\u6001\u7ba1\u7406\uff09</li> <li><code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\uff08\u4e3b\u5faa\u73af/dispatch table/EXCEPTION_HANDLER \u7684\u751f\u6210\u6a21\u677f\uff09</li> <li><code>runtime/interpreter/interpreter-inl.h</code>\uff08\u5927\u91cf opcode handler\uff1a<code>InstructionHandler::HandleXxx</code>\uff0c\u4ee5\u53ca stackless \u8c03\u7528/\u8fd4\u56de/\u627e catch \u7b49 helper\uff09</li> <li>\u8f85\u52a9\u5e95\u5ea7\uff1a<code>runtime/interpreter/instruction_handler_base.h</code>\u3001<code>runtime/interpreter/instruction_handler_state.h</code></li> <li>\u6570\u636e\u7ed3\u6784\uff1aFrame_VReg_Acc\uff08DataStructure\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Interpreter_Execute/#5","title":"5) \u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u4f60\u5173\u5fc3\u201ccall/\u8fd4\u56de\u600e\u4e48\u8de8\u8fb9\u754c\u201d \u2192 Bridge_I2C_C2I</li> <li>\u4f60\u5173\u5fc3\u201ccompiled code \u600e\u4e48\u8d70\u6162\u8def\u5f84\u201d \u2192 Entrypoints_and_RuntimeInterface</li> <li>\u4f60\u5173\u5fc3\u201cdeopt/OSR \u4e3a\u4ec0\u4e48\u89e6\u53d1\u3001\u600e\u4e48\u56de\u9000/\u8fdb\u5165\u201d \u2192 Deopt_and_OSR</li> <li>\u4f60\u5173\u5fc3\u201c\u5f02\u5e38/\u7f3a\u5e27/\u6808\u56de\u6eaf\u4e3a\u4ec0\u4e48\u4e0d\u4e00\u81f4\u201d \u2192 StackWalking</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/","title":"Opcode Deep Dives\uff08\u9762\u5411\u65b0\u540c\u5b66\uff5c\u4ece ISA \u2192 IRTOC handler \u2192 runtime \u4ea4\u4e92\uff09","text":"<p>\u76ee\u6807\uff1a\u4f60\u4e0d\u9700\u8981\u5148\u8bfb\u5b8c\u6574 <code>interpreter.irt</code>/<code>isa.yaml</code>\uff0c\u4f46\u8bfb\u5b8c\u8fd9\u7bc7\u5e94\u8be5\u80fd\u201c\u770b\u61c2\u5e76\u5b9a\u4f4d\u201d\u6700\u5e38\u89c1\u7684\u6267\u884c\u8def\u5f84\u3002 \u6bcf\u4e2a opcode \u90fd\u6309\u56fa\u5b9a\u6a21\u677f\u5c55\u5f00\uff1aISA \u8bed\u4e49 \u2192 fast interpreter \u5173\u952e\u5b8f \u2192 runtime slowpath/\u5f02\u5e38/OSR\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#0-1","title":"0) \u4f60\u9700\u8981\u5148\u77e5\u9053\u7684\u80cc\u666f\uff081 \u5206\u949f\uff09","text":"<ul> <li>ISA \u662f\u552f\u4e00\u4e8b\u5b9e\u6765\u6e90\uff1acore \u5728 <code>isa/isa.yaml</code>\uff0cETS \u6269\u5c55\u5728 <code>plugins/ets/isa/isa.yaml</code>\u3002</li> <li>IRTOC handler \u81ea\u52a8\u751f\u6210\uff1a<code>irtoc/scripts/interpreter.irt</code> \u91cc <code>Panda.instructions.each</code> \u4e3a\u6bcf\u6761\u6307\u4ee4\u751f\u6210 <code>HANDLE_FAST_*</code>\u3002</li> <li>fast interpreter \u7684\u6267\u884c\u5f62\u6001\u662f tail-call dispatch\uff1a\u6bcf\u4e2a handler \u6700\u7ec8\u4f1a <code>tail_call(next_handler)</code>\uff0c\u673a\u5668\u7801\u91cc\u5c31\u662f <code>jmp %reg</code>\u3002</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#1-calli2c-vs-stackless-interpreter-call","title":"1) <code>call.*</code>\uff1a\u8c03\u7528\u7684\u4e24\u6761\u8def\uff08I2C vs stackless interpreter call\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#11-isa","title":"1.1 ISA \u8bed\u4e49\uff08\u6838\u5fc3\u8981\u70b9\uff09","text":"<p>\u6765\u81ea <code>isa/isa.yaml</code> \u7684 Calling Sequence\uff1a - call \u4f1a\u521b\u5efa\u65b0 frame\uff0c\u590d\u5236\u53c2\u6570 - callee \u7684 acc \u88ab\u8ba4\u4e3a\u662f undefined\uff08verified bytecode \u4e0d\u53ef\u8bfb\uff09 - return \u901a\u8fc7 acc \u628a\u7ed3\u679c\u8fd4\u7ed9 caller</p>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#12-irtoc","title":"1.2 IRTOC \u5b9e\u73b0\u6293\u624b","text":"<p>\u5728 <code>interpreter.irt</code>\uff0c\u8c03\u7528\u6838\u5fc3\u6536\u655b\u5230\uff1a</p> <ul> <li><code>get_callee(...)</code>\uff1a\u89e3\u6790 method +\uff08virt call \u65f6\uff09\u89e3\u6790 receiver + <code>ResolveVirtualMethod</code></li> <li><code>generic_call(...)</code>\uff1a\u4e24\u6761\u8def\u5f84</li> <li>\u5df2\u7f16\u8bd1\uff1a<code>InterpreterToCompiledCodeBridge(pc, frame, callee, tr)</code>\uff08I2C\uff09</li> <li>\u672a\u7f16\u8bd1\uff1a\u521b\u5efa\u65b0 frame\uff0c\u6807\u8bb0 <code>Frame::IS_STACKLESS</code>\uff0c\u628a <code>THREAD_FRAME_OFFSET</code> \u6307\u5230\u65b0 frame</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#121-fast-handler-grep","title":"1.2.1 \u5de5\u7a0b\u951a\u70b9\uff1a\u5bf9\u5e94\u7684 fast handler \u540d\u79f0\uff08\u4f60 grep \u65f6\u7528\u8fd9\u4e2a\uff09","text":"<ul> <li>core\uff08\u9759\u6001 call\uff09\uff1a</li> <li><code>HANDLE_FAST_CALL_SHORT_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_CALL_V4_V4_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_CALL_RANGE_V8_ID16</code></li> <li>\u76f8\u5173\u53d8\u4f53\uff08\u540c\u4e00\u673a\u5236\u4e0d\u540c\u5165\u53e3\uff09\uff1a</li> <li>virt\uff1a<code>HANDLE_FAST_CALL_VIRT_*</code></li> <li>call.acc\uff1a<code>HANDLE_FAST_CALL_ACC_*</code> / <code>HANDLE_FAST_CALL_VIRT_ACC_*</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#13-checklist","title":"1.3 \u65b0\u4eba\u6392\u969c checklist","text":"<ul> <li>\u201ccall \u540e\u76f4\u63a5\u5d29\u6e83\u201d\uff1a</li> <li>\u5148\u786e\u8ba4\u8d70\u7684\u662f I2C \u8fd8\u662f stackless\uff08callee \u662f\u5426 compiled\uff09</li> <li>\u68c0\u67e5 call \u524d\u662f\u5426\u6b63\u786e <code>save_acc</code>\uff08GC/hook/safepoint \u9700\u8981\uff09</li> <li>\u201c\u8fd4\u56de\u503c\u4e0d\u5bf9\u201d\uff1a</li> <li>\u770b <code>restore_acc/restore_acc_tag</code> \u4e0e caller <code>Frame::acc</code> \u7684\u4e00\u81f4\u6027</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#2-return-returnvoidstackless-vs-runtime","title":"2) <code>return.* / return.void</code>\uff1astackless \u5f39\u6808 vs runtime \u8fb9\u754c\u8fd4\u56de","text":""},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#21-irtoc-generic_return","title":"2.1 IRTOC \u7684\u7edf\u4e00\u51fa\u53e3\uff1a<code>generic_return</code>","text":"<ul> <li>\u82e5 <code>Frame::IS_STACKLESS</code>\uff1a</li> <li>\u53d6 <code>prev_frame/next_pc</code></li> <li>\u628a\u8fd4\u56de\u503c copy \u5230 caller \u7684 acc slot</li> <li><code>THREAD_FRAME_OFFSET=prev_frame</code>\uff0cfree \u5f53\u524d frame</li> <li>\u7ee7\u7eed\u6267\u884c caller\uff08pc=next_pc\uff09</li> <li>\u5426\u5219\uff1a</li> <li><code>save_acc()</code> \u540e <code>Intrinsic(:INTERPRETER_RETURN)</code>\uff08\u56de\u5230 runtime \u8fb9\u754c\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#211-fast-handler","title":"2.1.1 \u5de5\u7a0b\u951a\u70b9\uff1a\u5bf9\u5e94\u7684 fast handler \u540d\u79f0","text":"<ul> <li><code>HANDLE_FAST_RETURN</code></li> <li><code>HANDLE_FAST_RETURN_64</code></li> <li><code>HANDLE_FAST_RETURN_OBJ</code></li> <li><code>HANDLE_FAST_RETURN_VOID</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#22","title":"2.2 \u4e3a\u4ec0\u4e48\u8fd9\u5f88\u91cd\u8981","text":"<p>\u8fd9\u51b3\u5b9a\u4e86\uff1a - \u4e3a\u4ec0\u4e48 fast interpreter \u91cc\u201c\u770b\u4e0d\u5230\u4e00\u4e2a\u5927 while loop\u201d\uff1a\u5b83\u9760 tail-call \u8ba9 handler \u4e32\u6210\u4e00\u6761\u6267\u884c\u94fe - \u4e3a\u4ec0\u4e48\u5f88\u591a\u8fd4\u56de\u8def\u5f84\u9700\u8981\u5199\u56de frame\uff1a\u5426\u5219 runtime \u770b\u4e0d\u5230\u6b63\u786e acc</p>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#3-jmp-osr-fake-return","title":"3) <code>jmp.*</code> \u4e0e OSR\uff1a\u56de\u8fb9\u63d2\u6869 + fake-return","text":""},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#31-isa-pc-immbranch_target","title":"3.1 ISA \u8bed\u4e49\uff1a<code>pc += imm</code>\uff08branch_target \u7ea6\u675f\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#32-irtoc-instrument_branches","title":"3.2 IRTOC \u5173\u952e\u673a\u5236\uff1a<code>instrument_branches</code>","text":"<p>\u5f53 <code>imm &lt;= 0</code>\uff08\u56de\u8fb9\uff09\uff1a - \u505a <code>safepoint</code> \u68c0\u67e5 - hotness&lt;=0 \u65f6\u8c03\u7528 <code>CallCompilerSlowPathOSR</code> - OSR \u6210\u529f\u65f6\u89e6\u53d1 <code>handle_fake_return()</code>\uff1a   - \u5f3a\u5236\u4ece\u5f53\u524d stackless frame \u9000\u51fa\u5230 caller\uff0c\u7ed9 OSR \u4e00\u4e2a\u7a33\u5b9a\u5207\u6362\u70b9</p> <p>\u8fd9\u5c31\u662f\u201cOSR \u89e6\u53d1\u70b9\u5728\u56de\u8fb9\u201d\u7684\u73b0\u5b9e\u6765\u6e90\uff1a\u4e0d\u662f\u7f16\u8bd1\u5668\u60f3\u5f53\u7136\uff0c\u800c\u662f\u89e3\u91ca\u5668\u5b9e\u73b0\u91cc\u660e\u786e\u505a\u4e86\u63d2\u6869\u3002</p>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#321-fast-handler","title":"3.2.1 \u5de5\u7a0b\u951a\u70b9\uff1a\u5bf9\u5e94\u7684 fast handler \u540d\u79f0","text":"<ul> <li>\u65e0\u6761\u4ef6\u8df3\u8f6c\uff1a<code>HANDLE_FAST_JMP_IMM8</code> / <code>HANDLE_FAST_JMP_IMM16</code> / <code>HANDLE_FAST_JMP_IMM32</code></li> <li>\u5e38\u89c1\u6761\u4ef6\u8df3\u8f6c\uff08\u793a\u4f8b\uff09\uff1a<code>HANDLE_FAST_JEQZ_IMM8/IMM16</code>\u3001<code>HANDLE_FAST_JNEZ_IMM8/IMM16</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#4-throwstackless-iframes-cframes","title":"4) <code>throw</code>\uff1a\u5f02\u5e38\u4e24\u6bb5\u5f0f\uff08stackless IFrames \u2192 CFrames\uff09","text":""},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#41-irtoc-handler","title":"4.1 IRTOC handler \u7684\u57fa\u672c\u7ed3\u6784","text":"<ul> <li>null check\uff08\u5fc5\u8981\u65f6\u629b NPE\uff09</li> <li><code>ThrowExceptionFromInterpreter(tr, exc, frame, pc)</code></li> <li><code>find_catch_block()</code>\uff1a</li> <li><code>FindCatchBlockInIFrames(tr, frame, pc)</code></li> <li>\u627e\u4e0d\u5230\u5219 <code>Intrinsic(:INTERPRETER_RETURN)</code> \u4ea4\u7ed9 runtime\uff08\u968f\u540e\u53ef\u80fd\u8d70 <code>FindCatchBlockInCallStack</code> \u5e76\u89e6\u53d1 deopt\uff09</li> <li>\u627e\u5230\u5219\u5207\u6362\u5230 EH frame + \u53d6\u56de EH acc + \u7ee7\u7eed\u6267\u884c handler_pc</li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#5-ldobjstobjcore-etsldobjnameetscallnameets","title":"5) <code>ldobj/stobj</code>\uff08core\uff09\u4e0e <code>ets.ldobj.name/ets.call.name</code>\uff08ETS \u6269\u5c55\uff09","text":"<p>\u8fd9\u4e00\u7ec4\u662f\u201c\u6700\u80fd\u4f53\u73b0\u8bed\u8a00\u6269\u5c55 + slowpath + cache\u201d\u7684\u6307\u4ee4\u65cf\uff1a</p> <ul> <li>core <code>ldobj/stobj</code>\uff1afield_id \u89e3\u6790\uff08cache_entry + ResolveFieldById \u7b49\uff09</li> <li>ETS <code>ets.ldobj.name*</code>\uff1aname-based resolution\uff08field/getter\uff09\u5e76\u5728\u5931\u8d25\u65f6\u629b ETS \u4e13\u7528\u5f02\u5e38</li> <li>ETS <code>ets.call.name*</code>\uff1aname-based method lookup + <code>generic_call</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#51-ets-handler-dispatch-table","title":"5.1 \u5de5\u7a0b\u951a\u70b9\uff1aETS handler \u540d\u79f0\uff08dispatch table \u91cc\u80fd\u76f4\u63a5\u770b\u5230\uff09","text":"<ul> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_PREF_V8_ID32</code></li> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_64_PREF_V8_ID32</code></li> <li><code>HANDLE_FAST_ETS_LDOBJ_NAME_OBJ_PREF_V8_ID32</code></li> <li><code>HANDLE_FAST_ETS_CALL_NAME_SHORT_PREF_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_ETS_CALL_NAME_PREF_V4_V4_V4_V4_ID16</code></li> <li><code>HANDLE_FAST_ETS_CALL_NAME_RANGE_PREF_V8_ID16</code></li> </ul> <p>\u5efa\u8bae\u8bfb\u8005\u63a5\u4e0b\u6765\uff1a - \u5bf9\u7167 <code>plugins/ets/isa/isa.yaml</code> \u7684 pseudo code - \u518d\u770b <code>interpreter.irt</code> \u91cc\u7684 <code>handle_ets_ldobj_name_* / handle_ets_call_name_*</code> \u5b8f</p>"},{"location":"04_ExecutionEngine/Flows/Opcode_DeepDives_IRTOC/#_1","title":"\u8bc1\u636e\u94fe\uff08\u672c\u7ae0\uff09","text":"<ul> <li>ISA core\uff1a<code>isa/isa.yaml</code></li> <li>ISA ETS\uff1a<code>plugins/ets/isa/isa.yaml</code></li> <li>IRTOC \u8bed\u4e49\uff1a<code>irtoc/scripts/interpreter.irt</code>\uff08\u89c1\u5bf9\u5e94 FileNotes\uff09</li> <li>dispatch table\uff1a<code>build/runtime/include/irtoc_interpreter_utils.h</code></li> <li>\u673a\u5668\u7801\u8bc1\u636e\uff1a<code>build/irtoc/irtoc_interpreter/disasm.txt</code></li> </ul>"},{"location":"04_ExecutionEngine/Flows/StackWalking/","title":"Flow\uff1aStackWalking\uff08StackWalker \u5982\u4f55\u904d\u5386\u89e3\u91ca\u5668/\u7f16\u8bd1\u5e27\uff09","text":""},{"location":"04_ExecutionEngine/Flows/StackWalking/#0","title":"0) \u5728\u7aef\u5230\u7aef\u4e3b\u7ebf\u56fe\u4e2d\u7684\u4f4d\u7f6e","text":"<ul> <li>\u603b\u5165\u53e3\uff1aExecutionEngine_EndToEnd\uff08\u201c\u5f02\u5e38/\u6808\u904d\u5386\uff08\u8c03\u8bd5/\u5f02\u5e38/\u53bb\u4f18\u5316\u90fd\u4f1a\u7528\uff09\u201d\u6846\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/StackWalking/#1-flow","title":"1) \u8fd9\u6761 flow \u89e3\u51b3\u4ec0\u4e48\u95ee\u9898","text":"<p>\u5f53\u4f60\u770b\u5230\uff1a - \u5d29\u6e83 dump/\u5f02\u5e38\u6808\u7f3a\u5e27 - profiler/\u8c03\u8bd5\u770b\u5230\u7684\u6808\u4e0d\u4e00\u81f4 - deopt/unwind \u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u4e86\u9519\u8bef\u7684 frame</p> <p>\u8fd9\u6761 flow \u7ed9\u4f60\u4e00\u4e2a\u201c\u904d\u5386\u7b56\u7565\u89c6\u56fe\u201d\uff1aStackWalker \u4f9d\u636e\u4ec0\u4e48\u5224\u65ad\u5e27\u7c7b\u578b\u3001\u5982\u4f55\u8de8\u8d8a\u8fb9\u754c\u5e27\u3001\u5982\u4f55\u4ea7\u51fa\u7edf\u4e00\u7684 FrameInfo\u3002</p>"},{"location":"04_ExecutionEngine/Flows/StackWalking/#2-mermaidstackwalker","title":"2) Mermaid\uff1aStackWalker \u7684\u904d\u5386\u4e3b\u7ebf\uff08\u6982\u5ff5\uff09","text":"<pre><code>flowchart TD\n  A[\"StackWalker::Create(thread, mode)\"] --&gt; B{\"\u5f53\u524d frame kind\uff1f\\n(\u89e3\u91ca\u5668/\u7f16\u8bd1/\u8fb9\u754c)\"}\n  B --&gt;|\u89e3\u91ca\u5668\u5e27| C[\"\u8bfb\u53d6 Frame \u94fe\\nmethod/pc/vregs/acc\"]\n  B --&gt;|\u7f16\u8bd1\u5e27| D[\"\u8bfb\u53d6 code info\\n(\u5bc4\u5b58\u5668/\u6808\u69fd\u6620\u5c04)\"]\n  B --&gt;|\u8fb9\u754c\u5e27| E[\"\u6309\u8fb9\u754c\u89c4\u5219\u8df3\u5230\u4e0a\u4e00\u5e27\\n(bridge/deopt \u7ea6\u5b9a)\"]\n  C --&gt; F[\"Yield FrameInfo\"]\n  D --&gt; F\n  E --&gt; B</code></pre>"},{"location":"04_ExecutionEngine/Flows/StackWalking/#3","title":"3) \u6392\u969c\u6293\u624b\uff08\u4f60\u8be5\u770b\u54ea\u91cc\uff09","text":"<ul> <li>FrameKind \u7684\u6765\u6e90\uff1a\u901a\u5e38\u5728 bridge/deopt \u4ea4\u754c\u5904\u5207\u6362\u6216\u6807\u8bb0</li> <li>\u7f3a\u5e27/\u9519\u5e27\uff1a\u4f18\u5148\u68c0\u67e5\u201c\u8fb9\u754c\u5e27\u8bc6\u522b\u201d\u4e0e\u201c\u4e0a\u4e00\u5e27\u8df3\u8f6c\u201d\u903b\u8f91</li> <li>inlined methods\uff1a\u4e00\u4e2a CFrame \u91cc\u53ef\u80fd\u5c55\u5f00\u591a\u4e2a method\uff1b\u5148\u786e\u8ba4\u4f60\u770b\u5230\u7684\u662f\u201c\u903b\u8f91\u5e27\u201d\u8fd8\u662f\u201c\u7269\u7406\u5e27\u201d</li> <li>\u5f02\u5e38\u4e24\u6bb5\u5f0f\uff1astackless IFrames \u2192\uff08\u5fc5\u8981\u65f6\uff09CFrames \u641c\u7d22\u5e76 deopt \u56de\u89e3\u91ca\u5668\uff1b\u7f3a\u5e27\u95ee\u9898\u7ecf\u5e38\u51fa\u73b0\u5728\u4e24\u6bb5\u4ea4\u754c  </li> <li>\u7b2c\u4e00\u6bb5\uff08\u89e3\u91ca\u5668 stackless\uff09\uff1a<code>EXCEPTION_HANDLER</code> \u8c03 <code>handler.FindCatchBlockStackless()</code> <ul> <li>\u8bc1\u636e\uff1a<code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code> \u7684 <code>EXCEPTION_HANDLER</code> \u903b\u8f91</li> </ul> </li> <li>\u7b2c\u4e8c\u6bb5\uff08\u8fdb\u5165\u7f16\u8bd1\u5e27/\u8de8\u8fb9\u754c\uff09\uff1a\u82e5\u7b2c\u4e00\u6bb5\u6ca1\u627e\u5230\uff0c\u5219\u8c03\u7528 <code>FindCatchBlockInCallStack(thread)</code> <ul> <li>\u8bc1\u636e\uff1a<code>runtime/exceptions.cpp::FindCatchBlockInCallStack/FindCatchBlockInCFrames</code> </li> <li>\u547d\u4e2d catch \u540e\u4f1a <code>Deoptimize(stack, method-&gt;GetInstructions() + pcOffset)</code>\uff0c\u76f4\u63a5\u628a\u63a7\u5236\u6d41\u62c9\u56de\u89e3\u91ca\u5668 catch pc</li> </ul> </li> </ul>"},{"location":"04_ExecutionEngine/Flows/StackWalking/#4","title":"4) \u8bc1\u636e\u94fe\uff08\u672c\u7ae0\u5185\uff09","text":"<ul> <li><code>runtime/include/stack_walker.h</code></li> <li><code>runtime/stack_walker.cpp</code></li> <li>\u4ea4\u754c\u9762\uff1a<code>runtime/bridge/bridge.cpp</code>\u3001<code>runtime/deoptimization.*</code></li> <li>\u5f02\u5e38\u8de8\u5e27\uff1a</li> <li><code>runtime/interpreter/templates/interpreter-inl_gen.h.erb</code>\uff08<code>EXCEPTION_HANDLER</code>\uff1astackless catch \u641c\u7d22 + \u8fdb\u5165\u7b2c\u4e8c\u6bb5\uff09</li> <li><code>runtime/exceptions.cpp</code>\uff08<code>FindCatchBlockInCallStack/FindCatchBlockInCFrames</code>\uff1aCFrames \u641c\u7d22 + Deoptimize\uff09</li> </ul>"},{"location":"04_ExecutionEngine/Flows/StackWalking/#5","title":"5) \u4e0b\u4e00\u6b65\uff08\u65b0\u4eba\u63a8\u8350\uff09","text":"<ul> <li>\u4f60\u9047\u5230\u201c\u8fb9\u754c\u5e27/ABI \u5bfc\u81f4\u7f3a\u5e27\u201d \u2192 Bridge_I2C_C2I</li> <li>\u4f60\u9047\u5230\u201cdeopt-after/\u56de\u9000\u89e3\u91ca\u5668\u5bfc\u81f4\u6808\u4e0d\u4e00\u81f4\u201d \u2192 Deopt_and_OSR</li> </ul>"},{"location":"04_ExecutionEngine/Manifests/Index/","title":"04 ExecutionEngine / Manifests / Index","text":"<p>\u672c\u76ee\u5f55\u653e\u7684\u662f \u201c\u672c\u7ae0\u8986\u76d6\u8303\u56f4\u201d\u4e0e\u201c\u843d\u5730\u8bc1\u636e\u6e05\u5355\u201d\uff0c\u7528\u4e8e review/\u6392\u969c/\u9a8c\u6536\u65f6\u5feb\u901f\u5bf9\u7167\uff1a</p>"},{"location":"04_ExecutionEngine/Manifests/Index/#_1","title":"\u6587\u4ef6\u8bf4\u660e","text":"<ul> <li><code>files.yaml</code></li> <li>\u7528\u9014\uff1a\u672c\u7ae0\u201c\u5173\u952e\u6e90\u6587\u4ef6\u6e05\u5355\u201d\uff08\u4eba\u4e3a\u7ef4\u62a4\uff09</li> <li>\u5178\u578b\u7528\u6cd5\uff1a\u5bf9\u7167\u786e\u8ba4\u5173\u952e\u6587\u4ef6\u662f\u5426\u90fd\u88ab\u8bfb\u8fc7/\u5199\u8fc7 FileNotes</li> <li><code>tree_inventory.txt</code></li> <li>\u7528\u9014\uff1a\u76ee\u5f55\u6811\u5feb\u7167\uff08\u65b9\u4fbf\u5feb\u901f\u67e5\u627e\u6587\u4ef6\u540d\uff09</li> </ul>"},{"location":"05_NativeBridge/","title":"05_NativeBridge\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\u3002</p>"},{"location":"05_NativeBridge/#_1","title":"\u672c\u7ae0\u8303\u56f4\uff08\u5f85\u51bb\u7ed3\uff09","text":"<ul> <li>seed_dirs: plugins/ets/runtime/ani, plugins/ets/runtime/interop_js, plugins/ets/runtime</li> <li>seed_files: plugins/ets/runtime/ets_napi_env.h, plugins/ets/runtime/ets_native_library_provider.cpp, plugins/ets/runtime/external_iface_table.h</li> </ul>"},{"location":"05_NativeBridge/#_2","title":"\u5bfc\u822a","text":"<ul> <li><code>Index.md</code>\uff1a\u6587\u4ef6\u6e05\u5355\u4e0e\u9605\u8bfb\u987a\u5e8f</li> <li><code>Manifests/files.yaml</code>\uff1a\u672c\u7ae0\u9010\u884c\u7cbe\u8bfb\u6587\u4ef6\u6e05\u5355\uff08\u52a8\u6001\u6269\u5c55\uff09</li> <li><code>Manifests/tree_inventory.txt</code>\uff1aseed \u626b\u63cf\u5f97\u5230\u7684\u5b8c\u6574\u6587\u4ef6\u6e05\u5355\uff08tree \u7b49\u4ef7\uff09</li> <li><code>FileNotes/</code>\uff1a\u9010\u6587\u4ef6\u9010\u884c\u7b14\u8bb0</li> <li><code>Errata_to_Stage1.md</code>\uff1a\u9636\u6bb5\u4e00\u6821\u6b63\u70b9</li> </ul>"},{"location":"05_NativeBridge/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"05_NativeBridge/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>\uff08\u6682\u65e0\uff09</li> </ul>"},{"location":"05_NativeBridge/Index/","title":"05_NativeBridge - Index","text":""},{"location":"05_NativeBridge/Index/#_1","title":"\u9605\u8bfb\u987a\u5e8f\uff08\u5f85\u8865\uff09","text":""},{"location":"05_NativeBridge/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/","title":"<code>plugins/ets/runtime/ani/ani.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cANI \u5916\u90e8 ABI \u5951\u7ea6\uff08\u805a\u7126\u8fd0\u884c\u65f6\u5b9e\u73b0\u76f8\u5173\u90e8\u5206\uff09\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u6587\u4ef6\u89c4\u6a21\uff1a\u7ea6 8k \u884c\uff08\u5927\u91cf Doxygen \u6587\u6863\uff09 \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 ANI \u7684 \u5bf9\u5916 C ABI\uff1a\u7c7b\u578b\u7cfb\u7edf\u3001\u8fd4\u56de\u7801\u3001options \u7ed3\u6784\u3001\u4ee5\u53ca\u4e24\u5f20\u51fd\u6570\u6307\u9488\u8868\uff1a - <code>__ani_vm_api</code>\uff1aVM \u7ea7 API\uff08CreateVM/GetEnv/Attach/Detach/Destroy\uff09 - <code>__ani_interaction_api</code>\uff1aInteraction API\uff08\u5bf9\u8c61/\u7c7b/\u65b9\u6cd5/\u6570\u7ec4/\u5f15\u7528/\u5f02\u5e38/Any \u7b49\uff09</p> <p>\u8fd0\u884c\u65f6\u5b9e\u73b0\u4f4d\u7f6e\uff1a - VM API \u7684\u5b9e\u73b0\uff1a<code>plugins/ets/runtime/ani/ani_vm_api.cpp</code> - Interaction API \u7684\u5b9e\u73b0\uff1a<code>plugins/ets/runtime/ani/ani_interaction_api.cpp</code> - env \u7684\u5b9e\u4f8b\uff1a<code>plugins/ets/runtime/ets_napi_env.*</code>\uff08\u628a <code>ani_env::c_api</code> \u6307\u5411 interaction \u8868\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#1-l30l34","title":"1. \u7248\u672c\u4e0e\u5e03\u5c14\u5e38\u91cf\uff08L30\u2013L34\uff09","text":"<ul> <li>L30\uff1a<code>ANI_VERSION_1</code></li> <li>L32\u2013L33\uff1a<code>ANI_FALSE/ANI_TRUE</code></li> </ul> <p><code>ani_interaction_api.cpp::IsVersionSupported</code> \u76ee\u524d\u4e5f\u53ea\u63a5\u53d7 <code>ANI_VERSION_1</code>\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#2-logger-abil35l46","title":"2. Logger \u56de\u8c03 ABI\uff08L35\u2013L46\uff09","text":"<p>\u6ce8\u91ca\u7ed9\u51fa\u7ea6\u5b9a\uff1a</p> <ul> <li><code>ani_logger</code> \u7b7e\u540d\uff1a<code>(FILE *stream, int log_level, const char *component, const char *message)</code></li> <li>\u901a\u8fc7 <code>ani_option</code>\uff1a<code>option=\"--logger\"</code>\uff0c<code>extra=ani_logger</code> \u4f20\u5165</li> <li>log level \u5e38\u91cf\uff1a<code>ANI_LOGLEVEL_*</code></li> </ul> <p>\u5bf9\u5e94\u5b9e\u73b0\uff1a - <code>ANIOptions</code> \u4f1a\u5f3a\u5236 <code>--logger</code> \u7684 <code>extra</code> \u975e\u7a7a\uff08\u89c1 <code>ani_options.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#3-l47l171","title":"3. \u57fa\u7840\u7c7b\u578b\u4e0e\u5f15\u7528\u7c7b\u578b\u6a21\u578b\uff08L47\u2013L171\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#31-l47l58","title":"3.1 \u57fa\u7840\u7c7b\u578b\uff08L47\u2013L58\uff09","text":"<ul> <li><code>ani_size</code>\uff08size_t\uff09</li> <li>8/16/32/64 \u4f4d\u6574\u6570\u4e0e float/double</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#32-l59l135","title":"3.2 \u5f15\u7528\u7c7b\u578b\uff08L59\u2013L135\uff09","text":"<p>\u8be5\u5934\u4e3a\u4e86\u540c\u65f6\u652f\u6301 C \u4e0e C++\uff0c\u91c7\u53d6\u4e24\u5957\u8868\u793a\uff1a</p> <ul> <li>C++ \u6a21\u5f0f\uff08L60\u2013L108\uff09\uff1a</li> <li>\u7528\u4e00\u7cfb\u5217\u7a7a\u7c7b <code>__ani_object/__ani_string/__ani_class/...</code> \u8868\u8fbe\u5f15\u7528\u7c7b\u578b\u5c42\u7ea7</li> <li>\u518d typedef \u6210\u6307\u9488\uff08\u4f8b\u5982 <code>typedef __ani_object* ani_object</code>\uff09</li> <li>\u597d\u5904\uff1aC++ \u7f16\u8bd1\u671f\u80fd\u533a\u5206 <code>ani_class</code> vs <code>ani_object</code>\uff0c\u51cf\u5c11\u8bef\u7528</li> <li>C \u6a21\u5f0f\uff08L109\u2013L134\uff09\uff1a</li> <li>\u7edf\u4e00\u4e3a <code>struct __ani_ref*</code> \u7684\u4e0d\u900f\u660e\u6307\u9488\uff0c\u5e76\u7528 typedef \u201c\u522b\u540d\u5316\u201d\uff08<code>ani_class</code> \u5176\u5b9e\u8fd8\u662f <code>ani_ref</code>\uff09</li> <li>\u597d\u5904\uff1a\u7eaf C \u8c03\u7528\u65b9\u4e0d\u9700\u8981\u7ee7\u627f\u5c42\u7ea7</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#33-ani_value-unionl161l171","title":"3.3 <code>ani_value</code> union\uff08L161\u2013L171\uff09","text":"<ul> <li>\u7528 union \u627f\u8f7d\u6240\u6709 primitive/ref \u503c\u3002 <code>ani_interaction_api.cpp</code> \u4f1a\u6839\u636e\u65b9\u6cd5 shorty \u628a varargs/<code>ani_value[]</code> \u8f6c\u6362\u6210 runtime <code>Value</code>\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#4-ani_native_functionnative-bind-l173l178","title":"4. <code>ani_native_function</code>\uff1anative bind \u7684\u6700\u5c0f\u63cf\u8ff0\uff08L173\u2013L178\uff09","text":"<ul> <li>(name, signature, pointer) \u4e09\u5143\u7ec4\uff0c\u7528\u4e8e\uff1a</li> <li><code>Namespace_BindNativeFunctions</code></li> <li><code>Module_BindNativeFunctions</code></li> <li><code>Class_BindNativeMethods</code></li> </ul> <p>\u8fd9\u4e9b\u5165\u53e3\u5728 <code>ani_interaction_api.cpp</code> \u4e2d\u5b9e\u73b0\uff0c\u5e76\u6700\u7ec8\u6c47\u603b\u8fdb <code>INTERACTION_API</code> \u8868\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#5-ani_vmani_env-l179l185","title":"5. <code>ani_vm</code>/<code>ani_env</code> \u7684\u201c\u4e8c\u91cd\u8bed\u4e49\u201d\uff08L179\u2013L185\uff09","text":"<p>\u8fd9\u91cc\u975e\u5e38\u5173\u952e\uff1a\u540c\u4e00\u4e2a\u6982\u5ff5\u5728 C \u4e0e C++ \u4e0b typedef \u4e0d\u540c\u3002</p> <ul> <li>C++\uff08L179\u2013L181\uff09\uff1a<code>ani_vm</code>/<code>ani_env</code> \u662f\u4e0d\u900f\u660e struct\uff08\u7531 runtime \u5185\u90e8\u5b9e\u73b0\u4e3a\u201c\u5e26 c_api \u6210\u5458\u7684\u5bf9\u8c61\u201d\uff09\u3002</li> <li>C\uff08L183\u2013L185\uff09\uff1a<code>ani_vm</code>/<code>ani_env</code> \u76f4\u63a5 typedef \u4e3a \u201c\u6307\u5411\u51fd\u6570\u6307\u9488\u8868\u7684\u6307\u9488\u201d\u3002   \u8fd9\u610f\u5473\u7740\u7eaf C \u8c03\u7528\u65b9\u53ef\u80fd\u628a <code>ani_vm</code> \u5f53\u4f5c <code>vm_api_table*</code> \u6765\u7528\uff0c\u800c runtime \u5185\u90e8\u4ecd\u53ef\u7528 C++ \u5bf9\u8c61\u8868\u8fbe env/vm \u5e76\u628a\u5176 <code>c_api</code> \u6307\u5411\u8868\u3002</li> </ul> <p>\u8fd9\u4e5f\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 <code>PandaEtsNapiEnv</code> \u7ee7\u627f\u81ea <code>ani_env</code>\uff1aC++ \u4fa7\u8981\u6709\u4e00\u4e2a\u201c\u6301\u6709\u72b6\u6001 + c_api\u201d\u7684\u5bf9\u8c61\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#6-ani_statusl187l203","title":"6. <code>ani_status</code>\uff1a\u7edf\u4e00\u9519\u8bef\u7801\uff08L187\u2013L203\uff09","text":"<p>\u5178\u578b\u91cd\u8981\u9879\uff1a</p> <ul> <li><code>ANI_OK</code></li> <li><code>ANI_INVALID_ARGS</code></li> <li><code>ANI_PENDING_ERROR</code>\uff1a\u8868\u793a\u5df2\u6709 pending exception\uff08<code>CHECK_ENV</code> \u5b8f\u4f1a\u76f4\u63a5\u8fd4\u56de\u5b83\uff09</li> <li><code>ANI_NOT_FOUND</code> / <code>ANI_AMBIGUOUS</code></li> <li><code>ANI_INVALID_VERSION</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#7-ani_optionscreatevmattach-options-abil205l213","title":"7. <code>ani_options</code>\uff1aCreateVM/Attach \u7684 options ABI\uff08L205\u2013L213\uff09","text":"<ul> <li><code>ani_option { const char* option; void* extra; }</code></li> <li><code>ani_options { size_t nr_options; const ani_option* options; }</code></li> </ul> <p>runtime \u89e3\u6790\u5165\u53e3\uff1a - <code>ani_vm_api.cpp::ANI_CreateVM</code>\uff1a<code>OptionsParser::Parse(options)</code> - <code>ani_vm_api.cpp::AttachCurrentThread</code>\uff1a\u76f4\u63a5\u626b\u63cf <code>--interop=enable/disable</code>\uff08\u8fd9\u662f attach \u4e13\u7528\u9009\u9879\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#8-__ani_vm_apivm-l215l225","title":"8. <code>__ani_vm_api</code>\uff1aVM \u7ea7\u51fd\u6570\u6307\u9488\u8868\uff08L215\u2013L225\uff09","text":"<p>\u6210\u5458\uff1a - <code>DestroyVM/GetEnv/AttachCurrentThread/DetachCurrentThread</code></p> <p>\u771f\u5b9e\u5b9e\u73b0\uff1a - <code>ani_vm_api.cpp</code> \u672b\u5c3e\u5b9a\u4e49 <code>static const __ani_vm_api VM_API = {...}</code> \u5e76\u7531 <code>GetVMAPI()</code> \u8fd4\u56de\u5730\u5740\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#9-createvmgetcreatedvmsani_constructorl227l239","title":"9. \u5bfc\u51fa\u7b26\u53f7\uff1aCreateVM/GetCreatedVMs/ANI_Constructor\uff08L227\u2013L239\uff09","text":"<ul> <li><code>ANI_CreateVM</code> / <code>ANI_GetCreatedVMs</code>\uff1a\u7531 runtime \u5bfc\u51fa\uff08\u5b9e\u73b0\u89c1 <code>ani_vm_api.cpp</code>\uff09</li> <li><code>ANI_Constructor</code> / <code>ANI_Destructor</code>\uff1a\u4f9b \u201cnative library so\u201d \u5bfc\u51fa\uff0c\u7c7b\u4f3c JNI_OnLoad/JNI_OnUnload   ETS runtime \u7684 <code>NativeLibraryProvider</code> \u4f1a\u5f3a\u5236\u67e5\u627e\u5e76\u8c03\u7528 <code>ANI_Constructor</code>\uff08\u89c1 <code>ets_native_library_provider.cpp::CallAniCtor</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani.h/#10-__ani_interaction_apil244","title":"10. <code>__ani_interaction_api</code>\uff1a\u8d85\u5927\u51fd\u6570\u8868\uff08L244 \u8d77\uff09","text":"<p>\u8fd9\u4e00\u6bb5\u5305\u542b\u5927\u91cf Doxygen \u6ce8\u91ca\u4e0e\u51fd\u6570\u6307\u9488\u5b57\u6bb5\uff0c\u662f ANI \u7684\u6838\u5fc3 ABI \u9762\u3002 \u6ce8\u610f\uff1a - ABI \u7684\u5b57\u6bb5\u987a\u5e8f\u662f\u534f\u8bae\uff1a<code>ani_interaction_api.cpp</code> \u5fc5\u987b\u6309\u540c\u6837\u987a\u5e8f\u521d\u59cb\u5316 <code>INTERACTION_API = { ... }</code>\u3002 - runtime \u5185\u90e8\u6700\u7ec8\u901a\u8fc7 <code>PandaEtsNapiEnv::c_api</code> \u95f4\u63a5\u8c03\u7528\u8fd9\u4e9b\u51fd\u6570\u3002</p> <p>\u5efa\u8bae\u9605\u8bfb\u7b56\u7565\uff1a - \u5148\u8bfb <code>ani_interaction_api.cpp</code> \u7684\u201c\u9aa8\u67b6\u51fd\u6570\u201d\uff08<code>DoGeneralMethodCall/GetArgValues/DoFind/AllocObject</code>\uff09\u4e0e\u672b\u5c3e <code>INTERACTION_API</code> \u521d\u59cb\u5316\uff0c\u518d\u5bf9\u7167\u672c\u5934\u67e5\u5b57\u6bb5\u542b\u4e49\u5373\u53ef\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/","title":"<code>plugins/ets/runtime/ani/ani_helpers.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5centrypoint/\u53c2\u6570\u91cd\u6392/GC \u5b89\u5168/async\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u6587\u4ef6\u89c4\u6a21\uff1a487 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 ANI/NAPI \u8c03\u7528\u6865\u7684\u201c\u5173\u952e\u7c98\u5408\u5c42\u201d\uff1a</p> <ul> <li>\u63d0\u4f9b <code>GetANIEntryPoint/GetANICriticalEntryPoint</code>\uff1a\u8fd4\u56de\u6c47\u7f16\u5165\u53e3\uff08<code>EtsNapiEntryPoint/EtsNapiCriticalNativeEntryPoint</code>\uff09</li> <li>\u8ba1\u7b97\u4e0e\u51c6\u5907 native \u8c03\u7528\u53c2\u6570\uff08<code>EtsNapiCalcStackArgsSpaceSize</code>\u3001<code>PrepareArgsOnStack</code>\uff09</li> <li>\u5728\u8fdb\u5165 native \u4ee3\u7801\u524d/\u540e\u505a\u72b6\u6001\u5207\u6362\u4e0e\u5f15\u7528\u5e27\u7ba1\u7406\uff08<code>EtsNapiBegin/EtsNapiEnd/EtsNapiObjEnd</code>\uff09</li> <li>\u5b9e\u73b0 <code>EtsAsyncCall</code>\uff1a\u628a async \u8c03\u7528\u5c01\u88c5\u6210 <code>EtsPromise</code> \u5e76\u901a\u8fc7 <code>CoroutineManager</code> \u53d1\u5c04</li> </ul> <p>\u8fd9\u90e8\u5206\u76f4\u63a5\u5173\u7cfb\u5230\uff1a - StackWalker \u80fd\u5426\u6b63\u786e\u904d\u5386 \u201cNAPI frame \u7684\u53c2\u6570\u533a\u201d - GC root\uff08ObjectHeader*\uff09\u5728 native \u8c03\u7528\u671f\u95f4\u662f\u5426\u53ef\u8fbe - local references \u751f\u547d\u5468\u671f\uff08Push/Pop local frame\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#0-argwriter-objectheader-etsreferencel47l79","title":"0. <code>ArgWriter</code>\uff1a\u628a ObjectHeader \u6307\u9488\u53d8\u6210 <code>EtsReference*</code>\uff08L47\u2013L79\uff09","text":"<ul> <li><code>ArgWriter</code> \u7ee7\u627f <code>arch::ArgWriter&lt;RUNTIME_ARCH&gt;</code>\uff0c\u7528\u4e8e\u628a\u53c2\u6570\u5199\u5230 out regs/stack\u3002</li> <li>\u7279\u5316 <code>Write&lt;ObjectHeader**&gt;</code>\uff08L55\u2013L67\uff09\uff1a</li> <li>\u8f93\u5165\u662f <code>EtsObject**</code>\uff08\u5b9e\u53c2\u5730\u5740\uff09\uff0c\u8f6c\u6210 <code>EtsReference*</code>\uff1a<ul> <li>undefined object \u2192 <code>EtsReference::GetUndefined()</code></li> <li>\u5426\u5219 <code>EtsReferenceStorage::NewEtsStackRef(objPtr)</code>\uff08\u628a\u201c\u6808\u4e0a\u5bf9\u8c61\u6307\u9488\u5730\u5740\u201d\u5305\u88c5\u6210 stack ref\uff09</li> </ul> </li> <li>\u6700\u7ec8\u5199\u5165\u7684\u662f <code>EtsReference*</code>\uff0c\u800c\u4e0d\u662f\u88f8 <code>ObjectHeader*</code>\u3002</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u540e\u7eed <code>PrepareArgsOnStack</code> \u4f1a\u628a class/this \u6307\u9488\u201c\u653e\u5230\u67d0\u4e2a\u7a33\u5b9a\u7684\u6808\u69fd\u91cc\u201d\uff0c\u5e76\u521b\u5efa stack ref\uff1a\u8fd9\u662f\u4e3a\u4e86 GC/stack walker \u4e00\u81f4\u6027\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#1-entrypoint-l82l95","title":"1. entrypoint \u7b26\u53f7\u5bfc\u51fa\uff08L82\u2013L95\uff09","text":"<ul> <li><code>extern \"C\" void EtsNapiEntryPoint();</code> \u4e0e <code>EtsNapiCriticalNativeEntryPoint();</code> \u6765\u81ea\u67b6\u6784\u76f8\u5173\u6c47\u7f16\u6587\u4ef6\u3002</li> <li><code>GetANIEntryPoint/GetANICriticalEntryPoint</code> \u53ea\u662f\u628a\u8fd9\u4e24\u4e2a\u7b26\u53f7\u5730\u5740\u8f6c\u6210 <code>const void*</code> \u8fd4\u56de\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#2-etsnapicalcstackargsspacesize-shorty-stack-l96l147","title":"2. <code>EtsNapiCalcStackArgsSpaceSize</code>\uff1a\u6309 shorty \u8ba1\u7b97 stack \u53c2\u6570\u7a7a\u95f4\uff08L96\u2013L147\uff09","text":"<ul> <li>\u4f7f\u7528 <code>arch::ArgCounter</code>\uff1a</li> <li>\u975e critical\uff1a\u989d\u5916\u8ba1\u5165 <code>ani_env*</code> \u4e0e <code>ObjectHeader*</code>\uff08class \u6216 this\uff09\u4e24\u4e2a\u524d\u7f6e\u53c2\u6570\uff08L101\u2013L104\uff09</li> <li>\u7136\u540e\u904d\u5386 method shorty\uff0c\u6309\u7c7b\u578b\u8ba1\u6570\uff08U1/U16/I32/I64/F32/F64/REF...\uff09</li> <li>\u8fd4\u56de <code>counter.GetStackSpaceSize()</code>\uff0c\u4f9b entrypoint \u5206\u914d outStackArgs \u7a7a\u95f4\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#3-prepareargsonstack-abi-ani-abil255l314","title":"3. <code>PrepareArgsOnStack</code>\uff1a\u628a\u8f93\u5165 ABI \u91cd\u6392\u4e3a ANI ABI\uff08L255\u2013L314\uff09","text":"<p>\u8f93\u5165\uff1a - <code>inRegsArgs</code>\uff1acallee \u7684\u5bc4\u5b58\u5668\u53c2\u6570\u533a\uff08\u5305\u542b Method*\u3001this/class \u7b49\uff09 - <code>inStackArgs</code>\uff1acallee \u7684\u6808\u53c2\u6570\u533a</p> <p>\u8f93\u51fa\uff1a - <code>outStackArgs</code>\uff08\u4ee5\u53ca\u6839\u636e\u5176\u63a8\u5bfc\u51fa\u7684 <code>outRegsArgs</code>\uff09\uff1a   - \u5148\u5199 <code>ani_env*</code>   - \u518d\u5199 \u201cclass \u6216 this\u201d\uff08\u4ee5 <code>EtsReference*</code> \u8868\u8fbe\uff09   - \u518d\u62f7\u8d1d\u539f method args\uff08\u901a\u8fc7 <code>ARCH_COPY_METHOD_ARGS</code>\uff09</p> <p>\u5173\u952e\u7ec6\u8282\uff1a</p> <ul> <li>L259\uff1a<code>outRegsArgs = inRegsArgs - FP_BYTES - GP_BYTES</code>\uff1a\u8f93\u51fa regs \u533a\u4f4d\u4e8e\u8f93\u5165 regs \u533a\u4e4b\u524d\uff08\u6808\u5e03\u5c40\u7ea6\u5b9a\uff09\u3002</li> <li>L275\u2013L304\uff1a\u5904\u7406 class/this\uff1a</li> <li>static\uff1a<ul> <li>\u82e5 <code>etsMethod-&gt;IsFunction()</code>\uff1a\u628a <code>Method*</code> \u6240\u5728\u69fd\u66ff\u6362\u4e3a <code>nullptr</code>\uff08L280\u2013L284\uff09\uff0c\u907f\u514d GC \u904d\u5386\u53c2\u6570\u65f6\u8bef\u628a method \u6307\u9488\u5f53\u5bf9\u8c61\u6307\u9488\u5bfc\u81f4\u5d29\u6e83\u3002</li> <li>\u5426\u5219\u628a <code>Method*</code> \u69fd\u66ff\u6362\u4e3a class object \u6307\u9488\uff08L286\u2013L294\uff09\uff0c\u5e76\u521b\u5efa stack ref\u3002</li> </ul> </li> <li>instance\uff1a<ul> <li>\u4ece <code>argReader</code> \u8bfb this \u6307\u9488\u5730\u5740\uff0c\u5e76\u521b\u5efa stack ref\uff08L300\u2013L303\uff09</li> </ul> </li> <li>L306\u2013L310\uff1a\u5199\u5165 <code>ani_env*</code> \u4e0e class/this ref\uff0c\u7136\u540e <code>ARCH_COPY_METHOD_ARGS</code>\u3002</li> </ul> <p>\u8fd9\u6bb5\u6ce8\u91ca/\u903b\u8f91\u975e\u5e38\u9ad8\u5bc6\u5ea6\uff1a\u672c\u8d28\u662f\u5728\u6784\u9020\u4e00\u4e2a \u201cStackWalker/GC \u53ef\u7406\u89e3\u7684\u3001\u7edf\u4e00\u7684 NAPI/ANI \u5e27\u53c2\u6570\u5e03\u5c40\u201d\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#4-etsnapibegin-native-local-ref-frame-nativecodebeginl316l350","title":"4. <code>EtsNapiBegin</code>\uff1a\u8fdb\u5165 native \u524d\u7684\u201c\u6b63\u786e\u6808 + local ref frame + NativeCodeBegin\u201d\uff08L316\u2013L350\uff09","text":"<ul> <li>\u5148\u8c03\u7528 <code>PrepareArgsOnStack</code> \u5f97\u5230 <code>outRegsArgs</code>\uff08L325\u2013L326\uff09\u3002</li> <li>L327\u2013L331\uff08\u5173\u952e\u6ce8\u91ca\uff09\uff1a\u5f3a\u8c03\u5fc5\u987b\u5148\u5b8c\u6210\u53c2\u6570\u91cd\u6392\uff0c\u4e4b\u540e\u624d\u80fd\u5b89\u5168 walk stack\uff08\u4f8b\u5982 safepoint/GC\uff09\u3002</li> <li>\u82e5 <code>method-&gt;GetNativePointer()==nullptr</code>\uff1a\u629b unresolved method \u5f02\u5e38\uff08L332\u2013L334\uff09\u3002</li> <li><code>MethodEntryEvent</code>\uff08L336\uff09\u3002</li> <li>Push local ref frame\uff1a</li> <li><code>MAX_LOCAL_REF = 4096</code></li> <li><code>pandaEnv-&gt;GetEtsReferenceStorage()-&gt;PushLocalEtsFrame(MAX_LOCAL_REF)</code>\uff08L339\u2013L342\uff09</li> <li>\u82e5\u4e0d\u662f fast native\uff1a<code>thread-&gt;NativeCodeBegin()</code>\uff08L344\u2013L347\uff09</li> <li>\u8fd4\u56de <code>outRegsArgs</code>\uff1a\u4f9b\u6c47\u7f16\u5165\u53e3\u7ee7\u7eed\u8c03\u7528 native\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#5-etsnapiendetsnapiobjend-nativel358l398","title":"5. <code>EtsNapiEnd/EtsNapiObjEnd</code>\uff1a\u9000\u51fa native\uff08L358\u2013L398\uff09","text":"<p>\u5171\u540c\u70b9\uff1a</p> <ul> <li>\u975e fast native\uff1a<code>NativeCodeEnd()</code>\uff08L364\u2013L366 / L381\u2013L384\uff09</li> <li><code>MethodExitEvent</code>\uff08L368 / L386\uff09</li> <li>Pop local ref frame\uff1a<code>PopLocalEtsFrame(EtsReference::GetUndefined())</code>\uff08L371\u2013L373 / L395\uff09</li> </ul> <p>\u5dee\u5f02\uff1a</p> <ul> <li><code>EtsNapiEnd</code>\uff1a\u4ec5\u505a\u72b6\u6001\u4e0e frame \u6e05\u7406\u3002</li> <li><code>EtsNapiObjEnd</code>\uff1a\u8fd8\u8981\u628a\u8fd4\u56de\u7684 <code>EtsReference*</code> \u89e3\u5f15\u7528\u4e3a <code>EtsObject*</code>\uff08\u4ec5\u5728\u65e0 pending exception \u65f6\uff09\uff08L390\u2013L393\uff09\uff0c\u518d\u8fd4\u56de\u5bf9\u8c61\u6307\u9488\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.cpp/#6-etsasynccallasync-promise-launchimmediatelyl415l481","title":"6. <code>EtsAsyncCall</code>\uff1aasync \u2192 Promise + LaunchImmediately\uff08L415\u2013L481\uff09","text":"<p>\u9ad8\u5c42\u8bed\u4e49\uff1a</p> <ul> <li>\u89e3\u6790 async impl method\uff1a<code>vm-&gt;GetClassLinker()-&gt;GetAsyncImplMethod(method, currentCoro)</code>\uff08L420\u2013L425\uff09</li> <li>\u82e5 coroutine switch \u88ab\u7981\u7528\uff1a\u629b INVALID_COROUTINE_OPERATION_ERROR\uff08L427\u2013L431\uff09</li> <li>\u505a\u4e00\u6b21\u201carg fix\u201d\u4ee5\u6ee1\u8db3 StackWalker\uff08static \u65f6\u628a Method* \u69fd\u66ff\u6362\u4e3a class object \u6307\u9488\uff0cL439\u2013L446\uff09</li> <li>\u521b\u5efa <code>EtsPromise</code>\uff08L451\u2013L455\uff09\uff0c\u5e76\u628a promise \u653e\u5165 global storage\uff08L456\uff09</li> <li>\u8bfb\u51fa\u6240\u6709\u53c2\u6570\u5230 <code>PandaVector&lt;Value&gt; args</code>\uff08L459\u2013L467\uff09\uff0c\u907f\u514d\u540e\u7eed GC \u7834\u574f\u5165\u53c2</li> <li><code>LaunchImmediately(evt, impl, args, workerId, ASYNC_CALL, false)</code>\uff08L470\u2013L474\uff09</li> <li>\u6210\u529f\u5219\u8fd4\u56de promise \u7684\u5bf9\u8c61\u6307\u9488\uff08<code>ToObjPtr(promiseHandle.GetPtr())</code>\uff09</li> </ul> <p>\u8fd9\u6bb5\u628a \u201cnative \u8c03\u7528\u89e6\u53d1 async\u201d \u4e0e \u201c\u534f\u7a0b\u8c03\u5ea6/\u4e8b\u4ef6\u5b8c\u6210\u201d \u6253\u901a\uff0c\u662f NativeBridge \u7ae0\u8282\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.h/","title":"<code>plugins/ets/runtime/ani/ani_helpers.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e ANI/NAPI \u4fa7\u7684\u201c\u5165\u53e3\u70b9\u201d\u7b26\u53f7\u83b7\u53d6\u51fd\u6570\uff1a - <code>GetANIEntryPoint()</code> - <code>GetANICriticalEntryPoint()</code></p> <p>\u5b83\u4eec\u901a\u5e38\u4f9b\u7f16\u8bd1\u5668/\u8fd0\u884c\u65f6\u5728\u751f\u6210 native \u8c03\u7528\u6865\u65f6\u67e5\u8be2\uff08\u5bf9\u5e94\u6c47\u7f16 entrypoint\uff1a<code>ets_napi_entry_point_*.S</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_helpers.h/#1-l19l22","title":"1. \u4e24\u4e2a\u5165\u53e3\u70b9\uff08L19\u2013L22\uff09","text":"<ul> <li>L20\uff1a<code>GetANIEntryPoint()</code>\uff1a\u666e\u901a NAPI entrypoint\uff08\u4f1a\u505a local ref frame\u3001NativeCodeBegin/End \u7b49\u7ba1\u7406\uff0c\u89c1 <code>.cpp</code> \u7684 <code>EtsNapiBegin/EtsNapiEnd</code>\uff09\u3002</li> <li>L21\uff1a<code>GetANICriticalEntryPoint()</code>\uff1acritical native entrypoint\uff08\u51cf\u5c11\u5f00\u9500/\u9650\u5236\u66f4\u591a\uff0c\u89c1 <code>.cpp</code> \u7684 <code>EtsNapiBeginCritical</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/","title":"<code>plugins/ets/runtime/ani/ani_interaction_api.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cinteraction API \u5b9e\u73b0\u4e2d\u5fc3\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u6587\u4ef6\u89c4\u6a21\uff1a6719 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 ANI \u7684 <code>__ani_interaction_api</code> \u51fd\u6570\u6307\u9488\u8868\uff08<code>INTERACTION_API</code>\uff09\uff0c\u8986\u76d6\uff1a - method/function \u8c03\u7528\uff08\u542b varargs \u4e0e <code>ani_value[]</code> \u4e24\u79cd\u5165\u53c2\uff09 - class/module/namespace \u67e5\u627e\u4e0e\u89e3\u6790 - object/field/array/tuple/any \u7b49\u57fa\u7840\u64cd\u4f5c - native bind\uff08\u628a C \u51fd\u6570\u7ed1\u5b9a\u5230 ETS \u65b9\u6cd5/\u51fd\u6570\uff09 - error/pending exception \u5904\u7406\u4e0e scope/reference \u7ba1\u7406</p> <p>\u7ed3\u6784\u4e0a\uff0c\u5b83\u628a\u5927\u91cf API \u805a\u5408\u5230\u4e00\u4e2a\u9759\u6001\u8868\uff1a - <code>const __ani_interaction_api INTERACTION_API = { ... }</code>\uff08L6305 \u5de6\u53f3\uff09 - <code>GetInteractionAPI()</code> \u8fd4\u56de <code>&amp;INTERACTION_API</code>\uff08L6709\u2013L6712\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#0-class-linkerhandle-scopestubscoroutine-scopesl23l45","title":"0. \u9876\u5c42\u4f9d\u8d56\uff1a\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4f1a\u5305\u542b class linker\u3001handle scope\u3001stubs\u3001coroutine scopes\uff08L23\u2013L45\uff09","text":"<ul> <li>L33\uff1a<code>ets_class_linker_extension.h</code>\uff1aFindClass/InitializeClass \u9700\u8981\u7c7b\u52a0\u8f7d\u5668\u6269\u5c55\u80fd\u529b\uff08\u8bed\u8a00\u76f8\u5173\uff09\u3002</li> <li>L34\uff1a<code>ets_handle_scope.h</code>\uff1alocal ref / handle scope \u4e0e GC root \u7ba1\u7406\u3002</li> <li>L36\u2013L37\uff1a<code>ets_stubs(.inl)</code>\uff1a\u67d0\u4e9b Any/Interop \u76f8\u5173\u8c03\u7528\u53ef\u80fd\u8d70 stubs\uff08\u9ad8\u6027\u80fd\u6865/\u5185\u5efa\uff09\u3002</li> <li>L44\uff1a<code>runtime/coroutines/coroutine_scopes.h</code>\uff1a<code>ScopedCoroutineNativeCall</code> \u5728 method \u8c03\u7528\u65f6\u6807\u8bb0\u201cnative call \u533a\u95f4\u201d\uff0c\u7528\u4e8e GC/safepoint/\u8c03\u5ea6\u7ea6\u675f\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aANI interaction API \u5e76\u4e0d\u662f\u7b80\u5355\u7684 \u201c\u53c2\u6570\u89e3\u5305 + \u8c03\u7528\u65b9\u6cd5\u201d\uff0c\u5b83\u5fc5\u987b\u4e25\u8c28\u5904\u7406\uff1a - \u7ebf\u7a0b/coroutine \u72b6\u6001\u5207\u6362\uff08native \u2194 managed\uff09 - handle scope / local ref \u751f\u547d\u5468\u671f - \u7c7b\u521d\u59cb\u5316\u4e0e\u5f02\u5e38\u4f20\u64ad</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#1-check_env-pending-exceptionl49l63","title":"1. \u73af\u5883\u6821\u9a8c\u5b8f\uff1a<code>CHECK_ENV</code> \u7684\u8bed\u4e49\u662f\u201c\u5148\u62d2\u7edd pending exception\u201d\uff08L49\u2013L63\uff09","text":"<ul> <li><code>CHECK_ENV_THAT_CAN_HAVE_PENDING_ERROR(env)</code>\uff1a\u53ea\u505a env!=nullptr \u68c0\u67e5\u3002</li> <li><code>CHECK_ENV(env)</code>\uff1a\u9664 env \u975e\u7a7a\u5916\uff0c\u8fd8\u68c0\u67e5\uff1a</li> <li><code>PandaEnv::FromAniEnv(env)-&gt;HasPendingException()</code></li> <li>\u82e5 true \u5219\u8fd4\u56de <code>ANI_PENDING_ERROR</code></li> </ul> <p>\u8fd9\u7ed9\u51fa\u4e00\u4e2a\u91cd\u8981 ABI \u7ea6\u675f\uff1a\u591a\u6570 ANI API \u5728\u5b58\u5728 pending exception \u65f6\u4f1a\u76f4\u63a5\u62d2\u7edd\u6267\u884c\u3002 \u8fd9\u4e0e JNI \u7684\u201c\u5f02\u5e38\u5f85\u5904\u7406\u65f6\u591a\u6570 API \u4ecd\u53ef\u67e5\u8be2\u4f46\u4e0d\u5e94\u7ee7\u7eed\u8c03\u7528\u201d\u7684\u89c4\u5219\u7c7b\u4f3c\uff0c\u4f46\u8fd9\u91cc\u7528\u660e\u786e\u7684\u8fd4\u56de\u7801\u5f3a\u5236\u6267\u884c\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#2-managedscopedmanagedcodefix-scopedcoroutinenativecall","title":"2. \u201c\u8fdb\u5165 managed\u201d\u7edf\u4e00\u95e8\u9762\uff1a<code>ScopedManagedCodeFix</code> + <code>ScopedCoroutineNativeCall</code>\uff08\u8d2f\u7a7f\u5168\u6587\u4ef6\uff09","text":"<p>\u5728\u9ad8\u9891\u5165\u53e3\u5904\u90fd\u80fd\u770b\u5230\u4e24\u4e2a RAII\uff1a</p> <ul> <li><code>ScopedManagedCodeFix s(env)</code>\uff1a\u628a <code>ani_env*</code> \u6620\u5c04\u5230 <code>PandaEnv</code>/<code>EtsCoroutine</code> \u5e76\u5efa\u7acb\u53ef\u5728\u672c\u4f5c\u7528\u57df\u5b89\u5168\u64cd\u4f5c VM \u7684\u6761\u4ef6\uff1b\u540c\u65f6\u63d0\u4f9b\uff1a</li> <li><code>ToInternalType(ani_ref/ani_object/ani_class/...)</code></li> <li><code>AddLocalRef(...) / LocalRef&lt;T&gt;</code> \u7b49 local reference \u64cd\u4f5c</li> <li><code>HasPendingException()</code> / <code>GetThrowable()</code> / <code>ClearException()</code> \u7b49</li> <li><code>ScopedCoroutineNativeCall c(s.GetCoroutine())</code>\uff1a\u7528\u4e8e\u89e6\u53d1 coroutine manager \u7684 native call \u4e8b\u4ef6\uff08L246\u2013L247\uff09</li> </ul> <p>\u5b9e\u6218\u9605\u8bfb\u6280\u5de7\uff1a\u5728\u6bcf\u4e2a API \u7684\u51fd\u6570\u4f53\u91cc\uff0c\u5148\u627e\u8fd9\u4e24\u884c\uff0c\u5c31\u80fd\u5feb\u901f\u5b9a\u4f4d\u201c\u8de8\u8fb9\u754c\u70b9\u201d\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#3-initializeclass-l117l136","title":"3. \u7c7b\u521d\u59cb\u5316\uff1a<code>InitializeClass</code> \u662f\u6240\u6709\u9759\u6001\u8c03\u7528/\u9759\u6001\u5b57\u6bb5\u8bbf\u95ee\u7684\u5171\u540c\u524d\u7f6e\uff08L117\u2013L136\uff09","text":"<p>\u6838\u5fc3\u89c4\u5219\uff1a</p> <ul> <li>\u82e5 <code>klass-&gt;IsInitialized()</code> \u2192 OK</li> <li>\u5426\u5219\u901a\u8fc7 <code>EtsClassLinker::InitializeClass(coroutine, klass)</code> \u521d\u59cb\u5316</li> <li>\u521d\u59cb\u5316\u5931\u8d25\uff1a</li> <li>\u82e5 coroutine \u6709 pending exception \u2192 <code>ANI_PENDING_ERROR</code></li> <li>\u5426\u5219 <code>ANI_ERROR</code></li> </ul> <p>\u8be5\u903b\u8f91\u4f1a\u5728\uff1a - \u9759\u6001\u65b9\u6cd5\u8c03\u7528\uff08<code>DoGeneralMethodCall</code> \u7684 <code>ani_static_method/ani_function</code> \u5206\u652f\uff09 - \u9759\u6001\u5b57\u6bb5 get/set\uff08<code>ClassGetStaticField*</code>\uff09 \u88ab\u7edf\u4e00\u590d\u7528\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#4-shorty-getargvaluesl138l227","title":"4. \u53c2\u6570\u89e3\u5305\uff1ashorty \u9a71\u52a8\u7684 <code>GetArgValues</code>\uff08L138\u2013L227\uff09","text":"<p>ANI \u63d0\u4f9b\u4e24\u79cd\u5165\u53c2\u5f62\u5f0f\uff1a</p> <ul> <li><code>.../va_list</code>\uff1a<code>GetArgValues(s, method, va_list, object)</code>\uff08L138\u2013L177\uff09</li> <li><code>ani_value[]</code>\uff1a<code>GetArgValues(s, method, const ani_value *args, object)</code>\uff08L208\u2013L227\uff09</li> </ul> <p>\u5171\u540c\u673a\u5236\uff1a</p> <ul> <li>\u4f7f\u7528 <code>panda_file::ShortyIterator</code> \u904d\u5386\u65b9\u6cd5 shorty\uff08L147\u2013L150 / L219\u2013L223\uff09</li> <li>\u8df3\u8fc7 return type\uff0c\u7136\u540e\u9010\u4e2a\u53c2\u6570\u8f6c\u6362\u6210 runtime <code>Value</code>\uff1a</li> <li><code>REFERENCE</code>\uff1a\u53d6 <code>ani_ref</code> \u5e76\u8f6c\u6210 <code>EtsObject*</code> \u2192 <code>ObjectHeader*</code></li> <li><code>U1/U16</code>\u3001<code>I8/I16/I32</code>\u3001<code>I64</code>\u3001<code>F32/F64</code>\uff1a\u6309 ABI \u89c4\u5219\u4ece varargs/union \u91cc\u63d0\u53d6\u5e76 bit_cast \u6210 <code>Value</code> \u7684\u5b58\u50a8\u5f62\u5f0f</li> <li>\u82e5 <code>object != nullptr</code>\uff08\u5b9e\u4f8b\u65b9\u6cd5\uff09\uff1a\u628a <code>this</code> \u7684 coretype \u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\uff08L143\u2013L145 / L216\u2013L218\uff09</li> </ul> <p>\u8fd9\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u5f88\u591a\u8c03\u7528\u5165\u53e3\u53ea\u9700\u8981\u4f20 <code>method + args</code>\uff1a\u6700\u7ec8\u7edf\u4e00\u6210 <code>Value[]</code> \u5582\u7ed9 <code>EtsMethod::Invoke</code>\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#5-dogeneralmethodcall-generalmethodcall-generalfunctioncalll240l291","title":"5. \u8c03\u7528\u9aa8\u67b6\uff1a<code>DoGeneralMethodCall</code> / <code>GeneralMethodCall</code> / <code>GeneralFunctionCall</code>\uff08L240\u2013L291\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#51-l229l238","title":"5.1 \u865a\u65b9\u6cd5\u89e3\u6790\uff08L229\u2013L238\uff09","text":"<ul> <li>\u5bf9 <code>ani_method</code>\uff08\u5b9e\u4f8b\u65b9\u6cd5\uff09\u8c03\u7528\u5148 <code>ResolveVirtualMethod</code>\uff1a</li> <li>\u82e5 method \u662f static \u2192 FATAL\uff08\u975e\u6cd5 ANI \u7528\u6cd5\uff09</li> <li>\u5426\u5219\u901a\u8fc7\u5bf9\u8c61 class \u7684 vtable resolve \u5f97\u5230\u771f\u5b9e <code>EtsMethod*</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#52-invokel240l276","title":"5.2 \u7edf\u4e00 invoke\uff08L240\u2013L276\uff09","text":"<ul> <li>RAII\uff1a<code>ScopedCoroutineNativeCall</code></li> <li>\u9009\u62e9 <code>EtsMethod* m</code>\uff1a</li> <li><code>ani_method</code>\uff1avirtual resolve</li> <li><code>ani_static_method</code> / <code>ani_function</code>\uff1a<code>ToInternalMethod</code> + <code>InitializeClass</code></li> <li><code>values = GetArgValues(...)</code></li> <li><code>m-&gt;Invoke(s, values.data(), &amp;res)</code>\uff1a\u628a\u8c03\u7528\u59d4\u6258\u7ed9 <code>EtsMethod</code>\uff08\u8bed\u8a00/\u89e3\u91ca\u5668/\u7f16\u8bd1\u5668\u8def\u5f84\u90fd\u53ef\u80fd\u5728\u8fd9\u91cc\u5206\u6d41\uff09</li> <li>\u628a <code>EtsValue</code> \u8f6c\u56de\u5bf9\u5e94 ANI \u8fd4\u56de\u7c7b\u578b</li> </ul> <p>\u8fd9\u662f\u6574\u4efd\u6587\u4ef6\u6700\u6838\u5fc3\u7684\u201c\u9aa8\u67b6\u201d\uff1a\u540e\u9762\u7684 <code>Object_CallMethod_*</code>\u3001<code>Class_CallMethod_*</code>\u3001<code>Function_Call_*</code> \u7b49\u5927\u91cf API \u53ea\u662f\u201c\u628a\u4e0d\u540c\u7b7e\u540d\u6620\u5c04\u5230\u8fd9\u4e2a\u9aa8\u67b6\u201d\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#6-l293l406","title":"6. \u5b57\u6bb5\u8bbf\u95ee\uff1a\u7c7b\u578b\u6821\u9a8c +\uff08\u9759\u6001\u5b57\u6bb5\uff09\u7c7b\u521d\u59cb\u5316\uff08L293\u2013L406\uff09","text":"<p>\u4ee3\u8868\u6027\u6a21\u5f0f\uff1a</p> <ul> <li><code>GetPrimitiveTypeField/SetPrimitiveTypeField</code>\uff1a</li> <li><code>CHECK_ENV</code> + ptr \u6821\u9a8c</li> <li><code>EtsField*</code> \u2192 \u6821\u9a8c <code>GetEtsType() == expected</code>\uff08<code>AniTypeInfo&lt;T&gt;::ETS_TYPE_VALUE</code>\uff09</li> <li><code>ScopedManagedCodeFix</code> \u540e\u8bfb\u53d6/\u5199\u5165 object \u7684 primitive field</li> <li><code>ClassGetStaticField/ClassSetStaticField</code>\uff1a</li> <li>\u5148 <code>InitializeClass(s, etsField-&gt;GetDeclaringClass())</code></li> <li>\u518d\u8bfb\u5199\u9759\u6001\u5b57\u6bb5</li> <li><code>ClassGetStaticFieldByName/ClassSetStaticFieldByName</code>\uff1a</li> <li>\u901a\u8fc7 <code>GetStaticFieldIDByName(name, nullptr)</code> \u67e5\u5b57\u6bb5</li> <li><code>ANI_NOT_FOUND</code> / <code>ANI_INVALID_TYPE</code> / <code>InitializeClass</code> \u5931\u8d25\u7b49\u5747\u6620\u5c04\u4e3a\u660e\u786e\u8fd4\u56de\u7801</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#7-findclassfindmodulefindnamespace-classnotfounderror-ani_not_foundl408l441","title":"7. FindClass/FindModule/FindNamespace\uff1a\u628a ClassNotFoundError \u7ffb\u8bd1\u6210 <code>ANI_NOT_FOUND</code>\uff08L408\u2013L441 \u7b49\uff09","text":"<p><code>DoFind</code> \u7684\u5173\u952e\u70b9\uff08L410\u2013L433\uff09\uff1a</p> <ul> <li>\u901a\u8fc7 <code>classLinker-&gt;GetClass(descriptor, true, GetClassLinkerContext(...))</code></li> <li>\u82e5 <code>pandaEnv-&gt;HasPendingException()</code>\uff1a</li> <li>\u82e5\u5f02\u5e38\u7c7b\u578b\u662f <code>LINKER_CLASS_NOT_FOUND_ERROR</code>\uff1a<ul> <li>\u6e05\u9664\u5f02\u5e38\u5e76\u8fd4\u56de <code>ANI_NOT_FOUND</code></li> </ul> </li> <li>\u5176\u4ed6\u5f02\u5e38\uff1a\u8fd4\u56de <code>ANI_PENDING_ERROR</code></li> <li>\u6821\u9a8c <code>klass-&gt;IsModule()</code> \u4e0e\u6a21\u677f\u53c2\u6570 <code>IS_MODULE</code> \u4e00\u81f4\uff0c\u5426\u5219 <code>ANI_NOT_FOUND</code></li> <li>\u6210\u529f\u5219 <code>s.AddLocalRef(reinterpret_cast&lt;EtsObject*&gt;(klass), result)</code></li> </ul> <p>\u8fd9\u91cc\u662f\u201cnative \u2194 class loading\u201d\u4ea4\u754c\u9762\uff1a ANI \u628a\u67d0\u4e9b linker \u5f02\u5e38\u964d\u7ea7\u4e3a\u201c\u6ca1\u627e\u5230\u201d\uff0c\u800c\u4e0d\u662f\u628a\u5f02\u5e38\u900f\u4f20\u5230 native \u8c03\u7528\u65b9\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#8-namesignature-mangle-overload-disambiguationl443l573","title":"8. \u901a\u8fc7 name/signature \u67e5\u65b9\u6cd5\uff1amangle + overload disambiguation\uff08L443\u2013L573\uff09","text":"<p>\u6838\u5fc3\u903b\u8f91\u5728 <code>DoGetClassMethodUnderManagedScope</code>\uff1a</p> <ul> <li>\u82e5 <code>signature==nullptr</code>\uff0c\u4f46\u540c\u540d\u65b9\u6cd5\u4e0d\u552f\u4e00 \u2192 <code>ANI_AMBIGUOUS</code>\uff08\u4e34\u65f6\u89c4\u5219\uff0c\u6ce8\u91ca\u8bf4\u660e\u672a\u6765\u79fb\u9664\uff09</li> <li>\u82e5 <code>signature!=nullptr</code>\uff1a<code>Mangle::ConvertSignatureToProto</code> \u89e3\u6790\u7b7e\u540d\uff0c\u5931\u8d25\u5219 <code>ANI_INVALID_DESCRIPTOR</code></li> <li>\u5148\u5c1d\u8bd5 <code>GetStaticMethod/GetInstanceMethod</code>\uff1b\u5426\u5219\u518d\u8d70 overload \u5217\u8868</li> <li>overload \u4e3a 0 \u2192 <code>ANI_NOT_FOUND</code>\uff1b&gt;1 \u2192 <code>ANI_AMBIGUOUS</code></li> </ul> <p>\u968f\u540e\u5404\u7c7b <code>ObjectCallMethodByName/ClassCallMethodByName</code>\uff1a</p> <ul> <li>\u505a env/ptr \u6821\u9a8c</li> <li>\u627e\u5230 <code>EtsMethod*</code> \u540e\u5148 <code>Check(ReturnType)</code>\uff08return type mismatch \u76f4\u63a5 FATAL\uff09</li> <li>\u6700\u7ec8\u56de\u5230 <code>DoGeneralMethodCall</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#9-allocobject-donewobjectl595l627","title":"9. \u5bf9\u8c61\u521b\u5efa\uff1a<code>AllocObject</code> + <code>DoNewObject</code>\uff08L595\u2013L627\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#91-allocobjectl595l608","title":"9.1 <code>AllocObject</code>\uff08L595\u2013L608\uff09","text":"<ul> <li>\u7981\u6b62\u521b\u5efa\uff1a</li> <li>abstract / interface</li> <li>string class / array class\uff08\u6ce8\u91ca\u63d0\u5230\u672a\u6765\u53ef\u80fd\u5141\u8bb8\uff0c\u5173\u8054 issue #22280\uff09</li> <li><code>EtsObject::Create(coro, klass)</code>\uff1a\u5206\u914d\u5bf9\u8c61</li> <li>\u901a\u8fc7 <code>s.AddLocalRef(obj, result)</code> \u8fd4\u56de ani_object\uff08local ref\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#92-donewobjectl610l627","title":"9.2 <code>DoNewObject</code>\uff08L610\u2013L627\uff09","text":"<ul> <li>\u5148 <code>AllocObject</code> \u83b7\u53d6 local ref <code>object</code></li> <li><code>InitializeClass(s, klass)</code></li> <li>\u8c03\u7528\u6784\u9020\u65b9\u6cd5\uff1a<code>DoGeneralMethodCall</code>\uff08\u8fd4\u56de\u503c\u7528\u4efb\u610f primitive \u7c7b\u578b\u5360\u4f4d\uff0c\u5ffd\u7565\uff09</li> <li><code>*result = object.Release()</code>\uff1a\u628a local ref \u4ea4\u7ed9\u8c03\u7528\u65b9\uff08\u9075\u5faa ANI \u7684 reference \u8bed\u4e49\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#10-anyhandlescope-vmhandle-etscalll6204l6302","title":"10. Any/\u52a8\u6001\u8c03\u7528\u65cf\uff1aHandleScope + VMHandle + <code>EtsCall*</code>\uff08\u4f8b\uff1aL6204\u2013L6302\uff09","text":"<p><code>Any_Call/Any_CallMethod/Any_New</code> \u4f53\u73b0\u4e86 dynamic interop \u7684\u8c03\u7528\u5f62\u6001\uff1a</p> <ul> <li><code>HandleScope&lt;ObjectHeader*&gt; scope(coroutine)</code>\uff1a\u786e\u4fdd\u4e34\u65f6\u5bf9\u8c61\u4f5c\u4e3a GC root</li> <li>\u628a <code>ani_ref* argv</code> \u8f6c\u4e3a <code>VMHandle&lt;ObjectHeader&gt;</code> \u6570\u7ec4</li> <li>\u8c03\u7528 <code>EtsCall/EtsCallThis/EtsCallNew</code></li> <li>\u82e5\u6709 pending exception \u2192 <code>ANI_PENDING_ERROR</code>\uff1b\u5426\u5219 <code>AddLocalRef(res, result)</code></li> </ul> <p>\u8fd9\u90e8\u5206\u662f \u201cnative \u5bf9\u52a8\u6001\u503c/\u51fd\u6570\u5bf9\u8c61\u201d \u7684\u8c03\u7528\u8def\u5f84\uff0c\u4e0e 04 \u7ae0\u7684 interpreter stubs/entrypoints \u5728\u7406\u5ff5\u4e0a\u7c7b\u4f3c\uff1a\u8981\u660e\u786e GC root \u4e0e\u5f02\u5e38\u4f20\u64ad\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#11-interaction_api-api-l6305l6706","title":"11. <code>INTERACTION_API</code> \u9759\u6001\u8868\uff1a\u5168\u90e8 API \u7684\u6700\u7ec8\u843d\u70b9\uff08L6305\u2013L6706\uff09","text":"<ul> <li>L6305\uff1a<code>const __ani_interaction_api INTERACTION_API = { ... }</code></li> <li>\u8868\u5185\u6309\u5916\u90e8 ABI \u7ea6\u5b9a\u7684\u987a\u5e8f\u5217\u51fa\u5927\u91cf\u51fd\u6570\u6307\u9488\uff08\u542b New/Object/Type/Find/Array/Ref/Error/Any/Promise \u7b49\uff09\u3002</li> <li>L6709\u2013L6712\uff1a<code>GetInteractionAPI()</code> \u8fd4\u56de <code>&amp;INTERACTION_API</code></li> <li>L6714\u2013L6717\uff1a<code>IsVersionSupported(version)</code>\uff1a\u5f53\u524d\u4ec5\u652f\u6301 <code>ANI_VERSION_1</code></li> </ul> <p>\u8fd9\u91cc\u4e0e <code>ets_napi_env.cpp</code> \u5b8c\u5168\u5bf9\u4e0a\uff1a<code>ani_env {ani::GetInteractionAPI()}</code> \u5b9e\u9645\u5c31\u662f\u628a env \u7684 <code>c_api</code> \u6307\u5411\u8fd9\u5f20\u8868\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.cpp/#12","title":"12. \u9605\u8bfb/\u6392\u969c\u6307\u5f15\uff08\u5efa\u8bae\uff09","text":"<p>\u9762\u5bf9 6k+ \u884c\u5927\u6587\u4ef6\uff0c\u5efa\u8bae\u4ee5\u201c\u9aa8\u67b6\u51fd\u6570\u201d\u4e3a\u7d22\u5f15\u5feb\u901f\u5b9a\u4f4d\uff1a</p> <ul> <li>\u8c03\u7528\uff1a<code>DoGeneralMethodCall</code>\u3001<code>GetArgValues</code>\u3001<code>ResolveVirtualMethod</code></li> <li>\u7c7b\u521d\u59cb\u5316\uff1a<code>InitializeClass</code></li> <li>\u67e5\u627e\uff1a<code>DoFind</code>\uff08\u628a ClassNotFoundError \u2192 ANI_NOT_FOUND\uff09</li> <li>new\uff1a<code>AllocObject</code>\u3001<code>DoNewObject</code></li> <li>Any\uff1a<code>Any_Call/Any_CallMethod/Any_New</code></li> <li>\u8868\uff1a<code>INTERACTION_API</code>\uff08\u786e\u8ba4\u67d0\u4e2a ABI slot \u5bf9\u5e94\u54ea\u4e2a\u5b9e\u73b0\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.h/","title":"<code>plugins/ets/runtime/ani/ani_interaction_api.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e ANI \u7684\u201cinteraction API \u8868\u201d\u5165\u53e3\u4e0e\u7248\u672c\u652f\u6301\u68c0\u67e5\uff1a - <code>GetInteractionAPI()</code>\uff1a\u8fd4\u56de <code>__ani_interaction_api</code> \u7684\u51fd\u6570\u6307\u9488\u8868\uff08\u5b9a\u4e49\u5728 <code>ani_interaction_api.cpp</code>\uff09 - <code>IsVersionSupported(version)</code>\uff1a\u5f53\u524d\u4ec5\u652f\u6301 <code>ANI_VERSION_1</code></p> <p>\u8be5\u8868\u4f1a\u88ab <code>PandaEtsNapiEnv</code> \u5728\u6784\u9020\u65f6\u5199\u5165 <code>ani_env::c_api</code>\uff08\u666e\u901a\u6a21\u5f0f\uff09\uff0c\u6216\u5728 verify \u6a21\u5f0f\u4e0b\u88ab\u66ff\u6362\u4e3a verify \u7248\u672c\u8868\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.h/#1-abi-l22","title":"1. \u5916\u90e8 ABI \u524d\u7f6e\u58f0\u660e\uff08L22\uff09","text":"<ul> <li>L22\uff1a<code>struct __ani_interaction_api;</code>   \u540c <code>__ani_vm_api</code> \u4e00\u6837\uff0c\u8fd9\u4e2a\u7c7b\u578b\u6765\u81ea\u5916\u90e8 ABI \u5934\uff1b\u6b64\u5904\u53ea\u505a\u524d\u7f6e\u58f0\u660e\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.h/#2-l24l27","title":"2. \u516c\u5f00\u51fd\u6570\uff08L24\u2013L27\uff09","text":"<ul> <li>L25\uff1a<code>GetInteractionAPI()</code>\uff1a\u8fd4\u56de <code>&amp;INTERACTION_API</code>\uff08\u5178\u578b\u9759\u6001\u8868\u6a21\u5f0f\uff0c\u5b9e\u73b0\u5728 <code>.cpp</code> \u672b\u5c3e\uff09\u3002</li> <li>L26\uff1a<code>IsVersionSupported(version)</code>\uff1a\u7531 <code>.cpp</code> \u5b9e\u73b0\uff08\u5f53\u524d\u7b49\u4e8e <code>version == ANI_VERSION_1</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_interaction_api.h/#3-enumarraynamesl28l33","title":"3. <code>EnumArrayNames</code>\uff1a\u5185\u90e8\u7ea6\u5b9a\u7684\u201c\u679a\u4e3e\u8f85\u52a9\u6570\u7ec4\u201d\u547d\u540d\uff08L28\u2013L33\uff09","text":"<ul> <li>L28\u2013L33\uff1a\u63d0\u4f9b\u51e0\u4e2a <code>constexpr std::string_view</code>\uff1a</li> <li><code>#NamesArray</code></li> <li><code>#ValuesArray</code></li> <li><code>#StringValuesArray</code></li> <li><code>#ItemsArray</code></li> </ul> <p>\u63a8\u65ad\u7528\u9014\uff1a - \u8fd9\u662f\u5bf9 ETS \u679a\u4e3e\u5b9e\u73b0\u7ec6\u8282\u7684\u7ea6\u5b9a\uff1a\u679a\u4e3e\u7c7b/\u6a21\u5757\u53ef\u80fd\u751f\u6210\u8fd9\u4e9b\u201c\u4f2a\u5b57\u6bb5/\u4f2a\u6570\u7ec4\u201d\u7528\u4e8e\u53cd\u5c04\u6216 interop\u3002 - interaction API \u5728 <code>FindEnum</code> \u6216\u76f8\u5173\u8bbf\u95ee\u63a5\u53e3\u4e2d\u53ef\u80fd\u7528\u8fd9\u4e9b\u540d\u79f0\u505a\u5b9a\u4f4d\uff08\u9700\u8981\u7ed3\u5408 <code>.cpp</code> \u7684\u76f8\u5e94\u5b9e\u73b0\u6bb5\u843d\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/","title":"<code>plugins/ets/runtime/ani/ani_options.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>ANIOptions</code> \u7684 option map \u4e0e\u6821\u9a8c\u89c4\u5219\uff1a - \u5f3a\u5236 <code>--logger</code> \u5fc5\u987b\u63d0\u4f9b <code>extra</code>\uff08callback \u6307\u9488\uff09\uff0c\u4e14\u4e0d\u80fd\u6709 <code>=value</code> - <code>--verify:ani</code> \u4e0d\u5141\u8bb8 value/extra - <code>--ext:interop</code>\uff08\u53ef\u9009\uff09\u5141\u8bb8 extra\uff08\u901a\u5e38\u4e3a JS env \u53e5\u67c4\uff09 - OHOS \u4e0b\u63d0\u4f9b\u9ed8\u8ba4 logger callback</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#1-getloggercallbackohos-loggerl26l34","title":"1. <code>GetLoggerCallback</code>\uff1aOHOS \u9ed8\u8ba4 logger\uff08L26\u2013L34\uff09","text":"<ul> <li>\u4ece <code>OptionKey::LOGGER</code> \u7684 <code>extra</code> \u53d6\u51fa\u5e76 reinterpret_cast \u4e3a <code>LoggerCallback</code>\u3002</li> <li>OHOS \u4e0b\u82e5 callback \u4e3a\u7a7a\uff0c\u8fd4\u56de <code>ohos::DefaultLogger</code>\uff08\u4fdd\u8bc1\u65e5\u5fd7\u53ef\u7528\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#2-setoption-map-handlerl36l51","title":"2. <code>SetOption</code>\uff1a\u67e5 map\u2192\u8c03\u7528 handler\u2192\u5b58\u5165\u6570\u7ec4\uff08L36\u2013L51\uff09","text":"<ul> <li>\u82e5 key \u4e0d\u5728 map\uff1a\u8fd4\u56de <code>false</code>\uff08\u8868\u793a\u201c\u4e0d\u662f ANIOptions \u7ba1\u7684 option\u201d\uff09\u3002</li> <li>\u5426\u5219\u6267\u884c handler\uff1a</li> <li>\u6210\u529f\u5219\u628a <code>unique_ptr&lt;OptionValue&gt;</code> \u5b58\u5165 <code>optionValues_[optionKey]</code></li> <li>\u5931\u8d25\u5219 <code>Unexpected(error_string)</code></li> </ul> <p>\u8fd9\u4e0e <code>OptionsParser</code> \u7684\u4e24\u9636\u6bb5\u89e3\u6790\u5bf9\u63a5\uff1a \u7b2c\u4e00\u9636\u6bb5\u5148\u8ba9 <code>ANIOptions</code> \u5403\u6389\u5b83\u8ba4\u8bc6\u7684 key\uff1b\u5269\u4e0b\u7684\u518d\u8fdb\u5165 <code>--ext:</code> \u6269\u5c55\u9009\u9879\u89e3\u6790\uff08\u89c1 <code>ani_options_parser.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#3-getoptionsmapl54l112","title":"3. <code>GetOptionsMap</code>\uff1a\u9759\u6001\u8868\u9a71\u52a8\uff08L54\u2013L112\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#31-loggerl58l73","title":"3.1 <code>--logger</code>\uff08L58\u2013L73\uff09","text":"<ul> <li>\u4e0d\u5141\u8bb8 <code>value</code>\uff08\u5fc5\u987b\u7a7a\uff09\u3002</li> <li>\u5f3a\u5236 <code>extra != nullptr</code>\uff08\u5fc5\u987b\u63d0\u4f9b callback\uff09\u3002</li> <li>\u5b58\u50a8\u4e3a <code>OptionValue { std::string(value), extra }</code>\uff1avalue \u5b9e\u9645\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u4ec5\u7528 extra\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#32-verifyanil75l90","title":"3.2 <code>--verify:ani</code>\uff08L75\u2013L90\uff09","text":"<ul> <li>\u4e0d\u5141\u8bb8 value\uff08\u5fc5\u987b\u7a7a\uff09\u3002</li> <li>\u4e0d\u5141\u8bb8 extra\uff08\u5fc5\u987b\u4e3a nullptr\uff09\u3002</li> <li>\u5b58\u50a8\u4e3a <code>OptionValue { true, extra }</code>\uff1a\u5373\u5f00\u542f verify\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.cpp/#33-extinteropl91l108","title":"3.3 <code>--ext:interop</code>\uff08L91\u2013L108\uff0c\u53ef\u9009\u7f16\u8bd1\uff09","text":"<ul> <li>\u4e0d\u5141\u8bb8 value\uff08\u5fc5\u987b\u7a7a\uff09\u3002</li> <li>\u5141\u8bb8 extra\uff08JS env \u53e5\u67c4\uff09\u5e76\u628a bool \u7f6e\u4e3a true\u3002</li> </ul> <p>\u6ce8\u610f\uff1a<code>ANI_CreateVM</code> \u7684 interop \u8def\u5f84\u4f7f\u7528\u7684\u662f <code>aniOptions.IsInteropMode()</code> \u4e0e <code>GetInteropEnv()</code>\uff08\u89c1 <code>ani_vm_api.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/","title":"<code>plugins/ets/runtime/ani/ani_options.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 ANI \u81ea\u8eab\u53ef\u8bc6\u522b\u7684 options \u96c6\u5408 <code>ANIOptions</code>\uff1a - <code>--logger</code>\uff1a\u6ce8\u5165 logger callback\uff08\u901a\u8fc7 <code>ani_option.extra</code>\uff09 - <code>--verify:ani</code>\uff1a\u5f00\u542f VerifyANI\uff08\u4f1a\u5f71\u54cd <code>PandaEtsNapiEnv</code> \u7684 <code>c_api</code> \u66ff\u6362\uff09 - <code>--ext:interop</code>\uff08\u7f16\u8bd1\u8fdb interop \u65f6\uff09\uff1a\u5f00\u542f interop \u6a21\u5f0f\u5e76\u4fdd\u5b58 <code>extra</code>\uff08JS env \u53e5\u67c4\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#0-includesl18l27","title":"0. includes\uff08L18\u2013L27\uff09","text":"<ul> <li><code>Expected</code>\uff1a<code>SetOption</code> \u8fd4\u56de <code>Expected&lt;bool, std::string&gt;</code>\uff1a  </li> <li><code>true/false</code> \u8868\u793a\u201c\u662f\u5426\u4e3a\u5df2\u8bc6\u522b\u7684 option key\u201d  </li> <li>error string \u8868\u793a\u201c\u8bc6\u522b\u4e86\u4f46\u53c2\u6570/extra \u4e0d\u5408\u6cd5\u201d</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#1-loggercallback-abil30","title":"1. <code>LoggerCallback</code> ABI\uff08L30\uff09","text":"<ul> <li>\u4e0e <code>ani.h</code> \u7684\u6ce8\u91ca ABI \u4e00\u81f4\uff1a<code>(FILE*, int, const char*, const char*)</code>\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#2-optionkey-option-l34l42","title":"2. <code>OptionKey</code>\uff1a\u7f16\u8bd1\u671f\u56fa\u5b9a\u7684 option \u679a\u4e3e\uff08L34\u2013L42\uff09","text":"<ul> <li><code>LOGGER</code>\u3001<code>VERIFY_ANI</code>\uff0c\u4ee5\u53ca\u53ef\u9009 <code>INTEROP</code>\uff08<code>PANDA_ETS_INTEROP_JS</code>\uff09\u3002</li> <li><code>NUMBER_OF_ELEMENTS</code> \u7528\u4e8e <code>optionValues_</code> \u6570\u7ec4\u5927\u5c0f\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#3-setoption-optionvalues_l47","title":"3. <code>SetOption</code>\uff1a\u89e3\u6790\u5e76\u5b58\u50a8\u5230 <code>optionValues_</code>\uff08L47\uff09","text":"<ul> <li>\u8f93\u5165\uff1a<code>key/value/extra</code></li> <li>\u8f93\u51fa\uff1a</li> <li><code>Expected&lt;bool, string&gt;</code>\uff1a  <ul> <li><code>false</code>\uff1a\u4e0d\u8ba4\u8bc6\u7684 key\uff08\u4ea4\u7ed9 <code>OptionsParser</code> \u5f53\u4f5c\u201c\u6269\u5c55 option\u201d\u7ee7\u7eed\u5904\u7406\uff09  </li> <li><code>Unexpected(msg)</code>\uff1a\u8ba4\u8bc6\u4f46\u53c2\u6570\u4e0d\u5408\u6cd5  </li> <li><code>true</code>\uff1a\u6210\u529f\u4fdd\u5b58</li> </ul> </li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#4-l49l67","title":"4. \u5feb\u901f\u67e5\u8be2\u63a5\u53e3\uff08L49\u2013L67\uff09","text":"<ul> <li><code>GetLoggerCallback()</code>\uff1a\u8fd4\u56de logger callback\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff0cOHOS \u4e0b\u6709\u9ed8\u8ba4\u503c\uff09\u3002</li> <li><code>IsVerifyANI()</code>\uff1a\u8bfb\u53d6 <code>VERIFY_ANI</code> \u7684 bool \u503c\uff08\u9ed8\u8ba4 false\uff09\u3002</li> <li>interop \u5206\u652f\uff1a</li> <li><code>IsInteropMode()</code>\uff1a\u8bfb\u53d6 bool\uff08\u9ed8\u8ba4 false\uff09</li> <li><code>GetInteropEnv()</code>\uff1a\u53d6 <code>extra</code>\uff08void*\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#5-optionvalueoptionhandlerl71l81","title":"5. \u5185\u90e8\u7ed3\u6784\uff1aOptionValue/OptionHandler\uff08L71\u2013L81\uff09","text":"<ul> <li><code>OptionValue</code>\uff1a</li> <li><code>value</code>\uff1a<code>variant&lt;bool, string&gt;</code></li> <li><code>extra</code>\uff1a\u539f\u6837\u4fdd\u5b58 <code>ani_option.extra</code></li> <li><code>OptionHandler</code>\uff1a\u628a\u5b57\u7b26\u4e32 key \u6620\u5c04\u5230 <code>(OptionKey, parser-fn)</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options.h/#6-l94l99","title":"6. \u5b58\u50a8\u5e03\u5c40\uff08L94\u2013L99\uff09","text":"<ul> <li><code>optionValues_</code> \u662f\u4e00\u4e2a\u5b9a\u957f\u6570\u7ec4\uff0c\u6309 <code>OptionKey</code> \u7684 underlying \u503c\u7d22\u5f15\u3002</li> <li><code>GetOptionsMap()</code> \u8fd4\u56de\u9759\u6001 map\uff08\u5b9e\u73b0\u5728 <code>.cpp</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/","title":"<code>plugins/ets/runtime/ani/ani_options_parser.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cANI_CreateVM options \u89e3\u6790\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u6587\u4ef6\u89c4\u6a21\uff1a248 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>OptionsParser</code> \u7684\u4e24\u9636\u6bb5\u89e3\u6790\uff1a 1) \u5148\u8ba9 <code>ANIOptions</code> \u89e3\u6790\u5b83\u8ba4\u8bc6\u7684 option\uff08<code>--logger</code>\u3001<code>--verify:ani</code>\u3001<code>--ext:interop</code>\uff09 2) \u5176\u4f59\u53c2\u6570\u82e5\u7b26\u5408 <code>--ext:</code> \u524d\u7f00\uff0c\u5219\u4f5c\u4e3a\u201c\u6269\u5c55 option\u201d\u5206\u6d3e\u7ed9 logger/runtime/compiler \u7684 PandArgParser</p> <p>\u6700\u7ec8\u4ea7\u51fa\uff1a<code>logger::Options</code>\u3001<code>RuntimeOptions</code>\uff08\u9ed8\u8ba4 ETS runtime\uff09\u3001compiler options\uff0c\u5e76\u5199\u56de ETS VM options\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#1-product-build-l25l29","title":"1. product build \u7ea6\u675f\uff08L25\u2013L29\uff09","text":"<ul> <li><code>PANDA_PRODUCT_BUILD</code> \u4e0b\uff1a<code>ANI_SUPPORTS_ONLY_PRODUCT_OPTIONS=true</code>   \u4f5c\u7528\uff1a\u4ec5\u5141\u8bb8 product allowlist \u4e2d\u7684\u53c2\u6570\u88ab\u89e3\u6790/\u900f\u4f20\uff0c\u5176\u4ed6\u53c2\u6570\u4f1a\u88ab\u9759\u9ed8\u8df3\u8fc7\u6216\u5224\u4e3a\u4e0d\u652f\u6301\uff08\u89c1 <code>GetParserDependentArgs</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#2-options-ets-runtime-l38l49","title":"2. \u6784\u9020\uff1a\u6ce8\u518c\u4e09\u5957 options\uff0c\u5e76\u8bbe\u7f6e ETS runtime \u9ed8\u8ba4\u503c\uff08L38\u2013L49\uff09","text":"<ul> <li>L40\u2013L42\uff1a\u628a logger/runtime/compiler \u7684 options \u6ce8\u518c\u5230\u5404\u81ea parser\u3002</li> <li>L44\u2013L49\uff1a\u5f3a\u5236\u8bbe\u7f6e runtime options \u7684 ETS \u9ed8\u8ba4\uff1a</li> <li>boot intrinsic/class spaces = {\"ets\"}</li> <li>runtimeType = \"ets\"</li> <li>loadRuntimes = {\"ets\"}</li> </ul> <p>\u8fd9\u4fdd\u8bc1 <code>ANI_CreateVM</code> \u521b\u5efa\u7684 runtime \u662f ETS runtime\uff0c\u800c\u4e0d\u662f\u4f9d\u8d56\u5916\u90e8\u4f20\u53c2\u51b3\u5b9a\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#3-parseanioptions-ext-options-ets-vm-optionsl83l132","title":"3. <code>Parse</code>\uff1a\u7b2c\u4e00\u9636\u6bb5\uff08ANIOptions\uff09+ \u7b2c\u4e8c\u9636\u6bb5\uff08ext options\uff09+ \u5199\u56de ETS VM options\uff08L83\u2013L132\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#31-ani_optionsl95l114","title":"3.1 \u904d\u5386 <code>ani_options</code>\uff08L95\u2013L114\uff09","text":"<ul> <li>\u5bf9\u6bcf\u4e2a <code>ani_option</code>\uff1a</li> <li>\u62c6 <code>name/value</code>\uff08\u6309 <code>=</code> \u5206\u5272\uff09</li> <li><code>aniOptions_.SetOption(name, value, opt.extra)</code>\uff1a<ul> <li><code>HasValue()==false</code>\uff1a\u8868\u793a\u53c2\u6570\u6709\u9519\u8bef\uff0c\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\u5b57\u7b26\u4e32</li> <li><code>Value()==true</code>\uff1aANIOptions \u8bc6\u522b\u5e76\u6d88\u8d39\u6389\u8be5 option</li> <li><code>Value()==false</code>\uff1a\u4e0d\u662f ANIOptions \u7ba1\u7684\uff0c\u6536\u96c6\u5230 <code>extOptions</code></li> </ul> </li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#32-option-l116l125-l174l187","title":"3.2 \u89e3\u6790\u6269\u5c55 option \u524d\u7f00\uff08L116\u2013L125, L174\u2013L187\uff09","text":"<ul> <li>\u53ea\u63a5\u53d7\u4e24\u79cd\u524d\u7f00\uff1a</li> <li>deprecated\uff1a<code>--ext:--</code></li> <li>\u65b0\u7248\uff1a<code>--ext:</code></li> <li>\u89e3\u6790\u540e\u6784\u9020 <code>Option{fullName, name, value, opt}</code>\uff0c\u5e76\u653e\u5165 <code>extOptionsMap[name]</code>\u3002</li> <li>\u82e5\u524d\u7f00\u4e0d\u5339\u914d\u5219\u8fd4\u56de\u7a7a\uff08\u968f\u540e\u62a5 \u201coption is not supported\u201d\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#33-parseextoptions-ext-options-3-parserl134l172","title":"3.3 <code>ParseExtOptions</code>\uff1a\u628a ext options \u5206\u6d3e\u7ed9 3 \u4e2a parser\uff08L134\u2013L172\uff09","text":"<ul> <li><code>GetParserDependentArgs(parser, productOptions, extOptionsMap, outArgs)</code>\uff1a</li> <li>\u8bfb\u53d6 parser \u5df2\u89e3\u6790\u8fc7\u7684 arg name \u96c6\u5408</li> <li>\u82e5 product build \u4e14 name \u4e0d\u5728 allowlist\uff1a\u8df3\u8fc7</li> <li>\u82e5 ext option \u88ab\u8be5 parser \u8bc6\u522b\uff1a<ul> <li>\u5f3a\u5236 <code>opt-&gt;extra == nullptr</code>\uff08\u6269\u5c55 option \u4e0d\u652f\u6301 extra\uff09</li> <li>\u7ec4\u88c5\u6210 <code>--name=value</code> \u5f62\u5f0f\u52a0\u5165 outArgs</li> <li>\u4ece map \u4e2d\u5220\u9664\u8be5\u9879</li> </ul> </li> <li>\u4f9d\u6b21\u5bf9 logger/runtime/compiler \u4e09\u4e2a parser \u505a\u8be5\u8fc7\u7a0b\uff1b\u6700\u540e\u8981\u6c42 extOptionsMap \u4e3a\u7a7a\uff0c\u5426\u5219\u62a5\u201c\u4e0d\u652f\u6301\u201d\u3002</li> <li>\u8fd0\u884c\u5404 parser \u5e76 Validate\uff1a</li> <li>logger validate \u5931\u8d25\u4f1a\u56de\u9000\u9ed8\u8ba4 logger options\uff08\u89c1 <code>RunLoggerOptionsParser</code>\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.cpp/#34-prepareetsvmoptionsl243l246","title":"3.4 <code>PrepareEtsVmOptions</code>\uff08L243\u2013L246\uff09","text":"<ul> <li>\u8c03 <code>SetEtsVmOptions(runtimeOptions_, make_unique&lt;EtsVmOptions&gt;(aniOptions_.IsVerifyANI()))</code>\uff1a   \u628a verifyANI \u5f00\u5173\u5199\u8fdb ETS VM options\uff08\u540e\u7eed env \u6784\u9020\u65f6\u4f1a\u7528\u5230\uff09\u3002</li> </ul> <p>\u8fd9\u6761\u94fe\u8def\u6700\u7ec8\u5f71\u54cd <code>PandaEtsNapiEnv</code> \u662f\u5426\u628a <code>c_api</code> \u66ff\u6362\u4e3a verify \u8868\uff08\u89c1 <code>ets_napi_env.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/","title":"<code>plugins/ets/runtime/ani/ani_options_parser.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e <code>OptionsParser</code>\uff0c\u7528\u4e8e <code>ANI_CreateVM</code> \u89e3\u6790 <code>ani_options</code> \u5e76\u4ea7\u51fa\u4e09\u7c7b\u7ed3\u679c\uff1a - <code>ANIOptions</code>\uff08ANI \u81ea\u8eab\u7684\u5f00\u5173\uff1alogger/verify/interop\uff09 - <code>logger::Options</code>\uff08\u65e5\u5fd7\u7cfb\u7edf\uff09 - <code>RuntimeOptions</code>\uff08\u8fd0\u884c\u65f6\u914d\u7f6e\uff0c\u4e14\u9ed8\u8ba4\u8bbe\u4e3a ets runtime\uff09 - \u4ee5\u53ca compiler options parser\uff08\u901a\u8fc7 <code>compiler::g_options</code>\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/#1-getterl37l50","title":"1. \u4ea7\u7269 getter\uff08L37\u2013L50\uff09","text":"<ul> <li><code>GetANIOptions()</code>\uff1a\u7ed9 <code>ani_vm_api.cpp</code> \u51b3\u5b9a interop/verify \u5206\u652f\u3002</li> <li><code>GetLoggerOptions()</code>\uff1a\u7528\u4e8e <code>Logger::Initialize(...)</code></li> <li><code>GetRuntimeOptions()</code>\uff1a\u7528\u4e8e <code>Runtime::Create(...)</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/#2-l53l70","title":"2. \u89e3\u6790\u6d41\u7a0b\u7684\u5173\u952e\u5185\u90e8\u7c7b\u578b\uff08L53\u2013L70\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/#21-option-option-l53l58","title":"2.1 <code>Option</code>\uff1a\u6269\u5c55 option \u7684\u62c6\u89e3\u7ed3\u679c\uff08L53\u2013L58\uff09","text":"<ul> <li><code>fullName</code>\uff1a\u539f\u59cb\u5b57\u7b26\u4e32\uff08\u5982 <code>--ext:foo=bar</code>\uff09</li> <li><code>name</code>\uff1a\u53bb\u6389 prefix \u7684\u540d\u5b57\uff08\u5982 <code>foo</code>\uff09</li> <li><code>value</code>\uff1a<code>bar</code></li> <li><code>opt</code>\uff1a\u6307\u5411\u539f\u59cb <code>ani_option</code>\uff0c\u4ee5\u4fbf\u68c0\u67e5 <code>extra</code> \u8bed\u4e49</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/#22-optionsmapl60l60","title":"2.2 <code>OptionsMap</code>\uff08L60\u2013L60\uff09","text":"<ul> <li><code>map&lt;name, unique_ptr&lt;Option&gt;&gt;</code>\uff1a\u7528\u4e8e\u628a ext options \u6682\u5b58\u5e76\u5206\u6d3e\u7ed9 logger/runtime/compiler \u4e09\u4e2a parser\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_options_parser.h/#23-parserl74l81","title":"2.3 \u4e09\u4e2a parser\uff08L74\u2013L81\uff09","text":"<ul> <li><code>loggerOptionsParser_</code> + <code>loggerOptions_</code></li> <li><code>runtimeOptionsParser_</code> + <code>runtimeOptions_</code></li> <li><code>compilerOptionsParser_</code></li> </ul> <p><code>PrepareEtsVmOptions()</code> \u4f1a\u628a ETS VM \u7279\u6709\u7684 options \u5199\u56de <code>RuntimeOptions</code>\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/","title":"<code>plugins/ets/runtime/ani/ani_vm_api.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cCreateVM/Attach/Detach/GetEnv\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u6587\u4ef6\u89c4\u6a21\uff1a246 \u884c \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 ANI \u7684 VM \u7ea7 API\uff08\u7c7b\u4f3c JNI \u7684 <code>JNI_CreateJavaVM</code> + attach/detach/getEnv\uff09\uff1a - <code>ANI_CreateVM</code>\uff1a\u89e3\u6790 options \u2192 \u521d\u59cb\u5316 logger \u2192 \u521b\u5efa Runtime \u2192\uff08\u53ef\u9009\uff09\u521b\u5efa main interop context \u2192 \u8fd4\u56de <code>ani_vm*</code> - <code>ANI_GetCreatedVMs</code>\uff1a\u8fd4\u56de\u5f53\u524d\u7ebf\u7a0b\u5173\u8054\u7684 VM\uff080 \u6216 1\uff09 - <code>DestroyVM</code>\uff1a\u9500\u6bc1 runtime \u6216\u5b50 VM - <code>GetEnv</code>\uff1a\u4ece\u5f53\u524d thread/coroutine \u53d6\u51fa <code>ani_env*</code>\uff08\u5373 <code>PandaEtsNapiEnv</code>\uff09 - <code>AttachCurrentThread/DetachCurrentThread</code>\uff1a\u628a\u7ebf\u7a0b attach \u6210\u201cexclusive worker coroutine\u201d\uff0c\u5e76\u5904\u7406 interop JS env \u751f\u547d\u5468\u671f</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#0-includes-aniruntimeinterop-l16l29","title":"0. includes\uff1a\u8fd9\u91cc\u628a ANI/Runtime/Interop \u4e09\u6761\u94fe\u4e32\u8d77\u6765\uff08L16\u2013L29\uff09","text":"<ul> <li>L17\u2013L18\uff1a<code>ani_options_parser.h</code> / <code>ani_options.h</code>\uff1aCreateVM/Attach \u89e3\u6790 ANI options\u3002</li> <li>L19\u2013L21\uff1acompiler/logger options\uff1a\u8bf4\u660e ANI options \u53ef\u4ee5\u5f71\u54cd\u7f16\u8bd1\u5668\u65e5\u5fd7\u7ec4\u4ef6\uff08\u901a\u5e38\u7528\u4e8e JIT/\u7f16\u8bd1\u8def\u5f84\u8c03\u8bd5\uff09\u3002</li> <li>L22\u2013L23\uff1a<code>ani_checkers.h</code>\u3001<code>ani_interaction_api.h</code>\uff1a<code>ANI_CHECK_*</code> \u5b8f\u4e0e version \u652f\u6301\u68c0\u67e5\u6765\u81ea interaction api\u3002</li> <li>L24\u2013L25\uff1a<code>ets_coroutine.h</code>\u3001<code>ets_vm.h</code>\uff1a\u7ebf\u7a0b attach \u7684\u6838\u5fc3\u5bf9\u8c61\u3002</li> <li>L26\uff1a<code>interop_context_api.h</code>\uff1a\u4e3b\u7ebf\u7a0b interop context \u521b\u5efa\u5165\u53e3\uff08\u7f16\u8bd1\u6761\u4ef6 <code>PANDA_ETS_INTEROP_JS</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#1-c-abiani_createvml31l74","title":"1. C ABI\uff1a<code>ANI_CreateVM</code>\uff08L31\u2013L74\uff09","text":"<ul> <li>L33\uff1a\u53c2\u6570\u6821\u9a8c\uff1a<code>result != nullptr</code>\u3002</li> <li>L34\u2013L36\uff1a\u7248\u672c\u6821\u9a8c\uff1a<code>ani::IsVersionSupported(version)</code>\u3002</li> <li>L38\u2013L45\uff1a\u89e3\u6790 options + \u521d\u59cb\u5316 logger\uff1a</li> <li><code>OptionsParser parser; errMsg = parser.Parse(options)</code></li> <li><code>Logger::Initialize(parser.GetLoggerOptions(), aniOptions.GetLoggerCallback())</code></li> <li>\u82e5 parse \u51fa\u9519 \u2192 \u65e5\u5fd7\u8bb0\u5f55\u5e76\u8fd4\u56de <code>ANI_ERROR</code></li> <li>L46\uff1a\u540c\u6b65 compiler logger \u7ec4\u4ef6\u3002</li> <li>L48\u2013L51\uff1a<code>Runtime::Create(runtimeOptions)</code>\uff1a\u521b\u5efa runtime\uff0c\u5931\u8d25\u8fd4\u56de error\u3002</li> <li>L53\u2013L64\uff1ainterop JS\uff08\u53ef\u9009\u7f16\u8bd1\uff09\uff1a</li> <li>\u82e5 <code>aniOptions.IsInteropMode()</code>\uff1a\u8c03\u7528 <code>interop::js::CreateMainInteropContext(coroutine, aniOptions.GetInteropEnv())</code></li> <li>\u5931\u8d25\u5219 <code>Runtime::Destroy()</code> \u5e76\u8fd4\u56de error\uff08\u907f\u514d\u534a\u521d\u59cb\u5316\uff09</li> <li>L66\u2013L68\uff1a\u8fd4\u56de <code>ani_vm*</code>\uff1a<code>*result = coroutine-&gt;GetPandaVM()</code></li> <li>L69\u2013L73\uff1a\u8f93\u51fa\u56fa\u5b9a\u65e5\u5fd7 <code>\"ani_vm has been created\"</code>\uff08\u6ce8\u91ca\u6307\u51fa\u6d4b\u8bd5\u4f9d\u8d56\u8be5\u6587\u672c\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#2-ani_getcreatedvms-vm-l77l100","title":"2. <code>ANI_GetCreatedVMs</code>\uff1a\u5f53\u524d\u7ebf\u7a0b\u89c6\u89d2\u7684 VM \u679a\u4e3e\uff08L77\u2013L100\uff09","text":"<ul> <li>\u82e5 <code>Thread::GetCurrent()==nullptr</code>\uff1a\u8bf4\u660e\u7ebf\u7a0b\u672a attach \u2192 \u8fd4\u56de 0 \u4e2a VM\u3002</li> <li>\u5426\u5219\u53d6 <code>EtsCoroutine::GetCurrent()</code>\uff1a</li> <li>coro \u5b58\u5728\uff1a\u8981\u6c42 buffer length &gt;= 1\uff0c\u7136\u540e\u5199\u5165 <code>coroutine-&gt;GetPandaVM()</code>\uff0c<code>*result = 1</code></li> <li>coro \u4e0d\u5b58\u5728\uff1a\u8fd4\u56de 0</li> </ul> <p>\u8fd9\u518d\u6b21\u4f53\u73b0\u201c\u7ebf\u7a0b attach\u201d\u540e\u624d\u5141\u8bb8\u628a thread \u89c6\u4e3a\u5728 VM \u5185\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#3-destroyvm-runtime-vml104l124","title":"3. <code>DestroyVM</code>\uff1a\u9500\u6bc1 runtime \u6216\u5b50 VM\uff08L104\u2013L124\uff09","text":"<ul> <li>L109\u2013L113\uff1a\u6ca1\u6709 current runtime \u5219\u65e0\u6cd5\u9500\u6bc1\uff08\u8fd4\u56de ANI_ERROR\uff09\u3002</li> <li>L115\u2013L121\uff1a\u533a\u5206\uff1a</li> <li>\u82e5 <code>pandaVm == runtime-&gt;GetPandaVM()</code>\uff1a\u9500\u6bc1\u6574\u4e2a Runtime\uff08<code>Runtime::Destroy()</code>\uff09</li> <li>\u5426\u5219\uff1a\u9500\u6bc1\u8be5 <code>PandaEtsVM</code>\uff08<code>PandaEtsVM::Destroy(pandaVm)</code>\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#4-getenvani_vm-ani_envl126l152","title":"4. <code>GetEnv</code>\uff1a<code>ani_vm*</code> \u2192 \u5f53\u524d <code>ani_env*</code>\uff08L126\u2013L152\uff09","text":"<ul> <li>\u6821\u9a8c vm/result/version\u3002</li> <li>L136\u2013L140\uff1a<code>Thread::GetCurrent()</code> \u5fc5\u987b\u975e\u7a7a\uff08\u7ebf\u7a0b\u5df2 attach\uff09\u3002</li> <li>L142\u2013L146\uff1a<code>EtsCoroutine::GetCurrent()</code> \u5fc5\u987b\u975e\u7a7a\uff08\u7ebf\u7a0b attach \u540e\u5e94\u6709\u5f53\u524d coroutine\uff09\u3002</li> <li>L147\u2013L151\uff1a<code>env = coro-&gt;GetEtsNapiEnv()</code>\uff0c\u65ad\u8a00\u975e\u7a7a\u5e76\u8fd4\u56de\u3002   \u5bf9\u5e94\u5b9e\u73b0\uff1a<code>PandaEtsNapiEnv</code>\uff08\u89c1 <code>ets_napi_env.*</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#5-attachcurrentthread-attach-worker-coroutinel154l201","title":"5. <code>AttachCurrentThread</code>\uff1a\u628a\u7ebf\u7a0b attach \u6210 worker coroutine\uff08L154\u2013L201\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#51-attach-l161l165","title":"5.1 \u7ebf\u7a0b attach \u524d\u7f6e\uff08L161\u2013L165\uff09","text":"<ul> <li>\u82e5 <code>Thread::GetCurrent()!=nullptr</code>\uff1a\u8bf4\u660e\u5df2 attach\uff0c\u76f4\u63a5\u62a5\u9519\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#52-interop-l166l179","title":"5.2 interop \u9009\u9879\u89e3\u6790\uff08L166\u2013L179\uff09","text":"<ul> <li>\u904d\u5386 <code>options-&gt;options</code>\uff1a</li> <li><code>\"--interop=enable\"</code>\uff1a\u8bbe\u7f6e <code>interopEnabled=true</code>\uff0c\u5e76\u4ece <code>option.extra</code> \u83b7\u53d6 <code>jsEnv</code></li> <li><code>\"--interop=disable\"</code>\uff1a\u5173\u95ed interop</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#53-exclusive-worker-coroutinel180l190","title":"5.3 \u521b\u5efa exclusive worker coroutine\uff08L180\u2013L190\uff09","text":"<ul> <li>\u53d6 <code>runtime/current etsVM/coroutineManager</code></li> <li><code>CreateExclusiveWorkerForThread(runtime, etsVM)</code>\uff1a\u4e3a\u5f53\u524d thread \u521b\u5efa\u4e13\u7528 worker coroutine</li> <li>\u5931\u8d25\u8bf4\u660e\u8fbe\u5230 EAWorkers \u4e0a\u9650 \u2192 \u8fd4\u56de error</li> <li>\u6210\u529f\u540e\u65ad\u8a00 <code>exclusiveCoro == Coroutine::GetCurrent()</code></li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#54-interop-ctx-l191l198","title":"5.4 interop ctx \u521b\u5efa\uff08L191\u2013L198\uff09","text":"<ul> <li>\u4ece main thread \u7684 <code>ExternalIfaceTable</code> \u53d6\u56de\u8c03\u8868\uff1a</li> <li><code>ifaceTable = mainThread-&gt;GetExternalIfaceTable()</code></li> <li>\u82e5 <code>jsEnv==nullptr</code>\uff1a\u901a\u8fc7 <code>ifaceTable-&gt;CreateJSRuntime()</code> \u521b\u5efa</li> <li><code>ifaceTable-&gt;CreateInteropCtx(exclusiveCoro, jsEnv)</code>\uff1a\u628a interop ctx \u7ed1\u5b9a\u5230\u8be5 worker coroutine</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#55-ani_envl199l200","title":"5.5 \u8fd4\u56de <code>ani_env*</code>\uff08L199\u2013L200\uff09","text":"<ul> <li><code>*result = PandaEtsNapiEnv::GetCurrent()</code>\uff1aenv \u662f coroutine-local\uff0c\u56e0\u6b64\u5728\u521b\u5efa worker coro \u540e\u624d\u53ef\u53d6 current env\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#6-detachcurrentthread-worker-coroutine-js-envl203l227","title":"6. <code>DetachCurrentThread</code>\uff1a\u9500\u6bc1 worker coroutine + \u6e05\u7406 JS env\uff08L203\u2013L227\uff09","text":"<ul> <li>\u8981\u6c42\u7ebf\u7a0b\u5df2 attach\uff08<code>Thread::GetCurrent()!=nullptr</code>\uff09\u3002</li> <li>\u5148\u4ece main thread \u7684 <code>ExternalIfaceTable</code> \u53d6 <code>jsEnv = ifaceTable-&gt;GetJSEnv()</code>\u3002</li> <li><code>coroMan-&gt;DestroyExclusiveWorker()</code>\uff1a\u9500\u6bc1\u5f53\u524d thread \u7684 worker coroutine\u3002</li> <li>\u82e5 <code>jsEnv != nullptr</code>\uff1a<code>ifaceTable-&gt;CleanUpJSEnv(jsEnv)</code>\uff08\u5916\u90e8 runtime \u6e05\u7406\uff09\u3002</li> <li>\u82e5 destroy \u5931\u8d25 \u2192 \u8fd4\u56de error\uff1b\u6210\u529f\u5219\u65ad\u8a00 <code>Thread::GetCurrent()==nullptr</code>\u3002</li> </ul> <p>\u6ce8\u610f\u987a\u5e8f\uff1a\u5148\u62ff\u5230 jsEnv\uff0c\u518d destroy worker\u3002\u8fd9\u6837\u4e0d\u4f1a\u5728 coroutine \u5df2\u9500\u6bc1\u540e\u518d\u901a\u8fc7 coroutine-local \u72b6\u6001\u53d6 jsEnv\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.cpp/#7-__ani_vm_api-getvmapil229l246","title":"7. <code>__ani_vm_api</code> \u8868\u4e0e <code>GetVMAPI</code>\uff08L229\u2013L246\uff09","text":"<ul> <li>L230\u2013L239\uff1a<code>VM_API</code> \u7684\u51fd\u6570\u6307\u9488\u8868\u628a\u5916\u90e8 ABI \u4e0e\u672c\u6587\u4ef6\u7684\u9759\u6001\u51fd\u6570\u7ed1\u5b9a\u3002</li> <li>L242\u2013L245\uff1a<code>GetVMAPI()</code> \u8fd4\u56de <code>&amp;VM_API</code>\uff1a\u5178\u578b\u201c\u9759\u6001\u8868 + \u6307\u9488\u5bfc\u51fa\u201d\u6a21\u5f0f\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.h/","title":"<code>plugins/ets/runtime/ani/ani_vm_api.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e ANI VM API \u7684\u5bfc\u51fa\u5165\u53e3\uff1a<code>ark::ets::ani::GetVMAPI()</code>\u3002 \u8be5\u51fd\u6570\u8fd4\u56de\u6307\u5411\u5916\u90e8 ABI \u7ed3\u6784\u4f53 <code>__ani_vm_api</code> \u7684\u6307\u9488\uff0c\u4f9b C \u4fa7\u901a\u8fc7\u51fd\u6570\u6307\u9488\u8868\u8c03\u7528 <code>DestroyVM/GetEnv/Attach/Detach</code> \u7b49\u64cd\u4f5c\uff08\u5b9a\u4e49\u89c1 <code>ani_vm_api.cpp</code>\uff09\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.h/#1-abi-l19","title":"1. \u5916\u90e8 ABI \u524d\u7f6e\u58f0\u660e\uff08L19\uff09","text":"<ul> <li>L19\uff1a<code>struct __ani_vm_api;</code>   \u6ce8\u91ca\u8bf4\u660e\u8fd9\u662f\u6765\u81ea\u5916\u90e8 header \u7684\u63a5\u53e3\u7c7b\u578b\uff1b\u672c\u4ed3\u5e93\u53ea\u505a\u524d\u7f6e\u58f0\u660e\u4ee5\u907f\u514d\u5f15\u5165\u5916\u90e8\u5934\u5bfc\u81f4 ABI \u6c61\u67d3\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ani_ani_vm_api.h/#2-l21l23","title":"2. \u5bf9\u5916\u5bfc\u51fa\u51fd\u6570\uff08L21\u2013L23\uff09","text":"<ul> <li>L21\u2013L23\uff1a<code>const __ani_vm_api *GetVMAPI();</code>   \u8bed\u4e49\uff1a\u8fd4\u56de\u9759\u6001\u8868\u5730\u5740\uff08\u901a\u5e38\u662f <code>static const __ani_vm_api VM_API = {...}</code> \u7684\u5730\u5740\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/","title":"<code>plugins/ets/runtime/ets_napi_env.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>PandaEtsNapiEnv</code> \u7684\u6784\u5efa\u3001\u83b7\u53d6\u5f53\u524d env\u3001\u5f15\u7528\u5b58\u50a8\u521d\u59cb\u5316\uff0c\u4ee5\u53ca\u5f02\u5e38\u6865\u63a5\u4e0e cleanup\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#0-includes-interaction-apil16l22","title":"0. includes\uff1a\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u76f4\u63a5\u4f9d\u8d56 interaction API\uff08L16\u2013L22\uff09","text":"<ul> <li>L17\uff1a<code>ani_interaction_api.h</code>\uff1a\u666e\u901a\u6a21\u5f0f\u7684 ANI C API \u8868\u6765\u6e90\uff08<code>ani::GetInteractionAPI()</code>\uff09\u3002</li> <li>L18\uff1a<code>verify_ani_interaction_api.h</code>\uff1averify \u6a21\u5f0f\u7684 C API \u8868\u6765\u6e90\uff08<code>ani::verify::GetVerifyInteractionAPI()</code>\uff09\u3002</li> <li>L20\u2013L21\uff1a<code>ets_coroutine.h</code> / <code>ets_vm.h</code>\uff1aenv \u7684\u6838\u5fc3\u7ed1\u5b9a\u5bf9\u8c61\u3002</li> </ul> <p>\u5173\u952e\u70b9\uff1a<code>PandaEtsNapiEnv</code> \u7684 <code>ani_env::c_api</code> \u5728\u6784\u9020\u65f6\u5c31\u88ab\u786e\u5b9a\uff08\u5e76\u53ef\u80fd\u88ab\u66ff\u6362\u4e3a verify \u8868\uff09\uff0c\u8fd9\u662f\u6574\u4e2a ANI \u8c03\u7528\u5206\u53d1\u7684\u201c\u5f00\u5173\u201d\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#1-create-env-reference-storage-referencestoragel24l39","title":"1. <code>Create</code>\uff1a\u5206\u914d env + reference storage\uff0c\u5e76\u521d\u59cb\u5316\u5e95\u5c42 ReferenceStorage\uff08L24\u2013L39\uff09","text":"<ul> <li>L27\uff1a\u53d6 VM\uff1a<code>etsVm = coroutine-&gt;GetVM()</code>\uff08\u6ce8\u610f\u8fd9\u662f ETS VM/\u8bed\u8a00\u5c42\u5bf9\u8c61\uff09\u3002</li> <li>L28\uff1a\u6784\u5efa <code>EtsReferenceStorage</code>\uff1a</li> <li>\u53c2\u6570\u5305\u542b <code>etsVm-&gt;GetGlobalObjectStorage()</code>\uff08\u5168\u5c40\u5bf9\u8c61\u5b58\u50a8\uff09\u4e0e <code>allocator</code></li> <li>\u6700\u540e\u4e00\u4e2a <code>false</code>\uff1a\u901a\u5e38\u8868\u793a\u201c\u662f\u5426\u4e3a weak/\u6216\u67d0\u79cd\u6a21\u5f0f\u201d\uff0c\u9700\u7ed3\u5408 <code>EtsReferenceStorage</code> \u5b9a\u4e49\u7406\u89e3</li> <li>L29\u2013L31\uff1a\u82e5\u5206\u914d\u5931\u8d25\u6216\u5e95\u5c42 <code>ReferenceStorage::Init()</code> \u5931\u8d25 \u2192 \u8fd4\u56de <code>Unexpected(\"Cannot allocate EtsReferenceStorage\")</code>\u3002</li> <li>L33\u2013L36\uff1a\u7528 allocator <code>New&lt;PandaEtsNapiEnv&gt;</code> \u5206\u914d env\uff1b\u5931\u8d25\u8fd4\u56de\u9519\u8bef\u3002</li> <li>L38\uff1a\u6210\u529f\u8fd4\u56de <code>Expected&lt;PandaEtsNapiEnv*, const char*&gt;(ptr)</code>\u3002</li> </ul> <p>\u8fd9\u91cc\u7528 <code>Expected/Unexpected</code> \u800c\u4e0d\u662f\u5f02\u5e38/\u8fd4\u56de\u7801\uff0c\u65b9\u4fbf\u5728 <code>ANI_CreateVM/AttachCurrentThread</code> \u94fe\u8def\u4e2d\u628a\u9519\u8bef\u6587\u672c\u4e00\u8def\u56de\u4f20\u5230 C API \u5c42\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#2-getcurrentenv-tls-l41l46","title":"2. <code>GetCurrent</code>\uff1aenv \u7684 TLS \u8bed\u4e49\uff08L41\u2013L46\uff09","text":"<ul> <li>L43\u2013L45\uff1a\u901a\u8fc7 <code>EtsCoroutine::GetCurrent()</code> \u627e\u5230\u5f53\u524d coroutine\uff0c\u7136\u540e <code>coro-&gt;GetEtsNapiEnv()</code>\u3002   \u7ed3\u8bba\uff1a\u5728 ETS \u8bbe\u8ba1\u91cc\uff0cani_env \u662f coroutine-local\uff0c\u4e0d\u662f\u7eaf thread-local\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#3-c_api-vs-verifyl48l56","title":"3. \u6784\u9020\u51fd\u6570\uff1a\u51b3\u5b9a <code>c_api</code> \u8868\uff08\u666e\u901a vs verify\uff09\uff08L48\u2013L56\uff09","text":"<ul> <li>L48\u2013L50\uff1a\u57fa\u7c7b\u521d\u59cb\u5316\uff1a<code>ani_env {ani::GetInteractionAPI()}</code>\uff0c\u9ed8\u8ba4\u7ed1\u5b9a\u201c\u666e\u901a interaction API \u8868\u201d\u3002</li> <li>L51\uff1a\u82e5 <code>coroutine-&gt;GetPandaVM()-&gt;IsVerifyANI()</code>\uff1a</li> <li>L52\uff1a\u53d6\u5168\u5c40 <code>ANIVerifier</code>\uff1a<code>GetEtsVM()-&gt;GetANIVerifier()</code></li> <li>L53\uff1a\u521b\u5efa <code>EnvANIVerifier(verifier, c_api)</code>\uff1a\u628a\u201c\u539f\u59cb c_api \u8868\u201d\u4f20\u5165\uff0c\u4ee5\u4fbf wrapper \u53ef\u5728\u6821\u9a8c\u540e\u8f6c\u53d1\u771f\u5b9e\u5b9e\u73b0</li> <li>L54\uff1a\u628a <code>c_api</code> \u66ff\u6362\u6210 verify \u7248\u672c\uff1a<code>ani::verify::GetVerifyInteractionAPI()</code></li> </ul> <p>\u8fd9\u5c31\u662f verify \u673a\u5236\u7684\u6838\u5fc3\uff1a - <code>EnvANIVerifier</code> \u4fdd\u5b58\u539f\u59cb\u8868\uff08\u771f\u5b9e\u5b9e\u73b0\uff09 - <code>c_api</code> \u6362\u6210 verify \u8868\uff08\u5165\u53e3\u53d8\u4e3a\u6821\u9a8c\u5668\uff09 \u56e0\u6b64\u540e\u7eed\u6240\u6709\u7ecf\u7531 <code>ani_env*</code> \u7684\u8c03\u7528\u90fd\u4f1a\u5148\u8fdb\u5165 verify wrapper\uff0c\u518d\u7531 verifier \u51b3\u5b9a\u662f\u5426/\u5982\u4f55\u8c03\u7528\u771f\u5b9e\u5b9e\u73b0\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#4-vm-l58l61","title":"4. VM \u8bbf\u95ee\uff08L58\u2013L61\uff09","text":"<ul> <li>L58\u2013L61\uff1a<code>GetEtsVM()</code> \u4ece coroutine \u8fd4\u56de <code>PandaVM</code>\uff08ETS VM \u7684 runtime \u5bb9\u5668\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#5-l63l76","title":"5. \u5f15\u7528\u5b58\u50a8\u7684\u751f\u547d\u5468\u671f\u64cd\u4f5c\uff08L63\u2013L76\uff09","text":"<ul> <li>L63\u2013L66\uff1a<code>FreeInternalMemory()</code>\uff1a\u76f4\u63a5 <code>reset()</code> referenceStorage\uff08\u91ca\u653e\u5185\u90e8\u5185\u5b58\uff09\u3002</li> <li>L68\u2013L71\uff1a<code>CleanUp()</code>\uff1a\u8c03\u7528 <code>referenceStorage_-&gt;CleanUp()</code>\uff08\u901a\u5e38\u7528\u4e8e detach/thread exit\uff09\u3002</li> <li>L73\u2013L76\uff1a<code>ReInitialize()</code>\uff1a<code>referenceStorage_-&gt;ReInitialize()</code>\uff08\u901a\u5e38\u7528\u4e8e\u91cd\u590d attach/\u73af\u5883\u590d\u7528\u573a\u666f\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.cpp/#6-coroutinel78l99","title":"6. \u5f02\u5e38\u6865\u63a5\u5230 coroutine\uff08L78\u2013L99\uff09","text":"<ul> <li>SetException/ClearException/GetThrowable \u90fd\u4f1a\uff1a</li> <li>ASSERT_MANAGED_CODE()\uff1a\u8981\u6c42\u5904\u4e8e managed \u72b6\u6001\uff08\u901a\u5e38\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u5df2 attach \u4e14\u5904\u4e8e\u5141\u8bb8\u64cd\u4f5c VM \u7684\u72b6\u6001\uff09\u3002</li> <li>\u901a\u8fc7 <code>coroutine_</code> \u8f6c\u53d1\u5230\u5e95\u5c42\u5f02\u5e38\u69fd\uff1a<ul> <li><code>SetException(thr-&gt;GetCoreType())</code></li> <li><code>GetException()</code> \u5e76 reinterpret_cast \u56de <code>EtsThrowable*</code></li> <li><code>ClearException()</code></li> </ul> </li> <li>L90\u2013L93\uff1a<code>HasPendingException()</code> \u4e0d\u8981\u6c42 managed assert\uff08\u53ef\u7528\u4e8e\u5feb\u901f\u68c0\u67e5\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/","title":"<code>plugins/ets/runtime/ets_napi_env.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 ETS \u4fa7\u7684 <code>ani_env</code> \u5b9e\u4f8b\u2014\u2014<code>PandaEtsNapiEnv</code>\u3002\u5b83\u662f native \u2194 VM \u7684\u5173\u952e\u201c\u73af\u5883\u5bf9\u8c61\u201d\uff0c\u7ed1\u5b9a\uff1a - \u5f53\u524d <code>EtsCoroutine</code> - <code>EtsReferenceStorage</code>\uff08\u8de8\u8fb9\u754c\u5f15\u7528\u751f\u547d\u5468\u671f\uff09 - \u53ef\u9009 <code>EnvANIVerifier</code>\uff08\u5f53\u542f\u7528 VerifyANI \u65f6\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#0-includesl19l22","title":"0. includes\uff08L19\u2013L22\uff09","text":"<ul> <li>L19\uff1a<code>ani.h</code>\uff1a\u58f0\u660e <code>ani_env</code> \u4e0e C API \u8868\u7ed3\u6784\uff08<code>ani_env::c_api</code>\uff09\u3002</li> <li>L20\uff1a<code>env_ani_verifier.h</code>\uff1aEnv \u7ea7 verifier\uff0c\u7528\u4e8e\u5728 verify \u6a21\u5f0f\u4e0b\u5305\u88c5/\u6821\u9a8c API \u8c03\u7528\u3002</li> <li>L21\uff1a<code>ets_reference.h</code>\uff1a\u5f15\u7528\u5b58\u50a8\uff08<code>EtsReferenceStorage</code>\uff09\u4e0e allocator \u76f8\u5173\u5b9a\u4e49\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#1-l25l28","title":"1. \u7c7b\u578b\u524d\u7f6e\u4e0e\u522b\u540d\uff08L25\u2013L28\uff09","text":"<ul> <li>L25\u2013L26\uff1a\u524d\u7f6e\u58f0\u660e <code>EtsCoroutine</code>\u3001<code>PandaEtsVM</code>\uff0c\u907f\u514d\u5934\u6587\u4ef6\u4e92\u76f8 include\u3002</li> <li>L27\uff1a<code>EtsThrowable = EtsObject</code>\uff1aETS \u4fa7\u628a throwable \u89c6\u4e3a\u5bf9\u8c61\uff08\u7531\u8bed\u8a00\u4e0a\u4e0b\u6587\u5b9a\u4e49\u771f\u5b9e\u8bed\u4e49\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#2-pandaetsnapienvani_env-c-l29l81","title":"2. <code>PandaEtsNapiEnv</code>\uff1aani_env \u7684 C++ \u5b9e\u73b0\uff08L29\u2013L81\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#21-envl31l34","title":"2.1 \u521b\u5efa\u4e0e\u83b7\u53d6\u5f53\u524d env\uff08L31\u2013L34\uff09","text":"<ul> <li>L31\u2013L32\uff1a<code>Create(coroutine, allocator)</code>\uff1a\u4ee5 <code>InternalAllocator</code> \u5206\u914d env \u4e0e\u5176 <code>EtsReferenceStorage</code>\uff1b\u8fd4\u56de <code>Expected&lt;*, const char*&gt;</code> \u4ee5\u643a\u5e26\u9519\u8bef\u5b57\u7b26\u4e32\u3002</li> <li>L33\uff1a<code>GetCurrent()</code>\uff1a\u4ece TLS/\u5f53\u524d coroutine \u83b7\u53d6 env\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#22-l35l48-l77l81","title":"2.2 \u751f\u547d\u5468\u671f\u4e0e\u6838\u5fc3\u7ed1\u5b9a\uff08L35\u2013L48, L77\u2013L81\uff09","text":"<ul> <li>L35\uff1a\u6784\u9020\u51fd\u6570\u63a5\u6536 <code>coroutine</code> \u4e0e <code>referenceStorage</code>\uff08unique_ptr\uff09\uff0c\u628a env \u4e0e coroutine \u751f\u547d\u5468\u671f\u7ed1\u5b9a\u3002</li> <li>L38\u2013L41\uff1a<code>GetEtsCoroutine()</code>\uff1a\u663e\u5f0f\u66b4\u9732\u7ed1\u5b9a\u7684 coroutine\u3002</li> <li>L43\uff1a<code>GetEtsVM()</code>\uff1a\u901a\u8fc7 coroutine \u5f97\u5230 VM\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09\u3002</li> <li>L45\u2013L48\uff1a<code>GetEtsReferenceStorage()</code>\uff1aenv \u66b4\u9732\u5f15\u7528\u5b58\u50a8\uff0c\u4f9b ANI/Interop \u903b\u8f91\u4f7f\u7528\u3002</li> <li>L78\u2013L80\uff1a\u6210\u5458\uff1a</li> <li><code>coroutine_</code></li> <li><code>referenceStorage_</code></li> <li><code>envANIVerifier_</code>\uff08\u4ec5 verify \u6a21\u5f0f\u4e0b\u975e\u7a7a\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#23-ani_env-pandaetsnapienv-l50l53","title":"2.3 <code>ani_env*</code> \u2194 <code>PandaEtsNapiEnv*</code> \u7684\u6865\uff08L50\u2013L53\uff09","text":"<ul> <li>L50\u2013L53\uff1a<code>FromAniEnv(ani_env*)</code>\uff1a\u9759\u6001 downcast helper\u3002   \u8fd9\u662f\u6574\u4e2a native bridge \u7684\u5e38\u89c1\u6a21\u5f0f\uff1aC ABI \u7528 <code>ani_env*</code>\uff0c\u5185\u90e8\u5b9e\u73b0\u9700\u8981\u56de\u5230 C++ \u7c7b\u578b\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#24-verifyanienv-verifierl55l64","title":"2.4 VerifyANI\uff1aenv \u7ea7 verifier\uff08L55\u2013L64\uff09","text":"<ul> <li>L55\u2013L58\uff1a<code>IsVerifyANI()</code>\uff1a\u7528 <code>envANIVerifier_ != nullptr</code> \u5224\u65ad\u5f53\u524d env \u662f\u5426\u5904\u4e8e verify \u6a21\u5f0f\u3002</li> <li>L60\u2013L64\uff1a<code>GetEnvANIVerifier()</code>\uff1a\u8981\u6c42\u975e\u7a7a\u5e76\u8fd4\u56de\u6307\u9488\u3002   \u5178\u578b\u7528\u9014\uff1a\u5728 verify \u4ee3\u7801\u8def\u5f84\u4e2d\u8bb0\u5f55/\u6821\u9a8c\u5f15\u7528\u3001\u53c2\u6570\u3001\u7ebf\u7a0b\u72b6\u6001\u7b49\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_napi_env.h/#25-apil66l73","title":"2.5 \u5f02\u5e38/\u5f15\u7528/\u6e05\u7406 API\uff08L66\u2013L73\uff09","text":"<p>\u8fd9\u4e9b\u65b9\u6cd5\u662f \u201cnative \u8fb9\u754c\u5e38\u7528\u80fd\u529b\u201d \u7684\u6700\u5c0f\u96c6\u5408\uff1a</p> <ul> <li>\u5f02\u5e38\u6865\u63a5\uff1a<code>SetException/GetThrowable/HasPendingException/ClearException</code></li> <li>\u8d44\u6e90\u6e05\u7406\uff1a<code>FreeInternalMemory/CleanUp/ReInitialize</code>\uff08\u4e3b\u8981\u9488\u5bf9 reference storage \u7684\u5185\u5b58/\u53e5\u67c4\u751f\u547d\u5468\u671f\uff09</li> </ul> <p>\u8fd9\u4e9b API \u7684\u5b9e\u73b0\u90fd\u5728 <code>ets_napi_env.cpp</code>\uff0c\u5e76\u4e14\u591a\u6570\u4f1a\u65ad\u8a00\u5904\u4e8e managed code\uff08<code>ASSERT_MANAGED_CODE()</code>\uff09\uff0c\u907f\u514d\u5728\u9519\u8bef\u7ebf\u7a0b/\u72b6\u6001\u4e0b\u64cd\u4f5c VM \u4fa7\u5f02\u5e38\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.cpp/","title":"<code>plugins/ets/runtime/ets_native_library.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>EtsNativeLibrary::Load</code> \u4e0e\u6784\u9020\u51fd\u6570\uff0c\u57fa\u672c\u662f\u5bf9 <code>os::library_loader::Load</code> \u7684\u5f02\u5e38/\u9519\u8bef\u5305\u88c5\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.cpp/#1-etsnativelibraryloadl19l27","title":"1. <code>EtsNativeLibrary::Load</code>\uff08L19\u2013L27\uff09","text":"<ul> <li>L21\uff1a<code>auto handle = os::library_loader::Load(name)</code>\uff1a\u5c1d\u8bd5\u52a0\u8f7d\u52a8\u6001\u5e93\u3002</li> <li>L22\u2013L24\uff1a\u5931\u8d25\u5219 <code>Unexpected(handle.Error())</code>\uff1a\u628a OS \u9519\u8bef\u539f\u6837\u4e0a\u629b\u3002</li> <li>L26\uff1a\u6210\u529f\u5219\u6784\u9020 <code>EtsNativeLibrary(name, std::move(handle.Value()))</code>\u3002</li> </ul> <p>\u4e0a\u5c42 <code>NativeLibraryProvider</code> \u4f1a\u628a\u8fd9\u4e2a <code>os::Error</code> \u8f6c\u4e3a string\uff0c\u5e76\u8fdb\u4e00\u6b65\u51b3\u5b9a\u662f\u5426\u9700\u8981 namespace fallback\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.cpp/#2-name-handlel29l32","title":"2. \u6784\u9020\u51fd\u6570\uff1a\u79fb\u52a8 name \u4e0e handle\uff08L29\u2013L32\uff09","text":"<ul> <li><code>name_</code> \u4e0e <code>handle_</code> \u90fd\u91c7\u7528 move \u8bed\u4e49\uff0c\u786e\u4fdd <code>EtsNativeLibrary</code> \u662f\u4e00\u4e2a\u201c\u62e5\u6709 handle \u6240\u6709\u6743\u201d\u7684\u503c\u7c7b\u578b\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.h/","title":"<code>plugins/ets/runtime/ets_native_library.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5bf9 <code>dlopen/dlsym</code>\uff08\u901a\u8fc7 <code>os::library_loader</code>\uff09\u7684\u8584\u5c01\u88c5\uff1a<code>EtsNativeLibrary</code>\u3002 <code>NativeLibraryProvider</code> \u7528\u5b83\u4f5c\u4e3a <code>libraries_</code> \u96c6\u5408\u5143\u7d20\uff0c\u5b9e\u73b0\uff1a - \u52a0\u8f7d so\uff08<code>Load</code>\uff09 - \u89e3\u6790\u7b26\u53f7\uff08<code>FindSymbol</code>\uff09 - \u4ee5 <code>LibraryHandle</code> \u7684 native handle \u505a\u4e25\u683c\u6392\u5e8f\uff08\u7528\u4e8e <code>PandaSet</code> \u53bb\u91cd/\u7a33\u5b9a\u5b58\u50a8\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.h/#0-includesl19l20","title":"0. includes\uff08L19\u2013L20\uff09","text":"<ul> <li>L19\uff1a<code>PandaString</code>\uff1a\u5e93\u540d\u4e0e\u7b26\u53f7\u540d\u4f7f\u7528 runtime \u81ea\u6709\u5b57\u7b26\u4e32\u7c7b\u578b\u3002</li> <li>L20\uff1a<code>library_loader.h</code>\uff1a\u8de8\u5e73\u53f0\u52a8\u6001\u5e93\u52a0\u8f7d\u4e0e\u7b26\u53f7\u89e3\u6790\u5c01\u88c5\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.h/#1-load-expectedlibrary-oserrorl25","title":"1. <code>Load</code>\uff1a\u8fd4\u56de <code>Expected&lt;Library, os::Error&gt;</code>\uff08L25\uff09","text":"<ul> <li>\u4e0e <code>NativeLibraryProvider</code> \u7684\u9519\u8bef\u5904\u7406\u98ce\u683c\u4e00\u81f4\uff1a\u5931\u8d25\u8fd4\u56de <code>os::Error</code>\uff0c\u4e0a\u5c42\u8f6c\u6210 string \u6216\u7ee7\u7eed\u5904\u7406\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library.h/#2-name-handlel27l51","title":"2. \u6838\u5fc3\u72b6\u6001\uff1aname + handle\uff08L27\u2013L51\uff09","text":"<ul> <li>L27\uff1a\u6784\u9020\u51fd\u6570\u63a5\u6536 <code>name</code> \u4e0e <code>LibraryHandle</code>\uff08\u53f3\u503c\u5f15\u7528\uff09\u4ee5\u8f6c\u79fb\u6240\u6709\u6743\u3002</li> <li>L38\u2013L41\uff1a<code>FindSymbol</code>\uff1a\u8c03\u7528 <code>os::library_loader::ResolveSymbol(handle_, name)</code>\u3002</li> <li>L43\u2013L46\uff1a<code>operator&lt;</code>\uff1a\u6309 <code>handle_.GetNativeHandle()</code> \u6392\u5e8f\u3002   \u8fd9\u610f\u5473\u7740 <code>PandaSet&lt;EtsNativeLibrary&gt;</code> \u7684\u201c\u552f\u4e00\u6027/\u6392\u5e8f\u201d\u662f\u57fa\u4e8e\u771f\u5b9e\u7684 OS handle\uff0c\u800c\u4e0d\u662f\u5e93\u540d\uff1b\u540c\u540d\u5e93\u82e5\u88ab\u4e0d\u540c\u65b9\u5f0f\u52a0\u8f7d\u53ef\u80fd\u4ecd\u662f\u4e0d\u540c handle\uff08\u4f46 provider \u4e0a\u5c42\u4f1a\u6309 name \u505a\u4e00\u6b21\u5e42\u7b49\u53bb\u91cd\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/","title":"<code>plugins/ets/runtime/ets_native_library_provider.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cLoadLibrary/ANI_Constructor/namespace fallback\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>NativeLibraryProvider</code>\uff1a - \u4ece <code>libraryPath_</code> \u6216\u7edd\u5bf9\u8def\u5f84\u52a0\u8f7d so - \u5728 system load \u5931\u8d25\u65f6\uff08\u4e14\u4e0d\u8981\u6c42\u6743\u9650\u6821\u9a8c\uff09\u56de\u9000\u5230\u201c\u5e94\u7528 namespace\u201d\u52a0\u8f7d - \u52a0\u8f7d\u6210\u529f\u540e\u8c03\u7528 <code>ANI_Constructor</code> \u8fdb\u884c\u521d\u59cb\u5316\u4e0e\u7248\u672c\u534f\u5546 - \u63d0\u4f9b\u7b26\u53f7\u89e3\u6790\u4e0e\u8def\u5f84\u7ba1\u7406</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#0-includesnative-bridge-l18l26","title":"0. includes\uff1a\u8fd9\u5c31\u662f\u201cnative bridge \u4e0e\u6267\u884c\u6808/\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\u201d\u4ea4\u6c47\u70b9\uff08L18\u2013L26\uff09","text":"<ul> <li>L22\uff1a<code>ani_interaction_api.h</code>\uff1a\u8868\u660e native load \u4e0e ANI/\u5f02\u5e38/\u7ebf\u7a0b\u72b6\u6001\u53ef\u80fd\u6709\u5173\uff08\u65e5\u5fd7/\u9519\u8bef\u8def\u5f84\uff09\u3002</li> <li>L23\u2013L25\uff1a<code>ets_vm.h</code>\u3001<code>ets_method.h</code>\u3001<code>ets_namespace_manager_impl.h</code>\uff1anamespace \u52a0\u8f7d\u9700\u8981 VM/\u65b9\u6cd5/namespace manager \u7684\u534f\u4f5c\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#1-helpersystem-path-l31l46","title":"1. \u533f\u540d\u547d\u540d\u7a7a\u95f4 helper\uff1asystem path \u641c\u7d22\uff08L31\u2013L46\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#11-loadfrompathpathes-namel31l46","title":"1.1 <code>LoadFromPath(pathes, name)</code>\uff08L31\u2013L46\uff09","text":"<ul> <li>L33\uff1a\u82e5 <code>name</code> \u4e0d\u5305\u542b <code>'/'</code>\uff0c\u624d\u8ba4\u4e3a\u662f\u201c\u5e93\u540d\u201d\u800c\u4e0d\u662f\u8def\u5f84\u3002</li> <li>L34\u2013L44\uff1a\u904d\u5386 <code>pathes</code>\uff0c\u62fc\u63a5 <code>path/name</code> \u5e76\u5c1d\u8bd5 <code>EtsNativeLibrary::Load(...)</code>\u3002</li> <li>L45\uff1a\u6700\u7ec8 fallback\uff1a<code>EtsNativeLibrary::Load(name)</code>\uff08\u53ef\u80fd\u662f\u7edd\u5bf9\u8def\u5f84\u6216\u7cfb\u7edf\u9ed8\u8ba4\u641c\u7d22\u8def\u5f84\uff09\u3002</li> </ul> <p>\u8fd9\u4e2a\u51fd\u6570\u628a \u201c\u5e93\u540d + libraryPath_\u201d \u7684\u641c\u7d22\u7b56\u7565\u96c6\u4e2d\u5c01\u88c5\uff0c\u907f\u514d\u6563\u843d\u5728 <code>LoadLibrary</code> \u4e3b\u6d41\u7a0b\u91cc\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#2-namespace-fallback-app-abcpathl48l71","title":"2. namespace fallback\uff1a\u4ece\u6267\u884c\u6808\u63a8\u5bfc app abcPath\uff08L48\u2013L71\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#21-loadnativelibraryfromnamespacenamel48l71","title":"2.1 <code>LoadNativeLibraryFromNamespace(name)</code>\uff08L48\u2013L71\uff09","text":"<ul> <li>L50\uff1a\u4f7f\u7528 <code>EtsCoroutine::GetCurrent()</code> \u4f5c\u4e3a StackWalker \u7684\u5165\u53e3\uff08\u518d\u6b21\u4f53\u73b0\u201cETS \u4ee5 coroutine \u4e3a\u6267\u884c\u4e3b\u4f53\u201d\uff09\u3002</li> <li>L52\u2013L68\uff1a\u904d\u5386 call stack\uff1a</li> <li>L55\u2013L57\uff1a\u8df3\u8fc7 <code>method-&gt;GetPandaFile()==nullptr</code> \u7684 frame\uff08\u53ef\u80fd\u662f native/\u7279\u6b8a\u5e27\uff09\u3002</li> <li>L58\u2013L63\uff1a\u8bfb\u53d6 <code>method-&gt;GetClass()-&gt;GetLoadContext()</code>\uff0c\u5e76\u6253\u5370\u662f\u5426 boot context\u3002</li> <li>L63\u2013L66\uff1a\u627e\u5230\u7b2c\u4e00\u4e2a \u975e boot context \u7684 frame\uff0c\u5373\u8ba4\u4e3a\u662f\u201c\u5e94\u7528\u4fa7\u8c03\u7528\u70b9\u201d\uff0c\u53d6\u5176 panda file \u7684 <code>GetFullFileName()</code> \u4f5c\u4e3a <code>abcPath</code>\u3002</li> <li>L69\u2013L71\uff1a\u4ea4\u7ed9 <code>EtsNamespaceManagerImpl::LoadNativeLibraryFromNs(abcPath, name)</code>\u3002</li> </ul> <p>\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u5173\u952e\u7684\u5de5\u7a0b\u51b3\u7b56\uff1a \u201c\u5e94\u7528 so \u4ece\u54ea\u4e2a namespace \u52a0\u8f7d\u201d\u4e0d\u662f\u7eaf\u914d\u7f6e\uff0c\u800c\u662f\u4e0e\u5f53\u524d\u6267\u884c\u6808/\u7c7b\u52a0\u8f7d\u4e0a\u4e0b\u6587\u7ed1\u5b9a\u3002 \u8fd9\u4f7f\u5f97\u540c\u540d so \u5728 system \u4e0e app namespace \u4e4b\u95f4\u7684\u9009\u62e9\u66f4\u8d34\u8fd1\u771f\u5b9e\u8c03\u7528\u8bed\u4e49\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#3-loadlibrary-permission-fallback-ctorl74l109","title":"3. <code>LoadLibrary</code>\uff1a\u5e76\u53d1\u53bb\u91cd + permission + fallback + ctor\uff08L74\u2013L109\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#31-l77l88","title":"3.1 \u524d\u7f6e\u68c0\u67e5\u4e0e\u53bb\u91cd\uff08L77\u2013L88\uff09","text":"<ul> <li>L77\uff1a\u8981\u6c42 <code>env != nullptr</code>\u3002</li> <li>L78\u2013L80\uff1a\u82e5 <code>shouldVerifyPermission</code> \u4e14 <code>CheckLibraryPermission</code> \u5931\u8d25 \u2192 \u8fd4\u56de\u9519\u8bef\u5b57\u7b26\u4e32\u3002</li> <li>L81\u2013L88\uff1a\u8bfb\u9501\u4e0b\u68c0\u67e5 <code>libraries_</code> \u662f\u5426\u5df2\u5b58\u5728\u540c\u540d\u5e93\uff0c\u5b58\u5728\u5219\u76f4\u63a5\u6210\u529f\u8fd4\u56de\uff08\u91cd\u590d load \u662f\u5e42\u7b49\u7684\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#32-fallbackl89l97","title":"3.2 \u52a0\u8f7d\u4e0e fallback\uff08L89\u2013L97\uff09","text":"<ul> <li>L89\uff1a\u5c1d\u8bd5 system/path load\uff1a<code>LoadFromPath(GetLibraryPath(), name)</code>\u3002</li> <li>L90\u2013L94\uff1a\u82e5 <code>!shouldVerifyPermission</code> \u4e14\u52a0\u8f7d\u5931\u8d25\uff1a   \u6253 warning\uff0c\u5e76\u5c1d\u8bd5 <code>LoadNativeLibraryFromNamespace(name.c_str())</code>\uff08\u5e94\u7528\u5e93\uff09\u3002</li> <li>L95\u2013L97\uff1a\u4ecd\u5931\u8d25\u5219\u8fd4\u56de <code>os::Error::ToString()</code>\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#33-ctorl98l109","title":"3.3 \u5199\u9501\u63d2\u5165\u4e0e ctor\uff08L98\u2013L109\uff09","text":"<ul> <li>L100\u2013L106\uff1a\u5199\u9501\u4e0b <code>libraries_.emplace(std::move(loadRes.Value()))</code>\uff1a</li> <li>\u82e5\u672a\u63d2\u5165\uff08\u5df2\u5b58\u5728\uff09\uff0c\u76f4\u63a5\u6210\u529f\u8fd4\u56de</li> <li>\u8bb0\u5f55 <code>lib</code> \u6307\u9488\u7528\u4e8e\u540e\u7eed ctor</li> <li>L108\uff1a<code>return CallAniCtor(env, lib)</code>\uff1a\u52a0\u8f7d\u6210\u529f\u540e\u5fc5\u987b\u8dd1 <code>ANI_Constructor</code>\uff08\u9664\u975e\u5e93\u7f3a\u7b26\u53f7\u5219\u8fd4\u56de\u9519\u8bef\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#4-callanictorjni_onload-l111l131","title":"4. <code>CallAniCtor</code>\uff1aJNI_OnLoad \u98ce\u683c\u7684\u7248\u672c\u534f\u5546\uff08L111\u2013L131\uff09","text":"<ul> <li>L113\uff1a\u67e5\u627e\u7b26\u53f7 <code>\"ANI_Constructor\"</code>\uff1a</li> <li>\u627e\u5230\u5219\u6309\u7b7e\u540d\u8c03\u7528\uff1a<code>ani_status (*)(ani_vm*, uint32_t*)</code></li> <li><code>vm</code> \u4ece env \u8f6c\u56de\uff1a<code>PandaEnv::FromAniEnv(env)-&gt;GetEtsVM()</code>\uff08env\u2192VM \u7684\u6807\u51c6\u6865\uff09</li> <li>status \u975e OK \u2192 \u8fd4\u56de\u9519\u8bef</li> <li>version \u4e0d\u652f\u6301\uff08<code>ani::IsVersionSupported(version)</code>\uff09\u2192 \u8fd4\u56de\u9519\u8bef</li> <li>L125\u2013L129\uff1a\u627e\u4e0d\u5230\u7b26\u53f7\u4e5f\u89c6\u4e3a\u9519\u8bef\uff08\u5f3a\u5236\u8981\u6c42 ctor \u5b58\u5728\uff09\uff0c\u5e76\u8bb0\u5f55\u65e5\u5fd7\u3002</li> </ul> <p>\u7ed3\u8bba\uff1aETS native library \u7684\u7ea6\u5b9a\u6bd4 JNI \u66f4\u201c\u786c\u201d\uff1a\u7f3a\u5c11 ctor \u76f4\u63a5\u5931\u8d25\uff0c\u800c\u4e0d\u662f\u53ef\u9009\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#5-ohos-classnamel133l183","title":"5. OHOS \u6743\u9650\u6821\u9a8c\uff1a\u9700\u8981\u8c03\u7528\u65b9 className\uff08L133\u2013L183\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#51-getcallerclassnamel133l157","title":"5.1 <code>GetCallerClassName</code>\uff08L133\u2013L157\uff09","text":"<ul> <li>\u901a\u8fc7 <code>env-&gt;GetEtsCoroutine()</code> \u4e0e <code>StackWalker::Create(coro)</code> \u627e\u5230\u5f53\u524d\u65b9\u6cd5\u5e27\u3002</li> <li>\u8981\u6c42\u8c03\u7528\u70b9\u6765\u81ea boot context\uff08L151\u2013L155\uff09\uff1a\u5426\u5219\u62a5\u9519\u3002   \u76f4\u89c9\uff1a\u53ea\u6709 \u201c\u7cfb\u7edf API\u201d \u6216\u201c\u53d7\u4fe1\u4efb\u8c03\u7528\u70b9\u201d \u624d\u88ab\u5141\u8bb8\u89e6\u53d1\u67d0\u4e9b\u5e93\u52a0\u8f7d\u7b56\u7565\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#52-checklibrarypermissionl159l183","title":"5.2 <code>CheckLibraryPermission</code>\uff08L159\u2013L183\uff09","text":"<ul> <li>\u4ec5\u5728 <code>PANDA_TARGET_OHOS</code> \u4e0b\u751f\u6548\u3002</li> <li>\u901a\u8fc7 <code>EtsNamespaceManagerImpl::GetExtensionApiCheckCallback()</code> \u83b7\u53d6\u56de\u8c03\uff1a</li> <li>\u672a\u6ce8\u518c \u2192 \u5931\u8d25</li> <li>\u56de\u8c03\u8fd4\u56de false \u2192 \u5931\u8d25\u5e76\u6253\u5370 className/fileName</li> <li>\u5426\u5219\u901a\u8fc7\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.cpp/#6-resolvesymbol-l185l216","title":"6. <code>ResolveSymbol</code> \u4e0e\u8def\u5f84\u7ba1\u7406\uff08L185\u2013L216\uff09","text":"<ul> <li><code>ResolveSymbol</code>\uff1a\u8bfb\u9501\u4e0b\u904d\u5386\u6240\u6709\u5df2\u52a0\u8f7d\u5e93\uff0c\u8fd4\u56de\u7b2c\u4e00\u4e2a\u547d\u4e2d\u7684\u7b26\u53f7\u5730\u5740\u3002</li> <li><code>GetLibraryPath/SetLibraryPath/AddLibraryPath</code>\uff1a\u8bfb\u5199\u9501\u4fdd\u62a4 <code>libraryPath_</code>\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.h/","title":"<code>plugins/ets/runtime/ets_native_library_provider.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e <code>NativeLibraryProvider</code> \u2014\u2014 ETS \u7684 native library \u88c5\u8f7d\u5668\u4e0e\u7b26\u53f7\u89e3\u6790\u5668\uff1a - \u7ef4\u62a4 <code>libraryPath_</code> \u641c\u7d22\u8def\u5f84 - \u7ba1\u7406\u5df2\u52a0\u8f7d\u7684 <code>EtsNativeLibrary</code> \u96c6\u5408 - \u63d0\u4f9b <code>LoadLibrary</code>\uff08\u542b\u6743\u9650\u6821\u9a8c/namespace fallback\uff09\u4e0e <code>ResolveSymbol</code></p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.h/#0-includesl19l24","title":"0. includes\uff08L19\u2013L24\uff09","text":"<ul> <li>L20\uff1a<code>RWLock</code>\uff1aprovider \u7684\u6838\u5fc3\u72b6\u6001\uff08libraries/path\uff09\u9700\u8981\u5e76\u53d1\u8bfb\u5199\u4fdd\u62a4\u3002</li> <li>L21\uff1a<code>ani.h</code>\uff1a<code>LoadLibrary</code> \u7684\u5165\u53e3\u53c2\u6570\u662f <code>ani_env*</code>\uff08C ABI\uff09\u3002</li> <li>L22\uff1a<code>ets_native_library.h</code>\uff1a\u771f\u5b9e\u7684 \u201cdlopen/dlsym \u5c01\u88c5\u5bf9\u8c61\u201d\u3002</li> <li>L23\uff1a<code>panda_containers.h</code>\uff1a<code>PandaVector/PandaSet/PandaString</code> \u5bb9\u5668\u4f53\u7cfb\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.h/#1-l26l49","title":"1. \u7c7b\u5b9a\u4e49\uff08L26\u2013L49\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.h/#11-apil34l41","title":"1.1 \u5bf9\u5916 API\uff08L34\u2013L41\uff09","text":"<ul> <li>L34\u2013L35\uff1a<code>LoadLibrary(env, name, shouldVerifyPermission, fileName)</code>   \u8fd4\u56de <code>optional&lt;string&gt;</code>\uff1a\u7a7a\u8868\u793a\u6210\u529f\uff1b\u975e\u7a7a\u5b57\u7b26\u4e32\u8868\u793a\u9519\u8bef\u4fe1\u606f\uff08\u4eba\u7c7b\u53ef\u8bfb\uff09\u3002   \u8fd9\u4e0e <code>ets_napi_env.cpp</code> \u7684 <code>Expected/Unexpected</code> \u601d\u8def\u4e00\u81f4\uff1a\u4f18\u5148\u4f20\u9012\u8bca\u65ad\u6587\u672c\u3002</li> <li>L36\uff1a<code>ResolveSymbol(name)</code>\uff1a\u5728\u5df2\u52a0\u8f7d\u5e93\u96c6\u5408\u4e2d\u67e5\u627e\u7b26\u53f7\uff08dlsym \u98ce\u683c\uff09\u3002</li> <li>L38\u2013L41\uff1alibrary path \u7684 get/set/add\uff0c\u5747\u9700\u9501\u4fdd\u62a4\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_ets_native_library_provider.h/#12-l42l48","title":"1.2 \u79c1\u6709\u5b9e\u73b0\u4e0e\u5e76\u53d1\u63a7\u5236\uff08L42\u2013L48\uff09","text":"<ul> <li>L43\uff1a<code>mutable RWLock lock_</code>\uff1a\u591a\u8bfb\u5c11\u5199\u5178\u578b\u573a\u666f\uff08\u89e3\u6790\u7b26\u53f7/\u83b7\u53d6\u8def\u5f84\u9891\u7e41\uff0c\u52a0\u8f7d\u5e93\u4e0e\u4fee\u6539\u8def\u5f84\u8f83\u5c11\uff09\u3002</li> <li>L44\uff1a<code>CallAniCtor(env, lib)</code>\uff1a\u52a0\u8f7d\u540e\u8c03\u7528 <code>ANI_Constructor</code> \u8fdb\u884c\u521d\u59cb\u5316/\u7248\u672c\u534f\u5546\u3002</li> <li>L45\uff1a<code>GetCallerClassName(env)</code>\uff1a\u6743\u9650\u6821\u9a8c/\u7b56\u7565\u5206\u652f\u9700\u8981\u77e5\u9053\u8c03\u7528\u65b9\uff08\u5178\u578b\u5728 OHOS \u7ea6\u675f\u4e0b\uff09\u3002</li> <li>L46\uff1a<code>CheckLibraryPermission(env, fileName)</code>\uff1a\u5e73\u53f0\u76f8\u5173\u6743\u9650\u68c0\u67e5\uff08OHOS\uff09\u3002</li> <li>L47\u2013L48\uff1a\u6838\u5fc3\u72b6\u6001\uff1a</li> <li><code>libraries_</code>\uff1a\u5df2\u52a0\u8f7d\u5e93\u96c6\u5408\uff08\u6309 <code>EtsNativeLibrary</code> \u7684\u6bd4\u8f83/\u54c8\u5e0c\u7b56\u7565\u53bb\u91cd\uff09</li> <li><code>libraryPath_</code>\uff1a\u641c\u7d22\u8def\u5f84\u5217\u8868</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/","title":"<code>plugins/ets/runtime/external_iface_table.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u8de8\u8fd0\u884c\u65f6\u56de\u8c03\u8868\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9a\u4e49 <code>ExternalIfaceTable</code> \u2014\u2014 ETS runtime \u4e0e\u5916\u90e8 runtime\uff08\u4e3b\u8981\u662f JS runtime/JobQueue\uff09\u4e4b\u95f4\u7684\u63a5\u53e3\u201c\u63d2\u69fd\u8868\u201d\u3002 \u8bbe\u8ba1\u8981\u70b9\uff1a - \u4ee5 <code>std::function</code> \u5b58\u50a8\u56de\u8c03\uff0c\u5141\u8bb8\u5728\u542f\u52a8\u9636\u6bb5\u7531\u5916\u90e8\u6a21\u5757\u6ce8\u5165\u5b9e\u73b0 - JS env \u4ee5 <code>void*</code> \u62bd\u8c61\uff08\u907f\u514d\u628a N-API \u7c7b\u578b\u6e17\u900f\u5230 core runtime\uff09 - \u7531 <code>EtsCoroutine</code>/ANI attach/detach \u5728\u5173\u952e\u65f6\u673a\u8c03\u7528\u8fd9\u4e9b\u56de\u8c03\uff08\u89c1 <code>ani_vm_api.cpp</code>\uff09</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#0-includesl19l23","title":"0. includes\uff08L19\u2013L23\uff09","text":"<ul> <li>L21\uff1a\u4f9d\u8d56 <code>runtime/interpreter/frame.h</code>\uff1a<code>ClearInteropHandleScopesFunction</code> \u9700\u8981\u4ee5 <code>Frame*</code> \u4f5c\u4e3a\u53c2\u6570\uff08\u6e05\u7406 interop handle scopes \u4ee5\u907f\u514d\u8de8\u8fb9\u754c\u6cc4\u6f0f\uff09\u3002</li> <li>L22\uff1a\u4f9d\u8d56 <code>job_queue.h</code>\uff1aJS interop \u76f8\u5173\u4efb\u52a1\u961f\u5217\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#1-js-runtime-l32l38","title":"1. \u7c7b\u578b\u522b\u540d\uff1a\u628a JS runtime \u4f5c\u4e3a\u9ed1\u76d2\uff08L32\u2013L38\uff09","text":"<ul> <li>L32\uff1a<code>using JSEnv = void*</code>\uff1a\u5bf9\u5916\u53ea\u66b4\u9732\u53e5\u67c4\uff0c\u4e0d\u66b4\u9732 JS runtime \u5177\u4f53\u7c7b\u578b\u3002</li> <li>L33\u2013L38\uff1a\u4e94\u7c7b\u56de\u8c03\uff1a</li> <li><code>ClearInteropHandleScopesFunction(Frame*)</code></li> <li><code>CreateJSRuntimeFunction() -&gt; JSEnv</code></li> <li><code>CleanUpJSEnvFunction(JSEnv)</code></li> <li><code>GetJSEnvFunction() -&gt; JSEnv</code></li> <li><code>CreateInteropCtxFunction(Coroutine*, JSEnv)</code>\uff1a\u5728\u67d0\u4e2a coroutine \u4e0a\u7ed1\u5b9a/\u521b\u5efa interop context</li> </ul> <p>\u8fd9\u51e0\u7c7b\u56de\u8c03\u6070\u597d\u8986\u76d6\u4e86 <code>ani_vm_api.cpp</code> \u7684 interop attach/detach \u9700\u6c42\uff1a attach\uff1a\u521b\u5efa js runtime\uff08\u53ef\u9009\uff09+ \u521b\u5efa interop ctx\uff1bdetach\uff1a\u6e05\u7406 js env\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#2-jobqueue-l45l128","title":"2. \u8d44\u6e90\u4e0e\u751f\u547d\u5468\u671f\uff1aJobQueue + \u56de\u8c03\u201c\u53ea\u8bbe\u7f6e\u4e00\u6b21\u201d\uff08L45\u2013L128\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#21-jobqueuel45l53","title":"2.1 JobQueue\uff08L45\u2013L53\uff09","text":"<ul> <li><code>jobQueue_</code> \u5b58\u5728\u5219\u53ef\u88ab <code>GetJobQueue()</code> \u8fd4\u56de\u3002</li> <li><code>SetJobQueue()</code> \u7528 unique_ptr \u8bbe\u7f6e\uff0c\u6240\u6709\u6743\u5f52 <code>ExternalIfaceTable</code>\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#22-assertalready_setl65l81-l108l112","title":"2.2 \u56de\u8c03\u8bbe\u7f6e\uff1aASSERT(!already_set)\uff08L65\u2013L81, L108\u2013L112\uff09","text":"<ul> <li><code>SetCreateJSRuntimeFunction/SetCleanUpJSEnvFunction/SetGetJSEnvFunction/SetCreateInteropCtxFunction</code>   \u90fd\u4f1a\u5148 <code>ASSERT(!xxx_)</code>\uff0c\u8868\u793a\u56de\u8c03\u5e94\u5728\u521d\u59cb\u5316\u9636\u6bb5\u53ea\u8bbe\u7f6e\u4e00\u6b21\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_external_iface_table.h/#23-no-opl83l119","title":"2.3 \u8c03\u7528\u56de\u8c03\uff1a\u5168\u90e8\u662f\u201c\u82e5\u5b58\u5728\u5219\u8c03\u7528\uff0c\u5426\u5219 no-op\u201d\uff08L83\u2013L119\uff09","text":"<ul> <li><code>CreateJSRuntime()</code>\uff1a\u6ca1\u6709\u56de\u8c03\u5219\u8fd4\u56de nullptr\u3002</li> <li><code>CleanUpJSEnv(env)</code>\uff1a\u6ca1\u6709\u56de\u8c03\u5219\u4e0d\u505a\u4efb\u4f55\u4e8b\u3002</li> <li><code>GetJSEnv()</code>\uff1a\u6ca1\u6709\u56de\u8c03\u5219\u8fd4\u56de nullptr\u3002</li> <li><code>CreateInteropCtx(coro, jsEnv)</code>\uff1a\u6ca1\u6709\u56de\u8c03\u5219 no-op\u3002</li> </ul> <p>\u8fd9\u8ba9 ETS runtime \u53ef\u4ee5\u5728 \u6ca1\u6709 interop_js \u7f16\u8bd1\u8fdb\u6765 \u7684\u60c5\u51b5\u4e0b\u4f9d\u7136\u5de5\u4f5c\uff1a \u56de\u8c03\u4e3a\u7a7a\u5373\u8868\u793a\u529f\u80fd\u5173\u95ed\uff0c\u4e0d\u9700\u8981\u5927\u91cf <code>#ifdef</code> \u8d2f\u7a7f\u4e1a\u52a1\u4ee3\u7801\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/","title":"<code>plugins/ets/runtime/interop_js/interop_context.cpp</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5bf9 ANI/ExternalIfaceTable \u53ef\u89c1\u7684\u5173\u952e\u8def\u5f84\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5b9e\u73b0 <code>InteropCtx</code> \u4e0e <code>CreateMainInteropContext</code>\u3002 \u8be5\u6587\u4ef6\u4e5f\u975e\u5e38\u5927\uff1b\u672c\u7ae0\u4ee5 NativeBridge \u89c6\u89d2\u805a\u7126\u4e24\u6761\u95ed\u73af\u4e3b\u7ebf\uff1a</p> <p>1) ANI_CreateVM \u2192 CreateMainInteropContext\uff1a\u4e3b\u7ebf\u7a0b\u521b\u5efa interop ctx\uff0c\u5e76\u628a runtime \u751f\u547d\u5468\u671f\u7ed1\u5b9a\u5230 JS env cleanup hook\uff08hybrid \u6a21\u5f0f\uff09\u3002 2) ExternalIfaceTable \u56de\u8c03\u6ce8\u5165\u70b9\uff1a<code>InteropCtx::InitExternalInterfaces()</code> \u628a \u201cCreateJSRuntime / GetJSEnv / CleanUpJSEnv / CreateInteropCtx / ClearInteropHandleScopes / JobQueue\u201d \u6ce8\u5165\uff0c\u4f9b <code>ani_vm_api.cpp::Attach/Detach</code> \u4e0e\u5f02\u5e38/\u53bb\u4f18\u5316\u8def\u5f84\u8c03\u7528\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#1-interopctxinitexternalinterfaces-interop-l424l469","title":"1. <code>InteropCtx::InitExternalInterfaces</code>\uff1a\u628a interop \u80fd\u529b\u4ee5\u56de\u8c03\u8868\u6ce8\u5165\uff08L424\u2013L469\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#11-jobqueue-interop-handle-scopesl426l429","title":"1.1 JobQueue \u4e0e\u201c\u6e05\u7406 interop handle scopes\u201d\uff08L426\u2013L429\uff09","text":"<ul> <li>L426\uff1a<code>interfaceTable_.SetJobQueue(MakePandaUnique&lt;JsJobQueue&gt;())</code></li> <li>L427\u2013L429\uff1a\u6ce8\u91ca\u660e\u786e\uff1a\u8be5\u6e05\u7406\u51fd\u6570\u201cshould be called in the deoptimization and exception handlers\u201d\u3002   \u6ce8\u5165\u56de\u8c03\uff1a<code>ClearInteropHandleScopesFunction(Frame*)</code> \u2192 <code>DestroyLocalScopeForTopFrame(frame)</code>\u3002</li> </ul> <p>\u5bf9\u5e94\u5173\u7cfb\uff1a <code>ExternalIfaceTable</code> \u91cc\u628a\u53c2\u6570\u7c7b\u578b\u56fa\u5b9a\u4e3a <code>runtime/interpreter/frame.h::Frame*</code>\uff0c\u786e\u4fdd\u6267\u884c\u5f15\u64ce\uff08\u89e3\u91ca\u5668/\u53bb\u4f18\u5316/\u5f02\u5e38\u5904\u7406\uff09\u80fd\u5728\u8fb9\u754c\u70b9\u6e05\u7406 interop local scopes\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#12-js-runtime-ohoshybrid-l430l458","title":"1.2 JS runtime \u751f\u547d\u5468\u671f\uff08OHOS/hybrid \u6a21\u5f0f\u4e0b\uff09\uff08L430\u2013L458\uff09","text":"<p>\u4ec5\u5728 <code>PANDA_TARGET_OHOS || PANDA_JS_ETS_HYBRID_MODE</code> \u4e0b\u751f\u6548\uff1a</p> <ul> <li>L431\u2013L442\uff1a<code>CreateJSRuntimeFunction</code>\uff1a</li> <li>\u8c03 <code>napi_create_runtime(env, &amp;resultJsEnv)</code></li> <li>\u521d\u59cb\u5316 global \u4e0e helper\uff08\u4ee5\u53ca\u53ef\u9009 Console \u6a21\u5757\uff09</li> <li>\u8fd4\u56de\u65b0\u7684 <code>napi_env</code>\uff08\u4f5c\u4e3a <code>ExternalIfaceTable::JSEnv</code> \u7684 <code>void*</code>\uff09</li> <li>L444\u2013L450\uff1a<code>GetJSEnvFunction</code>\uff1a</li> <li>\u53d6 <code>InteropCtx::Current()</code> \u5e76\u8fd4\u56de\u5176 <code>GetJSEnv()</code>\uff08\u82e5 ctx \u4e0d\u5b58\u5728\u5219 nullptr\uff09</li> <li>L452\u2013L456\uff1a<code>CleanUpJSEnvFunction</code>\uff1a</li> <li>\u8c03 <code>napi_destroy_runtime(env)</code> \u9500\u6bc1 js runtime</li> </ul> <p>\u5bf9\u5e94 ANI\uff1a <code>ani_vm_api.cpp::AttachCurrentThread</code> \u5728 <code>--interop=enable</code> \u4e14\u672a\u63d0\u4f9b <code>jsEnv</code> \u65f6\uff0c\u4f1a\u8c03\u7528 <code>ifaceTable-&gt;CreateJSRuntime()</code>\uff1b <code>DetachCurrentThread</code> \u4f1a\u62ff\u5230 <code>ifaceTable-&gt;GetJSEnv()</code> \u5e76\u8c03\u7528 <code>CleanUpJSEnv(jsEnv)</code>\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#13-worker-interop-ctxcreateinteropctxfunctionl459l468","title":"1.3 worker \u4e0a\u7ed1\u5b9a interop ctx\uff1a<code>CreateInteropCtxFunction</code>\uff08L459\u2013L468\uff09","text":"<ul> <li>\u628a <code>void*</code> \u8f6c\u56de <code>napi_env</code></li> <li>\u628a <code>Coroutine*</code> \u8f6c\u4e3a <code>EtsCoroutine*</code></li> <li>\u8c03 <code>InteropCtx::Init(etsCoro, env)</code>\uff1a\u5728\u8be5 worker \u4e0a\u521b\u5efa/\u7ed1\u5b9a ctx</li> <li>OHOS + interop \u7f16\u8bd1\u65f6\uff1a<code>TryInitInteropInJsEnv(jsEnv)</code> \u521d\u59cb\u5316\u8be5 JSVM \u5b9e\u4f8b\u5185\u7684 interop</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#2-createmaininteropcontextani-l934l973","title":"2. <code>CreateMainInteropContext</code>\uff1aANI \u53ef\u89c1\u7684\u5916\u90e8\u5165\u53e3\uff08L934\u2013L973\uff09","text":"<p>\u8fd9\u662f <code>interop_context_api.h</code> \u58f0\u660e\u7684\u51fd\u6570\uff0c\u5728 <code>ani_vm_api.cpp::ANI_CreateVM</code> \u4e2d\u88ab\u8c03\u7528\u3002</p> <p>\u5173\u952e\u6b65\u9aa4\uff1a</p> <ul> <li>L936\uff1a\u65ad\u8a00 <code>mainCoro</code> \u5c31\u662f main thread coroutine\u3002</li> <li>L937\u2013L939\uff1a<code>CheckRuntimeOptions(mainCoro)</code>\uff1a\u4e0d\u6ee1\u8db3\u5219\u5931\u8d25\uff08\u8fd0\u884c\u65f6\u9009\u9879\u7ea6\u675f\uff09\u3002</li> <li>L940\u2013L943\uff1aOHOS/hybrid \u6a21\u5f0f\u4e0b <code>napi_setup_hybrid_environment(env)</code>\u3002</li> <li>L944\uff1a<code>AppStateManager::Create()</code>\uff1a\u521b\u5efa app state \u76d1\u63a7\u5668\u3002</li> <li>L945\u2013L948\uff1a\u5728 <code>ScopedManagedCodeThread sm(mainCoro)</code> \u4e0b\u8c03\u7528 <code>InteropCtx::Init(mainCoro, napi_env)</code>\u3002   \u542b\u4e49\uff1a\u521d\u59cb\u5316 interop ctx \u9700\u8981\u5728 managed code \u8bed\u5883\u4e2d\u5b8c\u6210\uff08\u53ef\u80fd\u4f1a\u89e6\u53d1\u7c7b\u52a0\u8f7d/\u65b9\u6cd5\u8c03\u7528/\u5206\u914d\u7b49\uff09\u3002</li> <li>L952\u2013L958\uff1a\u521d\u59cb\u5316 Timer module + app state callback\u3002</li> <li>L960\u2013L967\uff1a\u6ce8\u518c <code>napi_add_env_cleanup_hook</code>\uff1a\u5728 JS env \u751f\u547d\u5468\u671f\u7ed3\u675f\u65f6\u9500\u6bc1 <code>AppStateManager</code> \u4e0e <code>Runtime</code>\uff08hybrid leading VM \u573a\u666f\u628a ETS VM \u751f\u547d\u5468\u671f\u7ed1\u5b9a\u5230 JSVM\uff09\u3002</li> <li>L968\u2013L972\uff1aOHOS \u4e0b <code>TryInitInteropInJsEnv(napiEnv)</code>\uff0c\u5426\u5219\u76f4\u63a5\u8fd4\u56de true\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.cpp/#3-05","title":"3. \u672c\u6587\u4ef6\u5728 05 \u7ae0\u95ed\u73af\u4e2d\u7684\u4f4d\u7f6e\uff08\u603b\u7ed3\uff09","text":"<p>\u4f60\u53ef\u4ee5\u628a\u5b83\u89c6\u4e3a \u201cinterop_js \u5b50\u7cfb\u7edf\u7684 bootstrap + \u628a\u80fd\u529b\u6ce8\u5165 <code>ExternalIfaceTable</code> \u7684\u5730\u65b9\u201d\uff1a</p> <pre><code>flowchart TD\n  A[ANI_CreateVM] --&gt;|interop=enable| B[CreateMainInteropContext]\n  B --&gt; C[\"InteropCtx::Init(mainCoro, napi_env)\"]\n  C --&gt; D[InteropCtx::InitExternalInterfaces]\n  D --&gt; E[ExternalIfaceTable \u56de\u8c03\u8868\u5c31\u7eea]\n  E --&gt; F[AttachCurrentThread: CreateJSRuntime/CreateInteropCtx]\n  E --&gt; G[DetachCurrentThread: GetJSEnv/CleanUpJSEnv]\n  E --&gt; H[\"Deopt/\u5f02\u5e38: ClearInteropHandleScopes(Frame*)\"]</code></pre>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/","title":"<code>plugins/ets/runtime/interop_js/interop_context.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5cInteropCtx \u5bf9\u8c61\u6a21\u578b\uff08\u805a\u7126\u5bf9\u5916\u8fb9\u754c\uff09\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u58f0\u660e JS interop \u7684\u6838\u5fc3\u5bf9\u8c61 <code>InteropCtx</code>\uff08\u4ee5\u53ca\u82e5\u5e72\u8f85\u52a9\u7f13\u5b58/\u5b58\u50a8\uff09\u3002 \u6ce8\u610f\uff1a\u8be5\u5934\u975e\u5e38\u5927\uff0c\u4e14\u5305\u542b\u5927\u91cf interop \u7ec6\u8282\uff1b\u672c\u7ae0\u5728\u201cNativeBridge\u201d\u8bed\u5883\u4e0b\u91cd\u70b9\u5173\u6ce8 \u5bf9\u5916\u8fb9\u754c\u4e0e\u751f\u547d\u5468\u671f\u94a9\u5b50\uff1a</p> <ul> <li><code>InteropCtx::Init(EtsCoroutine*, napi_env)</code>\uff1a\u4e3a\u67d0\u4e2a coroutine \u7ed1\u5b9a interop ctx</li> <li><code>InteropCtx::Current(...)</code>\uff1a\u4ece coroutine/worker \u83b7\u53d6\u5f53\u524d ctx</li> <li><code>InteropCtx::GetJSEnv()</code>\uff1a\u83b7\u53d6 JS runtime env\uff08napi_env\uff09</li> <li><code>InteropCtx::InitExternalInterfaces()</code>\uff1a\u628a <code>ExternalIfaceTable</code> \u56de\u8c03\u6ce8\u5165 ETS VM\uff08\u5b9e\u73b0\u89c1 <code>.cpp</code>\uff09</li> <li><code>DestroyLocalScopeForTopFrame(Frame*)</code>\uff1a\u7528\u4e8e\u5f02\u5e38/\u53bb\u4f18\u5316\u65f6\u6e05\u7406 interop handle scopes\uff08\u901a\u8fc7 ExternalIfaceTable \u66b4\u9732\uff09</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#1-nativebridge-interop-l19l41","title":"1. \u201c\u4e0d\u8981\u5728 NativeBridge \u7ae0\u8282\u91cc\u9677\u5165 interop \u7ec6\u8282\u201d\u7684\u539f\u56e0\uff08L19\u2013L41\uff09","text":"<p>\u8be5\u5934\u76f4\u63a5 include \u4e86\u5927\u91cf interop \u5b50\u7cfb\u7edf\u7ec4\u4ef6\uff08job queue\u3001refconvert\u3001intrinsics\u3001xgc\u3001napi\u3001hybrid vm interface \u7b49\uff09\u3002 \u8fd9\u610f\u5473\u7740\uff1a - \u4efb\u4f55\u5f15\u5165\u8be5\u5934\u7684\u6587\u4ef6\u90fd\u4f1a\u628a interop \u7684\u5927\u90e8\u5206\u5b9e\u73b0\u7ec6\u8282\u5e26\u8fdb\u7f16\u8bd1\u5355\u5143\uff1b - \u4e3a\u4e86\u9694\u79bb\uff0cANI \u7b49\u6a21\u5757\u5e94\u4f18\u5148 include <code>interop_context_api.h</code>\uff08void* \u53c2\u6570\uff09\u800c\u4e0d\u662f\u76f4\u63a5 include \u672c\u5934\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#2-interopctx-l156l240","title":"2. <code>InteropCtx</code> \u7684\u5173\u952e\u5bf9\u5916\u65b9\u6cd5\uff08L156\u2013L240\uff09","text":""},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#21-l161l165","title":"2.1 \u521d\u59cb\u5316\u4e0e\u9500\u6bc1\uff08L161\u2013L165\uff09","text":"<ul> <li>L161\uff1a<code>static void Init(EtsCoroutine *coro, napi_env env)</code>\uff1a\u5c06 interop ctx \u4e0e\u67d0\u4e2a coroutine \u7ed1\u5b9a\u3002   \u8fd9\u4f1a\u5728\uff1a</li> <li>main \u7ebf\u7a0b\uff1a<code>CreateMainInteropContext</code> \u5185\u8c03\u7528</li> <li>worker \u7ebf\u7a0b attach\uff1a<code>ExternalIfaceTable::CreateInteropCtx</code> \u56de\u8c03\u5185\u8c03\u7528\uff08\u89c1 <code>interop_context.cpp::InitExternalInterfaces</code>\uff09</li> <li>L162\uff1a\u6790\u6784\u51fd\u6570\u8d1f\u8d23\u91ca\u653e interop \u76f8\u5173 GC references \u7b49\u8d44\u6e90\u3002</li> <li>L164\u2013L165\uff1a<code>Destroy(void*)</code>\uff1a\u5178\u578b\u201c\u4ee5 void* \u5b58\u5728 worker \u4e0a\u201d\u7684\u9500\u6bc1\u5165\u53e3\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#22-ctx-l166l179","title":"2.2 \u5f53\u524d ctx \u7684\u83b7\u53d6\uff08L166\u2013L179\uff09","text":"<ul> <li>L166\u2013L174\uff1a<code>Current(Coroutine*)</code>\uff1a\u901a\u8fc7 <code>coro-&gt;GetWorker()</code> \u518d\u53d6 <code>Current(worker)</code>\u3002   \u6ce8\u91ca\u63d0\u793a\u672a\u6765\u53ef\u80fd\u4f18\u5316\u4e3a\u4ece coroutine \u7f13\u5b58 pointer\uff0c\u4f46\u9700\u8981\u4fdd\u8bc1 worker \u72b6\u6001\u4e00\u81f4\u3002</li> <li>L176\u2013L179\uff1a<code>Current()</code>\uff1a\u53d6\u5f53\u524d coroutine \u7684 ctx\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#23-js-env-interop-local-scopesl186l221","title":"2.3 JS env \u4e0e interop local scopes\uff08L186\u2013L221\uff09","text":"<ul> <li>L186\u2013L190\uff1a<code>GetJSEnv()</code>\uff1a\u8fd4\u56de napi_env\uff08\u65ad\u8a00\u975e\u7a7a\uff09\u3002</li> <li>L213\u2013L221\uff1a<code>DestroyLocalScopeForTopFrame(Frame*)</code>\uff1a\u5bf9 interop local scopes \u7684\u5173\u952e\u6e05\u7406\u5165\u53e3\u3002   \u5b83\u5728 <code>.cpp</code> \u4e2d\u4f1a\u88ab\u6ce8\u5165\u4e3a <code>ExternalIfaceTable::ClearInteropHandleScopesFunction</code>\uff0c\u5e76\u88ab\u6ce8\u660e\u201c\u5e94\u5728\u53bb\u4f18\u5316\u4e0e\u5f02\u5e38 handler \u4e2d\u8c03\u7528\u201d\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context.h/#3-nativebridge-interopctx","title":"3. \u672c\u7ae0\u201cNativeBridge\u201d\u4e0e InteropCtx \u7684\u8fde\u63a5\u65b9\u5f0f\uff08\u603b\u7ed3\uff09","text":"<p>NativeBridge \u4e0d\u76f4\u63a5\u4f9d\u8d56 interop \u7684\u5185\u90e8\u5b9e\u73b0\uff0c\u800c\u662f\u901a\u8fc7\u4e24\u6761\u201c\u7a84\u63a5\u53e3\u201d\u8fde\u63a5\uff1a</p> <ul> <li>\u542f\u52a8\u9636\u6bb5\uff08main thread\uff09\uff1a<code>interop_context_api.h::CreateMainInteropContext(mainCoro, void* jsEnv)</code></li> <li>\u8fd0\u884c\u9636\u6bb5\uff08worker attach/detach \u4e0e\u5f02\u5e38/\u53bb\u4f18\u5316\u6e05\u7406\uff09\uff1a<code>ExternalIfaceTable</code> \u56de\u8c03\u96c6\u5408   \u56de\u8c03\u7684\u6ce8\u5165\u53d1\u751f\u5728 <code>InteropCtx::InitExternalInterfaces()</code>\uff08\u5b9e\u73b0\u89c1 <code>interop_context.cpp</code>\uff09\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context_api.h/","title":"<code>plugins/ets/runtime/interop_js/interop_context_api.h</code>\uff08\u9010\u884c\u7cbe\u8bfb\uff5c\u5bf9\u5916\u9694\u79bb\u5c42\uff09","text":"<p>\u7ae0\u8282\u5f52\u5c5e\uff1aStage2 / 05_NativeBridge \u672c\u6587\u4ef6\u89d2\u8272\uff1a\u5bf9\u5916\u63d0\u4f9b Interop JS \u7684\u6700\u5c0f\u5165\u53e3\uff0c\u7528\u4e8e\u9694\u79bb\u5b9e\u73b0\u7ec6\u8282\uff1a - <code>CreateMainInteropContext(EtsCoroutine*, void *napiEnv)</code></p> <p>\u8bbe\u8ba1\u8981\u6c42\uff08\u6ce8\u91ca\u660e\u786e\u5199\u51fa\uff09\uff1a\u8c03\u7528\u65b9\uff08\u4f8b\u5982 ANI\uff09\u5e94\u4e0e interop \u5b9e\u73b0\u9694\u79bb\uff0c\u56e0\u6b64\u53c2\u6570\u7528 <code>void*</code> \u800c\u4e0d\u662f <code>napi_env</code>\u3002</p>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context_api.h/#1-l21l40","title":"1. \u524d\u7f6e\u58f0\u660e\u4e0e\u547d\u540d\u7a7a\u95f4\uff08L21\u2013L40\uff09","text":"<ul> <li>L23\uff1a<code>class EtsCoroutine;</code>\uff1aInterop \u521d\u59cb\u5316\u9700\u8981\u4e3b coroutine\u3002</li> <li>L25\uff1a\u5d4c\u5957\u547d\u540d\u7a7a\u95f4 <code>interop::js</code>\uff1a\u6e05\u6670\u6807\u8bb0\u5c5e\u4e8e JS interop \u5b50\u7cfb\u7edf\u3002</li> </ul>"},{"location":"05_NativeBridge/FileNotes/plugins_ets_runtime_interop_js_interop_context_api.h/#2-createmaininteropcontextani-l27l37","title":"2. <code>CreateMainInteropContext</code>\uff1aANI \u53ef\u8c03\u7528\u7684\u552f\u4e00\u5916\u90e8\u5165\u53e3\uff08L27\u2013L37\uff09","text":"<ul> <li>L27\u2013L35\uff08\u6ce8\u91ca\uff09\uff1a\u8bf4\u660e\u8be5\u51fd\u6570\u4f1a\uff1a</li> <li>\u521b\u5efa main interop context</li> <li>\u521d\u59cb\u5316\u6a21\u5757\u3001XGC \u7b49</li> <li>\u4f46\u4e3a\u4e86\u9694\u79bb\uff0c\u7981\u6b62\u66b4\u9732 <code>napi_env</code> \u7c7b\u578b</li> <li>L36\uff1a<code>PANDA_PUBLIC_API bool CreateMainInteropContext(mainCoro, void *napiEnv)</code>   \u8fd4\u56de bool\uff1a\u6210\u529f/\u5931\u8d25\uff1b\u5931\u8d25\u65f6 ANI \u4fa7\u4f1a\u9500\u6bc1 runtime\uff08\u89c1 <code>ani_vm_api.cpp::ANI_CreateVM</code>\uff09\u3002</li> </ul>"},{"location":"06_Tooling_Profiling_Verification/","title":"06_Tooling_Profiling_Verification\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\u3002</p>"},{"location":"06_Tooling_Profiling_Verification/#_1","title":"\u672c\u7ae0\u8303\u56f4\uff08\u5f85\u51bb\u7ed3\uff09","text":"<ul> <li>seed_dirs: runtime/tooling, runtime/jit, verification</li> <li>seed_files: </li> </ul>"},{"location":"06_Tooling_Profiling_Verification/#_2","title":"\u5bfc\u822a","text":"<ul> <li><code>Index.md</code>\uff1a\u6587\u4ef6\u6e05\u5355\u4e0e\u9605\u8bfb\u987a\u5e8f</li> <li><code>Manifests/files.yaml</code>\uff1a\u672c\u7ae0\u9010\u884c\u7cbe\u8bfb\u6587\u4ef6\u6e05\u5355\uff08\u52a8\u6001\u6269\u5c55\uff09</li> <li><code>Manifests/tree_inventory.txt</code>\uff1aseed \u626b\u63cf\u5f97\u5230\u7684\u5b8c\u6574\u6587\u4ef6\u6e05\u5355\uff08tree \u7b49\u4ef7\uff09</li> <li><code>FileNotes/</code>\uff1a\u9010\u6587\u4ef6\u9010\u884c\u7b14\u8bb0</li> <li><code>Errata_to_Stage1.md</code>\uff1a\u9636\u6bb5\u4e00\u6821\u6b63\u70b9</li> </ul>"},{"location":"06_Tooling_Profiling_Verification/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"06_Tooling_Profiling_Verification/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>\uff08\u6682\u65e0\uff09</li> </ul>"},{"location":"06_Tooling_Profiling_Verification/Index/","title":"06_Tooling_Profiling_Verification - Index","text":""},{"location":"06_Tooling_Profiling_Verification/Index/#_1","title":"\u9605\u8bfb\u987a\u5e8f\uff08\u5f85\u8865\uff09","text":""},{"location":"06_Tooling_Profiling_Verification/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"},{"location":"07_Build_and_Configuration/","title":"07_Build_and_Configuration\uff08Stage2\uff09","text":"<p>\u9636\u6bb5\u4e8c\uff1a\u9010\u884c\u7cbe\u8bfb\u4e0e wiki \u6c89\u6dc0\u3002</p>"},{"location":"07_Build_and_Configuration/#_1","title":"\u672c\u7ae0\u8303\u56f4\uff08\u5f85\u51bb\u7ed3\uff09","text":"<ul> <li>seed_dirs: cmake, plugins, runtime, compiler, verification</li> <li>seed_files: BUILD.gn, CMakeLists.txt</li> </ul>"},{"location":"07_Build_and_Configuration/#_2","title":"\u5bfc\u822a","text":"<ul> <li><code>Index.md</code>\uff1a\u6587\u4ef6\u6e05\u5355\u4e0e\u9605\u8bfb\u987a\u5e8f</li> <li><code>Manifests/files.yaml</code>\uff1a\u672c\u7ae0\u9010\u884c\u7cbe\u8bfb\u6587\u4ef6\u6e05\u5355\uff08\u52a8\u6001\u6269\u5c55\uff09</li> <li><code>Manifests/tree_inventory.txt</code>\uff1aseed \u626b\u63cf\u5f97\u5230\u7684\u5b8c\u6574\u6587\u4ef6\u6e05\u5355\uff08tree \u7b49\u4ef7\uff09</li> <li><code>FileNotes/</code>\uff1a\u9010\u6587\u4ef6\u9010\u884c\u7b14\u8bb0</li> <li><code>Errata_to_Stage1.md</code>\uff1a\u9636\u6bb5\u4e00\u6821\u6b63\u70b9</li> </ul>"},{"location":"07_Build_and_Configuration/Errata_to_Stage1/","title":"\u9636\u6bb5\u4e00\u6821\u6b63\u8bb0\u5f55\uff08Stage2 -&gt; Stage1 Errata\uff09","text":"<p>\u5728\u9636\u6bb5\u4e8c\u9010\u884c\u7cbe\u8bfb\u4e2d\u53d1\u73b0 Stage1 \u63cf\u8ff0\u4e0d\u51c6\u786e\u65f6\uff1a 1) \u5728\u6b64\u8bb0\u5f55\u6821\u6b63\u70b9\u4e0e\u4f9d\u636e\uff08\u6587\u4ef6/\u51fd\u6570/\u884c\u6bb5\uff09 2) \u56de\u5199\u4fee\u6b63 Stage1 \u5bf9\u5e94\u6587\u6863</p>"},{"location":"07_Build_and_Configuration/Errata_to_Stage1/#_1","title":"\u6821\u6b63\u70b9\u5217\u8868","text":"<ul> <li>\uff08\u6682\u65e0\uff09</li> </ul>"},{"location":"07_Build_and_Configuration/Index/","title":"07_Build_and_Configuration - Index","text":""},{"location":"07_Build_and_Configuration/Index/#_1","title":"\u9605\u8bfb\u987a\u5e8f\uff08\u5f85\u8865\uff09","text":""},{"location":"07_Build_and_Configuration/Index/#_2","title":"\u6587\u4ef6\u6e05\u5355","text":"<ul> <li>\u89c1 <code>Manifests/files.yaml</code>\uff08\u9010\u884c\u7cbe\u8bfb\u6e05\u5355\uff09</li> <li>\u89c1 <code>Manifests/tree_inventory.txt</code>\uff08seed \u5168\u91cf\u626b\u63cf\u6e05\u5355\uff09</li> </ul>"}]}